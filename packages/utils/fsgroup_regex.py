import re


def extract_kiln_data(text):
    # نرمال‌سازی اعداد فارسی و عربی
    translation_table = str.maketrans("۰۱۲۳۴۵۶۷۸۹٠١٢٣٤٥٦٧٨٩", "01234567890123456789")
    text = text.translate(translation_table)

    def normalize_number(num_str):
        if not num_str:
            return None
        num_str = num_str.replace(" ", "").replace("/", ".")
        if num_str.count(".") > 1:
            parts = num_str.split(".")
            num_str = parts[0] + "." + "".join(parts[1:])
        try:
            return float(num_str) if "." in num_str else int(num_str)
        except ValueError:
            return None

    def normalize_time(t):
        t = t.strip()
        if re.fullmatch(r"\d{1,2}", t):
            return f"{int(t):02d}:00"
        if re.fullmatch(r"\d{1,2}:\d{1,2}", t):
            h, m = t.split(":")
            return f"{int(h):02d}:{int(m):02d}"
        if re.fullmatch(r"\d{1,2}صبح", t):
            h = re.findall(r"\d{1,2}", t)[0]
            return f"{int(h):02d}:00"
        if re.fullmatch(r"\d{1,2}ظهر", t):
            h = re.findall(r"\d{1,2}", t)[0]
            return f"{int(h):02d}:00"
        return t

    patterns = {
        "time": [
            r"ساعت\s*([0-9]{1,2}(?::[0-9]{1,2})?)",
            r"([0-9]{1,2}صبح)",
            r"([0-9]{1,2}ظهر)",
        ],
        "kiln1": [
            r"ک\s*(?:وره)?\s*1\s*[=:\-–—]+\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"ک\s*یک\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"کوره\s*1\s*ساعت\s*[0-9]+\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"ک\s*1\s*[=:\-–—]+\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"کوره\s*1\s*=\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"کوره\s*1\.\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
        ],
        "kiln2": [
            r"ک\s*(?:وره)?\s*2\s*[=:\-–—]+\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"ک\s*دو\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"کوره\s*2\s*ساعت\s*[0-9]+\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"ک\s*2\s*[=:\-–—]+\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"کوره\s*2\s*=\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"کوره\s*2\.\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
        ],
        "above40": [
            r"بالای\s*40\s*[=:\-–—]+\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"بالا\s*چهل\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"بالای\s*40\s*=\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"بالای\s*40\s*[^\w\s]+\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",  # هر کاراکتر غیرحرف و غیرفاصله
        ],
        "repeat_kiln1": [
            r"تکرار\s*کوره?\s*1\s*[=:\-–—]?\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"تکرار\s*ک\s*1\s*[=:\-–—]?\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"مجدد\s*ک\s*1\s*[=:\-–—]?\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"تکرار\s*ک\s*یک\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"مجدد\s*ک\s*یک\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"تکرار\s*کوره?\s*1\s*ساعت\s*[0-9]+\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
        ],
        "repeat_kiln2": [
            r"تکرار\s*کوره?\s*2\s*[=:\-–—]?\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"تکرار\s*ک\s*2\s*[=:\-–—]?\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"مجدد\s*ک\s*2\s*[=:\-–—]?\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"تکرار\s*ک\s*دو\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"مجدد\s*ک\s*دو\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
            r"تکرار\s*کوره?\s*2\s*ساعت\s*[0-9]+\s*([0-9]+(?:\s*[./]\s*[0-9]+)?)",
        ],
    }

    result = {key: [] for key in patterns}

    for key, pats in patterns.items():
        for pat in pats:
            matches = re.findall(pat, text, re.IGNORECASE)
            if key == "time":
                result[key].extend([normalize_time(m) for m in matches])
            else:
                for m in matches:
                    val = normalize_number(m)
                    if val is not None:
                        result[key].append(val)

    # حذف تکراری‌ها ولی نگه داشتن همه مقادیر
    for key in result:
        result[key] = list(dict.fromkeys(result[key]))
        if len(result[key]) == 0:
            result[key] = None

    return result


# texts = [
#     """
# سلام کوره 1 ساعت 16 6.46 شد...
# کوره 2 ساعت 16 4.91 شد...
# """,
#     """
# آنالیز ساعت ۱۲
# ک یک ۴
# ک دو ۳.۰۳
# """,
#     """
# باسلام آنالیز ساعت ۸
# ک یک ۲.۲۱
# ک دو ۲.۵۱
# بالا چهل ۶.۹۱
# """,
#     """
# سلام ساعت8
# ک1-------3/55
# ک2-------3/04
# بالای 40-------2/88
# """,
#     """
# باسلام آنالیز ساعت ۸
# ک یک ۲.۲۱
# ک دو ۲.۵۱
# بالا چهل ۶.۹۱
# """,
#     """
# با سلام
# نتیجه تست co2
# 8صبح
# کوره 1=1.40
# کوره 2=3.50
# بالای40=11.96
# """,
#     """
# سلام آنالیز کوره 1 ساعت 20 5.22 ...
# آنالیز کوره 2 ساعت 20 5.11 ...
# """,
#     """
# تکرار کوره۲ ساعت ۱۳/۳۰=۵/۱۳
# """,
#     """
# با سلام
# نتیجه تست co2
# 12ظهر
# کوره 1=3.65
# کوره 2=2.80
# """,
#     """
# باسلام آنالیز ساعت ۸
# ک یک ۱۰.۱۵
# ک دو ۵.۱۱
# بالا چهل ۱۱.۰۱
# تکرار یک ۸.۳۷
# """,
#     """
# سلام کوره 1 ساعت 8 3.89 شد...
# کوره 2 ساعت 8 10.35 شد...
# بالای 40 10.73 شد...
# تکرار کوره 2 1.30 شد...
# """,
#     """
# سلام ساعت۸
# کوره۱ =۳/۶۶
# کوره۲ =۴/۴۴
# بالای۴۰ =۳/۱۱
# """,
#     """
# باسلام آنالیز ساعت ۲۴
# ک یک ۷.۹۰
# ک دو ۴.۰۴
# مجدد ک یک ۳.۴۰
# """,
#     """
# سلام کوره 1 ساعت 8 3.56 شد...
# کوره 2 ساعت 8 2.67 شد...
# بالای 40 4.78 شد...
# """,
#     """
# سلام ساعت8
# ک1-----2/57
# ک2------2/86
# بالای 40------10/41
# """,
#     """
# سلام ساعت۲۴
# کوره۱ =۲/۸۸
# کوره۲ =۹۷/.
# """,
#     """
# آنالیز ساعت ۸
# ک یک ۱۱.۰۶
# ک دو ۱۰.۰۱
# بالا چهل ۱۱.۶۴
# مجدد ک یک ۷.۰۱
# مجدد ک دو ۷.۲۳
# """,
#     """
# سلام
# آنالیز ساعت ۱۲
# کوره۱.         ۱۲.۱۹
# کوره ۲.       ۸.۲۳
# """,
#     """
# تکرار کوره ۲       6.07
# سلام ساعت۱۶
# کوره۱ =۲/۳۲
# کوره۲ =۳/۷۲
# """,
#     """
# آنالیز ساعت ۱۶
# ک یک ۱.۵۱
# ک دو هنوز متوقف میباشد
# """,
#     """
# سلام کوره 1 ساعت 20 4.39 شد...
# کوره 2 ساعت 20 8.77 شد...
# """,
#     """
# سلام تکرار کوره 2 8.99 شد... گفتم ریجک شود....
# """,
#     """
# سلام کوره 1 ساعت 12 6.66 شد...
# کوره 2 ساعت 12 9.80 شد... تکرار آن 5.83 شد...
# کوره 1 ساعت 16 4.61 شد...
# کوره 2 ساعت 16 3.09 صدم شد...
# سلام کوره 1 ساعت 16 5.44 شد...
# کوره 2 ساعت 16 4.86 شد...
# کوره 1 ساعت 12 4.28 شد...
# کوره 2 ساعت 12 2.63 شد....
# کوره 1 ساعت 8 3.31 شد...
# کوره 2 ساعت 8 1.76 شد...
# بالای 40 9.26 شد....
# """,
# ]

# for i, text in enumerate(texts, 1):
#     print(f"text {i}:")
#     data = extract_kiln_data(text)
#     print(data)
#     print("-" * 30)

# data = extract_kiln_data(text="بالای 40------9/11")
# print(data)

(this.webpackJsonp=this.webpackJsonp||[]).push([[12,19,29],{117:function(e,t,s){"use strict";s.r(t),s.d(t,"ripple",(function(){return l}));var i=s(81),n=s(160),a=s(74),o=s(73);let r=0;function l(e,t=(()=>Promise.resolve()),s=null,l=!1){if(e.querySelector(".c-ripple"))return;e.classList.add("rp");let d=document.createElement("div");d.classList.add("c-ripple");let c;e.classList.contains("rp-square")&&d.classList.add("is-square"),e[l?"prepend":"append"](d);const h=(e,i)=>{const o=Date.now(),l=document.createElement("div"),h=r++,u=1e3*+window.getComputedStyle(d).getPropertyValue("--ripple-duration").replace("s","");c=()=>{let e=Date.now()-o;const t=()=>{n.a.mutate(()=>{l.remove()}),s&&s(h)};if(e<u){let s=Math.max(u-e,u/2);setTimeout(()=>l.classList.add("hiding"),Math.max(s-u/2,0)),setTimeout(t,s)}else l.classList.add("hiding"),setTimeout(t,u/2);a.IS_TOUCH_SUPPORTED||window.removeEventListener("contextmenu",c),c=null,p=!1},t&&t(h),window.requestAnimationFrame(()=>{const t=d.getBoundingClientRect();l.classList.add("c-ripple__circle");const s=e-t.left,n=i-t.top,a=Math.sqrt(Math.pow(Math.abs(n-t.height/2)+t.height/2,2)+Math.pow(Math.abs(s-t.width/2)+t.width/2,2)),o=s-a/2,r=n-a/2;l.style.width=l.style.height=a+"px",l.style.left=o+"px",l.style.top=r+"px",d.append(l)})},u=t=>t.target!==e&&(["BUTTON","A"].includes(t.target.tagName)||Object(i.a)(t.target,"c-ripple")!==d);let p=!1;if(a.IS_TOUCH_SUPPORTED){let t=()=>{c&&c()};e.addEventListener("touchstart",s=>{if(!o.default.settings.animationsEnabled)return;if(s.touches.length>1||p||u(s))return;p=!0;let{clientX:i,clientY:n}=s.touches[0];h(i,n),e.addEventListener("touchend",t,{once:!0}),window.addEventListener("touchmove",s=>{s.cancelBubble=!0,s.stopPropagation(),t(),e.removeEventListener("touchend",t)},{once:!0})},{passive:!0})}else e.addEventListener("mousedown",t=>{if(![0,2].includes(t.button))return;if(!o.default.settings.animationsEnabled)return;if("0"===e.dataset.ripple||u(t))return;if(p)return void(p=!1);let{clientX:s,clientY:i}=t;h(s,i),window.addEventListener("mouseup",c,{once:!0,passive:!0}),window.addEventListener("contextmenu",c,{once:!0,passive:!0})},{passive:!0})}},124:function(e,t,s){"use strict";s.r(t);var i=s(1);Object.defineProperty(Uint8Array.prototype,"hex",{get:function(){return Object(i.f)(this)},set:function(e){this.set(Object(i.c)(e))},enumerable:!0,configurable:!0}),Uint8Array.prototype.randomize=function(){if(!crypto||!("getRandomValues"in crypto))throw new Error("NO_SECURE_RANDOM");return crypto.getRandomValues(this),this},Uint8Array.prototype.concat=function(...e){return Object(i.a)(this,...e)},Uint8Array.prototype.toJSON=function(){return[...this]},Array.prototype.findAndSplice=function(e){let t=this.findIndex(e);return-1!==t?this.splice(t,1)[0]:void 0},String.prototype.toHHMMSS=function(e=!1){const t=parseInt(this+"",10),s=Math.floor(t/3600);let i=Math.floor((t-3600*s)/60),n=t-3600*s-60*i;return s&&(e=!0),i<10&&(i=e?"0"+i:i),n<10&&(n="0"+n),(s?s+":":"")+i+":"+n},Promise.prototype.finally=Promise.prototype.finally||function(e){const t=t=>Promise.resolve(e()).then(t);return this.then(e=>t(()=>e),e=>t(()=>Promise.reject(e)))},Promise.prototype.safeFinally=function(e){return this.catch(()=>{}).finally(e)}},138:function(e,t,s){"use strict";s.d(t,"d",(function(){return o})),s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return l})),s.d(t,"c",(function(){return d})),s.d(t,"e",(function(){return c}));var i=s(74),n=s(151);let a;function o(e){if(e.isTrusted&&"click"===e.type&&e.target!==a)return!0}document.addEventListener("mousedown",e=>{a=e.target});const r=i.IS_TOUCH_SUPPORTED?"mousedown":"click";function l(e,t,s={}){const i=s.listenerSetter?s.listenerSetter.add(e):e.addEventListener.bind(e);s.touchMouseDown=!0,i(r,t,s)}function d(e,t,s){e.removeEventListener(r,t,s)}function c(e){Object(n.a)(e,r)}},141:function(e,t,s){"use strict";var i=s(115),n=s(117);t.a=(e,t={})=>{const s=document.createElement(t.asDiv?"div":"button");return s.className=e+(t.icon?" tgico-"+t.icon:""),t.noRipple||(t.rippleSquare&&s.classList.add("rp-square"),Object(n.ripple)(s)),t.onlyMobile&&s.classList.add("only-handhelds"),t.disabled&&s.setAttribute("disabled","true"),t.text&&s.append(Object(i.i18n)(t.text)),s}},142:function(e,t,s){"use strict";s.d(t,"f",(function(){return h})),s.d(t,"g",(function(){return u})),s.d(t,"c",(function(){return m})),s.d(t,"d",(function(){return y})),s.d(t,"e",(function(){return w})),s.d(t,"b",(function(){return M})),s.d(t,"a",(function(){return C}));var i=s(11),n=s(79),a=s(138),o=s(144),r=s(74),l=s(54),d=s(73),c=s(147);function h(e,t=!1){const s='\n  <svg xmlns="http://www.w3.org/2000/svg" class="preloader-circular" viewBox="25 25 50 50">\n  <circle class="preloader-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"/>\n  </svg>';if(t){const t=document.createElement("div");return t.classList.add("preloader"),t.innerHTML=s,e&&e.appendChild(t),t}return e.insertAdjacentHTML("beforeend",s),e.lastElementChild}function u(e,t="check"){return e.classList.remove("tgico-"+t),e.disabled=!0,h(e),()=>{e.innerHTML="",e.classList.add("tgico-"+t),e.removeAttribute("disabled")}}i.a.putPreloader=h;let p=e=>{let t=f.getBoundingClientRect(),{clientX:s,clientY:i}=e,n=s>=t.right?s-t.right:t.left-s,a=i>=t.bottom?i-t.bottom:t.top-i;(n>=100||a>=100)&&m()};const g=e=>{m()},m=()=>{f&&(f.classList.remove("active"),f.parentElement.classList.remove("menu-open"),b&&b.remove(),f=null,d.default.dispatchEvent("context_menu_toggle",!1)),v&&(v(),v=null),r.IS_TOUCH_SUPPORTED||(window.removeEventListener("mousemove",p),window.removeEventListener("contextmenu",g)),document.removeEventListener(a.a,g),l.IS_MOBILE_SAFARI||c.a.removeByType("menu")};window.addEventListener("resize",()=>{f&&m()});let f=null,v=null,b=null;function y(e,t){m(),l.IS_MOBILE_SAFARI||c.a.pushItem({type:"menu",onPop:e=>{m()}}),f=e,f.classList.add("active"),f.parentElement.classList.add("menu-open"),b||(b=document.createElement("div"),b.classList.add("btn-menu-overlay"),b.addEventListener(a.a,e=>{Object(n.a)(e),g()})),f.parentElement.insertBefore(b,f),v=t,r.IS_TOUCH_SUPPORTED||(window.addEventListener("mousemove",p),window.addEventListener("contextmenu",g,{once:!0})),document.addEventListener(a.a,g),d.default.dispatchEvent("context_menu_toggle",!0)}function w(e,t,s){e.touches&&(e=e.touches[0]);const{pageX:i,pageY:n}=e;let{scrollWidth:a,scrollHeight:r}=t;const l=document.body.getBoundingClientRect(),d=l.width,c=l.height;s=o.b.isMobile?"right":"left";let h="top";const u={x:{left:i,right:i-a},intermediateX:"right"===s?8:d-a-8,y:{top:n,bottom:n-r},intermediateY:n<c/2?8:c-r-8},p={left:u.x.left+a+8<=d,right:u.x.right>=8},g={top:u.y.top+r+8<=c,bottom:u.y.bottom-8>=8};{let e;e=p[s]?u.x[s]:(s="center",u.intermediateX),t.style.left=e+"px"}{let e;e=g[h]?u.y[h]:(h="center",u.intermediateY),t.style.top=e+"px"}t.className=t.className.replace(/(top|center|bottom)-(left|center|right)/g,""),t.classList.add(("center"===h?h:"bottom")+"-"+("center"===s?s:"left"===s?"right":"left"))}let S=!1,I=0;function M(){I&&clearTimeout(I),I=window.setTimeout(()=>{I=0,S=!1},400),S=!0}function C(e,t,s){const i=s?s.add(e):e.addEventListener.bind(e),a=s?s.removeManual.bind(s,e):e.removeEventListener.bind(e);if(l.IS_APPLE&&r.IS_TOUCH_SUPPORTED){let s;const o={capture:!0},r=()=>{clearTimeout(s),a("touchmove",r,o),a("touchend",r,o),a("touchcancel",r,o)};i("touchstart",a=>{a.touches.length>1?r():(i("touchmove",r,o),i("touchend",r,o),i("touchcancel",r,o),s=window.setTimeout(()=>{S?r():(t(a),r(),f&&!f.classList.contains("contextmenu")&&e.addEventListener("touchend",n.a,{once:!0}))},400))})}else i("contextmenu",r.IS_TOUCH_SUPPORTED?s=>{t(s),f&&e.addEventListener("touchend",n.a,{once:!0})}:t)}},143:function(e,t,s){"use strict";function i(e,t){if("string"==typeof t)return void(e.innerHTML=t);const s=e.firstChild;s?e.lastChild===s?s.replaceWith(t):(e.textContent="",e.append(t)):e.append(t)}s.d(t,"a",(function(){return i}))},145:function(e,t,s){"use strict";function i(e,t){e.setAttribute("dir","auto"),"string"==typeof t?t?e.innerHTML=t:e.textContent="":(e.textContent="",e.append(t))}s.d(t,"a",(function(){return i}))},146:function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var i=s(151),n=s(154),a=s(158),o=s(150),r=s(164);var l=s(145),d=s(115),c=s(139),h=s(148);let u=()=>{document.addEventListener("paste",e=>{if(!Object(a.a)(e.target,'contenteditable="true"'))return;let t,s;e.preventDefault();let i=(e.originalEvent||e).clipboardData.getData("text/plain"),r=!0,l=(e.originalEvent||e).clipboardData.getData("text/html");if(l.trim()){l=l.replace(/<style([\s\S]*)<\/style>/,""),l=l.replace(/<!--([\s\S]*)-->/,"");const e=l.match(/<body>([\s\S]*)<\/body>/);e&&(l=e[1].trim());let n=document.createElement("span");n.innerHTML=l;let a=n.firstChild;for(;a;){let e=a.nextSibling;3===a.nodeType&&(a.nodeValue.trim()||a.remove()),a=e}const d=Object(o.a)(n,!0);if(d.value.replace(/\s/g,"").length===i.replace(/\s/g,"").length){t=d.value,s=d.entities,r=!1;let e=c.b.parseEntities(t);e=e.filter(e=>"messageEntityEmoji"===e._||"messageEntityLinebreak"===e._),c.b.mergeEntities(s,e)}}r&&(t=i,s=c.b.parseEntities(t),s=s.filter(e=>"messageEntityEmoji"===e._||"messageEntityLinebreak"===e._));const d=c.b.wrapDraftText(t,{entities:s});t=Object(n.a)(d),window.document.execCommand("insertHTML",!1,t)}),u=null};var p;!function(e){e[e.Neutral=0]="Neutral",e[e.Valid=1]="Valid",e[e.Error=2]="Error"}(p||(p={}));t.b=class{constructor(e={}){this.options=e,this.container=document.createElement("div"),this.container.classList.add("input-field"),this.required=e.required,this.validate=e.validate,void 0!==e.maxLength&&void 0===e.showLengthOn&&(e.showLengthOn=Math.min(40,Math.round(e.maxLength/3)));const{placeholder:t,maxLength:s,showLengthOn:i,name:n,plainText:a,canBeEdited:l=!0}=e;let c,h,p=e.label||e.labelText;if(a)this.container.innerHTML=`\n      <input type="text" ${n?`name="${n}"`:""} autocomplete="off" ${p?'required=""':""} class="input-field-input">\n      `,c=this.container.firstElementChild;else{u&&u(),this.container.innerHTML='\n      <div contenteditable="true" class="input-field-input"></div>\n      ',c=this.container.firstElementChild,c.contentEditable=""+!!l;const t=new MutationObserver(()=>{h&&h()});c.addEventListener("input",()=>{Object(r.a)(c)&&(c.innerHTML=""),this.inputFake&&(this.inputFake.innerHTML=c.innerHTML,this.onFakeInput())}),t.observe(c,{characterData:!0,childList:!0,subtree:!0}),e.animate&&(c.classList.add("scrollable","scrollable-y"),this.inputFake=document.createElement("div"),this.inputFake.setAttribute("contenteditable","true"),this.inputFake.className=c.className+" input-field-input-fake")}if(c.setAttribute("dir","auto"),t&&(Object(d._i18n)(c,t,void 0,"placeholder"),this.inputFake&&Object(d._i18n)(this.inputFake,t,void 0,"placeholder")),p||t){const e=document.createElement("div");e.classList.add("input-field-border"),this.container.append(e)}if(p&&(this.label=document.createElement("label"),this.setLabel(),this.container.append(this.label)),s){const e=this.container.lastElementChild;let t=!1;h=()=>{const n=c.classList.contains("error"),r=a?c.value.length:[...Object(o.a)(c,!1).value].length,l=s-r,d=l<0;c.classList.toggle("error",d),d||l<=i?(this.setLabel(),e.append(` (${s-r})`),t||(t=!0)):(n&&!d||t)&&(this.setLabel(),t=!1)},c.addEventListener("input",h)}this.input=c}select(){this.value&&(this.options.plainText?this.input.select():function(e){const t=document.createRange();t.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(t)}(this.input))}setLabel(){this.label.textContent="",this.options.labelText?Object(l.a)(this.label,this.options.labelText):this.label.append(Object(d.i18n)(this.options.label,this.options.labelOptions))}onFakeInput(e=!0){const{scrollHeight:t}=this.inputFake,s=+this.input.style.height.replace("px","");if(s===t)return;const i=Math.round(50*Math.log(Math.abs(t-s)));this.input.style.transitionDuration=i+"ms",e&&(this.input.style.height=t?t+"px":"");Object(h.a)(this.input,"is-changing-height",!0,i,()=>{this.input.classList.remove("is-changing-height")})}get value(){return this.options.plainText?this.input.value:Object(o.a)(this.input,!1).value}set value(e){this.setValueSilently(e,!1),Object(i.a)(this.input,"input")}setValueSilently(e,t=!0){this.options.plainText?this.input.value=e:(this.input.innerHTML=e,this.inputFake&&(this.inputFake.innerHTML=e,t&&this.onFakeInput()))}isChanged(){return this.value!==this.originalValue}isValid(){return!this.input.classList.contains("error")&&(!this.validate||this.validate())&&(!this.required||!Object(r.a)(this.input))}isValidToChange(){return this.isValid()&&this.isChanged()}setDraftValue(e="",t=!1){this.options.plainText||(e=Object(n.a)(c.b.wrapDraftText(e))),t?this.setValueSilently(e,!1):this.value=e}setOriginalValue(e="",t=!1){this.originalValue=e,this.setDraftValue(e,t)}setState(e,t){t&&(this.label.textContent="",this.label.append(Object(d.i18n)(t,this.options.labelOptions))),this.input.classList.toggle("error",!!(e&p.Error)),this.input.classList.toggle("valid",!!(e&p.Valid))}setError(e){this.setState(p.Error,e)}}},147:function(e,t,s){"use strict";var i=s(11),n=s(54),a=s(24),o=s(85),r=s(79),l=s(82),d=s(167);const c=new class{constructor(){if(this.onPopState=e=>{const t=window.location.hash,s=e.state;if(this.debug&&this.log("popstate",e,this.isPossibleSwipe,t),t!==this.currentHash)if(this.debug&&this.log.warn(`hash changed, new=${t}, current=${this.currentHash}, overridden=${this.overriddenHash}`),s===this.id&&this.overriddenHash&&this.overriddenHash!==t)this.overrideHash(this.overriddenHash);else{if(!s||this.overriddenHash||!t)return this.currentHash=t,void(this.onHashChange&&this.onHashChange());this.overrideHash()}if(s!==this.id&&(this.pushState(),!this.navigations.length))return;const i=this.navigations.pop();i?(this.manual=!this.isPossibleSwipe,this.handleItem(i,this.navigations.length)):this.pushState()},this.onTouchStart=e=>{e.touches.length>1||(this.debug&&this.log("touchstart"),Object(d.a)(e)&&(this.isPossibleSwipe=!0,window.addEventListener("touchend",()=>{setTimeout(()=>{this.isPossibleSwipe=!1},100)},{passive:!0,once:!0})))},this.navigations=[],this.id=Date.now(),this.manual=!1,this.log=Object(a.b)("NC"),this.debug=!0,this.currentHash=window.location.hash,this.overriddenHash="",this.isPossibleSwipe=!1,window.addEventListener("popstate",this.onPopState),window.addEventListener("keydown",e=>{const t=this.navigations[this.navigations.length-1];t&&("Escape"!==e.key||t.onEscape&&!t.onEscape()||(Object(r.a)(e),this.back(t.type)))},{capture:!0,passive:!1}),n.IS_MOBILE_SAFARI){const e={passive:!0};window.addEventListener("touchstart",this.onTouchStart,e)}history.scrollRestoration="manual",this.pushState()}overrideHash(e=""){e&&"#"!==e[0]?e="#"+e:"#"===e&&(e=""),this.currentHash!==e&&(this.overriddenHash=this.currentHash=e,this.replaceState(),this.pushState())}handleItem(e,t=this.navigations.indexOf(e)){const s=e.onPop(!!this.manual&&void 0);this.debug&&this.log("popstate, navigation:",e,this.navigations),!1===s?this.spliceItems(Math.min(this.navigations.length,t),0,e):e.noBlurOnPop||Object(o.a)(),this.manual=!1}findItemByType(e){for(let t=this.navigations.length-1;t>=0;--t){const s=this.navigations[t];if(s.type===e)return{item:s,index:t}}}back(e){if(e){const t=this.findItemByType(e);if(t)return this.manual=!0,this.navigations.splice(t.index,1),void this.handleItem(t.item)}history.back()}onItemAdded(e){this.debug&&this.log("onItemAdded",e,this.navigations),e.noHistory||this.pushState()}pushItem(e){this.navigations.push(e),this.onItemAdded(e)}spliceItems(e,t,...s){this.navigations.splice(e,t,...s),s.forEach(e=>{this.onItemAdded(e)})}pushState(){this.manual=!1,history.pushState(this.id,"")}replaceState(){this.debug&&this.log.warn("replace");const e=location.origin+location.pathname+location.search+this.overriddenHash;history.replaceState(this.id,"",e)}removeItem(e){Object(l.f)(this.navigations,e)}removeByType(e,t=!1){for(let s=this.navigations.length-1;s>=0;--s){if(this.navigations[s].type===e&&(this.navigations.splice(s,1),t))break}}};i.a.appNavigationController=c,t.a=c},148:function(e,t,s){"use strict";var i=s(73);const n=(e,t,s,a,o,r)=>{const{timeout:l,raf:d}=e.dataset;if(void 0!==l&&clearTimeout(+l),void 0!==d&&(window.cancelAnimationFrame(+d),r||delete e.dataset.raf),r&&i.default.settings.animationsEnabled&&a)return void(e.dataset.raf=""+window.requestAnimationFrame(()=>{delete e.dataset.raf,n(e,t,s,a,o,r-1)}));s&&t&&e.classList.add(t);const c=()=>{delete e.dataset.timeout,!s&&t&&e.classList.remove("backwards",t),e.classList.remove("animating"),o&&o()};if(!i.default.settings.animationsEnabled||!a)return e.classList.remove("animating","backwards"),void c();e.classList.add("animating"),e.classList.toggle("backwards",!s),e.dataset.timeout=""+setTimeout(c,a)};t.a=n},150:function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var i=s(11),n=s(139),a=s(159);function o(e,t=!0){const s=[],i=[],o=t?[]:void 0;Object(a.a)(e,s,i,void 0,void 0,o),i.length&&s.push(i.join(""));let r=s.join("\n");return r=r.replace(/\u00A0/g," "),o&&n.b.combineSameEntities(o),{value:r,entities:o}}i.a.getRichValue=o},151:function(e,t,s){"use strict";function i(e,t){const s=new Event(t,{bubbles:!0,cancelable:!0});e.dispatchEvent(s)}s.d(t,"a",(function(){return i}))},153:function(e,t,s){"use strict";s.d(t,"b",(function(){return d})),s.d(t,"a",(function(){return c}));var i=s(74),n=s(24),a=s(175),o=s(170),r=s(79);class l{constructor(e,t="",s=document.createElement("div")){this.el=e,this.container=s,this.onScrollMeasure=0,this.isHeavyAnimationInProgress=!1,this.needCheckAfterAnimation=!1,this.container.classList.add("scrollable"),this.log=Object(n.b)("SCROLL"+(t?"-"+t:""),n.a.Error),e&&(Array.from(e.children).forEach(e=>this.container.append(e)),e.append(this.container))}setListeners(){window.addEventListener("resize",this.onScroll,{passive:!0}),this.container.addEventListener("scroll",this.onScroll,{passive:!0,capture:!0}),Object(o.a)(()=>{this.isHeavyAnimationInProgress=!0,this.onScrollMeasure&&(this.needCheckAfterAnimation=!0,window.cancelAnimationFrame(this.onScrollMeasure))},()=>{this.isHeavyAnimationInProgress=!1,this.needCheckAfterAnimation&&(this.onScroll(),this.needCheckAfterAnimation=!1)})}append(e){this.container.append(e)}scrollIntoViewNew(e,t,s,i,n,o,r,l){return Object(a.b)(this.container,e,t,s,i,n,o,r,l)}}class d extends l{constructor(e,t="",s=300,i){super(e,t),this.onScrollOffset=s,this.onAdditionalScroll=null,this.onScrolledTop=null,this.onScrolledBottom=null,this.lastScrollTop=0,this.lastScrollDirection=0,this.loadedAll={top:!0,bottom:!1},this.onScroll=()=>{if(this.isHeavyAnimationInProgress)return this.onScrollMeasure&&window.cancelAnimationFrame(this.onScrollMeasure),void(this.needCheckAfterAnimation=!0);(this.onScrolledTop||this.onScrolledBottom||this.splitUp||this.onAdditionalScroll)&&(this.onScrollMeasure&&window.cancelAnimationFrame(this.onScrollMeasure),this.onScrollMeasure=window.requestAnimationFrame(()=>{this.onScrollMeasure=0;const e=this.container.scrollTop;this.lastScrollDirection=this.lastScrollTop===e?0:this.lastScrollTop<e?1:-1,this.lastScrollTop=e,this.onAdditionalScroll&&0!==this.lastScrollDirection&&this.onAdditionalScroll(),this.checkForTriggers&&this.checkForTriggers()}))},this.checkForTriggers=()=>{if(!this.onScrolledTop&&!this.onScrolledBottom)return;if(this.isHeavyAnimationInProgress)return void this.onScroll();const e=this.container.scrollHeight;if(!e)return;const t=e-this.container.clientHeight,s=this.lastScrollTop;this.onScrolledTop&&s<=this.onScrollOffset&&this.lastScrollDirection<=0&&this.onScrolledTop(),this.onScrolledBottom&&t-s<=this.onScrollOffset&&this.lastScrollDirection>=0&&this.onScrolledBottom()},this.container.classList.add("scrollable-y"),this.setListeners()}setVirtualContainer(e){this.splitUp=e,this.log("setVirtualContainer:",e,this)}prepend(...e){(this.splitUp||this.padding||this.container).prepend(...e)}append(...e){(this.splitUp||this.padding||this.container).append(...e)}getDistanceToEnd(){return this.scrollHeight-Math.round(this.scrollTop+this.container.offsetHeight)}get isScrolledDown(){return this.getDistanceToEnd()<=1}set scrollTop(e){this.container.scrollTop=e}get scrollTop(){return this.container.scrollTop}get scrollHeight(){return this.container.scrollHeight}}class c extends l{constructor(e,t="",s=300,n=15,a=document.createElement("div")){if(super(e,t,a),this.onScrollOffset=s,this.splitCount=n,this.container=a,this.container.classList.add("scrollable-x"),!i.IS_TOUCH_SUPPORTED){const e=e=>{!e.deltaX&&this.container.scrollWidth>this.container.clientWidth&&(this.container.scrollLeft+=e.deltaY/4,Object(r.a)(e))};this.container.addEventListener("wheel",e,{passive:!1})}}}},154:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(156);function n(e){return Array.from(e.childNodes).map(e=>e.nodeType===e.TEXT_NODE?Object(i.d)(e.textContent):e.outerHTML).join("")}},155:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var i=s(116),n=s(80),a=s(117),o=s(115);class r{constructor(e={}){const t=this.label=document.createElement("label");t.classList.add("checkbox-field"),e.restriction&&t.classList.add("checkbox-field-restriction"),e.round&&t.classList.add("checkbox-field-round"),e.disabled&&this.toggleDisability(!0),this.listenerSetter=e.listenerSetter;const s=this.input=document.createElement("input");if(s.classList.add("checkbox-field-input"),s.type="checkbox",e.name&&(s.id="input-"+e.name),e.checked&&(s.checked=!0),e.stateKey){let t=void 0!==e.checked;const a=()=>{if(!t)return;let n;e.stateValues?n=e.stateValues[s.checked?1:0]:(n=s.checked,e.stateValueReverse&&(n=!n)),i.default.setByKey(e.stateKey,n)};!t&&i.default.getState().then(s=>{t=!0;const i=Object(n.d)(s,e.stateKey);let a;e.stateValues?a=1===e.stateValues.indexOf(i):(a=i,e.stateValueReverse&&(a=!a)),this.setValueSilently(a)}),e.listenerSetter?e.listenerSetter.add(s)("change",a):s.addEventListener("change",a)}let r;if(e.text?(r=this.span=document.createElement("span"),r.classList.add("checkbox-caption"),Object(o._i18n)(r,e.text,e.textArgs)):t.classList.add("checkbox-without-caption"),t.append(s),e.toggle){t.classList.add("checkbox-field-toggle");const e=document.createElement("div");e.classList.add("checkbox-toggle"),t.append(e)}else{const e=document.createElement("div");e.classList.add("checkbox-box");const s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.classList.add("checkbox-box-check"),s.setAttributeNS(null,"viewBox","0 0 24 24");const i=document.createElementNS("http://www.w3.org/2000/svg","use");i.setAttributeNS(null,"href","#check"),i.setAttributeNS(null,"x","-1"),s.append(i);const n=document.createElement("div");n.classList.add("checkbox-box-background");const a=document.createElement("div");a.classList.add("checkbox-box-border"),e.append(a,n,s),t.append(e)}r&&t.append(r),e.withRipple?(t.classList.add("checkbox-ripple","hover-effect"),Object(a.ripple)(t,void 0,void 0,!0)):e.withHover&&t.classList.add("hover-effect")}get checked(){return this.input.checked}set checked(e){this.setValueSilently(e);const t=new Event("change",{bubbles:!0,cancelable:!0});this.input.dispatchEvent(t)}setValueSilently(e){this.input.checked=e}toggleDisability(e){return this.label.classList.toggle("checkbox-disabled",e),()=>this.toggleDisability(!e)}}},157:function(e,t,s){"use strict";function i(e,t){return t?e.forEach(e=>e.setAttribute("disabled","true")):e.forEach(e=>e.removeAttribute("disabled")),()=>i(e,!t)}s.d(t,"a",(function(){return i}))},158:function(e,t,s){"use strict";function i(e,t){return e.closest(`[${t}]`)}s.d(t,"a",(function(){return i}))},159:function(e,t,s){"use strict";s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return n}));const i={bold:{match:'[style*="font-weight"], b',entityName:"messageEntityBold"},underline:{match:'[style*="underline"], u',entityName:"messageEntityUnderline"},italic:{match:'[style*="italic"], i',entityName:"messageEntityItalic"},monospace:{match:'[style*="monospace"], [face="monospace"], pre',entityName:"messageEntityPre"},strikethrough:{match:'[style*="line-through"], strike',entityName:"messageEntityStrike"},link:{match:"A:not(.follow)",entityName:"messageEntityTextUrl"},mentionName:{match:"A.follow",entityName:"messageEntityMentionName"}};function n(e,t,s,a,o,r,l={offset:0}){if(3===e.nodeType){const t=e.nodeValue;if(a===e?s.push(t.substr(0,o)+""+t.substr(o)):s.push(t),r&&t.trim()&&e.parentNode){const s=e.parentElement;for(const e in i){const n=i[e],a=s.closest(n.match+", [contenteditable]");a&&null===a.getAttribute("contenteditable")&&("messageEntityTextUrl"===n.entityName?r.push({_:n.entityName,url:s.href,offset:l.offset,length:t.length}):"messageEntityMentionName"===n.entityName?r.push({_:n.entityName,offset:l.offset,length:t.length,user_id:s.dataset.follow.toUserId()}):r.push({_:n.entityName,offset:l.offset,length:t.length}))}}return void(l.offset+=t.length)}if(1!==e.nodeType)return;const d=a===e,c="DIV"===e.tagName||"P"===e.tagName;if(c&&s.length||"BR"===e.tagName)t.push(s.join("")),s.splice(0,s.length);else if(e instanceof HTMLImageElement){const t=e.alt;t&&(s.push(t),l.offset+=t.length)}d&&!o&&s.push("");let h=e.firstChild;for(;h;)n(h,t,s,a,o,r,l),h=h.nextSibling;d&&o&&s.push(""),c&&s.length&&(t.push(s.join("")),s.splice(0,s.length))}},160:function(e,t,s){"use strict";var i=s(83),n=s(48),a=s(11),o=s(161);const r=new class{constructor(){this.promises={},this.raf=i.b.bind(null),this.scheduled=!1}do(e,t){let s=this.promises[e];return s||(this.scheduleFlush(),s=this.promises[e]=Object(n.a)()),void 0!==t&&s.then(()=>t()),s}measure(e){return this.do("read",e)}mutate(e){return this.do("write",e)}mutateElement(e,t){const s=Object(o.a)(e)?this.mutate():Promise.resolve();return void 0!==t&&s.then(()=>t()),s}scheduleFlush(){this.scheduled||(this.scheduled=!0,this.raf(()=>{this.promises.read&&this.promises.read.resolve(),this.promises.write&&this.promises.write.resolve(),this.scheduled=!1,this.promises={}}))}};a.a&&(a.a.sequentialDom=r),t.a=r},163:function(e,t,s){"use strict";var i=s(11),n=s(17),a=s(140);const o=new class{constructor(){this.serverTimeOffset=0,n.a.get("server_time_offset").then(e=>{e&&(this.serverTimeOffset=e)}),a.a.addTaskListener("applyServerTimeOffset",e=>{this.serverTimeOffset=e.payload})}};i.a&&(i.a.serverTimeManager=o),t.a=o},164:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(150);function n(e){return e.hasAttribute("contenteditable")||"INPUT"!==e.tagName?!Object(i.a)(e,!1).value.trim():!e.value.trim()}},167:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(54);function n(e){return i.IS_MOBILE_SAFARI&&e instanceof TouchEvent&&e.touches[0].clientX<30}},169:function(e,t,s){"use strict";function i(e,t){return e.closest(t)}s.d(t,"a",(function(){return i}))},171:function(e,t,s){"use strict";var i=s(11),n=s(140),a=s(1),o=s(91);const r=new class{getState(){return n.a.invokeApi("account.getPasswordLayer68",{}).then(e=>e)}getLoginState(){return n.a.invokeApi("account.getPassword").then(e=>e)}updateSettings(e={}){return this.getState().then(t=>{const s={current_password_hash:null,new_settings:{_:"account.passwordInputSettingsLayer68",flags:0,hint:e.hint,email:e.email}};if(e.newPassword){if("account.password2"===t._)Object(o.b)(e.currentPassword,t.current_salt).then(i=>{s.current_password_hash=i;const r=new Array(8),l=Object(a.a)(t.new_salt,r);s.new_settings.new_salt=l,s.new_settings.flags|=1,Object(o.b)(e.newPassword,l).then(t=>(s.new_settings.new_password_hash=t,s.new_settings.flags|=1,s.new_settings.hint=e.hint,s.new_settings.email=e.email,s.new_settings.flags|=2,n.a.invokeApi("account.updatePasswordSettingsLayer68",s)))});else if("account.noPassword"===t._){s.current_password_hash=new Uint8Array;const i=new Array(8),r=Object(a.a)(t.new_salt,i);s.new_settings.new_salt=r,s.new_settings.flags|=1,Object(o.b)(e.newPassword,r).then(t=>(s.new_settings.new_password_hash=t,s.new_settings.flags|=1,s.new_settings.hint=e.hint,e.email?s.new_settings.email=e.email:s.new_settings.email=void 0,n.a.invokeApi("account.updatePasswordSettingsLayer68",s)))}}else{if("account.noPassword"===t._&&e.email)return s.new_settings.flags=2,s.new_settings.email="",s.current_password_hash=new Uint8Array,n.a.invokeApi("account.updatePasswordSettingsLayer68",s);"account.password2"===t._&&Object(o.b)(e.currentPassword,t.current_salt).then(e=>(s.current_password_hash=e,s.new_settings.flags=3,s.new_settings.email="",s.new_settings.hint="",s.new_settings.new_password_hash=new Uint8Array,s.new_settings.new_salt=new Uint8Array,n.a.invokeApi("account.updatePasswordSettingsLayer68",s)))}})}check(e,t,s={},i){return"account.password2"===t._?Object(o.b)(e,t.current_salt).then(e=>{var t,a;return n.a.invokeApi("auth.checkPassword2",{password_hash:e,flags:2,phone_number:null!==(t=i.phone_number)&&void 0!==t?t:"0",phone_code:null!==(a=i.phone_code)&&void 0!==a?a:"0"},s).then(e=>("auth.authorization"===e._&&n.a.setUser(e.user),e))}):n.a.invokeCrypto("computeSRP",e,t,!1).then(e=>n.a.invokeApi("auth.checkPassword",{password:e},s).then(e=>("auth.authorization"===e._&&n.a.setUser(e.user),e)))}check2StepPassword(e,t,s={}){if("account.password2"===t._)return Object(o.b)(e,t.current_salt).then(e=>n.a.invokeApi("account.getPasswordSettings68",{password_hash:e}))}confirmPasswordEmail(e){return n.a.invokeApi("account.confirmPasswordEmail",{code:e})}resendPasswordEmail(){return n.a.invokeApi("account.resendPasswordEmail")}cancelPasswordEmail(){return n.a.invokeApi("account.cancelPasswordEmail")}};i.a.passwordManager=r,t.a=r},177:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var i=s(115);const n=new Map;let a=0;const o=(e,t,s="")=>{s=t.country_code+s,a=Math.max(a,s.length),n.set(s,{country:e,code:t})};function r(e){n.size||i.default.countriesList.forEach(e=>{e.country_codes.forEach(t=>{t.prefixes?t.prefixes.forEach(s=>{o(e,t,s)}):o(e,t)})});let t,s=e.replace(/\D/g,""),r=s.slice(0,a);for(let e=r.length-1;e>=0&&(t=n.get(r.slice(0,e+1)),!t);--e);if(!t)return{formatted:s,country:void 0,code:void 0,leftPattern:""};const l=t.country,d=t.code.patterns||[],c=s.slice(t.code.country_code.length);let h="",u=0,p="";for(let e=d.length-1;e>=0;--e){h=d[e];const t=h.replace(/ /g,"");let s=0;for(let e=0,i=Math.min(c.length,t.length);e<i;++e){if(c[e]!==t[e]&&"X"!==t[e]){s=0;break}++s}s>u&&(u=s,p=h)}h=p||h,h=h.replace(/\d/g,"X"),h=t.code.country_code+" "+h,h.split("").forEach((e,t)=>{" "===e&&" "!==s[t]&&s.length>t&&(s=s.slice(0,t)+" "+s.slice(t))});let g=h&&h.length>s.length?h.slice(s.length):"";return g&&(g=g.replace(/X/g,"â€’")),{formatted:s,country:l,code:t.code,leftPattern:g}}},178:function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var i=s(79),n=s(146);class a extends n.b{constructor(e={}){super(Object.assign({plainText:!0},e)),this.passwordVisible=!1,this.onVisibilityClick=e=>{Object(i.a)(e),this.passwordVisible=!this.passwordVisible,this.toggleVisible.classList.toggle("eye-hidden",this.passwordVisible),this.input.type=this.passwordVisible?"text":"password",this.onVisibilityClickAdditional&&this.onVisibilityClickAdditional()};const t=this.input;t.type="password",t.setAttribute("required",""),t.autocomplete="off";const s=document.createElement("input");s.classList.add("stealthy"),s.tabIndex=-1,s.type="password",t.parentElement.prepend(s),t.parentElement.insertBefore(s.cloneNode(),t.nextSibling);const n=this.toggleVisible=document.createElement("span");n.classList.add("toggle-visible","tgico"),this.container.classList.add("input-field-password"),this.container.append(n),n.addEventListener("click",this.onVisibilityClick),n.addEventListener("touchend",this.onVisibilityClick)}}},179:function(e,t,s){"use strict";function i(e){const t=document.createElement("span");return"string"==typeof e?t.innerHTML=e:t.append(e),t}s.d(t,"a",(function(){return i}))},180:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(74);function n(e,t=!1){if(!i.IS_TOUCH_SUPPORTED||t&&document.activeElement===e)if(e.focus(),void 0!==window.getSelection&&void 0!==document.createRange){var s=document.createRange();s.selectNodeContents(e),s.collapse(!1);var n=window.getSelection();n.removeAllRanges(),n.addRange(s)}else if(void 0!==document.body.createTextRange){var a=document.body.createTextRange();a.moveToElementText(e),a.collapse(!1),a.select()}}},181:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(149);class n{constructor(e){this.size=e,this.needFrame=0,this.container=document.createElement("div"),this.container.classList.add("media-sticker-wrapper")}load(){return this.loadPromise?this.loadPromise:this.loadPromise=i.b.loadAnimationFromURL({container:this.container,loop:!1,autoplay:!0,width:this.size,height:this.size,noCache:!0},"assets/img/TwoFactorSetup.tgs").then(e=>(this.animation=e,this.animation.play(),i.b.waitForFirstFrame(e)))}remove(){this.animation&&this.animation.remove()}}},184:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(146);class n extends i.b{constructor(e){super(Object.assign({plainText:!0},e));const t=this.input;t.type="tel",t.setAttribute("required",""),t.autocomplete="off";let s=0;this.input.addEventListener("input",t=>{this.input.classList.remove("error"),this.setLabel();const i=this.value.replace(/\D/g,"").slice(0,e.length);this.setValueSilently(i);const n=this.value.length;if(n===e.length)e.onFill(this.value);else if(n===s)return;s=n})}}},186:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var i=s(22),n=s(88),a=s(194),o=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class r{constructor(e){this.dbName=e,this.useStorage=!0,i.a.test&&(this.dbName+="_test"),r.STORAGES.length&&(this.useStorage=r.STORAGES[0].useStorage),this.openDatabase(),r.STORAGES.push(this)}openDatabase(){var e;return null!==(e=this.openDbPromise)&&void 0!==e?e:this.openDbPromise=caches.open(this.dbName)}delete(e){return this.timeoutOperation(t=>t.delete("/"+e))}deleteAll(){return caches.delete(this.dbName)}get(e){return this.timeoutOperation(t=>t.match("/"+e))}save(e,t){return this.timeoutOperation(s=>s.put("/"+e,t))}getFile(e,t="blob"){return this.get(e).then(e=>{if(!e)throw"NO_ENTRY_FOUND";return e[t]()})}saveFile(e,t){t instanceof Blob||(t=Object(n.a)(t));const s=new Response(t,{headers:{"Content-Length":""+t.size}});return this.save(e,s).then(()=>t)}timeoutOperation(e){return this.useStorage?new Promise((t,s)=>o(this,void 0,void 0,(function*(){let i=!1;const n=setTimeout(()=>{s(),i=!0},15e3);try{const s=yield this.openDatabase();if(!s)throw this.useStorage=!1,this.openDbPromise=void 0,"no cache?";const n=yield e(s);if(i)return;t(n)}catch(e){s(e)}clearTimeout(n)}))):Promise.reject("STORAGE_OFFLINE")}getFileWriter(e,t){const s=a.a.getFakeFileWriter(t,t=>this.saveFile(e,t).catch(()=>t));return Promise.resolve(s)}static toggleStorage(e){return Promise.all(this.STORAGES.map(t=>{if(t.useStorage=e,!e)return t.deleteAll()}))}}r.STORAGES=[]},187:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(149);class n{constructor(e){this.size=e,this.needFrame=0,this.container=document.createElement("div"),this.container.classList.add("media-sticker-wrapper")}load(){return this.loadPromise?this.loadPromise:this.loadPromise=i.b.loadAnimationFromURL({container:this.container,loop:!0,autoplay:!0,width:this.size,height:this.size,noCache:!0},"assets/img/islamic.tgs").then(e=>(this.animation=e,this.animation.play(),i.b.waitForFirstFrame(e)))}remove(){this.animation&&this.animation.remove()}}},188:function(e,t,s){"use strict";function i(e,t=0,s=null){let{h:i,m:n,s:a}=r(t);e.textContent=l(i,n,a);let o=setInterval(()=>{let{h:i,m:n,s:a}=r(t);e.textContent=l(i,n,a),0===t&&(null!==s&&s(),clearInterval(o)),t-=1},1e3);function r(e=0){let s,i,n,a;return s=Math.floor(t/60/60),a=t-60*s*60,i=Math.floor(a/60),a-=60*i,n=a,{h:s,m:i,s:n}}function l(e=0,t=0,s=0){return(t<10?"0"+t:t)+":"+(s<10?"0"+s:s)}}s.d(t,"a",(function(){return i}))},194:function(e,t,s){"use strict";var i=s(88),n=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};t.a=new class{constructor(){this.blobSupported=!0;try{Object(i.a)([],"")}catch(e){this.blobSupported=!1}}isAvailable(){return this.blobSupported}write(e,t){return t instanceof Blob?Object(i.e)(t).then(t=>e.write(t)):e.write(t)}getFakeFileWriter(e,t){const s=[];return{write:e=>n(this,void 0,void 0,(function*(){if(!this.blobSupported)throw!1;s.push(e)})),truncate:()=>{s.length=0},finalize:(n=!0)=>{const a=Object(i.a)(s,e);return n&&t&&t(a),a}}}}},196:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var i=s(180),n=s(177),a=s(54),o=s(146);class r extends o.b{constructor(e={}){super(Object.assign({label:"Contacts.PhoneNumber.Placeholder",name:"phone"},e)),this.pasted=!1,this.lastValue="+98",this.container.classList.add("input-field-phone");let t=this.input;if(t instanceof HTMLInputElement)t.type="tel",t.autocomplete="rr55RandomRR55";else{t.inputMode="decimal";const e=window.devicePixelRatio;if(e>1){let s;a.IS_APPLE?s=-.16*e:a.IS_ANDROID&&(s=0),t.style.setProperty("--letter-spacing",s+"px")}const s=this.setValueSilently.bind(this);this.setValueSilently=e=>{s(e),Object(i.a)(this.input,!0)}}t.addEventListener("input",()=>{t.classList.remove("error");const s=this.value;let i;Math.abs(s.length-this.lastValue.length)>1&&!this.pasted&&a.IS_APPLE_MOBILE&&this.setValueSilently(this.lastValue+s),this.pasted=!1,this.setLabel();let o,r,l,d="";"+"===this.value.replace(/\++/,"+")?this.setValueSilently("+"):(i=Object(n.a)(this.value),o=i.formatted,r=i.country,d=i.leftPattern,l=i.code,this.setValueSilently(this.lastValue=o?"+"+o:"")),t.dataset.leftPattern=d,e.onInput&&e.onInput(i)}),t.addEventListener("paste",()=>{this.pasted=!0}),t.addEventListener("keypress",e=>{const t=e.key;if(/\D/.test(t)&&!e.metaKey&&!e.ctrlKey&&"Backspace"!==t&&("+"!==t||!e.shiftKey))return e.preventDefault(),!1})}}},201:function(e,t,s){"use strict";s.r(t),s.d(t,"AppDialogsManager",(function(){return Xd}));var i=s(24);class n{constructor(e){this.items=new Map,this.locked=!1,this.observer=new IntersectionObserver(t=>{if(this.locked)return;const s=[];t.forEach(e=>{const t=e.target;this.items.get(t)!==e.isIntersecting&&(this.items.set(t,e.isIntersecting),s[e.isIntersecting?"unshift":"push"]({target:t,visible:e.isIntersecting}))}),s.forEach(t=>{e(t.target,t.visible)})})}getVisible(){const e=[];return this.items.forEach((t,s)=>{t&&e.push(s)}),e}clearVisible(){const e=this.getVisible();for(const t of e)this.items.set(t,!1)}isVisible(e){return this.items.get(e)}disconnect(){this.observer.disconnect(),this.items.clear()}refresh(){this.observer.disconnect();const e=[...this.items.keys()];for(const t of e)this.observer.observe(t)}refreshVisible(){const e=this.getVisible();for(const t of e)this.observer.unobserve(t);for(const t of e)this.observer.observe(t)}observe(e){this.items.set(e,!1),this.observer.observe(e)}unobserve(e){this.observer.unobserve(e),this.items.delete(e)}unlock(){this.locked=!1}unlockAndRefresh(){this.unlock(),this.refresh()}lock(){this.locked=!0}}var a=s(82),o=s(65),r=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class l{constructor(e=8){this.parallelLimit=e,this.queueId=0,this.queue=[],this.inProcess=new Set,this.lockPromise=null,this.unlockResolve=null,this.log=Object(i.b)("LL",i.a.Error),this.processQueue=Object(o.a)(()=>this._processQueue(),20,!1)}clear(){this.inProcess.clear(),this.queue.length=0}lock(){this.lockPromise||(this.lockPromise=new Promise((e,t)=>{this.unlockResolve=e}))}unlock(){this.unlockResolve&&(this.unlockResolve(),this.unlockResolve=this.lockPromise=null,this.processQueue())}processItem(e){return r(this,void 0,void 0,(function*(){if(!this.lockPromise){this.inProcess.add(e);try{yield this.loadItem(e)}catch(e){["NO_ENTRY_FOUND","STORAGE_OFFLINE"].includes(e)||this.log.error("loadMediaQueue error:",e)}this.inProcess.delete(e),this.processQueue()}}))}loadItem(e){return e.load()}getItem(){return this.queue.shift()}addElement(e,t){this.queue[e](t),this.processQueue()}_processQueue(e){if(!this.queue.length||this.lockPromise||this.parallelLimit>0&&this.inProcess.size>=this.parallelLimit)return;do{if(e?Object(a.f)(this.queue,e):e=this.getItem(),!e)break;this.processItem(e),e=null}while(this.inProcess.size<this.parallelLimit&&this.queue.length)}push(e){this.addElement("push",e)}unshift(e){this.addElement("unshift",e)}}class d extends l{constructor(e=8){super(e),this.parallelLimit=e,this.queue=[],this.inProcess=new Set}lock(){super.lock(),this.intersector.lock()}unlock(){super.unlock(),this.intersector.unlock()}unlockAndRefresh(){super.unlock(),this.intersector.unlockAndRefresh()}clear(){super.clear(),this.intersector.disconnect()}refresh(){this.intersector.refresh()}loadItem(e){return e.load(e.div)}addElement(e,t){if(this.queue.find(e=>e.div===t.div&&e.load===t.load))return!1;for(const e of this.inProcess)if(e.div===t.div&&e.load===t.load)return!1;return this.queue[e](t),!0}setProcessQueueTimeout(){this.intersectorTimeout||(this.intersectorTimeout=window.setTimeout(()=>{this.intersectorTimeout=0,this.processQueue()},0))}push(e){super.push(e)}unshift(e){super.unshift(e)}unobserve(e){Object(a.d)(this.queue,t=>t.div===e),this.intersector.unobserve(e)}}class c extends d{constructor(e=8){super(e),this.parallelLimit=e,this.onVisibilityChange=(e,t)=>{t&&(Object(a.d)(this.queue,t=>t.div===e).forEach(e=>{e.wasSeen=!0,this.queue.unshift(e)}),this.setProcessQueueTimeout())},this.intersector=new n(this.onVisibilityChange)}getItem(){return this.queue.findAndSplice(e=>e.wasSeen)}processItem(e){const t=Object.create(null,{processItem:{get:()=>super.processItem}});return r(this,void 0,void 0,(function*(){yield t.processItem.call(this,e),this.intersector.unobserve(e.div)}))}addElement(e,t){return!!super.addElement(e,t)&&(this.intersector.observe(t.div),t.hasOwnProperty("wasSeen")||(t.wasSeen=!1),!0)}}class h extends d{constructor(e=8,t){super(e),this.parallelLimit=e,this.onVisibilityChange=t,this._queue=new Map,this.intersector=new n((e,t)=>{const s=Object(a.d)(this.queue,t=>t.div===e);if(t){(s.length?s:[this._queue.get(e)]).forEach(t=>{this.queue.unshift(t||this._queue.get(e))})}this.onVisibilityChange&&this.onVisibilityChange(e,t),this.setProcessQueueTimeout()})}clear(){super.clear(),this._queue.clear()}observe(e){this._queue.set(e.div,e),this.intersector.observe(e.div)}}class u extends d{constructor(e=8,t){super(e),this.parallelLimit=e,this.onVisibilityChange=t,this.intersector=new n((e,t)=>{const s=Object(a.d)(this.queue,t=>t.div===e);t&&s.length&&s.forEach(e=>{this.queue.unshift(e)}),this.onVisibilityChange&&this.onVisibilityChange(e,t),this.setProcessQueueTimeout()})}observe(e){this.intersector.observe(e)}}var p=s(148),g=s(83),m=s(80),f=s(79),v=s(138),b=s(161);class y{constructor(e){this.tempId=0,this.detached=!0,this.promise=null,this.isUpload=!1,this.cancelable=!0,this.streamable=!1,this.tryAgainOnFail=!0,this.attachMethod="append",this.onClick=e=>{e&&Object(f.a)(e),this.preloader.classList.contains("manual")?this.loadFunc&&this.loadFunc(e):this.promise&&this.promise.cancel&&this.promise.cancel()},e&&Object(m.g)(this,e)}constructContainer(e={}){this.preloader||(this.preloader=document.createElement("div"),this.preloader.classList.add("preloader-container"),e.color&&this.preloader.classList.add("preloader-"+e.color),e.bold&&this.preloader.classList.add("preloader-bold"),this.streamable&&this.preloader.classList.add("preloader-streamable"))}constructDownloadIcon(){this.constructContainer()}construct(){this.construct=null,this.constructContainer(),this.preloader.innerHTML=`\n    <div class="you-spin-me-round">\n    <svg xmlns="http://www.w3.org/2000/svg" class="preloader-circular" viewBox="${this.streamable?"25 25 50 50":"27 27 54 54"}">\n    <circle class="preloader-path-new" cx="${this.streamable?"50":"54"}" cy="${this.streamable?"50":"54"}" r="${this.streamable?19:24}" fill="none" stroke-miterlimit="10"/>\n    </svg>\n    </div>`,this.streamable?this.totalLength=118.61124420166016:this.totalLength=149.82473754882812,this.cancelable?(this.preloader.innerHTML+='\n      <svg xmlns="http://www.w3.org/2000/svg" class="preloader-close" viewBox="0 0 24 24">\n        <g fill="none" fill-rule="evenodd">\n          <polygon points="0 0 24 0 24 24 0 24"/>\n          <path fill="#000" fill-rule="nonzero" d="M5.20970461,5.38710056 L5.29289322,5.29289322 C5.65337718,4.93240926 6.22060824,4.90467972 6.61289944,5.20970461 L6.70710678,5.29289322 L12,10.585 L17.2928932,5.29289322 C17.6834175,4.90236893 18.3165825,4.90236893 18.7071068,5.29289322 C19.0976311,5.68341751 19.0976311,6.31658249 18.7071068,6.70710678 L13.415,12 L18.7071068,17.2928932 C19.0675907,17.6533772 19.0953203,18.2206082 18.7902954,18.6128994 L18.7071068,18.7071068 C18.3466228,19.0675907 17.7793918,19.0953203 17.3871006,18.7902954 L17.2928932,18.7071068 L12,13.415 L6.70710678,18.7071068 C6.31658249,19.0976311 5.68341751,19.0976311 5.29289322,18.7071068 C4.90236893,18.3165825 4.90236893,17.6834175 5.29289322,17.2928932 L10.585,12 L5.29289322,6.70710678 C4.93240926,6.34662282 4.90467972,5.77939176 5.20970461,5.38710056 L5.29289322,5.29289322 L5.20970461,5.38710056 Z"/>\n        </g>\n      </svg>\n      <svg xmlns="http://www.w3.org/2000/svg" class="preloader-download" viewBox="0 0 24 24">\n        <g fill="none" fill-rule="evenodd">\n          <polygon points="0 0 24 0 24 24 0 24"/>\n          <path fill="#000" fill-rule="nonzero" d="M5,19 L19,19 C19.5522847,19 20,19.4477153 20,20 C20,20.5128358 19.6139598,20.9355072 19.1166211,20.9932723 L19,21 L5,21 C4.44771525,21 4,20.5522847 4,20 C4,19.4871642 4.38604019,19.0644928 4.88337887,19.0067277 L5,19 L19,19 L5,19 Z M11.8833789,3.00672773 L12,3 C12.5128358,3 12.9355072,3.38604019 12.9932723,3.88337887 L13,4 L13,13.585 L16.2928932,10.2928932 C16.6533772,9.93240926 17.2206082,9.90467972 17.6128994,10.2097046 L17.7071068,10.2928932 C18.0675907,10.6533772 18.0953203,11.2206082 17.7902954,11.6128994 L17.7071068,11.7071068 L12.7071068,16.7071068 C12.3466228,17.0675907 11.7793918,17.0953203 11.3871006,16.7902954 L11.2928932,16.7071068 L6.29289322,11.7071068 C5.90236893,11.3165825 5.90236893,10.6834175 6.29289322,10.2928932 C6.65337718,9.93240926 7.22060824,9.90467972 7.61289944,10.2097046 L7.70710678,10.2928932 L11,13.585 L11,4 C11,3.48716416 11.3860402,3.06449284 11.8833789,3.00672773 L12,3 L11.8833789,3.00672773 Z"/>\n        </g>\n      </svg>',this.downloadSvg=this.preloader.lastElementChild,this.cancelSvg=this.downloadSvg.previousElementSibling):this.preloader.classList.add("preloader-swing"),this.circle=this.preloader.firstElementChild.firstElementChild.firstElementChild,this.cancelable&&Object(v.b)(this.preloader,this.onClick)}setDownloadFunction(e){this.loadFunc=e}setManual(){this.preloader.classList.add("manual"),this.setProgress(0)}attachPromise(e){if(this.isUpload&&this.promise)return;this.promise=e;const t=--this.tempId,s=Date.now(),i=i=>{if(e.notify=e.notifyAll=null,t!==this.tempId)return;const n=Date.now()-s;if(!i&&this.cancelable){this.setProgress(100);const e=150;n<e?this.detach():setTimeout(()=>{t===this.tempId&&this.detach()},e)}else this.tryAgainOnFail?(this.attach(this.preloader.parentElement),Object(g.b)(()=>{this.setManual()})):this.detach();this.promise=e=null};e.then(()=>i(null)).catch(e=>i(e)),e.addNotifyListener&&e.addNotifyListener(e=>{if(t!==this.tempId)return;const s=e.done/e.total*100;this.setProgress(s)})}attach(e,t=!1,s){if(this.construct&&this.construct(),this.preloader.parentElement&&this.preloader.classList.remove("manual"),this.detached=!1,s&&this.attachPromise(s),this.detached||this.preloader.parentElement!==e){const t=Object(b.a)(this.preloader)?1:2;this.preloader.parentElement!==e&&e[this.attachMethod](this.preloader),Object(p.a)(this.preloader,"is-visible",!0,200,void 0,t)}this.cancelable&&t&&this.setProgress(0)}detach(){this.detached||(this.detached=!0,this.preloader&&this.preloader.parentElement&&Object(p.a)(this.preloader,"is-visible",!1,200,()=>{this.preloader.remove()},1))}setProgress(e){if(this.totalLength||Object(b.a)(this.circle))if(0!==e)try{this.totalLength||(this.totalLength=this.circle.getTotalLength()),this.circle.style.strokeDasharray=Math.max(5,e/100*this.totalLength)+", "+this.totalLength}catch(e){}else this.circle.style.strokeDasharray=""}}var w=s(48),S=s(152),I=s(144),M=s(166),C=s(54),P=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};function L(e){let t,s;return e instanceof HTMLVideoElement?(t=e.videoWidth,s=e.videoHeight):(t=e.naturalWidth,s=e.naturalHeight),i={media:e,mediaSize:Object(I.c)(t,s),boxSize:Object(I.c)(320,240),quality:.9},new Promise(e=>{var t,s;const n=document.createElement("canvas"),a=i.mediaSize.aspectFitted(i.boxSize);n.width=a.width*window.devicePixelRatio,n.height=a.height*window.devicePixelRatio,n.getContext("2d").drawImage(i.media,0,0,n.width,n.height),n.toBlob(t=>{e({blob:t,size:a})},null!==(t=i.mimeType)&&void 0!==t?t:"image/jpeg",null!==(s=i.quality)&&void 0!==s?s:1)});var i}function E(e){return new Promise((t,s)=>{e.onseeked=()=>{e.onseeked=()=>{L(e).then(t),e.onseeked=void 0},e.currentTime=0},e.onerror=s,e.currentTime=Math.min(e.duration,1)})}function _(e){return P(this,void 0,void 0,(function*(){const t=yield function(e){return new Promise((t,s)=>{const i=document.createElement("video");i.volume=0,i.addEventListener("loadedmetadata",()=>t(i),{once:!0}),i.addEventListener("error",s,{once:!0}),i.src=e})}(e);return Promise.race([Object(M.a)(2e3),E(t)])}))}function k(e,t=e.HAVE_METADATA,s){return new Promise(i=>{e.readyState>=t?i():e.addEventListener(C.IS_APPLE_MOBILE&&!s?"loadeddata":"canplay",()=>i(),{once:!0})})}function T(e,t=!1){return P(this,void 0,void 0,(function*(){const s=[],i=(e,n)=>P(this,void 0,void 0,(function*(){if(e.isDirectory){const t=e.createReader();yield new Promise((e,s)=>{t.readEntries(t=>P(this,void 0,void 0,(function*(){for(const e of t)yield i(e,n);e()})))})}else if(e)if(t)s.push(e.type);else{const t=n.getAsFile(),i=e instanceof File?e:e instanceof DataTransferItem?e.getAsFile():yield new Promise((s,i)=>e.file(s,e=>s(t)));if(!i)return;s.push(i)}}));if(e instanceof DragEvent&&e.dataTransfer.files&&!e.dataTransfer.items)for(let i=0;i<e.dataTransfer.files.length;i++){const n=e.dataTransfer.files[i];s.push(t?n.type:n)}else{const s=(e.dataTransfer||e.clipboardData||e.originalEvent.clipboardData).items,n=[];for(let e=0;e<s.length;++e){const a=s[e];if("file"===a.kind){const e=(t?a:a.webkitGetAsEntry())||a.getAsFile();n.push(i(e,a))}}yield Promise.all(n)}return s}))}var x=s(49),A=s(156),O=s(115),F=s(140),D=s(1),j=s(11);const R=new class{constructor(){this.contexts=new Map,this.links={},this.log=Object(i.b)("RD",void 0,!0),F.a.addTaskListener("refreshReference",e=>{const t=e.payload;e.originalPayload=t,this.refreshReference(t).then(t=>{e.payload=t},t=>{e.error=t}).then(()=>F.a.postMessage(e))})}saveContext(e,t,s){[s,e]=this.getContexts(e),s||(s=new Set,this.contexts.set(e,s)),this.links[Object(D.f)(e)]=e;for(const e of s)if(Object(m.b)(e,t))return;s.add(t)}getReferenceByLink(e){return this.links[Object(D.f)(e)]}getContexts(e){return[this.contexts.get(e)||(e=this.getReferenceByLink(e)||e,this.contexts.get(e)),e]}getContext(e){const t=this.getContexts(e);return t[0]?[t[0].values().next().value,t[1]]:void 0}deleteContext(e,t,s){if([s,e]=this.getContexts(e),s)for(const i of s)if(Object(m.b)(i,t))return s.delete(i),s.size||(this.contexts.delete(e),delete this.links[Object(D.f)(e)]),!0;return!1}refreshReference(e,t){if(this.log("refreshReference: start",e.slice(),t),!t){const s=this.getContext(e);if(!s)return this.log("refreshReference: got no context for reference:",e.slice()),Promise.reject("NO_CONTEXT");[t,e]=s}let s;switch(null==t?void 0:t.type){case"message":s=js.wrapSingleMessage(t.peerId,t.messageId,!0);break;default:return this.log.warn("refreshReference: not implemented context",t),Promise.reject()}const i=Object(D.f)(e);return this.log("refreshReference: refreshing reference:",i),s.then(()=>{const s=Object(D.f)(e);if(this.log("refreshReference: refreshed, reference before:",i,"after:",s),i!==s)return e;this.deleteContext(e,t);const n=this.getContext(e);if(n)return this.refreshReference(e,n[0]);throw this.log.error("refreshReference: no new context, reference before:",i,"after:",s,t),"NO_NEW_CONTEXT"})}};j.a.referenceDatabase=R;var B=R,U=s(163),N=s(139),H=s(73);var z={"Ã":"A","Ä‚":"A","áº®":"A","áº¶":"A","áº°":"A","áº²":"A","áº´":"A","Ç":"A","Ã‚":"A","áº¤":"A","áº¬":"A","áº¦":"A","áº¨":"A","áºª":"A","Ã„":"A","Çž":"A","È¦":"A","Ç ":"A","áº ":"A","È€":"A","Ã€":"A","áº¢":"A","È‚":"A","Ä€":"A","Ä„":"A","Ã…":"A","Çº":"A","á¸€":"A","Èº":"A","Ãƒ":"A","êœ²":"AA","Ã†":"AE","Ç¼":"AE","Ç¢":"AE","êœ´":"AO","êœ¶":"AU","êœ¸":"AV","êœº":"AV","êœ¼":"AY","á¸‚":"B","á¸„":"B","Æ":"B","á¸†":"B","Éƒ":"B","Æ‚":"B","Ä†":"C","ÄŒ":"C","Ã‡":"C","á¸ˆ":"C","Äˆ":"C","ÄŠ":"C","Æ‡":"C","È»":"C","ÄŽ":"D","á¸":"D","á¸’":"D","á¸Š":"D","á¸Œ":"D","ÆŠ":"D","á¸Ž":"D","Ç²":"D","Ç…":"D","Ä":"D","Æ‹":"D","Ç±":"DZ","Ç„":"DZ","Ã‰":"E","Ä”":"E","Äš":"E","È¨":"E","á¸œ":"E","ÃŠ":"E","áº¾":"E","á»†":"E","á»€":"E","á»‚":"E","á»„":"E","á¸˜":"E","Ã‹":"E","Ä–":"E","áº¸":"E","È„":"E","Ãˆ":"E","áºº":"E","È†":"E","Ä’":"E","á¸–":"E","á¸”":"E","Ä˜":"E","É†":"E","áº¼":"E","á¸š":"E","êª":"ET","á¸ž":"F","Æ‘":"F","Ç´":"G","Äž":"G","Ç¦":"G","Ä¢":"G","Äœ":"G","Ä ":"G","Æ“":"G","á¸ ":"G","Ç¤":"G","á¸ª":"H","Èž":"H","á¸¨":"H","Ä¤":"H","â±§":"H","á¸¦":"H","á¸¢":"H","á¸¤":"H","Ä¦":"H","Ã":"I","Ä¬":"I","Ç":"I","ÃŽ":"I","Ã":"I","á¸®":"I","Ä°":"I","á»Š":"I","Èˆ":"I","ÃŒ":"I","á»ˆ":"I","ÈŠ":"I","Äª":"I","Ä®":"I","Æ—":"I","Ä¨":"I","á¸¬":"I","ê¹":"D","ê»":"F","ê½":"G","êž‚":"R","êž„":"S","êž†":"T","ê¬":"IS","Ä´":"J","Éˆ":"J","á¸°":"K","Ç¨":"K","Ä¶":"K","â±©":"K","ê‚":"K","á¸²":"K","Æ˜":"K","á¸´":"K","ê€":"K","ê„":"K","Ä¹":"L","È½":"L","Ä½":"L","Ä»":"L","á¸¼":"L","á¸¶":"L","á¸¸":"L","â± ":"L","êˆ":"L","á¸º":"L","Ä¿":"L","â±¢":"L","Çˆ":"L","Å":"L","Ç‡":"LJ","á¸¾":"M","á¹€":"M","á¹‚":"M","â±®":"M","Åƒ":"N","Å‡":"N","Å…":"N","á¹Š":"N","á¹„":"N","á¹†":"N","Ç¸":"N","Æ":"N","á¹ˆ":"N","È ":"N","Ç‹":"N","Ã‘":"N","ÇŠ":"NJ","Ã“":"O","ÅŽ":"O","Ç‘":"O","Ã”":"O","á»":"O","á»˜":"O","á»’":"O","á»”":"O","á»–":"O","Ã–":"O","Èª":"O","È®":"O","È°":"O","á»Œ":"O","Å":"O","ÈŒ":"O","Ã’":"O","á»Ž":"O","Æ ":"O","á»š":"O","á»¢":"O","á»œ":"O","á»ž":"O","á» ":"O","ÈŽ":"O","êŠ":"O","êŒ":"O","ÅŒ":"O","á¹’":"O","á¹":"O","ÆŸ":"O","Çª":"O","Ç¬":"O","Ã˜":"O","Ç¾":"O","Ã•":"O","á¹Œ":"O","á¹Ž":"O","È¬":"O","Æ¢":"OI","êŽ":"OO","Æ":"E","Æ†":"O","È¢":"OU","á¹”":"P","á¹–":"P","ê’":"P","Æ¤":"P","ê”":"P","â±£":"P","ê":"P","ê˜":"Q","ê–":"Q","Å”":"R","Å˜":"R","Å–":"R","á¹˜":"R","á¹š":"R","á¹œ":"R","È":"R","È’":"R","á¹ž":"R","ÉŒ":"R","â±¤":"R","êœ¾":"C","ÆŽ":"E","Åš":"S","á¹¤":"S","Å ":"S","á¹¦":"S","Åž":"S","Åœ":"S","È˜":"S","á¹ ":"S","á¹¢":"S","á¹¨":"S","áºž":"SS","Å¤":"T","Å¢":"T","á¹°":"T","Èš":"T","È¾":"T","á¹ª":"T","á¹¬":"T","Æ¬":"T","á¹®":"T","Æ®":"T","Å¦":"T","â±¯":"A","êž€":"L","Æœ":"M","É…":"V","êœ¨":"TZ","Ãš":"U","Å¬":"U","Ç“":"U","Ã›":"U","á¹¶":"U","Ãœ":"U","Ç—":"U","Ç™":"U","Ç›":"U","Ç•":"U","á¹²":"U","á»¤":"U","Å°":"U","È”":"U","Ã™":"U","á»¦":"U","Æ¯":"U","á»¨":"U","á»°":"U","á»ª":"U","á»¬":"U","á»®":"U","È–":"U","Åª":"U","á¹º":"U","Å²":"U","Å®":"U","Å¨":"U","á¹¸":"U","á¹´":"U","êž":"V","á¹¾":"V","Æ²":"V","á¹¼":"V","ê ":"VY","áº‚":"W","Å´":"W","áº„":"W","áº†":"W","áºˆ":"W","áº€":"W","â±²":"W","áºŒ":"X","áºŠ":"X","Ã":"Y","Å¶":"Y","Å¸":"Y","áºŽ":"Y","á»´":"Y","á»²":"Y","Æ³":"Y","á»¶":"Y","á»¾":"Y","È²":"Y","ÉŽ":"Y","á»¸":"Y","Å¹":"Z","Å½":"Z","áº":"Z","â±«":"Z","Å»":"Z","áº’":"Z","È¤":"Z","áº”":"Z","Æµ":"Z","Ä²":"IJ","Å’":"OE","á´€":"A","á´":"AE","Ê™":"B","á´ƒ":"B","á´„":"C","á´…":"D","á´‡":"E","êœ°":"F","É¢":"G","Ê›":"G","Êœ":"H","Éª":"I","Ê":"R","á´Š":"J","á´‹":"K","ÊŸ":"L","á´Œ":"L","á´":"M","É´":"N","á´":"O","É¶":"OE","á´":"O","á´•":"OU","á´˜":"P","Ê€":"R","á´Ž":"N","á´™":"R","êœ±":"S","á´›":"T","â±»":"E","á´š":"R","á´œ":"U","á´ ":"V","á´¡":"W","Ê":"Y","á´¢":"Z","Ã¡":"a","Äƒ":"a","áº¯":"a","áº·":"a","áº±":"a","áº³":"a","áºµ":"a","ÇŽ":"a","Ã¢":"a","áº¥":"a","áº­":"a","áº§":"a","áº©":"a","áº«":"a","Ã¤":"a","ÇŸ":"a","È§":"a","Ç¡":"a","áº¡":"a","È":"a","Ã ":"a","áº£":"a","Èƒ":"a","Ä":"a","Ä…":"a","á¶":"a","áºš":"a","Ã¥":"a","Ç»":"a","á¸":"a","â±¥":"a","Ã£":"a","êœ³":"aa","Ã¦":"ae","Ç½":"ae","Ç£":"ae","êœµ":"ao","êœ·":"au","êœ¹":"av","êœ»":"av","êœ½":"ay","á¸ƒ":"b","á¸…":"b","É“":"b","á¸‡":"b","áµ¬":"b","á¶€":"b","Æ€":"b","Æƒ":"b","Éµ":"o","Ä‡":"c","Ä":"c","Ã§":"c","á¸‰":"c","Ä‰":"c","É•":"c","Ä‹":"c","Æˆ":"c","È¼":"c","Ä":"d","á¸‘":"d","á¸“":"d","È¡":"d","á¸‹":"d","á¸":"d","É—":"d","á¶‘":"d","á¸":"d","áµ­":"d","á¶":"d","Ä‘":"d","É–":"d","ÆŒ":"d","Ä±":"i","È·":"j","ÉŸ":"j","Ê„":"j","Ç³":"dz","Ç†":"dz","Ã©":"e","Ä•":"e","Ä›":"e","È©":"e","á¸":"e","Ãª":"e","áº¿":"e","á»‡":"e","á»":"e","á»ƒ":"e","á»…":"e","á¸™":"e","Ã«":"e","Ä—":"e","áº¹":"e","È…":"e","Ã¨":"e","áº»":"e","È‡":"e","Ä“":"e","á¸—":"e","á¸•":"e","â±¸":"e","Ä™":"e","á¶’":"e","É‡":"e","áº½":"e","á¸›":"e","ê«":"et","á¸Ÿ":"f","Æ’":"f","áµ®":"f","á¶‚":"f","Çµ":"g","ÄŸ":"g","Ç§":"g","Ä£":"g","Ä":"g","Ä¡":"g","É ":"g","á¸¡":"g","á¶ƒ":"g","Ç¥":"g","á¸«":"h","ÈŸ":"h","á¸©":"h","Ä¥":"h","â±¨":"h","á¸§":"h","á¸£":"h","á¸¥":"h","É¦":"h","áº–":"h","Ä§":"h","Æ•":"hv","Ã­":"i","Ä­":"i","Ç":"i","Ã®":"i","Ã¯":"i","á¸¯":"i","á»‹":"i","È‰":"i","Ã¬":"i","á»‰":"i","È‹":"i","Ä«":"i","Ä¯":"i","á¶–":"i","É¨":"i","Ä©":"i","á¸­":"i","êº":"d","ê¼":"f","áµ¹":"g","êžƒ":"r","êž…":"s","êž‡":"t","ê­":"is","Ç°":"j","Äµ":"j","Ê":"j","É‰":"j","á¸±":"k","Ç©":"k","Ä·":"k","â±ª":"k","êƒ":"k","á¸³":"k","Æ™":"k","á¸µ":"k","á¶„":"k","ê":"k","ê…":"k","Äº":"l","Æš":"l","É¬":"l","Ä¾":"l","Ä¼":"l","á¸½":"l","È´":"l","á¸·":"l","á¸¹":"l","â±¡":"l","ê‰":"l","á¸»":"l","Å€":"l","É«":"l","á¶…":"l","É­":"l","Å‚":"l","Ç‰":"lj","Å¿":"s","áºœ":"s","áº›":"s","áº":"s","á¸¿":"m","á¹":"m","á¹ƒ":"m","É±":"m","áµ¯":"m","á¶†":"m","Å„":"n","Åˆ":"n","Å†":"n","á¹‹":"n","Èµ":"n","á¹…":"n","á¹‡":"n","Ç¹":"n","É²":"n","á¹‰":"n","Æž":"n","áµ°":"n","á¶‡":"n","É³":"n","Ã±":"n","ÇŒ":"nj","Ã³":"o","Å":"o","Ç’":"o","Ã´":"o","á»‘":"o","á»™":"o","á»“":"o","á»•":"o","á»—":"o","Ã¶":"o","È«":"o","È¯":"o","È±":"o","á»":"o","Å‘":"o","È":"o","Ã²":"o","á»":"o","Æ¡":"o","á»›":"o","á»£":"o","á»":"o","á»Ÿ":"o","á»¡":"o","È":"o","ê‹":"o","ê":"o","â±º":"o","Å":"o","á¹“":"o","á¹‘":"o","Ç«":"o","Ç­":"o","Ã¸":"o","Ç¿":"o","Ãµ":"o","á¹":"o","á¹":"o","È­":"o","Æ£":"oi","ê":"oo","É›":"e","á¶“":"e","É”":"o","á¶—":"o","È£":"ou","á¹•":"p","á¹—":"p","ê“":"p","Æ¥":"p","áµ±":"p","á¶ˆ":"p","ê•":"p","áµ½":"p","ê‘":"p","ê™":"q","Ê ":"q","É‹":"q","ê—":"q","Å•":"r","Å™":"r","Å—":"r","á¹™":"r","á¹›":"r","á¹":"r","È‘":"r","É¾":"r","áµ³":"r","È“":"r","á¹Ÿ":"r","É¼":"r","áµ²":"r","á¶‰":"r","É":"r","É½":"r","â†„":"c","êœ¿":"c","É˜":"e","É¿":"r","Å›":"s","á¹¥":"s","Å¡":"s","á¹§":"s","ÅŸ":"s","Å":"s","È™":"s","á¹¡":"s","á¹£":"s","á¹©":"s","Ê‚":"s","áµ´":"s","á¶Š":"s","È¿":"s","É¡":"g","ÃŸ":"ss","á´‘":"o","á´“":"o","á´":"u","Å¥":"t","Å£":"t","á¹±":"t","È›":"t","È¶":"t","áº—":"t","â±¦":"t","á¹«":"t","á¹­":"t","Æ­":"t","á¹¯":"t","áµµ":"t","Æ«":"t","Êˆ":"t","Å§":"t","áµº":"th","É":"a","á´‚":"ae","Ç":"e","áµ·":"g","É¥":"h","Ê®":"h","Ê¯":"h","á´‰":"i","Êž":"k","êž":"l","É¯":"m","É°":"m","á´”":"oe","É¹":"r","É»":"r","Éº":"r","â±¹":"r","Ê‡":"t","ÊŒ":"v","Ê":"w","ÊŽ":"y","êœ©":"tz","Ãº":"u","Å­":"u","Ç”":"u","Ã»":"u","á¹·":"u","Ã¼":"u","Ç˜":"u","Çš":"u","Çœ":"u","Ç–":"u","á¹³":"u","á»¥":"u","Å±":"u","È•":"u","Ã¹":"u","á»§":"u","Æ°":"u","á»©":"u","á»±":"u","á»«":"u","á»­":"u","á»¯":"u","È—":"u","Å«":"u","á¹»":"u","Å³":"u","á¶™":"u","Å¯":"u","Å©":"u","á¹¹":"u","á¹µ":"u","áµ«":"ue","ê¸":"um","â±´":"v","êŸ":"v","á¹¿":"v","Ê‹":"v","á¶Œ":"v","â±±":"v","á¹½":"v","ê¡":"vy","áºƒ":"w","Åµ":"w","áº…":"w","áº‡":"w","áº‰":"w","áº":"w","â±³":"w","áº˜":"w","áº":"x","áº‹":"x","á¶":"x","Ã½":"y","Å·":"y","Ã¿":"y","áº":"y","á»µ":"y","á»³":"y","Æ´":"y","á»·":"y","á»¿":"y","È³":"y","áº™":"y","É":"y","á»¹":"y","Åº":"z","Å¾":"z","áº‘":"z","Ê‘":"z","â±¬":"z","Å¼":"z","áº“":"z","È¥":"z","áº•":"z","áµ¶":"z","á¶Ž":"z","Ê":"z","Æ¶":"z","É€":"z","ï¬€":"ff","ï¬ƒ":"ffi","ï¬„":"ffl","ï¬":"fi","ï¬‚":"fl","Ä³":"ij","Å“":"oe","ï¬†":"st","â‚":"a","â‚‘":"e","áµ¢":"i","â±¼":"j","â‚’":"o","áµ£":"r","áµ¤":"u","áµ¥":"v","â‚“":"x","Ð":"YO","Ð™":"I","Ð¦":"TS","Ð£":"U","Ðš":"K","Ð•":"E","Ð":"N","Ð“":"G","Ð¨":"SH","Ð©":"SCH","Ð—":"Z","Ð¥":"H","Ðª":"","Ñ‘":"yo","Ð¹":"i","Ñ†":"ts","Ñƒ":"u","Ðº":"k","Ðµ":"e","Ð½":"n","Ð³":"g","Ñˆ":"sh","Ñ‰":"sch","Ð·":"z","Ñ…":"h","ÑŠ":"","Ð¤":"F","Ð«":"I","Ð’":"V","Ð":"A","ÐŸ":"P","Ð ":"R","Ðž":"O","Ð›":"L","Ð”":"D","Ð–":"ZH","Ð­":"E","Ñ„":"f","Ñ‹":"i","Ð²":"v","Ð°":"a","Ð¿":"p","Ñ€":"r","Ð¾":"o","Ð»":"l","Ð´":"d","Ð¶":"zh","Ñ":"e","Ð¯":"Ya","Ð§":"CH","Ð¡":"S","Ðœ":"M","Ð˜":"I","Ð¢":"T","Ð¬":"","Ð‘":"B","Ð®":"YU","Ñ":"ya","Ñ‡":"ch","Ñ":"s","Ð¼":"m","Ð¸":"i","Ñ‚":"t","ÑŒ":"","Ð±":"b","ÑŽ":"yu"};const W=/[`~!@#$%^&*()\-_=+\[\]\\|{}'";:\/?.>,<]+/g,q=/^\s+|\s$/g;function V(e){return e.replace(W,"").replace(q,"")}function G(e){return e.replace(/[^A-Za-z0-9]/g,e=>{const t=z[e];return void 0!==t?t:e})}function K(e,t=!0){const s="%"===e.charAt(0);return e=V(e),t&&(e=G(e)),e=e.toLowerCase(),s&&(e="%"+e),e}function Q(e,t={}){const s=t.includeTag&&"%"===e.charAt(0);return t.clearBadChars&&(e=V(e)),t.latinize&&(e=G(e)),t.ignoreCase&&(e=e.toLowerCase()),s&&(e="%"+e),e}class ${constructor(e,t=0){this.options=e,this.minChars=t,this.fullTexts=new Map}indexObject(e,t){if(this.options&&t.trim()&&(t=Q(t,this.options)),!t)return this.fullTexts.delete(e),!1;this.fullTexts.set(e,t)}search(e){const t=this.fullTexts;this.options&&(e=Q(e,this.options));const s=[],i=e.split(" "),n=i.length;t.forEach((e,t)=>{let a=!0,o=0;for(let t=0;t<n;++t){const s=i[t],n=e.indexOf(s);if(-1===n||0!==n&&" "!==e[n-1]){a=!1;break}o+=s.length}if(a){o+=n-1;const i=e.length;(this.minChars<=o||i<=o)&&s.push({fullText:e,fullTextLength:i,what:t,foundChars:o})}}),s.sort((e,t)=>e.fullTextLength-t.fullTextLength||t.foundChars-e.foundChars);return new Set(s.map(e=>e.what))}}var Y;!function(e){e[e.None=0]="None",e[e.Top=1]="Top",e[e.Bottom=2]="Bottom",e[e.Both=3]="Both"}(Y||(Y={}));class X{constructor(){this.sliceConstructor=X.getSliceConstructor(this);const e=this.constructSlice();this.slices=[e]}static getSliceConstructor(e){return class extends Array{constructor(){super(...arguments),this.end=Y.None}isEnd(t){if((this.end&t)===t)return!0;let s=!1;if(t===Y.Top){const i=e.last;s=!!(i.end&t)&&this.includes(i[i.length-1])}else if(t===Y.Bottom){const i=e.first;s=!!(i.end&t)&&this.includes(i[0])}else if(t===Y.Both)return this.isEnd(Y.Top)&&this.isEnd(Y.Bottom);return s&&this.setEnd(t),s}setEnd(e){this.end|=e}unsetEnd(e){this.end^=e}splice(t,s,...i){const n=super.splice(t,s,...i);if(!this.length){const t=e.slices,s=t.indexOf(this);-1!==s&&(1===t.length?this.unsetEnd(Y.Both):t.splice(s,1))}return n}}}constructSlice(...e){const t=new this.sliceConstructor(e.length);for(let s=0,i=e.length;s<i;++s)t[s]=e[s];return t}insertSlice(e,t=!0){if(!e.length)return;const s=this.slices[0];if(!s.length)return s.push(...e),s;const i=e[e.length-1],n=e[0];let a,o=-1,r=-1,l=0;for(;l<this.slices.length&&(a=this.slices[l],o=a.indexOf(i),r=a.indexOf(n),-1===r||-1===o)&&(-1===r&&-1===o);++l);if(-1!==r&&-1!==o);else if(-1!==r){const t=e.slice(a.length-r);a.push(...t)}else if(-1!==o){const t=e.slice(0,e.length-o-1);a.unshift(...t)}else{let t=0;for(const s=this.slices.length;t<s;++t){const s=this.slices[t];if(e[0]>s[0])break}this.slices.splice(t,0,this.constructSlice(...e)),l=t}return t?this.flatten(l):void 0}flatten(e){if(this.slices.length>=2)for(let t=0,s=this.slices.length;t<s-1;++t){const i=this.slices[t],n=this.slices[t+1];-1!==i.indexOf(n[0])&&(i.setEnd(n.end),this.slices.splice(t+1,1),t<e&&--e,--s,--t,this.insertSlice(n,!1))}return this.slices[e]}get first(){return this.slices[0]}get last(){return this.slices[this.slices.length-1]}get slice(){return this.first}get length(){return this.slice.length}findSlice(e){for(let t=0,s=this.slices.length;t<s;++t){const s=this.slices[t],i=s.indexOf(e);if(-1!==i)return{slice:s,index:i}}}findSliceOffset(e){let t;for(let s=0;s<this.slices.length;++s){let i=0;if(t=this.slices[s],!(t.length<2))for(;i<t.length;i++)if(e>=t[i])return{slice:t,offset:e===t[i]?i:i-1}}if(t&&t.isEnd(Y.Top))return{slice:t,offset:t.length}}sliceMe(e,t,s){let i=this.slice,n=0,a=0;if(e){const t=this.findSliceOffset(e);if(!t)return;i=t.slice,n=a=t.offset,i.includes(e)&&(a+=1)}let o=Math.max(a+t,0),r=a+t+s;const l=i.slice(o,r),d=t<0?s+t:s,c=Math.abs(t),h=i.length-a>=d||!!i.isEnd(Y.Top)&&(l.setEnd(Y.Top),!0),u=a-c>=0||!!i.isEnd(Y.Bottom)&&(l.setEnd(Y.Bottom),!0);return{slice:l,offsetIdOffset:n,fulfilled:Y.None|(h&&u?Y.Both:(h?Y.Top:Y.None)|(u?Y.Bottom:Y.None))}}unshift(...e){let t=this.first;t.length?t.isEnd(Y.Bottom)||(t=this.constructSlice(),t.setEnd(Y.Bottom),this.slices.unshift(t)):t.setEnd(Y.Bottom),t.unshift(...e)}push(...e){let t=this.last;t.length?t.isEnd(Y.Top)||(t=this.constructSlice(),t.setEnd(Y.Top),this.slices.push(t)):t.setEnd(Y.Top),t.push(...e)}delete(e){const t=this.findSlice(e);return!!t&&(t.slice.splice(t.index,1),!0)}}j.a&&(j.a.SlicedArray=X);var Z=s(84),J=s(51),ee=s(17);class te{constructor(e,t,s,i,n,a,o,r,l,d){this.appMessagesManager=e,this.appChatsManager=t,this.appPeersManager=s,this.appUsersManager=i,this.appDraftsManager=n,this.appNotificationsManager=a,this.appStateManager=o,this.apiUpdatesManager=r,this.serverTimeManager=l,this.appMessagesIdsManager=d,this.folders={},this.archivedDialogs=[],this.toggleArchivedDialog=e=>{const t=this.archivedDialogs.findIndex(t=>t===e);-1!==t?this.archivedDialogs.splice(t,1):this.archivedDialogs.push(e),ee.a.set({archivedIds:this.archivedDialogs})},this.onUpdateFolderPeers=e=>{e.folder_peers.forEach(e=>{var t;const{folder_id:s,peer:i}=e,n=this.appPeersManager.getPeerId(i),a=this.dropDialog(n)[0];a&&((null===(t=a.pFlags)||void 0===t?void 0:t.pinned)&&this.handleDialogUnpinning(a,s),a.folder_id=s,this.generateIndexForDialog(a),this.pushDialog(a)),this.appMessagesManager.scheduleHandleNewDialogs(n,a)})},this.onUpdateDialogPinned=e=>{var t;const s=null!==(t=e.folder_id)&&void 0!==t?t:0,i=this.appPeersManager.getPeerId(e.peer.peer),n=this.getDialogOnly(i);n&&(e.pFlags.pinned?n.pFlags.pinned=!0:this.handleDialogUnpinning(n,s),this.generateIndexForDialog(n,void 0,void 0,s)),this.appMessagesManager.scheduleHandleNewDialogs(i,n)},this.onUpdatePinnedDialogs=e=>{var t;const s=null!==(t=e.folder_id)&&void 0!==t?t:0,i=e=>{this.pinnedOrders[s].length=0,e.reverse(),e.forEach(e=>{n[e]=!0;const t=this.getDialogOnly(e);this.appMessagesManager.scheduleHandleNewDialogs(e,t),t&&(t.pFlags.pinned=!0,this.generateIndexForDialog(t))});const t=this.getFolderDialogs(s,!1);for(const e of t){if(!e.pFlags.pinned)break;const t=e.peerId;n[t]||this.appMessagesManager.scheduleHandleNewDialogs(t)}},n={};e.order?i(e.order.map(e=>this.appPeersManager.getPeerId(e.peer))):F.a.invokeApi("messages.getPinnedDialogs",{folder_id:s}).then(e=>{this.applyDialogs(e),i(e.dialogs.map(e=>e.peerId))})},this.storage=this.appStateManager.storages.dialogs,this.dialogs=this.storage.getCache(),this.clear(!0),ee.a.get("archivedIds").then(e=>{this.archivedDialogs=[...e]}),H.default.addEventListener("language_change",()=>{const e=i.getSelf().id.toPeerId(!1);if(this.getDialogOnly(e)){const t=s.getPeerSearchText(e);this.dialogsIndex.indexObject(e,t)}});const c=e=>{const t=this.getCachedDialogs(!1);for(let s=0;s<t.length;++s)this.processDialogForFilter(t[s],e)};H.default.addEventListener("filter_order",()=>{const e=this.getCachedDialogs(!1);for(const e in this.folders)+e>1&&delete this.folders[e];for(let t=0;t<e.length;++t){const s=e[t];for(let e=0;e<=10;++e){s["index_"+e]=void 0}this.processDialogForFilters(s)}}),H.default.addEventListener("filter_update",c),H.default.addEventListener("filter_new",c),H.default.addEventListener("filter_delete",e=>{const t=this.getCachedDialogs(!1),s="index_"+e.orderIndex;for(let e=0;e<t.length;++e){delete t[e][s]}delete this.folders[e.id]}),H.default.addEventListener("chat_update",e=>{const t=this.appChatsManager.getChat(e),s=e.toPeerId(!0);t.pFlags.left&&this.getDialogOnly(s)&&this.dropDialogOnDeletion(s)}),H.default.addMultipleEventsListeners({updateFolderPeers:this.onUpdateFolderPeers,updateDialogPinned:this.onUpdateDialogPinned,updatePinnedDialogs:this.onUpdatePinnedDialogs}),o.getState().then(e=>{this.pinnedOrders=e.pinnedOrders||{},this.pinnedOrders[0]||(this.pinnedOrders[0]=[]),this.pinnedOrders[1]||(this.pinnedOrders[1]=[]);const t=o.storagesResults.dialogs;if(t.length)for(let e=0,s=t.length;e<s;++e){const s=t[e];if(s){s.top_message=this.appMessagesIdsManager.getServerMessageId(s.top_message),s.topMessage&&this.appMessagesManager.saveMessages([s.topMessage]);for(let e=0;e<=10;++e)delete s["index_"+e];this.saveDialog(s,void 0,!0);this.appMessagesManager.getMessageByPeer(s.peerId,s.top_message).deleted&&this.appMessagesManager.reloadConversation(s.peerId)}}this.allDialogsLoaded=e.allDialogsLoaded||{}})}isDialogsLoaded(e){return!!this.allDialogsLoaded[e]}setDialogsLoaded(e,t){void 0===e&&t?(this.allDialogsLoaded[0]=t,this.allDialogsLoaded[1]=t):this.allDialogsLoaded[e]=t,this.allDialogsLoaded[0]&&this.allDialogsLoaded[1]&&(this.allDialogsLoaded[void 0]=!0,this.appMessagesManager.filtersStorage.updateLocalPinnedDialogs(),this.archivedDialogs.forEach(e=>{var t;if(null===(t=this.folders[1])||void 0===t?void 0:t.dialogs.find(t=>t.peerId===e))return;let s=this.appMessagesManager.getDialogOnly(e);s&&this.appMessagesManager.editPeerFolders([s.peerId],1)})),this.appStateManager.pushToState("allDialogsLoaded",this.allDialogsLoaded)}clear(e=!1){if(this.pinnedOrders={0:[],1:[]},e)this.allDialogsLoaded={};else{this.appStateManager.storagesResults.dialogs.length=0,this.storage.clear(),this.setDialogsLoaded(0,!1),this.setDialogsLoaded(1,!1),this.setDialogsLoaded(void 0,!1),this.savePinnedOrders()}this.folders={},this.dialogsOffsetDate={},this.dialogsNum=0,this.dialogsIndex=new $({clearBadChars:!0,ignoreCase:!0,latinize:!0,includeTag:!0}),this.cachedResults={query:"",count:0,dialogs:[],folderId:0}}handleDialogUnpinning(e,t){delete e.pFlags.pinned,Object(a.f)(this.pinnedOrders[t],e.peerId),this.savePinnedOrders()}savePinnedOrders(){this.appStateManager.pushToState("pinnedOrders",this.pinnedOrders)}resetPinnedOrder(e){this.pinnedOrders[e]=[]}getPinnedOrders(e){return this.pinnedOrders[e]}getOffsetDate(e){const t=this.dialogsOffsetDate[e]||0;return void 0!==e||t?t:Math.min(this.getOffsetDate(0),this.getOffsetDate(1))}getFolder(e){var t;return null!==(t=this.folders[e])&&void 0!==t?t:this.folders[e]={dialogs:[],id:e,unreadMessagesCount:0,unreadDialogsCount:0}}getFolderDialogs(e,t=!0){if(void 0===e)return this.getCachedDialogs(t);const s=this.getFolder(e);return t?s.dialogs.filter(e=>void 0===e.migratedTo):s.dialogs}getCachedDialogs(e){return this.getFolderDialogs(0,e).concat(this.getFolderDialogs(1,e))}setDialogIndexInFilter(e,t,s){var i;let n;if(this.appMessagesManager.filtersStorage.testDialogForFilter(e,s)){const t=s.pinnedPeerIds.indexOf(e.peerId);n=-1!==t?this.generateDialogIndex(this.generateDialogPinnedDateByIndex(s.pinned_peers.length-1-t,s.id),!0):(null===(i=e.pFlags)||void 0===i?void 0:i.pinned)?this.generateIndexForDialog(e,!0,void 0,s.id):e.index}return e[t]=n}getDialog(e,t,s=!0){const i=[];void 0===t?i.push(this.getFolder(0).dialogs,this.getFolder(1).dialogs):i.push(this.getFolderDialogs(t,!1));for(let t of i){let i=0,n=0;for(let a=t.length;i<a;++i){const a=t[i];if(a.peerId===e)return[a,i-n];s&&void 0!==a.migratedTo&&++n}}return[]}getDialogOnly(e){return this.dialogs[e]}generateDialogIndex(e,t){return void 0===e&&(e=Object(S.f)(!0)+this.serverTimeManager.serverTimeOffset),65536*e+(t?0:65535&++this.dialogsNum)}processDialogForFilters(e){const t=this.appMessagesManager.filtersStorage.filters;for(const s in t){const i=t[s];this.processDialogForFilter(e,i)}}processDialogForFilter(e,t){const s=this.getDialogIndexKey(t.id),i=this.getFolder(t.id).dialogs,n=i.findIndex(t=>t.peerId===e.peerId),o=i[n],r=o&&o[s],l=this.setDialogIndexInFilter(e,s,t);r!==l&&((!r&&l||n&&!l)&&this.prepareFolderUnreadCountModifyingByDialog(t.id,e,!!l),-1!==n&&i.splice(n,1),l&&Object(a.g)(i,e,s,n))}prepareDialogUnreadCountModifying(e){const t=[this.prepareFolderUnreadCountModifyingByDialog(e.folder_id,e)],s=this.appMessagesManager.filtersStorage.filters;for(const i in s){const n=s[i];this.appMessagesManager.filtersStorage.testDialogForFilter(e,n)&&t.push(this.prepareFolderUnreadCountModifyingByDialog(n.id,e))}return()=>t.forEach(e=>e())}prepareFolderUnreadCountModifyingByDialog(e,t,s){const i=this.appMessagesManager.getDialogUnreadCount(t);if(void 0===s)return()=>{const s=this.appMessagesManager.getDialogUnreadCount(t),n=s-i,a=s&&!i||!s&&i?i?-1:1:0;this.modifyFolderUnreadCount(e,n,a)};this.modifyFolderUnreadCount(e,s?i:-i,i?s?1:-1:0)}modifyFolderUnreadCount(e,t,s){if(!t&&!s)return;const i=this.getFolder(e);t&&(i.unreadMessagesCount=Math.max(0,i.unreadMessagesCount+t)),s&&(i.unreadDialogsCount=Math.max(0,i.unreadDialogsCount+s)),void 0===i.dispatchUnreadTimeout&&(i.dispatchUnreadTimeout=J.a.setTimeout(()=>{i.dispatchUnreadTimeout=void 0,H.default.dispatchEvent("folder_unread",i)},0))}generateIndexForDialog(e,t=!1,s,i){var n;let a,o=0;if(e.pFlags.pinned&&!t)o=this.generateDialogPinnedDate(e,i),a=!0;else{s||(s=this.appMessagesManager.getMessageByPeer(e.peerId,e.top_message)),o=s.date||o;const t=this.appPeersManager.isChannel(e.peerId)&&e.peerId.toChatId();if(t){const e=this.appChatsManager.getChat(t);(!o||e.date&&e.date>o)&&(o=e.date)}"draftMessage"===(null===(n=e.draft)||void 0===n?void 0:n._)&&e.draft.date>o&&(o=e.draft.date)}o||(o=Object(S.f)(!0));const r=this.generateDialogIndex(o,a);if(t)return r;e.index=r}generateDialogPinnedDateByIndex(e,t=0){return t?2147418112+(65535&e):65535-(65535&e)+2147418112}generateDialogPinnedDate(e,t){const s=this.pinnedOrders[e.folder_id],i=s.indexOf(e.peerId);let n=i;return-1===i&&(n=s.push(e.peerId)-1,this.savePinnedOrders()),this.generateDialogPinnedDateByIndex(n,t)}setDialogToState(e){const{peerId:t,pts:s}=e,i=this.appMessagesManager.getHistoryStorage(t),n=this.appMessagesManager.getMessagesStorage(t),a=i.history.slice;let o;for(let e=0,s=a.length;e<s;++e){const s=a[e],i=this.appMessagesManager.getMessageFromStorage(n,s);if(!i.pFlags.is_outgoing&&!i.deleted){o=i;const e=i.viaBotId||i.fromId;e!==t&&this.appStateManager.requestPeerSingle(e,"topMessage",t);break}}if(e.topMessage=o,t.isAnyChat()&&s){const i=this.apiUpdatesManager.getChannelState(t.toChatId(),s).pts;e.pts=i}this.storage.set({[t]:e}),this.appStateManager.requestPeerSingle(t,"dialog")}pushDialog(e,t,s,i){const{folder_id:n,peerId:o}=e,r=this.getFolderDialogs(n,!1),l=r.findIndex(e=>e.peerId===o);if(-1!==l&&r.splice(l,1),this.dialogs[o]=e,this.setDialogToState(e),void 0===t&&(t=this.getDialogOffsetDate(e)),this.processDialogForFilters(e),t&&!e.pFlags.pinned){if(i){const e=this.dialogsOffsetDate[void 0];(!e||t<e)&&(this.dialogsOffsetDate[void 0]=t)}const a=this.dialogsOffsetDate[n];if(!a||t<a){if(!s&&!this.isDialogsLoaded(n))return void this.clearDialogFromState(e,!0);this.dialogsOffsetDate[n]=t}}-1===l&&this.prepareFolderUnreadCountModifyingByDialog(n,e,!0),Object(a.g)(r,e,"index",l)}dropDialog(e){const t=this.getDialog(e,void 0,!1),[s,i]=t;if(s){delete this.dialogs[e];this.getFolder(s.folder_id).dialogs.splice(i,1);const t=void 0!==Object(a.f)(this.pinnedOrders[s.folder_id],e);this.processDialogForFilters(s),this.dialogsIndex.indexObject(e,""),t&&this.savePinnedOrders(),this.clearDialogFromState(s,!1)}return t}clearDialogFromState(e,t){const s=e.peerId;this.appStateManager.releaseSinglePeer(s,"topMessage"),this.appStateManager.releaseSinglePeer(s,"dialog"),this.storage.delete(s,t)}dropDialogWithEvent(e){const t=this.dropDialog(e);return t.length&&H.default.dispatchEvent("dialog_drop",{peerId:e,dialog:t[0]}),t}dropDialogOnDeletion(e){this.dropDialogWithEvent(e),H.default.dispatchEvent("peer_deleted",e)}applyDialogs(e){Object(a.e)(e.dialogs,(t,s)=>{"dialogFolder"===t._&&e.dialogs.splice(s,1)}),this.appUsersManager.saveApiUsers(e.users),this.appChatsManager.saveApiChats(e.chats),this.appMessagesManager.saveMessages(e.messages);const t={};e.dialogs.forEach(e=>{const s=this.appPeersManager.getPeerId(e.peer);let i=e.top_message;const n=this.appMessagesManager.pendingTopMsgs[s];n&&(!i||this.appMessagesManager.getMessageByPeer(s,n).date>this.appMessagesManager.getMessageByPeer(s,i).date)&&(e.top_message=i=n,this.appMessagesManager.getHistoryStorage(s).maxId=n),i||e.draft&&"draftMessage"===e.draft._?(this.saveDialog(e),t[s]=e):this.dropDialogWithEvent(s);const a=this.appMessagesManager.newUpdatesAfterReloadToHandle[s];if(void 0!==a){for(const e of a)this.apiUpdatesManager.saveUpdate(e);delete this.appMessagesManager.newUpdatesAfterReloadToHandle[s]}}),Object.keys(t).length&&H.default.dispatchEvent("dialogs_multiupdate",t)}getDialogOffsetDate(e){return this.appMessagesManager.getMessageByPeer(e.peerId,e.top_message).date||0}saveDialog(e,t,s,i){var n,a;void 0===t&&(t=null!==(n=e.folder_id)&&void 0!==n?n:0);const o=this.appPeersManager.getPeerId(e.peer);if(!o)return void console.error("saveConversation no peerId???",e,t);"dialog"!==e._&&console.error("saveConversation not regular dialog",e,Object.assign({},e));const r=this.appPeersManager.isChannel(o)?o.toChatId():Z.b;if(o.isAnyChat()){const e=this.appChatsManager.getChat(o.toChatId());if("channelForbidden"===e._||e.pFlags.left||e.pFlags.kicked)return}const l=this.appPeersManager.getPeerSearchText(o);this.dialogsIndex.indexObject(o,l);const d=this.getDialogOnly(o);let c,h;if(e.top_message){c=this.appMessagesIdsManager.generateMessageId(e.top_message);const t=(null==d?void 0:d.top_message)&&this.appMessagesManager.getMessageByPeer(o,d.top_message);(null===(a=null==t?void 0:t.pFlags)||void 0===a?void 0:a.is_outgoing)&&d.top_message>=c&&(c=d.top_message),h=this.appMessagesManager.getMessageByPeer(o,c)}else c=this.appMessagesManager.generateTempMessageId(o),h={_:"message",id:c,mid:c,from_id:this.appPeersManager.getOutputPeer(this.appUsersManager.getSelf().id.toPeerId(!1)),peer_id:this.appPeersManager.getOutputPeer(o),deleted:!0,pFlags:{out:!0},date:0,message:""},this.appMessagesManager.saveMessages([h],{isOutgoing:!0});if((null==h?void 0:h.pFlags)||this.appMessagesManager.log.error("saveConversation no message:",e,h),!r&&o.isAnyChat()){const t=this.appChatsManager.getChat(o.toChatId());if(t&&t.migrated_to&&t.pFlags.deactivated){const s=this.appPeersManager.getPeerId(t.migrated_to);this.appMessagesManager.migratedFromTo[o]=s,this.appMessagesManager.migratedToFrom[s]=o,e.migratedTo=s}}if(e.top_message=c,e.read_inbox_max_id=this.appMessagesIdsManager.generateMessageId(d&&!e.read_inbox_max_id?d.read_inbox_max_id:e.read_inbox_max_id),e.read_outbox_max_id=this.appMessagesIdsManager.generateMessageId(d&&!e.read_outbox_max_id?d.read_outbox_max_id:e.read_outbox_max_id),void 0===e.folder_id&&"dialog"===e._&&(e.folder_id=d?d.folder_id:t),e.draft=this.appDraftsManager.saveDraft(o,0,e.draft),e.peerId=o,h.pFlags.is_outgoing){const t=h.pFlags.out;c>e[t?"read_outbox_max_id":"read_inbox_max_id"]?(h.pFlags.unread=!0,e.unread_count||t||++e.unread_count):delete h.pFlags.unread}const u=this.appMessagesManager.getHistoryStorage(o),p=u.history.slice;if(p.length){if(!p.isEnd(Y.Bottom)){u.history.insertSlice([c]).setEnd(Y.Bottom),this.appMessagesManager.mergeReplyKeyboard(u,h)&&H.default.dispatchEvent("history_reply_markup",{peerId:o})}}else u.history.unshift(c),this.appMessagesManager.mergeReplyKeyboard(u,h)&&H.default.dispatchEvent("history_reply_markup",{peerId:o});u.maxId=c,u.readMaxId=e.read_inbox_max_id,u.readOutboxMaxId=e.read_outbox_max_id,this.appNotificationsManager.savePeerSettings({peerId:o,settings:e.notify_settings}),r&&e.pts&&this.apiUpdatesManager.addChannelState(r,e.pts),this.generateIndexForDialog(e),Object(m.c)(e,["index_0","index_1","index_2","index_3","index_4","index_5","index_6","index_7","index_8","index_9","index_10"]),d&&Object(m.i)(d,e),this.pushDialog(e,h.date,s,i)}getDialogIndexKey(e){return e>1?"index_"+this.appMessagesManager.filtersStorage.getFilter(e).orderIndex:"index"}getDialogs(e="",t,s=20,i=0,n=!1){const a={};if(i>1){const o=[],r=this.appUsersManager.fillContacts();r.cached||o.push(r.promise);const l=this.appMessagesManager.filtersStorage.reloadMissingPeerIds(i);if(l&&o.push(l),o.length)return a.cached=!1,a.promise=Promise.all(o).then(()=>this.getDialogs(e,t,s,i,n).promise),a}const o=i>1||this.getOffsetDate(i)?void 0:i;let r=this.getFolderDialogs(i,n);const l=this.getDialogIndexKey(i);if(e){if(!s||this.cachedResults.query!==e||this.cachedResults.folderId!==i){this.cachedResults.query=e,this.cachedResults.folderId=i;const t=this.dialogsIndex.search(e),s=[];for(const e in this.dialogs){const n=this.dialogs[e];t.has(n.peerId)&&n.folder_id===i&&s.push(n)}s.sort((e,t)=>t[l]-e[l]),this.cachedResults.dialogs=s,this.cachedResults.count=s.length}r=this.cachedResults.dialogs}else this.cachedResults.query="";let d=0;if(t>0)for(let e=r.length;d<e&&!(t>r[d][l]);++d);const c=this.isDialogsLoaded(o),h=r.length>=d+s;if(e||c||h){const i=r.slice(d,d+s);return a.cached=!0,a.promise=Promise.resolve({dialogs:i,count:c?r.length:null,isTopEnd:r.length&&(i[0]&&i[0]===r[0]||r[0][l]<t),isEnd:(e||c)&&d+s>=r.length}),a}return a.cached=!1,a.promise=this.appMessagesManager.getTopMessages(s,o).then(e=>{if(n&&(r=this.getFolderDialogs(i,n)),d=0,t>0)for(let e=r.length;d<e&&!(t>r[d][l]);++d);const a=r.slice(d,d+s);return{dialogs:a,count:void 0===e.count?r.length:e.count,isTopEnd:r.length&&(a[0]&&a[0]===r[0]||r[0][l]<t),isEnd:e.isEnd}}),a}}const se=e=>btoa(JSON.stringify(e)),ie=e=>JSON.parse(atob(e));var ne=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};const ae=[["pinned_peers","pinnedPeerIds"],["exclude_peers","excludePeerIds"],["include_peers","includePeerIds"]];class oe{constructor(e,t,s,i,n,a,o){this.appMessagesManager=e,this.appPeersManager=t,this.appUsersManager=s,this.appNotificationsManager=i,this.appStateManager=n,this.apiUpdatesManager=a,this.rootScope=o,this.localPinnedDialogs={0:new Set([]),1:new Set([])},this.updateLocalPinnedDialogs=()=>{for(const e in this.localPinnedDialogs){const t=this.localPinnedDialogs[e];t.size&&t.forEach(t=>ne(this,void 0,void 0,(function*(){const s=this.appMessagesManager.dialogsStorage.getDialogOnly(t);this.appMessagesManager.isDialogPinned(+e,s)||this.appMessagesManager.toggleDialogPin(t,+e)})))}},this.onUpdateDialogFilter=e=>{e.filter?this.saveDialogFilter(e.filter):this.filters[e.id]&&(delete this.localPinnedDialogs[e.id],this.rootScope.dispatchEvent("filter_delete",this.filters[e.id]),delete this.filters[e.id]),this.appStateManager.pushToState("filters",this.filters)},this.onUpdateDialogFilterOrder=e=>{this.orderIndex=1,e.order.forEach((e,t)=>{const s=this.filters[e];delete s.orderIndex,this.setOrderIndex(s)}),this.rootScope.dispatchEvent("filter_order",e.order),this.appStateManager.pushToState("filters",this.filters)},this.getLocalPinnedDialogs=()=>this.localPinnedDialogs,this.addLocalPinnedDialog=(e,t)=>{this.localPinnedDialogs[e]||(this.localPinnedDialogs[e]=new Set([])),this.localPinnedDialogs[e].add(t),this.setLocalPinnedStorage(this.localPinnedDialogs)},this.removeLocalPinnedDialog=(e,t)=>{this.localPinnedDialogs[e].delete(t),this.setLocalPinnedStorage(this.localPinnedDialogs)},this.setLocalPinnedStorage=e=>{const t={};for(const s in e){const i=e[s];t[s]=Array.from(i)}ee.a.set({localPinned:se(t)})},this.afterUpdateFilter=(e,t,s)=>{if(this.onUpdateDialogFilter({_:"updateDialogFilter",id:e.id,filter:t?void 0:e}),s){const t=[];for(const e in this.filters){const s=this.filters[e];++s.orderIndex,t.push(s)}e.orderIndex=1;const s=t.sort((e,t)=>e.orderIndex-t.orderIndex).map(e=>e.id);this.onUpdateDialogFilterOrder({_:"updateDialogFilterOrder",order:s})}},this.updateLocalFilters=(e,t)=>{const s=Object.assign({},this.localFilters);t?delete s[e.id]:s[e.id]=e,this.localFilters=Object.assign({},s),ee.a.set({localFilters:s})},this.clear(),this.filters={},this.localFilters={},this.appStateManager.getState().then(e=>ne(this,void 0,void 0,(function*(){var t;Object(m.i)(this.filters,e.filters),Array.isArray(null===(t=e.pinnedOrders)||void 0===t?void 0:t[0])&&e.pinnedOrders[0].forEach(e=>{this.addLocalPinnedDialog(0,e)});for(const e in this.filters){const t=this.filters[e];t.hasOwnProperty("orderIndex")&&t.orderIndex>=this.orderIndex&&(this.orderIndex=t.orderIndex+1),t.pinnedPeerIds.forEach(t=>{this.addLocalPinnedDialog(+e,t)})}const s=yield ee.a.get("localFilters");s&&(this.localFilters=Object.assign({},s));const i=yield ee.a.get("localPinned");if(i){const e=ie(i),t={};for(const s in e)t[s]=new Set(e[s]),t[s].size&&t[s].forEach(e=>{this.addLocalPinnedDialog(+s,e)})}}))),o.addMultipleEventsListeners({updateDialogFilter:this.onUpdateDialogFilter,updateDialogFilters:e=>{const t=Object(m.a)(this.filters);this.getDialogFilters(!0).then(e=>{for(const s in t){const t=+s;e.find(e=>e.id===t)||this.onUpdateDialogFilter({_:"updateDialogFilter",id:t})}this.onUpdateDialogFilterOrder({_:"updateDialogFilterOrder",order:e.map(e=>e.id)})})},updateDialogFilterOrder:this.onUpdateDialogFilterOrder,language_change:()=>{a.processLocalUpdate({_:"updateDialogFilters"})}})}clear(e=!1){e||Object(m.i)(this.filters,{}),this.orderIndex=1,this.reloadedPeerIds=new Set}testDialogForFilter(e,t){var s,i;const n=e.peerId;if(!this.appMessagesManager.getDialogOnly(n))return!1;if(t.excludePeerIds.includes(n))return!1;const a=t.pFlags;if(a.exclude_archived&&1===e.folder_id)return!1;if(a.exclude_read&&!this.appMessagesManager.isDialogUnread(e))return!1;if(a.exclude_muted){if(this.appNotificationsManager.isPeerLocalMuted(n))return!1}if(t.includePeerIds.includes(n))return!0;if(this.appPeersManager.isAnyChat(n)){if(a.broadcasts&&this.appPeersManager.isBroadcast(n))return!0;if(a.groups&&this.appPeersManager.isAnyGroup(n))return!0;if(8224===t.flags||a.admin){const e=this.appPeersManager.getPeer(n);if((this.appPeersManager.isChannel(n)||this.appPeersManager.isAnyGroup(n))&&(!0===e.pFlags.creator||!0===(null===(i=null===(s=null==e?void 0:e.admin_rights)||void 0===s?void 0:s.pFlags)||void 0===i?void 0:i.post_messages)))return!0}}else{const e=n.toUserId();if(this.appUsersManager.isBot(e))return!!a.bots;if(a.non_contacts&&!this.appUsersManager.isContact(e))return!0;if(a.contacts&&this.appUsersManager.isContact(e))return!0}return!1}testDialogForFilterId(e,t){return this.testDialogForFilter(e,this.filters[t])}getFilter(e){return this.filters[e]}toggleDialogPin(e,t){const s=this.filters[t],i=s.pinnedPeerIds.indexOf(e),n=-1!==i;if(n&&(s.pinned_peers.splice(i,1),s.pinnedPeerIds.splice(i,1),this.removeLocalPinnedDialog(t,e)),!n){if(s.pinned_peers.length>=this.rootScope.config.pinned_infolder_count_max)return Promise.reject({type:"PINNED_DIALOGS_TOO_MUCH"});s.pinned_peers.push(this.appPeersManager.getInputPeerById(e)),s.pinnedPeerIds.push(e),this.addLocalPinnedDialog(t,e)}return this.updateDialogFilter(s)}createDialogFilter(e,t){const s=Math.max(1,...Object.keys(this.filters).map(e=>+e));return(e=Object(m.a)(e)).id=s+1,this.localFilters[e.id]=e,this.updateDialogFilter(e,void 0,t)}updateDialogFilter(e,t=!1,s=!1){const i=t?0:1;return e.id in this.localFilters?Promise.resolve().then(()=>(this.updateLocalFilters(e,t),this.afterUpdateFilter(e,t,s),!0)):F.a.invokeApi("messages.updateDialogFilter",{flags:i,id:e.id,filter:t?void 0:this.getOutputDialogFilter(e)}).then(i=>(i&&this.afterUpdateFilter(e,t,s),i))}getOutputDialogFilter(e){const t=Object(m.a)(e);return this.filterIncludedPinnedPeers(e),t}filterIncludedPinnedPeers(e){Object(a.e)(e.includePeerIds,(t,s)=>{e.pinnedPeerIds.includes(t)&&(e.include_peers.splice(s,1),e.includePeerIds.splice(s,1))})}reloadMissingPeerIds(e){const t=[],s=this.getFilter(e),i=null==s?void 0:s.pinned_peers;if(null==i?void 0:i.length){const e=i.filter((e,t)=>{const s=this.appPeersManager.getPeerId(e);return!this.reloadedPeerIds.has(s)&&!this.appMessagesManager.getDialogOnly(s)});if(e.length){const s=e.map(e=>{const t=this.appPeersManager.getPeerId(e),s=this.appMessagesManager.reloadConversation(e);return s.then(()=>{this.reloadedPeerIds.add(t)}),s}),i=Promise.all(s);t.push(i)}}return t.length?Promise.all(t):void 0}getDialogFilters(e=!1){return ne(this,void 0,void 0,(function*(){const t=Object.keys(this.filters);if(t.length&&!e)return t.map(e=>this.filters[e]).sort((e,t)=>e.orderIndex-t.orderIndex);const s=yield F.a.invokeApiSingle("messages.getDialogFilters");for(const e in this.localFilters){const t=this.localFilters[e];s.push(t)}for(const t of s)this.saveDialogFilter(t,e);return s}))}saveDialogFilter(e,t=!0){ae.forEach(([t,s])=>{e[s]=e[t].map(e=>this.appPeersManager.getPeerId(e))}),this.filterIncludedPinnedPeers(e),e.include_peers=e.pinned_peers.concat(e.include_peers),e.includePeerIds=e.pinnedPeerIds.concat(e.includePeerIds);const s=this.filters[e.id];s?Object.assign(s,e):this.filters[e.id]=e,this.setOrderIndex(e),t?this.rootScope.dispatchEvent("filter_update",e):s||this.rootScope.dispatchEvent("filter_new",e)}setOrderIndex(e){e.hasOwnProperty("orderIndex")?e.orderIndex>=this.orderIndex&&(this.orderIndex=e.orderIndex+1):e.orderIndex=this.orderIndex++,this.appStateManager.pushToState("filters",this.filters)}}var re=s(153),le=s(143);class de{constructor(e,t,s=!0,i,n=!0,a=!0,o){this.name=e,this.type=t,this.clearable=s,this.autonomous=a,this.onFound=o,this.list=Jd.createChatList(),this.container=document.createElement("div"),i&&(this.container.className=i),e&&(this.nameEl=document.createElement("div"),this.nameEl.classList.add("search-group__name"),"string"==typeof e&&this.nameEl.append(Object(O.i18n)(e)),this.container.append(this.nameEl)),this.container.classList.add("search-group","search-group-"+t),this.container.append(this.list),this.container.style.display="none",n&&Jd.setListClickListener(this.list,o,void 0,a)}clear(){this.container.style.display="none",this.clearable&&(this.list.innerHTML="")}setActive(){this.container.style.display=""}toggle(){this.list.childElementCount?this.setActive():this.clear()}}class ce{constructor(e,t,s,i){this.container=e,this.searchInput=t,this.searchGroups=s,this.onSearch=i,this.minMsgId=0,this.loadedCount=-1,this.foundCount=-1,this.searchPromise=null,this.searchTimeout=0,this.query="",this.listsContainer=null,this.threadId=0,this.scrollable=new re.b(this.container),this.listsContainer=this.scrollable.container;for(let e in this.searchGroups)this.listsContainer.append(this.searchGroups[e].container);this.searchGroups.messages&&this.scrollable.setVirtualContainer(this.searchGroups.messages.list),this.searchInput.onChange=e=>{this.query=e,this.reset(!1),this.searchMore()},this.scrollable.onScrolledBottom=()=>{this.query.trim()&&(this.searchTimeout||(this.searchTimeout=window.setTimeout(()=>{this.searchMore(),this.searchTimeout=0},0)))}}reset(e=!0){e&&(this.searchInput.value="",this.query="",this.peerId=void 0,this.threadId=0),this.minMsgId=0,this.loadedCount=-1,this.foundCount=-1;for(let e in this.searchGroups)this.searchGroups[e].clear();this.searchPromise=null}beginSearch(e,t=0,s=""){this.peerId=e,this.threadId=t,this.query!==s&&(this.searchInput.inputField.value=s),this.searchInput.input.focus()}searchMore(){if(this.searchPromise)return this.searchPromise;const e=this.query;if(!e.trim())return void(this.onSearch&&this.onSearch(0));if(-1!==this.foundCount&&this.loadedCount>=this.foundCount)return Promise.resolve();const t=this.minMsgId||0;return this.searchPromise=js.getSearch({peerId:this.peerId,query:e,inputFilter:{_:"inputMessagesFilterEmpty"},maxId:t,limit:20,threadId:this.threadId}).then(t=>{if(this.searchPromise=null,this.searchInput.value!==e)return;const{count:s,history:i}=t;i.length&&i[0].mid===this.minMsgId&&i.shift();const n=this.searchGroups.messages;i.forEach(t=>{const s=this.peerId?t.fromId:t.peerId,{dialog:i,dom:n}=Jd.addDialogNew({dialog:s,container:this.scrollable,drawStatus:!1,avatarSize:54,meAsSaved:!1});t.peerId!==s&&(n.listEl.dataset.peerId=""+t.peerId),Jd.setLastMessage(i,t,n,e)}),n.toggle(),this.minMsgId=i.length&&i[i.length-1].mid,-1===this.loadedCount&&(this.loadedCount=0),this.loadedCount+=i.length,-1===this.foundCount&&(this.foundCount=s,n.nameEl&&Object(le.a)(n.nameEl,Object(O.i18n)(s?"Chat.Search.MessagesFound":"Chat.Search.NoMessagesFound",[s])),this.onSearch&&this.onSearch(this.foundCount))}).catch(e=>{console.error("search error",e),this.searchPromise=null})}}const he=new Set(["all","web","webk"]),ue=new Set;function pe(e){return e.find(e=>he.has(e.platform)&&!ue.has(e.reason))}function ge(e){return!!pe(e)}function me(e){return e&&e.toLowerCase()||""}var fe=s(177),ve=s(116);const be=new class{constructor(){this.storage=ve.default.storages.users,this.updateUsersStatuses=()=>{const e=Object(S.f)(!0);for(const t in this.users){const s=this.users[t];this.updateUserStatus(s,e)}},this.setUserPayHash=e=>F.a.invokeApi("getPayHash",{flag:0,msg_id:0,peer:{_:"peerUser",user_id:e}}).then(e=>{H.default.payHash=e.hash}),this.clear(!0),setInterval(this.updateUsersStatuses,6e4),H.default.addEventListener("state_synchronized",this.updateUsersStatuses),H.default.addMultipleEventsListeners({updateUserStatus:e=>{const t=e.user_id,s=this.users[t];s&&(s.status=e.status,s.status&&("expires"in s.status&&(s.status.expires-=U.a.serverTimeOffset),"was_online"in s.status&&(s.status.was_online-=U.a.serverTimeOffset)),H.default.dispatchEvent("user_update",t),this.setUserToStateIfNeeded(s))},updateUserPhoto:e=>{const t=e.user_id,s=this.users[t];s?(this.forceUserOnline(t),"userProfilePhotoEmpty"===e.photo._?delete s.photo:s.photo=Object(m.i)(s.photo,e.photo),this.setUserToStateIfNeeded(s),H.default.dispatchEvent("user_update",t),H.default.dispatchEvent("avatar_update",t.toPeerId())):console.warn("No user by id:",t)},updateUserName:e=>{const t=e.user_id,s=this.users[t];s&&(this.forceUserOnline(t),this.saveApiUser(Object.assign({},s,{first_name:e.first_name,last_name:e.last_name,username:e.username}),!0))}}),H.default.addEventListener("language_change",e=>{const t=this.getSelf().id;this.contactsIndex.indexObject(t,this.getUserSearchText(t))}),ve.default.getState().then(e=>{const t=ve.default.storagesResults.users;if(t.length)for(let e=0,s=t.length;e<s;++e){const s=t[e];s&&(this.users[s.id]=s)}const s=e.contactsList;s&&Array.isArray(s)&&(s.forEach(e=>{this.pushContact(e)}),s.length&&(this.contactsFillPromise=Object(w.a)(),this.contactsFillPromise.resolve(this.contactsList))),ve.default.addEventListener("peerNeeded",e=>{if(!Te.isUser(e))return;const t=e.toUserId();this.storage.getFromCache(t)||this.storage.set({[t]:this.getUser(t)})}),ve.default.addEventListener("peerUnneeded",e=>{if(!Te.isUser(e))return;const t=e.toUserId();this.storage.getFromCache(t)&&this.storage.delete(t)})})}clear(e=!1){if(e)this.users={},this.usernames={};else{const e=ve.default.storagesResults.users;for(const t in this.users){if(!t)continue;const s=t.toPeerId();if(!ve.default.isPeerNeeded(s)){const s=this.users[t];s.username&&delete this.usernames[me(s.username)],e.findAndSplice(e=>e.id===t),this.storage.delete(t),delete this.users[t]}}}this.getTopPeersPromises={},this.contactsIndex=this.createSearchIndex(),this.contactsFillPromise=void 0,this.contactsList=new Set,this.updatedContactsList=!1}onContactsModified(){const e=[...this.contactsList];ve.default.pushToState("contactsList",e)}fillContacts(){var e;if(this.contactsFillPromise&&this.updatedContactsList)return{cached:this.contactsFillPromise.isFulfilled,promise:this.contactsFillPromise};this.updatedContactsList=!0;const t=Object(w.a)();return F.a.invokeApi("contacts.getContacts").then(e=>{"contacts.contacts"===e._&&(this.contactsList.clear(),this.saveApiUsers(e.users),e.contacts.forEach(e=>{this.pushContact(e.user_id)}),this.onContactsModified(),this.contactsFillPromise=t),t.resolve(this.contactsList)},()=>{this.updatedContactsList=!1}),{cached:null===(e=this.contactsFillPromise)||void 0===e?void 0:e.isFulfilled,promise:this.contactsFillPromise||(this.contactsFillPromise=t)}}resolveUsername(e){return"@"===e[0]&&(e=e.slice(1)),e=e.toLowerCase(),this.usernames[e]?Promise.resolve(this.users[this.usernames[e]]):F.a.invokeApi("contacts.resolveUsername",{username:e}).then(e=>(this.saveApiUsers(e.users),Pe.saveApiChats(e.chats),Te.getPeer(Te.getPeerId(e.peer))))}pushContact(e){this.contactsList.add(e),this.contactsIndex.indexObject(e,this.getUserSearchText(e)),ve.default.requestPeerSingle(e.toPeerId(),"contact")}popContact(e){this.contactsList.delete(e),this.contactsIndex.indexObject(e,""),ve.default.releaseSinglePeer(e.toPeerId(),"contact")}getUserSearchText(e){const t=this.users[e];if(!t)return"";return[t.first_name,t.last_name,t.phone,t.username,t.pFlags.self?O.default.format("SavedMessages",!0):"",t.pFlags.self?"Saved Messages":""].filter(Boolean).join(" ")}getContacts(e,t=!1,s="name"){return this.fillContacts().promise.then(i=>{let n=[...i];if(e){const t=this.contactsIndex.search(e);n=[...n].filter(e=>t.has(e))}"name"===s?n.sort((e,t)=>{const s=(this.users[e]||{}).sortName||"",i=(this.users[t]||{}).sortName||"";return s.localeCompare(i)}):"online"===s&&n.sort((e,t)=>{const s=be.getUserStatusForSort(be.getUser(e).status);return be.getUserStatusForSort(be.getUser(t).status)-s});const o=H.default.myId.toUserId();return Object(a.f)(n,o),t&&this.testSelfSearch(e)&&n.unshift(o),n})}getContactsPeerIds(e,t,s){return this.getContacts(e,t,s).then(e=>e.map(e=>e.toPeerId(!1)))}toggleBlock(e,t){return F.a.invokeApiSingle(t?"contacts.block":"contacts.unblock",{id:Te.getInputPeerById(e)}).then(s=>(s&&Ie.processLocalUpdate({_:"updatePeerBlocked",peer_id:Te.getOutputPeer(e),blocked:t}),s))}testSelfSearch(e){const t=this.getSelf(),s=this.createSearchIndex();return s.indexObject(t.id,this.getUserSearchText(t.id)),s.search(e).has(t.id)}createSearchIndex(){return new $({clearBadChars:!0,ignoreCase:!0,latinize:!0,includeTag:!0})}saveApiUsers(e,t){e.saved||(e.saved=!0,e.forEach(e=>this.saveApiUser(e,t)))}saveApiUser(e,t){var s,i;if("userEmpty"===e._)return;const n=e.id,a=this.users[n];if(void 0===e.pFlags&&(e.pFlags={}),e.pFlags.min&&void 0!==a)return;if(!a||a.username!==e.username){if(null==a?void 0:a.username){const e=me(a.username);delete this.usernames[e]}if(e.username){const t=me(e.username);this.usernames[t]=n}}if(a&&void 0!==a.sortName&&a.first_name===e.first_name&&a.last_name===e.last_name)e.sortName=a.sortName;else{const t=e.first_name+(e.last_name?" "+e.last_name:"");e.sortName=e.pFlags.deleted?"":K(t,!1)}e.status&&(e.status.expires&&(e.status.expires-=U.a.serverTimeOffset),e.status.was_online&&(e.status.was_online-=U.a.serverTimeOffset));let o=!1,r=!1;if(void 0===a)this.users[n]=e;else{e.first_name===a.first_name&&e.last_name===a.last_name&&e.username===a.username||(r=!0);(null===(s=a.photo)||void 0===s?void 0:s.photo_id)!==(null===(i=e.photo)||void 0===i?void 0:i.photo_id)&&(o=!0);const t=!!a.pFlags.contact,l=!!e.pFlags.contact;Object(m.i)(a,e),H.default.dispatchEvent("user_update",n),t!==l&&this.onContactUpdated(n,l,t)}o&&H.default.dispatchEvent("avatar_update",e.id.toPeerId()),r&&H.default.dispatchEvent("peer_title_edit",e.id.toPeerId()),this.setUserToStateIfNeeded(e)}setUserToStateIfNeeded(e){ve.default.isPeerNeeded(e.id.toPeerId())&&this.storage.set({[e.id]:e})}formatUserPhone(e){return"+"+Object(fe.a)(e).formatted}isUserOnlineVisible(e){return this.getUserStatusForSort(e)>3}getUserStatusForSort(e){if("object"!=typeof e&&(e=this.getUser(e).status),e){const t="userStatusOnline"===e._?e.expires:"userStatusOffline"===e._?e.was_online:0;if(t)return t;switch(e._){case"userStatusRecently":return 3;case"userStatusLastWeek":return 2;case"userStatusLastMonth":return 1}}return 0}getUser(e){return Object(m.f)(e)?e:this.users[e]||{id:e,pFlags:{deleted:!0},access_hash:""}}getSelf(){return this.getUser(H.default.myId)}getUserStatusString(e){var t;let s,i;switch(e){case Z.c:s="Peer.RepliesNotifications";break;case Z.d:s="Peer.ServiceNotifications";break;default:{if(this.isBot(e)){s="Bot";break}const n=this.getUser(e);if(!n){s="";break}if(n.pFlags.support){s="SupportStatus";break}switch(null===(t=n.status)||void 0===t?void 0:t._){case"userStatusRecently":s="Lately";break;case"userStatusLastWeek":s="WithinAWeek";break;case"userStatusLastMonth":s="WithinAMonth";break;case"userStatusOffline":{const e=n.status.was_online,t=Date.now()/1e3;if(t-e<60)s="Peer.Status.justNow";else if(t-e<3600){s="Peer.Status.minAgo";i=[(t-e)/60|0]}else if(t-e<86400){s="LastSeen.HoursAgo";i=[(t-e)/3600|0]}else{s="Peer.Status.LastSeenAt";const t=new Date(1e3*e);i=[("0"+t.getDate()).slice(-2)+"."+("0"+(t.getMonth()+1)).slice(-2),("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)]}break}case"userStatusOnline":s="Online";break;default:s="ALongTimeAgo"}break}}return Object(O.i18n)(s,i)}isBot(e){return this.users[e]&&!!this.users[e].pFlags.bot}isContact(e){return this.contactsList.has(e)||!(!this.users[e]||!this.users[e].pFlags.contact)}isRegularUser(e){const t=this.users[e];return t&&!this.isBot(e)&&!t.pFlags.deleted&&!t.pFlags.support}isNonContactUser(e){return this.isRegularUser(e)&&!this.isContact(e)&&e.toPeerId()!==H.default.myId}hasUser(e,t){const s=this.users[e];return Object(m.f)(s)&&(t||!s.pFlags.min)}canSendToUser(e){const t=this.getUser(e);return!t.pFlags.deleted&&t.id.toPeerId()!==Z.c}getUserPhoto(e){const t=this.getUser(e);return t&&t.photo||{_:"userProfilePhotoEmpty"}}getUserString(e){const t=this.getUser(e);return"u"+e+(t.access_hash?"_"+t.access_hash:"")}getUserInput(e){const t=this.getUser(e);return t.pFlags&&t.pFlags.self?{_:"inputUserSelf"}:{_:"inputUser",user_id:e,access_hash:t.access_hash}}getContactMediaInput(e){const t=this.getUser(e);return{_:"inputMediaContact",first_name:t.first_name,last_name:t.last_name,phone_number:t.phone,vcard:"",user_id:e}}updateUserStatus(e,t=Object(S.f)(!0)){e.status&&"userStatusOnline"===e.status._&&e.status.expires<t&&(e.status={_:"userStatusOffline",was_online:e.status.expires},H.default.dispatchEvent("user_update",e.id),this.setUserToStateIfNeeded(e))}forceUserOnline(e,t){if(this.isBot(e))return;const s=Object(S.f)(!0);if(t){if(s-t>=60)return}else if(Ie.updatesState.syncLoading)return;const i=this.getUser(e);i&&i.status&&"userStatusOnline"!==i.status._&&"userStatusEmpty"!==i.status._&&!i.pFlags.support&&!i.pFlags.deleted&&(i.status={_:"userStatusOnline",expires:s+60},H.default.dispatchEvent("user_update",e),this.setUserToStateIfNeeded(i))}importContact(e,t,s){return this.importContacts([{first_name:e,last_name:t,phones:[s]}]).then(e=>{if(!e.length){const e=new Error;throw e.type="NO_USER",e}return e[0]})}importContacts(e){const t=[];for(let s=0;s<e.length;++s)for(let i=0;i<e[s].phones.length;++i)t.push({_:"inputPhoneContact",client_id:(s<<16|i).toString(10),phone:e[s].phones[i],first_name:e[s].first_name,last_name:e[s].last_name});return F.a.invokeApi("contacts.importContacts",{contacts:t}).then(e=>{const t=new Map;e.imported.forEach(e=>{t.set(e.user_id,this.isContact(e.user_id))}),this.saveApiUsers(e.users);return e.imported.map(e=>{const s=t.get(e.user_id);return this.onContactUpdated(e.user_id,!0,s),e.user_id})})}getTopPeers(e){return this.getTopPeersPromises[e]?this.getTopPeersPromises[e]:this.getTopPeersPromises[e]=ve.default.getState().then(t=>{const s=t.topPeersCache[e];return s&&s.cachedTime+864e5>Date.now()&&s.peers?s.peers:F.a.invokeApi("contacts.getTopPeers",{[e]:!0,offset:0,limit:15,hash:"0"}).then(s=>{let i=[];return"contacts.topPeers"===s._&&(this.saveApiUsers(s.users),Pe.saveApiChats(s.chats),s.categories.length&&(i=s.categories[0].peers.map(e=>{const t=Te.getPeerId(e.peer);return ve.default.requestPeer(t,"topPeer"),{id:t,rating:e.rating}}))),t.topPeersCache[e]={peers:i,cachedTime:Date.now()},ve.default.pushToState("topPeersCache",t.topPeersCache),i})})}getBlocked(e=0,t=0){return F.a.invokeApiSingle("contacts.getBlocked",{offset:e,limit:t}).then(e=>{this.saveApiUsers(e.users),Pe.saveApiChats(e.chats);return{count:"contacts.blocked"===e._?e.users.length+e.chats.length:e.count,peerIds:e.users.map(e=>e.id.toPeerId()).concat(e.chats.map(e=>e.id.toPeerId(!0)))}})}searchContacts(e,t=20){return F.a.invokeApiCacheable("contacts.search",{q:e,limit:t},{cacheSeconds:60}).then(e=>{this.saveApiUsers(e.users),Pe.saveApiChats(e.chats);return{my_results:Object(a.c)(e.my_results.map(e=>Te.getPeerId(e))),results:e.results.map(e=>Te.getPeerId(e))}})}onContactUpdated(e,t,s=this.isContact(e)){t!==s&&(t?this.pushContact(e):this.popContact(e),this.onContactsModified(),H.default.dispatchEvent("contacts_update",e))}updateUsername(e){return F.a.invokeApi("account.updateUsername",{username:e}).then(e=>{this.saveApiUser(e)})}setUserStatus(e,t){if(this.isBot(e))return;const s=this.users[e];if(s){const i=t?{_:"userStatusOffline",was_online:Object(S.f)(!0)}:{_:"userStatusOnline",expires:Object(S.f)(!0)+50};s.status=i,H.default.dispatchEvent("user_update",e),this.setUserToStateIfNeeded(s)}}addContact(e,t,s,i,n){return F.a.invokeApi("contacts.addContact",{id:this.getUserInput(e),first_name:t,last_name:s,phone:i,add_phone_privacy_exception:n}).then(t=>{Ie.processUpdateMessage(t,{override:!0}),this.onContactUpdated(e,!0)})}deleteContacts(e){return F.a.invokeApi("contacts.deleteContacts",{id:e.map(e=>this.getUserInput(e))}).then(t=>{Ie.processUpdateMessage(t,{override:!0}),e.forEach(e=>{this.onContactUpdated(e,!1)})})}isRestricted(e){const t=this.getUser(e),s=t.restriction_reason;return!!(t.pFlags.restricted&&s&&ge(s))}};j.a.appUsersManager=be;var ye=be,we=s(55);const Se=new class{constructor(){this.updatesState={pendingPtsUpdates:[],pendingSeqUpdates:{},syncPending:null,syncLoading:null},this.channelStates={},this.attached=!1,this.log=Object(i.b)("UPDATES",i.a.Error|i.a.Warn|i.a.Log),this.debug=j.b,this.processUpdateMessage=(e,t={})=>{const s={date:e.date,seq:e.seq,seqStart:e.seq_start};switch(this.debug&&this.log.debug("processUpdateMessage",e),e._){case"updatesTooLong":case"new_session_created":this.forceGetDifference();break;case"updateShort":this.processUpdate(e.update,s);break;case"updatesCombined":case"updates":ye.saveApiUsers(e.users,t.override),Pe.saveApiChats(e.chats,t.override),e.updates.forEach(e=>{this.processUpdate(e,s)});break;default:this.log.warn("Unknown update message",e)}}}setProxy(){const e=this;this.updatesState=new Proxy(this.updatesState,{set:function(t,s,i){return t[s]=i,e.saveUpdatesState(),!0}})}saveUpdatesState(){const e=this.updatesState;ve.default.pushToState("updates",{seq:e.seq,pts:e.pts,date:e.date})}popPendingSeqUpdate(){const e=this.updatesState,t=e.seq+1,s=e.pendingSeqUpdates[t];if(!s)return!1;const i=s.updates;for(let e=0,t=i.length;e<t;++e)this.saveUpdate(i[e]);return e.seq=s.seq,s.date&&e.date<s.date&&(e.date=s.date),delete e.pendingSeqUpdates[t],!this.popPendingSeqUpdate()&&e.syncPending&&e.syncPending.seqAwaiting&&e.seq>=e.syncPending.seqAwaiting&&(e.syncPending.ptsAwaiting?delete e.syncPending.seqAwaiting:(clearTimeout(e.syncPending.timeout),e.syncPending=null)),!0}popPendingPtsUpdate(e){const t=e?this.getChannelState(e):this.updatesState;if(!t.pendingPtsUpdates.length)return!1;t.pendingPtsUpdates.sort((e,t)=>e.pts-t.pts);let s=t.pts,i=0,n=0;for(let e=0,a=t.pendingPtsUpdates.length;e<a;++e){const a=t.pendingPtsUpdates[e];s+=a.pts_count,s>=a.pts&&(i=a.pts,n=e)}if(!i)return!1;this.debug&&this.log.debug("pop pending pts updates",i,t.pendingPtsUpdates.slice(0,n+1)),t.pts=i;for(let e=0;e<=n;++e){const s=t.pendingPtsUpdates[e];this.saveUpdate(s)}return t.pendingPtsUpdates.splice(0,n+1),!t.pendingPtsUpdates.length&&t.syncPending&&(t.syncPending.seqAwaiting?delete t.syncPending.ptsAwaiting:(clearTimeout(t.syncPending.timeout),t.syncPending=null)),!0}forceGetDifference(){this.updatesState.syncLoading=null,this.getDifference()}processLocalUpdate(e){this.processUpdateMessage({_:"updateShort",update:e})}getDifference(e=!1){const t=this.updatesState;let s=t.syncLoading;s||(t.pendingSeqUpdates={},t.pendingPtsUpdates=[]),t.syncPending&&(clearTimeout(t.syncPending.timeout),t.syncPending=null);const i=F.a.invokeApi("updates.getDifference",{pts:t.pts,pts_total_limit:e?1200:void 0,date:t.date,qts:-1},{timeout:2147483647}).then(s=>{if(this.debug&&this.log.debug("Get diff result",s),"updates.differenceEmpty"===s._)return this.debug&&this.log.debug("apply empty diff",s.seq),t.date=s.date,void(t.seq=s.seq);if(e&&H.default.dispatchEvent("state_synchronizing"),"updates.differenceTooLong"!==s._){ye.saveApiUsers(s.users),Pe.saveApiChats(s.chats),s.other_updates.forEach(e=>{switch(e._){case"updateChannelTooLong":case"updateNewChannelMessage":case"updateEditChannelMessage":return void this.processUpdate(e)}this.saveUpdate(e)}),s.new_messages.forEach(e=>{this.saveUpdate({_:"updateNewMessage",message:e,pts:t.pts,pts_count:0})});const e="updates.difference"===s._?s.state:s.intermediate_state;t.seq=e.seq,t.pts=e.pts,t.date=e.date}else t.pts=s.pts,t.date=(Date.now()/1e3|0)+U.a.serverTimeOffset,delete t.seq,this.channelStates={},this.log.warn("getDifference:",s._),H.default.dispatchEvent("state_cleared");if("updates.differenceSlice"===s._)return this.getDifference();this.debug&&this.log.debug("finished get diff")});return s||this.justAName(t,i),i}getChannelDifference(e){const t=this.getChannelState(e),s=t.syncLoading;s||(t.pendingPtsUpdates=[]),t.syncPending&&(clearTimeout(t.syncPending.timeout),t.syncPending=null);const i=F.a.invokeApi("updates.getChannelDifference",{channel:Pe.getChannelInput(e),filter:{_:"channelMessagesFilterEmpty"},pts:t.pts,limit:30},{timeout:2147483647}).then(s=>{if(this.debug&&this.log.debug("Get channel diff result",s),t.pts="pts"in s?s.pts:void 0,"updates.channelDifferenceEmpty"!==s._){if("updates.channelDifferenceTooLong"===s._)return this.debug&&this.log.debug("channel diff too long",s),delete this.channelStates[e],void this.saveUpdate({_:"updateChannelReload",channel_id:e});if(ye.saveApiUsers(s.users),Pe.saveApiChats(s.chats),this.debug&&this.log.debug("applying",s.other_updates.length,"channel other updates"),s.other_updates.forEach(e=>{this.saveUpdate(e)}),this.debug&&this.log.debug("applying",s.new_messages.length,"channel new messages"),s.new_messages.forEach(e=>{this.saveUpdate({_:"updateNewChannelMessage",message:e,pts:t.pts,pts_count:0})}),this.debug&&this.log.debug("apply channel diff",t.pts),"updates.channelDifference"===s._&&!s.pFlags.final)return this.getChannelDifference(e);this.debug&&this.log.debug("finished channel get diff")}else this.debug&&this.log.debug("apply channel empty diff",s)});return s||this.justAName(t,i,e),i}justAName(e,t,s){e.syncLoading=t,H.default.dispatchEvent("state_synchronizing",s),t.then(()=>{e.syncLoading=null,H.default.dispatchEvent("state_synchronized",s)},()=>{e.syncLoading=null})}addChannelState(e,t){if(!t)throw new Error("Add channel state without pts "+e);return!(e in this.channelStates)&&(this.channelStates[e]={pts:t,pendingPtsUpdates:[],syncPending:null,syncLoading:null},!0)}getChannelState(e,t){return void 0===this.channelStates[e]&&this.addChannelState(e,t),this.channelStates[e]}processUpdate(e,t={}){var s;let i;switch(e._){case"updateNewChannelMessage":case"updateEditChannelMessage":i=Te.getPeerId(e.message.peer_id).toChatId();break;case"updateChannelTooLong":if(i=e.channel_id,!(i in this.channelStates))return!1;break;default:"channel_id"in e&&"pts"in e&&(i=e.channel_id)}const{pts:n,pts_count:a}=e,o=i?this.getChannelState(i,n):this.updatesState;if(o.syncLoading)return!1;if("updateChannelTooLong"===e._)return(!o.lastPtsUpdateTime||o.lastPtsUpdateTime<Date.now()-6)&&this.getChannelDifference(i),!1;if("updateNewMessage"===e._||"updateEditMessage"===e._||"updateNewChannelMessage"===e._||"updateEditChannelMessage"===e._){const t=e.message,n=Te.getPeerId(t.peer_id),a=t.fwd_from||{};let o;if(t.from_id&&!ye.hasUser(Te.getPeerId(t.from_id),t.pFlags.post)&&(o="author")||a.from_id&&!ye.hasUser(Te.getPeerId(a.from_id),!!a.from_id.channel_id)&&(o="fwdAuthor")||(null===(s=a.from_id)||void 0===s?void 0:s.channel_id)&&!Pe.hasChat(a.from_id.channel_id,!0)&&(o="fwdChannel")||n.isUser()&&!ye.hasUser(n)&&(o="toPeer User")||n.isAnyChat()&&!Pe.hasChat(n.toChatId())&&(o="toPeer Chat"))return this.log.warn("Not enough data for message update",n,o,t),i&&Pe.hasChat(i)&&this.getChannelDifference(i),!1}else if(i&&!Pe.hasChat(i))return!1;let r,l;if(n){if(o.pts+(a||0)<n)return this.debug&&this.log.warn("Pts hole",o,e,i&&Pe.getChat(i)),o.pendingPtsUpdates.push(e),o.syncPending||o.syncLoading||(o.syncPending={timeout:window.setTimeout(()=>{o.syncPending=null,o.syncLoading||i&&this.getChannelDifference(i)},6)}),o.syncPending.ptsAwaiting=!0,!1;if(n>o.pts)o.pts=n,r=!0,o.lastPtsUpdateTime=Date.now();else if(a)return!1;i&&t.date&&this.updatesState.date<t.date&&(this.updatesState.date=t.date)}else if(!i&&t.seq>0){const s=t.seq,i=t.seqStart||s;if(i!==o.seq+1&&i>o.seq)return this.debug&&this.log.warn("Seq hole",o,o.syncPending&&o.syncPending.seqAwaiting),void 0===o.pendingSeqUpdates[i]&&(o.pendingSeqUpdates[i]={seq:s,date:t.date,updates:[]}),o.pendingSeqUpdates[i].updates.push(e),o.syncPending||(o.syncPending={timeout:window.setTimeout(()=>{o.syncPending=null,o.syncLoading||this.getDifference()},6)}),(!o.syncPending.seqAwaiting||o.syncPending.seqAwaiting<i)&&(o.syncPending.seqAwaiting=i),!1;o.seq!==s&&(o.seq=s,t.date&&o.date<t.date&&(o.date=t.date),l=!0)}this.saveUpdate(e),r?this.popPendingPtsUpdate(i):l&&this.popPendingSeqUpdate()}saveUpdate(e){H.default.dispatchEvent(e._,e)}attach(){this.attached||(this.log("attach"),this.attached=!0,ve.default.getState().then(({updates:e})=>{const t=ve.default.newVersion;e&&e.pts&&e.date?(Object.assign(this.updatesState,e),this.log("will get difference",Object.assign({},e)),this.getDifference(!0)):(this.log("will get new state"),this.updatesState.syncLoading=new Promise(e=>{F.a.invokeApi("updates.getState",{},{noErrorBox:!0}).then(t=>{this.updatesState.seq=t.seq,this.updatesState.pts=t.pts,this.updatesState.date=t.date,this.saveUpdatesState(),this.updatesState.syncLoading=null,e()})})),F.a.setUpdatesProcessor(this.processUpdateMessage),this.setProxy(),t&&this.updatesState.syncLoading.then(()=>{fetch("changelogs/"+t+".md").then(e=>200===e.status&&e.ok&&e.text()||Promise.reject()).then(e=>{const t=[],s={_:"updateServiceNotification",entities:t,message:N.b.parseMarkdown(e,t),type:"local",pFlags:{},inbox_date:Date.now()/1e3|0,media:void 0};this.processLocalUpdate(s)}).catch(we.a)})}))}};j.a.apiUpdatesManager=Se;var Ie=Se,Me=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};const Ce=new class{constructor(){this.storage=ve.default.storages.chats,this.onChatUpdated=(e,t,s)=>{var i,n;Ie.processUpdateMessage(t),(s||(null===(n=null===(i=t)||void 0===i?void 0:i.updates)||void 0===n?void 0:n.length))&&this.isChannel(e)&&H.default.dispatchEvent("invalidate_participants",e)},this.onChatUpdatedForce=(e,t)=>this.onChatUpdated(e,t,!0),this.clear(!0),H.default.addMultipleEventsListeners({updateChannelParticipant:e=>{F.a.clearCache("channels.getParticipants",t=>t.channel.channel_id===e.channel_id),H.default.dispatchEvent("chat_participant",e)},updateChatDefaultBannedRights:e=>{const t=Te.getPeerId(e.peer).toChatId(),s=this.chats[t];s&&(s.default_banned_rights=e.default_banned_rights,H.default.dispatchEvent("chat_update",t))}}),ve.default.getState().then(e=>{const t=ve.default.storagesResults.chats;if(t.length)for(let e=0,s=t.length;e<s;++e){const s=t[e];s&&(this.chats[s.id]=s)}ve.default.addEventListener("peerNeeded",e=>{e.isUser()||this.storage.getFromCache(e.toChatId())||this.storage.set({[e.toChatId()]:this.getChat(e.toChatId())})}),ve.default.addEventListener("peerUnneeded",e=>{!e.isUser()&&this.storage.getFromCache(e.toChatId())&&this.storage.delete(e.toChatId())})})}clear(e=!1){if(e)this.chats={};else{const e=ve.default.storagesResults.chats;for(const t in this.chats)t&&(ve.default.isPeerNeeded(t.toPeerId(!0))||(e.findAndSplice(e=>e.id===t),this.storage.delete(t),delete this.chats[t]))}}saveApiChats(e,t){e.saved||(e.saved=!0,e.forEach(e=>this.saveApiChat(e,t)))}saveApiChat(e,t){var s,i;if("chatEmpty"===e._)return;const n=this.chats[e.id];if(void 0===e.pFlags&&(e.pFlags={}),e.pFlags.min&&void 0!==n)return;"channel"===e._&&void 0===e.participants_count&&void 0!==n&&n.participants_count&&(e.participants_count=n.participants_count);let a=!1,o=!1;if(void 0===n)this.chats[e.id]=e;else{(null===(s=n.photo)||void 0===s?void 0:s.photo_id)!==(null===(i=e.photo)||void 0===i?void 0:i.photo_id)&&(a=!0),n.title!==e.title&&(o=!0),Object(m.i)(n,e),H.default.dispatchEvent("chat_update",e.id)}const r=e.id.toPeerId(!0);a&&H.default.dispatchEvent("avatar_update",r),o&&H.default.dispatchEvent("peer_title_edit",r),ve.default.isPeerNeeded(r)&&this.storage.set({[e.id]:e})}getChat(e){return e.isAnyChat()&&(console.error("chatId should be positive"),j.b),this.chats[e]||{_:"chatEmpty",id:e,deleted:!0,access_hash:"",pFlags:{}}}getChatTyped(e){return this.getChat(e)}combineParticipantBannedRights(e,t){const s=this.getChat(e);if(s.default_banned_rights){t=Object(m.a)(t);const e=s.default_banned_rights.pFlags;for(let s in e)t.pFlags[s]=e[s]}return t}hasRights(e,t,s,i){var n;const a=this.getChat(e);if("chatEmpty"===a._)return!1;if(a.pFlags.deactivated&&"view_messages"!==t)return!1;if(a.pFlags.creator&&void 0===s)return!0;if("chatForbidden"===a._||"channelForbidden"===a._||a.pFlags.kicked||a.pFlags.left&&!a.pFlags.megagroup)return!1;if(!s&&!(s=a.admin_rights||a.banned_rights||a.default_banned_rights))return"chat"===a._;let o={};s&&(o=s.pFlags);const r="chatAdminRights"===s._;switch(t){case"embed_links":case"send_games":case"send_gifs":case"send_inline":case"send_media":case"send_messages":case"send_forwarded_messages":case"send_polls":case"send_stickers":if(!i&&a.pFlags.left)return!1;if("chatBannedRights"===s._&&o[t])return!1;if("channel"===a._&&!a.pFlags.megagroup&&!o.post_messages)return!1;break;case"delete_messages":return!!o.delete_messages;case"invite_users":return r?!!o[t]:!o[t];case"edit_chat":return r;case"post_messages":case"edit_messages":case"delete_messages":case"pin_messages":case"add_admins":case"post_live":case"change_info":return r&&!!o[t];case"change_type":case"delete_chat":return!1;case"ban_users":case"change_permissions":return r&&!!o.ban_users;case"view_participants":return"chatBannedRights"===(null==s?void 0:s._)?!(null===(n=null==s?void 0:s.pFlags)||void 0===n?void 0:n.view_participants):!("chat"!==a._&&a.default_banned_rights&&a.default_banned_rights.pFlags.view_participants&&!a.admin_rights)}return!0}editChatDefaultBannedRights(e,t){const s=this.getChat(e);return s.default_banned_rights&&s.default_banned_rights.until_date===t.until_date&&Object(m.b)(s.default_banned_rights.pFlags,t.pFlags)?Promise.resolve():F.a.invokeApi("messages.editChatDefaultBannedRights",{peer:Te.getInputPeerById(e.toPeerId(!0)),banned_rights:t}).then(this.onChatUpdated.bind(this,e))}isChannel(e){const t=this.chats[e];return!(!t||"channel"!==t._&&"channelForbidden"!==t._)}isMegagroup(e){const t=this.chats[e];return!(!t||"channel"!==t._||!t.pFlags.megagroup)}isBroadcast(e){return this.isChannel(e)&&!this.isMegagroup(e)}isInChat(e){let t=!0;const s=this.getChat(e);return("channelForbidden"===s._||"chatForbidden"===s._||"chatEmpty"===s._||s.pFlags.left||s.pFlags.kicked||s.pFlags.deactivated)&&(t=!1),t}getChannelInput(e){const t=this.getChat(e);return"chatEmpty"!==t._&&t.access_hash?{_:"inputChannel",channel_id:e,access_hash:t.access_hash||"0"}:{_:"inputChannelEmpty"}}getInputPeer(e){return this.isChannel(e)?this.getChannelInputPeer(e):this.getChatInputPeer(e)}getChatInputPeer(e){return{_:"inputPeerChat",chat_id:e}}getChannelInputPeer(e){return{_:"inputPeerChannel",channel_id:e,access_hash:this.getChat(e).access_hash||0}}hasChat(e,t){const s=this.chats[e];return Object(m.f)(s)&&(t||!s.pFlags.min)}getChatPhoto(e){const t=this.getChat(e);return t&&t.photo||{_:"chatPhotoEmpty"}}getChatString(e){const t=this.getChat(e);return this.isChannel(e)?(this.isMegagroup(e)?"s":"c")+e+"_"+t.access_hash:"g"+e}createChannel(e,t){return F.a.invokeApi("channels.createChannel",{broadcast:!0,title:e,about:t}).then(e=>{Ie.processUpdateMessage(e);const t=e.chats[0].id;return H.default.dispatchEvent("history_focus",{peerId:t.toPeerId(!0)}),t})}inviteToChannel(e,t){const s=this.getChannelInput(e),i=t.map(e=>ye.getUserInput(e));return F.a.invokeApi("channels.inviteToChannel",{channel:s,users:i}).then(this.onChatUpdated.bind(this,e))}createChat(e,t){return F.a.invokeApi("messages.createChat",{users:t.map(e=>ye.getUserInput(e)),title:e}).then(e=>{Ie.processUpdateMessage(e);const t=e.chats[0].id;return H.default.dispatchEvent("history_focus",{peerId:t.toPeerId(!0)}),t})}leaveChannel(e){return F.a.invokeApi("channels.leaveChannel",{channel:this.getChannelInput(e)}).then(this.onChatUpdated.bind(this,e))}joinChannel(e){return F.a.invokeApi("channels.joinChannel",{channel:this.getChannelInput(e)}).then(this.onChatUpdated.bind(this,e))}addToChat(e,t){return this.isChannel(e)?this.inviteToChannel(e,[t]):this.addChatUser(e,t)}addChatUser(e,t,s=100){return F.a.invokeApi("messages.addChatUser",{chat_id:e,user_id:ye.getUserInput(t),fwd_limit:s}).then(this.onChatUpdated.bind(this,e))}deleteChatUser(e,t){return F.a.invokeApi("messages.deleteChatUser",{chat_id:e,user_id:ye.getUserInput(t)}).then(this.onChatUpdated.bind(this,e))}leaveChat(e){return this.deleteChatUser(e,ye.getSelf().id)}leave(e){return this.isChannel(e)?this.leaveChannel(e):this.leaveChat(e)}delete(e){return this.isChannel(e)?this.deleteChannel(e):this.deleteChat(e)}deleteChannel(e){return F.a.invokeApi("channels.deleteChannel",{channel:this.getChannelInput(e)}).then(this.onChatUpdated.bind(this,e))}deleteChat(e){return F.a.invokeApi("messages.deleteChat",{chat_id:e})}migrateChat(e){const t=this.getChat(e);return"channel"===t._?Promise.resolve(t.id):F.a.invokeApi("messages.migrateChat",{chat_id:e}).then(t=>{this.onChatUpdated(e,t);return t.updates.find(e=>"updateChannel"===e._).channel_id})}updateUsername(e,t){return F.a.invokeApi("channels.updateUsername",{channel:this.getChannelInput(e),username:t}).then(s=>{if(s){this.getChat(e).username=t}return s})}editAdmin(e,t,s,i=""){const n=this.isChannel(e),a=this.getParticipantPeerId(t).toUserId();return this.migrateChat(e).then(e=>F.a.invokeApi("channels.editAdmin",{channel:this.getChannelInput(e),user_id:ye.getUserInput(a),admin_rights:s,rank:i}).then(o=>{const r=Object(S.f)(!0),l=this.generateUpdateChannelParticipant({chatId:e,newParticipant:Object.keys(s.pFlags).length?{_:"channelParticipantAdmin",date:r,admin_rights:s,promoted_by:ye.getSelf().id,user_id:a,rank:i,pFlags:{}}:{_:"channelParticipant",date:r,user_id:a},prevParticipant:t,wasChannel:n});Ie.processLocalUpdate(l),this.onChatUpdatedForce(e,o)}))}editPhoto(e,t){const s={_:"inputChatUploadedPhoto",file:t};let i;return i=this.isChannel(e)?F.a.invokeApi("channels.editPhoto",{channel:this.getChannelInput(e),photo:s},{fileUpload:!0}):F.a.invokeApi("messages.editChatPhoto",{chat_id:e,photo:s},{fileUpload:!0}),i.then(e=>{Ie.processUpdateMessage(e)})}editTitle(e,t){let s;return s=this.isChannel(e)?F.a.invokeApi("channels.editTitle",{channel:this.getChannelInput(e),title:t}):F.a.invokeApi("messages.editChatTitle",{chat_id:e,title:t}),s.then(e=>{Ie.processUpdateMessage(e)})}editAbout(e,t){const s=e.toPeerId(!0);return F.a.invokeApi("messages.editChatAbout",{peer:Te.getInputPeerById(s),about:t}).then(e=>(e&&H.default.dispatchEvent("peer_bio_edit",s),e))}getParticipantPeerId(e){if("object"!=typeof e)return e;return e.peer?this.getPeerId(e.peer):e.user_id.toPeerId()}generateUpdateChannelParticipant({chatId:e,prevParticipant:t,newParticipant:s,wasChannel:i}){return{_:"updateChannelParticipant",channel_id:e,date:Object(S.f)(!0),actor_id:void 0,qts:void 0,user_id:this.getParticipantPeerId(t||s),prev_participant:i?t:void 0,new_participant:s}}editBanned(e,t,s){return Me(this,void 0,void 0,(function*(){const i=this.getParticipantPeerId(t),n=this.isChannel(e);if(!n){const t=yield this.migrateChat(e);e=t}return F.a.invokeApi("channels.editBanned",{channel:this.getChannelInput(e),participant:Te.getInputPeerById(i),banned_rights:s}).then(a=>{const o=Object(S.f)(!0),r=this.generateUpdateChannelParticipant({chatId:e,wasChannel:n,prevParticipant:t,newParticipant:Object.keys(s.pFlags).length?{_:"channelParticipantBanned",date:o,banned_rights:s,kicked_by:ye.getSelf().id,peer:Te.getOutputPeer(i),pFlags:s.pFlags.view_messages?{left:!0}:{}}:void 0});Ie.processLocalUpdate(r),this.onChatUpdated(e,a)})}))}getPeerId(e){if(void 0!==e&&e.isPeerId&&e.isPeerId())return e;if(Object(m.f)(e)){const t=e.user_id;if(void 0!==t)return t.toPeerId(!1);const s=e.channel_id||e.chat_id;return void 0!==s?s.toPeerId(!0):Z.b}if(!e)return Z.b;const t="u"===e.charAt(0),s=e.substr(1).split("_");return t?s[0].toPeerId():(s[0]||"").toPeerId(!0)}clearChannelParticipantBannedRights(e,t){return this.editBanned(e,t,{_:"chatBannedRights",until_date:0,pFlags:{}})}kickFromChannel(e,t){return this.editBanned(e,t,{_:"chatBannedRights",until_date:0,pFlags:{view_messages:!0}})}kickFromChat(e,t){return this.isChannel(e)?this.kickFromChannel(e,t):this.deleteChatUser(e,Object(m.f)(t)?this.getParticipantPeerId(t):t.toUserId())}resolveChannel(e){return F.a.invokeApiSingle("channels.getChannels",{id:[{_:"inputChannel",channel_id:e,access_hash:"0"}]}).then(e=>{this.saveApiChats(e.chats)})}togglePreHistoryHidden(e,t){return this.migrateChat(e).then(e=>F.a.invokeApi("channels.togglePreHistoryHidden",{channel:this.getChannelInput(e),enabled:t})).then(e=>{Ie.processUpdateMessage(e)})}toggleSignatures(e,t){return F.a.invokeApi("channels.toggleSignatures",{channel:this.getChannelInput(e),enabled:t}).then(e=>{Ie.processUpdateMessage(e)})}isRestricted(e){const t=this.getChat(e),s=t.restriction_reason;return!this.isInChat(e)&&!!(t.pFlags.restricted&&s&&ge(s))}toggleNoForwards(e,t){return F.a.invokeApi("messages.toggleNoForwards",{peer:this.getInputPeer(e),enabled:t}).then(e=>{Ie.processUpdateMessage(e)})}};j.a.appChatsManager=Ce;var Pe=Ce;const Le=["#fc5c51","#0fb297","#d09306","#3d72ed","#895dd5","#cd4073","#00c1a6","#fa790f"],Ee=["red","green","yellow","blue","violet","pink","cyan","orange"],_e=[0,7,4,1,6,3,5];["isChannel","isMegagroup","isAnyGroup","isBroadcast","isBot","isContact","isUser","isAnyChat"].forEach(e=>{const t=Array.isArray(e)?e[0]:e,s=Array.isArray(e)?e[1]:e;String.prototype[t]=function(){return ke[s](this.toString())},Number.prototype[t]=function(){return ke[s](this)}});const ke=new class{canPinMessage(e){return e.isUser()&&(ke.isChannel(e)||ke.isMegagroup(e))||Pe.hasRights(e.toChatId(),"pin_messages")}getPeerPhoto(e){if(this.isRestricted(e))return;const t=e.isUser()?ye.getUserPhoto(e.toUserId()):Pe.getChatPhoto(e.toChatId());return"chatPhotoEmpty"!==t._&&"userProfilePhotoEmpty"!==t._?t:void 0}getPeerMigratedTo(e){if(e.isUser())return!1;const t=Pe.getChat(e.toChatId());return!!(t&&t.migrated_to&&t.pFlags.deactivated)&&this.getPeerId(t.migrated_to)}getPeerTitle(e,t=!1,s=!1){e||(e=H.default.myId);let i="";if(e.isUser()){const t=ye.getUser(e.toUserId());t.first_name&&(i+=t.first_name),!t.last_name||s&&i||(i+=" "+t.last_name),i=i?i.trim():t.pFlags.deleted?O.default.format("HiddenName",!0):t.username}else{i=Pe.getChat(e.toChatId()).title,s&&(i=i.split(" ")[0])}return t?i:N.a.wrapEmojiText(i)}getOutputPeer(e){if(e.isUser())return{_:"peerUser",user_id:e.toUserId()};const t=e.toChatId();return Pe.isChannel(t)?{_:"peerChannel",channel_id:t}:{_:"peerChat",chat_id:t}}getPeerString(e){return e.isUser()?ye.getUserString(e.toUserId()):Pe.getChatString(e.toChatId())}getPeerUsername(e){return this.getPeer(e).username||""}getPeerInitials(e){var t;const s=this.getPeer(e);return N.a.getAbbreviation(null!==(t=s.title)&&void 0!==t?t:[s.first_name,s.last_name].filter(Boolean).join(" "))}getPeer(e){return e.isUser()?ye.getUser(e.toUserId()):Pe.getChat(e.toChatId())}getPeerId(e){if(void 0!==e&&e.isPeerId&&e.isPeerId())return e;if(Object(m.f)(e)){const t=e.user_id;if(void 0!==t)return t.toPeerId(!1);const s=e.channel_id||e.chat_id;return void 0!==s?s.toPeerId(!0):H.default.myId}if(!e)return 0;const t="u"===e.charAt(0),s=e.substr(1).split("_");return t?s[0].toPeerId():(s[0]||"").toPeerId(!0)}getDialogPeer(e){return{_:"dialogPeer",peer:this.getOutputPeer(e)}}isChannel(e){return!e.isUser()&&Pe.isChannel(e.toChatId())}isMegagroup(e){return!e.isUser()&&Pe.isMegagroup(e.toChatId())}isAnyGroup(e){return!e.isUser()&&!Pe.isBroadcast(e.toChatId())}isBroadcast(e){return this.isChannel(e)&&!this.isMegagroup(e)}isBot(e){return e.isUser()&&ye.isBot(e.toUserId())}isContact(e){return e.isUser()&&ye.isContact(e.toUserId())}isUser(e){return+e>=0}isAnyChat(e){return!this.isUser(e)}isRestricted(e){return e.isUser()?ye.isRestricted(e.toUserId()):Pe.isRestricted(e.toChatId())}getRestrictionReasonText(e){const t=this.getPeer(e),s=t.restriction_reason?pe(t.restriction_reason):void 0;return s?s.text:e.isUser()?"This user is restricted":"This chat is restricted"}getInputNotifyPeerById(e,t){return t?e.isUser()?{_:"inputNotifyUsers"}:this.isBroadcast(e)?{_:"inputNotifyBroadcasts"}:{_:"inputNotifyChats"}:{_:"inputNotifyPeer",peer:this.getInputPeerById(e)}}getInputPeerById(e){if(!e)return{_:"inputPeerEmpty"};if(!e.isUser()){const t=e.toChatId();return Pe.isChannel(t)?Pe.getChannelInputPeer(t):Pe.getChatInputPeer(t)}const t=e.toUserId();return{_:"inputPeerUser",user_id:t,access_hash:ye.getUser(t).access_hash}}getInputDialogPeerById(e){return{_:"inputDialogPeer",peer:Object(m.f)(e)?e:this.getInputPeerById(e)}}getPeerColorById(e,t=!0){if(!e)return"";const s=_e[Math.abs(+e)%7];return(t?Ee:Le)[s]}getPeerSearchText(e){let t;if(this.isUser(e))t="%pu "+ye.getUserSearchText(e.toUserId());else{t="%pg "+(Pe.getChat(e.toChatId()).title||"")}return t}getDialogType(e){return this.isMegagroup(e)?"megagroup":this.isChannel(e)?"channel":this.isUser(e)?e===H.default.myId?"saved":"chat":"group"}getDeleteButtonText(e){switch(this.getDialogType(e)){case"channel":return Pe.hasRights(e.toChatId(),"delete_chat")?"ChannelDelete":"ChatList.Context.LeaveChannel";case"megagroup":case"group":return Pe.hasRights(e.toChatId(),"delete_chat")?"DeleteMega":"ChatList.Context.LeaveGroup";default:return"ChatList.Context.DeleteChat"}}noForwards(e){var t;if(e.isUser())return!1;return!!(null===(t=Pe.getChatTyped(e.toChatId()).pFlags)||void 0===t?void 0:t.noforwards)}};j.a.appPeersManager=ke;var Te=ke,xe=s(145);const Ae=new WeakMap;j.a.peerTitleWeakMap=Ae,H.default.addEventListener("peer_title_edit",e=>{Array.from(document.querySelectorAll(`.peer-title[data-peer-id="${e}"]`)).forEach(e=>{const t=Ae.get(e);t&&t.update()})});class Oe{constructor(e){this.plainText=!1,this.onlyFirstName=!1,this.dialog=!1,this.element=document.createElement("span"),this.element.classList.add("peer-title"),this.element.setAttribute("dir","auto"),this.update(e),Ae.set(this.element,this)}update(e){if(e)for(let t in e)this.element.dataset[t]=e[t]?""+("boolean"==typeof e[t]?+e[t]:e[t]):"0",this[t]=e[t];this.peerId===H.default.myId&&this.dialog?Object(le.a)(this.element,Object(O.i18n)(this.onlyFirstName?"Saved":"SavedMessages")):this.peerId.isUser()&&ye.getUser(this.peerId).pFlags.deleted?Object(le.a)(this.element,Object(O.i18n)(this.onlyFirstName?"Deleted":"HiddenName")):Object(xe.a)(this.element,Te.getPeerTitle(this.peerId,this.plainText,this.onlyFirstName))}}var Fe=s(190);const De=new Set(["image/jpeg","image/png","image/bmp"]);Fe.a&&De.add("image/webp");var je=De;var Re=!!document.createElement("video").canPlayType("video/quicktime")||C.IS_SAFARI||C.IS_APPLE_MOBILE;const Be=new Set(["image/gif","video/mp4","video/webm"]);Re&&Be.add("video/quicktime");var Ue=Be;function Ne(e){if(e instanceof DocumentFragment)return e;const t=document.createElement("template");return e=e.trim(),t.innerHTML=e,t.content}var He=s(179);function ze(e,t){const s=""["".length-1]||"";let i;switch(e._){case"inputPhotoFileLocation":i=["photo",""[0],e.id,e.thumb_size].filter(Boolean).join("_");break;case"inputDocumentFileLocation":i=["document",""[0],e.id,e.thumb_size].filter(Boolean).join("_");break;case"inputPeerPhotoFileLocation":i=["peerPhoto",e.photo_id,e.pFlags.big?"big":"small"].join("_");break;case"inputStickerSetThumb":i=["stickerSetThumb",e.stickerset.id||e.stickerset.short_name||e.stickerset.emoticon||e.stickerset._,e.thumb_version].join("_");break;case"inputFileLocation":i=e.volume_id+"_"+e.local_id;break;case"inputWebFileLocation":i=["webFile",e.url].join("_");break;default:console.error("Unrecognized location:",e),i=""}return i+(s?"."+s:s)}const We={s:"Seconds",m:"Minutes",h:"Hours",d:"Days",w:"Weeks"};function qe(e){const t=function(e,t=2){e||(e=1);let s=[];const i=[{m:1,t:"s"},{m:60,t:"m"},{m:60,t:"h"},{m:24,t:"d"},{m:7,t:"w"}];let n=1;i.forEach((t,a)=>{if(n*=t.m,e<n)return;const o=i[a===i.length-1?a:a+1].m;s.push({duration:e/n%o|0,type:t.t})});const a=s.slice(-t).reverse();for(let e=a.length-1;e>=0;--e)0===a[e].duration&&a.splice(e,1);return a}(e,2).map(e=>Object(O.i18n)(We[e.type],[e.duration])),s=document.createElement("span");return s.append(...Object(O.join)(t,!1)),s}const Ve=new Error("MIDDLEWARE");class Ge{constructor(){this.details={cleaned:!1,inner:[],onCleanCallbacks:[]},this.onDestroyCallbacks=[],this.onDestroy=e=>{if(this.destroyed)return e();this.onDestroyCallbacks.push(e)}}clean(){const e=this.details;e.cleaned=!0,e.inner.splice(0,e.inner.length).forEach(e=>e.destroy()),e.onCleanCallbacks.splice(0,e.onCleanCallbacks.length).forEach(e=>e()),this.details={cleaned:!1,inner:[],onCleanCallbacks:[]}}destroy(){this.destroyed=!0,this.clean(),this.onDestroyCallbacks.splice(0,this.onDestroyCallbacks.length).forEach(e=>e()),this.parent&&(Object(a.f)(this.parent.details.inner,this),this.parent=void 0)}get(e){const t=this.details,s=()=>!t.cleaned&&(!e||e());return s.create=()=>{if(!s())throw Ve;const e=Ke();return e.parent=this,t.inner.push(e),e},s.onClean=e=>{if(!s())return e();t.onCleanCallbacks.push(e)},s.onDestroy=this.onDestroy,s}}function Ke(){return new Ge}var Qe=s(122);const $e={},Ye=(e,t)=>{e instanceof HTMLImageElement||e instanceof HTMLVideoElement?e.src=t:e instanceof SVGImageElement?e.setAttributeNS(null,"href",t):e.style.backgroundImage="url("+t+")"};function Xe(e,t,s,i=!0){if(!t)return console.error("renderImageFromUrl: no url?",e,t),void(s&&s());if($e[t]&&i||e instanceof HTMLVideoElement)e&&Ye(e,t),s&&s();else{const i=e instanceof HTMLImageElement,n=i?e:new Image;n.src=t,n.addEventListener("load",()=>{!i&&e&&Ye(e,t),$e[t]=!0,s&&s()},{once:!0}),s&&n.addEventListener("error",e=>{console.error("Render image from url failed:",e,t,n),s()})}}function Ze(e,t,s){return new Promise(i=>{Xe(e,t,i,s)})}var Je=s(160),et=s(186);const tt=new class{constructor(){this.cacheStorage=new et.a("cachedFiles"),this.downloads={},this.progress={},this.progressCallbacks={},this.uploadId=0,this.thumbsCache={photo:{},document:{}},H.default.addEventListener("download_progress",e=>{const t=e;this.progress[t.fileName]=t;const s=this.progressCallbacks[t.fileName];s&&s.forEach(e=>e(t));const i=this.downloads[t.fileName];i&&i.notifyAll(t)})}getNewDeferred(e){const t=Object(w.a)();return t.cancel=()=>{const s=new Error("Download canceled");s.name="AbortError",F.a.cancelDownload(e),t.reject(s),t.cancel=()=>{}},t.finally(()=>{delete this.progress[e],delete this.progressCallbacks[e]}),t.catch(()=>{this.clearDownload(e)}),this.downloads[e]=t}clearDownload(e){delete this.downloads[e]}fakeDownload(e,t){const s=this.getNewDeferred(e);return"string"==typeof t?fetch(t).then(e=>e.blob()).then(e=>s.resolve(e)):s.resolve(t),s}download(e){const t=ze(e.location,e.fileName);if(this.downloads.hasOwnProperty(t))return this.downloads[t];const s=this.getNewDeferred(t),i=e=>{s.reject(e)};return(()=>{if(!F.a.worker||e.onlyCache){const n=this.cacheStorage.getFile(t).then(t=>{if(t.size<e.size)throw"wrong size";s.resolve(t)});return e.onlyCache?n.catch(i):n.catch(()=>F.a.downloadFile(e).then(s.resolve,i))}F.a.downloadFile(e).then(s.resolve,i)})(),s}upload(e,t,s){if(!t){const s=null==e?void 0:e.type;if(s){const e=this.uploadId+++"."+s.split("/")[1];t=["image/jpeg","image/png","image/bmp"].indexOf(s)>=0?"photo"+e:0===s.indexOf("audio/")||["video/ogg"].indexOf(s)>=0?"audio"+e:0===s.indexOf("video/")?"video"+e:"document"+e}else t="upload-"+this.uploadId++}const i=this.getNewDeferred(t);return F.a.uploadFile({file:e,fileName:t,peer:s}).then(i.resolve,i.reject),i.finally(()=>{this.clearDownload(t)}),i}getDownload(e){return this.downloads[e]}addProgressCallback(e,t){var s;const i=this.progress[e];(null!==(s=this.progressCallbacks[e])&&void 0!==s?s:this.progressCallbacks[e]=[]).push(t),i&&t(i)}createDownloadAnchor(e,t,s){const i=document.createElement("a");i.href=e,i.download=t,i.target="_blank",i.style.position="absolute",i.style.top="1px",i.style.left="1px",document.body.append(i);try{var n=document.createEvent("MouseEvents");n.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),i.dispatchEvent(n)}catch(t){console.error("Download click error",t);try{i.click()}catch(t){window.open(e,"_blank")}}setTimeout(()=>{i.remove(),s&&s()},100)}downloadToDisc(e,t){const s=this.download(e);return s.then(e=>{const s=URL.createObjectURL(e);this.createDownloadAnchor(s,t,()=>{URL.revokeObjectURL(s)})}),s}getCacheContext(e,t="full"){var s,i;const n=null!==(s=this.thumbsCache[e._][e.id])&&void 0!==s?s:this.thumbsCache[e._][e.id]={};return null!==(i=n[t])&&void 0!==i?i:n[t]={downloaded:0,url:""}}};j.a&&(j.a.appDownloadManager=tt);var st=tt,it=s(170),nt=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};const at=[];let ot=!1;function rt(e,t="push"){return e.items.length?(e.promise=Object(w.a)(),at[t](e),function e(){if(!ot){(function(e){if(!e.items.length)return e.promise.resolve([]),Promise.resolve([]);const t=e.items.slice(),s=[];return new Promise((i,n)=>{const a=()=>nt(this,void 0,void 0,(function*(){const o=performance.now();do{yield Object(it.c)();const i=e.process.apply(e.context,t.shift());let a;if(i instanceof Promise)try{a=yield i}catch(e){return void n(e)}else a=i;s.push(a)}while(t.length>0&&performance.now()-o<6);t.length>0?Object(g.b)(a):i(s)}));Object(g.b)(a)}).then(e.promise.resolve,e.promise.reject)})(at.shift()).finally(()=>{ot=!1,at.length&&e()})}}(),e.promise):Promise.resolve([])}const lt="filter"in(document.createElement("canvas").getContext("2d")||{});let dt,ct;function ht(e,t,s){return new Promise(i=>{const n=document.createElement("canvas");n.width=e.width,n.height=e.height;const a=n.getContext("2d",{alpha:!1});lt?(a.filter=`blur(${t}px)`,a.drawImage(e,2*-t,2*-t,n.width+4*t,n.height+4*t)):(a.drawImage(e,0,0),ct(a,0,0,n.width,n.height,t,s)),i(n.toDataURL())})}dt=lt?Promise.resolve():s.e(31).then(s.bind(null,207)).then(e=>{ct=e.default});const ut=new Map;function pt(e,t=2,s=2){return(e instanceof Promise?e:Promise.resolve(e)).then(e=>{if(!e)return console.error("no dataUri for blur",e),Promise.resolve(e);if(ut.size>1e3&&ut.clear(),ut.has(e))return ut.get(e);const i=new Promise(i=>{dt.then(()=>{const n=new Image;n.onload=()=>{lt?ht(n,t,s).then(i):rt({items:[[n,t,s]],context:null,process:ht},"unshift").then(e=>{i(e[0])})},n.src=e})});return ut.set(e,i),i})}var gt=s(191);var mt=new class{constructor(){this.windowW=0,this.windowH=0;const e="visualViewport"in window?window.visualViewport:window,t=()=>{this.windowW=e.width||e.innerWidth,this.windowH=e.height||e.innerHeight};e.addEventListener("resize",t),t()}},ft=s(22),vt=s(88),bt=s(56),yt=s(9),wt=s(194),St=s(52),It=(s(124),s(64)),Mt=s(86);Mt.a;const Ct=new Map;var Pt=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};let Lt=!1;It.a.setUpdatesProcessor(e=>{Object(bt.b)({update:e})}),It.a.onConnectionStatusChange=e=>{Object(bt.b)({type:"connectionStatusChange",payload:e})};const Et={convertWebp:e=>{const{fileName:t,bytes:s}=e.payload,i=xt.webpConvertPromises[t];i&&(i.resolve(s),delete xt.webpConvertPromises[t])},webpSupport:e=>{Lt=e.payload},socketProxy:e=>{const t=e.payload,s=t.id,i=Ct.get(s);"message"===t.type?i.dispatchEvent("message",t.payload):"open"===t.type?i.dispatchEvent("open"):"close"===t.type&&(i.dispatchEvent("close"),Ct.delete(s))},localStorageProxy:e=>{ee.a.finishTask(e.id,e.payload)},userAgent:e=>{It.a.userAgent=e.payload},online:()=>{It.a.forceReconnectTimeout()},forceReconnect:()=>{It.a.forceReconnect()},toggleStorage:e=>{const t=e.payload;et.a.toggleStorage(t)},refreshReference:e=>{const t=Object(D.f)(e.originalPayload),s=xt.refreshReferencePromises[t],i=null==s?void 0:s.deferred;i&&(e.error?i.reject(e.error):i.resolve(e.payload))}};J.a.addEventListener("message",e=>Pt(void 0,void 0,void 0,(function*(){try{const t=e.data,s=t.taskId,i=Et[t.type];if(i)return void i(t);if(!t.task)return;switch(t.task){case"computeSRP":case"gzipUncompress":return yt.a.invokeCrypto(t.task,...t.args).then(e=>{Object(bt.b)({taskId:s,result:e})});case"requestFilePart":case"setQueueId":case"cancelDownload":case"uploadFile":case"downloadFile":try{let e=xt[t.task].apply(xt,t.args);e instanceof Promise&&(e=yield e),Object(bt.b)({taskId:s,result:e})}catch(e){Object(bt.b)({taskId:s,error:e})}break;case"getNetworker":St.a[t.task].apply(St.a,t.args).finally(()=>{Object(bt.b)({taskId:s,result:null})});break;case"setLanguage":case"startAll":case"stopAll":It.a[t.task].apply(It.a,t.args);break;default:try{let e=St.a[t.task].apply(St.a,t.args);e instanceof Promise&&(e=yield e),Object(bt.b)({taskId:s,result:e})}catch(e){Object(bt.b)({taskId:s,error:e})}}}catch(e){console.error("worker task error:",e)}}))),Object(bt.b)("ready");var _t=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class kt{constructor(){this.cacheStorage=new et.a("cachedFiles"),this.cachedDownloadPromises={},this.uploadPromises={},this.downloadPulls={},this.downloadActives={},this.webpConvertPromises={},this.refreshReferencePromises={},this.log=Object(i.b)("AFM",i.a.Error|i.a.Log),this.tempId=0,this.queueId=0,this.debug=ft.a.debug,this.uncompressTGS=(e,t)=>yt.a.invokeCrypto("gzipUncompress",e.slice().buffer,!0),this.convertWebp=(e,t)=>{const s=Object(w.a)(),i={type:"convertWebp",payload:{fileName:t,bytes:e}};return Object(bt.c)(i),this.webpConvertPromises[t]=s},setInterval(()=>{for(const e in this.refreshReferencePromises){const{deferred:t}=this.refreshReferencePromises[e];(t.isFulfilled||t.isRejected)&&delete this.refreshReferencePromises[e]}},18e5)}downloadRequest(e,t,s,i,n=0){void 0===this.downloadPulls[e]&&(this.downloadPulls[e]=[],this.downloadActives[e]=0);const a=this.downloadPulls[e],o=new Promise((e,o)=>{a.push({id:t,queueId:n,cb:s,deferred:{resolve:e,reject:o},activeDelta:i})});return setTimeout(()=>{this.downloadCheck(e)},0),o}downloadCheck(e){const t=this.downloadPulls[e],s="upload"===e?24:36;if(this.downloadActives[e]>=s||!t||!t.length)return!1;const i=t.findAndSplice(e=>0===e.queueId)||t.findAndSplice(e=>e.queueId===this.queueId)||t.shift(),n=i.activeDelta||1;this.downloadActives[e]+=n,i.cb().then(t=>{this.downloadActives[e]-=n,this.downloadCheck(e),i.deferred.resolve(t)},t=>{t&&t.type&&("DOWNLOAD_CANCELED"===t.type||"UPLOAD_CANCELED"===t.type)||this.log.error("downloadCheck error:",t),this.downloadActives[e]-=n,this.downloadCheck(e),i.deferred.reject(t)})}setQueueId(e){this.queueId=e}getFileStorage(){return this.cacheStorage}cancelDownload(e){const t=(this.cachedDownloadPromises[e]?[this.cachedDownloadPromises[e]]:void 0)||(this.uploadPromises[e]?Array.from(this.uploadPromises[e]):[]);let s=!1;for(let e=0,i=t.length;e<i;++e){const i=t[e];!i||i.isRejected||i.isFulfilled||(i.cancel(),s=!0)}return s}requestWebFilePart(e,t,s,i,n=0,a=0,o){return this.downloadRequest(e,n,()=>_t(this,void 0,void 0,(function*(){return o&&o(),St.a.invokeApi("upload.getWebFile",{location:t,offset:s,limit:i},{dcId:e,fileDownload:!0})})),this.getDelta(i),a)}requestFilePart(e,t,s,i,n=0,a=0,o){return this.downloadRequest(e,n,()=>_t(this,void 0,void 0,(function*(){o&&o();const n=()=>_t(this,void 0,void 0,(function*(){o&&o();return St.a.invokeApi("upload.getFile",{location:t,offset:s,limit:i},{dcId:e,fileDownload:!0}).catch(e=>{if("FILE_REFERENCE_EXPIRED"===e.type)return this.refreshReference(t).then(n);throw e})})),a=t.file_reference;if(a&&!t.checkedReference){t.checkedReference=!0;const e=Object(D.f)(a);if(this.refreshReferencePromises[e])return this.refreshReference(t).then(n)}return n()})),this.getDelta(i),a)}getDelta(e){return e/1024/128}getLimitPart(e){let t;return t=512,524288}refreshReference(e){const t=e.file_reference,s=Object(D.f)(t);let i=this.refreshReferencePromises[s];if(!i){const n=Object(w.a)();i=this.refreshReferencePromises[s]={deferred:n,timeout:J.a.setTimeout(()=>{this.log.error("Didn't refresh the reference:",e),n.reject("REFERENCE_IS_NOT_REFRESHED")},6e4)},n.catch(we.a).finally(()=>{clearTimeout(i.timeout)});const a={type:"refreshReference",payload:t};Object(bt.c)(a)}return i.deferred.then(t=>{if(s===Object(D.f)(t))throw"REFERENCE_IS_NOT_REFRESHED";e.file_reference=t})}downloadFile(e){var t;if(!wt.a.isAvailable())return Promise.reject({type:"BROWSER_BLOB_NOT_SUPPORTED"});const s=null!==(t=e.size)&&void 0!==t?t:0,{dcId:i,location:n}=e;let a;"image/webp"!==e.mimeType||Lt?"application/x-tgsticker"===e.mimeType&&(a=this.uncompressTGS,e.mimeType="application/json"):(a=this.convertWebp,e.mimeType="image/png");const o=ze(n,e.fileName),r=this.cachedDownloadPromises[o],l=this.getFileStorage();if(this.debug&&this.log("downloadFile",o,s,n,e.mimeType),r)return s?r.then(t=>t.size<s?(this.debug&&this.log("downloadFile need to deleteFile, wrong size:",t.size,s),this.deleteFile(o).then(()=>this.downloadFile(e)).catch(()=>this.downloadFile(e))):t):r;const d=Object(w.a)(),c=e.mimeType||"image/jpeg";let h,u,p=!1,g=e=>{h=e,delete this.cachedDownloadPromises[o],d.reject(h),g=()=>{},!u||h&&"DOWNLOAD_CANCELED"===h.type||u.truncate()};const m=this.tempId++;l.getFile(o).then(e=>_t(this,void 0,void 0,(function*(){if(e.size<s)throw yield this.deleteFile(o),!1;d.resolve(e)}))).catch(()=>{l.getFileWriter(o,c).then(t=>{u=t;const r=e.limitPart||this.getLimitPart(s);let l,c,h=Promise.resolve();const v=(e,t)=>_t(this,void 0,void 0,(function*(){if(a){return yield a(e,o)}return e})),b="inputWebFileLocation"===n._?this.requestWebFilePart.bind(this):this.requestFilePart.bind(this),y=[];l=0;do{c=Object(w.a)(),y.push({offset:l,writeFilePromise:h,writeFileDeferred:c}),h=c,l+=r}while(l<s);let S=0;const I=()=>_t(this,void 0,void 0,(function*(){const{offset:a,writeFilePromise:l,writeFileDeferred:c}=y.shift();try{f();const h=yield b(i,n,a,r,m,e.queueId,f),u=h.bytes;y.length&&I(),this.debug&&this.log("downloadFile requestFilePart result:",o,h);const g=a+r>=s||!u.byteLength;if(u.byteLength){S+=u.byteLength,d.notify({done:S,offset:a,total:s});const e=yield v(u);f(),yield l,f(),yield wt.a.write(t,e)}c.resolve(),g&&(p=!0,d.resolve(t.finalize(s<2e7)))}catch(e){g(e)}}));for(let e=0,t=Math.min(1/0,y.length);e<t;++e)I()}).catch(e=>{["STORAGE_OFFLINE"].includes(e)||this.log.error("saveFile error:",e)})});const f=()=>{if(h)throw h};return d.cancel=()=>{if(!h&&!p){const e=new Error("Canceled");e.type="DOWNLOAD_CANCELED",g(e)}},d.notify=e=>{Object(bt.b)({progress:Object.assign({fileName:o},e)})},this.cachedDownloadPromises[o]=d,d.safeFinally(()=>{delete this.cachedDownloadPromises[o]}),d}deleteFile(e){return delete this.cachedDownloadPromises[e],this.getFileStorage().delete(e)}uploadFile({file:e,fileName:t,peer:s}){var i;null===kt.peer&&(kt.peer=s);const n=e.size,a=n>=10485760;let o=!1,r=!1,l=0,d=262144;n>67108864?d=524288:n<102400&&(d=32768);const c=this.getDelta(d),h=Math.ceil(n/d),u=Object(x.b)();let p=0;const g={_:a?"inputFileBig":"inputFile",id:u,parts:h,name:t,md5_checksum:""},m={notify:e=>{}},f=new Promise((e,t)=>{if(h>4e3)return t({type:"FILE_TOO_BIG"});m.resolve=e,m.reject=t});if(Object.assign(f,m),h>4e3)return f;let v=e=>{"UPLOAD_CANCELED"!==(null==e?void 0:e.type)&&this.log.error("Up Error",e),f.reject(e),o=!0,v=()=>{}};const b=a?"upload.saveBigFilePart":"upload.saveFilePart",y=this.tempId++,w=this;const S=function*(){for(let t=0;t<n;t+=d){const i=p++;yield w.downloadRequest("upload",y,()=>{const c=e.slice(t,t+d);return Object(vt.b)(c).then(e=>{if(o)throw{type:"UPLOAD_CANCELED"};return w.debug&&w.log("Upload file part, isBig:",a,i,e.byteLength,new Uint8Array(e).length,new Uint8Array(e).slice().length),St.a.invokeApi(b,{file_id:u,file_part:i,file_total_parts:h,bytes:e,peer:s,totalFileSize:n},{fileUpload:!0}).then(e=>{l++,f.notify({done:l*d,total:n}),l>=h&&(f.resolve(g),r=!0)},v)})},c).catch(v)}}(),I=()=>{if(o)return;const e=S.next();e.done||o||e.value.then(I)};for(let e=0,t=Math.min(1/0,h);e<t;++e)I();f.cancel=()=>{o||r||(o=!0,v({type:"UPLOAD_CANCELED"}))},f.notify=e=>{Object(bt.b)({progress:Object.assign({fileName:t},e)})},f.finally(()=>{M.delete(f),M.size||delete this.uploadPromises[t]});const M=null!==(i=this.uploadPromises[t])&&void 0!==i?i:this.uploadPromises[t]=new Set;return M.add(f),f}}kt.peer=null;const Tt=new kt;j.a.apiFileManager=Tt;var xt=Tt,At=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class Ot{constructor(){this.photos={},this.filteredPhotos=[],this.getPreviewURLFromEmptyThumb=(e,t,s=!1)=>At(this,void 0,void 0,(function*(){const i=st.getCacheContext(e,t.type),n=this.getPhotoDownloadOptions(e,t);return xt.requestFilePart(e.dc_id,n.location,0,524288).then(e=>i.url?i.url:this.getPreviewURLFromBytes(e.bytes,s))}))}savePhoto(e,t){var s;if("photoEmpty"===e._)return;const i=this.photos[e.id];if(e.file_reference&&(Object(m.h)("file_reference",i,e),B.saveContext(e.file_reference,t)),null===(s=e.sizes)||void 0===s?void 0:s.length){const t=e.sizes[e.sizes.length-1];"photoSizeProgressive"===t._&&(t.size=t.sizes[t.sizes.length-1])}return i?Object.assign(i,e):this.photos[e.id]=e}choosePhotoSize(e,t=0,s=0,i=!1,n=!1){window.devicePixelRatio>1&&(t*=2,s*=2);let a={_:"photoSizeEmpty",type:""},o=e.sizes||e.thumbs;if(n&&o&&"document"===e._&&(o=o.concat({_:"photoSize",w:e.w,h:e.h,size:e.size,type:void 0})),null==o?void 0:o.length){for(let e=0,i=o.length;e<i;++e){const i=o[e];if(!("w"in i)&&!("h"in i))continue;a=i;const n="w"in i?i.w:0,r="h"in i?i.h:0,l=Object(gt.a)(n,r,t,s);if(l.width>=t||l.height>=s)break}i&&"photoSizeEmpty"===a._&&"photoStrippedSize"===o[0]._&&(a=o[0])}return a}getUserPhotos(e,t="0",s=20){const i=ye.getUserInput(e);return F.a.invokeApiCacheable("photos.getUserPhotos",{user_id:i,offset:0,limit:s,max_id:t},{cacheSeconds:60}).then(s=>{ye.saveApiUsers(s.users);const i=s.photos.map((t,i)=>(s.photos[i]=this.savePhoto(t,{type:"profilePhoto",peerId:e.toPeerId()}),t.id));if(this.filteredPhotos.length&&this.filteredPhotos.forEach(e=>{const t=String(e),s=i.findIndex(e=>String(e)===t);-1!==s&&i.splice(s,1)}),"0"!==t&&t){const e=i.indexOf(t);-1!==e&&i.splice(e,1)}return{count:s.count||i.length,photos:i}})}getPreviewURLFromBytes(e,t=!1){let s,i;i=t?C.IS_SAFARI?"image/png":"image/webp":"image/jpeg",s=e instanceof Uint8Array?e:new Uint8Array(e);const n=s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength),a=new Blob([n],{type:i});return URL.createObjectURL(a)}getPathFromPhotoPathSize(e){const t=e.bytes;let s="M";for(let e=0,i=t.length;e<i;++e){const i=t[e];i>=192?s+="AACAAAAHAAALMAAAQASTAVAAAZaacaaaahaaalmaaaqastava.az0123456789-,"[i-128-64]:(i>=128?s+=",":i>=64&&(s+="-"),s+=""+(63&i))}return s+="z",s}getPreviewURLFromThumb(e,t,s=!1){const i=st.getCacheContext(e,t.type);return i.url||(i.url=this.getPreviewURLFromBytes(t.bytes,s))}getImageFromStrippedThumb(e,t,s){const i=t.bytes.length?this.getPreviewURLFromThumb(e,t,!1):this.getPreviewURLFromEmptyThumb(e,t,!1),n=new Image;n.classList.add("thumbnail");const a=(s?pt(i):Promise.resolve(i)).then(e=>Ze(n,e));return{image:n,loadPromise:a}}setAttachmentSize(e,t,s,i,n=!0,a,o,r){let l;r||(r=this.choosePhotoSize(e,s,i,void 0,o));const d="document"===e._;l=d?Object(I.c)(e.w||r.w||512,e.h||r.h||512):Object(I.c)(r.w||100,r.h||100);let c=Object(I.c)(s,i);c=l=l.aspect(c,n);let h=!0;return d&&!["video","gif"].includes(e.type)||(c.width<200&&c.height<200&&(c=l=l.aspectCovered(Object(I.c)(200,200))),a&&(a.message||a.reply_to_mid||a.media.webpage||a.replies&&a.replies.pFlags.comments&&777!==a.replies.channel_id)&&c.width<320&&(c=Object(I.c)(320,c.height),h=!1),h&&c.width<120&&a&&(c=Object(I.c)(120,c.height),h=!1)),t.style.width=c.width+"px",t.style.height=c.height+"px",{photoSize:r,size:l,isFit:h}}getStrippedThumbIfNeeded(e,t,s,i=!1){if(!t.downloaded||["video","gif"].includes(e.type)||i){if("document"===e._&&t.downloaded&&!i)return null;const n=e.sizes||e.thumbs,a=(null==n?void 0:n.length)?n.find(e=>"photoCachedSize"===e._):null;if(a&&"bytes"in a)return this.getImageFromStrippedThumb(e,a,s)}return null}getPhotoDownloadOptions(e,t,s,i){const n="document"===e._;if(!t||"photoSizeEmpty"===t._)throw new Error("photoSizeEmpty!");const a=("photoSize"===t._||"photoSizeProgressive"===t._)&&e.access_hash&&e.file_reference,o={_:n?"inputDocumentFileLocation":"inputPhotoFileLocation",id:e.id,access_hash:e.access_hash,file_reference:e.file_reference,thumb_size:t.type};return{dcId:e.dc_id,location:o,size:a?t.size:void 0,queueId:s,onlyCache:i}}preloadPhoto(e,t,s,i){const n=this.getPhoto(e);if(!n||"photoEmpty"===n._)throw new Error("preloadPhoto photoEmpty!");if(!t){const e=mt.windowW,s=mt.windowH;t=this.choosePhotoSize(n,e,s)}const a=st.getCacheContext(n,t.type);if(a.downloaded>=("size"in t?t.size:0)&&a.url)return Promise.resolve();const o=this.getPhotoDownloadOptions(n,t,s,i),r=ze(o.location);let l=st.getDownload(r);return l||(l=st.download(o),l.then(e=>{if(!a.downloaded||a.downloaded<e.size){const t=URL.createObjectURL(e);a.downloaded=e.size,a.url=t}return e}).catch(()=>{}),l)}getPhoto(e){return Object(m.f)(e)?e:this.photos[e]}getInput(e){return{_:"inputPhoto",id:e.id,access_hash:e.access_hash,file_reference:e.file_reference}}getMediaInput(e){return{_:"inputMediaPhoto",id:this.getInput(e),ttl_seconds:0}}savePhotoFile(e,t){const s=this.choosePhotoSize(e,65535,65535);if("photoSize"!==s._&&"photoSizeProgressive"!==s._)return;const i=this.getPhotoDownloadOptions(e,s,t);i.fileName="photo"+e.id+".jpg",st.downloadToDisc(i,i.fileName)}}Ot.jpegHeader=Object(D.c)("ffd8ffe000104a46494600010100000100010000ffdb004300281c1e231e19282321232d2b28303c64413c37373c7b585d4964918099968f808c8aa0b4e6c3a0aadaad8a8cc8ffcbdaeef5ffffff9bc1fffffffaffe6fdfff8ffdb0043012b2d2d3c353c76414176f8a58ca5f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8ffc00011080000000003012200021101031101ffc4001f0000010501010101010100000000000000000102030405060708090a0bffc400b5100002010303020403050504040000017d01020300041105122131410613516107227114328191a1082342b1c11552d1f02433627282090a161718191a25262728292a3435363738393a434445464748494a535455565758595a636465666768696a737475767778797a838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae1e2e3e4e5e6e7e8e9eaf1f2f3f4f5f6f7f8f9faffc4001f0100030101010101010101010000000000000102030405060708090a0bffc400b51100020102040403040705040400010277000102031104052131061241510761711322328108144291a1b1c109233352f0156272d10a162434e125f11718191a262728292a35363738393a434445464748494a535455565758595a636465666768696a737475767778797a82838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae2e3e4e5e6e7e8e9eaf2f3f4f5f6f7f8f9faffda000c03010002110311003f00"),Ot.jpegTail=Object(D.c)("ffd9");const Ft=new Ot;j.a&&(j.a.appPhotosManager=Ft);var Dt=Ft;var jt=new class{constructor(){this.savedAvatarURLs={}}isAvatarCached(e){return!!this.savedAvatarURLs[e]}removeFromAvatarsCache(e){this.savedAvatarURLs[e]&&delete this.savedAvatarURLs[e]}loadAvatar(e,t,s){const i=Te.getInputPeerById(e);let n,a=!1,o=this.savedAvatarURLs[e];if(o&&o[s])"string"!=typeof o[s]?n=o[s]:(n=Promise.resolve(o[s]),a=!0);else{o||(o=this.savedAvatarURLs[e]={});const a={_:"inputPeerPhotoFileLocation",pFlags:{},peer:i,photo_id:t.photo_id};"photo_big"===s?(a.pFlags.big=!0,a.local_id=t.photo_big.local_id,a.volume_id=t.photo_big.volume_id):(a.local_id=t.photo_small.local_id,a.volume_id=t.photo_small.volume_id);const r={dcId:t.dc_id,location:a},l=st.download(r);n=o[s]=l.then(e=>o[s]=URL.createObjectURL(e))}return{cached:a,loadPromise:n}}putAvatar(e,t,s,i,n=new Image,a=!1){let o,r,l,{cached:d,loadPromise:c}=this.loadAvatar(t,s,i);if(n.classList.add("avatar-photo"),d)r=()=>{Object(le.a)(e,n),e.dataset.color=""};else{const a=H.default.settings.animationsEnabled;if(a&&n.classList.add("fade-in"),"photo_big"===i){const i=this.putAvatar(e,t,s,"photo_small");o=i.loadPromise,l=i.thumbImage}else if(s.stripped_thumb){l=new Image,e.classList.add("avatar-relative"),l.classList.add("avatar-photo","avatar-photo-thumbnail");const t=Dt.getPreviewURLFromBytes(s.stripped_thumb);o=Ze(l,t).then(()=>{Object(le.a)(e,l)})}r=()=>{l?e.append(n):Object(le.a)(e,n),setTimeout(()=>{e.childElementCount&&Je.a.mutateElement(n,()=>{e.dataset.color="",a&&n.classList.remove("fade-in"),l&&l.remove()})},a?200:0)}}const h=c.then(e=>Ze(n,e)).then(r);return{cached:d,loadPromise:o||h,thumbImage:l}}s(e,t,s,i){Object(xe.a)(e,t),e.dataset.color=s,e.classList.remove("tgico-saved","tgico-deletedaccount","tgico-reply_filled"),i&&e.classList.add(i)}putPhoto(e,t,s=!1,i="",n=!1){const a=H.default.myId;if(t===a&&s)return void this.s(e,"","","tgico-saved");if(t!==Z.b&&t.isUser()){const s=ye.getUser(t);if(s&&s.pFlags&&s.pFlags.deleted)return void this.s(e,"",Te.getPeerColorById(t),"tgico-deletedaccount")}const o=Te.getPeerPhoto(t),r=!!o,l=!!e.firstElementChild&&!e.firstElementChild.classList.contains("emoji");if(!r||!l||!this.savedAvatarURLs[t]){let n="";if(!t||t===a&&s||(n=Te.getPeerColorById(t)),t===Z.c)return void this.s(e,"",n,"tgico-reply_filled");const o=i?N.b.getAbbreviation(i):Te.getPeerInitials(t);this.s(e,o,n,"")}if(r){const s="photo_small";return this.putAvatar(e,t,o,s,void 0,n)}}},Rt=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};const Bt=new class{constructor(){this.sampleRate=48e3,this.tasks=[],this.keepAlive=!1,this.log=Object(i.b)("OPUS",i.a.Error)}isPlaySupported(){if(void 0!==this.isPlaySupportedResult)return this.isPlaySupportedResult;const e=document.createElement("audio");return this.isPlaySupportedResult=!(!e.canPlayType||!e.canPlayType("audio/ogg;").replace(/no/,""))}loadWavWorker(){this.wavWorker||(this.wavWorker=new Worker("waveWorker.min.js"),this.wavWorker.addEventListener("message",e=>{const t=e.data;if(this.log("[WAV] got message:",t),t&&t.page){const e=t.page;this.onTaskEnd(this.tasks.shift(),e)}}))}loadWorker(){this.worker||(this.worker=new Worker("decoderWorker.min.js"),this.worker.addEventListener("message",e=>{const t=e.data;this.log("[DECODER] got message",t),"done"===t.type?(this.wavWorker.postMessage({command:"done"}),t.waveform&&(this.tasks[0].waveform=t.waveform)):this.wavWorker.postMessage({command:"encode",buffers:e.data},C.IS_SAFARI?void 0:t.map(e=>e.buffer))}))}setKeepAlive(e){this.keepAlive=e,this.keepAlive?(this.loadWorker(),this.loadWavWorker()):this.tasks.length||this.terminateWorkers()}onTaskEnd(e,t){t?(clearTimeout(e.timeout),e.callback.resolve({bytes:t,waveform:e.waveform})):e.callback.reject("timeout"),this.tasks.length&&this.executeNewTask(this.tasks[0]),this.terminateWorkers()}terminateWorkers(e=!1){(!this.keepAlive&&!this.tasks.length||e)&&(this.worker&&(this.worker.terminate(),this.worker=null),this.wavWorker&&(this.wavWorker.terminate(),this.wavWorker=null))}executeNewTask(e){this.worker.postMessage({command:"init",decoderSampleRate:this.sampleRate,outputBufferSampleRate:this.sampleRate}),this.wavWorker.postMessage({command:"init",wavBitDepth:16,wavSampleRate:this.sampleRate}),this.log("[DECODER] send decode"),this.worker.postMessage({command:"decode",pages:e.pages,waveform:e.withWaveform},C.IS_SAFARI?void 0:[e.pages.buffer]),e.timeout=window.setTimeout(()=>{this.log.error("decode timeout"),this.terminateWorkers(!0),this.tasks.length&&(this.loadWorker(),this.loadWavWorker()),this.onTaskEnd(this.tasks.shift())},1e4)}pushDecodeTask(e,t){return new Promise((s,i)=>{const n={pages:e,withWaveform:t,callback:{resolve:s,reject:i},timeout:0};this.loadWorker(),this.loadWavWorker(),1===this.tasks.push(n)&&this.executeNewTask(n)})}decode(e,t=!1){return Rt(this,void 0,void 0,(function*(){return this.pushDecodeTask(e,t).then(e=>{const t=new Blob([e.bytes],{type:"audio/wav"});return{url:URL.createObjectURL(t),waveform:e.waveform}})}))}};j.a.opusDecodeController=Bt;var Ut=Bt,Nt=s(147),Ht=s(74),zt=s(173);class Wt extends Mt.a{constructor(e,t){super(!1),this.navigationType=e,this.withOverlay=t,this.onClick=e=>{var t;Object(v.d)(e)||this.element&&Object(zt.a)(e.target,this.element)||((null===(t=this.listenerOptions)||void 0===t?void 0:t.capture)&&Object(f.a)(e),this.close())},this.listenerOptions=t?{}:{capture:!0}}close(){var e;this.element&&(null===(e=this.overlay)||void 0===e||e.remove(),this.element=void 0,this.dispatchEvent("toggle",!1)),Ht.IS_TOUCH_SUPPORTED||window.removeEventListener("contextmenu",this.onClick,this.listenerOptions),document.removeEventListener(v.a,this.onClick,this.listenerOptions),C.IS_MOBILE_SAFARI||Nt.a.removeByType(this.navigationType)}open(e){this.close(),C.IS_MOBILE_SAFARI||Nt.a.pushItem({type:this.navigationType,onPop:e=>{this.close()}}),this.element=e,!this.overlay&&this.withOverlay&&(this.overlay=document.createElement("div"),this.overlay.classList.add("btn-menu-overlay"),this.overlay.addEventListener(v.a,e=>{Object(f.a)(e),this.onClick(e)})),this.overlay&&this.element.parentElement.insertBefore(this.overlay,this.element),Ht.IS_TOUCH_SUPPORTED||window.addEventListener("contextmenu",this.onClick,Object.assign(Object.assign({},this.listenerOptions),{once:!0})),document.addEventListener(v.a,this.onClick,this.listenerOptions),this.dispatchEvent("toggle",!0)}}const qt=document.createElement("div");let Vt;qt.classList.add("toast");const Gt=new Wt("toast");function Kt(){Gt.close(),qt.classList.remove("is-visible"),Vt&&clearTimeout(+Vt),Vt=window.setTimeout(()=>{qt.remove(),Vt=void 0},200)}function Qt(e,t,s=3e3){Gt.close(),Object(le.a)(qt,e),qt.parentElement||(document.body.append(qt),qt.offsetLeft),qt.classList.add("is-visible"),Vt&&clearTimeout(+Vt),Gt.open(qt),Vt=window.setTimeout(Kt,s),t&&Gt.addEventListener("toggle",t,{once:!0})}function $t(e){Qt(Object(O.i18n)(e.langPackKey,e.langPackArguments),e.onClose,e.timeToDisappear)}Gt.addEventListener("toggle",e=>{e||Kt()});var Yt=s(154),Xt=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};const Zt={mov:"video/quicktime",gif:"image/gif",pdf:"application/pdf"};const Jt=new class{constructor(){this.docs={},this.savingLottiePreview={},this.downloading=new Map,this.savedGifs=[],this.onServiceWorkerFail=()=>{for(const e in this.docs){const t=this.docs[e];if(t.supportsStreaming){delete t.supportsStreaming;delete st.getCacheContext(t).url}}},this.isSavedGif=e=>{if("document"===e._&&"gif"===e.type){return!!this.savedGifs.find(t=>t===e.id)}return!1},this.saveGif=e=>{if("document"===e._&&"gif"===e.type){const t=se([...this.savedGifs,e.id]);ee.a.set({savedGifs:t}),this.savedGifs.push(e.id),H.default.dispatchEvent("save_gif",e),$t({langPackKey:"Gif.Saved.Success",timeToDisappear:3500})}},F.a.onServiceWorkerFail=this.onServiceWorkerFail,ee.a.get("savedGifs").then(e=>{if(e){const t=ie(e);this.savedGifs=[...t]}else{const e=se([]);ee.a.set({savedGifs:e})}})}saveDoc(e,t){if("documentEmpty"===e._)return;const s=this.docs[e.id];if(e.file_reference&&(Object(m.h)("file_reference",s,e),B.saveContext(e.file_reference,t)),s||(this.docs[e.id]=e),e.attributes.forEach(t=>{switch(t._){case"documentAttributeFilename":e.file_name=N.a.wrapPlainText(t.file_name),e.fileName=Object(Yt.a)(N.a.wrapEmojiText(t.file_name));break;case"documentAttributeAudio":e.duration=t.duration,e.audioTitle=Object(Yt.a)(N.a.wrapEmojiText(t.title)),e.audioPerformer=Object(Yt.a)(N.a.wrapEmojiText(t.performer)),e.type=t.pFlags.voice&&"audio/ogg"===e.mime_type?"voice":"audio";break;case"documentAttributeVideo":e.duration=t.duration,e.w=t.w,e.h=t.h,t.pFlags.round_message?e.type="round":e.animated?e.type="gif":e.type="video";break;case"documentAttributeSticker":void 0!==t.alt&&(e.stickerEmojiRaw=t.alt,e.stickerEmoji=Object(Yt.a)(N.a.wrapRichText(e.stickerEmojiRaw,{noLinks:!0,noLinebreaks:!0}))),t.stickerset&&("inputStickerSetEmpty"===t.stickerset._?delete t.stickerset:"inputStickerSetID"===t.stickerset._&&(e.stickerSetInput=t.stickerset)),"image/webp"===e.mime_type&&(e.thumbs||Fe.a)&&(e.type="sticker",e.sticker=1);break;case"documentAttributeImageSize":e.type="photo",e.w=t.w,e.h=t.h;break;case"documentAttributeAnimated":"image/gif"!==e.mime_type&&"video/mp4"!==e.mime_type||(e.type="gif"),e.animated=!0}}),e.mime_type)e.mime_type===Zt.pdf?e.type="pdf":e.mime_type===Zt.gif&&(e.type="gif");else{const t=(e.file_name||"").split(".").pop(),s=t&&Zt[t.toLowerCase()];if(s)e.mime_type=s;else switch(e.type){case"gif":case"video":case"round":e.mime_type="video/mp4";break;case"sticker":e.mime_type="image/webp";break;case"audio":e.mime_type="audio/mpeg";break;case"voice":e.mime_type="audio/ogg";break;default:e.mime_type="application/octet-stream"}}if("voice"!==e.type&&"round"!==e.type||(e.file_name=e.fileName=e.type+"_"+Object(S.e)(new Date(1e3*e.date),{monthAsNumber:!0,leadingZero:!0}).replace(/[:\.]/g,"-").replace(", ","_")),F.a.isServiceWorkerOnline()&&("gif"===e.type&&e.size>8e6||"audio"===e.type||"video"===e.type))if("ios"===H.default.platform)e.supportsStreaming=!1;else{e.supportsStreaming=!0;const t=st.getCacheContext(e);t.url||(t.url=this.getFileURL(e))}return e.file_name||(e.file_name=e.fileName=""),"application/x-tgsticker"===e.mime_type&&"AnimatedSticker.tgs"===e.file_name&&(e.type="sticker",e.animated=!0,e.sticker=2),s?Object.assign(s,e):e}getDoc(e){return Object(m.f)(e)?e:this.docs[e]}getMediaInput(e){return{_:"inputMediaDocument",id:{_:"inputDocument",id:e.id,access_hash:e.access_hash,file_reference:e.file_reference},ttl_seconds:0}}getInput(e,t){return{_:"inputDocumentFileLocation",id:e.id,access_hash:e.access_hash,file_reference:e.file_reference,thumb_size:t}}getFileDownloadOptions(e,t,s,i){const n=this.getInput(e,null==t?void 0:t.type);let a;return a=t?e.sticker?"image/webp":"image/jpeg":e.mime_type||"application/octet-stream",{dcId:e.dc_id,location:n,size:t?t.size:e.size,mimeType:a,fileName:e.file_name,queueId:s,onlyCache:i}}getFileURL(e,t=!1,s){let i;return i=t?"download":s?"thumb":e.supportsStreaming?"stream":"document",function(e,t){return"/"+e+"/"+encodeURIComponent(JSON.stringify(t))}(i,this.getFileDownloadOptions(e,s))}getThumbURL(e,t){let s=Promise.resolve();const i=st.getCacheContext(e,t.type);return i.url||(s="bytes"in t?pt(Dt.getPreviewURLFromBytes(t.bytes,!!e.sticker)).then(e=>{i.url=e}):Dt.preloadPhoto(e,t)),{thumb:t,cacheContext:i,promise:s}}getThumb(e,t=!0){const s=Dt.choosePhotoSize(e,0,0,!t);return"photoSizeEmpty"===s._?null:this.getThumbURL(e,s)}getInputFileName(e,t){return ze(this.getInput(e,t),e.file_name)}downloadDoc(e,t,s){const i=this.getInputFileName(e);let n=st.getDownload(i);if(n)return n;const a=this.getFileDownloadOptions(e,void 0,t,s);n=st.download(a),this.downloading.set(e.id,n),H.default.dispatchEvent("download_start",e.id);const o=st.getCacheContext(e),r=n;return r.then(e=>{o.url=URL.createObjectURL(e),o.downloaded=e.size},()=>{}).finally(()=>{this.downloading.delete(e.id)}),"voice"!==e.type||Ut.isPlaySupported()||(n=r.then(e=>Xt(this,void 0,void 0,(function*(){const t=new FileReader;return yield new Promise((s,i)=>{t.onloadend=e=>{const t=new Uint8Array(e.target.result);Ut.decode(t).then(e=>{o.url=e.url,s()},e=>{delete o.downloaded,i(e)})},t.readAsArrayBuffer(e)}),e})))),n.then(()=>{H.default.dispatchEvent("document_downloaded",e)}),n}saveLottiePreview(e,t,s){const i=e.id+"-"+s;if(this.savingLottiePreview[i])return;e.stickerCachedThumbs||(Object(m.c)(e,["stickerCachedThumbs"]),e.stickerCachedThumbs={});const n=e.stickerCachedThumbs[s];n&&n.w>=t.width&&n.h>=t.height||(this.savingLottiePreview[i]=!0,t.toBlob(n=>{const a={url:URL.createObjectURL(n),w:t.width,h:t.height};e.stickerCachedThumbs[s]=a,delete this.savingLottiePreview[i]}))}saveDocFile(e,t){const s=this.downloadDoc(e,t);return s.then(()=>{const t=st.getCacheContext(e);st.createDownloadAnchor(t.url,e.file_name)}),s}};j.a.appDocsManager=Jt;var es=Jt,ts=s(23),ss=s(87);class is{constructor(){this.tempNum=0}generateMessageId(e,t=!1){const s=is.MESSAGE_ID_OFFSET,i=t?++this.tempNum:0;return e>=s?t?e+(i&is.MESSAGE_ID_INCREMENT-1):e:s+(e*is.MESSAGE_ID_INCREMENT+(i&is.MESSAGE_ID_INCREMENT-1))}getServerMessageId(e){return this.clearMessageId(e,!0)}clearMessageId(e,t){const s=is.MESSAGE_ID_OFFSET;if(e<s)return e;const i=is.MESSAGE_ID_INCREMENT-1,n=e&i;return n!==i&&(e-=n+1),t?(e-s)/is.MESSAGE_ID_INCREMENT:e}incrementMessageId(e,t){return this.generateMessageId(this.getServerMessageId(e)+t)}}is.MESSAGE_ID_INCREMENT=65536,is.MESSAGE_ID_OFFSET=4294967295;const ns=new is;j.a&&(j.a.appMessagesIdsManager=ns);var as=ns,os=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};const rs=new class{constructor(){this.drafts={},this.getAllDraftPromise=null,ss.a.get("drafts").then(e=>{this.drafts=e||{}}),H.default.addMultipleEventsListeners({updateDraftMessage:e=>{const t=Te.getPeerId(e.peer);this.saveDraft(t,e.threadId,e.draft,{notify:!0})}})}getKey(e,t){return e+(t?"_"+t:"")}getDraft(e,t){return this.drafts[this.getKey(e,t)]}addMissedDialogs(){return this.getAllDrafts().then(()=>{for(const e in this.drafts){if(-1!==e.indexOf("_"))continue;const t=e.toPeerId();js.getDialogOnly(t)||js.reloadConversation(t)}})}getAllDrafts(){return this.getAllDraftPromise||(this.getAllDraftPromise=F.a.invokeApi("messages.getAllDrafts").then(e=>{(Ie.updatesState.syncLoading||Promise.resolve()).then(()=>{Ie.processUpdateMessage(e)})}))}saveDraft(e,t,s,i={}){const n=this.processApiDraft(s),a=this.getKey(e,t);return n?this.drafts[a]=n:delete this.drafts[a],ss.a.set({drafts:this.drafts}),i.notify&&H.default.dispatchEvent("draft_updated",{peerId:e,threadId:t,draft:n,force:i.force}),n}draftsAreEqual(e,t){if(typeof e!=typeof t)return!1;if(!Object(ts.b)(e))return!0;if(e._!==t._)return!1;if("draftMessage"===e._&&t._===e._){if(e.reply_to_msg_id!==t.reply_to_msg_id)return!1;if(!Object(m.b)(e.entities,t.entities))return!1;if(e.message!==t.message)return!1;if(e.pFlags.no_webpage!==t.pFlags.no_webpage)return!1}return!0}isEmptyDraft(e){return!e||"draftMessageEmpty"===e._||!(e.reply_to_msg_id>0)&&!e.message.length}processApiDraft(e){if(!e||"draftMessage"!==e._)return;const t=N.b.parseEntities(e.message),s=e.entities||[],i=N.b.mergeEntities(s.slice(),t);return e.rMessage=Object(Yt.a)(N.b.wrapDraftText(e.message,{entities:i})),e.reply_to_msg_id&&(e.reply_to_msg_id=as.generateMessageId(e.reply_to_msg_id)),e}syncDraft(e,t,s,i=!0,n=!1){return os(this,void 0,void 0,(function*(){const a=this.getDraft(e,t);if(this.draftsAreEqual(a,s))return!0;let o,r={peer:Te.getInputPeerById(e),message:""};if(this.isEmptyDraft(s))o={_:"draftMessageEmpty"};else{let e=s.message,t=s.entities;s.reply_to_msg_id&&(r.reply_to_msg_id=as.getServerMessageId(s.reply_to_msg_id)),(null==t?void 0:t.length)&&(r.entities=js.getInputEntities(t)),s.pFlags.no_webpage&&(r.no_webpage=s.pFlags.no_webpage),r.message=e}const l=o||s;return l.date=Object(S.f)(!0)+U.a.serverTimeOffset,this.saveDraft(e,t,l,{notify:!0,force:n}),!(i&&!t)||F.a.invokeApi("messages.saveDraft",r)}))}clearAllDrafts(){return F.a.invokeApi("messages.clearAllDrafts").then(e=>{if(e)for(const e in this.drafts){const[t,s]=e.split("_");H.default.dispatchEvent("draft_updated",{peerId:t.toPeerId(),threadId:s?+s:void 0,draft:void 0})}})}clearDraft(e,t){t?this.syncDraft(e,t):this.saveDraft(e,t,null,{notify:!0,force:!0})}setDraft(e,t,s,i){const n={_:"draftMessage",date:Date.now()/1e3|0,message:s,pFlags:{},entities:i};t?this.syncDraft(e,t,n,!1,!0):this.saveDraft(e,t,n,{notify:!0,force:!0})}};j.a.appDraftsManager=rs;var ls=rs,ds=s(162);const cs=new Map,hs=new Set,us='Roboto, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif';let ps;const gs=()=>{cancelAnimationFrame(ps),ps=window.requestAnimationFrame(ms)},ms=()=>{hs.forEach(fs),hs.clear()};window.addEventListener("resize",()=>{for(const[e]of cs)hs.add(e);gs()},{capture:!0,passive:!0});const fs=e=>{let t=cs.get(e);const s=!t;let{text:i,textLength:n,from:a,multiplier:o,font:r,textWidth:l,elementWidth:d}=t||{};s&&(i=e.textContent,n=i.length,a=50,o=a>0&&a/100,r=`${e.dataset.fontWeight||400} 16px ${us}`,l=bs(i,r),d=e.getBoundingClientRect().width,t={text:i,textLength:n,from:a,multiplier:o,font:r,textWidth:l,elementWidth:d},cs.set(e,t));const c=e.getBoundingClientRect().width,h=s||d!==c;if(!s&&h&&(t.elementWidth=d=c),h)if(l>d){e.setAttribute("title",i);let s=i,n=d;for(;s.length>3;){let t=s.length;const i=o&&Object(ds.a)(o*t<<0,1,t-2)||Math.max(t+a-1,1),l=s.substr(0,i).replace(/\s*$/,""),c=s.substr(i+1).replace(/^\s*/,"");if(s=l+c,n=bs(s+"â€¦",r),n<d){e.textContent=l+"â€¦"+c;break}}t.elementWidth=e.getBoundingClientRect().width}else e.removeAttribute("title")};let vs;function bs(e,t){if(!vs){const e=document.createElement("canvas");vs=e.getContext("2d"),vs.font=t}return vs.measureText(e).width}class ys extends HTMLElement{constructor(){super()}connectedCallback(){cs.set(this,null),hs.add(this),gs()}disconnectedCallback(){cs.delete(this)}}customElements.define("middle-ellipsis-element",ys);var ws=s(125),Ss=s(182),Is=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};const Ms=new class{constructor(){this.notificationsShown={},this.notificationIndex=0,this.notificationsCount=0,this.soundsPlayed={},this.vibrateSupport=!!navigator.vibrate,this.peerSettings={notifyPeer:{},notifyUsers:null,notifyChats:null,notifyBroadcasts:null},this.faviconEl=document.head.querySelector('link[rel="icon"]'),this.titleBackup=document.title,this.titleChanged=!1,this.stopped=!1,this.settings={},this.pushInited=!1,this.updateLocalSettings=()=>{Promise.all(["notify_nodesktop","notify_volume","notify_novibrate","notify_nopreview","notify_nopush"].map(e=>ss.a.get(e))).then(e=>{if(this.settings.nodesktop=e[0],this.settings.volume=void 0===e[1]?.5:e[1],this.settings.novibrate=e[2],this.settings.nopreview=e[3],this.settings.nopush=e[4],this.pushInited){const e=!this.settings.nopush&&!this.settings.nodesktop&&ws.default.isAvailable||!1;e!==(!1!==this.registeredDevice)&&(e?ws.default.subscribe():ws.default.unsubscribe())}ws.default.setSettings(this.settings)}),ve.default.getState().then(e=>{this.settings.nosound=!e.settings.notifications.sound})},this.updateNotifySettingsByType=(e,t)=>Is(this,void 0,void 0,(function*(){const s=Object(A.b)(e._);let i=yield ee.a.get(s);const n=Object.assign(Object.assign(Object.assign({},i),t),{_:"peerNotifySettings"});return yield ee.a.set({[s]:n}),Ie.processLocalUpdate({_:"updateNotifySettings",peer:Object.assign(Object.assign({},e),{_:Object(A.b)(e._)}),notify_settings:Object.assign(Object.assign({},t),{_:"peerNotifySettings"})}),n})),this.getNotifySettingsByType=e=>Is(this,void 0,void 0,(function*(){const t=Object(A.b)(e._),s=yield ee.a.get(t),i=s||(yield this.updateNotifySettingsByType(e,{_:"inputPeerNotifySettings",show_previews:!0,silent:!1,mute_until:0}));return this.savePeerSettings({key:t,settings:i}),i})),this.requestPermission=()=>{Notification.requestPermission(),window.removeEventListener("click",this.requestPermission)},navigator.vibrate=navigator.vibrate||navigator.mozVibrate||navigator.webkitVibrate,this.notificationsUiSupport="Notification"in window||"mozNotification"in navigator,this.topMessagesDeferred=Object(w.a)(),this.notifySoundEl=document.createElement("div"),this.notifySoundEl.id="notify-sound",document.body.append(this.notifySoundEl),H.default.addEventListener("instance_deactivated",()=>{this.stop()}),H.default.addEventListener("instance_activated",()=>{this.stopped&&this.start()}),H.default.addEventListener("idle",e=>{this.stopped||(e||this.clear(),this.toggleToggler())}),H.default.addMultipleEventsListeners({updateNotifySettings:e=>{const t="notifyPeer"===e.peer._&&Te.getPeerId(e.peer.peer),s="notifyPeer"!==e.peer._?e.peer._:void 0;this.savePeerSettings({key:s,peerId:t,settings:e.notify_settings}),H.default.dispatchEvent("notify_settings",e)}}),H.default.addEventListener("push_init",e=>{this.pushInited=!0,this.settings.nodesktop||this.settings.nopush?this.unregisterDevice(e):e?this.registerDevice(e):ws.default.subscribe()}),H.default.addEventListener("push_subscribe",e=>{this.registerDevice(e)}),H.default.addEventListener("push_unsubscribe",e=>{this.unregisterDevice(e)}),H.default.addEventListener("dialogs_multiupdate",()=>{this.topMessagesDeferred.resolve()},{once:!0}),H.default.addEventListener("push_notification_click",e=>{if("push_settings"===e.action)return;if("mute1d"===e.action)return void F.a.invokeApi("account.updateDeviceLocked",{period:86400}).then(()=>{});const t=e.custom&&e.custom.peerId.toPeerId();console.log("click",e,t),t&&this.topMessagesDeferred.then(()=>{e.custom.channel_id&&!Pe.hasChat(e.custom.channel_id)||t.isUser()&&!ye.hasUser(t)||H.default.dispatchEvent("history_focus",{peerId:t,mid:+e.custom.msg_id})})})}toggleToggler(e=H.default.idle.isIDLE){if(C.IS_MOBILE)return;const t=()=>{this.titleChanged=!1,document.title=this.titleBackup,this.setFavicon()};window.clearInterval(this.titleInterval),this.titleInterval=0,e?this.titleInterval=window.setInterval(()=>{const e=this.notificationsCount;if(e)if(this.titleChanged)t();else{this.titleChanged=!0,document.title=O.default.format("Notifications.Count",!0,[e]);const t=document.createElement("canvas");t.width=32*window.devicePixelRatio,t.height=t.width;const s=t.getContext("2d");s.beginPath(),s.arc(t.width/2,t.height/2,t.width/2,0,2*Math.PI,!1),s.fillStyle="#ff8100",s.fill();let i=24,n=""+e;e<10?i=22:e<100?i=20:(n="99+",i=16),i*=window.devicePixelRatio,s.font=`700 ${i}px ${us}`,s.textBaseline="middle",s.textAlign="center",s.fillStyle="white",s.fillText(n,t.width/2,.5625*t.height),this.setFavicon(t.toDataURL())}else this.toggleToggler(!1)},1e3):t()}getLocalSettings(){return this.settings}getNotifySettings(e){let t,s=Object(A.b)(e._),i=this.peerSettings[s];return"inputNotifyPeer"!==e._&&(i instanceof Promise||null===i)?this.getNotifySettingsByType(e):("inputNotifyPeer"===e._&&(t=s=Te.getPeerId(e.peer),i=i[s]),i||void 0)}getNotifyPeerTypeSettings(){if(this.getNotifyPeerTypePromise)return this.getNotifyPeerTypePromise;const e=["inputNotifyBroadcasts","inputNotifyUsers","inputNotifyChats"].map(e=>this.getNotifySettings({_:e}));return this.getNotifyPeerTypePromise=Promise.all(e)}updateNotifySettings(e,t){return F.a.invokeApi("account.updateNotifySettings",{peer:e,settings:t}).then(s=>{s&&Ie.processLocalUpdate({_:"updateNotifySettings",peer:Object.assign(Object.assign({},e),{_:Object(A.b)(e._)}),notify_settings:Object.assign(Object.assign({},t),{_:"peerNotifySettings"})})})}getNotifyExceptions(){F.a.invokeApi("account.getNotifyExceptions",{compare_sound:!0}).then(e=>{Ie.processUpdateMessage(e)})}getContactSignUpNotification(){return this.notifyContactsSignUp?this.notifyContactsSignUp:this.notifyContactsSignUp=F.a.invokeApi("account.getContactSignUpNotification")}setContactSignUpNotification(e){F.a.invokeApi("account.setContactSignUpNotification",{silent:e}).then(t=>{this.notifyContactsSignUp=Promise.resolve(!e)})}setFavicon(e="assets/img/favicon.ico"){if(this.prevFavicon===e)return;const t=this.faviconEl.cloneNode();t.href=e,this.faviconEl.parentNode.replaceChild(t,this.faviconEl),this.faviconEl=t,this.prevFavicon=e}savePeerSettings({key:e,peerId:t,settings:s}){let i;t&&(e=t,i=this.peerSettings.notifyPeer),(i||this.peerSettings)[e]=s,t||H.default.dispatchEvent("notify_peer_type_settings",{key:e,settings:s})}isMuted(e){return"peerNotifySettings"===e._&&(1e3*e.mute_until>Object(S.f)()||e.silent)}getPeerMuted(e){const t=this.getNotifySettings({_:"inputNotifyPeer",peer:Te.getInputPeerById(e)});return(t instanceof Promise?t:Promise.resolve(t)).then(e=>this.isMuted(e))}getPeerLocalSettings(e,t=!0){const s={_:"peerNotifySettings"},i=this.peerSettings.notifyPeer[e];if(!i||i instanceof Promise||Object.assign(s,i),t){const t=Te.getInputNotifyPeerById(e,!0),i=Object(A.b)(t._),n=this.peerSettings[i];if(n&&!(n instanceof Promise))for(let e in n)void 0===s[e]&&(s[e]=n[e])}return s}isPeerLocalMuted(e,t=!0){if(e===H.default.myId)return!1;const s=this.getPeerLocalSettings(e,t);return this.isMuted(s)}start(){if(this.updateLocalSettings(),H.default.addEventListener("settings_updated",this.updateLocalSettings),ws.default.start(),!this.notificationsUiSupport)return!1;"Notification"in window&&"granted"!==Notification.permission&&"denied"!==Notification.permission&&window.addEventListener("click",this.requestPermission);try{"onbeforeunload"in window&&window.addEventListener("beforeunload",this.clear)}catch(e){}}stop(){this.clear(),window.clearInterval(this.titleInterval),this.titleInterval=0,this.setFavicon(),this.stopped=!0}notify(e){if(this.stopped)return;e.image||(e.image="assets/img/logo_filled_rounded.png"),this.notificationsCount++,this.titleInterval||this.toggleToggler();const t=++this.notificationIndex,s=e.key||"k"+t;this.notificationsShown[s]=!0;const i=Object(S.f)();if(this.settings.volume>0&&!this.settings.nosound&&(this.testSound(this.settings.volume),this.soundsPlayed[e.tag]=i),!this.notificationsUiSupport||"Notification"in window&&"granted"!==Notification.permission)return!1;if(this.settings.nodesktop)return this.vibrateSupport&&!this.settings.novibrate?void navigator.vibrate([200,100,200]):void 0;let n;if("Notification"in window){try{if(e.tag)for(let t in this.notificationsShown){const s=this.notificationsShown[t];"boolean"!=typeof s&&s.tag===e.tag&&(s.hidden=!0)}n=new Notification(e.title,{icon:e.image||"",body:e.message||"",tag:e.tag||"",silent:e.silent||!1})}catch(e){return this.notificationsUiSupport=!1,void ws.default.setLocalNotificationsDisabled()}n.onclick=()=>{n.close(),Ss.a.focus(),this.clear(),e.onclick&&e.onclick()},n.onclose=()=>{n.hidden||(delete this.notificationsShown[s],this.clear())},n.show&&n.show(),this.notificationsShown[s]=n,C.IS_MOBILE||setTimeout(()=>{this.hide(s)},8e3)}}testSound(e){const t=Object(S.f)();if(this.nextSoundAt&&t<this.nextSoundAt&&this.prevSoundVolume===e)return;this.nextSoundAt=t+1e3,this.prevSoundVolume=e;const s="assets/audio/notification.mp3",i=document.createElement("audio");i.autoplay=!0,i.setAttribute("mozaudiochannel","notification"),i.volume=e,i.innerHTML=`\n      <source src="${s}" type="audio/mpeg" />\n      <embed hidden="true" autostart="true" loop="false" volume="${100*e}" src="${s}" />\n    `,this.notifySoundEl.append(i),i.addEventListener("ended",()=>{i.remove()},{once:!0})}cancel(e){const t=this.notificationsShown[e];if(t){this.notificationsCount>0&&--this.notificationsCount;try{"boolean"!=typeof t&&t.close&&(t.hidden=!0,t.close())}catch(e){}delete this.notificationsShown[e]}}hide(e){const t=this.notificationsShown[e];if(t&&"boolean"!=typeof t)try{t.close&&(t.hidden=!0,t.close())}catch(e){}}soundReset(e){delete this.soundsPlayed[e]}clear(){for(const e in this.notificationsShown){const t=this.notificationsShown[e];try{"boolean"!=typeof t&&t.close&&t.close()}catch(e){}}this.notificationsShown={},this.notificationsCount=0,ws.default.hidePushNotifications()}registerDevice(e){return!1}unregisterDevice(e){if(!this.registeredDevice)return!1;F.a.invokeApi("account.unregisterDevice",{token_type:e.tokenType,token:e.tokenValue,other_uids:[]}).then(()=>{this.registeredDevice=!1},e=>{e.handled=!0})}getVibrateSupport(){return this.vibrateSupport}};j.a.appNotificationsManager=Ms;var Cs=Ms;const Ps=new class{constructor(){this.polls={},this.results={},this.pollToMessages={},this.log=Object(i.b)("POLLS",i.a.Error),H.default.addMultipleEventsListeners({updateMessagePoll:e=>{this.log("updateMessagePoll:",e);let t=e.poll||this.polls[e.poll_id];if(!t)return;let s=e.results;const i=this.savePoll(t,s);t=i.poll,s=i.results,H.default.dispatchEvent("poll_update",{poll:t,results:s})}})}savePoll(e,t,s){s&&this.updatePollToMessage(s,!0);const i=e.id;return this.polls[i]?(e=Object.assign(this.polls[i],e),t=this.saveResults(e,t)):(this.polls[i]=e,e.chosenIndexes=[],t=this.saveResults(e,t)),{poll:e,results:t}}saveResults(e,t){var s;return this.results[e.id]?t=Object.assign(this.results[e.id],t):this.results[e.id]=t,t.pFlags.min||(e.chosenIndexes.length=0,(null===(s=null==t?void 0:t.results)||void 0===s?void 0:s.length)&&t.results.forEach((t,s)=>{var i;(null===(i=t.pFlags)||void 0===i?void 0:i.chosen)&&e.chosenIndexes.push(s)})),t}getPoll(e){return{poll:this.polls[e],results:this.results[e]}}getInputMediaPoll(e,t,s,i){return s?(i||(i=[]),s=N.a.parseMarkdown(s,i)):s=void 0,{_:"inputMediaPoll",poll:e,correct_answers:t,solution:s,solution_entities:s?i:void 0}}updatePollToMessage(e,t){const{id:s}=e.media.poll;let i=this.pollToMessages[s];if(!t&&!i)return;i||(i=this.pollToMessages[s]=new Set);const n=e.peerId+"_"+e.mid;t?i.add(n):i.delete(n),t||i.size||(delete this.polls[s],delete this.results[s],delete this.pollToMessages[s])}sendVote(e,t){const s=e.media.poll,i=t.map(e=>s.answers[e].option),n=e.mid,a=e.peerId,o=Te.getInputPeerById(a);return e.pFlags.is_outgoing?js.invokeAfterMessageIsSent(n,"sendVote",e=>(this.log("invoke sendVote callback"),this.sendVote(e,t))):F.a.invokeApi("messages.sendVote",{peer:o,msg_id:as.getServerMessageId(e.mid),options:i}).then(e=>{this.log("sendVote updates:",e),Ie.processUpdateMessage(e)})}getResults(e){const t=Te.getInputPeerById(e.peerId);return F.a.invokeApi("messages.getPollResults",{peer:t,msg_id:as.getServerMessageId(e.mid)}).then(e=>{Ie.processUpdateMessage(e),this.log("getResults updates:",e)})}getVotes(e,t,s,i=20){return F.a.invokeApi("messages.getPollVotes",{peer:Te.getInputPeerById(e.peerId),id:as.getServerMessageId(e.mid),option:t,offset:s,limit:i}).then(e=>(this.log("getPollVotes messages:",e),ye.saveApiUsers(e.users),e))}stopPoll(e){const t=e.media.poll;if(t.pFlags.closed)return Promise.resolve();const s=Object(m.a)(t);return s.pFlags.closed=!0,js.editMessage(e,void 0,{newMedia:this.getInputMediaPoll(s)}).then(()=>{},e=>{this.log.error("stopPoll error:",e)})}};j.a.appPollsManager=Ps;var Ls=Ps;function Es(e,t){return e instanceof Promise?e.then(t):t(e)}var _s=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};const ks=new class{constructor(){this.usersFull={},this.chatsFull={},this.fullPromises={},this.deleteFirstProfilePhoto=()=>{F.a.invokeApi("photos.updateProfilePhoto",{id:{_:"inputPhotoEmpty"}}).then(()=>this.getProfile(H.default.myId,!0))},this.deleteProfilePhoto=e=>_s(this,void 0,void 0,(function*(){const t=ye.getSelf().photo;e===String(t.photo_id)?this.deleteFirstProfilePhoto():this.deletePhotos([e])})),this.onUpdateUserTyping=e=>{var t;const s=e.user_id?e.user_id.toPeerId():Te.getPeerId(e.from_id);if(H.default.myId===s||"speakingInGroupCallAction"===e.action._)return;const i=Te.getPeerId(e),n=null!==(t=this.typingsInPeer[i])&&void 0!==t?t:this.typingsInPeer[i]=[];let a=n.find(e=>e.userId===s);const o=()=>{delete a.timeout;const e=n.indexOf(a);-1!==e&&n.splice(e,1),H.default.dispatchEvent("peer_typings",{peerId:i,typings:n}),n.length||delete this.typingsInPeer[i]};if(a&&void 0!==a.timeout&&clearTimeout(a.timeout),"sendMessageCancelAction"===e.action._){if(!a)return;return void o()}a||(a={userId:s},n.push(a)),a.action=e.action;const r=ye.hasUser(s);r?ye.forceUserOnline(s):"updateChatUserTyping"===e._&&e.chat_id&&Pe.hasChat(e.chat_id)&&!Pe.isChannel(e.chat_id)&&ks.getChatFull(e.chat_id).then(()=>{void 0!==a.timeout&&ye.hasUser(s)&&H.default.dispatchEvent("peer_typings",{peerId:i,typings:n})}),a.timeout=window.setTimeout(o,6e3),r&&H.default.dispatchEvent("peer_typings",{peerId:i,typings:n})},this.onUpdatePeerBlocked=e=>{const t=Te.getPeerId(e.peer_id);if(Te.isUser(t)){const s=this.usersFull[t.toUserId()];s&&(e.blocked?s.pFlags.blocked=!0:delete s.pFlags.blocked)}H.default.dispatchEvent("peer_block",{peerId:t,blocked:e.blocked})},H.default.addMultipleEventsListeners({updateChatParticipants:e=>{const t=e.participants;if("chatParticipants"===t._){const e=t.chat_id,s=this.chatsFull[e];void 0!==s&&(s.participants=t,H.default.dispatchEvent("chat_full_update",e))}},updateChatParticipantAdd:e=>{const t=this.chatsFull[e.chat_id];if(void 0!==t){const s=t.participants,i=s.participants||[];for(let t=0,s=i.length;t<s;t++)if(i[t].user_id===e.user_id)return;i.push({_:"chatParticipant",user_id:e.user_id,inviter_id:e.inviter_id,date:Object(S.f)(!0)}),s.version=e.version,H.default.dispatchEvent("chat_full_update",e.chat_id)}},updateChatParticipantDelete:e=>{const t=this.chatsFull[e.chat_id];if(void 0!==t){const s=t.participants,i=s.participants||[];for(let t=0,n=i.length;t<n;t++)if(i[t].user_id===e.user_id)return i.splice(t,1),s.version=e.version,void H.default.dispatchEvent("chat_full_update",e.chat_id)}},updateUserTyping:this.onUpdateUserTyping,updateChatUserTyping:this.onUpdateUserTyping,updateChannelUserTyping:this.onUpdateUserTyping,updatePeerBlocked:this.onUpdatePeerBlocked}),H.default.addEventListener("chat_update",e=>{var t;const s=this.chatsFull[e],i=Pe.getChat(e);if(!i.photo||!s)return;const n="chatPhotoEmpty"===i.photo._;if(s.chat_photo&&n!==("photoEmpty"===s.chat_photo._))return delete this.chatsFull[e],void H.default.dispatchEvent("chat_full_update",e);if(n)return;const a=i.photo.photo_id;(null===(t=s.chat_photo)||void 0===t?void 0:t.id)!==a&&(delete this.chatsFull[e],H.default.dispatchEvent("chat_full_update",e))}),H.default.addEventListener("invalidate_participants",e=>{this.invalidateChannelParticipants(e)}),this.typingsInPeer={}}getProfile(e,t){if(this.usersFull[e]&&!t)return Promise.resolve(this.usersFull[e]);const s=e.toPeerId(!1);return this.fullPromises[s]?this.fullPromises[s]:this.fullPromises[s]=F.a.invokeApi("users.getFullUser",{id:ye.getUserInput(e)}).then(t=>{const i=t.user;return ye.saveApiUser(i,!0),t.profile_photo&&(t.profile_photo=Dt.savePhoto(t.profile_photo,{type:"profilePhoto",peerId:s})),void 0!==t.about&&(t.rAbout=Object(Yt.a)(N.a.wrapRichText(t.about,{noLinebreaks:!0}))),Cs.savePeerSettings({peerId:s,settings:t.notify_settings}),delete this.fullPromises[s],this.usersFull[e]=t})}getProfileByPeerId(e,t){return Te.isAnyChat(e)?this.getChatFull(e.toChatId(),t):this.getProfile(e.toUserId(),t)}getCachedFullChat(e){return this.chatsFull[e]}getFullPhoto(e){return this.getProfileByPeerId(e).then(e=>{switch(e._){case"userFull":return e.profile_photo;case"channelFull":case"chatFull":return e.chat_photo}})}getChatFull(e,t){if(Pe.isChannel(e))return this.getChannelFull(e,t);const s=this.chatsFull[e];if(s&&!t){const t=Pe.getChat(e);if(t.version===s.participants.version||t.pFlags.left)return Promise.resolve(s)}const i=e.toPeerId(!0);return void 0!==this.fullPromises[i]?this.fullPromises[i]:this.fullPromises[i]=F.a.invokeApi("messages.getFullChat",{chat_id:e}).then(t=>{Pe.saveApiChats(t.chats,!0),ye.saveApiUsers(t.users);const s=t.full_chat;return s&&s.chat_photo&&s.chat_photo.id&&(s.chat_photo=Dt.savePhoto(s.chat_photo,{type:"profilePhoto",peerId:i})),Cs.savePeerSettings({peerId:i,settings:s.notify_settings}),delete this.fullPromises[i],this.chatsFull[e]=s,H.default.dispatchEvent("chat_full_update",e),s})}getChatInviteLink(e,t){return this.getChatFull(e).then(s=>{if(!t&&s.exported_invite&&"chatInviteExportedLayer122"==s.exported_invite._)return s.exported_invite.link;const i=Pe.getChannelInput(e.toChatId());return F.a.invokeApi("channels.inviteToChannelLayer84",{channel:i}).then(e=>e.link)})}filterParticipantsByQuery(e,t){const s=ye.createSearchIndex();e.forEach(e=>{const t=Pe.getParticipantPeerId(e);s.indexObject(t,ye.getUserSearchText(t))});const i=s.search(t);return e.filter(e=>{const t=Pe.getParticipantPeerId(e);return i.has(t)})}getParticipants(e,t={_:"channelParticipantsRecent"},s=200,i=0){return Pe.isChannel(e)?this.getChannelParticipants(e,t,s,i):Es(this.getChatFull(e),e=>{const s=e.participants;if("chatParticipants"!==s._)throw new Error("CHAT_PRIVATE");return"channelParticipantsSearch"===t._&&t.q.trim()?Object.assign(Object.assign({},s),{participants:this.filterParticipantsByQuery(s.participants,t.q)}):s})}getParticipant(e,t){return _s(this,void 0,void 0,(function*(){return Pe.isChannel(e)?this.getChannelParticipant(e,t):this.getParticipants(e).then(e=>{const s=e.participants.find(e=>{if(Pe.getParticipantPeerId(e)===t)return e});if(!s)throw new Error("USER_NOT_PARTICIPANT");return s})}))}getChannelParticipants(e,t={_:"channelParticipantsRecent"},s=200,i=0){if("channelParticipantsRecent"===t._){const t=Pe.getChat(e);if(t&&t.pFlags&&(t.pFlags.kicked||t.pFlags.broadcast&&!t.pFlags.creator&&!t.admin_rights))return Promise.reject()}return"channelParticipantsSearch"===t._&&t.q.trim()?this.getChannelParticipants(e,{_:"channelParticipantsRecent"},200,0).then(e=>{const s=this.filterParticipantsByQuery(e.participants,t.q);return Object.assign(Object.assign({},e),{participants:s,count:s.length})}):F.a.invokeApiCacheable("channels.getParticipants",{channel:Pe.getChannelInput(e),filter:t,offset:i,limit:s,hash:"0"},{cacheSeconds:60}).then(e=>(ye.saveApiUsers(e.users),e))}getChannelParticipant(e,t){return F.a.invokeApiSingle("channels.getParticipant",{channel:Pe.getChannelInput(e),participant:Te.getInputPeerById(t)}).then(e=>(ye.saveApiUsers(e.users),e.participant))}getChannelFull(e,t){if(void 0!==this.chatsFull[e]&&!t)return Promise.resolve(this.chatsFull[e]);const s=e.toPeerId(!0);return void 0!==this.fullPromises[s]?this.fullPromises[s]:this.fullPromises[s]=F.a.invokeApi("channels.getFullChannel",{channel:Pe.getChannelInput(e)}).then(t=>{Pe.saveApiChats(t.chats,!0),ye.saveApiUsers(t.users);const i=t.full_chat;return i&&i.chat_photo.id&&(i.chat_photo=Dt.savePhoto(i.chat_photo,{type:"profilePhoto",peerId:s})),Cs.savePeerSettings({peerId:s,settings:i.notify_settings}),delete this.fullPromises[s],this.chatsFull[e]=i,H.default.dispatchEvent("chat_full_update",e),i},t=>{switch(t.type){case"CHANNEL_PRIVATE":let t=Pe.getChat(e);t={_:"channelForbidden",access_hash:t.access_hash,title:t.title},Ie.processUpdateMessage({_:"updates",updates:[{_:"updateChannel",channel_id:e}],chats:[t],users:[]})}throw t})}getMentions(e,t,s){let i;return i=Pe.isChannel(e)?this.getChannelParticipants(e,{_:"channelParticipantsMentions",q:t,top_msg_id:as.getServerMessageId(s)},50,0).then(e=>e.participants.map(e=>Pe.getParticipantPeerId(e))):e?this.getChatFull(e).then(e=>e.participants.participants.map(e=>e.user_id.toPeerId())):Promise.resolve([]),Promise.all([ye.getTopPeers("bots_inline").catch(()=>[]),i]).then(e=>(e=>{"@"===t.charAt(0)&&(t=t.slice(1));const s=new $({ignoreCase:!0}),i=new Map;e.forEach(e=>{s.indexObject(e.id,ye.getUserSearchText(e.id)),i.set(e.id,e.rating)});const n=Array.from(s.search(t));return n.sort((e,t)=>i.get(t)-i.get(e)),n})(e[0].concat(e[1].map(e=>({id:e,rating:0})))))}invalidateChannelParticipants(e){delete this.chatsFull[e],delete this.fullPromises[e.toPeerId(!0)],F.a.clearCache("channels.getParticipants",t=>t.channel.channel_id===e),H.default.dispatchEvent("chat_full_update",e)}updateProfile(e,t,s){return F.a.invokeApi("account.updateProfile",{first_name:e,last_name:t,about:s}).then(e=>(ye.saveApiUser(e),this.getProfile(H.default.myId,!0)))}uploadProfilePhoto(e){return F.a.invokeApi("photos.uploadProfilePhoto",{file:e},{fileUpload:!0}).then(()=>this.getProfile(H.default.myId,!0))}deletePhotos(e){const t=e.map(e=>{const t=Dt.getPhoto(e);return Dt.getInput(t)});return F.a.invokeApi("photos.deletePhotos",{id:t}).then(e=>{Dt.filteredPhotos.push(t[0].id),H.default.dispatchEvent("avatar_update",H.default.myId)})}getChatMembersString(e){var t,s;const i=Pe.getChat(e);if("chatForbidden"===i._)return Object(O.i18n)("YouWereKicked");const n=this.chatsFull[e];let a;a=n?"channelFull"===n._?n.participants_count:null===(t=n.participants.participants)||void 0===t?void 0:t.length:i.participants_count||(null===(s=i.participants)||void 0===s?void 0:s.participants.length);a=a||1;let o=Pe.isBroadcast(e)?"Peer.Status.Subscribers":"Peer.Status.Member";return Object(O.i18n)(o,[Object(ds.e)(a)])}verifyParticipantForOnlineCount(e){const t=ye.getUser(e.user_id);return!(!t||!t.status||"userStatusOnline"!==t.status._)}reduceParticipantsForOnlineCount(e){return e.reduce((e,t)=>e+ +this.verifyParticipantForOnlineCount(t),0)}getOnlines(e){var t;return _s(this,void 0,void 0,(function*(){if(Pe.isBroadcast(e))return 1;const s=yield this.getChatFull(e);if(Pe.isMegagroup(e)){if(s.participants_count<=100){const t=yield this.getChannelParticipants(e,{_:"channelParticipantsRecent"},100);return this.reduceParticipantsForOnlineCount(t.participants)}const i=yield F.a.invokeApiCacheable("messages.getOnlines",{peer:Pe.getChannelInputPeer(e)},{cacheSeconds:60});return null!==(t=i.onlines)&&void 0!==t?t:1}const i=s.participants;return(null==i?void 0:i.participants)?this.reduceParticipantsForOnlineCount(i.participants):1}))}getPeerTypings(e){return this.typingsInPeer[e]}};j.a.appProfileManager=ks;var Ts=ks;const xs=new Set(["photo","video","gif","document"]);const As=new class{constructor(){this.webpages={},this.pendingWebPages={},H.default.addMultipleEventsListeners({updateWebPage:e=>{this.saveWebPage(e.webpage)}})}saveWebPage(e,t,s){var i,n;if("webPageNotModified"===e._)return;const{id:a}=e,o=this.webpages[a],r=o&&o._===e._&&o.hash==o.hash;if("webPage"===e._){"photo"===(null===(i=e.photo)||void 0===i?void 0:i._)?e.photo=Dt.savePhoto(e.photo,s):delete e.photo,"document"===(null===(n=e.document)||void 0===n?void 0:n._)?e.document=es.saveDoc(e.document,s):("document"===e.type&&delete e.type,delete e.document);const t=e.site_name;let a=e.title||e.author||t||"";t&&a===t&&delete e.site_name,a=Object(A.f)(a,80,100),e.rTitle=Object(Yt.a)(N.a.wrapRichText(a,{noLinks:!0,noLinebreaks:!0}));let o="";if("GitHub"===t){const t=e.url.match(/(https?:\/\/github\.com\/[^\/]+\/[^\/]+)/);t&&(o=t[0]+"/issues/{1}")}const r=Object(A.f)(e.description||"",150,180);e.rDescription=Object(Yt.a)(N.a.wrapRichText(r,{contextSite:t||"external",contextHashtag:o})),xs.has(e.type)||e.description||!e.photo||(e.type="photo")}let l=this.pendingWebPages[a];if(t&&(l||(l=this.pendingWebPages[a]=new Set),l.add(t)),void 0===o?this.webpages[a]=e:Object(m.i)(o,e),!t&&void 0!==l&&r){const e=[];l.forEach(t=>{const[s,i,n]=t.split("_");e.push({peerId:s.toPeerId(),mid:+i,isScheduled:!!n})}),H.default.dispatchEvent("webpage_updated",{id:a,msgs:e})}return e}getMessageKeyForPendingWebPage(e,t,s){return e+"_"+t+(s?"_s":"")}deleteWebPageFromPending(e,t){const s=e.id;if(!s)return;const i=this.pendingWebPages[s];i&&i.has(t)&&(i.delete(t),i.size||delete this.pendingWebPages[s])}getWebPage(e){return this.webpages[e]}};j.a&&(j.a.appWebPagesManager=As);var Os=As,Fs=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};const Ds=new class{constructor(){this.pendingByRandomId={},this.pendingByMessageId={},this.pendingAfterMsgs={},this.pendingTopMsgs={},this.tempFinalizeCallbacks={},this.sendSmthLazyLoadQueue=new l(10),this.needSingleMessages=new Map,this.fetchSingleMessagesPromise=null,this.maxSeenId=0,this.migratedFromTo={},this.migratedToFrom={},this.newMessagesHandleTimeout=0,this.newMessagesToHandle={},this.newDialogsToHandle={},this.newUpdatesAfterReloadToHandle={},this.notificationsHandlePromise=0,this.notificationsToHandle={},this.reloadConversationsPeers=new Map,this.log=Object(i.b)("MESSAGES",i.a.Error|i.a.Debug|i.a.Log|i.a.Warn),this.groupedTempId=0,this.typings={},this.unreadMentions={},this.goToNextMentionPromises={},this.isDialogPinned=(e,t)=>{var s;return e>1?Ds.filtersStorage.getFilter(e).pinnedPeerIds.includes(t.peerId):!!(null===(s=t.pFlags)||void 0===s?void 0:s.pinned)},this.handleNewMessages=()=>{clearTimeout(this.newMessagesHandleTimeout),this.newMessagesHandleTimeout=0,H.default.dispatchEvent("history_multiappend",this.newMessagesToHandle),this.newMessagesToHandle={}},this.handleNewDialogs=()=>{let e=0;const t=this.newDialogsToHandle;for(const s in t){const i=t[s];i?(this.dialogsStorage.pushDialog(i),Te.isChannel(s.toPeerId())||(e=Math.max(e,i.top_message||0))):(this.reloadConversation(s.toPeerId()),delete t[s])}0!==e&&this.incrementMaxSeenId(e),H.default.dispatchEvent("dialogs_multiupdate",t),this.newDialogsToHandle={}},this.handleNotifications=()=>{window.clearTimeout(this.notificationsHandlePromise),this.notificationsHandlePromise=0;for(const e in this.notificationsToHandle){const t=e.toPeerId();if(H.default.peerId===t&&!H.default.idle.isIDLE)continue;const s=this.notificationsToHandle[t];Promise.all([Cs.getNotifySettings(Te.getInputNotifyPeerById(t,!1))]).then(([e])=>{const i=s.topMessage;!Cs.isPeerLocalMuted(t,!0)&&i.pFlags.unread&&i.pFlags.unread&&this.notifyAboutMessage(i,{fwdCount:s.fwdCount,peerTypeNotifySettings:e})})}this.notificationsToHandle={}},this.onUpdateMessageId=e=>{const t=e.random_id,s=this.pendingByRandomId[t];if(s){const{peerId:i,tempId:n,threadId:a,storage:o}=s,r=as.generateMessageId(e.id),l=this.getMessageFromStorage(o,r);l.deleted?this.pendingByMessageId[r]=t:([this.getHistoryStorage(i),a?this.getHistoryStorage(i,a):void 0].filter(Boolean).forEach(e=>{e.history.delete(n)}),this.finalizePendingMessageCallbacks(o,n,l))}},this.onUpdateNewMessage=e=>{var t,s,i;const n=e.message,a=this.getMessagePeer(n),o=this.getMessagesStorage(a),r=this.getDialogOnly(a),l="updateNewDiscussionMessage"===e._;this.saveMessages([n],{storage:new Map});const d=this.getThreadKey(n),c=d?+d.split("_")[1]:void 0;if(c&&!l&&this.threadsStorage[a]&&this.threadsStorage[a][c]){const e={_:"updateNewDiscussionMessage",message:n};this.onUpdateNewMessage(e)}if(!r&&!l){let s=!0;if(a.isAnyChat()&&(s=Pe.isInChat(a.toChatId())),s){const s=null!==(t=this.newUpdatesAfterReloadToHandle[a])&&void 0!==t?t:this.newUpdatesAfterReloadToHandle[a]=new Set;if(s.has(e))return void this.log.error("here we go again",a);this.scheduleHandleNewDialogs(a),s.add(e)}}this.saveMessages([n],{storage:o}),"message"===n._&&"messageMediaLiveStream"===(null===(s=null==n?void 0:n.media)||void 0===s?void 0:s._)&&H.default.dispatchEvent("message_edit",{storage:o,peerId:a,mid:n.mid});const h=this.checkPendingMessage(n),u=this.getHistoryStorage(a,l?c:void 0);if(l||this.updateMessageRepliesIfNeeded(n),u.history.findSlice(n.mid)&&("message"!==n._||"messageMediaLiveStream"!==(null===(i=null==n?void 0:n.media)||void 0===i?void 0:i._)))return!1;const p=u.history.first;if(p.isEnd(Y.Bottom)){let e=0;for(const t=p.length;e<t&&!(n.mid>p[e]);++e);p.splice(e,0,n.mid)}else u.history.unshift(n.mid);null!==u.count&&u.count++,this.mergeReplyKeyboard(u,n)&&H.default.dispatchEvent("history_reply_markup",{peerId:a});const g=n.fromId;if(g.isUser()&&!n.pFlags.out&&n.from_id){ye.forceUserOnline(g,n.date);const e={_:"sendMessageCancelAction"};let t;t=a.isUser()?{_:"updateUserTyping",action:e,user_id:g}:Te.isChannel(a)?{_:"updateChannelUserTyping",action:e,channel_id:a.toChatId(),from_id:Te.getOutputPeer(g),top_msg_id:c?as.getServerMessageId(c):void 0}:{_:"updateChatUserTyping",action:e,chat_id:a.toChatId(),from_id:Te.getOutputPeer(g)},Ie.processLocalUpdate(t)}if(h||this.handleNewMessage(a,n.mid),l)return;const m=!n.pFlags.out&&n.pFlags.unread;if(r){if(m){const e=this.dialogsStorage.prepareDialogUnreadCountModifying(r);++r.unread_count,n.pFlags.mentioned&&(++r.unread_mentions_count,this.modifyCachedMentions(a,n.mid,!0)),e()}this.setDialogTopMessage(n,r)}if(m){const e=a;let t=this.notificationsToHandle[e];void 0===t&&(t=this.notificationsToHandle[e]={fwdCount:0,fromId:Z.b}),t.fromId!==g&&(t.fromId=g,t.fwdCount=0),n.fwd_from&&++t.fwdCount,t.topMessage=n,this.notificationsHandlePromise||(this.notificationsHandlePromise=window.setTimeout(this.handleNotifications,0))}},this.onUpdateDialogUnreadMark=e=>{const t=Te.getPeerId(e.peer.peer),s=this.getDialogOnly(t);if(s){const i=this.dialogsStorage.prepareDialogUnreadCountModifying(s);e.pFlags.unread?s.pFlags.unread_mark=!0:delete s.pFlags.unread_mark,i(),H.default.dispatchEvent("dialogs_multiupdate",{[t]:s}),this.dialogsStorage.setDialogToState(s)}else this.scheduleHandleNewDialogs(t)},this.onUpdateEditMessage=e=>{const t=e.message,s=this.getMessagePeer(t),i=as.generateMessageId(t.id),n=this.getMessagesStorage(s);if(!n.has(i))return;const a=this.getMessageFromStorage(n,i);this.saveMessages([t],{storage:n});const o=this.getMessageFromStorage(n,i);this.handleEditedMessage(a,o);const r=this.getDialogOnly(s),l=r&&r.top_message===i;if(t.clear_history)l&&H.default.dispatchEvent("dialog_flush",{peerId:s});else if(H.default.dispatchEvent("message_edit",{storage:n,peerId:s,mid:i}),l||t.grouped_id){const e={};e[s]=r,H.default.dispatchEvent("dialogs_multiupdate",e),this.dialogsStorage.setDialogToState(r)}},this.onUpdateReadHistory=e=>{const t=e.channel_id,s=as.generateMessageId(e.max_id||e.read_max_id),i=as.generateMessageId(e.top_msg_id),n=t?t.toPeerId(!0):Te.getPeerId(e.peer),a="updateReadHistoryOutbox"===e._||"updateReadChannelOutbox"===e._||"updateReadChannelDiscussionOutbox"===e._||void 0,o=this.getMessagesStorage(n),r=Object(m.e)(o,"desc"),l=this.getDialogOnly(n);let d=0,c=0,h=!1;const u=this.getHistoryStorage(n,i);if(n.isUser()&&a&&ye.forceUserOnline(n),i){const e=this.threadsToReplies[n+"_"+i];if(e){const[t,s]=e.split("_");this.updateMessage(t.toPeerId(),+s,"replies_updated")}}const p=!i&&l&&this.dialogsStorage.prepareDialogUnreadCountModifying(l);for(let e=0,t=r.length;e<t;e++){const t=r[e];if(t>s)continue;const u=o.get(t);if(u.pFlags.out===a){if(!u.pFlags.unread)break;if(i){const e=u.reply_to;if(!e||(e.reply_to_top_id||e.reply_to_msg_id)!==i)continue}u.pFlags.unread&&(delete u.pFlags.unread,h||(h=!0),u.pFlags.out||i||!l||(d=--l.unread_count,u.pFlags.mentioned&&(c=--l.unread_mentions_count,this.modifyCachedMentions(n,u.mid,!1))),Cs.cancel("msg"+t))}}if(a?u.readOutboxMaxId=s:u.readMaxId=s,!i&&l){if(a?l.read_outbox_max_id=s:l.read_inbox_max_id=s,!a){let e;d<0||!this.getReadMaxIdIfUnread(n)?e=0:d&&l.top_message>s&&(e=d),void 0!==e&&(l.unread_count=e),c<0&&(l.unread_mentions_count=0)}p&&p(),this.dialogsStorage.processDialogForFilters(l),H.default.dispatchEvent("dialog_unread",{peerId:n}),this.dialogsStorage.setDialogToState(l)}if(h&&H.default.dispatchEvent("messages_read"),!i&&t){const e=n+"_";for(const t in this.threadsToReplies)if(0===t.indexOf(e)){const[e,s]=this.threadsToReplies[t].split("_");H.default.dispatchEvent("replies_updated",this.getMessageByPeer(e.toPeerId(),+s))}}},this.onUpdateReadMessagesContents=e=>{const t=e.channel_id,s=e.messages.map(e=>as.generateMessageId(e)),i=t?t.toPeerId(!0):this.getMessageById(s[0]).peerId;for(let e=0,t=s.length;e<t;++e){const t=s[e],n=this.getMessageByPeer(i,t);n.deleted?this.fixDialogUnreadMentionsIfNoMessage(i):n.pFlags.media_unread&&(delete n.pFlags.media_unread,this.setDialogToStateIfMessageIsTop(n),!n.pFlags.out&&n.pFlags.mentioned&&this.modifyCachedMentions(i,t,!1))}H.default.dispatchEvent("messages_media_read",{peerId:i,mids:s})},this.onUpdateChannelAvailableMessages=e=>{const t=e.channel_id.toPeerId(!0),s=this.getHistoryStorage(t).history.slice,i=as.generateMessageId(e.available_min_id),n=s.filter(e=>e<=i);e.messages=n,this.onUpdateDeleteMessages(e)},this.onUpdateDeleteMessages=e=>{const t=e.channel_id,s=e.messages.map(e=>as.generateMessageId(e)),i=t?t.toPeerId(!0):this.getMessageById(s[0]).peerId;if(!i)return;F.a.clearCache("messages.getSearchCounters",e=>Te.getPeerId(e.peer)===i);const n=new Set;for(const e of s){const t=this.getMessageByPeer(i,e),s=this.getThreadKey(t);s&&this.threadsStorage[i]&&this.threadsStorage[i][+s.split("_")[1]]&&n.add(s)}const a=this.handleDeletedMessages(i,this.getMessagesStorage(i),s),o=Array.from(n).map(e=>{const[t,s]=e.split("_");return this.getHistoryStorage(t.toPeerId(),+s)}),r=this.getHistoryStorage(i);[r].concat(o).forEach(e=>{for(const t of a.msgs)e.history.delete(t);a.count&&e.count&&(e.count=Math.max(0,e.count-a.count))}),H.default.dispatchEvent("history_delete",{peerId:i,msgs:a.msgs});const l=this.getDialogOnly(i);if(l){const e=a.unreadMentions||a.unread,t=e&&this.dialogsStorage.prepareDialogUnreadCountModifying(l);if(a.unreadMentions&&(l.unread_mentions_count=Math.max(0,l.unread_mentions_count-a.unreadMentions)),a.unread&&(l.unread_count=Math.max(0,l.unread_count-a.unread)),e&&(t(),H.default.dispatchEvent("dialog_unread",{peerId:i})),a.msgs.has(l.top_message)){const e=r.history.first;if(e.isEnd(Y.Bottom)&&e.length){const t=e[0],s=this.getMessageByPeer(i,t);this.setDialogTopMessage(s,l)}else this.reloadConversation(i)}}},this.onUpdateChannel=e=>{const t=e.channel_id,s=t.toPeerId(!0),i=Pe.getChat(t),n=Pe.isInChat(t);(!!i.username||!i.pFlags.left)!==(void 0!==this.historiesStorage[s])&&(delete this.historiesStorage[s],H.default.dispatchEvent("history_forbidden",s));!!this.getDialogOnly(s)!==n&&(n?this.reloadConversation(s):this.dialogsStorage.dropDialogOnDeletion(s))},this.onUpdateChannelReload=e=>{const t=e.channel_id.toPeerId(!0);this.dialogsStorage.dropDialog(t),delete this.historiesStorage[t],this.reloadConversation(t).then(()=>{H.default.dispatchEvent("history_reload",t)})},this.onUpdateChannelMessageViews=e=>{const t=e.views,s=e.channel_id.toPeerId(!0),i=as.generateMessageId(e.id),n=this.getMessageByPeer(s,i);!n.deleted&&void 0!==n.views&&n.views<t&&(n.views=t,H.default.dispatchEvent("message_views",{peerId:s,mid:i,views:t}),this.setDialogToStateIfMessageIsTop(n))},this.onUpdateServiceNotification=e=>{const t=Z.d,s=t,i=this.generateTempMessageId(s),n={_:"message",id:i,from_id:Te.getOutputPeer(t),peer_id:Te.getOutputPeer(s),pFlags:{unread:!0},date:(e.inbox_date||Object(S.f)(!0))+U.a.serverTimeOffset,message:e.message,media:e.media,entities:e.entities};ye.hasUser(t)||ye.saveApiUsers([{_:"user",id:t,pFlags:{verified:!0},access_hash:"0",first_name:"Eitaa",phone:"42777"}]),this.saveMessages([n],{isOutgoing:!0}),e.inbox_date&&(this.pendingTopMsgs[s]=i,this.onUpdateNewMessage({_:"updateNewMessage",message:n,pts:void 0,pts_count:void 0}))},this.onUpdatePinnedMessages=e=>{const t="updatePinnedChannelMessages"===e._?e.channel_id:void 0,s=t?t.toPeerId(!0):Te.getPeerId(e.peer),i=e.messages.map(e=>as.generateMessageId(e)),n=this.getMessagesStorage(s),a=i.filter(e=>!n.has(e));(a.length?Promise.all(a.map(e=>this.wrapSingleMessage(s,e))):Promise.resolve()).finally(()=>{var t;const a=null===(t=e.pFlags)||void 0===t?void 0:t.pinned;if(a)for(const e of i){n.get(e).pFlags.pinned=!0}else for(const e of i){delete n.get(e).pFlags.pinned}delete this.pinnedMessages[s],ve.default.getState().then(e=>{delete e.hiddenPinnedMessages[s],H.default.dispatchEvent("peer_pinned_messages",{peerId:s,mids:i,pinned:a})})})},this.onUpdateNotifySettings=e=>{const{peer:t,notify_settings:s}=e;if("notifyPeer"===t._){const e=Te.getPeerId(t.peer),i=this.getDialogOnly(e);i&&(i.notify_settings=s,H.default.dispatchEvent("dialog_notify_settings",i),this.dialogsStorage.setDialogToState(i))}},this.onUpdateNewScheduledMessage=e=>{const t=e.message,s=this.getMessagePeer(t),i=this.scheduledMessagesStorage[s];if(i){const e=as.generateMessageId(t.id),n=this.getMessageFromStorage(i,e);this.saveMessages([t],{storage:i,isScheduled:!0});const a=this.getMessageFromStorage(i,e);if(n.deleted){this.checkPendingMessage(t)||H.default.dispatchEvent("scheduled_new",{peerId:s,mid:t.mid})}else this.handleEditedMessage(n,a),H.default.dispatchEvent("message_edit",{storage:i,peerId:s,mid:t.mid})}},this.onUpdateDeleteScheduledMessages=e=>{const t=Te.getPeerId(e.peer),s=this.scheduledMessagesStorage[t];if(s){const i=e.messages.map(e=>as.generateMessageId(e));this.handleDeletedMessages(t,s,i),H.default.dispatchEvent("scheduled_delete",{peerId:t,mids:i})}},this.clear(),H.default.addMultipleEventsListeners({updateMessageID:this.onUpdateMessageId,updateNewDiscussionMessage:this.onUpdateNewMessage,updateNewMessage:this.onUpdateNewMessage,updateNewChannelMessage:this.onUpdateNewMessage,updateDialogUnreadMark:this.onUpdateDialogUnreadMark,updateEditMessage:this.onUpdateEditMessage,updateEditChannelMessage:this.onUpdateEditMessage,updateReadChannelDiscussionInbox:this.onUpdateReadHistory,updateReadChannelDiscussionOutbox:this.onUpdateReadHistory,updateReadHistoryInbox:this.onUpdateReadHistory,updateReadHistoryOutbox:this.onUpdateReadHistory,updateReadChannelInbox:this.onUpdateReadHistory,updateReadChannelOutbox:this.onUpdateReadHistory,updateChannelReadMessagesContents:this.onUpdateReadMessagesContents,updateReadMessagesContents:this.onUpdateReadMessagesContents,updateChannelAvailableMessages:this.onUpdateChannelAvailableMessages,updateDeleteMessages:this.onUpdateDeleteMessages,updateDeleteChannelMessages:this.onUpdateDeleteMessages,updateChannel:this.onUpdateChannel,updateChannelReload:this.onUpdateChannelReload,updateChannelMessageViews:this.onUpdateChannelMessageViews,updateServiceNotification:this.onUpdateServiceNotification,updatePinnedMessages:this.onUpdatePinnedMessages,updatePinnedChannelMessages:this.onUpdatePinnedMessages,updateNotifySettings:this.onUpdateNotifySettings,updateNewScheduledMessage:this.onUpdateNewScheduledMessage,updateDeleteScheduledMessages:this.onUpdateDeleteScheduledMessages}),H.default.addEventListener("notify_peer_type_settings",({key:e,settings:t})=>{let s;s="notifyUsers"===e?e=>e.peerId.isUser():"notifyBroadcasts"===e?e=>e.peerId.isBroadcast():e=>Te.isAnyGroup(e.peerId),this.dialogsStorage.getFolderDialogs(0).concat(this.dialogsStorage.getFolderDialogs(1)).filter(s).forEach(e=>{H.default.dispatchEvent("dialog_notify_settings",e)})}),H.default.addEventListener("webpage_updated",({id:e,msgs:t})=>{t.forEach(({peerId:t,mid:s,isScheduled:i})=>{const n=i?this.getScheduledMessagesStorage(t):this.getMessagesStorage(t),a=this.getMessageFromStorage(n,s);a&&(a.media={_:"messageMediaWebPage",webpage:Os.getWebPage(e)},H.default.dispatchEvent("message_edit",{storage:n,peerId:t,mid:s}))})}),H.default.addEventListener("draft_updated",({peerId:e,threadId:t,draft:s})=>{if(t)return;const i=this.getDialogOnly(e);if(i){if(!t){i.draft=s;let t=!1;s||as.getServerMessageId(i.top_message)?(this.dialogsStorage.generateIndexForDialog(i),this.dialogsStorage.pushDialog(i)):(this.dialogsStorage.dropDialog(e),t=!0),H.default.dispatchEvent("dialog_draft",{peerId:e,dialog:i,drop:t,draft:s,index:i.index})}}else this.reloadConversation(e)}),H.default.addEventListener("poll_update",({poll:e})=>{const t=Ls.pollToMessages[e.id];if(t)for(const e of t){const[t,s]=e.split("_"),i=this.getMessageByPeer(t.toPeerId(),+s);this.setDialogToStateIfMessageIsTop(i)}}),ve.default.getState().then(e=>{e.maxSeenMsgId&&(this.maxSeenId=e.maxSeenMsgId)})}clear(){this.middleware?this.middleware.clean():this.middleware=Ke(),this.messagesStorageByPeerId={},this.groupedMessagesStorage={},this.scheduledMessagesStorage={},this.historiesStorage={},this.threadsStorage={},this.searchesStorage={},this.pinnedMessages={},this.threadsServiceMessagesIdsStorage={},this.threadsToReplies={},this.dialogsStorage&&this.dialogsStorage.clear(),this.filtersStorage&&this.filtersStorage.clear()}construct(){this.filtersStorage=new oe(this,Te,ye,Cs,ve.default,Ie,H.default),this.dialogsStorage=new te(this,Pe,Te,ye,ls,Cs,ve.default,Ie,U.a,as)}getInputEntities(e){const t=Object(m.a)(e);return t.forEach(e=>{"messageEntityMentionName"===e._&&(e._="inputMessageEntityMentionName",e.user_id=ye.getUserInput(e.user_id))}),t}invokeAfterMessageIsSent(e,t,s){var i,n;const a=null!==(i=this.tempFinalizeCallbacks[e])&&void 0!==i?i:this.tempFinalizeCallbacks[e]={},o=null!==(n=a[t])&&void 0!==n?n:a[t]={deferred:Object(w.a)()};return o.callback=s,o.deferred}editMessage(e,t,s={}){const{mid:i,peerId:n}=e;if(e.pFlags.is_outgoing)return this.invokeAfterMessageIsSent(i,"edit",e=>this.editMessage(e,t,s));let a=s.entities||[];t&&(t=N.a.parseMarkdown(t,a));const o=s.scheduleDate||(e.pFlags.is_scheduled?e.date:void 0);return F.a.invokeApi("messages.editMessage",{peer:Te.getInputPeerById(n),id:e.id,message:t,media:s.newMedia,entities:a.length?this.getInputEntities(a):void 0,no_webpage:s.noWebPage,schedule_date:o}).then(e=>{Ie.processUpdateMessage(e)},e=>{if(this.log.error("editMessage error:",e),!e||"MESSAGE_NOT_MODIFIED"!==e.type)return e&&"MESSAGE_EMPTY"===e.type&&(e.handled=!0),Promise.reject(e);e.handled=!0})}sendText(e,t,s={}){if(!t.trim())return;s.threadId&&!s.replyToMsgId&&(s.replyToMsgId=s.threadId);const i=H.default.config.message_length_max;if(t.length>i){const n=Object(A.g)(t,i);t=n[0],n.length>1&&delete s.webPage;for(let t=1;t<n.length;++t)setTimeout(()=>{this.sendText(e,n[t],s)},t)}e=Te.getPeerMigratedTo(e)||e;let n=s.entities||[];s.viaBotId||(t=N.a.parseMarkdown(t,n));let a=this.getInputEntities(n);a.length||(a=void 0);const o=this.generateOutgoingMessage(e,s);o.entities=n,o.message=t;const r=s.replyToMsgId?as.getServerMessageId(s.replyToMsgId):void 0,l=Te.isChannel(e);s.webPage&&(o.media={_:"messageMediaWebPage",webpage:s.webPage});const d=e=>{e?o.error=!0:delete o.error,H.default.dispatchEvent("messages_pending")};o.send=()=>{d(!1);const i={};let n;return this.pendingAfterMsgs[e]&&(i.afterMessageId=this.pendingAfterMsgs[e].messageId),n=s.viaBotId?F.a.invokeApiAfter("messages.sendInlineBotResult",{peer:Te.getInputPeerById(e),random_id:o.random_id,reply_to_msg_id:r||void 0,query_id:s.queryId,id:s.resultId,clear_draft:s.clearDraft},i):F.a.invokeApiAfter("messages.sendMessage",{no_webpage:s.noWebPage,peer:Te.getInputPeerById(e),message:t,random_id:o.random_id,reply_to_msg_id:r||void 0,entities:a,clear_draft:s.clearDraft,schedule_date:s.scheduleDate||void 0,silent:s.silent},i),this.pendingAfterMsgs[e]=i,n.then(e=>{if("updateShortSentMessage"===e._){const t=Object(m.a)(o);t.date=e.date,t.id=e.id,t.media=e.media,t.entities=e.entities,this.wrapMessageEntities(t),e.pFlags.out&&(t.pFlags.out=!0),e={_:"updates",users:[],chats:[],seq:0,date:void 0,updates:[{_:"updateMessageID",random_id:o.random_id,id:t.id},{_:s.scheduleDate?"updateNewScheduledMessage":l?"updateNewChannelMessage":"updateNewMessage",message:t,pts:e.pts,pts_count:e.pts_count}]}}else e.updates&&e.updates.forEach(e=>{"updateDraftMessage"===e._&&(e.local=!0)});Ie.processUpdateMessage(e)},()=>{d(!0)}).finally(()=>{this.pendingAfterMsgs[e]===i&&delete this.pendingAfterMsgs[e]})},this.beforeMessageSending(o,{isScheduled:!!s.scheduleDate||void 0,threadId:s.threadId,clearDraft:s.clearDraft})}sendFile(e,t,s={}){e=Te.getPeerMigratedTo(e)||e;const i=this.generateOutgoingMessage(e,s),n=s.replyToMsgId?as.getServerMessageId(s.replyToMsgId):void 0;let a,o;const r="mime_type"in t?t.mime_type:t.type,l=t instanceof File?t.name:"",d=!(t instanceof File||t instanceof Blob);let c=s.caption||"";this.log("sendFile",t,r);const h=s.entities||[];c&&(c=N.a.parseMarkdown(c,h));const u=[],p=je.has(r);let g,m,f;if(d)a="document",o="";else if(0===r.indexOf("audio/")||["video/ogg"].indexOf(r)>=0){a="audio",o="audio."+("ogg"===r.split("/")[1]?"ogg":"mp3"),f="sendMessageUploadAudioAction",s.isVoiceMessage&&(a="voice",i.pFlags.media_unread=!0);let e={_:"documentAttributeAudio",pFlags:{voice:s.isVoiceMessage},waveform:s.waveform,duration:s.duration||0};u.push(e)}else if(s.isMedia)if(p){a="photo",o="photo."+r.split("/")[1],f="sendMessageUploadPhotoAction";const e={_:"photoSize",w:s.width,h:s.height,type:"full",location:null,size:t.size};g={_:"photo",id:""+i.id,sizes:[e],w:s.width,h:s.height};const n=st.getCacheContext(g,e.type);n.downloaded=t.size,n.url=s.objectURL||"",g=Dt.savePhoto(g)}else if(Ue.has(r)){a="video",o="video.mp4",f="sendMessageUploadVideoAction";const e={_:"documentAttributeVideo",pFlags:{round_message:s.isRoundMessage,supports_streaming:!0},duration:s.duration,w:s.width,h:s.height};u.push(e),s.noSound&&t.size>10240&&t.size<10485760&&u.push({_:"documentAttributeAnimated"})}else a="document",o="document."+r.split("/")[1],f="sendMessageUploadDocumentAction";else a="document",o="document."+r.split("/")[1],f="sendMessageUploadDocumentAction";if(u.push({_:"documentAttributeFilename",file_name:l||o}),-1!==["document","video","audio","voice"].indexOf(a)&&!d){const e=[];m={_:"document",id:""+i.id,duration:s.duration,attributes:u,w:s.width,h:s.height,thumbs:e,mime_type:r,size:t.size};const n=st.getCacheContext(m);let o;if(n.downloaded=t.size,n.url=s.objectURL||"",p)u.push({_:"documentAttributeImageSize",w:s.width,h:s.height}),o={_:"photoSize",w:s.width,h:s.height,type:"full",size:t.size};else if("video"===a&&s.thumb){o={_:"photoSize",w:s.thumb.size.width,h:s.thumb.size.height,type:"local-thumb",size:s.thumb.blob.size};const e=st.getCacheContext(m,o.type);e.downloaded=o.size,e.url=s.thumb.url}o&&e.push(o),m=es.saveDoc(m)}this.log("sendFile",a,o,t.type,s);const v=d?void 0:new y({attachMethod:"prepend",tryAgainOnFail:!1,isUpload:!0}),b=Object(w.a)();v&&(v.attachPromise(b),b.cancel=()=>{const e=new Error("Download canceled");e.name="AbortError",b.reject(e)},b.catch(t=>{"AbortError"!==t.name||M||(this.log("cancelling upload",S),this.cancelPendingMessage(i.random_id),this.setTyping(e,{_:"sendMessageCancelAction"}),(null==C?void 0:C.cancel)&&C.cancel())}));const S=d?void 0:{_:g?"messageMediaPhoto":"messageMediaDocument",pFlags:{},preloader:v,photo:g,document:m,promise:b};i.entities=h,i.message=c,i.media=d?{_:"messageMediaDocument",pFlags:{},document:t}:S;const I=e=>{e?i.error=!0:delete i.error,H.default.dispatchEvent("messages_pending")};let M=!1,C=null;return i.send=()=>{if(d){const{id:e,access_hash:s,file_reference:i}=t,n={_:"inputMediaDocument",id:{_:"inputDocument",id:e,access_hash:s,file_reference:i}};b.resolve(n)}else if(t instanceof File||t instanceof Blob){const n=()=>{let n;return M&&!i.error||(M=!1,C=st.upload(t,"",Te.getOutputPeer(i.peerId)),b.notifyAll({done:0,total:t.size})),"video"===a&&s.objectURL&&(n=new Promise((e,t)=>{(s.thumb&&s.thumb.blob?Promise.resolve(s.thumb):_(s.objectURL)).then(s=>{s?st.upload(s.blob).then(e,t):e(null)},t)})),C&&C.then(e=>Fs(this,void 0,void 0,(function*(){let t;switch(delete i.media.preloader,e.name=o,M=!0,a){case"photo":t={_:"inputMediaUploadedPhoto",file:e};break;default:t={_:"inputMediaUploadedDocument",file:e,mime_type:r,pFlags:{force_file:"sendMessageUploadDocumentAction"===f||void 0},attributes:u}}if(n)try{const e=yield n;t.thumb=e}catch(e){this.log.error("sendFile thumb upload error:",e)}b.resolve(t)})),()=>{I(!0)}),C.addNotifyListener(t=>{const s=Math.max(1,Math.floor(100*t.done/t.total));f&&this.setTyping(e,{_:f,progress:0|s}),b.notifyAll(t)}),b};s.isGroupedItem?n():this.sendSmthLazyLoadQueue.push({load:n})}return b},this.beforeMessageSending(i,{isGroupedItem:s.isGroupedItem,isScheduled:!!s.scheduleDate||void 0,threadId:s.threadId,clearDraft:s.clearDraft}),s.isGroupedItem||b.then(t=>(this.setTyping(e,{_:"sendMessageCancelAction"}),F.a.invokeApi("messages.sendMedia",{background:s.background,peer:Te.getInputPeerById(e),media:t,message:c,random_id:i.random_id,reply_to_msg_id:n,schedule_date:s.scheduleDate,silent:s.silent,entities:h,clear_draft:s.clearDraft},{fileUpload:!0}).then(e=>{Ie.processUpdateMessage(e)},e=>{if("photo"===a&&400===e.code&&("PHOTO_INVALID_DIMENSIONS"===e.type||"PHOTO_SAVE_FILE_INVALID"===e.type))return e.handled=!0,a="document",void i.send();I(!0)}))),{message:i,promise:b}}sendAlbum(e,t,s={}){return Fs(this,void 0,void 0,(function*(){if(s.threadId&&!s.replyToMsgId&&(s.replyToMsgId=s.threadId),1===t.length)return this.sendFile(e,t[0],Object.assign(Object.assign({},s),s.sendFileDetails[0]));e=Te.getPeerMigratedTo(e)||e;const i=s.replyToMsgId?as.getServerMessageId(s.replyToMsgId):void 0;let n=s.caption||"",a=s.entities||[];n&&(n=N.a.parseMarkdown(n,a)),this.log("sendAlbum",t,s);const o=""+ ++this.groupedTempId,r=t.map((t,r)=>{const l=s.sendFileDetails[r],d=Object.assign({isGroupedItem:!0,isMedia:s.isMedia,scheduleDate:s.scheduleDate,silent:s.silent,replyToMsgId:i,threadId:s.threadId,groupId:o},l);return 0===r&&(d.caption=n,d.entities=a),this.sendFile(e,t,d).message});s.clearDraft&&setTimeout(()=>{ls.clearDraft(e,s.threadId)},0);const l=(e,t)=>{t?e.error=!0:delete e.error,H.default.dispatchEvent("messages_pending")},d=Te.getInputPeerById(e),c=t=>{this.setTyping(e,{_:"sendMessageCancelAction"}),this.sendSmthLazyLoadQueue.push({load:()=>F.a.invokeApi("messages.sendMultiMedia",{peer:d,multi_media:t,reply_to_msg_id:i,schedule_date:s.scheduleDate,silent:s.silent,clear_draft:s.clearDraft},{fileUpload:!0}).then(e=>{Ie.processUpdateMessage(e)},e=>{r.forEach(e=>l(e,!0))})})},h=r.map(e=>e.send().then(e=>F.a.invokeApi("messages.uploadMedia",{peer:d,media:e},{fileUpload:!0})).then(t=>{let s;if("messageMediaPhoto"===t._){const e=Dt.savePhoto(t.photo);s=Dt.getMediaInput(e)}else if("messageMediaDocument"===t._){const e=es.saveDoc(t.document);s=es.getMediaInput(e)}const i={_:"inputSingleMedia",media:s,random_id:e.random_id,message:n,entities:a};return n&&(n="",a=[]),i}).catch(t=>{if("AbortError"===t.name)return null;throw this.log.error("sendAlbum upload item error:",t,e),l(e,!0),t}));Promise.all(h).then(e=>{c(e.filter(Boolean))})}))}sendOther(e,t,s={}){var i;e=Te.getPeerMigratedTo(e)||e;const n=this.generateOutgoingMessage(e,s),a=s.replyToMsgId?as.getServerMessageId(s.replyToMsgId):void 0;let o;switch(t._){case"inputMediaPoll":{const e=""+n.id;t.poll.id=e,Ls.savePoll(t.poll,{_:"pollResults",flags:4,total_voters:0,pFlags:{}});const{poll:s,results:i}=Ls.getPoll(e);o={_:"messageMediaPoll",poll:s,results:i};break}case"inputMediaPhoto":o={_:"messageMediaPhoto",photo:Dt.getPhoto(t.id.id)};break;case"inputMediaDocument":o={_:"messageMediaDocument",document:es.getDoc(t.id.id)};break;case"inputMediaContact":o={_:"messageMediaContact",phone_number:t.phone_number,first_name:t.first_name,last_name:t.last_name,user_id:null!==(i=t.user_id)&&void 0!==i?i:"0",vcard:t.vcard};break;case"inputMediaGeoPoint":o={_:"messageMediaGeo",geo:s.geoPoint};break;case"inputMediaVenue":o={_:"messageMediaVenue",geo:s.geoPoint,title:t.title,address:t.address,provider:t.provider,venue_id:t.venue_id,venue_type:t.venue_type};break;case"messageMediaPending":o=t}n.media=o;n.send=()=>{const i={};let o;return this.pendingAfterMsgs[e]&&(i.afterMessageId=this.pendingAfterMsgs[e].messageId),o=s.viaBotId?F.a.invokeApiAfter("messages.sendInlineBotResult",{peer:Te.getInputPeerById(e),random_id:n.random_id,reply_to_msg_id:a||void 0,query_id:s.queryId,id:s.resultId,clear_draft:s.clearDraft,schedule_date:s.scheduleDate,silent:s.silent},i):F.a.invokeApiAfter("messages.sendMedia",{peer:Te.getInputPeerById(e),media:t,random_id:n.random_id,reply_to_msg_id:a||void 0,message:"",clear_draft:s.clearDraft,schedule_date:s.scheduleDate,silent:s.silent},i),this.pendingAfterMsgs[e]=i,o.then(e=>{e.updates&&e.updates.forEach(e=>{"updateDraftMessage"===e._&&(e.local=!0)}),Ie.processUpdateMessage(e)},e=>{H.default.dispatchEvent("messages_pending")}).finally(()=>{this.pendingAfterMsgs[e]===i&&delete this.pendingAfterMsgs[e]})},this.beforeMessageSending(n,{isScheduled:!!s.scheduleDate||void 0,threadId:s.threadId,clearDraft:s.clearDraft})}beforeMessageSending(e,t={}){const s=e.id,i=this.getMessagePeer(e),n=t.isScheduled?this.getScheduledMessagesStorage(i):this.getMessagesStorage(i);if(t.isScheduled)this.saveMessages([e],{storage:n,isScheduled:!0,isOutgoing:!0}),setTimeout(()=>{H.default.dispatchEvent("scheduled_new",{peerId:i,mid:s})},0);else{const a=[this.getHistoryStorage(i),t.threadId?this.getHistoryStorage(i,t.threadId):void 0];for(const e of a)e&&e.history.unshift(s);this.saveMessages([e],{storage:n,isOutgoing:!0}),this.setDialogTopMessage(e),setTimeout(()=>{H.default.dispatchEvent("history_append",{storage:n,peerId:i,mid:s})},0)}this.pendingByRandomId[e.random_id]={peerId:i,tempId:s,threadId:t.threadId,storage:n},!t.isGroupedItem&&e.send&&setTimeout(()=>{t.clearDraft&&ls.clearDraft(i,t.threadId),e.send()},0)}generateOutgoingMessage(e,t){let s;t.threadId&&!t.replyToMsgId&&(t.replyToMsgId=t.threadId);const i=Te.isBroadcast(e);if(i){if(Te.getPeer(e).pFlags.signatures){const e=ye.getSelf();s=e.first_name+(e.last_name?" "+e.last_name:"")}}return{_:"message",id:this.generateTempMessageId(e),from_id:this.generateFromId(e),peer_id:Te.getOutputPeer(e),post_author:s,pFlags:this.generateFlags(e),date:t.scheduleDate||Object(S.f)(!0)+U.a.serverTimeOffset,message:"",grouped_id:t.groupId,random_id:Object(x.b)(),reply_to:this.generateReplyHeader(t.replyToMsgId,t.threadId),via_bot_id:t.viaBotId,reply_markup:t.replyMarkup,replies:this.generateReplies(e),views:i&&1,pending:!0}}generateReplyHeader(e,t){const s={_:"messageReplyHeader",reply_to_msg_id:e||t};return t&&s.reply_to_msg_id!==t&&(s.reply_to_top_id=t),s}generateReplies(e){let t;if(Te.isBroadcast(e)){const s=Ts.chatsFull[e.toChatId()];(null==s?void 0:s.linked_chat_id)&&(t={_:"messageReplies",flags:1,pFlags:{comments:!0},channel_id:s.linked_chat_id,replies:0,replies_pts:0})}return t}generateFromId(e){return e.isAnyChat()&&(e.isBroadcast()||this.isAnonymousSending(e))?void 0:Te.getOutputPeer(ye.getSelf().id.toPeerId())}generateFlags(e){const t={};return e!==ye.getSelf().id&&(t.out=!0,Te.isChannel(e)||ye.isBot(e)||(t.unread=!0)),Te.isBroadcast(e)&&(t.post=!0),t}generateForwardHeader(e,t){const s=ye.getSelf().id.toPeerId();if(t.fromId===s&&t.peerId===s&&!t.fwd_from)return;const i={_:"messageFwdHeader",flags:0,date:t.date};return t.fwd_from?(i.from_id=t.fwd_from.from_id,i.from_name=t.fwd_from.from_name,i.post_author=t.fwd_from.post_author):(i.from_id=Te.getOutputPeer(t.fromId),i.post_author=t.post_author),Te.isBroadcast(t.peerId)&&(t.post_author&&(i.post_author=t.post_author),i.channel_post=t.id),e===s&&(i.saved_from_msg_id=t.id,i.saved_from_peer=Te.getOutputPeer(t.peerId)),i}generateFakeAvatarMessage(e,t){const s=Number.MAX_SAFE_INTEGER,i={_:"messageService",pFlags:{},action:{_:"messageActionChannelEditPhoto",photo:t},mid:s,peerId:e,date:t.date||Math.floor(Date.now()/1e3),fromId:e};return this.getMessagesStorage(e).set(s,i),i}isAnonymousSending(e){var t,s;return e.isAnyChat()&&(null===(s=null===(t=Te.getPeer(e).admin_rights)||void 0===t?void 0:t.pFlags)||void 0===s?void 0:s.anonymous)}setDialogTopMessage(e,t=this.getDialogOnly(e.peerId)){if(t){t.top_message=e.mid;this.getHistoryStorage(e.peerId).maxId=e.mid,this.dialogsStorage.generateIndexForDialog(t,!1,e),this.scheduleHandleNewDialogs(e.peerId,t)}}cancelPendingMessage(e){const t=this.pendingByRandomId[e];if(t){const{peerId:s,tempId:i,storage:n}=t,a=this.getHistoryStorage(s);return Ie.processLocalUpdate({_:"updateDeleteMessages",messages:[i],pts:void 0,pts_count:void 0}),a.history.delete(i),delete this.pendingByRandomId[e],n.delete(i),!0}return!1}fillConversations(){return Fs(this,void 0,void 0,(function*(){const e=this.middleware.get();for(;!this.dialogsStorage.isDialogsLoaded(void 0);){const t=yield this.getTopMessages(100,void 0);if(!e()||t.isEnd)break}}))}getConversations(e="",t,s,i=0,n){return this.dialogsStorage.getDialogs(e,t,s,i,n)}getReadMaxIdIfUnread(e,t){var s;const i=this.getHistoryStorage(e,t);if(t){const t=this.getHistoryStorage(e),n=Math.max(null!==(s=t.readMaxId)&&void 0!==s?s:0,i.readMaxId);return!this.getMessageByPeer(e,i.maxId).pFlags.out&&n<i.maxId?n:0}{const t=this.getMessageByPeer(e,i.maxId),s=e.isUser()?Math.max(i.readMaxId,i.readOutboxMaxId):i.readMaxId;return!t.pFlags.out&&s<i.maxId?s:0}}getTopMessages(e,t,s){let i=0;void 0===s&&(s=this.dialogsStorage.getOffsetDate(t)),s&&(i=65536*s,s+=U.a.serverTimeOffset);const n=this.middleware.get(),o={folder_id:t,offset_date:s,offset_id:0,offset_peer:Te.getInputPeerById(void 0),limit:100,hash:"0"};return F.a.invokeApiSingle("messages.getDialogs",o,{noErrorBox:!0}).then(r=>{if(!n()||"messages.dialogsNotModified"===r._)return null;j.b&&this.log("messages.getDialogs result:",r.dialogs,Object.assign({},r.dialogs[0])),s||void 0===t||this.dialogsStorage.resetPinnedOrder(t),s||Qe.default.setAuthorized(!0),ye.saveApiUsers(r.users),Pe.saveApiChats(r.chats),this.saveMessages(r.messages);let l=!!s,d=!1;const c={},h=void 0===t?0:t,u=void 0===t;Object(a.e)(r.dialogs,e=>{void 0===e.folder_id&&(e.folder_id=h),this.dialogsStorage.saveDialog(e,void 0,!0,u),l||Te.isChannel(e.peerId||Te.getPeerId(e.peer))||(this.incrementMaxSeenId(e.top_message),l=!0),void 0!==e.peerId&&(i&&e.index>i&&(this.scheduleHandleNewDialogs(e.peerId,e),d=!0),as.getServerMessageId(e.read_inbox_max_id)||as.getServerMessageId(e.read_outbox_max_id)||(c[e.peerId]=e,this.log.error("noIdsDialogs",e,o)))});const p=Object.keys(c);if(p.length){const e=p.map(e=>e.toPeerId()),t=e.map(e=>this.reloadConversation(e));Promise.all(t).then(()=>{H.default.dispatchEvent("dialogs_multiupdate",c);for(let t=0;t<e.length;++t)H.default.dispatchEvent("dialog_unread",{peerId:e[t]})})}const g=r.count,m=this.dialogsStorage.getFolderDialogs(t,!1);let f=0;for(let e=0,t=m.length;e<t;++e)as.getServerMessageId(m[e].top_message)&&++f;const v=!g||f>=g||!r.dialogs.length;v&&this.dialogsStorage.setDialogsLoaded(t,!0),d?this.scheduleHandleNewDialogs():H.default.dispatchEvent("dialogs_multiupdate",{});const b=r.dialogs,y=100===e?b:b.slice(0,e);return{isEnd:v&&y[y.length-1]===b[b.length-1],count:g,dialogs:y}})}forwardMessages(e,t,s,i={}){e=Te.getPeerMigratedTo(e)||e,s=s.slice().sort((e,t)=>e-t),i.dropCaptions&&(i.dropAuthor=!0);const n={},a=s.map(s=>{var a,o;const r=this.getMessageByPeer(t,s),l=this.generateOutgoingMessage(e,i),d=["entities","media"];i.dropAuthor||(l.fwd_from=this.generateForwardHeader(e,r),d.push("views","forwards")),i.dropCaptions&&r.media||d.push("message"),d.forEach(e=>{l[e]=r[e]});const c=null===(a=l.media)||void 0===a?void 0:a.document;if(c){["round","voice"].includes(c.type)&&(l.pFlags.media_unread=!0)}if(r.grouped_id){(null!==(o=n[r.grouped_id])&&void 0!==o?o:n[r.grouped_id]={tempId:""+ ++this.groupedTempId,messages:[]}).messages.push(l)}return l});for(const e in n){const t=n[e];t.messages.length>1&&t.messages.forEach(e=>{e.grouped_id=t.tempId})}a.forEach(e=>{this.beforeMessageSending(e,{isScheduled:!!i.scheduleDate||void 0})});const o={};this.pendingAfterMsgs[e]&&(o.afterMessageId=this.pendingAfterMsgs[e].messageId);const r=F.a.invokeApiAfter("messages.forwardMessages",{from_peer:Te.getInputPeerById(t),id:s.map(e=>as.getServerMessageId(e)),random_id:a.map(e=>e.random_id),to_peer:Te.getInputPeerById(e),with_my_score:i.withMyScore,silent:i.silent,schedule_date:i.scheduleDate,drop_author:i.dropAuthor,drop_media_captions:i.dropCaptions},o).then(e=>{this.log("forwardMessages updates:",e),Ie.processUpdateMessage(e)}).finally(()=>{this.pendingAfterMsgs[e]===o&&delete this.pendingAfterMsgs[e]});return this.pendingAfterMsgs[e]=o,r}generateEmptyMessage(e){return{_:"messageEmpty",id:as.getServerMessageId(e),mid:e,deleted:!0,pFlags:{}}}getMessageFromStorage(e,t){return e&&e.get(t)||this.generateEmptyMessage(t)}createMessageStorage(){return new Map}getMessagesStorage(e){var t;return null!==(t=this.messagesStorageByPeerId[e])&&void 0!==t?t:this.messagesStorageByPeerId[e]=this.createMessageStorage()}getMessageById(e){for(const t in this.messagesStorageByPeerId){if(Te.isChannel(t.toPeerId()))continue;const s=this.messagesStorageByPeerId[t].get(e);if(s)return s}return this.getMessageFromStorage(null,e)}getMessageByPeer(e,t){return e?this.getMessageFromStorage(this.getMessagesStorage(e),t):this.getMessageById(t)}getMessagePeer(e){return e.peer_id&&Te.getPeerId(e.peer_id)||Z.b}getDialogByPeerId(e){return this.dialogsStorage.getDialog(e)}getDialogOnly(e){return this.dialogsStorage.getDialogOnly(e)}reloadConversation(e){let t;if(void 0!==e){const s=Te.getPeerId(e);let i=this.reloadConversationsPeers.get(s);if(i&&(t=i.promise),t)return t;t=Object(w.a)(),this.reloadConversationsPeers.set(s,i={inputDialogPeer:Te.getInputDialogPeerById(e),promise:t})}return this.reloadConversationsPromise||(this.reloadConversationsPromise=new Promise((e,t)=>{setTimeout(()=>{const t=[],s={};for(const[e,{inputDialogPeer:i,promise:n}]of this.reloadConversationsPeers)"inputDialogPeer"===i._&&(t.push(i.peer),s[e]=n);this.reloadConversationsPeers.clear();F.a.invokeApi("messages.getPeerDialogs",{peers:t}).then(e=>{this.dialogsStorage.applyDialogs(e),e.dialogs.forEach(e=>{const t=e.peerId;t&&(s[t].resolve(e),delete s[t])})},e=>{}).finally(()=>{(()=>{for(const e in s)s[e].resolve(void 0)})(),e(),this.reloadConversationsPromise=null,this.reloadConversationsPeers.size&&this.reloadConversation()})},0)})),t||this.reloadConversationsPromise}doFlushHistory(e,t,s){return F.a.invokeApiSingle("messages.deleteHistory",{just_clear:t,revoke:s,peer:e,max_id:0}).then(i=>(Ie.processUpdateMessage({_:"updateShort",update:{_:"updatePts",pts:i.pts,pts_count:i.pts_count}}),!i.offset||this.doFlushHistory(e,t,s)))}flushHistory(e,t,s){return Fs(this,void 0,void 0,(function*(){if(Te.isChannel(e)){const t=this.getHistory(e,0,1),s=t instanceof Promise?yield t:t,i=e.toChatId(),n=s.history[0]||0;return F.a.invokeApiSingle("channels.deleteHistory",{channel:Pe.getChannelInput(i),max_id:as.getServerMessageId(n)}).then(e=>(e&&Ie.processLocalUpdate({_:"updateChannelAvailableMessages",channel_id:i,available_min_id:n}),e))}return this.doFlushHistory(Te.getInputPeerById(e),t,s).then(()=>{[this.historiesStorage,this.threadsStorage,this.searchesStorage,this.pinnedMessages,this.pendingAfterMsgs,this.pendingTopMsgs].forEach(t=>{delete t[e]});const s=this.needSingleMessages.get(e);if(s&&s.clear(),[this.messagesStorageByPeerId,this.scheduledMessagesStorage].forEach(t=>{const s=t[e];s&&s.clear()}),t)H.default.dispatchEvent("dialog_flush",{peerId:e});else{delete this.notificationsToHandle[e],delete this.typings[e];const t=this.reloadConversationsPeers.get(e);t&&(this.reloadConversationsPeers.delete(e),t.promise.resolve(void 0)),this.dialogsStorage.dropDialogOnDeletion(e)}})}))}onPeerDeleted(e){}hidePinnedMessages(e){return Promise.all([ve.default.getState(),this.getPinnedMessage(e)]).then(([t,s])=>{t.hiddenPinnedMessages[e]=s.maxId,H.default.dispatchEvent("peer_pinned_hidden",{peerId:e,maxId:s.maxId})})}getPinnedMessage(e){var t;const s=null!==(t=this.pinnedMessages[e])&&void 0!==t?t:this.pinnedMessages[e]={};return s.promise?s.promise:s.maxId?Promise.resolve(s):s.promise=this.getSearch({peerId:e,inputFilter:{_:"inputMessagesFilterPinned"},maxId:0,limit:1}).then(e=>{var t;return s.count=e.count,s.maxId=null===(t=e.history[0])||void 0===t?void 0:t.mid,s}).finally(()=>{delete s.promise})}updatePinnedMessage(e,t,s,i,n){return F.a.invokeApi("messages.updatePinnedMessage",{peer:Te.getInputPeerById(e),unpin:s,silent:i,pm_oneside:n,id:as.getServerMessageId(t)}).then(e=>{Ie.processUpdateMessage(e)})}unpinAllMessages(e){return F.a.invokeApiSingle("messages.unpinAllMessages",{peer:Te.getInputPeerById(e)}).then(t=>{if(Ie.processUpdateMessage({_:"updateShort",update:{_:"updatePts",pts:t.pts,pts_count:t.pts_count}}),!t.offset){return this.getMessagesStorage(e).forEach(e=>{e.pFlags.pinned&&delete e.pFlags.pinned}),H.default.dispatchEvent("peer_pinned_messages",{peerId:e,unpinAll:!0}),delete this.pinnedMessages[e],!0}return this.unpinAllMessages(e)})}getAlbumText(e){const t=this.groupedMessagesStorage[e];let s,i,n,a=0;for(const[e,o]of t)if(o.message){if(++a>1)break;s=o.message,i=o.totalEntities,n=o.entities}return a>1&&(s=void 0,i=void 0,n=void 0),{message:s,entities:n,totalEntities:i}}getMidsByAlbum(e){return Object(m.e)(this.groupedMessagesStorage[e],"asc")}getMidsByMessage(e){return e?e.grouped_id?this.getMidsByAlbum(e.grouped_id):[e.mid]:[]}filterMessages(e,t){const s=[];if(e.grouped_id){const i=this.groupedMessagesStorage[e.grouped_id];for(const[e,n]of i)t(n)&&s.push(n)}else t(e)&&s.push(e);return s}generateTempMessageId(e){const t=this.getDialogOnly(e);return as.generateMessageId((null==t?void 0:t.top_message)||0,!0)}saveMessage(e,t={}){var s,i;if(void 0===e.pFlags&&(e.pFlags={}),"messageEmpty"===e._)return void(e.deleted=!0);const n=this.getMessagePeer(e),a=t.storage||this.getMessagesStorage(n),o="peerChannel"===e.peer_id._,r=o&&Pe.isBroadcast(n.toChatId());t.isScheduled&&(e.pFlags.is_scheduled=!0),t.isOutgoing&&(e.pFlags.is_outgoing=!0);const l=as.generateMessageId(e.id);if(e.mid=l,e.grouped_id){(null!==(s=this.groupedMessagesStorage[e.grouped_id])&&void 0!==s?s:this.groupedMessagesStorage[e.grouped_id]=new Map).set(l,e)}const d=this.getDialogOnly(n);d&&l&&l>d[e.pFlags.out?"read_outbox_max_id":"read_inbox_max_id"]&&(e.pFlags.unread=!0),e.reply_to&&(e.reply_to.reply_to_msg_id&&(e.reply_to.reply_to_msg_id=e.reply_to_mid=as.generateMessageId(e.reply_to.reply_to_msg_id)),e.reply_to.reply_to_top_id&&(e.reply_to.reply_to_top_id=as.generateMessageId(e.reply_to.reply_to_top_id))),e.replies&&(e.replies.max_id&&(e.replies.max_id=as.generateMessageId(e.replies.max_id)),e.replies.read_max_id&&(e.replies.read_max_id=as.generateMessageId(e.replies.read_max_id)));const c=!!n;c||(e.date-=U.a.serverTimeOffset);const h=ye.getSelf().id;e.peerId=n,e.fromId=n===h?e.fwd_from?e.fwd_from.from_id?Te.getPeerId(e.fwd_from.from_id):0:h:e.pFlags.post||!e.from_id?n:Te.getPeerId(e.from_id);const u=e.fwd_from;if(u){u.saved_from_msg_id&&(u.saved_from_msg_id=as.generateMessageId(u.saved_from_msg_id)),u.channel_post&&(u.channel_post=as.generateMessageId(u.channel_post));const t=u.saved_from_peer||u.from_id,s=u.saved_from_msg_id||u.channel_post;if(t&&s){const i=Te.getPeerId(t),n=as.generateMessageId(s);e.savedFrom=i+"_"+n}e.fwdFromId=Te.getPeerId(u.from_id),c||(u.date-=U.a.serverTimeOffset)}e.via_bot_id>0&&(e.viaBotId=e.via_bot_id);const p={type:"message",peerId:n,messageId:l};if(e.media)switch(e.media._){case"messageMediaEmpty":delete e.media;break;case"messageMediaPhoto":e.media.ttl_seconds?e.media={_:"messageMediaUnsupportedWeb"}:e.media.photo=Dt.savePhoto(e.media.photo,p),e.media.photo||delete e.media;break;case"messageMediaPoll":{const t=Ls.savePoll(e.media.poll,e.media.results,e);e.media.poll=t.poll,e.media.results=t.results;break}case"messageMediaDocument":e.media.ttl_seconds?e.media={_:"messageMediaUnsupportedWeb"}:e.media.document=es.saveDoc(e.media.document,p);break;case"messageMediaWebPage":{const s=Os.getMessageKeyForPendingWebPage(n,l,t.isScheduled);e.media.webpage=Os.saveWebPage(e.media.webpage,s,p);break}case"messageMediaInvoice":e.media={_:"messageMediaUnsupportedWeb"}}if(e.action){const t=e.action;let s,a;const l=e.fromId===ye.getSelf().id?"You":"";switch(t.photo&&(t.photo=Dt.savePhoto(t.photo,p)),t.document&&(t.document=es.saveDoc(t.photo,p)),t._){case"messageActionChatEditPhoto":(null===(i=t.photo)||void 0===i?void 0:i.video_sizes)?t._=r?"messageActionChannelEditVideo":"messageActionChatEditVideo":r&&(t._="messageActionChannelEditPhoto");break;case"messageActionGroupCall":{let s;void 0===t.duration?(s="started",n!==e.fromId&&(s+="_by"+l)):s="ended_by"+l,t.type=s;break}case"messageActionChatEditTitle":r&&(t._="messageActionChannelEditTitle");break;case"messageActionChatDeletePhoto":r&&(t._="messageActionChannelDeletePhoto");break;case"messageActionChatAddUser":1===t.users.length?(t.user_id=t.users[0],e.fromId===t.user_id&&(t._=o?"messageActionChatJoined"+l:"messageActionChatReturn"+l)):t.users.length>1&&(t._="messageActionChatAddUsers");break;case"messageActionChatDeleteUser":e.fromId===t.user_id&&(t._="messageActionChatLeave"+l);break;case"messageActionChannelMigrateFrom":s=t.chat_id.toPeerId(!0),a=n;break;case"messageActionChatMigrateTo":s=n,a=t.channel_id.toPeerId(!0);break;case"messageActionHistoryClear":e.clear_history=!0,delete e.pFlags.out,delete e.pFlags.unread;break;case"messageActionPhoneCall":t.type=(e.pFlags.out?"out_":"in_")+("phoneCallDiscardReasonMissed"===t.reason._||"phoneCallDiscardReasonBusy"===t.reason._?"missed":"ok")}s&&a&&!this.migratedFromTo[s]&&!this.migratedToFrom[a]&&this.migrateChecks(s,a)}e.message&&e.message.length&&!e.totalEntities&&this.wrapMessageEntities(e),a.set(l,e)}saveMessages(e,t={}){e.saved||(e.saved=!0,e.forEach(e=>{this.saveMessage(e,t)}))}wrapMessageEntities(e){const t=e.entities?e.entities.slice():[];e.message=N.a.fixEmoji(e.message,t);const s=N.a.parseEntities(e.message);e.totalEntities=N.a.mergeEntities(t,s)}wrapMessageForReply(e,t=e.message,s,i,n,a){const o=[];let r=!1;const l=(e,t)=>{if(e){if(void 0===t&&r)return;t=i?O.default.format(e,!0):Object(O.i18n)(e)}if(i)o.push(t);else{const e=document.createElement("i");"string"==typeof t?e.innerHTML=t:e.append(t),o.push(e)}},d=this.isRestricted(e);let c=e.totalEntities;if(e.media&&!d){let n=!0;if(e.grouped_id){if(s){const t=this.getMidsByMessage(e);if(s.length===t.length){for(const e of t)if(!s.includes(e)){n=!1;break}}else n=!1}if(n){const s=this.getAlbumText(e.grouped_id);t=s.message,c=s.totalEntities,a||(l("AttachAlbum"),r=!0)}}else n=!1;if(!n&&!a||!t){const s=e.media;switch(s._){case"messageMediaPhoto":l("AttachPhoto");break;case"messageMediaDice":l(void 0,i?s.emoticon:N.a.wrapEmojiText(s.emoticon));break;case"messageMediaVenue":t=s.title,l("AttachLocation");break;case"messageMediaGeo":l("AttachLocation");break;case"messageMediaGeoLive":l("AttachLiveLocation");break;case"messageMediaPoll":const e="ðŸ“Š "+(s.poll.question||"poll");l(void 0,i?e:N.a.wrapEmojiText(e));break;case"messageMediaContact":l("AttachContact");break;case"messageMediaGame":{const e="ðŸŽ® "+s.game.title;l(void 0,i?e:N.a.wrapEmojiText(e));break}case"messageMediaDocument":{const e=s.document;if("video"===e.type)l("AttachVideo");else if("voice"===e.type)l("AttachAudio");else if("gif"===e.type)l("AttachGif");else if("round"===e.type)l("AttachRound");else if("sticker"===e.type){const s=o.length;if(e.stickerEmojiRaw){const t=e.stickerEmojiRaw+" ";l(void 0,i?t:N.a.wrapEmojiText(t))}l("AttachSticker");const n=o.splice(s,2);if(i)o.push(n[0]+n[1]);else{const e=window.document.createElement("span");e.append(...n),o.push(e)}t=""}else if("audio"===e.type){const t=e.attributes.find(e=>"documentAttributeAudio"===e._&&(e.title||e.performer)),s="ðŸŽµ "+(t?[t.title,t.performer].filter(Boolean).join(" - "):e.file_name);l(void 0,i?s:N.a.wrapEmojiText(s))}else l(void 0,i?e.file_name:N.a.wrapEmojiText(e.file_name));break}}}const d=o.length;for(let e=1;e<d;e+=2)o.splice(e,0,", ");t&&d&&o.push(", ")}if(e.action){const t=this.wrapMessageActionTextNew(e,i);t&&l(void 0,t)}if(d&&(t=pe(e.restriction_reason).text,c=[]),t)if(t=Object(A.f)(t,100),c||(c=[]),i)o.push(N.a.wrapPlainText(t,c));else{if(n){n=n.trim();let e,s=!1,i=new RegExp(Object(A.e)(n),"gi");for(c=c.slice();null!==(e=i.exec(t));)c.push({_:"messageEntityHighlight",length:n.length,offset:e.index}),s=!0;s&&N.a.sortEntities(c)}const e=N.a.wrapRichText(t,{noLinebreaks:!0,entities:c,noLinks:!0,noTextFormat:!0});o.push(Ne(e))}if(i)return o.join("");{const e=document.createDocumentFragment();return e.append(...o),e}}wrapSenderToPeer(e){const t=document.createElement("span");t.classList.add("sender-title");const s=e.fromId===H.default.myId&&e.peerId!==H.default.myId;if(t.append(s?Object(O.i18n)("FromYou"):new Oe({peerId:e.fromId,dialog:e.peerId===H.default.myId}).element),Te.isAnyGroup(e.peerId)||s){const s=new Oe({peerId:e.peerId}).element;t.append(" âž ",s)}return t}wrapSentTime(e){const t=document.createElement("span");return t.classList.add("sent-time"),t.append(Object(S.b)(new Date(1e3*e.date))),t}wrapMessageActionTextNew(e,t){const s=t?void 0:document.createElement("span"),i="action"in e&&e.action;if(i.message){const e=i.message;return t?N.a.wrapPlainText(e):(Object(xe.a)(s,N.a.wrapRichText(e,{noLinebreaks:!0})),s)}{let n,o,r=i._;const l=(e,t)=>t?Te.getPeerTitle(e,t)+" ":new Oe({peerId:e}).element;switch(i._){case"messageActionPhoneCall":r+="."+i.type,o=[qe(i.duration)];break;case"messageActionGroupCall":r+="."+i.type,o=[],r.endsWith("You")||o.push(l(e.fromId,t)),o.push(qe(i.duration));break;case"messageActionInviteToGroupCall":{const s=[e.fromId,i.users[0].toPeerId()];let r="ActionGroupCall";const d=ye.getSelf().id;s[0]===d&&(r+="You"),r+="Invited",s[1]===d&&(r+="You"),Object(a.f)(s,d),n=r,o=s.map(e=>l(e,t));break}case"messageActionGroupCallScheduled":{const s=new Date,a=new Date(1e3*i.schedule_date),r=(a.getTime()-s.getTime())/864e5,d=new Date(s);d.setDate(d.getDate()+1);const c=Te.isBroadcast(e.peerId);n=c?"ChatList.Service.VoiceChatScheduled.Channel":"ChatList.Service.VoiceChatScheduled",o=[];const h=ye.getSelf().id;e.fromId===h?n+="You":c||o.push(l(e.fromId,t));let u,p=[];r<1&&a.getDate()===s.getDate()?u="TodayAtFormattedWithToday":r<2&&a.getDate()===d.getDate()?u="Time.TomorrowAt":(u="formatDateAtTime",p.push(new O.default.IntlDateElement({date:a,options:{day:"2-digit",month:"2-digit",year:"2-digit"}}).element)),p.push(Object(S.d)(a));const g=Object(O.i18n)(u,p);o.push(g);break}case"messageActionChatCreate":{const s=ye.getSelf().id;e.fromId===s?r+="You":o=[l(e.fromId,t)];break}case"messageActionPinMessage":{const s=e.peerId,i=this.getMessageByPeer(s,e.reply_to_mid);if(o=[l(e.fromId,t)],i.deleted)n="ActionPinnedNoText",e.reply_to_mid&&this.fetchMessageReplyTo(e).then(t=>{t.deleted||e.deleted||(H.default.dispatchEvent("message_edit",{storage:this.getMessagesStorage(s),peerId:s,mid:e.mid}),this.isMessageIsTopMessage(e)&&H.default.dispatchEvent("dialogs_multiupdate",{[s]:this.getDialogOnly(s)}))});else{const e=document.createElement("i");e.dataset.savedFrom=i.peerId+"_"+i.mid,e.dir="auto",e.append(this.wrapMessageForReply(i,void 0,void 0,t)),o.push(e)}break}case"messageActionContactSignUp":case"messageActionChatReturn":case"messageActionChatLeave":case"messageActionChatJoined":case"messageActionChatEditPhoto":case"messageActionChatDeletePhoto":case"messageActionChatEditVideo":case"messageActionChatJoinedByLink":case"messageActionChannelEditVideo":case"messageActionChannelDeletePhoto":o=[l(e.fromId,t)];break;case"messageActionChannelEditTitle":case"messageActionChatEditTitle":o=[],"messageActionChatEditTitle"===i._&&o.push(l(e.fromId,t)),o.push(t?i.title:Object(He.a)(N.a.wrapEmojiText(i.title)));break;case"messageActionChatDeleteUser":case"messageActionChatAddUsers":case"messageActionChatAddUser":{const s=i.users||[i.user_id];if(o=[l(e.fromId,t)],s.length>1)if(t)o.push(...s.map(e=>l(e.toPeerId(),!0).trim()).join(", "));else{const e=document.createElement("span");e.append(...Object(O.join)(s.map(e=>l(e.toPeerId(),!1)),!1)),o.push(e)}else o.push(l(s[0].toPeerId(),t));break}case"messageActionBotAllowed":{const e=N.a.wrapRichText(i.domain,{entities:[{_:"messageEntityUrl",length:i.domain.length,offset:0}]});o=[Object(He.a)(e)];break}default:n=O.langPack[r]||`[${i._}]`}return n||(n=O.langPack[r],void 0===n&&(n="["+r+"]")),t?O.default.format(n,!0,o):Object(O._i18n)(s,n,o)}}reportMessages(e,t,s,i){return F.a.invokeApiSingle("messages.report",{peer:Te.getInputPeerById(e),id:t.map(e=>as.getServerMessageId(e)),reason:{_:s},message:i})}startBot(e,t,s){const i=t?t.toPeerId(!0):e.toPeerId();if(s){const t=Object(x.b)();return F.a.invokeApi("messages.startBot",{bot:ye.getUserInput(e),peer:Te.getInputPeerById(i),random_id:t,start_param:s}).then(e=>{Ie.processUpdateMessage(e)})}if(t){let s;return s=Pe.isChannel(t)?Pe.inviteToChannel(t,[e]):Pe.addChatUser(t,e,0),s.catch(e=>{if(!e||"USER_ALREADY_PARTICIPANT"!=e.type)throw e;e.handled=!0}).then(()=>{const t=ye.getUser(e);return this.sendText(i,"/start@"+t.username)})}return this.sendText(i,"/start")}editPeerFolders(e,t){const s=Te.getOutputPeer(e[0]),i={_:"updates",chats:[],seq:0,users:[],date:Date.now(),updates:[{_:"updateFolderPeers",folder_peers:[{_:"folderPeer",peer:s,folder_id:t}],pts:void 0,pts_count:0}]};Ie.processUpdateMessage(i)}toggleDialogPin(e,t){var s;if(t>1)return this.filtersStorage.toggleDialogPin(e,t);const i=this.getDialogOnly(e);if(!i)return Promise.reject();const n=!(null===(s=i.pFlags)||void 0===s?void 0:s.pinned)||void 0;if(n){const e=1===t?H.default.config.pinned_infolder_count_max:H.default.config.pinned_dialogs_count_max;if(this.dialogsStorage.getPinnedOrders(t).length>=e)return Promise.reject({type:"PINNED_DIALOGS_TOO_MUCH"})}return Promise.resolve({peer:Te.getInputDialogPeerById(e),pinned:n}).then(()=>{{n?this.filtersStorage.addLocalPinnedDialog(t,e):this.filtersStorage.removeLocalPinnedDialog(t,e);const s=n?{pinned:n}:{};Ie.saveUpdate({_:"updateDialogPinned",peer:Te.getDialogPeer(e),folder_id:t,pFlags:s})}})}markDialogUnread(e,t){var s;const i=this.getDialogOnly(e);if(!i)return Promise.reject();const n=!t&&!(null===(s=i.pFlags)||void 0===s?void 0:s.unread_mark)||void 0;return F.a.invokeApi("messages.markDialogUnread",{peer:Te.getInputDialogPeerById(e),unread:n}).then(t=>{if(t){const t=n?{unread:n}:{};this.onUpdateDialogUnreadMark({_:"updateDialogUnreadMark",peer:Te.getDialogPeer(e),pFlags:t})}})}migrateChecks(e,t){if(!this.migratedFromTo[e]&&!this.migratedToFrom[t]&&Pe.hasChat(t.toChatId())){const s=Pe.getChat(e.toChatId());s&&s.migrated_to&&s.migrated_to.channel_id===t.toChatId()&&(this.migratedFromTo[e]=t,this.migratedToFrom[t]=e,H.default.dispatchEvent("dialog_migrate",{migrateFrom:e,migrateTo:t}),this.dialogsStorage.dropDialogWithEvent(e))}}canMessageBeEdited(e,t){if(e.pFlags.is_outgoing)return!1;const s=["messageMediaPhoto","messageMediaDocument","messageMediaWebPage","messageMediaLiveStream"];return"poll"===t&&s.push("messageMediaPoll"),!("message"!==e._||e.deleted||e.fwd_from||e.via_bot_id||e.media&&-1===s.indexOf(e.media._)||e.fromId&&ye.isBot(e.fromId))&&(!e.media||"messageMediaDocument"!==e.media._||!e.media.document.sticker&&"round"!==e.media.document.type)}canEditMessage(e,t="text",s){var i,n;return!(!e||!this.canMessageBeEdited(e,t))&&(this.getMessagePeer(e)===ye.getSelf().id||(s&&Te.isBroadcast(s)?Pe.hasRights(s.toChatId(),"edit_messages"):!((e.date<Object(S.f)(!0)-H.default.config.edit_time_limit&&"messageMediaPoll"!==(null===(i=e.media)||void 0===i?void 0:i._)||!e.pFlags.out)&&"messageMediaLiveStream"!==(null===(n=e.media)||void 0===n?void 0:n._))))}canDeleteMessage(e){return e&&(e.peerId.isUser()||e.fromId===H.default.myId||"chat"===Pe.getChat(e.peerId.toChatId())._||Pe.hasRights(e.peerId.toChatId(),"delete_messages"))&&!e.pFlags.is_outgoing}canForwardMessage(e){var t;let s=!1;return"message"===e._&&"messageMediaLiveStream"===(null===(t=null==e?void 0:e.media)||void 0===t?void 0:t._)?e.fromId===H.default.myId?s=!0:Te.isBroadcast(e.peerId)&&(e.fwd_from?Te.isBroadcast(Te.getPeerId(e.fwd_from.from_id))&&(s=!0):s=!0):s=!0,s}getReplyKeyboard(e){return this.getHistoryStorage(e).replyMarkup}mergeReplyKeyboard(e,t){var s,i;let n=t.reply_markup;if(!n&&!(null===(s=t.pFlags)||void 0===s?void 0:s.out)&&!t.action)return!1;if("replyInlineMarkup"===(null==n?void 0:n._))return!1;const a=e.replyMarkup;if(n)return!(a&&a.mid>=t.mid)&&(!n.pFlags.selective&&(e.maxOutId&&t.mid<e.maxOutId&&n.pFlags.single_use&&(n.pFlags.hidden=!0),n.mid=t.mid,"replyKeyboardHide"!==n._&&(n.fromId=Te.getPeerId(t.from_id)),e.replyMarkup=n,!0));if(t.pFlags.out)if(a){if(a.pFlags.single_use&&!a.pFlags.hidden&&(t.mid>a.mid||t.pFlags.is_outgoing)&&t.message)return a.pFlags.hidden=!0,!0}else(!e.maxOutId||t.mid>e.maxOutId)&&(e.maxOutId=t.mid);return!("messageActionChatDeleteUser"!==(null===(i=t.action)||void 0===i?void 0:i._)||!(a?t.action.user_id===a.fromId:ye.isBot(t.action.user_id)))&&(e.replyMarkup={_:"replyKeyboardHide",mid:t.mid,pFlags:{}},!0)}getSearchStorage(e,t){return this.searchesStorage[e]||(this.searchesStorage[e]={}),this.searchesStorage[e][t]||(this.searchesStorage[e][t]={history:[]}),this.searchesStorage[e][t]}getSearchCounters(e,t,s=!0){if(Te.isRestricted(e))return Promise.resolve(t.map(e=>({_:"messages.searchCounter",pFlags:{},filter:e,count:0})));return(s?F.a.invokeApiCacheable:F.a.invokeApi).bind(F.a)("messages.getSearchCounters",{peer:Te.getInputPeerById(e),filters:t})}filterMessagesByInputFilter(e,t,s,i){var n;const a=[];if(!t.length)return a;let o=!0;const r={},l=[],d=[];switch(e){case"inputMessagesFilterPhotos":r.messageMediaPhoto=!0;break;case"inputMessagesFilterPhotoVideo":r.messageMediaPhoto=!0,r.messageMediaDocument=!0,l.push("video");break;case"inputMessagesFilterVideo":r.messageMediaDocument=!0,l.push("video");break;case"inputMessagesFilterDocument":r.messageMediaDocument=!0,d.push("video");break;case"inputMessagesFilterVoice":r.messageMediaDocument=!0,l.push("voice");break;case"inputMessagesFilterRoundVoice":r.messageMediaDocument=!0,l.push("round","voice");break;case"inputMessagesFilterRoundVideo":r.messageMediaDocument=!0,l.push("round");break;case"inputMessagesFilterMusic":r.messageMediaDocument=!0,l.push("audio");break;case"inputMessagesFilterUrl":r.url=!0;break;case"inputMessagesFilterChatPhotos":r.avatar=!0;break;default:o=!1}if(!o)return a;for(let e=0,o=t.length;e<o;++e){const o=s.get(t[e]);if(!o)continue;let c=!1;if("message"===o._){if(o.media&&r[o.media._]){const e=o.media.document;if(e&&(l.length&&!l.includes(e.type)||d.includes(e.type)))continue;c=!0}else if(r.url&&o.message){const e=["messageEntityTextUrl","messageEntityUrl"];((null===(n=o.totalEntities)||void 0===n?void 0:n.find(t=>e.includes(t._)))||N.a.matchUrl(o.message))&&(c=!0)}}else r.avatar&&o.action&&["messageActionChannelEditPhoto","messageActionChatEditPhoto","messageActionChannelEditVideo","messageActionChatEditVideo"].includes(o.action._)&&(c=!0);if(c&&(a.push(o),a.length>=i))break}return a}getSearch({peerId:e,query:t,inputFilter:s,maxId:i,limit:n,nextRate:a,backLimit:o,threadId:r,folderId:l,minDate:d,maxDate:c,lastHistory:h}){if(Te.isRestricted(e))return Promise.resolve({count:0,offset_id_offset:0,next_rate:void 0,history:[]});if(t||(t=""),s||(s={_:"inputMessagesFilterEmpty"}),void 0===n&&(n=20),a||(a=0),o||(o=0),d=d?d/1e3|0:0,c=c?c/1e3|0:0,"inputMessagesFilterTitle"===(null==s?void 0:s._)){const e=e=>e,s=new Set,i=(e,i,n=!1)=>{e.forEach(e=>{if(s.has(e))return;s.add(e);const a=Te.getPeer(e),{dom:o}=Jd.addDialogNew({dialog:e,container:i.list,drawStatus:!1,avatarSize:48,autonomous:i.autonomous});if(n&&(a.participants_count||a.participants)){const s=new RegExp(`(${Object(A.e)(t)}|${Object(A.e)(K(t))})`,"gi");o.titleSpan.innerHTML=o.titleSpan.innerHTML.replace(s,"<i>$1</i>"),o.lastMessageSpan.append(Ts.getChatMembersString(e.toChatId()))}else if(e===H.default.myId)o.lastMessageSpan.append(Object(O.i18n)("Presence.YourChat"));else{let t=Te.getPeerUsername(e);if(t)t="@"+t;else{const s=ye.getUser(e);s&&s.phone&&(t="+"+Object(fe.a)(s.phone).formatted)}o.lastMessageSpan.innerHTML="<i>"+t+"</i>"}}),i.toggle();const a=document.querySelector("#search-container .search-super-content-title");a.append(i.container);const o=a.parentNode.querySelector(".preloader");o&&o.remove()};return ye.searchContacts(t,50).then(e).then(e=>{if(e){const t=new de(!1,"contacts",void 0,void 0,void 0,void 0,close);i(e.results,t,!0);document.querySelector("#search-container .search-super-content-title").append(t.container)}return Promise.resolve({count:0,offset_id_offset:0,next_rate:void 0,history:[]})})}let u=[];o&&(n+=o);let p;if(!e||o||i||t||1===n||r||(p=this.getHistoryStorage(e),u=this.filterMessagesByInputFilter(s._,p.history.slice,this.getMessagesStorage(e),n)),u.length){if(!(u.length<n))return Promise.resolve({count:0,next_rate:0,offset_id_offset:0,history:u});i=u[u.length-1].mid,n-=u.length}else 0;const g=F.a.invokeApi.bind(F.a);let m;if(e&&!a&&void 0===l)m=g("messages.search",{peer:Te.getInputPeerById(e),q:t||"",filter:s,min_date:d,max_date:c,limit:n,offset_id:as.getServerMessageId(i)||0,add_offset:o?-o:0,max_id:0,min_id:0,hash:"",top_msg_id:as.getServerMessageId(r)||0},{noErrorBox:!0});else{let a,o=0,r=0,l=i&&this.getMessageByPeer(e,i);if(l&&l.date&&(r=l.id,a=this.getMessagePeer(l)),h){const e=Ds.getMessageByPeer(h.peerId,h.mid);e&&(r=e.id,a=e.peerId,o=e.date)}let d=0;if(null==s?void 0:s._){let e=!1;if("inputMessagesFilterPrivate"===s._?(d=65536,e=!0):"inputMessagesFilterPublic"===s._?(d=131072,e=!0):"inputMessagesFilterGlobal"===s._&&(d=262144,e=!0),e){const e=document.querySelector("#search-container .sub-search-super-item.active");if(e){const t=e.getAttribute("data-type");switch(t){case"text":d+=1;break;case"image":d+=2;break;case"video":d+=16;break;case"music":d+=32;break;case"file":d+=8}}}}m=g("messages.searchGlobalExt",{flags:d,q:t,offset_date:o,offset_peer:Te.getInputPeerById(a),offset_id:r,limit:n},{noErrorBox:!0})}return m.then(e=>{ye.saveApiUsers(e.users),Pe.saveApiChats(e.chats),this.saveMessages(e.messages),j.b&&this.log("getSearch result:",s,e);const t=e.count||u.length+e.messages.length;return e.messages.forEach(e=>{const t=this.getMessagePeer(e);if(t.isAnyChat()){const e=Pe.getChat(t.toChatId());e.migrated_to&&this.migrateChecks(t,e.migrated_to.channel_id.toPeerId(!0))}u.push(e)}),{count:t,offset_id_offset:e.offset_id_offset||0,next_rate:e.next_rate,history:u}})}subscribeRepliesThread(e,t){const s=e+"_"+t;for(const e in this.threadsToReplies)if(this.threadsToReplies[e]===s)return;this.getDiscussionMessage(e,t)}generateThreadServiceStartMessage(e){const t=e.peerId+"_"+e.mid;if(this.threadsServiceMessagesIdsStorage[t])return;const s=as.getServerMessageId(Math.max(...this.getMidsByMessage(e))),i={_:"messageService",pFlags:{is_single:!0},id:as.generateMessageId(s,!0),date:e.date,from_id:{_:"peerUser",user_id:Z.b},peer_id:e.peer_id,action:{_:"messageActionDiscussionStarted"},reply_to:this.generateReplyHeader(e.id)};this.saveMessages([i],{isOutgoing:!0}),this.threadsServiceMessagesIdsStorage[t]=i.mid}getDiscussionMessage(e,t){return F.a.invokeApiSingle("messages.getDiscussionMessage",{peer:Te.getInputPeerById(e),msg_id:as.getServerMessageId(t)}).then(s=>{var i;Pe.saveApiChats(s.chats),ye.saveApiUsers(s.users),this.saveMessages(s.messages);const n=this.filterMessages(s.messages[0],e=>!!e.replies)[0],a=n.peerId+"_"+n.mid;this.generateThreadServiceStartMessage(n);const o=this.getHistoryStorage(n.peerId,n.mid);return s.max_id=o.maxId=as.generateMessageId(s.max_id)||0,s.read_inbox_max_id=o.readMaxId=as.generateMessageId(null!==(i=s.read_inbox_max_id)&&void 0!==i?i:n.mid),s.read_outbox_max_id=o.readOutboxMaxId=as.generateMessageId(s.read_outbox_max_id)||0,this.threadsToReplies[a]=e+"_"+t,n})}handleNewMessage(e,t){void 0===this.newMessagesToHandle[e]&&(this.newMessagesToHandle[e]=new Set),this.newMessagesToHandle[e].add(t),this.newMessagesHandleTimeout||(this.newMessagesHandleTimeout=window.setTimeout(this.handleNewMessages,0))}scheduleHandleNewDialogs(e,t){return void 0!==e&&(this.newDialogsToHandle[e]=t),this.newDialogsHandlePromise?this.newDialogsHandlePromise:this.newDialogsHandlePromise=new Promise(e=>{setTimeout(()=>{e(),this.newDialogsHandlePromise=void 0,this.handleNewDialogs()},0)})}deleteMessages(e,t,s){var i,n;let a;const o=t.map(e=>as.getServerMessageId(e));if(e.isAnyChat()&&Te.isChannel(e)){const s=e.toChatId(),r=Pe.getChat(s);if(!r.pFlags.creator&&!(null===(n=null===(i=r.admin_rights)||void 0===i?void 0:i.pFlags)||void 0===n?void 0:n.delete_messages)&&!(t=t.filter(t=>!!this.getMessageByPeer(e,t).pFlags.out)).length)return;a=F.a.invokeApi("channels.deleteMessages",{channel:Pe.getChannelInput(s),id:o}).then(e=>{Ie.processLocalUpdate({_:"updateDeleteChannelMessages",channel_id:s,messages:t,pts:e.pts,pts_count:e.pts_count})})}else a=F.a.invokeApi("messages.deleteMessages",{revoke:s,id:o}).then(e=>{Ie.processLocalUpdate({_:"updateDeleteMessages",messages:t,pts:e.pts,pts_count:e.pts_count})});return a}readHistory(e,t=0,s,i=!1){if(this.log("readHistory:",e,t,s),!this.getReadMaxIdIfUnread(e,s)&&!i)return this.log("readHistory: isn't unread"),Promise.resolve();const n=this.getHistoryStorage(e,s);if(n.triedToReadMaxId>=t)return Promise.resolve();let a;return s?(n.readPromise||(a=F.a.invokeApi("messages.readDiscussion",{peer:Te.getInputPeerById(e),msg_id:as.getServerMessageId(s),read_max_id:as.getServerMessageId(t)})),Ie.processLocalUpdate({_:"updateReadChannelDiscussionInbox",channel_id:e.toChatId(),top_msg_id:s,read_max_id:t})):Te.isChannel(e)?(n.readPromise||(a=F.a.invokeApi("channels.readHistory",{channel:Pe.getChannelInput(e.toChatId()),max_id:as.getServerMessageId(t)})),Ie.processLocalUpdate({_:"updateReadChannelInbox",max_id:t,channel_id:e.toChatId(),still_unread_count:void 0,pts:void 0})):(n.readPromise||(a=F.a.invokeApi("messages.readHistory",{peer:Te.getInputPeerById(e),max_id:as.getServerMessageId(t)}).then(e=>{Ie.processUpdateMessage({_:"updateShort",update:{_:"updatePts",pts:e.pts,pts_count:e.pts_count}})})),Ie.processLocalUpdate({_:"updateReadHistoryInbox",max_id:t,peer:Te.getOutputPeer(e),still_unread_count:void 0,pts:void 0,pts_count:void 0})),Cs.soundReset(Te.getPeerString(e)),n.readPromise?n.readPromise:(n.triedToReadMaxId=t,a.finally(()=>{delete n.readPromise;const{readMaxId:i}=n;this.log("readHistory: promise finally",t,i),i>t&&this.readHistory(e,i,s,!0)}),n.readPromise=a)}readAllHistory(e,t,s=!1){const i=this.getHistoryStorage(e,t);i.maxId&&this.readHistory(e,i.maxId,t,s)}fixDialogUnreadMentionsIfNoMessage(e){const t=this.getDialogOnly(e);(null==t?void 0:t.unread_mentions_count)&&this.reloadConversation(e)}modifyCachedMentions(e,t,s){const i=this.unreadMentions[e];i&&(s?i.first.isEnd(Y.Top)&&i.insertSlice([t]):i.delete(t))}goToNextMention(e){var t;const s=this.goToNextMentionPromises[e];if(s)return s;const i=null!==(t=this.unreadMentions[e])&&void 0!==t?t:this.unreadMentions[e]=new X,n=i.length,a=i.first.isEnd(Y.Top);if(!n&&a)return Promise.resolve();let o=Promise.resolve();return!a&&n<25&&(o=this.loadNextMentions(e)),this.goToNextMentionPromises[e]=o.then(()=>{const t=i.last,s=t&&t[t.length-1];s&&(i.delete(s),H.default.dispatchEvent("history_focus",{peerId:e,mid:s}))}).finally(()=>{delete this.goToNextMentionPromises[e]})}loadNextMentions(e){const t=this.unreadMentions[e],s=t.first[0]||1;return this.getUnreadMentions(e,s,-50,50).then(e=>{this.mergeHistoryResult(t,e,1===s?0:s,50,-50)})}getUnreadMentions(e,t,s,i,n=0,a=0){return F.a.invokeApiSingle("messages.getUnreadMentions",{peer:Te.getInputPeerById(e),offset_id:as.getServerMessageId(t),add_offset:s,limit:i,max_id:as.getServerMessageId(n),min_id:as.getServerMessageId(a)}).then(e=>(ye.saveApiUsers(e.users),Pe.saveApiChats(e.chats),this.saveMessages(e.messages),e))}readMessages(e,t){if(!t.length)return Promise.resolve();let s,i;if(t=t.map(e=>as.getServerMessageId(e)),e.isAnyChat()&&Te.isChannel(e)){const n=e.toChatId();i={_:"updateChannelReadMessagesContents",channel_id:n,messages:t},s=F.a.invokeApi("channels.readMessageContents",{channel:Pe.getChannelInput(n),id:t})}else i={_:"updateReadMessagesContents",messages:t,pts:void 0,pts_count:void 0},s=F.a.invokeApi("messages.readMessageContents",{id:t}).then(e=>{i.pts=e.pts,i.pts_count=e.pts_count,Ie.processLocalUpdate(i)});return Ie.processLocalUpdate(i),s}getHistoryStorage(e,t){var s,i;return t?(this.threadsStorage[e]||(this.threadsStorage[e]={}),null!==(s=this.threadsStorage[e][t])&&void 0!==s?s:this.threadsStorage[e][t]={count:null,history:new X}):null!==(i=this.historiesStorage[e])&&void 0!==i?i:this.historiesStorage[e]={count:null,history:new X}}setDialogToStateIfMessageIsTop(e){this.isMessageIsTopMessage(e)&&this.dialogsStorage.setDialogToState(this.getDialogOnly(e.peerId))}isMessageIsTopMessage(e){const t=this.getDialogOnly(e.peerId);return t&&t.top_message===e.mid}updateMessageRepliesIfNeeded(e){try{const t=this.getThreadKey(e);if(t){const e=this.threadsToReplies[t];if(e){const[t,s]=e.split("_");this.updateMessage(t.toPeerId(),+s,"replies_updated")}}}catch(t){this.log.error("incrementMessageReplies err",t,e)}}getThreadKey(e){var t;let s="";if((null===(t=e.peerId)||void 0===t?void 0:t.isAnyChat())&&e.reply_to){const t=e.reply_to.reply_to_top_id||e.reply_to.reply_to_msg_id;s=e.peerId+"_"+t}return s}updateMessage(e,t,s){return this.wrapSingleMessage(e,t,!0).then(()=>{const i=this.getMessageByPeer(e,t);return s&&H.default.dispatchEvent(s,i),i})}checkPendingMessage(e){const t=this.pendingByMessageId[e.mid];let s;if(t){const i=this.pendingByRandomId[t];(s=this.finalizePendingMessage(t,e))&&H.default.dispatchEvent("history_update",{storage:i.storage,peerId:e.peerId,mid:e.mid}),delete this.pendingByMessageId[e.mid]}return s}mutePeer(e,t){const s={_:"inputPeerNotifySettings"};return void 0===t&&(t=!Cs.isPeerLocalMuted(e,!1)),s.mute_until=t?Z.a:0,Cs.updateNotifySettings({_:"inputNotifyPeer",peer:Te.getInputPeerById(e)},s)}canSendToPeer(e,t,s="send_messages"){if(Te.isRestricted(e))return!1;if(e.isAnyChat()){const i=Pe.getChat(e.toChatId());return Pe.hasRights(e.toChatId(),s,void 0,!!t)&&(!i.pFlags.left||!!t)}return ye.canSendToUser(e)}finalizePendingMessage(e,t){const s=this.pendingByRandomId[e];if(s){const{peerId:i,tempId:n,threadId:a,storage:o}=s;[this.getHistoryStorage(i),a?this.getHistoryStorage(i,a):void 0].filter(Boolean).forEach(e=>{e.history.delete(n)});const r=this.getMessageFromStorage(o,n);return r.deleted||(delete t.pFlags.is_outgoing,delete t.pending,delete t.error,delete t.random_id,delete t.send),H.default.dispatchEvent("messages_pending"),delete this.pendingByRandomId[e],this.finalizePendingMessageCallbacks(o,n,t),r}}finalizePendingMessageCallbacks(e,t,s){const i=this.tempFinalizeCallbacks[t];if(void 0!==i){for(const e in i){const{deferred:t,callback:n}=i[e];n(s).then(t.resolve,t.reject)}delete this.tempFinalizeCallbacks[t]}if(s.media){const{photo:e,document:i}=s.media;if(e){const s=Dt.getPhoto(""+t);if(s){const t=e.sizes[e.sizes.length-1],i=st.getCacheContext(e,t.type),n=st.getCacheContext(s,"full");Object.assign(i,n);const a=e.sizes[e.sizes.length-1],o=ze(Dt.getPhotoDownloadOptions(e,a).location);st.fakeDownload(o,n.url)}}else if(i){const e=es.getDoc(""+t);if(e&&e.type&&"sticker"!==e.type&&"image/gif"!==e.mime_type){const t=st.getCacheContext(i),s=st.getCacheContext(e);Object.assign(t,s);const n=es.getInputFileName(i);st.fakeDownload(n,s.url)}}else s.media.poll&&(delete Ls.polls[t],delete Ls.results[t])}const n=this.getMessageFromStorage(e,t);e.delete(t),this.handleReleasingMessage(n,e),H.default.dispatchEvent("message_sent",{storage:e,tempId:t,tempMessage:n,mid:s.mid,message:s})}incrementMaxSeenId(e){if(!e||this.maxSeenId&&!(e>this.maxSeenId))return!1;this.maxSeenId=e,ve.default.pushToState("maxSeenMsgId",e)}incrementMessageViews(e,t){if(t.length)return F.a.invokeApiSingle("messages.getMessagesViews",{flags:0,peer:Te.getInputPeerById(e),id:t.map(e=>as.getServerMessageId(e)),increment:!0}).then(s=>{const i=new Array(t.length),n=e.toChatId();for(let e=0,a=t.length;e<a;++e)i[e]={_:"updateChannelMessageViews",channel_id:n,id:t[e],views:s.views[e].views};Ie.processUpdateMessage({_:"updates",updates:i,chats:s.chats,users:s.users})})}notifyAboutMessage(e,t={}){var s;const i=this.getMessagePeer(e);if(Te.isRestricted(i))return;const n={},a=Te.getPeerString(i);let o;o=(null===(s=null==t?void 0:t.peerTypeNotifySettings)||void 0===s?void 0:s.show_previews)?"message"===e._&&e.fwd_from&&t.fwdCount?O.default.format("Notifications.Forwarded",!0,[t.fwdCount]):this.wrapMessageForReply(e,void 0,void 0,!0):O.default.format("Notifications.New",!0),n.title=Te.getPeerTitle(i,!0),i.isAnyChat()&&e.fromId!==e.peerId&&(n.title=Te.getPeerTitle(e.fromId,!0)+" @ "+n.title),n.title=N.a.wrapPlainText(n.title),n.onclick=()=>{H.default.dispatchEvent("history_focus",{peerId:i,mid:e.mid})},n.message=o,n.key="msg"+e.mid,n.tag=a,n.silent=!0;const r=Te.getPeerPhoto(i);r?jt.loadAvatar(i,r,"photo_small").loadPromise.then(t=>{e.pFlags.unread&&(n.image=t,Cs.notify(n))}):Cs.notify(n)}getScheduledMessagesStorage(e){var t;return null!==(t=this.scheduledMessagesStorage[e])&&void 0!==t?t:this.scheduledMessagesStorage[e]=this.createMessageStorage()}getScheduledMessageByPeer(e,t){return this.getMessageFromStorage(this.getScheduledMessagesStorage(e),t)}getScheduledMessages(e){if(!this.canSendToPeer(e))return Promise.resolve([]);const t=this.getScheduledMessagesStorage(e);return t.size?Promise.resolve([...t.keys()]):F.a.invokeApiSingle("messages.getScheduledHistory",{peer:Te.getInputPeerById(e),hash:""}).then(t=>{if("messages.messagesNotModified"!==t._){ye.saveApiUsers(t.users),Pe.saveApiChats(t.chats);const s=this.getScheduledMessagesStorage(e);return this.saveMessages(t.messages,{storage:s,isScheduled:!0}),[...s.keys()]}return[]})}sendScheduledMessages(e,t){return F.a.invokeApi("messages.sendScheduledMessages",{peer:Te.getInputPeerById(e),id:t.map(e=>as.getServerMessageId(e))}).then(e=>{Ie.processUpdateMessage(e)})}deleteScheduledMessages(e,t){return F.a.invokeApi("messages.deleteScheduledMessages",{peer:Te.getInputPeerById(e),id:t.map(e=>as.getServerMessageId(e))}).then(e=>{Ie.processUpdateMessage(e)})}getMessageWithReplies(e){if(e.peerId===Z.c||(e=this.filterMessages(e,e=>!!e.replies)[0])&&e.replies&&e.replies.pFlags.comments&&"777"!==e.replies.channel_id)return e}isFetchIntervalNeeded(e){return e.isAnyChat()&&!Pe.isInChat(e.toChatId())}isRestricted(e){return!(!e.restriction_reason||!ge(e.restriction_reason))}getNewHistory(e,t){var s;return Fs(this,void 0,void 0,(function*(){if(!this.isFetchIntervalNeeded(e))return;const i=this.getHistoryStorage(e,t),n=i.history.slice;if(!n.isEnd(Y.Bottom))return;delete i.maxId,n.unsetEnd(Y.Bottom);let a=this.getHistory(e,null!==(s=n[0])&&void 0!==s?s:1,0,50,t);a instanceof Promise&&(a=yield a);for(let t=0,s=a.history.length;t<s;++t)this.handleNewMessage(e,a.history[t]);return i}))}getHistory(e,t=0,s,i,n){const a=this.getHistoryStorage(e,n);if(Te.isRestricted(e)){const e=a.history.first;e.setEnd(Y.Both);const t=e.slice(0,0);return t.setEnd(Y.Both),{count:0,history:t,offsetIdOffset:0}}let o=0;i&&(o=-i,s+=i);const r=a.history.sliceMe(t,o,s);return!r||r.slice.length!==s&&(r.fulfilled&Y.Both)!==Y.Both?this.fillHistoryStorage(e,t,s,o,a,n).then(()=>{const e=a.history.sliceMe(t,o,s);return{count:a.count,history:(null==e?void 0:e.slice)||a.history.constructSlice(),offsetIdOffset:(null==e?void 0:e.offsetIdOffset)||a.count}}):{count:a.count,history:r.slice,offsetIdOffset:r.offsetIdOffset}}isHistoryResultEnd(e,t,s){const{offset_id_offset:i,messages:n}=e,a=e.count||n.length,o=i||0,r=s<0?t+s:t;return{count:a,offsetIdOffset:o,isTopEnd:o>=a-r||a<r,isBottomEnd:!o||s<0&&o+s<=0}}mergeHistoryResult(e,t,s,i,n){const{messages:a}=t,o=this.isHistoryResultEnd(t,i,n),{count:r,offsetIdOffset:l,isTopEnd:d,isBottomEnd:c}=o,h=a.map(e=>e.mid);if(s&&as.getServerMessageId(s)&&!h.includes(s)&&l<r){let e=0;for(const t=h.length;e<t&&!(s>h[e]);++e);h.splice(e,0,s)}const u=e.insertSlice(h)||e.slice;return d&&u.setEnd(Y.Top),c&&u.setEnd(Y.Bottom),Object.assign({slice:u,mids:h,messages:a},o)}fillHistoryStorage(e,t,s,i,n,a){return this.requestHistory(e,t,s,i,void 0,a).then(a=>{const{count:o,isBottomEnd:r,slice:l,messages:d}=this.mergeHistoryResult(n.history,a,t,s,i);n.count=o;for(let t=0,s=d.length;t<s;++t){const s=d[t];this.mergeReplyKeyboard(n,s)&&H.default.dispatchEvent("history_reply_markup",{peerId:e})}r&&(n.maxId=l[0])})}requestHistory(e,t,s=0,i=0,n=0,a=0){const o={peer:Te.getInputPeerById(e),offset_id:as.getServerMessageId(t)||0,offset_date:n,add_offset:i,limit:s,max_id:0,min_id:0,hash:0};a&&(o.msg_id=as.getServerMessageId(a)||0);return F.a.invokeApiSingle(a?"messages.getReplies":"messages.getHistory",o,{noErrorBox:!0}).then(o=>{j.b&&this.log("requestHistory result:",e,o,t,s,i),ye.saveApiUsers(o.users),Pe.saveApiChats(o.chats),this.saveMessages(o.messages),Te.isChannel(e)&&Ie.addChannelState(e.toChatId(),o.pts);let r=o.messages.length,l=o.count;r&&o.messages[r-1].deleted&&(o.messages.splice(r-1,1),r--,l--);const d=this.getHistoryStorage(e,a),c=o.messages[r-1];if(r&&c.grouped_id){const t=d.history.findSlice(c.mid);if(t&&t.slice.length+o.messages.length<l)return this.requestHistory(e,c.mid,10,0,n,a).then(e=>o)}return o},t=>{switch(t.type){case"CHANNEL_PRIVATE":let t=Pe.getChat(e.toChatId());t={_:"channelForbidden",access_hash:t.access_hash,title:t.title},Ie.processUpdateMessage({_:"updates",updates:[{_:"updateChannel",channel_id:e.toChatId()}],chats:[t],users:[]})}throw t})}fetchSingleMessages(){return this.fetchSingleMessagesPromise?this.fetchSingleMessagesPromise:this.fetchSingleMessagesPromise=new Promise(e=>{setTimeout(()=>{const t=[];for(const[e,s]of this.needSingleMessages){const i=[...s.keys()],n=i.map(e=>({_:"inputMessageID",id:as.getServerMessageId(e)}));let a;a=e.isAnyChat()&&Te.isChannel(e)?F.a.invokeApiSingle("channels.getMessages",{channel:Pe.getChannelInput(e.toChatId()),id:n}):F.a.invokeApiSingle("messages.getMessages",{id:n});const o=a.then(e=>{ye.saveApiUsers(e.users),Pe.saveApiChats(e.chats),this.saveMessages(e.messages);for(let t=0;t<e.messages.length;++t){const i=e.messages[t],n=as.generateMessageId(i.id);s.get(n).resolve(e.messages[t]),s.delete(n)}if(s.size)for(const[e,t]of s)t.resolve(this.generateEmptyMessage(e))}).finally(()=>{H.default.dispatchEvent("messages_downloaded",{peerId:e,mids:i})});t.push(o)}this.needSingleMessages.clear(),Promise.all(t).finally(()=>{this.fetchSingleMessagesPromise=null,this.needSingleMessages.size&&this.fetchSingleMessages(),e()})},0)})}wrapSingleMessage(e,t,s=!1){const i=this.getMessageByPeer(e,t);if(i.deleted||s){let s=this.needSingleMessages.get(e);s||this.needSingleMessages.set(e,s=new Map);let i=s.get(t);return i||(i=Object(w.a)(),s.set(t,i),this.fetchSingleMessages(),i)}return H.default.dispatchEvent("messages_downloaded",{peerId:e,mids:[t]}),Promise.resolve(i)}fetchMessageReplyTo(e){if(!e.reply_to_mid)return Promise.resolve(this.generateEmptyMessage(0));const t=e.reply_to.reply_to_peer_id?Te.getPeerId(e.reply_to.reply_to_peer_id):e.peerId;return this.wrapSingleMessage(t,e.reply_to_mid).then(t=>(t.deleted&&delete e.reply_to_mid,t))}setTyping(e,t){let s=this.typings[e];return H.default.myId&&e&&this.canSendToPeer(e)&&e!==H.default.myId&&(null==s?void 0:s.type)!==t._?((null==s?void 0:s.timeout)&&clearTimeout(s.timeout),s=this.typings[e]={type:t._},F.a.invokeApi("messages.setTyping",{peer:Te.getInputPeerById(e),action:t}).finally(()=>{s===this.typings[e]&&(s.timeout=window.setTimeout(()=>{delete this.typings[e]},6e3))})):Promise.resolve(!1)}handleReleasingMessage(e,t){const s=e.media;if(s){const i=s.webpage||s,n=i.photo||i.document;if((null==n?void 0:n.file_reference)&&B.deleteContext(n.file_reference,{type:"message",peerId:e.peerId,messageId:e.mid}),"webpage"in s&&s.webpage){const i=this.getScheduledMessagesStorage(e.peerId)===t,n=Os.getMessageKeyForPendingWebPage(e.peerId,e.mid,i);Os.deleteWebPageFromPending(s.webpage,n)}s.poll&&Ls.updatePollToMessage(e,!1)}}handleDeletedMessages(e,t,s){const i={count:0,unread:0,unreadMentions:0,msgs:new Set};for(const n of s){const s=this.getMessageFromStorage(t,n);if(s.deleted){this.fixDialogUnreadMentionsIfNoMessage(e);continue}this.handleReleasingMessage(s,t),this.updateMessageRepliesIfNeeded(s),s.pFlags.out||s.pFlags.is_outgoing||!s.pFlags.unread||(++i.unread,Cs.cancel("msg"+n),s.pFlags.mentioned&&(++i.unreadMentions,this.modifyCachedMentions(e,n,!1))),++i.count,i.msgs.add(n),s.deleted=!0;const a=s.grouped_id;if(a){const e=this.groupedMessagesStorage[a];e&&(e.delete(n),i.albums||(i.albums={}),(i.albums[a]||(i.albums[a]=new Set)).add(n),e.size||(delete i.albums,delete this.groupedMessagesStorage[a]))}t.delete(n);const o=this.newMessagesToHandle[e];o&&o.has(n)&&o.delete(n)}if(i.albums)for(const t in i.albums)H.default.dispatchEvent("album_edit",{peerId:e,groupId:t,deletedMids:[...i.albums[t]]});return i}handleEditedMessage(e,t){var s;if("message"===e._&&(null===(s=e.media)||void 0===s?void 0:s.webpage)){const t=Os.getMessageKeyForPendingWebPage(e.peerId,e.mid,!!e.pFlags.is_scheduled);Os.deleteWebPageFromPending(e.media.webpage,t)}}getMediaFromMessage(e){return e.action?e.action.photo:e.media&&(e.media.photo||e.media.document||e.media.webpage&&(e.media.webpage.document||e.media.webpage.photo))}isMentionUnread(e){var t;const s=null===(t=e.media)||void 0===t?void 0:t.document;return e.pFlags.media_unread&&e.pFlags.mentioned&&(!s||!["voice","round"].includes(s.type))}getDialogUnreadCount(e){return e.unread_count||+!!e.pFlags.unread_mark}isDialogUnread(e){return!!this.getDialogUnreadCount(e)}canForward(e){return!e.pFlags.noforwards&&!Te.noForwards(e.peerId)}};j.a.appMessagesManager=Ds;var js=Ds;const Rs=[...je].concat([...Ue]);var Bs=new Set(Rs);function Us(e){Object(a.e)(e.history,(t,s,i)=>{t.action.photo||(i.splice(s,1),void 0!==e.count&&--e.count)})}class Ns{constructor(e){this.previous=[],this.next=[],this.reverse=!1,this.loadCount=50,this.loadWhenLeft=20,this.loadedAllUp=!1,this.loadedAllDown=!1,Object(m.g)(this,e)}setTargets(e,t,s){this.previous=e,this.next=t,this.reverse=s}get index(){return void 0!==this.count?this.previous.length:-1}reset(e=!1){this.current=void 0,this.previous=[],this.next=[],this.loadedAllUp=this.loadedAllDown=e,this.loadPromiseUp=this.loadPromiseDown=null}go(e,t=!0){let s,i;if(e>0){if(s=this.next.splice(0,e),i=s.pop(),!i)return;this.previous.push(this.current,...s)}else{if(s=this.previous.splice(this.previous.length+e,-e),i=s.shift(),!i)return;this.next.unshift(...s,this.current)}return this.next.length<this.loadWhenLeft&&this.load(!this.reverse),this.previous.length<this.loadWhenLeft&&this.load(this.reverse),this.current=i,t&&this.onJump&&this.onJump(i,e>0),this.current}load(e){if(e&&this.loadedAllDown)return Promise.resolve();if(!e&&this.loadedAllUp)return Promise.resolve();if(e&&this.loadPromiseDown)return this.loadPromiseDown;if(!e&&this.loadPromiseUp)return this.loadPromiseUp;let t;t=e?this.reverse?this.previous[0]:this.next[this.next.length-1]:this.reverse?this.next[this.next.length-1]:this.previous[0];const s=this.loadMore(t,e,this.loadCount).then(t=>{if(e&&this.loadPromiseDown!==s||!e&&this.loadPromiseUp!==s)return;t.items.length<this.loadCount&&(e?this.loadedAllDown=!0:this.loadedAllUp=!0),void 0===this.count&&(this.count=t.count||t.items.length);(e?t.items.forEach.bind(t.items):a.e.bind(null,t.items))(t=>{const s=this.processItem?this.processItem(t):t;s&&(e?this.reverse?this.previous.unshift(s):this.next.push(s):this.reverse?this.next.push(s):this.previous.unshift(s))}),this.onLoadedMore&&this.onLoadedMore()},()=>{}).then(()=>{e?this.loadPromiseDown=null:this.loadPromiseUp=null});return e?this.loadPromiseDown=s:this.loadPromiseUp=s,s}}class Hs extends Ns{constructor(e={}){super(Object.assign(Object.assign({},e),{loadMore:(e,t,s)=>{var i;const n=t?0:s;let a=null===(i=this.current)||void 0===i?void 0:i.mid;return e&&(a=e.mid),t||(a=as.incrementMessageId(a,1)),js.getSearch(Object.assign(Object.assign({},this.searchContext),{peerId:this.searchContext.peerId||(null==e?void 0:e.peerId),maxId:a,limit:n?0:s,backLimit:n})).then(e=>("inputMessagesFilterChatPhotos"===this.searchContext.inputFilter._&&Us(e),e.next_rate&&(this.searchContext.nextRate=e.next_rate),{count:e.count,items:e.history}))},processItem:t=>{if(this.filterMids([t.mid]).length)return e.processItem(t)}})),this.onHistoryDelete=({peerId:e,msgs:t})=>{const s=s=>s.peerId===e&&t.has(s.mid),i=(e,t,i)=>{s(e)&&i.splice(t,1)};Object(a.e)(this.previous,i),Object(a.e)(this.next,i),this.current&&s(this.current)&&this.onEmptied&&this.onEmptied()},this.onHistoryMultiappend=e=>{if(void 0!==this.searchContext.folderId)return;if(!this.loadedAllUp||this.loadPromiseUp)return;const t=e[this.searchContext.peerId];if(!t)return;const s=Array.from(t).sort((e,t)=>e-t),i=this.filterMids(s).map(e=>this.processItem(e)).filter(Boolean);i.length&&this.next.push(...i)},this.onMessageSent=({message:e})=>{this.onHistoryMultiappend({[e.peerId]:new Set([e.mid])})},H.default.addEventListener("history_delete",this.onHistoryDelete),H.default.addEventListener("history_multiappend",this.onHistoryMultiappend),H.default.addEventListener("message_sent",this.onMessageSent)}filterMids(e){const t=this.searchContext.isScheduled?js.getScheduledMessagesStorage(this.searchContext.peerId):js.getMessagesStorage(this.searchContext.peerId);return js.filterMessagesByInputFilter(this.searchContext.inputFilter._,e,t,e.length)}setSearchContext(e){this.searchContext=e,void 0!==this.searchContext.folderId&&(this.loadedAllUp=!0,void 0===this.searchContext.nextRate&&(this.loadedAllDown=!0)),"inputMessagesFilterChatPhotos"===this.searchContext.inputFilter._&&(this.loadedAllUp=!0),this.searchContext.useSearch||(this.loadedAllDown=this.loadedAllUp=!0)}reset(){super.reset(),this.searchContext=void 0}cleanup(){this.reset(),H.default.removeEventListener("history_delete",this.onHistoryDelete),H.default.removeEventListener("history_multiappend",this.onHistoryMultiappend),H.default.removeEventListener("message_sent",this.onMessageSent),this.onEmptied=void 0}}var zs=s(168),Ws=s(146);class qs{constructor(e,t){this.prevValue="",this.timeout=0,this.onInput=()=>{if(!this.onChange)return;let e=this.value;e!==this.prevValue&&(this.prevValue=e,clearTimeout(this.timeout),this.timeout=window.setTimeout(()=>{this.onChange(e)},200))},this.onClearClick=()=>{this.value="",this.onChange&&this.onChange(""),this.onClear&&this.onClear()},this.inputField=new Ws.b({placeholder:e,plainText:!0}),this.container=this.inputField.container,this.container.classList.remove("input-field"),this.container.classList.add("input-search"),this.onChange=t,this.input=this.inputField.input,this.input.classList.add("input-search-input");const s=document.createElement("i");s.classList.add("tgico","tgico-search"),this.clearBtn=document.createElement("i"),this.clearBtn.classList.add("tgico","btn-icon","tgico-close"),this.input.addEventListener("input",this.onInput),this.clearBtn.addEventListener("click",this.onClearClick),this.container.append(s,this.clearBtn)}get value(){return this.inputField.value}set value(e){this.prevValue=e,clearTimeout(this.timeout),this.inputField.value=e}remove(){clearTimeout(this.timeout),this.input.removeEventListener("input",this.onInput),this.clearBtn.removeEventListener("click",this.onClearClick)}}var Vs=s(193);class Gs{constructor(){this.listeners=new Set}add(e){return(t,s,i)=>{const n={element:e,event:t,callback:s,options:i};return this.addManual(n),n}}addManual(e){var t;e.element.addEventListener(e.event,e.callback,e.options),(null===(t=e.options)||void 0===t?void 0:t.once)&&(e.onceCallback=()=>{this.remove(e),e.onceFired=!0},e.element.addEventListener(e.event,e.onceCallback,e.options)),this.listeners.add(e)}remove(e){e.onceFired||(e.element.removeEventListener(e.event,e.callback,e.options),e.onceCallback&&e.element.removeEventListener(e.event,e.onceCallback,e.options)),this.listeners.delete(e)}removeManual(e,t,s,i){let n;for(const a of this.listeners)if(a.element===e&&a.event===t&&a.callback===s&&a.options===i){n=a;break}n&&this.remove(n)}removeAll(){this.listeners.forEach(e=>{this.remove(e)})}}var Ks=s(141);var Qs=(e,t={})=>Object(Ks.a)("btn-icon",Object.assign({icon:e||void 0},t)),$s=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class Ys{constructor(e,t){this._constructor(e,t)}_constructor(e,t=!0){this.slider=e,this.middlewareHelper=e?e.getMiddleware().create():Ke(),this.destroyable=t,this.container=document.createElement("div"),this.container.classList.add("tabs-tab","sidebar-slider-item"),this.header=document.createElement("div"),this.header.classList.add("sidebar-header"),this.closeBtn=Qs("left sidebar-close-button",{noRipple:!0}),this.title=document.createElement("div"),this.title.classList.add("sidebar-header__title"),this.header.append(this.closeBtn,this.title),this.content=document.createElement("div"),this.content.classList.add("sidebar-content"),this.scrollable=new re.b(this.content,void 0,void 0,!0),this.container.append(this.header,this.content),this.slider.addTab(this),this.listenerSetter=new Gs}close(){return this.slider.closeTab(this)}open(...e){return $s(this,void 0,void 0,(function*(){if(this.init)try{const t=this.init(...e);this.init=null,t instanceof Promise&&(yield t)}catch(e){console.error("open tab error",e)}this.slider.selectTab(this)}))}init(...e){}onCloseAfterTimeout(){var e,t;this.destroyable&&(this.slider.tabs.delete(this),this.container.remove(),null===(e=this.listenerSetter)||void 0===e||e.removeAll(),null===(t=this.middlewareHelper)||void 0===t||t.destroy())}setTitle(e){this.title.innerHTML="",this.title.append(Object(O.i18n)(e))}}class Xs extends Ys{constructor(e){super(e),this.eventListener=new Mt.a}onClose(){this.eventListener.dispatchEvent("close")}onCloseAfterTimeout(){const e=this.eventListener.dispatchResultableEvent("destroy");return this.eventListener.dispatchEvent("destroyAfter",Promise.all(e).then(we.a,we.a)),this.eventListener.cleanup(),super.onCloseAfterTimeout()}}class Zs{constructor(e){this.historyTabIds=[],this.canHideFirst=!1,this.onCloseBtnClick=()=>{Nt.a.findItemByType(this.navigationType)?Nt.a.back(this.navigationType):this.historyTabIds.length&&this.closeTab(this.historyTabIds[this.historyTabIds.length-1])},this.closeTab=(e,t,s)=>{if(void 0!==e&&this.historyTabIds[this.historyTabIds.length-1]!==e)return!1;const i=this.historyTabIds.pop();this.onCloseTab(i,t,s);const n=this.historyTabIds[this.historyTabIds.length-1];return this._selectTab(void 0!==n?n instanceof Ys?n.container:n:this.canHideFirst?-1:0,t),!0},Object(m.g)(this,e),this.tabs||(this.tabs=new Map),this.tabsContainer=this.sidebarEl.querySelector(".sidebar-slider"),this._selectTab=Object(Vs.a)(this.tabsContainer,"navigation",250),this.canHideFirst||this._selectTab(0),Array.from(this.sidebarEl.querySelectorAll(".sidebar-close-button")).forEach(e=>{Object(v.b)(e,this.onCloseBtnClick)}),this.middlewareHelper=Ke()}getMiddleware(){return this.middlewareHelper.get()}selectTab(e){if(this.historyTabIds[this.historyTabIds.length-1]===e)return!1;const t=e instanceof Ys?e:this.tabs.get(e);return t&&(t.onOpen&&t.onOpen(),t.onOpenAfterTimeout&&setTimeout(()=>{t.onOpenAfterTimeout()},250)),Nt.a.pushItem({type:this.navigationType,onPop:e=>(this.closeTab(void 0,e,!0),!0)}),this.historyTabIds.push(e),this._selectTab(e instanceof Ys?e.container:e),!0}removeTabFromHistory(e){Object(a.f)(this.historyTabIds,e),this.onCloseTab(e,void 0)}sliceTabsUntilTab(e,t){for(let s=this.historyTabIds.length-1;s>=0;--s){const i=this.historyTabIds[s];if(i!==t){if(i instanceof e)break;this.removeTabFromHistory(i)}}}getTab(e){return this.historyTabIds.find(t=>t instanceof e)}isTabExists(e){return!!this.getTab(e)}onCloseTab(e,t,s){var i;s||Nt.a.removeByType(this.navigationType,!0);const n=e instanceof Ys?e:this.tabs.get(e);if(n){try{null===(i=n.onClose)||void 0===i||i.call(n)}catch(e){console.error("tab onClose error",n)}n.onCloseAfterTimeout&&setTimeout(()=>{n.onCloseAfterTimeout()},280)}}addTab(e){e.container.parentElement||(this.tabsContainer.append(e.container),e.closeBtn&&e.closeBtn.addEventListener("click",this.onCloseBtnClick))}createTab(e,t=!0,s){return new e(s?void 0:this,t)}}var Js=function(e,t){let s,i,n,a={},o=200,r=200,l=0,d=0,c=0,h=0,u=0,p=-1;const g=[];function m(){e.classList.add("crop-blur"),e.draggable=!1,n=new Image,n.src=e.src,n.draggable=!1,n.classList.add("crop-overlay-image"),t||(t=document.createElement("canvas")),s=document.createElement("div"),s.classList.add("crop-component"),i=document.createElement("div"),i.classList.add("crop-overlay");const a=document.createElement("div");a.classList.add("crop-overlay-color"),s.appendChild(i);e.parentNode.appendChild(s),s.appendChild(n),s.appendChild(e),s.appendChild(a),i.appendChild(n),n.style.maxWidth=e.width+"px",u=e.naturalWidth/e.offsetWidth;const l=e.offsetWidth/2-o/2,d=e.offsetHeight/2-r/2;f(o,r),v(l,d),b(l,d),s.addEventListener("mousedown",I,!1),s.addEventListener("touchstart",I,!1),s.addEventListener("wheel",S,!1),C.IS_MOBILE&&s.addEventListener("pointerdown",L,!1),document.addEventListener("keypress",w,!1)}function f(e,t){c=e*u,h=t*u,i.style.width=e+"px",i.style.height=t+"px"}function v(e,t){d=t*u,l=e*u,n.style.top=-t+"px",n.style.left=-e+"px"}function b(e,t){i.style.top=t+"px",i.style.left=e+"px"}function y(e){e=e*Math.PI*2;let t,s,a,o,r=Math.floor(i.clientWidth+e),l=Math.floor(i.clientHeight+e),d=n.clientWidth,c=n.clientHeight;r<50||r>d||(t=i.offsetLeft-e/2,s=i.offsetTop-e/2,a=t+r,o=s+l,t<0&&(t=0),s<0&&(s=0),a>d||o>c||(f(r,r),v(t,s),b(t,s)))}function w(e){switch(e.preventDefault(),String.fromCharCode(e.charCode)){case"+":y(4);break;case"-":y(-4)}}function S(e){e.preventDefault(),y(e.deltaY>0?1:-1)}function I(e){e.preventDefault(),e.stopPropagation(),function(e){a.container_width=i.offsetWidth,a.container_height=i.offsetHeight,a.container_left=i.offsetLeft,a.container_top=i.offsetTop,a.mouse_x=(e.clientX||e.pageX||e.touches&&e.touches[0].clientX)+window.scrollX,a.mouse_y=(e.clientY||e.pageY||e.touches&&e.touches[0].clientY)+window.scrollY}(e),document.addEventListener("mousemove",P),document.addEventListener("touchmove",P),document.addEventListener("mouseup",M),document.addEventListener("touchend",M)}function M(e){e.preventDefault(),document.removeEventListener("mouseup",M),document.removeEventListener("touchend",M),document.removeEventListener("mousemove",P),document.removeEventListener("touchmove",P)}function P(e){let t,s,o,r,l={x:0,y:0};e.preventDefault(),e.stopPropagation(),l.x=e.pageX||e.touches&&e.touches[0].pageX,l.y=e.pageY||e.touches&&e.touches[0].pageY,t=l.x-(a.mouse_x-a.container_left),s=l.y-(a.mouse_y-a.container_top),o=i.offsetWidth,r=i.offsetHeight,t<0?t=0:t>n.offsetWidth-o&&(t=n.offsetWidth-o),s<0?s=0:s>n.offsetHeight-r&&(s=n.offsetHeight-r),v(t,s),b(t,s)}function L(e){e.stopPropagation(),s.addEventListener("pointermove",E,!1),s.addEventListener("pointerup",_,!1),s.addEventListener("pointercancel",_,!1),s.addEventListener("pointerout",_,!1),s.addEventListener("pointerleave",_,!1),g.push(e),2===g.length&&(p=Math.floor(Math.hypot(g[0].clientX-g[1].clientX,g[0].clientY-g[1].clientY)))}function E(e){e.stopPropagation();const t=g.findIndex(t=>t.pointerId===e.pointerId);if(g[t]=e,2===g.length){const e=Math.floor(Math.hypot(g[0].clientX-g[1].clientX,g[0].clientY-g[1].clientY));p>0&&(e>p&&y(.25),e<p&&y(-.25)),p=e}}function _(e){e.stopPropagation(),function(e){const t=g.findIndex(t=>t.pointerId===e.pointerId);g.splice(t,1)}(e),g.length<2&&(s.removeEventListener("pointermove",E,!1),p=-1),0===g.length&&(s.removeEventListener("pointerup",_,!1),s.removeEventListener("pointercancel",_,!1),s.removeEventListener("pointerout",_,!1),s.removeEventListener("pointerleave",_,!1))}return C.IS_MOBILE&&(o=100,r=100),e.complete?m():e.onload=m,{crop:function(){t.width=c,t.height=h,t.getContext("2d").drawImage(e,l,d,c,h,0,0,c,h)},removeHandlers:function(){s.removeEventListener("mousedown",I),s.removeEventListener("touchstart",I),s.removeEventListener("wheel",S),document.removeEventListener("mouseup",M),document.removeEventListener("touchend",M),document.removeEventListener("mousemove",P),document.removeEventListener("touchmove",P),document.removeEventListener("keypress",w),C.IS_MOBILE&&(s.removeEventListener("pointerdown",L,!1),s.removeEventListener("pointermove",E,!1),s.removeEventListener("pointerup",_,!1),s.removeEventListener("pointercancel",_,!1),s.removeEventListener("pointerout",_,!1),s.removeEventListener("pointerleave",_,!1)),s.remove(),i.remove(),n.remove()}}},ei=s(117),ti=s(81),si=s(85);function ii(e){if("Enter"===e.key&&!C.IS_MOBILE&&!e.isComposing){if("enter"===H.default.settings.sendShortcut){if(e.shiftKey||e.ctrlKey||e.metaKey)return;return!0}{const t=C.IS_APPLE?e.metaKey:e.ctrlKey;if(e.shiftKey||(C.IS_APPLE?e.ctrlKey:e.metaKey))return;if(t)return!0}}return!1}class ni extends Mt.a{constructor(e,t,s={}){super(!1),this.buttons=t,this.element=document.createElement("div"),this.container=document.createElement("div"),this.header=document.createElement("div"),this.title=document.createElement("div"),this.onEscape=()=>!0,this.hide=()=>{Nt.a.back("popup")},this.destroy=()=>{this.dispatchEvent("close"),this.element.classList.add("hiding"),this.element.classList.remove("active"),this.listenerSetter.removeAll(),this.middlewareHelper.destroy(),H.default.isOverlayActive=!1,Nt.a.removeItem(this.navigationItem),this.navigationItem=void 0,setTimeout(()=>{this.element.remove(),this.dispatchEvent("closeAfterTimeout"),this.cleanup(),zs.a.checkAnimations(!1)},150)},this.element.classList.add("popup"),this.element.className="popup"+(e?" "+e:""),this.container.classList.add("popup-container","z-depth-1"),this.header.classList.add("popup-header"),this.title.classList.add("popup-title"),this.header.append(this.title),this.middlewareHelper=Ke(),this.listenerSetter=new Gs,this.confirmShortcutIsSendShortcut=s.confirmShortcutIsSendShortcut,s.closable&&(this.btnClose=document.createElement("span"),this.btnClose.classList.add("btn-icon","popup-close","tgico-close"),this.header.prepend(this.btnClose),Object(v.b)(this.btnClose,this.hide,{listenerSetter:this.listenerSetter,once:!0})),s.overlayClosable&&Object(v.b)(this.element,e=>{Object(ti.a)(e.target,"popup-container")||this.hide()},{listenerSetter:this.listenerSetter}),s.withConfirm&&(this.btnConfirm=document.createElement("button"),this.btnConfirm.classList.add("btn-primary","btn-color-primary"),!0!==s.withConfirm&&this.btnConfirm.append(Object(O.i18n)(s.withConfirm)),this.header.append(this.btnConfirm),Object(ei.ripple)(this.btnConfirm)),this.container.append(this.header),s.body&&(this.body=document.createElement("div"),this.body.classList.add("popup-body"),this.container.append(this.body));let i=this.btnConfirm;if(t&&t.length){const e=this.buttonsEl=document.createElement("div");e.classList.add("popup-buttons"),2===t.length&&e.classList.add("popup-buttons-row");const s=t.map(e=>{const t=document.createElement("button");return t.className="btn"+(e.isDanger?" danger":" primary"),Object(ei.ripple)(t),e.text?t.innerHTML=e.text:t.append(Object(O.i18n)(e.langKey,e.langArgs)),Object(v.b)(t,()=>{e.callback&&e.callback(),this.destroy()},{listenerSetter:this.listenerSetter,once:!0}),e.element=t});if(!i&&2===t.length){const e=t.find(e=>!e.isCancel);e&&(i=e.element)}e.append(...s),this.container.append(e)}this.btnConfirmOnEnter=i,this.element.append(this.container)}show(){this.navigationItem={type:"popup",onPop:this.destroy,onEscape:this.onEscape},Nt.a.pushItem(this.navigationItem),Object(si.a)(),document.body.append(this.element),this.element.offsetWidth,this.element.classList.add("active"),H.default.isOverlayActive=!0,zs.a.checkAnimations(!0),setTimeout(()=>{this.listenerSetter.add(document.body)("keydown",e=>{(this.confirmShortcutIsSendShortcut?ii(e):"Enter"===e.key)&&(Object(v.e)(this.btnConfirmOnEnter),Object(f.a)(e))})},0)}static createPopup(e,...t){return new e(...t)}}const ai=e=>(e.find(e=>e.isCancel)||e.push({langKey:"Cancel",isCancel:!0}),e);class oi extends ni{constructor(){super("popup-avatar",null,{closable:!0,withConfirm:!0}),this.image=new Image,this.cropper={crop:()=>{},removeHandlers:()=>{}},this.h6=document.createElement("h6"),Object(O._i18n)(this.h6,"Popup.Avatar.Title"),this.btnClose.classList.remove("btn-icon"),this.header.append(this.h6),this.cropContainer=document.createElement("div"),this.cropContainer.classList.add("crop"),this.cropContainer.append(this.image),this.input=document.createElement("input"),this.input.type="file",this.input.style.display="none",this.input.accept="image/*",this.listenerSetter.add(this.input)("change",e=>{const t=e.target.files[0];t&&Object(vt.c)(t).then(e=>{this.image=new Image,this.cropContainer.append(this.image),this.image.src=e,this.image.onload=()=>{this.show(),this.cropper=Js(this.image,this.canvas),this.cropContainer.clientHeight<180?(this.cropContainer.classList.add("small-image"),this.btnConfirm.classList.add("small-image"),this.cropper=Js(this.image,this.canvas)):(this.cropContainer.classList.remove("small-image"),this.btnConfirm.classList.remove("small-image")),this.input.value=""}})},!1),this.btnConfirm.className="btn-primary btn-color-primary btn-circle btn-crop btn-icon tgico-check z-depth-1",Object(v.b)(this.btnConfirm,()=>{this.cropper.crop(),this.hide(),this.canvas.toBlob(e=>{this.blob=e,this.darkenCanvas(),this.resolve()},"image/jpeg",1)},{listenerSetter:this.listenerSetter}),this.container.append(this.cropContainer,this.btnConfirm,this.input),this.addEventListener("closeAfterTimeout",()=>{this.cropper.removeHandlers(),this.image&&this.image.remove()})}resolve(){this.onCrop(()=>st.upload(this.blob))}open(e,t){this.canvas=e,this.onCrop=t,this.input.click()}darkenCanvas(){let e=this.canvas.getContext("2d");e.fillStyle="rgba(0, 0, 0, 0.3)",e.fillRect(0,0,this.canvas.width,this.canvas.height)}}class ri{constructor(e){this.container=document.createElement("div"),this.container.classList.add("avatar-edit"),this.canvas=document.createElement("canvas"),this.canvas.classList.add("avatar-edit-canvas"),this.icon=document.createElement("span"),this.icon.classList.add("tgico","tgico-cameraadd"),this.container.append(this.canvas,this.icon),this.container.addEventListener("click",()=>{(new oi).open(this.canvas,e)})}clear(){this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height)}}var li=(e={})=>Object(Ks.a)("btn-circle btn-corner z-depth-1"+(e.className?" "+e.className:""),e);class di extends Ys{constructor(){super(...arguments),this.searchGroup=new de(!0,"contacts",!0,"new-group-members disable-hover",!1),this.uploadAvatar=null}init(){this.container.classList.add("new-group-container"),this.setTitle("NewGroup"),this.avatarEdit=new ri(e=>{this.uploadAvatar=e});const e=document.createElement("div");e.classList.add("input-wrapper"),this.groupNameInputField=new Ws.b({label:"CreateGroup.NameHolder",maxLength:128}),e.append(this.groupNameInputField.container),this.groupNameInputField.input.addEventListener("input",()=>{const e=this.groupNameInputField.value;this.nextBtn.classList.toggle("is-visible",!!e.length&&!this.groupNameInputField.input.classList.contains("error"))}),this.nextBtn=li({icon:"arrow_next"}),this.nextBtn.addEventListener("click",()=>{const e=this.groupNameInputField.value;this.nextBtn.disabled=!0,Pe.createChat(e,this.peerIds.map(e=>e.toUserId())).then(e=>{this.uploadAvatar&&this.uploadAvatar().then(t=>{Pe.editPhoto(e,t)}),wr.removeTabFromHistory(this),wr.selectTab(0)})});const t=document.createElement("div");t.classList.add("chatlist-container"),t.append(this.searchGroup.container),this.content.append(this.nextBtn),this.scrollable.append(this.avatarEdit.container,e,t)}onCloseAfterTimeout(){this.searchGroup.clear(),this.avatarEdit.clear(),this.uploadAvatar=null,this.groupNameInputField.value="",this.nextBtn.disabled=!1}open(e){const t=super.open();return t.then(()=>{this.peerIds=e,this.peerIds.forEach(e=>{let{dom:t}=Jd.addDialogNew({dialog:e,container:this.searchGroup.list,drawStatus:!1,rippleEnabled:!1,avatarSize:48});t.lastMessageSpan.append(ye.getUserStatusString(e))}),this.searchGroup.nameEl.textContent="",this.searchGroup.nameEl.append(Object(O.i18n)("Members",[this.peerIds.length])),this.searchGroup.setActive()}),t}}var ci=s(192),hi=s(142),ui=s(183),pi=s(149),gi=s(202),mi=s(151),fi=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};const vi=(()=>{try{return C.IS_SAFARI&&+navigator.userAgent.match(/ Version\/(\d+)/)[1]<14}catch(e){return!1}})();const bi=new class{constructor(){if(this.media=new Map,this.scheduled=new Map,this.mediaDetails=new Map,this.waitingMediaForLoad=new Map,this.waitingScheduledMediaForLoad=new Map,this.waitingDocumentsForLoad={},this._volume=1,this._muted=!1,this._playbackRate=1,this.playbackRates={voice:1,video:1,audio:1},this.seekBackward=e=>{const t=this.playingMedia;t&&(t.currentTime=Math.max(0,t.currentTime-(e.seekOffset||10)))},this.seekForward=e=>{const t=this.playingMedia;t&&(t.currentTime=Math.min(t.duration,t.currentTime+(e.seekOffset||10)))},this.seekTo=e=>{const t=this.playingMedia;t&&(t.currentTime=e.seekTime)},this.onMediaDocumentLoad=e=>{const t=this.mediaDetails.get(e),s=es.getDoc(t.docId);"audio"===s.type&&s.supportsStreaming&&vi&&this.handleSafariStreamable(e);const i=st.getCacheContext(s);e.src=i.url,this.playingMedia===e&&(e.playbackRate=this.playbackRate);const n=this.waitingDocumentsForLoad[s.id];n&&(n.delete(e),n.size||delete this.waitingDocumentsForLoad[s.id])},this.onPlay=e=>{const t=e.target,s=this.mediaDetails.get(t),{peerId:i,mid:n}=s,a=this.getMessageByMedia(t);if(this.playingMedia!==t){this.stop();const e=e=>e.mid===n&&e.peerId===i;if(!this.listLoader.current||!e(this.listLoader.current)){let t,s=this.listLoader.previous.findIndex(e);-1!==s?t=-(this.listLoader.previous.length-s):(s=this.listLoader.next.findIndex(e),-1!==s&&(t=s+1)),-1!==s?t&&this.listLoader.go(t,!1):this.setTargets({peerId:i,mid:n})}this.setMedia(t,a)}setTimeout(()=>{H.default.dispatchEvent("media_play",{doc:js.getMediaFromMessage(a),message:a,media:t})},0)},this.onPause=e=>{H.default.dispatchEvent("media_pause")},this.onEnded=e=>{var t;if(e.isTrusted){if(this.onPause(e),(null===(t=this.listLoader)||void 0===t?void 0:t.current)&&this.lastAutoPlayItem){const e=this.listLoader.current;if(e.mid===this.lastAutoPlayItem.mid&&e.peerId===this.lastAutoPlayItem.peerId)return this.stop(),void H.default.dispatchEvent("media_stop")}this.next()||(this.stop(),H.default.dispatchEvent("media_stop"))}},this.play=()=>this.toggle(!0),this.pause=()=>this.toggle(!1),this.stop=()=>{const e=this.playingMedia;if(!e)return!1;e.paused||e.pause(),e.currentTime=0,Object(mi.a)(e,"ended");const t=this.mediaDetails.get(e);if(null==t?void 0:t.clean){e.src="";const s=t.peerId,i=t.isScheduled?this.scheduled:this.media,n=i.get(s);n&&(n.delete(t.mid),n.size||i.delete(s)),e.remove(),this.mediaDetails.delete(e)}return this.playbackRates[this.playingMediaType]=this.playbackRate,this.playingMedia=void 0,this.playingMediaType=void 0,!0},this.playItem=e=>{const{peerId:t,mid:s}=e,i=this.searchContext.isScheduled;this.getMedia(t,s,i).play(),setTimeout(()=>{this.resolveWaitingForLoadMedia(t,s,i)},0)},this.next=()=>!this.lockedSwitchers&&this.listLoader.go(1),this.previous=()=>{const e=this.playingMedia;return e&&(e.currentTime>5||!this.listLoader.previous.length)?(e.currentTime=0,void this.toggle(!0)):!this.lockedSwitchers&&this.listLoader.go(-1)},this.container=document.createElement("div"),this.container.style.cssText="display: none;",document.body.append(this.container),navigator.mediaSession){const e={play:this.play,pause:this.pause,stop:this.stop,seekbackward:this.seekBackward,seekforward:this.seekForward,seekto:this.seekTo,previoustrack:this.previous,nexttrack:this.next};for(const t in e)try{navigator.mediaSession.setActionHandler(t,e[t])}catch(e){console.warn("MediaSession action is not supported:",t)}}H.default.addEventListener("document_downloaded",e=>{const t=this.waitingDocumentsForLoad[e.id];if(t)for(const e of t)this.onMediaDocumentLoad(e)});const e={};["volume","muted","playbackRate"].forEach(t=>{const s="_"+t;e[t]={get:()=>this[s],set:e=>{this[s]!==e&&(this[s]=e,this.playingMedia&&(this.playingMedia[t]=e,"playbackRate"===t&&(this.playingMedia.defaultPlaybackRate=e)),this.dispatchPlaybackParams())}}}),Object.defineProperties(this,e)}dispatchPlaybackParams(){const{volume:e,muted:t,playbackRate:s}=this;H.default.dispatchEvent("media_playback_params",{volume:e,muted:t,playbackRate:s})}addMedia(e,t,s){const{peerId:i,mid:n}=e,a=!!e.pFlags.is_scheduled?this.scheduled:this.media;let o=a.get(e.peerId);o||a.set(e.peerId,o=new Map);let r=o.get(n);if(r)return r;const l=js.getMediaFromMessage(e);o.set(n,r=document.createElement("round"===l.type||"video"===l.type?"video":"audio")),"round"===l.type&&r.setAttribute("playsinline","true");const d={peerId:i,mid:n,docId:l.id,clean:s,isScheduled:e.pFlags.is_scheduled};this.mediaDetails.set(r,d),r.volume=1,this.container.append(r),r.addEventListener("play",this.onPlay),r.addEventListener("pause",this.onPause),r.addEventListener("ended",this.onEnded),"audio"!==l.type&&(null==e?void 0:e.pFlags.media_unread)&&e.fromId!==H.default.myId&&r.addEventListener("timeupdate",()=>{js.readMessages(i,[n])},{once:!0});const c=Object(w.a)();if(t)c.resolve();else{const t=e.pFlags.is_scheduled?this.waitingScheduledMediaForLoad:this.waitingMediaForLoad;let s=t.get(i);s||t.set(i,s=new Map),s.set(n,c)}return c.then(()=>{const e=st.getCacheContext(l);if(l.supportsStreaming||e.url)this.onMediaDocumentLoad(r);else{let e=this.waitingDocumentsForLoad[l.id];e||(e=this.waitingDocumentsForLoad[l.id]=new Set),e.add(r),es.downloadDoc(l)}}),r}getMedia(e,t,s){const i=(s?this.scheduled:this.media).get(e);return null==i?void 0:i.get(t)}handleSafariStreamable(e){e.addEventListener("play",()=>{const t=e.currentTime;e.addEventListener("progress",()=>{e.currentTime=e.duration-1,e.addEventListener("progress",()=>{e.currentTime=t,e.paused||e.play()},{once:!0})},{once:!0})})}resolveWaitingForLoadMedia(e,t,s){const i=s?this.waitingScheduledMediaForLoad:this.waitingMediaForLoad,n=i.get(e);if(!n)return;const a=n.get(t);a&&(a.resolve(),n.delete(t),n.size||i.delete(e))}isSafariBuffering(e){return!!e.safariBuffering}setSafariBuffering(e,t){e.safariBuffering=t}setNewMediadata(e,t=this.playingMedia){var s;return fi(this,void 0,void 0,(function*(){yield k(t,void 0,!1);const i=js.getMediaFromMessage(e),n=[],a="voice"===i.type||"round"===i.type;let o="",r="";if(null===(s=i.thumbs)||void 0===s?void 0:s.length){const s=i.thumbs[i.thumbs.length-1];if(!s.bytes){const a=st.getCacheContext(i,s.type);if(a.url)n.push({src:a.url,sizes:`${s.w}x${s.h}`,type:"image/jpeg"});else{Dt.preloadPhoto(i,s).then(()=>{this.playingMedia===t&&a.url&&this.setNewMediadata(e)})}}}else if(a){const s=e.fromId||e.peerId,a=Te.getPeerPhoto(s);if(a){const i=jt.loadAvatar(s,a,"photo_small");if(i.cached){const e=yield i.loadPromise;n.push({src:e,sizes:"160x160",type:"image/jpeg"})}else i.loadPromise.then(s=>{this.playingMedia===t&&s&&this.setNewMediadata(e)})}o=Te.getPeerTitle(s,!0,!1),r=O.default.format("voice"===i.type?"AttachAudio":"AttachRound",!0)}if(!a){const e=i.attributes.find(e=>"documentAttributeAudio"===e._);o=e&&e.title||i.file_name,r=e&&e.performer}n.length||(C.IS_APPLE?Ht.IS_TOUCH_SUPPORTED?n.push({src:"assets/img/apple-touch-icon-precomposed.png",sizes:"180x180",type:"image/png"}):n.push({src:"assets/img/apple-touch-icon.png",sizes:"180x180",type:"image/png"}):[72,96,144,192,256,384,512].forEach(e=>{const t=`${e}x${e}`;n.push({src:`assets/img/android-chrome-${t}.png`,sizes:t,type:"image/png"})}));const l=new MediaMetadata({title:o,artist:r,artwork:n});navigator.mediaSession.metadata=l}))}getMessageByMedia(e){const t=this.mediaDetails.get(e),{peerId:s,mid:i}=t;return t.isScheduled?js.getScheduledMessageByPeer(s,i):js.getMessageByPeer(s,i)}toggle(e){return!!this.playingMedia&&(void 0===e&&(e=this.playingMedia.paused),this.playingMedia.paused===e&&(e?this.playingMedia.play():this.playingMedia.pause(),!0))}willBePlayed(e){this.willBePlayedMedia=e}setSearchContext(e){return!Object(m.b)(this.searchContext,e)&&(this.searchContext=Object(m.a)(e),!0)}getSearchContext(){return this.searchContext}setTargets(e,t,s){this.listLoader?this.listLoader.reset():this.listLoader=new Hs({loadCount:10,loadWhenLeft:5,processItem:e=>(this.addMedia(e,!1),{peerId:e.peerId,mid:e.mid}),onJump:(e,t)=>{this.playItem(e)},onEmptied:()=>{H.default.dispatchEvent("media_stop"),this.stop()}});const i=void 0===this.searchContext.folderId;t?this.listLoader.setTargets(t,s,i):this.listLoader.reverse=i,this.listLoader.setSearchContext(this.searchContext),this.listLoader.current=e,this.lastAutoPlayItem=s&&s.length?s[s.length-1]:e,this.listLoader.load(!0),this.listLoader.load(!1)}getPlaybackMediaTypeFromMessage(e){const t=js.getMediaFromMessage(e);let s="audio";return(null==t?void 0:t.type)&&("voice"===t.type||"round"===t.type?s="voice":"video"===t.type&&(s="video")),s}setMedia(e,t){const s=this.getPlaybackMediaTypeFromMessage(t);this._playbackRate=this.playbackRates[s],this.playingMedia=e,this.playingMediaType=s,this.playingMedia.volume=this.volume,this.playingMedia.muted=this.muted,this.playingMedia.defaultPlaybackRate=this.playbackRate,this.playingMedia.playbackRate=this.playbackRate,"mediaSession"in navigator&&this.setNewMediadata(t)}setSingleMedia(e,t){const s=this.playingMedia,i=this.pause();return this.willBePlayed(void 0),e?this.setMedia(e,t):this.playingMedia=void 0,this.toggleSwitchers(!1),()=>{this.toggleSwitchers(!0),s&&(this.mediaDetails.get(s)?this.setMedia(s,this.getMessageByMedia(s)):this.next()||this.previous()),e&&this.playingMedia===e&&this.stop(),i&&this.play()}}toggleSwitchers(e){this.lockedSwitchers=!e}};j.a.appMediaPlaybackController=bi;var yi=bi;function wi(e,t,s,i){const n=e=>{s({x:e.pageX,y:e.pageY,event:e})},a=t=>{document.removeEventListener("mousemove",n),e.addEventListener("mousedown",o,{once:!0}),i&&i({x:t.pageX,y:t.pageY,event:t})},o=s=>{0===s.button?(t({x:s.pageX,y:s.pageY,event:s}),n(s),document.addEventListener("mousemove",n),document.addEventListener("mouseup",a,{once:!0})):e.addEventListener("mousedown",o,{once:!0})};e.addEventListener("mousedown",o,{once:!0});const r=e=>{e.preventDefault(),s({x:e.touches[0].clientX,y:e.touches[0].clientY,isTouch:!0,event:e})},l=t=>{document.removeEventListener("touchmove",r),e.addEventListener("touchstart",d,{passive:!1,once:!0}),i&&i({x:t.touches[0].clientX,y:t.touches[0].clientY,isTouch:!0,event:t})},d=e=>{t({x:e.touches[0].clientX,y:e.touches[0].clientY,isTouch:!0,event:e}),r(e),document.addEventListener("touchmove",r,{passive:!1}),document.addEventListener("touchend",l,{passive:!1,once:!0})};return e.addEventListener("touchstart",d,{passive:!1,once:!0}),()=>{e.removeEventListener("mousedown",o),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",a),e.removeEventListener("touchstart",d),document.removeEventListener("touchmove",r),document.removeEventListener("touchend",l)}}class Si{constructor(e,t=0){this.mousedown=!1,this.events={},this.withTransition=!1,this.useTransform=!1,this.vertical=!1,this.onMouseMove=e=>{this.scrub(e)},this.onMouseDown=e=>{var t;this.rect=this.container.getBoundingClientRect(),this.mousedown=!0,this.scrub(e),this.container.classList.add("is-focused"),(null===(t=this.events)||void 0===t?void 0:t.onMouseDown)&&this.events.onMouseDown(e)},this.onMouseUp=e=>{var t;this.mousedown=!1,this.container.classList.remove("is-focused"),(null===(t=this.events)||void 0===t?void 0:t.onMouseUp)&&this.events.onMouseUp(e)},this.onInput=()=>{var e;const t=+this.seek.value;this.setFilled(t),(null===(e=this.events)||void 0===e?void 0:e.onScrub)&&this.events.onScrub(t)},Object(m.g)(this,e),this.container=document.createElement("div"),this.container.classList.add("progress-line"),this.useTransform?this.container.classList.add("use-transform"):this.withTransition&&this.container.classList.add("with-transition"),this.filled=document.createElement("div"),this.filled.classList.add("progress-line__filled");const s=this.seek=document.createElement("input");s.classList.add("progress-line__seek"),s.type="range",s.step=""+this.step,s.min=""+this.min,s.max=""+this.max,s.value=""+t,t&&this.setProgress(t);const i=""+this.step,n=i.indexOf(".");this.decimals=-1===n?0:i.length-n-1,this.container.append(this.filled,s)}get value(){return+this.seek.value}setHandlers(e){this.events=e}setListeners(){this.seek.addEventListener("input",this.onInput),this._removeListeners=wi(this.container,this.onMouseDown,this.onMouseMove,this.onMouseUp)}setProgress(e){this.seek.value=""+e,this.setFilled(+this.seek.value)}addProgress(e){this.seek.value=""+(+this.seek.value+e),this.setFilled(+this.seek.value)}setFilled(e){let t=(e-this.min)/(this.max-this.min);t=Object(ds.a)(t,0,1),this.useTransform?this.filled.style.transform=`scaleX(${t})`:this.filled.style.width=100*t+"%"}scrub(e){var t;const s=this.vertical?this.rect.height:this.rect.width,i=Object(ds.a)(this.vertical?-(e.y-this.rect.bottom):e.x-this.rect.left,0,s);let n=this.min+i/s*(this.max-this.min);return n-this.min<(this.max-this.min)/2&&(n-=this.step/10),n=+n.toFixed(this.decimals),n=Object(ds.a)(n,this.min,this.max),this.setProgress(n),(null===(t=this.events)||void 0===t?void 0:t.onScrub)&&this.events.onScrub(n),n}removeListeners(){this._removeListeners&&(this._removeListeners(),this._removeListeners=null),this.seek.removeEventListener("input",this.onInput),this.events={}}}const Ii=e=>{if(e.element)return e.element;const{icon:t,text:s,onClick:i,checkboxField:n,noCheckboxClickListener:a}=e,o=document.createElement("div");o.className="btn-menu-item"+(t?" tgico-"+t:""),Object(ei.ripple)(o);let r=e.textElement;r||(r=e.textElement=s?Object(O.i18n)(s):document.createElement("span"),e.regularText&&(r.innerHTML=e.regularText)),r.classList.add("btn-menu-item-text"),o.append(r);const l=!!n||!!e.keepOpen;return Object(v.b)(o,e=>{Object(f.a)(e);!1!==i(e)&&(l||Object(hi.c)(),n&&!a&&(n.checked="radio"===n.input.type||!n.checked))},e.options),n&&o.append(n.label),e.element=o};var Mi=(e,t)=>{const s=document.createElement("div");s.classList.add("btn-menu"),t&&e.forEach(e=>{e.options?e.options.listenerSetter=t:e.options={listenerSetter:t}});const i=e.map(Ii);return s.append(...i),s};const Ci=(e,t,s)=>{((null==s?void 0:s.listenerSetter)?s.listenerSetter.add(e):e.addEventListener.bind(e))(v.a,s=>{if(!e.classList.contains("btn-menu-toggle"))return!1;const i=e.querySelector(".btn-menu");Object(f.a)(s),e.classList.contains("menu-open")?Object(hi.c)():(t&&t(s),Object(hi.d)(i))})};var Pi=(e={},t,s,i)=>{e.asDiv=!0;const n=Qs("more btn-menu-toggle",e),a=Mi(s,e.listenerSetter);return a.classList.add(t),Ci(n,i,e),n.append(a),n},Li=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class Ei extends Si{constructor(e,t,s,i){super({step:1e3/60/1e3,min:0,max:1,withTransition:s,useTransform:i},0),this.progressRAF=0,this.onLoadedData=()=>{this.max=this.media.duration,this.seek.setAttribute("max",""+this.max)},this.onEnded=()=>{this.setProgress()},this.onPlay=()=>{let e=()=>{this.setProgress(),this.progressRAF=this.media.paused?0:window.requestAnimationFrame(e)};this.progressRAF&&window.cancelAnimationFrame(this.progressRAF),this.streamable&&this.setLoadProgress(),this.progressRAF=window.requestAnimationFrame(e)},this.onTimeUpdate=()=>{this.media.paused&&(this.setProgress(),this.streamable&&this.setLoadProgress())},this.onProgress=e=>{this.setLoadProgress()},e&&this.setMedia(e,t)}setMedia(e,t=!1){this.media&&this.removeListeners(),t&&!this.filledLoad?(this.filledLoad=document.createElement("div"),this.filledLoad.classList.add("progress-line__filled","progress-line__loaded"),this.container.prepend(this.filledLoad)):this.filledLoad&&this.filledLoad.classList.toggle("hide",!t),this.media=e,this.streamable=t,(!e.paused||e.currentTime>0)&&this.onPlay();let s=!1;this.setSeekMax(),this.setListeners(),this.setHandlers({onMouseDown:()=>{s=!this.media.paused,s&&this.media.pause()},onMouseUp:e=>{s&&this.media.play()}})}scrub(e){const t=super.scrub(e);return this.media.currentTime=t,t}setLoadProgress(){if(yi.isSafariBuffering(this.media))return;const e=this.media.buffered,t=e.length,s=this.media.currentTime;let i=0,n=0;for(let a=0;a<t;++a){const t=e.start(a);s>=t&&t>=i&&(i=t,n=e.end(a))}const a=this.media.duration?n/this.media.duration:0;this.filledLoad.style.width=100*a+"%"}setSeekMax(){this.max=this.media.duration||0,this.max>0?this.onLoadedData():this.media.addEventListener("loadeddata",this.onLoadedData)}setProgress(){if(yi.isSafariBuffering(this.media))return;const e=this.media.currentTime;super.setProgress(e)}setListeners(){super.setListeners(),this.media.addEventListener("ended",this.onEnded),this.media.addEventListener("play",this.onPlay),this.media.addEventListener("timeupdate",this.onTimeUpdate),this.streamable&&this.media.addEventListener("progress",this.onProgress)}removeListeners(){super.removeListeners(),this.media.removeEventListener("loadeddata",this.onLoadedData),this.media.removeEventListener("ended",this.onEnded),this.media.removeEventListener("play",this.onPlay),this.media.removeEventListener("timeupdate",this.onTimeUpdate),this.streamable&&this.media.removeEventListener("progress",this.onProgress),this.progressRAF&&(window.cancelAnimationFrame(this.progressRAF),this.progressRAF=0)}}class _i extends Si{constructor(e,t=!1){super({step:.01,min:0,max:1,vertical:t},1),this.listenerSetter=e,this.vertical=t,this.onMuteClick=e=>{e&&Object(f.a)(e),yi.muted=!yi.muted},this.setVolume=()=>{const{volume:e,muted:t}=yi;let s;s=!e||t?"M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z":e>.5?"M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z":e>0&&e<.25?"M7 9v6h4l5 5V4l-5 5H7z":"M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5 9v6h4l5 5V4L9 9H5z";try{this.volumeSvg.innerHTML=`<path d="${s}"></path>`}catch(e){}this.mousedown||this.setProgress(t?0:e)},this.setListeners(),this.setHandlers({onScrub:e=>{const t=Math.max(Math.min(e,1),0);yi.muted=!1,yi.volume=t}}),this.btn=document.createElement("div"),this.btn.classList.add("player-volume"),this.btn.innerHTML='\n    <svg class="player-volume__icon" focusable="false" viewBox="0 0 24 24" aria-hidden="true"></svg>\n    ',this.btn.classList.add("btn-icon"),this.volumeSvg=this.btn.firstElementChild,this.btn.append(this.container),Object(v.b)(this.volumeSvg,this.onMuteClick,{listenerSetter:this.listenerSetter}),this.listenerSetter.add(H.default)("media_playback_params",this.setVolume),this.setVolume()}}class ki extends Mt.a{constructor(e,t=!1,s=!1,i,n){if(super(!1),this.video=e,this.modeLive=n,this.showControlsTimeout=0,this.hideControls=()=>{clearTimeout(this.showControlsTimeout),this.showControlsTimeout=0;const e=this.wrapper.classList.contains("show-controls");if(!1!==this.controlsLocked){if(this.video.paused||!e||this.controlsLocked)return}else if(!e)return;this.dispatchEvent("toggleControls",!1),this.wrapper.classList.remove("show-controls")},this.showControls=(e=!0)=>{this.showControlsTimeout?(clearTimeout(this.showControlsTimeout),this.showControlsTimeout=0):this.wrapper.classList.contains("show-controls")||!1===this.controlsLocked||(this.dispatchEvent("toggleControls",!0),this.wrapper.classList.add("show-controls")),e&&!this.controlsLocked&&(this.showControlsTimeout=window.setTimeout(this.hideControls,3e3))},this.toggleControls=e=>{const t=this.wrapper.classList.contains("show-controls");if(void 0===e)t?this.hideControls():this.showControls();else{if(e===t)return;!1===e?this.hideControls():this.showControls()}},this.setPlaybackRate=()=>{const{playbackRate:e}=yi;this.video.playbackRate=e,this.modeLive||this.setPlaybackRate()},this.onFullScreen=()=>{null!==document.webkitFullscreenElement||this.wrapper.classList.remove("ckin__fullscreen")},this.wrapper=document.createElement("div"),this.wrapper.classList.add("ckin__player"),this.listenerSetter=new Gs,e.parentNode.insertBefore(this.wrapper,e),this.wrapper.appendChild(e),this.skin="default",e.defaultPlaybackRate=1,e.playbackRate=1,this.stylePlayer(i),n||this.setBtnMenuToggle(),this.listenerSetter.add(e)("ratechange",()=>{this.setPlaybackRateIcon()}),"default"===this.skin){const t=this.wrapper.querySelector(".default__controls.ckin__controls");if(this.progress=new Ei(e,s),this.modeLive){const e=t.querySelector(".left-controls"),s=e.querySelector(".btn-icon"),i=e.querySelector(".time"),n=e.querySelector(".player-volume");s.style.display="none",i.style.display="none",n.style.margin="0px"}else t.prepend(this.progress.container);if(!document.pictureInPictureEnabled){const e=t.querySelector(".picture-in-picture");e&&(e.style.display="none")}}if(t){e.play().catch(t=>{"NotAllowedError"===t.name&&(e.muted=!0,e.autoplay=!0,e.play())}).finally(()=>{this.wrapper.classList.toggle("is-playing",!this.video.paused)})}}stylePlayer(e){const{wrapper:t,video:s,skin:i}=this;t.classList.add(i);const n=this.buildControls();let a;if(t.insertAdjacentHTML("beforeend",n),"default"===i){const e=t.querySelectorAll(".toggle"),i=t.querySelector(".fullscreen"),n=t.querySelector(".picture-in-picture"),o=t.querySelector("#time-elapsed");a=t.querySelector("#time-duration"),a.innerHTML=String(0|s.duration).toHHMMSS();const r=new _i(this.listenerSetter),l=t.querySelector(".left-controls");r.btn.classList.remove("btn-icon"),l.insertBefore(r.btn,o.parentElement),Array.from(e).forEach(e=>{this.listenerSetter.add(e)("click",()=>{this.togglePlay()})}),this.listenerSetter.add(s)("click",()=>{Ht.IS_TOUCH_SUPPORTED||this.modeLive||this.togglePlay()}),Ht.IS_TOUCH_SUPPORTED?this.listenerSetter.add(t)("click",()=>{this.toggleControls()}):(this.listenerSetter.add(this.wrapper)("mousemove",()=>{this.showControls()}),this.listenerSetter.add(this.wrapper)("mouseenter",()=>{this.showControls(!1)}),this.listenerSetter.add(this.wrapper)("mouseleave",e=>{Object(ti.a)(e.relatedTarget,"media-viewer-caption")?this.showControls(!1):this.hideControls()}),this.listenerSetter.add(document)("keydown",e=>{if(H.default.overlaysActive>1||document.pictureInPictureElement===s)return;const{key:t,code:n}=e;let a=!0;return"KeyF"===n?this.toggleFullScreen(i):"KeyM"===n?yi.muted=!yi.muted:"Space"===n?this.togglePlay():e.altKey&&"Equal"===n?yi.playbackRate+=.25:e.altKey&&"Minus"===n?yi.playbackRate-=.25:!this.wrapper.classList.contains("ckin__fullscreen")||"ArrowLeft"!==t&&"ArrowRight"!==t?a=!1:"ArrowLeft"===t?yi.seekBackward({action:"seekbackward"}):yi.seekForward({action:"seekforward"}),a?(Object(f.a)(e),!1):void 0})),this.listenerSetter.add(s)("dblclick",()=>{Ht.IS_TOUCH_SUPPORTED||this.toggleFullScreen(i)}),this.listenerSetter.add(i)("click",e=>{this.toggleFullScreen(i)}),this.listenerSetter.add(n)("click",e=>{this.togglePictureInPicture(n)}),"webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange".split(" ").forEach(e=>{this.listenerSetter.add(t)(e,this.onFullScreen,!1)}),this.listenerSetter.add(s)("timeupdate",()=>{o.innerHTML=String(0|s.currentTime).toHHMMSS()}),this.listenerSetter.add(s)("play",()=>{this.wrapper.classList.add("played")},{once:!0}),this.listenerSetter.add(s)("pause",()=>{this.showControls(!1)})}this.listenerSetter.add(s)("play",()=>{this.wrapper.classList.add("is-playing")}),this.listenerSetter.add(s)("pause",()=>{this.wrapper.classList.remove("is-playing")}),s.duration||e?a.innerHTML=String(Math.round(s.duration||e)).toHHMMSS():k(s).then(()=>{a.innerHTML=String(Math.round(s.duration)).toHHMMSS()})}lockControls(e){this.controlsLocked=e,this.wrapper.classList.toggle("disable-hover",!1===e),this.toggleControls(e)}togglePlay(){this.video[this.video.paused?"play":"pause"]()}buildControls(){const e=this.skin;if("default"===e)return`\n      <button class="${e}__button--big toggle tgico" title="Toggle Play"></button>\n      <div class="${e}__gradient-bottom ckin__controls"></div>\n      <div class="${e}__controls ckin__controls">\n        <div class="bottom-controls">\n          <div class="left-controls">\n            <button class="btn-icon ${e}__button toggle tgico" title="Toggle Video"></button>\n            <div class="time">\n              <time id="time-elapsed">0:00</time>\n              <span> / </span>\n              <time id="time-duration">0:00</time>\n            </div>\n          </div>\n          <div class="right-controls">\n            <button class="btn-icon ${e}__button btn-menu-toggle playback-rate ${this.modeLive?"hide":""}" title="Playback Rate"></button>\n            <button class="btn-icon ${e}__button picture-in-picture tgico-picture-in-picture" title="Picture in Picture"></button>\n            <button class="btn-icon ${e}__button fullscreen tgico-fullscreen" title="Full Screen"></button>\n          </div>\n        </div>\n      </div>`}setBtnMenuToggle(){const e=ki.PLAYBACK_RATES.map(e=>({regularText:e+"x",onClick:()=>{this.video.defaultPlaybackRate=e,this.video.playbackRate=e,this.setPlaybackRateIcon()}})),t=Mi(e),s=this.wrapper.querySelector(".playback-rate");t.classList.add("top-left"),Ci(s),s.append(t),this.setPlaybackRateIcon()}setPlaybackRateIcon(){const e=this.wrapper.querySelector(".playback-rate");if(!e)return;ki.PLAYBACK_RATES_ICONS.forEach(t=>{t="tgico-"+t,e.classList.remove(t)});let t=ki.PLAYBACK_RATES.indexOf(this.video.playbackRate);-1===t&&(t=ki.PLAYBACK_RATES.indexOf(1)),e.classList.add("tgico-"+ki.PLAYBACK_RATES_ICONS[t])}static isFullScreen(){return!!(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement)}toggleFullScreen(e){const t=this.wrapper;if(C.IS_APPLE_MOBILE){const e=this.video;return e.webkitEnterFullscreen(),void e.enterFullscreen()}ki.isFullScreen()?(t.classList.remove("ckin__fullscreen"),document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen(),e.classList.remove("tgico-smallscreen"),e.classList.add("tgico-fullscreen"),e.setAttribute("title","Full Screen")):(t.classList.add("ckin__fullscreen"),t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen&&t.msRequestFullscreen(),e.classList.remove("tgico-fullscreen"),e.classList.add("tgico-smallscreen"),e.setAttribute("title","Exit Full Screen"))}static isPictureInPicture(){return!!document.pictureInPictureElement}togglePictureInPicture(e){return Li(this,void 0,void 0,(function*(){if(document.pictureInPictureEnabled){if(ki.isFullScreen()){const e=this.wrapper.querySelector(".fullscreen");this.toggleFullScreen(e)}if(ki.isPictureInPicture())if(document.pictureInPictureElement===this.video)try{yield document.exitPictureInPicture()}catch(e){console.error("Failed to enter Picture-in-Picture mode: ",e)}else try{yield document.exitPictureInPicture(),yield new Promise(e=>setTimeout(e,100));const e=Object(ti.a)(this.video.parentElement,"media-viewer-whole");e&&(e.style.display="none",e.classList.add("mode-picture-in-picture")),this.video.addEventListener("leavepictureinpicture",()=>{e.style.display="block",e.classList.remove("mode-picture-in-picture"),document.querySelectorAll(".media-viewer-whole:not(.mode-picture-in-picture)").forEach(e=>{e.remove()})}),yield this.video.requestPictureInPicture()}catch(e){console.error("Failed to switch Picture-in-Picture mode: ",e)}else try{document.pictureInPictureElement&&document.pictureInPictureElement!==this.video&&(yield document.exitPictureInPicture(),yield new Promise(e=>setTimeout(e,100)));const e=Object(ti.a)(this.video.parentElement,"media-viewer-whole");e&&(e.style.display="none",e.classList.add("mode-picture-in-picture")),this.video.addEventListener("leavepictureinpicture",()=>{e.style.display="block",e.classList.remove("mode-picture-in-picture"),document.querySelectorAll(".media-viewer-whole:not(.mode-picture-in-picture)").forEach(e=>{e.remove()})}),yield this.video.requestPictureInPicture()}catch(e){console.error("Failed to enter Picture-in-Picture mode: ",e)}}}))}removeListeners(){super.cleanup(),this.listenerSetter.removeAll(),this.progress.removeListeners()}}function Ti(e){return function(e,t){let s,i=!1;return(...n)=>{s=n,i||(i=!0,e(()=>{i=!1,t(...s)}))}}(g.b,e)}function xi(e){e.classList.add("is-voice");const t=e.message,s=js.getMediaFromMessage(t);t.pFlags.out&&e.classList.add("is-out");const i=I.b.isMobile?16:23,n=I.b.isMobile?152:190,a=I.b.isMobile?190:256,o=s.duration,r=Object(ds.a)(o/60*a,n,a),l=document.createElementNS("http://www.w3.org/2000/svg","svg");l.classList.add("audio-waveform"),l.setAttributeNS(null,"width",""+r),l.setAttributeNS(null,"height",""+i),l.setAttributeNS(null,"viewBox",`0 0 ${r} ${i}`);const d=document.createElement("div");d.classList.add("audio-time"),e.append(l,d);let c=s.attributes.find(e=>"documentAttributeAudio"===e._).waveform||new Uint8Array([]);c=function(e){e instanceof Uint8Array||(e=new Uint8Array(e));const t=8*e.length/5|0;if(!t)return new Uint8Array([]);let s;try{const i=new DataView(e.buffer);s=new Uint8Array(t);for(let e=0;e<t;e++){const t=5*e/8|0,n=5*e%8,a=i.getUint16(t,!0);s[e]=a>>n&31}}catch(e){s=new Uint8Array([])}return s}(c.slice(0,63));const h=Math.max(...c),u=c.length?c.length:100,p=Math.min(r/4|0,u);let g=0;const m=i-4;let b="";for(let e=0,t=0,s=0;e<u;++e){const n=c[e]||0;if(s+p>=u){s=s+p-u,s<(p+1)/2&&g<n&&(g=n);const e=Math.max((g*m+(h+1)/2)/(h+1),4);b+=`\n      <rect x="${t}" y="${i-e}" width="2" height="${e}" rx="1" ry="1"></rect>\n      `,t+=4,g=s<(p+1)/2?0:n}else g<n&&(g=n),s+=p}l.insertAdjacentHTML("beforeend",b);const y=Array.from(l.children);let w=e.querySelector(".audio-waveform");return()=>{let t=e.audio;const s=()=>{const e=t.currentTime===t.duration?0:Math.ceil(t.currentTime/t.duration*p);y.forEach((t,s)=>t.classList.toggle("active",s<e))};(!t.paused||t.currentTime>0&&t.currentTime!==t.duration)&&s();const i=Ti(s);return e.addAudioListener("timeupdate",i),e.addAudioListener("ended",i),e.readyPromise.then(()=>{let e=!1,s=!1;function i(e){let s;if(e instanceof MouseEvent)s=e.offsetX;else{const t=e.target.getBoundingClientRect();s=e.targetTouches[0].pageX-t.left}const i=s/r*t.duration;t.currentTime=i}w.addEventListener("mouseleave",i=>{e&&(t.play(),e=!1),s=!1}),w.addEventListener("mousemove",t=>{s=!0,e&&i(t)}),w.addEventListener("mousedown",s=>{s.preventDefault(),0===s.button&&(t.paused||t.pause(),i(s),e=!0)}),w.addEventListener("mouseup",i=>{s&&e&&(t.play(),e=!1)}),Object(v.b)(w,e=>{Object(f.a)(e),t.paused||i(e)})},we.a),()=>{w.remove(),w=null,t=null}}}function Ai(e=!0){const t=new y({cancelable:!0,tryAgainOnFail:e});return t.construct(),e||(t.circle.setAttributeNS(null,"r","23"),t.totalLength=143.58203125),t}ki.PLAYBACK_RATES=[.5,1,1.5,2],ki.PLAYBACK_RATES_ICONS=["playback_05","playback_1x","playback_15","playback_2x"],H.default.addEventListener("messages_media_read",({mids:e,peerId:t})=>{e.forEach(e=>{const s=`[data-mid="${e}"][data-peer-id="${t}"]`;Array.from(document.querySelectorAll(`audio-element.is-unread${s}, .media-round.is-unread${s}`)).forEach(e=>{e.classList.remove("is-unread")})})});const Oi=e=>{let t,s;const i=!e.classList.contains("search-super-item"),n=Object(ti.a)(e,i?"bubbles-inner":"tabs-tab");if(n){const a=':not([data-is-outgoing="1"])',o=".audio:not(.is-voice)"+a;let r;if(r=e.matches(o)?[o]:[".audio.is-voice"+a,".media-round"+a],i){const e=".bubble:not(.webpage) ";r=r.map(t=>e+t)}const l=r.join(", "),d=Array.from(n.querySelectorAll(l)),c=d.indexOf(e),h=d.map(e=>({peerId:e.dataset.peerId.toPeerId(),mid:+e.dataset.mid}));t=h.slice(0,c),s=h.slice(c+1)}return[t,s]};class Fi extends HTMLElement{constructor(){super(...arguments),this.withTime=!1,this.voiceAsMusic=!1,this.showSender=!1,this.listenerSetter=new Gs}render(){var e,t;this.classList.add("audio"),this.dataset.mid=""+this.message.mid,this.dataset.peerId=""+this.message.peerId;const s=js.getMediaFromMessage(this.message),i="voice"===s.type,n=!this.voiceAsMusic&&i,a=this.message.pFlags.is_outgoing,o=a&&this.preloader,r=String(0|s.duration).toHHMMSS();this.innerHTML='\n    <div class="audio-toggle audio-ico">\n      <div class="audio-play-icon">\n        <div class="part one" x="0" y="0" fill="#fff"></div>\n        <div class="part two" x="0" y="0" fill="#fff"></div>\n      </div>\n    </div>';const l=this.firstElementChild,d=document.createElement("div");d.classList.add("audio-download");"audio"!==s.type&&this.message&&this.message.pFlags.media_unread&&this.classList.add("is-unread"),o&&(this.classList.add("is-outgoing"),this.append(d));const c=n?xi(this):function(e){const t=e.withTime,s=e.message,i=js.getMediaFromMessage(s),n="voice"===i.type||"round"===i.type,a=document.createElement("div");if(a.classList.add("audio-description"),!n){const n=[];i.audioPerformer&&n.push(Object(He.a)(i.audioPerformer)),t?n.push(Object(S.c)(s.date)):n.length||n.push(Object(ds.b)(i.size)),e.showSender&&n.push(js.wrapSenderToPeer(s)),a.append(...Object(O.joinElementsWith)(n," â€¢ "))}e.insertAdjacentHTML("beforeend",'\n  <div class="audio-details">\n    <div class="audio-title"></div>\n    <div class="audio-subtitle"><div class="audio-time"></div></div>\n  </div>');const o=e.querySelector(".audio-title"),r=new ys;r.dataset.fontWeight=e.dataset.fontWeight,n?r.append(js.wrapSenderToPeer(s)):Object(xe.a)(r,i.audioTitle||i.fileName),o.append(r),e.showSender&&o.append(js.wrapSentTime(s));const l=e.querySelector(".audio-subtitle");return l.append(a),()=>{let t=!1,s=new Ei(e.audio,i.supportsStreaming);e.addAudioListener("ended",()=>{e.classList.remove("audio-show-progress"),l.lastChild.replaceWith(a),t=!1});const n=()=>{t||(e.classList.add("audio-show-progress"),t=!0,s&&l.lastChild.replaceWith(s.container))};return e.addAudioListener("play",n),(!e.audio.paused||e.audio.currentTime>0)&&n(),()=>{s.removeListeners(),s.container.remove(),s=null}}}(this),h=this.querySelector(".audio-time");h.innerHTML=r;const u=this.onLoad=e=>{this.onLoad=void 0;const t=this.audio=yi.addMedia(this.message,e),s=this.readyPromise=Object(w.a)();this.audio.readyState>=this.audio.HAVE_CURRENT_DATA?s.resolve():this.addAudioListener("canplay",()=>s.resolve(),{once:!0}),this.onTypeDisconnect=c();const i=()=>String(0|t.currentTime).toHHMMSS()+(n?" / "+r:""),a=()=>{h.innerText=i(),l.classList.toggle("playing",!t.paused)};(!t.paused||t.currentTime>0&&t.currentTime!==t.duration)&&a();const o=(e,s=t.paused)=>{if(e&&Object(f.a)(e),s){const e=!!this.searchContext;if(yi.setSearchContext(this.searchContext||{peerId:Z.b,inputFilter:{_:"inputMessagesFilterEmpty"},useSearch:!1})){const[t,s]=e?Oi(this):[];yi.setTargets({peerId:this.message.peerId,mid:this.message.mid},t,s)}t.play().catch(()=>{})}else t.pause()};return Object(v.b)(l,e=>o(e),{listenerSetter:this.listenerSetter}),this.addAudioListener("ended",()=>{l.classList.remove("playing"),h.innerText=r}),this.addAudioListener("timeupdate",()=>{!t.currentTime&&t.paused||yi.isSafariBuffering(t)||(h.innerText=i())}),this.addAudioListener("pause",()=>{l.classList.remove("playing")}),this.addAudioListener("play",a),o};if(null===(e=s.thumbs)||void 0===e?void 0:e.length){const e=[],t=Oa({photo:s,message:null,container:l,boxWidth:48,boxHeight:48,loadPromises:this.loadPromises,withoutPreloader:!0,lazyLoadQueue:this.lazyLoadQueue});l.style.width=l.style.height="",t.images.thumb&&e.push(t.images.thumb),t.images.full&&e.push(t.images.full),this.classList.add("audio-with-thumb"),e.forEach(e=>e.classList.add("audio-thumb"))}if(a)o&&(this.dataset.isOutgoing="1",this.preloader.attach(d,!1));else{let e=this.preloader;u("audio"!==s.type&&!this.noAutoDownload);const i=t=>{if(this.audio.src)return;yi.resolveWaitingForLoadMedia(this.message.peerId,this.message.mid,this.message.pFlags.is_scheduled);const i=()=>{t&&(yi.willBePlayed(this.audio),C.IS_SAFARI&&!this.audio.autoplay&&(this.audio.autoplay=!0))};if(i(),!e)if(s.supportsStreaming){let e;this.classList.add("corner-download");const t=()=>{const t=Ai(!1),s=Object(w.a)();s.notifyAll({done:75,total:100}),s.catch(()=>{this.audio.pause(),yi.willBePlayed(void 0)}),s.cancel=()=>{s.cancel=we.a;const e=new Error;e.type="CANCELED",s.reject(e)},t.attach(d,!1,s),e=this.addAudioListener("pause",()=>{s.cancel()},{once:!0}),i()},s=this.addAudioListener("play",t);this.readyPromise.then(()=>{this.listenerSetter.remove(s),this.listenerSetter.remove(e)})}else{e=Ai(),t||(this.readyPromise=Object(w.a)());const n=()=>{i();const n=es.downloadDoc(s);return t||n.then(()=>{this.readyPromise.resolve()}),e.attach(d,!1,n),{download:n}};e.setDownloadFunction(n),n()}this.append(d),this.classList.add("downloading"),this.readyPromise.then(()=>{this.classList.remove("downloading"),d.classList.add("downloaded"),setTimeout(()=>{d.remove()},200),yi.willBePlayedMedia===this.audio&&(this.audio.play(),yi.willBePlayed(void 0))})};(null===(t=this.audio)||void 0===t?void 0:t.src)||("audio"===s.type||this.noAutoDownload?Object(v.b)(l,()=>{i(!0)},{once:!0,capture:!0,passive:!1,listenerSetter:this.listenerSetter}):i(!1))}}get addAudioListener(){return this.listenerSetter.add(this.audio)}disconnectedCallback(){this.isConnected||(this.onTypeDisconnect&&(this.onTypeDisconnect(),this.onTypeDisconnect=null),this.readyPromise&&this.readyPromise.reject(),this.listenerSetter.removeAll(),this.listenerSetter=null,this.preloader=null)}}customElements.define("audio-element",Fi);class Di{constructor(e,t){this.className=e,this.fill=t,this.container=document.createElement("div"),this.container.className=e,this.border=document.createElement("div"),this.border.classList.add(e+"-border"),this.content=document.createElement("div"),this.content.classList.add(e+"-content"),this.title=document.createElement("div"),this.title.classList.add(e+"-title"),this.title.setAttribute("dir","auto"),this.subtitle=document.createElement("div"),this.subtitle.classList.add(e+"-subtitle"),this.subtitle.setAttribute("dir","auto"),this.content.append(this.title,this.subtitle),this.container.append(this.border,this.content)}}function ji(e){var t,s;let{title:i,titleEl:n,subtitle:a,subtitleEl:o,mediaEl:r,message:l,loadPromises:d}=e;void 0!==i&&("string"==typeof i&&(i=Object(A.f)(i,140),i=N.a.wrapEmojiText(i)),Object(le.a)(n,i)),d||(d=[]);let c=l&&l.media,h=!1,u=!1;const p=r?Array.from(r.children).slice():[];let g;if(c&&r){if(o.textContent="",o.append(js.wrapMessageForReply(l,void 0,void 0,void 0,void 0,!0)),c.webpage&&(c=c.webpage),c.photo||c.document&&(null===(t=c.document.thumbs)||void 0===t?void 0:t.length)){g=Pd.chat.bubbles.getMiddleware();const e=Pd.chat.bubbles.lazyLoadQueue;if("sticker"===(null===(s=c.document)||void 0===s?void 0:s.type))h=!0,Da({doc:c.document,div:r,lazyLoadQueue:e,group:Sd,width:32,height:32,middleware:g,loadPromises:d});else{const t=c.photo||c.document;u="round"===t.type;try{Oa({photo:t,container:r,boxWidth:32,boxHeight:32,size:Dt.choosePhotoSize(t,32,32),middleware:g,lazyLoadQueue:e,noBlur:!0,withoutPreloader:!0,loadPromises:d}),h=!0}catch(e){}}}}else l?(o.textContent="",o.append(js.wrapMessageForReply(l,l.message&&Object(A.f)(l.message,140)))):("string"==typeof a&&(a=Object(A.f)(a,140),a=N.a.wrapEmojiText(a)),Object(le.a)(o,a||""));return Promise.all(d).then(()=>{g&&!g()||(p.forEach(e=>e.remove()),r&&r.classList.toggle("is-round",u))}),h}class Ri extends Di{constructor(e){super(e,(e,t="",s)=>{this.mediaEl||(this.mediaEl=document.createElement("div"),this.mediaEl.classList.add(this.className+"-media"));const i=ji({title:e,titleEl:this.title,subtitle:t,subtitleEl:this.subtitle,mediaEl:this.mediaEl,message:s});this.container.classList.toggle("is-media",i),i?this.content.prepend(this.mediaEl):this.mediaEl.remove()}),this.className=e}}const Bi=0,Ui=1,Ni=2,Hi=4,zi=8;class Wi{constructor(e,t,s,i,n=t){this.sizes=e,this.maxWidth=t,this.minWidth=s,this.spacing=i,this.maxHeight=n,this.count=e.length,this.ratios=Wi.countRatios(e),this.proportions=Wi.countProportions(this.ratios),this.averageRatio=Object(a.a)(this.ratios,1)/this.count,this.maxSizeRatio=t/this.maxHeight}layout(){return this.count?this.count>=5||this.ratios.find(e=>e>2)?new qi(this.ratios,this.averageRatio,this.maxWidth,this.minWidth,this.spacing).layout():2===this.count?this.layoutTwo():3===this.count?this.layoutThree():this.layoutFour():[]}layoutTwo(){return"ww"===this.proportions&&this.averageRatio>1.4*this.maxSizeRatio&&this.ratios[1]-this.ratios[0]<.2?this.layoutTwoTopBottom():"ww"===this.proportions||"qq"===this.proportions?this.layoutTwoLeftRightEqual():this.layoutTwoLeftRight()}layoutThree(){return"n"===this.proportions[0]?this.layoutThreeLeftAndOther():this.layoutThreeTopAndOther()}layoutFour(){return"w"===this.proportions[0]?this.layoutFourTopAndOther():this.layoutFourLeftAndOther()}layoutTwoTopBottom(){const e=this.maxWidth,t=Math.round(Math.min(e/this.ratios[0],Math.min(e/this.ratios[1],(this.maxHeight-this.spacing)/2)));return[{geometry:{x:0,y:0,width:e,height:t},sides:zi|Ui|Ni},{geometry:{x:0,y:t+this.spacing,width:e,height:t},sides:zi|Hi|Ni}]}layoutTwoLeftRightEqual(){const e=(this.maxWidth-this.spacing)/2,t=Math.round(Math.min(e/this.ratios[0],Math.min(e/this.ratios[1],1*this.maxHeight)));return[{geometry:{x:0,y:0,width:e,height:t},sides:Ui|zi|Hi},{geometry:{x:e+this.spacing,y:0,width:e,height:t},sides:Ui|Ni|Hi}]}layoutTwoLeftRight(){const e=Math.round(1.5*this.minWidth),t=Math.min(Math.round(Math.max(.4*(this.maxWidth-this.spacing),(this.maxWidth-this.spacing)/this.ratios[0]/(1/this.ratios[0]+1/this.ratios[1]))),this.maxWidth-this.spacing-e),s=this.maxWidth-t-this.spacing,i=Math.min(this.maxHeight,Math.round(Math.min(s/this.ratios[0],t/this.ratios[1])));return[{geometry:{x:0,y:0,width:s,height:i},sides:Ui|zi|Hi},{geometry:{x:s+this.spacing,y:0,width:t,height:i},sides:Ui|Ni|Hi}]}layoutThreeLeftAndOther(){const e=this.maxHeight,t=Math.round(Math.min((this.maxHeight-this.spacing)/2,this.ratios[1]*(this.maxWidth-this.spacing)/(this.ratios[2]+this.ratios[1]))),s=e-t-this.spacing,i=Math.max(this.minWidth,Math.round(Math.min((this.maxWidth-this.spacing)/2,Math.min(t*this.ratios[2],s*this.ratios[1])))),n=Math.min(Math.round(e*this.ratios[0]),this.maxWidth-this.spacing-i);return[{geometry:{x:0,y:0,width:n,height:e},sides:Ui|zi|Hi},{geometry:{x:n+this.spacing,y:0,width:i,height:s},sides:Ui|Ni},{geometry:{x:n+this.spacing,y:s+this.spacing,width:i,height:t},sides:Hi|Ni}]}layoutThreeTopAndOther(){const e=this.maxWidth,t=Math.round(Math.min(e/this.ratios[0],.66*(this.maxHeight-this.spacing))),s=(this.maxWidth-this.spacing)/2,i=Math.min(this.maxHeight-t-this.spacing,Math.round(Math.min(s/this.ratios[1],s/this.ratios[2]))),n=e-s-this.spacing;return[{geometry:{x:0,y:0,width:e,height:t},sides:zi|Ui|Ni},{geometry:{x:0,y:t+this.spacing,width:s,height:i},sides:Hi|zi},{geometry:{x:s+this.spacing,y:t+this.spacing,width:n,height:i},sides:Hi|Ni}]}layoutFourTopAndOther(){const e=this.maxWidth,t=Math.round(Math.min(e/this.ratios[0],.66*(this.maxHeight-this.spacing))),s=Math.round((this.maxWidth-2*this.spacing)/(this.ratios[1]+this.ratios[2]+this.ratios[3])),i=Math.max(this.minWidth,Math.round(Math.min(.4*(this.maxWidth-2*this.spacing),s*this.ratios[1]))),n=Math.round(Math.max(Math.max(1*this.minWidth,.33*(this.maxWidth-2*this.spacing)),s*this.ratios[3])),a=e-i-n-2*this.spacing,o=Math.min(this.maxHeight-t-this.spacing,s);return[{geometry:{x:0,y:0,width:e,height:t},sides:zi|Ui|Ni},{geometry:{x:0,y:t+this.spacing,width:i,height:o},sides:Hi|zi},{geometry:{x:i+this.spacing,y:t+this.spacing,width:a,height:o},sides:Hi},{geometry:{x:i+this.spacing+a+this.spacing,y:t+this.spacing,width:n,height:o},sides:Ni|Hi}]}layoutFourLeftAndOther(){const e=this.maxHeight,t=Math.round(Math.min(e*this.ratios[0],.6*(this.maxWidth-this.spacing))),s=Math.round((this.maxHeight-2*this.spacing)/(1/this.ratios[1]+1/this.ratios[2]+1/this.ratios[3])),i=Math.round(s/this.ratios[1]),n=Math.round(s/this.ratios[2]),a=e-i-n-2*this.spacing,o=Math.max(this.minWidth,Math.min(this.maxWidth-t-this.spacing,s));return[{geometry:{x:0,y:0,width:t,height:e},sides:Ui|zi|Hi},{geometry:{x:t+this.spacing,y:0,width:o,height:i},sides:Ui|Ni},{geometry:{x:t+this.spacing,y:i+this.spacing,width:o,height:n},sides:Ni},{geometry:{x:t+this.spacing,y:i+n+2*this.spacing,width:o,height:a},sides:Hi|Ni}]}static countRatios(e){return e.map(e=>e.w/e.h)}static countProportions(e){return e.map(e=>e>1.2?"w":e<.8?"n":"q").join("")}}class qi{constructor(e,t,s,i,n,a=4*s/3){this.averageRatio=t,this.maxWidth=s,this.minWidth=i,this.spacing=n,this.maxHeight=a,this.ratios=qi.cropRatios(e,t),this.count=e.length}static cropRatios(e,t){return e.map(e=>t>1.1?Object(ds.a)(e,1,2.75):Object(ds.a)(e,.6667,1))}layout(){let e=new Array(this.count),t=[];const s=(e,t)=>{const s=this.ratios.slice(e,e+t),i=Object(a.a)(s,0);return(this.maxWidth-(t-1)*this.spacing)/i},i=e=>{let i=[],n=0;for(let t of e)i.push(s(n,t)),n+=t;t.push({lineCounts:e,heights:i})};for(let e=1;e!==this.count;++e){const t=this.count-e;e>3||t>3||i([e,t])}for(let e=1;e!==this.count-1;++e)for(let t=1;t!==this.count-e;++t){const s=this.count-e-t;e>3||t>(this.averageRatio<.85?4:3)||s>3||i([e,t,s])}for(let e=1;e!==this.count-1;++e)for(let t=1;t!==this.count-e;++t)for(let s=1;s!==this.count-e-t;++s){const n=this.count-e-t-s;e>3||t>3||s>3||n>3||i([e,t,s,n])}let n=null,o=0;for(const e of t){const{heights:t,lineCounts:s}=e,i=s.length,r=Object(a.a)(t,0)+this.spacing*(i-1),l=Math.min(...t),d=(Math.max(...t),l<this.minWidth?1.5:1),c=(()=>{for(let e=1;e!==i;++e)if(s[e-1]>s[e])return 1.5;return 1})(),h=Math.abs(r-this.maxHeight)*d*c;(!n||h<o)&&(n=e,o=h)}if(!(null==n?void 0:n.lineCounts))return;const r=n.lineCounts,l=n.heights,d=r.length;let c=0,h=0;for(let t=0;t!==d;++t){const s=r[t],i=l[t],n=Math.round(i);let a=0;for(let o=0;o!==s;++o){const r=Bi|(0===t?Ui:Bi)|(t===d-1?Hi:Bi)|(0===o?zi:Bi)|(o===s-1?Ni:Bi),l=this.ratios[c],u=o===s-1?this.maxWidth-a:Math.round(l*i);e[c]={geometry:{x:a,y:h,width:u,height:n},sides:r},a+=u+this.spacing,++c}h+=n+this.spacing}return e}}class Vi{constructor(e){this._disabled=!1,this.avatarSize=120,this.isChanged=()=>{if(this.uploadAvatar)return!0;let e=0,t=0,s=0;return this.inputFields.forEach(i=>{i.isValid()&&(i.isChanged()&&++e,i.required&&++s),i.required&&++t}),t===s&&e>0},this.handleChange=()=>{this.nextBtn.classList.toggle("is-visible",this.isChanged())},Object(m.g)(this,e),this.nextBtn?this.nextBtn.classList.contains("btn-corner")||(this.handleChange=()=>{this.nextBtn.toggleAttribute("disabled",!this.isChanged()||this.disabled)}):this.nextBtn=li({icon:"check"}),e.withoutAvatar||(this.avatarElem=document.createElement("avatar-element"),this.avatarElem.classList.add("avatar-placeholder","avatar-"+this.avatarSize),this.avatarElem.setAttribute("peer",""+this.peerId),e.doNotEditAvatar||(this.avatarEdit=new ri(e=>{this.uploadAvatar=e,this.handleChange(),this.avatarElem.remove()}),this.avatarEdit.container.append(this.avatarElem))),this.inputFields.forEach(e=>{this.listenerSetter.add(e.input)("input",this.handleChange)}),this.handleChange()}get disabled(){return this._disabled}set disabled(e){this._disabled=e,this.inputFields.forEach(t=>t.input.toggleAttribute("disabled",e)),this.handleChange()}lockWithPromise(e,t=!1){this.disabled=!0,e.then(()=>{t&&(this.disabled=!1)},()=>{this.disabled=!1})}}var Gi=s(155);function Ki(e,t){const s=document.createElement("form");return e.forEach(e=>{const{container:i,input:n}=e;s.append(i),n.addEventListener("change",e=>{n.checked&&t(n.value,e)})}),s}class Qi{constructor(e={}){this.freezed=!1,e.checkboxFieldOptions&&(e.checkboxField=new Gi.a(Object.assign({listenerSetter:e.listenerSetter},e.checkboxFieldOptions))),this.container=document.createElement(e.radioField||e.checkboxField?"label":"div"),this.container.classList.add("row"),this.subtitle=document.createElement("div"),this.subtitle.classList.add("row-subtitle"),this.subtitle.setAttribute("dir","auto"),e.subtitle?"string"==typeof e.subtitle?Object(xe.a)(this.subtitle,e.subtitle):this.subtitle.append(e.subtitle):e.subtitleLangKey&&this.subtitle.append(Object(O.i18n)(e.subtitleLangKey,e.subtitleLangArgs)),this.container.append(this.subtitle);let t=!!e.havePadding;if(e.radioField||e.checkboxField){if(t=!0,e.radioField&&(this.radioField=e.radioField,this.container.append(this.radioField.label)),e.checkboxField){this.checkboxField=e.checkboxField;const s=e.checkboxField.label.classList.contains("checkbox-field-toggle");if(s?(this.container.classList.add("row-with-toggle"),e.titleRight=this.checkboxField.label):(t=!0,this.checkboxField.span||this.checkboxField.label.classList.add("checkbox-field-absolute"),this.container.append(this.checkboxField.label)),e.withCheckboxSubtitle&&!s){const t=()=>{Object(le.a)(this.subtitle,Object(O.i18n)(this.checkboxField.input.checked?"Checkbox.Enabled":"Checkbox.Disabled"))};e.listenerSetter?e.listenerSetter.add(this.checkboxField.input)("change",t):this.checkboxField.input.addEventListener("change",t)}}(e.radioField||e.checkboxField).label.classList.add("disable-hover")}if(e.title||e.titleLangKey){let t;const s=e.titleRight||e.titleRightSecondary;if(s?(t=document.createElement("div"),t.classList.add("row-title-row"),this.container.append(t)):t=this.container,this.title=document.createElement("div"),this.title.classList.add("row-title"),this.title.setAttribute("dir","auto"),e.title?"string"==typeof e.title?this.title.innerHTML=e.title:this.title.append(e.title):this.title.append(Object(O.i18n)(e.titleLangKey)),t.append(this.title),s){const i=this.titleRight=document.createElement("div");i.classList.add("row-title","row-title-right"),e.titleRightSecondary&&i.classList.add("row-title-right-secondary"),"string"==typeof s?i.innerHTML=s:i.append(s),t.append(i)}}e.icon&&(t=!0,this.title.classList.add("tgico","tgico-"+e.icon),this.container.classList.add("row-with-icon")),t&&this.container.classList.add("row-with-padding"),e.navigationTab&&(e.clickable=()=>e.navigationTab.open()),(e.clickable||e.radioField||e.checkboxField)&&("function"==typeof e.clickable&&this.container.addEventListener("click",t=>{this.freezed||e.clickable(t)}),this.container.classList.add("row-clickable","hover-effect"),e.noRipple||Object(ei.ripple)(this.container,void 0,void 0,!0))}}const $i=(e,t)=>Ki(e.map(e=>({container:e.container,input:e.radioField.input})),t);function Yi(e){navigator.clipboard?navigator.clipboard.writeText(e):function(e){var t=document.createElement("textarea");t.value=e,t.style.top="0",t.style.left="0",t.style.position="fixed",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy")}catch(e){}document.body.removeChild(t)}(e)}class Xi{constructor(e){const t=this.label=document.createElement("label");t.classList.add("radio-field");const s=this.input=document.createElement("input");s.type="radio",s.name="input-radio-"+e.name,e.value&&(s.value=e.value,e.stateKey&&(ve.default.getState().then(t=>{s.checked=Object(m.d)(t,e.stateKey)===e.value}),s.addEventListener("change",()=>{ve.default.setByKey(e.stateKey,e.value)})));const i=this.main=document.createElement("div");i.classList.add("radio-field-main"),e.text?i.innerHTML=e.text:e.langKey&&Object(O._i18n)(i,e.langKey),t.append(s,i)}get checked(){return this.input.checked}set checked(e){this.setValueSilently(e);const t=new Event("change",{bubbles:!0,cancelable:!0});this.input.dispatchEvent(t)}setValueSilently(e){this.input.checked=e}}function Zi(e,t,s=!0,i=!0){let n,a,o,r,l=!1;const d=t=>{const s=o,i=r;try{s(e.apply(null,t))}catch(e){console.error("debounce error",e),i(e)}},c=(...e)=>{a||(a=new Promise((e,t)=>(o=e,r=t))),n?(clearTimeout(n),l=!0,r(),a=new Promise((e,t)=>(o=e,r=t))):s&&(d(e),l=!1);const c=J.a.setTimeout(()=>{!i||s&&!l||d(e),n===c&&(n=a=o=r=void 0,l=!1)},t);return n=c,a.catch(we.a),a};return c.clearTimeout=()=>{n&&(J.a.clearTimeout(n),r(),n=a=o=r=void 0,l=!1)},c.isDebounced=()=>!!n,c}class Ji extends Ws.b{constructor(e){super(e),this.checkUsernameDebounced=Zi(this.checkUsername.bind(this),150,!1,!0),e.listenerSetter.add(this.input)("input",()=>{const e=this.getValue();if(e===this.originalValue||!e.length)return this.setState(Ws.a.Neutral,this.options.label),void(this.options.onChange&&this.options.onChange());N.b.isUsernameValid(e)?this.setState(Ws.a.Neutral):this.setError(this.options.invalidText),this.input.classList.contains("error")?this.options.onChange&&this.options.onChange():this.checkUsernameDebounced(e)})}getValue(){let e=this.value;return this.options.head&&(e=e.slice(this.options.head.length),this.setValueSilently(this.options.head+e)),e}checkUsername(e){this.checkUsernamePromise||(this.options.peerId?this.checkUsernamePromise=F.a.invokeApi("channels.checkUsername",{channel:Pe.getChannelInput(this.options.peerId.toChatId()),username:e}):this.checkUsernamePromise=F.a.invokeApi("account.checkUsername",{username:e}),this.checkUsernamePromise.then(t=>{this.getValue()===e&&(t?this.setState(Ws.a.Valid,this.options.availableText):this.setError(this.options.takenText))},t=>{if(this.getValue()===e)switch(t.type){case"USERNAME_INVALID":this.setError(this.options.invalidText)}}).then(()=>{this.checkUsernamePromise=void 0,this.options.onChange&&this.options.onChange();const t=this.getValue();t!==e&&this.isValidToChange()&&N.b.isUsernameValid(t)&&this.checkUsername(t)}))}}class en extends ni{constructor(e,t={}){if(super("popup-peer"+(e?" "+e:""),t.buttons&&ai(t.buttons),Object.assign({overlayClosable:!0},t)),this.className=e,t.peerId){let e=new Od;e.setAttribute("dialog","1"),e.setAttribute("peer",""+t.peerId),e.classList.add("avatar-32"),this.header.prepend(e)}t.noTitle||(t.titleLangKey||!t.title?this.title.append(Object(O.i18n)(t.titleLangKey||"AppName",t.titleLangArgs)):this.title.innerText=t.title||"");const s=document.createDocumentFragment();if(t.descriptionLangKey||t.description){const e=document.createElement("p");e.classList.add("popup-description"),t.descriptionLangKey?e.append(Object(O.i18n)(t.descriptionLangKey,t.descriptionLangArgs)):t.description&&Object(xe.a)(e,t.description),s.append(e)}t.checkboxes&&(this.container.classList.add("have-checkbox"),t.checkboxes.forEach(e=>{e.withRipple=!1;const t=new Gi.a(e);e.checkboxField=t,s.append(t.label)}),t.buttons.forEach(e=>{if(e.callback){const s=e.callback;e.callback=()=>{const e=new Set;t.checkboxes.forEach(t=>{t.checkboxField.checked&&e.add(t.text)}),s(e)}}})),this.container.insertBefore(s,this.header.nextElementSibling)}}var tn=s(157);class sn extends Xs{init(){this.container.classList.add("edit-peer-container","group-type-container");const e=Pe.isBroadcast(this.chatId);this.setTitle(e?"ChannelType":"GroupType");const t=new fr({name:e?"ChannelType":"GroupType"}),s=Object(x.b)(),i=new Qi({radioField:new Xi({langKey:e?"ChannelPrivate":"MegaPrivate",name:s,value:"private"}),subtitleLangKey:e?"ChannelPrivateInfo":"MegaPrivateInfo"}),n=new Qi({radioField:new Xi({langKey:e?"ChannelPublic":"MegaPublic",name:s,value:"public"}),subtitleLangKey:e?"ChannelPublicInfo":"MegaPublicInfo"}),a=$i([i,n],e=>{const t=[r,c];"public"===e&&t.reverse(),t[0].container.classList.remove("hide"),t[1].container.classList.add("hide"),u()}),o=Pe.getChat(this.chatId);t.content.append(a);const r=new fr({}),l=new Qi({title:this.chatFull.exported_invite.link,subtitleLangKey:e?"ChannelPrivateLinkHelp":"MegaPrivateLinkHelp",clickable:()=>{Yi(this.chatFull.exported_invite.link),Qt(O.default.format("LinkCopied",!0))}}),d=Object(Ks.a)("btn-primary btn-transparent danger",{icon:"delete",text:"RevokeLink"});Object(v.b)(d,()=>{new en("revoke-link",{buttons:[{langKey:"RevokeButton",callback:()=>{const e=Object(tn.a)([d],!0);Ts.getChatInviteLink(this.chatId,!0).then(t=>{e(),l.title.innerHTML=t})}}],titleLangKey:"RevokeLink",descriptionLangKey:"RevokeAlert"}).show()},{listenerSetter:this.listenerSetter}),r.content.append(l.container,d);const c=new fr({caption:e?"Channel.UsernameAboutChannel":"Channel.UsernameAboutGroup",noDelimiter:!0}),h=document.createElement("div");h.classList.add("input-wrapper");const u=()=>{const e=i.radioField.checked&&"eitaa.com/"!==g||p.isValidToChange()&&p.input.classList.contains("valid");m.classList.toggle("is-visible",e)},p=new Ji({label:"SetUrlPlaceholder",name:"group-public-link",plainText:!0,listenerSetter:this.listenerSetter,availableText:"Link.Available",invalidText:"Link.Invalid",takenText:"Link.Taken",onChange:u,peerId:this.chatId.toPeerId(!0),head:"eitaa.com/"}),g="eitaa.com/"+(o.username||"");h.append(p.container),c.content.append(h);const m=li({icon:"check",className:"is-visible"});this.content.append(m),Object(v.b)(m,()=>{Object(hi.g)(m);const e=n.radioField.checked?p.getValue():"";Pe.migrateChat(this.chatId).then(t=>Pe.updateUsername(t,e)).then(()=>{this.close()})},{listenerSetter:this.listenerSetter}),("eitaa.com/"!==g?n:i).radioField.checked=!0,p.setOriginalValue(g),Pe.isChannel(this.chatId)&&!Pe.isMegagroup(this.chatId)&&this.scrollable.append(t.container),this.scrollable.append(r.container,c.container);{const t=new fr({name:"SavingContentTitle",caption:e?"RestrictSavingContentInfoChannel":"RestrictSavingContentInfoGroup"}),s=new Gi.a({text:"RestrictSavingContent",withRipple:!0});this.listenerSetter.add(s.input)("change",()=>{const e=s.toggleDisability(!0);Pe.toggleNoForwards(this.chatId,s.checked).then(()=>{e()})});const i=()=>{s.setValueSilently(!!o.pFlags.noforwards)};this.listenerSetter.add(H.default)("chat_update",e=>{this.chatId===e&&i()}),i(),t.content.append(s.label),this.scrollable.append(t.container)}}}var nn=s(169);class an{constructor(e){this.loading=!1,this.loaded=!1,Object(m.g)(this,e),e.scrollable.onScrolledBottom=()=>{this.load()}}load(){return this.loaded?Promise.resolve():this.loading?this.promise:(this.loading=!0,void(this.promise=this.getPromise().then(e=>{this.loading=!1,this.promise=void 0,e?(this.loaded=!0,this.scrollable.onScrolledBottom=null):this.scrollable.checkForTriggers()},()=>{this.promise=void 0,this.loading=!1})))}}class on{constructor(e){Object(m.g)(this,e)}createField(e){var t;const{info:s,isNested:i,isDisabled:n}=e;if(s.nestedTo&&!i)return;const a=s.row=new Qi({titleLangKey:i?void 0:s.text,checkboxField:s.checkboxField=new Gi.a({text:i?s.text:void 0,checked:!s.nested&&s.checked,toggle:!i,listenerSetter:this.listenerSetter,restriction:this.asRestrictions&&!i,name:s.name,disabled:n}),listenerSetter:this.listenerSetter,subtitleLangKey:s.description,clickable:s.nested?e=>{Object(zt.a)(e.target,a.checkboxField.label)||(Object(f.a)(e),a.container.classList.toggle("accordion-toggler-expanded"),r.classList.toggle("is-expanded"))}:void 0});s.restrictionText&&(s.checkboxField.label.lastElementChild.classList.add("with-lock","tgico"),s.checkboxField.input.disabled=!0,Object(v.b)(s.row.container,e=>{Qt(O.default.format(s.restrictionText,!0))},{listenerSetter:this.listenerSetter}));const o=[a.container];let r,l;if(s.nested){const e=r=document.createElement("div");e.classList.add("accordion"),e.style.setProperty("--max-height",48*s.nested.length+"px");const i=s;s.nested.forEach(t=>{var s;null!==(s=t.nestedTo)&&void 0!==s||(t.nestedTo=i),e.append(...this.createField({info:t,isNested:!0}).nodes)}),o.push(e);const n=document.createElement("span");n.classList.add("tgico-down","accordion-icon"),l=s.nestedCounter=document.createElement("b"),this.setNestedCounter(s),a.title.append(" ",l," ",n),a.container.classList.add("accordion-toggler"),a.title.classList.add("with-delimiter"),a.checkboxField.setValueSilently(this.getNestedCheckedLength(s)===s.nested.length),null!==(t=s.toggleWith)&&void 0!==t||(s.toggleWith={checked:s.nested,unchecked:s.nested})}if(s.toggleWith||s.nestedTo){const e=s.toggleWith?t=>{const{toggleWith:s,nested:i}=t,n=t.checkboxField.checked,a=n?s.checked:s.unchecked;if(!a)return;this.fields.filter(e=>a.includes(e)).forEach(t=>{t.checkboxField.setValueSilently(n),t.nestedTo&&!i&&this.setNestedCounter(t.nestedTo),t.toggleWith&&e(t)}),t.nested&&this.setNestedCounter(t)}:void 0,t=s.nestedTo?()=>{const e=this.getNestedCheckedLength(s.nestedTo);s.nestedTo.checkboxField.setValueSilently(e===s.nestedTo.nested.length),this.setNestedCounter(s.nestedTo,e)}:void 0;this.listenerSetter.add(s.checkboxField.input)("change",()=>{null==e||e(s),null==t||t()})}return{row:a,nodes:o}}getNestedCheckedLength(e){return e.nested.reduce((e,t)=>e+ +t.checkboxField.checked,0)}setNestedCounter(e,t=this.getNestedCheckedLength(e)){e.nestedCounter.textContent=`${t}/${e.nested.length}`}}var rn=s(175),ln=s(158),dn=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class cn{constructor(e){var t;this.container=document.createElement("div"),this.list=Jd.createChatList(),this.chatsContainer=document.createElement("div"),this.selected=new Set,this.freezed=!1,this.folderId=0,this.offsetIndex=0,this.query="",this.loadedWhat={},this.renderedPeerIds=new Set,this.peerType=["dialogs"],this.multiSelect=!0,this.rippleEnabled=!0,this.avatarSize=48,this.exceptSelf=!1,this.tempIds={},this.selfPresence="Presence.YourChat",this.needSwitchList=!1,this.design="round",this.participants=new Map,this.onInput=()=>{const e=this.input.value;if(this.query!==e){(this.peerType.includes("contacts")||this.peerType.includes("dialogs"))&&(this.cachedContacts=null),this.peerType.includes("dialogs")&&(this.folderId=0,this.offsetIndex=0);for(let e in this.tempIds)++this.tempIds[e];this.list=Jd.createChatList(),this.promise=null,this.loadedWhat={},this.query=e,this.renderedPeerIds.clear(),this.needSwitchList=!0,this.middlewareHelper.clean(),this.getMoreResults()}},this.checkForTriggers=()=>{this.scrollable.checkForTriggers()},Object(m.g)(this,e),this.meAsSaved=!1,this.container.classList.add("selector"),this.middlewareHelper=Ke();const s=(this.renderResultsFunc||this.renderResults).bind(this);if(this.renderResultsFunc=(e,t)=>dn(this,void 0,void 0,(function*(){const{needSwitchList:i}=this,n=this.middlewareHelper.get();if(i&&(this.needSwitchList=!1,this.scrollable.splitUp.replaceWith(this.list),this.scrollable.setVirtualContainer(this.list)),e=e.filter(e=>{const t=!this.renderedPeerIds.has(e);return t&&this.renderedPeerIds.add(e),t}),this.filterPeerTypeBy){const t="function"==typeof this.filterPeerTypeBy;if(e=yield Object(a.b)(e,e=>dn(this,void 0,void 0,(function*(){if(e.isPeerId()){if(t){const t=yield Te.getPeer(e);return this.filterPeerTypeBy(t)}for(const t of this.filterPeerTypeBy)if(Te[t](e))return!0;return!1}return!0}))),!n())return}yield s(e,t)})),this.input=document.createElement("input"),this.input.classList.add("selector-search-input"),this.placeholder?Object(O._i18n)(this.input,this.placeholder,void 0,"placeholder"):Object(O._i18n)(this.input,"SendMessageTo",void 0,"placeholder"),this.input.type="text",this.multiSelect){let e=document.createElement("div");e.classList.add("selector-search-container"),this.selectedContainer=document.createElement("div"),this.selectedContainer.classList.add("selector-search"),this.selectedContainer.append(this.input),e.append(this.selectedContainer),this.selectedScrollable=new re.b(e);let t=document.createElement("hr");this.selectedContainer.addEventListener("click",e=>{if(this.freezed)return;let t=e.target;if(t=Object(ti.a)(t,"selector-user"),!t)return;const s=t.dataset.key,i=this.chatsContainer.querySelector('[data-peer-id="'+s+'"]');i?i.click():this.remove(s.toPeerId())}),this.container.append(e,t)}this.chatsContainer.classList.add("chatlist-container"),"night"===H.default.getTheme().name&&this.chatsContainer.classList.add("eitaa-dialogs-toggle"),this.chatsContainer.append(this.list),this.scrollable=new re.b(this.chatsContainer),this.scrollable.setVirtualContainer(this.list),this.chatsContainer.addEventListener("click",e=>{const t=Object(ln.a)(e.target,"data-peer-id");if(Object(f.a)(e),!t)return;if(this.freezed)return;let s=t.dataset.peerId;if(s=s.isPeerId()?s.toPeerId():s,this.onSelect)return void this.onSelect(s);if(!this.multiSelect)return void this.add(s);this.selected.has(s)?this.remove(s):this.add(s);const i=t.querySelector("input");i.checked=!i.checked});const i=Zi(this.onInput,200,!1,!0);this.input.addEventListener("input",i),this.scrollable.onScrolledBottom=()=>{this.getMoreResults()},this.listenerSetter=new Gs,this.container.append(this.chatsContainer),this.appendTo.append(this.container),this.channelParticipantsUpdateFilter&&this.listenerSetter.add(H.default)("chat_participant",e=>{if(e.channel_id!==this.peerId.toChatId())return;const t=e.new_participant,s=e.prev_participant,i=e.user_id.toPeerId(!1),n=this.channelParticipantsUpdateFilter(t),a=!!s&&this.channelParticipantsUpdateFilter(s);n?(this.participants.set(i,t),this.renderResultsFunc([i],!0)):a&&(this.participants.delete(i),this.deletePeerId(i))}),null===(t=null==e?void 0:e.middleware)||void 0===t||t.onDestroy(()=>{this.destroy()}),setTimeout(()=>{let t=this.getMoreResults();e.onFirstRender&&t.then(()=>{e.onFirstRender()})},0)}destroy(){this.middlewareHelper.destroy()}deletePeerId(e){const t=this.list.querySelector(`[data-peer-id="${e}"]`);null==t||t.remove(),this.renderedPeerIds.delete(e)}renderSaved(){return dn(this,void 0,void 0,(function*(){this.exceptSelf||this.offsetIndex||0!==this.folderId||!this.peerType.includes("dialogs")||this.query&&!ye.testSelfSearch(this.query)||(yield this.renderResultsFunc([H.default.myId]))}))}getTempId(e){var t,s;null!==(t=(s=this.tempIds)[e])&&void 0!==t||(s[e]=0);const i=++this.tempIds[e];return{tempId:i,middleware:()=>this.tempIds[e]===i}}getMoreDialogs(){return dn(this,void 0,void 0,(function*(){if(this.promise)return this.promise;if(this.loadedWhat.dialogs&&this.loadedWhat.archived)return;const e=mt.windowH/72*1.25|0,{middleware:t}=this.getTempId("dialogs"),s=js.getConversations(this.query,this.offsetIndex,e,this.folderId,!0).promise;this.promise=s,s.catch(()=>{t()&&(this.loadedWhat[this.loadedWhat.dialogs?"archived":"dialogs"]=!0)});const i=yield s;if(!t())return;this.promise=null;let n=i.dialogs;if(n.length){const e=n[n.length-1].index||0;if(n=n.slice(),n.findAndSplice(e=>e.peerId===H.default.myId),this.chatRightsAction&&(n=yield Object(a.b)(n,e=>this.filterByRights(e.peerId)),!t()))return;if(yield this.renderSaved(),!t())return;this.offsetIndex=e}if(yield this.renderResultsFunc(n.map(e=>e.peerId)),i.isEnd){if(!this.loadedWhat.dialogs){if(yield this.renderSaved(),!t())return;return this.loadedWhat.dialogs=!0,this.offsetIndex=0,this.folderId=1,this.getMoreDialogs()}if(this.loadedWhat.archived=!0,!this.loadedWhat.contacts)return this.getMoreContacts()}}))}filterByRights(e){return e.isUser()&&("send_messages"!==this.chatRightsAction||ye.canSendToUser(e))||Pe.hasRights(e.toChatId(),this.chatRightsAction)}getMoreContacts(){return dn(this,void 0,void 0,(function*(){if(this.promise)return this.promise;if(this.loadedWhat.contacts)return;const e=this.peerType.includes("contacts");if(!this.cachedContacts){const{middleware:t}=this.getTempId("contacts"),s=Promise.all([e?ye.getContactsPeerIds(this.query):[],this.query?ye.searchContacts(this.query):void 0]);s.catch(()=>{t()&&(this.loadedWhat.contacts=!0)}),this.promise=s;let[i,n]=yield s;if(!t())return;if(n){let s=e?n.my_results.concat(n.results):n.my_results;if(this.chatRightsAction&&(s=yield Object(a.b)(s,e=>this.filterByRights(e)),!t()))return;this.peerType.includes("dialogs")||(s=s.filter(e=>e.isUser())),this.cachedContacts=Object(a.c)(i.concat(s))}else this.cachedContacts=i.slice();Object(a.f)(this.cachedContacts,H.default.myId),this.promise=null}const t=mt.windowH/72*1.25|0,s=this.cachedContacts.splice(0,t);yield this.renderResultsFunc(s),this.cachedContacts.length||(this.loadedWhat.contacts=!0)}))}getMoreChannelParticipants(){return dn(this,void 0,void 0,(function*(){if(this.promise)return this.promise;if(this.loadedWhat.channelParticipants)return;let e;e=this.channelParticipantsFilter?"function"==typeof this.channelParticipantsFilter?this.channelParticipantsFilter(this.query):this.channelParticipantsFilter:{_:"channelParticipantsRecent"};const{middleware:t}=this.getTempId("channelParticipants"),s=Ts.getChannelParticipants(this.peerId.toChatId(),e,50,this.list.childElementCount);s.catch(()=>{t()&&(this.loadedWhat.channelParticipants=!0)});const i=yield s;if(!t())return;const n=i.participants.map(e=>{const t=Pe.getParticipantPeerId(e);return this.participants.set(t,e),t});yield this.renderResultsFunc(n),(this.list.childElementCount>=i.count||i.participants.length<50)&&(this.loadedWhat.channelParticipants=!0)}))}getMoreResults(){const e=(()=>{const e=[];return!this.peerType.includes("dialogs")||this.loadedWhat.archived||(e.push(this.getMoreDialogs()),this.loadedWhat.archived)?(!this.peerType.includes("contacts")&&!this.peerType.includes("dialogs")||this.loadedWhat.contacts||e.push(this.getMoreContacts()),this.peerType.includes("channelParticipants")&&!this.loadedWhat.channelParticipants&&e.push(this.getMoreChannelParticipants()),e):e})(),t=Promise.all(e);return e.length&&t.then(this.checkForTriggers),t}renderResults(e,t){return dn(this,void 0,void 0,(function*(){!this.peerType.includes("dialogs")&&this.loadedWhat.contacts&&(e=yield Object(a.b)(e,e=>ye.isNonContactUser(e)));const s=e.map(e=>dn(this,void 0,void 0,(function*(){const s=Jd.addDialogNew({dialog:e,container:this.scrollable,rippleEnabled:this.rippleEnabled,avatarSize:this.avatarSize,meAsSaved:this.meAsSaved,append:t}),{dom:i}=s;if(this.multiSelect){const t=this.selected.has(e);i.containerEl.prepend(this.checkbox(t))}let n;this.getSubtitleForElement&&(n=yield this.getSubtitleForElement(e)),n||(n=yield this.wrapSubtitle(e)),i.lastMessageSpan.append(n)})));return Promise.all(s)}))}wrapSubtitle(e){return dn(this,void 0,void 0,(function*(){let t;return t=e.isAnyChat()?yield function(e,t){var s,i;return ka(this,void 0,void 0,(function*(){if(null!=t||(t=yield Pe.getChat(e)),"chatForbidden"===t._)return Object(O.i18n)("YouWereKicked");const n=Ts.getCachedFullChat(e);let a;a=n?"channelFull"===n._?n.participants_count:null===(s=n.participants.participants)||void 0===s?void 0:s.length:t.participants_count||(null===(i=t.participants)||void 0===i?void 0:i.participants.length);a=a||1;const o=t.pFlags.broadcast?"Peer.Status.Subscribers":"Peer.Status.Member";return Object(O.i18n)(o,[Object(ds.e)(a)])}))}(e.toChatId()):e===H.default.myId&&this.meAsSaved?Object(O.i18n)(this.selfPresence):ye.getUserStatusString(e.toPeerId()),t}))}checkbox(e){const t=new Gi.a({round:"round"===this.design});return e&&(t.input.checked=e),t.label}add(e,t,s=!0){if(this.selected.add(e),!this.multiSelect)return void this.onChange(this.selected.size);this.query.trim()&&(this.input.value="",this.onInput());const i=document.createElement("div");i.classList.add("selector-user","scale-in");const n=document.createElement("avatar-element");return n.classList.add("selector-user-avatar","tgico"),n.setAttribute("dialog","1"),n.classList.add("avatar-32"),i.dataset.key=""+e,e.isPeerId()&&(void 0===t&&(t=new Oe({peerId:e.toPeerId(),dialog:!0}).element),n.setAttribute("peer",""+e)),t&&("string"==typeof t?i.innerHTML=t:(Object(le.a)(i,t),i.append(t))),i.insertAdjacentElement("afterbegin",n),this.selectedContainer.insertBefore(i,this.input),this.onChange&&this.onChange(this.selected.size),s&&this.selectedScrollable.scrollIntoViewNew(this.input,"center"),i}remove(e){if(!this.multiSelect)return;const t=this.selectedContainer.querySelector(`[data-key="${e}"]`);t.classList.remove("scale-in"),t.offsetWidth,t.classList.add("scale-out");const s=()=>{this.selected.delete(e),t.remove(),this.onChange&&this.onChange(this.selected.size)};H.default.settings.animationsEnabled?t.addEventListener("animationend",s,{once:!0}):s()}getSelected(){return[...this.selected]}addInitial(e){e.forEach(e=>{this.add(e,void 0,!1)}),window.requestAnimationFrame(()=>{this.selectedScrollable.scrollIntoViewNew(this.input,"center",void 0,void 0,rn.a.Static)})}}var hn=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class un extends ni{constructor(e){super("popup-forward",null,{closable:!0,overlayClosable:!0,body:!0}),this.selector=new cn({appendTo:this.body,middleware:this.middlewareHelper.get(),onChange:()=>hn(this,void 0,void 0,(function*(){const t=this.selector.getSelected(),s=t[t.length-1].toPeerId();if(e.onSelect){const t=e.onSelect(s);if(t instanceof Promise)try{yield t}catch(e){return}}this.selector=null,this.hide()})),peerType:e.peerTypes,onFirstRender:()=>{this.show(),this.selector.checkForTriggers(),Ht.IS_TOUCH_SUPPORTED||this.selector.input.focus()},chatRightsAction:e.chatRightsAction,multiSelect:!1,rippleEnabled:!1,avatarSize:46,peerId:e.peerId,placeholder:e.placeholder,selfPresence:e.selfPresence,filterPeerTypeBy:null==e?void 0:e.filterPeerTypeBy,channelParticipantsFilter:null==e?void 0:e.channelParticipantsFilter}),this.title.append(this.selector.input)}}function pn(e,t,s){var i;const n="channelParticipantCreator"===(null==t?void 0:t._),a=null===(i=t)||void 0===i?void 0:i.promoted_by;return!!e.pFlags.creator||!n&&(!a||a===s)}var gn=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class mn extends Xs{init(){var e;return gn(this,void 0,void 0,(function*(){let t;this.container.classList.add("edit-peer-container","user-permissions-container"),this.setTitle(this.isAdmin?"EditAdmin":"UserRestrictions");const s=yield Pe.getChat(this.chatId),i=Pe.isChannel(this.chatId),n=(Te.isAnyGroup(this.chatId.toPeerId(!0)),"channelParticipantCreator"===(null===(e=this.participant)||void 0===e?void 0:e._)),a=pn(s,this.participant,H.default.myId);let o;o=this.isAdmin?["channelParticipantAdmin","channelParticipantCreator"]:["channelParticipantBanned"];{const e=new fr({name:this.isAdmin?"EditAdminWhatCanDo":"UserRestrictionsCanDo",caption:!!this.isAdmin||void 0}),i=document.createElement("div");i.classList.add("chatlist-container"),e.content.insertBefore(i,e.title);const n=Jd.createChatList({new:!0});i.append(n);const{dom:r}=Jd.addDialogNew({dialog:this.userId.toPeerId(!1),container:n,rippleEnabled:!0,avatarSize:48,meAsSaved:!1});r.lastMessageSpan.append(ye.getUserStatusString(this.userId));const l={chatId:this.chatId,listenerSetter:this.listenerSetter,appendTo:e.content,participant:o.includes(this.participant._)?this.participant:void 0,chat:s,canEdit:a},d=o.includes(this.participant._)?(this.isAdmin?this.participant.admin_rights:this.participant.banned_rights).pFlags:void 0;if(this.isAdmin){const s=new bn(l),i=s.fields[s.fields.length-1],n=()=>{e.caption.replaceChildren(Object(O.i18n)(a?i.checkboxField.checked?"Channel.Admin.AdminAccess":"Channel.Admin.AdminRestricted":"EditAdminCantEdit"))};n(),this.listenerSetter.add(i.checkboxField.input)("change",n),t=()=>{if(!pn)return;const e=s.takeOut();d&&Object(m.b)(d,e.pFlags)||Pe.editAdmin(this.chatId,this.participant,e)}}else{const e=new vn(l);t=()=>{const t=e.takeOut();d&&Object(m.b)(d,t.pFlags)||Pe.editBanned(this.chatId,this.participant,t)}}this.eventListener.addEventListener("destroy",t,{once:!0}),this.scrollable.append(e.container)}if(this.isAdmin){const e=new fr({});if(!n&&pn){const s=Object(Ks.a)("btn-primary btn-transparent danger",{icon:"deleteuser",text:"Channel.Admin.Dismiss"});Object(v.b)(s,()=>gn(this,void 0,void 0,(function*(){const e=Object(tn.a)([s],!0);try{yield Pe.editAdmin(this.chatId,this.participant,{_:"chatAdminRights",pFlags:{}},"")}catch(t){return void e()}this.eventListener.removeEventListener("destroy",t),this.close()})),{listenerSetter:this.listenerSetter}),e.content.append(s)}e.content.childElementCount&&this.scrollable.append(e.container)}else{const e=new fr({});if("channelParticipantBanned"===this.participant._){const s=Object(Ks.a)("btn-primary btn-transparent danger",{icon:"delete",text:"GroupPermission.Delete"});Object(v.b)(s,()=>{const e=Object(tn.a)([s],!0);Pe.clearChannelParticipantBannedRights(this.chatId,this.participant).then(()=>{this.eventListener.removeEventListener("destroy",t),this.close()},()=>{e()})},{listenerSetter:this.listenerSetter}),e.content.append(s)}const s=Object(Ks.a)("btn-primary btn-transparent danger",{icon:"deleteuser",text:"UserRestrictionsBlock"});Object(v.b)(s,()=>gn(this,void 0,void 0,(function*(){const e=Object(tn.a)([s],!0);try{const e=this.userId.toPeerId();yield(n={peerId:this.chatId.toPeerId(!0),descriptionLangKey:"Permissions.RemoveFromGroup",descriptionLangArgs:[new Oe({peerId:e}).element],titleLangKey:"ChannelBlockUser",button:{langKey:"Remove",isDanger:!0}},new Promise((e,t)=>{var s;const{button:i,checkbox:a}=n;i.callback=t=>{e(a||!t?t?!!t.size:void 0:n.checkboxes.map(e=>t.has(e.text)))};const o=ai(n.buttons||[i]);o.find(e=>e.isCancel).callback=()=>{t()},n.buttons=o,null!==(s=n.checkboxes)&&void 0!==s||(n.checkboxes=a&&[a]),ni.createPopup(en,"popup-confirmation",n).show()})),i?yield Pe.kickFromChannel(this.chatId,this.participant):yield Pe.kickFromChat(this.chatId,this.participant)}catch(t){return void e()}var n;this.eventListener.removeEventListener("destroy",t),this.close()})),{listenerSetter:this.listenerSetter}),e.content.append(s),this.scrollable.append(e.container)}}))}}mn.openTab=(e,t,s,i)=>{const n=new mn(e);n.participant=s,n.chatId=t,n.userId=Pe.getParticipantPeerId(s).toUserId(),n.isAdmin=i,n.open()};var fn=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class vn extends on{constructor(e){super({listenerSetter:e.listenerSetter,fields:[],asRestrictions:!0}),this.options=e,this.construct()}construct(){return fn(this,void 0,void 0,(function*(){const e=this.options,t=this.chat=yield Pe.getChat(e.chatId),s=this.defaultBannedRights=t.default_banned_rights,i=this.rights=e.participant?Pe.combineParticipantBannedRights(t.id,e.participant.banned_rights):s,n=Pe.hasRights(e.chatId,"change_info"),a=[{flags:["send_messages"],text:"UserRestrictionsSend",exceptionText:"UserRestrictionsNoSend"},{flags:["send_forwarded_messages"],text:"UserRestrictionsSendForwarded",exceptionText:"UserRestrictionsNoSendForwarded"},{flags:["send_media"],text:"UserRestrictionsSendMedia",exceptionText:"UserRestrictionsNoSendMedia"},{flags:["send_stickers","send_gifs"],text:"UserRestrictionsSendStickers",exceptionText:"UserRestrictionsNoSendStickers"},{flags:["embed_links"],text:"UserRestrictionsEmbedLinks",exceptionText:"UserRestrictionsNoEmbedLinks"},{flags:["view_participants"],text:"UserRestrictionsViewParticipants",exceptionText:"UserRestrictionsNoViewParticipants"},{flags:["invite_users"],text:"UserRestrictionsInviteUsers",exceptionText:"UserRestrictionsNoInviteUsers"}],o={};a.forEach(e=>{const s=e.flags[0];o[s]=e,e.checked=Pe.hasRights(t.id,s,i)}),o.send_messages.toggleWith={unchecked:[o.send_forwarded_messages,o.send_media,o.send_stickers,o.send_gifs,o.embed_links]},o.send_forwarded_messages.toggleWith={checked:[o.send_messages]},o.send_media.toggleWith={checked:[o.send_messages,o.send_gifs,o.send_stickers],unchecked:[o.send_stickers,o.send_gifs]},o.send_stickers.toggleWith={checked:[o.send_messages]},o.embed_links.toggleWith={checked:[o.send_messages]},o.send_stickers.toggleWith={checked:[o.send_media]},this.fields=a;for(const i of this.fields)!e.forChat&&s.pFlags[i.flags[0]]?i.restrictionText="UserRestrictionsDisabled":Te.getPeerUsername(t.id.toPeerId(!0))&&(i.flags.includes("pin_messages")||i.flags.includes("change_info"))&&(i.restrictionText=e.participant?"UserRestrictionsDisabled":"EditCantEditPermissionsPublic");for(const t of this.fields){if(t.nestedTo)continue;const{nodes:s}=this.createField({info:t,isDisabled:!n});e.appendTo.append(...s)}}))}takeOut(){const e={_:"chatBannedRights",until_date:2147483647,pFlags:{}};for(const t of this.fields){!t.checkboxField.checked&&t.flags.forEach(t=>{e.pFlags[t]=!0})}return e}}class bn extends on{constructor(e){super({listenerSetter:e.listenerSetter,fields:[],asRestrictions:!0}),this.options=e,this.construct()}construct(){var e;const t=this.options,s=t.chat,i=!!s.pFlags.broadcast,n=this.rights=t.participant?t.participant.admin_rights:void 0;let a=[{flags:["change_info"],text:i?"EditAdminChangeChannelInfo":"EditAdminChangeGroupInfo"},i&&{flags:["post_messages"],text:"EditAdminPostMessages"},i&&{flags:["edit_messages"],text:"EditAdminEditMessages"},{flags:["delete_messages"],text:i?"EditAdminDeleteMessages":"EditAdminGroupDeleteMessages"},!i&&{flags:["ban_users"],text:"EditAdminBanUsers"},!i&&{flags:["invite_users"],text:"EditAdminAddUsersViaLink"},i&&{flags:["invite_users"],text:"Channel.EditAdmin.PermissionInviteSubscribers"},{flags:["post_live"],text:"EditAdminPostLive"},{flags:["pin_messages"],text:"EditAdminPinMessages"},{flags:["add_admins"],text:"EditAdminAddAdmins",checked:!!n&&void 0}];a=a.filter(Boolean),a.forEach(e=>{var t;const i=e.flags[0];null!==(t=e.checked)&&void 0!==t||(e.checked=Pe.hasRights(s.id,i,n))}),this.fields=a;const o=new Set(["anonymous"]),r="channelParticipantCreator"===(null===(e=t.participant)||void 0===e?void 0:e._);for(const e of this.fields){const i=e.flags[0];t.canEdit?(r&&!o.has(i)||!Pe.hasRights(s.id,i))&&(e.restrictionText="EditCantEditPermissions"):e.restrictionText="EditAdminCantEdit";const{nodes:n}=this.createField({info:e});t.appendTo.append(...n)}}takeOut(){const e={_:"chatAdminRights",pFlags:{}};for(const t of this.fields)t.checkboxField.checked&&t.flags.forEach(t=>{e.pFlags[t]=!0});return e}}class yn extends Xs{init(){return fn(this,void 0,void 0,(function*(){let e;this.container.classList.add("edit-peer-container","group-permissions-container"),this.setTitle("ChannelPermissions"),this.participants=new Map;{const t=new fr({name:"ChannelPermissionsHeader"});e=new vn({chatId:this.chatId,listenerSetter:this.listenerSetter,appendTo:t.content,forChat:!0}),this.eventListener.addEventListener("destroy",()=>{Pe.editChatDefaultBannedRights(this.chatId,e.takeOut())},{once:!0}),this.scrollable.append(t.container)}{const t=new fr({name:"PrivacyExceptions"}),s=new Qi({titleLangKey:"ChannelAddException",subtitleLangKey:"Loading",icon:"adduser",clickable:()=>{ni.createPopup(un,{peerTypes:["channelParticipants"],onSelect:e=>{setTimeout(()=>{i(e)},0)},placeholder:"ExceptionModal.Search.Placeholder",peerId:-this.chatId})},listenerSetter:this.listenerSetter}),i=e=>fn(this,void 0,void 0,(function*(){let t=this.participants.get(e);if(!t)try{t=yield Ts.getParticipant(this.chatId,e)}catch(e){return void Qt("User is no longer participant")}const s=new mn(this.slider);s.participant=t,s.chatId=this.chatId,s.userId=e,s.open()}));t.content.append(s.container);const n=t.generateContentElement();n.classList.add("chatlist-container");const a=Jd.createChatList({new:!0});n.append(a),Object(v.b)(a,e=>{const t=Object(nn.a)(e.target,"A");if(!t)return;const s=t.dataset.peerId.toPeerId();i(s)},{listenerSetter:this.listenerSetter});const o=(t,s)=>fn(this,void 0,void 0,(function*(){const i=s.banned_rights,n=(yield Pe.getChat(this.chatId)).default_banned_rights,a=[];e.fields.forEach(e=>{const t=e.flags[0];i.pFlags[t]&&!n.pFlags[t]&&a.push(e.exceptionText)});const o=t.lastMessageSpan;a.length?(o.replaceChildren(...Object(O.join)(a.map(e=>Object(O.i18n)(e)),!1)),o.classList.toggle("hide",!a.length)):(o.replaceChildren(Object(O.i18n)("UserRestrictionsBy",[new Oe({peerId:s.kicked_by.toPeerId(!1)}).element])),o.classList.remove("hide"))})),r=(e,t)=>{const s=Te.getPeerId(e.peer),{dom:i}=Jd.addDialogNew({dialog:s,container:a,rippleEnabled:!0,avatarSize:54,append:t});this.participants.set(s,e),i.listEl.dialogDom=i,o(i,e)};this.listenerSetter.add(H.default)("chat_participant",e=>{const t=e.new_participant,s=e.prev_participant,i=e.user_id.toPeerId(!1),n="channelParticipantBanned"===(null==t?void 0:t._)&&!t.banned_rights.pFlags.view_messages;t?this.participants.set(i,t):this.participants.delete(i);const d=a.querySelector(`[data-peer-id="${i}"]`);n?(d?o(d.dialogDom,t):r(t,!1),"channelParticipantBanned"!==(null==s?void 0:s._)&&++c):(null==d||d.remove(),"channelParticipantBanned"===(null==s?void 0:s._)&&--c),l()});const l=()=>{const e=Object(O.i18n)(c?"Permissions.ExceptionsCount":"Permissions.NoExceptions",[c]);Object(le.a)(s.subtitle,e)};let d,c=0;const h=()=>(d=new an({scrollable:this.scrollable,getPromise:()=>Ts.getChannelParticipants(this.chatId,{_:"channelParticipantsBanned",q:""},50,a.childElementCount).then(e=>{for(const t of e.participants)r(t,!0);return c=e.count,l(),e.participants.length<50||e.count===a.childElementCount})}),d.load());this.scrollable.append(t.container),Pe.isChannel(this.chatId)?yield h():(l(),this.listenerSetter.add(H.default)("dialog_migrate",({migrateFrom:e,migrateTo:t})=>{this.chatId===e&&(this.chatId=t,h())}))}}))}onOpenAfterTimeout(){this.scrollable.onScroll()}}class wn{constructor(e,t=Te.getDialogType(e),s){const i=new Oe({peerId:e}).element,n=(t,i=c&&!!t.size)=>{let n=Pe.leave(e.toChatId());i&&(n=n.finally(()=>js.flushHistory(e))),s&&s(n)},a=t=>{let i;if(e.isUser())i=js.flushHistory(e,!1,c?!!t.size:void 0);else{if(!t.size)return n(t);i=Pe.delete(e.toChatId())}s&&s(i)};let o,r,l,d,c;switch(t){case"channel":Pe.hasRights(e.toChatId(),"delete_chat")?(Pe.deleteChannel,o="ChannelDeleteMenu",r="AreYouSureDeleteAndExitChannel",d=[{langKey:"ChannelDeleteMenu",isDanger:!0,callback:a}],c=[{text:"DeleteChannelForAll",checked:!0}]):(o="LeaveChannelMenu",r="ChannelLeaveAlertWithName",l=[i],d=[{langKey:"LeaveChannel",isDanger:!0,callback:n}]);break;case"chat":o="DeleteChatUser",r="AreYouSureDeleteThisChatWithUser",l=[i],d=[{langKey:"DeleteChatUser",isDanger:!0,callback:a}];break;case"saved":o="DeleteChatUser",r="AreYouSureDeleteThisChatSavedMessages",d=[{langKey:"DeleteChatUser",isDanger:!0,callback:a}];break;case"megagroup":case"group":Pe.hasRights(e.toChatId(),"delete_chat")?(o="DeleteMegaMenu",r="AreYouSureDeleteAndExit",d=[{langKey:"DeleteMegaMenu",isDanger:!0,callback:a}],c=[{text:"DeleteChat.DeleteGroupForAll",checked:!0}]):(o="LeaveMegaMenu",r="AreYouSureDeleteAndExitName",l=[i],d=[{langKey:"DeleteChatUser",isDanger:!0,callback:e=>n(e,!0)}])}new en("popup-delete-chat",{peerId:e,titleLangKey:o,descriptionLangKey:r,descriptionLangArgs:l,buttons:d,checkboxes:c}).show()}}var Sn=new class extends Wt{constructor(){super("menu",!0),this.onMouseMove=e=>{const t=this.element.getBoundingClientRect(),{clientX:s,clientY:i}=e,n=s>=t.right?s-t.right:t.left-s,a=i>=t.bottom?i-t.bottom:t.top-i;(n>=100||a>=100)&&this.close()},I.b.addEventListener("resize",()=>{this.element&&this.close()})}isOpened(){return!!this.element}close(){this.element&&(this.element.classList.remove("active"),this.element.parentElement.classList.remove("menu-open")),super.close(),Ht.IS_TOUCH_SUPPORTED||window.removeEventListener("mousemove",this.onMouseMove)}openBtnMenu(e,t){super.open(e),this.element.classList.add("active","was-open"),this.element.parentElement.classList.add("menu-open"),t&&this.addEventListener("toggle",t,{once:!0}),Ht.IS_TOUCH_SUPPORTED||window.addEventListener("mousemove",this.onMouseMove)}},In=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};var Mn=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};function Cn(e){const{listenTo:t,appendTo:s,onOpen:i,onClose:n,slider:o,chatId:r,participants:l,middleware:d}=e;let c,h,u,p,g,m,f,b,y;const w=Pe.isBroadcast(r),S=e=>{mn.openTab(o,r,h,e)};return function({buttons:e,findElement:t,listenTo:s,appendTo:i,filterButtons:n,onOpen:o,onClose:r,onBeforeOpen:l,listenerSetter:d,middleware:c,listenForClick:h}){null!=i||(i=document.body),null!=d||(d=new Gs);const u=new Gs,p=c?c.create():Ke();let g;const m=e=>{const i=t?t(e):s;if(!i)return;let n=g;if((e instanceof MouseEvent||e.hasOwnProperty("preventDefault"))&&e.preventDefault(),n&&n.classList.contains("active"))return!1;(e instanceof MouseEvent||e.hasOwnProperty("cancelBubble"))&&(e.cancelBubble=!0);(()=>{In(this,void 0,void 0,(function*(){yield null==o?void 0:o(i);const t=yield y();if(!t)return;i.classList.add("menu-open"),n=t.element;const{cleanup:s,destroy:a}=t;Object(hi.e)(e,n),Sn.openBtnMenu(n,()=>{i.classList.remove("menu-open"),null==r||r(),s(),setTimeout(()=>{a()},300)})}))})()};Object(hi.a)(s,m,d);const f=()=>{u.removeAll(),p.clean()},b=()=>{f(),d.removeAll()},y=()=>In(this,void 0,void 0,(function*(){f(),e.forEach(e=>e.element=void 0);const t=n||(e=>Object(a.b)(e,e=>!(null==e?void 0:e.verify)||Es(e.verify(),e=>null!=e&&e))),s=yield t(e);if(!s.length)return;const o=g=yield Mi(s,u);return o.classList.add("contextmenu"),yield null==l?void 0:l(),i.append(o),{element:o,cleanup:f,destroy:()=>{o.remove()}}}));return c&&c.onDestroy(()=>{b()}),h&&Object(v.b)(s,m,{listenerSetter:d}),{element:g,destroy:b,open:m}}({listenTo:t,appendTo:s,middleware:d,findElement:e=>c=Object(ti.a)(e.target,"chatlist-chat"),onOpen:()=>Mn(this,void 0,void 0,(function*(){return u=c.dataset.peerId.toPeerId(),h=l.get(u),[p,m,f,b]=yield Promise.all([Pe.getChat(r),Pe.hasRights(r,"change_permissions"),Pe.hasRights(r,"add_admins"),Pe.hasRights(r,"invite_users")]),c.classList.add("menu-open"),g=(w||m)&&"channelParticipantBanned"===h._&&h.banned_rights.pFlags.view_messages,y="channelParticipant"===h._||"channelParticipantBanned"===h._,null==i?void 0:i()})),onClose:()=>(c.classList.remove("menu-open"),null==n?void 0:n()),buttons:[{icon:"message",text:"SendMessage",onClick:()=>{Pd.setInnerPeer(u)}},{icon:"adduser",text:w?"AddToChannel":"AddToGroup",onClick:()=>{g&&Pe.addToChat(r,u).then(()=>{$t({langPackKey:"InviteToChannelSuccessfully",timeToDisappear:4e3}),o.closeTab()}).catch(e=>{"USER_PRIVACY_RESTRICTED"===e.type?$t(w?{langPackKey:"InviteToChannelError",timeToDisappear:3e3}:{langPackKey:"InviteToGroupError",timeToDisappear:3e3}):"CHANNEL_PRIVATE"===e.type?$t({langPackKey:"InviteToChannelFailed",timeToDisappear:3e3}):"USER_NOT_MUTUAL_CONTACT"===e.type&&$t(w?{langPackKey:"InviteToChannel.Error.MutualContact",timeToDisappear:4e3}:{langPackKey:"InviteToGroup.Error.MutualContact",timeToDisappear:4e3})})},verify:()=>!!g},{icon:"promote",text:"SetAsAdmin",onClick:()=>S(!0),verify:()=>f&&"channelParticipant"===h._},{icon:"admin",text:"EditAdminRights",onClick:()=>S(!0),verify:()=>"channelParticipantAdmin"===h._&&pn(p,h,H.default.myId)},{icon:"restrict",text:"KickFromSupergroup",onClick:()=>S(!1),verify:()=>!w&&m&&y&&!g},{icon:"delete",text:"Delete",onClick:()=>{g&&Pe.editBanned(r,h,{_:"chatBannedRights",pFlags:{},until_date:0})},verify:()=>!(!g||!w&&!m||u===H.default.myId)},{icon:"delete",text:w?"KickFromChannel":"KickFromGroup",onClick:()=>{Pe.kickFromChat(r,u).then(()=>{o.closeTab(),$t({langPackKey:"SuccessfullRemoveUser",timeToDisappear:5e3})})},verify:()=>b&&u!==H.default.myId&&"channelParticipantCreator"!==h._&&("channelParticipantAdmin"!==h._||pn(p,h,H.default.myId))&&("channelParticipant"===h._||!g)}]})}class Pn extends Ys{init(){this.nextBtn=li({icon:"arrow_next"}),this.content.append(this.nextBtn),this.scrollable.container.remove(),this.nextBtn.addEventListener("click",()=>{const e=this.selector.getSelected().map(e=>e.toPeerId());if(this.skippable)this.takeOut(e),this.close();else{const t=this.takeOut(e);t instanceof Promise?this.attachToPromise(t):void 0===t&&this.close()}})}attachToPromise(e){const t=Object(hi.g)(this.nextBtn,"arrow_next");e.then(()=>{this.close()},()=>{t()})}open(e){const t=super.open();this.setTitle(e.title),this.peerType=e.type,this.takeOut=e.takeOut,this.skippable=e.skippable;const s="privacy"===this.peerType;return this.selector=new cn({appendTo:this.content,middleware:this.middlewareHelper.get(),onChange:this.skippable?null:e=>{this.nextBtn.classList.toggle("is-visible",!!e)},peerType:["contacts"],placeholder:e.placeholder,exceptSelf:s,filterPeerTypeBy:s?["isUser"]:void 0}),e.selectedPeerIds&&this.selector.addInitial(e.selectedPeerIds),this.nextBtn.classList.add("tgico-arrow_next"),this.nextBtn.innerHTML="",this.nextBtn.disabled=!1,this.nextBtn.classList.toggle("is-visible",this.skippable),t}}var Ln=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};var En=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};function _n(e){return function(e){const t=Object(w.a)();return{selector:new cn(Object.assign(Object.assign({},e),{multiSelect:!1,meAsSaved:!0,onFirstRender:()=>{t.resolve()}})),loadPromise:t}}(Object.assign(Object.assign({},e),{peerType:["channelParticipants"]}))}class kn extends Xs{init(e){return En(this,void 0,void 0,(function*(){const t=yield Pe.getChat(e),s=Pe.isBroadcast(e);this.container.classList.add("edit-peer-container","chat-members-container"),this.setTitle(s?"PeerInfo.Subscribers":"GroupMembers"),this.addBtn=li({icon:"addmember_filled",className:"is-visible"}),this.content.append(this.addBtn),Object(v.b)(this.addBtn,()=>{!function({peerId:e,slider:t}){Ln(this,void 0,void 0,(function*(){const s=e.toChatId(),i=Pe.isChannel(s),n=Pe.isBroadcast(s),a=(t,s)=>{let a,o,r,l,d;if(t.length>1){a="AddMembersAlertTitle",o=[Object(O.i18n)(n?"Subscribers":"Members",[t.length])],r="AddMembersAlertNamesText";const e=document.createElement("b");e.append(new Oe({peerId:t[0]}).element);const s=t.length;l=[e,String(s-1)],i||(d=[{text:"AddMembersForwardMessages",checked:!0}])}else{a="AddOneMemberAlertTitle",r="AddMembersAlertCountText";const e=document.createElement("b");e.append(new Oe({peerId:t[0]}).element),l=[e],i||(d=[{text:"AddOneMemberForwardMessages",textArgs:[new Oe({peerId:t[0]}).element],checked:!0}])}l.push(new Oe({peerId:e}).element),ni.createPopup(en,"popup-add-members",{peerId:e,titleLangKey:a,descriptionLangKey:r,descriptionLangArgs:l,buttons:[{langKey:"Add",callback:s}],checkboxes:d}).show()},o=e=>{"USER_PRIVACY_RESTRICTED"===e.type?$t(n?{langPackKey:"InviteToChannelError",timeToDisappear:3e3}:{langPackKey:"InviteToGroupError",timeToDisappear:3e3}):"CHANNEL_PRIVATE"===e.type?$t({langPackKey:"InviteToChannelFailed",timeToDisappear:3e3}):"USER_NOT_MUTUAL_CONTACT"===e.type&&$t(n?{langPackKey:"InviteToChannel.Error.MutualContact",timeToDisappear:4e3}:{langPackKey:"InviteToGroup.Error.MutualContact",timeToDisappear:4e3})};if(i){const e=new Pn(t);e.open({type:"channel",skippable:!1,takeOut:t=>(a(t,()=>{const i=Pe.inviteToChannel(s,t);i.catch(o),e.attachToPromise(i),n&&i.then(()=>{$t({langPackKey:"InviteToChannelSuccessfully",timeToDisappear:3500})})}),!1),title:n?"ChannelAddSubscribers":"GroupAddMembers",placeholder:"SendMessageTo"})}else ni.createPopup(un,{peerTypes:["contacts"],placeholder:"Search",onSelect:e=>{setTimeout(()=>{a([e],t=>{Pe.addChatUser(s,e,t.size?void 0:0).catch(o)})},0)}})}))}({peerId:e.toPeerId(!0),slider:this.slider})},{listenerSetter:this.listenerSetter}),Pe.hasRights(e,"invite_users")||this.addBtn.classList.add("hide");t.participants_count;const{selector:i,loadPromise:n}=_n({appendTo:this.content,middleware:this.middlewareHelper.get(),peerId:e.toPeerId(!0),channelParticipantsUpdateFilter:e=>!!e,meAsSaved:!1});return this.selector=i,Cn({chatId:e,listenTo:this.selector.scrollable.container,participants:this.selector.participants,slider:this.slider,middleware:this.middlewareHelper.get()}),n}))}}var Tn=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class xn extends Xs{init(e){return Tn(this,void 0,void 0,(function*(){const t=yield Pe.isBroadcast(e);this.container.classList.add("edit-peer-container","removed-users-container"),this.setTitle("ChannelBlacklist");const s=!!Pe.hasRights(e,"invite_users");this.addBtn=li({icon:"addmember_filled",className:"is-visible"}),this.content.append(this.addBtn),Object(v.b)(this.addBtn,()=>{const t=ni.createPopup(un,{peerTypes:["channelParticipants"],peerId:e.toPeerId(!0),onSelect:s=>{const i=t.selector.participants.get(s);Pe.kickFromChat(e,i).then(()=>{this.slider.closeTab(),$t({langPackKey:"SuccessfullRemoveUser",timeToDisappear:5e3})})},placeholder:"SearchPlaceholder",filterPeerTypeBy:e=>{if(e.id===H.default.myId)return!1;return"channelParticipantCreator"!==t.selector.participants.get(e.id)._}})},{listenerSetter:this.listenerSetter}),s||this.addBtn.classList.add("hide");const{selector:i,loadPromise:n}=_n({appendTo:this.content,middleware:this.middlewareHelper.get(),peerId:e.toPeerId(!0),channelParticipantsFilter:e=>({_:"channelParticipantsKicked",q:e}),channelParticipantsUpdateFilter:e=>"channelParticipantBanned"===(null==e?void 0:e._)&&e.pFlags.left,getSubtitleForElement:e=>Tn(this,void 0,void 0,(function*(){const t=this.selector.participants.get(e).kicked_by.toPeerId(!1);return Object(O.i18n)("UserRemovedBy",[new Oe({peerId:t}).element])}))});this.selector=i;const a=new fr({noDelimiter:!0,caption:t?"NoBlockedChannel2":"NoBlockedGroup2"});return a.container.firstElementChild.remove(),this.selector.scrollable.container.append(a.container,this.selector.scrollable.container.lastElementChild),Cn({listenTo:this.selector.scrollable.container,slider:this.slider,chatId:e,participants:this.selector.participants,middleware:this.middlewareHelper.get()}),n}))}}var An=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class On extends Xs{init(){const e=this.chatId.toPeerId(!0);this.container.classList.add("edit-peer-container","chat-administrators-container"),this.setTitle("PeerInfo.Administrators");Pe.getChat(this.chatId),Pe.isBroadcast(this.chatId);const t=Pe.hasRights(this.chatId,"add_admins");this.addBtn=li({icon:"addmember_filled",className:"is-visible"}),this.content.append(this.addBtn),Object(v.b)(this.addBtn,()=>{const t=ni.createPopup(un,{peerTypes:["channelParticipants"],peerId:e,placeholder:"SearchPlaceholder",channelParticipantsFilter:e=>e&&e.trim().length?{_:"channelParticipantsSearch",q:e}:{_:"channelParticipantsRecent"},onSelect:e=>An(this,void 0,void 0,(function*(){o();let i=t.selector.participants.get(e);if(!i)try{i=yield Ts.getParticipant(this.chatId,e)}catch(t){i={_:"channelParticipant",user_id:e.toUserId(),date:Math.floor(Date.now()/1e3)}}s(i)})),filterPeerTypeBy:e=>{const s=t.selector.participants.get(e.id);return!s||"channelParticipantAdmin"!==s._&&"channelParticipantCreator"!==s._}}),i=new Set;let n=0;const o=()=>{i.forEach(e=>{t.selector.participants.has(e)||t.selector.deletePeerId(e)}),i.clear()},r=e=>An(this,void 0,void 0,(function*(){try{const t=Te.getPeerId(e);if(!t.isUser())return null;const[s,i]=e.substring(1).split("_"),n=Number(s);if(!Number.isFinite(n))return null;if(!ye.hasUser(n,!0)){if(!i)return null;const e=(yield St.a.invokeApi("users.getFullUser",{id:{_:"inputUser",user_id:n,access_hash:Number(i)}})).user;ye.saveApiUser(e,!0)}return t}catch(e){return console.error("Failed to resolve peer by ID",e),null}})),l=Zi(()=>An(this,void 0,void 0,(function*(){const e=t.selector.input.value.trim(),s=++n;if(o(),!e)return;const l=[],d=(e=>{const t=e.trim();if(!t)return null;const s=t.toLowerCase();return/^[0-9]+(?:_[0-9]+)?$/.test(s)?"u"+s:/^[uc][0-9]+(?:_[0-9]+)?$/.test(s)?s:null})(e);if(d)try{const e=yield r(d);if(n!==s)return;e&&l.push(e)}catch(e){console.error("Failed to resolve input string",e)}if(e.startsWith("@")){const t=e.slice(1).trim();if(t)try{const e=yield ye.resolveUsername(t);if(n!==s)return;const i=Te.getPeerId(e);i.isUser()&&l.push(i)}catch(e){console.error("Failed to resolve username",e)}}try{const t=yield ye.searchContacts(e,20);if(n===s){Object(a.c)(t.my_results.concat(t.results)).forEach(e=>{e.isUser()&&l.push(e)})}}catch(e){console.error("contacts.search failed",e)}if(n!==s)return;const c=Object(a.c)(l);for(const e of c)if(e&&e.isPeerId()&&e.isUser()&&!t.selector.participants.has(e)&&(!t.selector.list.querySelector(`[data-peer-id="${e}"]`)||i.has(e)))try{yield t.selector.renderResultsFunc([e],!0),i.add(e)}catch(e){console.error("Failed to render manual peer entry",e)}})),250);t.selector.input.addEventListener("input",l)},{listenerSetter:this.listenerSetter}),t||this.addBtn.classList.add("hide");const s=e=>An(this,void 0,void 0,(function*(){mn.openTab(this.slider,this.chatId,e,!0)})),{selector:i,loadPromise:n}=function(e){const t=Object(w.a)();return{selector:new cn(Object.assign(Object.assign({},e),{peerType:["channelParticipants"],multiSelect:!1,placeholder:"SearchPlaceholder",meAsSaved:!1,onFirstRender:()=>{t.resolve()}})),loadPromise:t}}({appendTo:this.content,middleware:this.middlewareHelper.get(),peerId:e,meAsSaved:!1,channelParticipantsFilter:e=>({_:"channelParticipantsAdmins",q:e}),getSubtitleForElement:e=>An(this,void 0,void 0,(function*(){const t=this.selector.participants.get(e);if("channelParticipantCreator"===t._||"chatParticipantCreator"===t._)return Object(O.i18n)("ChannelCreator");const s=t.promoted_by.toPeerId(!1);return Object(O.i18n)("EditAdminPromotedBy",[new Oe({peerId:s}).element])})),onSelect:e=>{const t=this.selector.participants.get(e);s(t)},channelParticipantsUpdateFilter:e=>["channelParticipantAdmin","channelParticipantCreator"].includes(null==e?void 0:e._)});return this.selector=i,Cn({chatId:this.chatId,listenTo:this.selector.scrollable.container,participants:this.selector.participants,slider:this.slider,middleware:this.middlewareHelper.get()}),n}}var Fn=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class Dn extends Ys{_init(){return Fn(this,void 0,void 0,(function*(){this.listenerSetter.removeAll(),this.scrollable.container.innerHTML="",this.container.classList.add("edit-peer-container","edit-group-container"),this.setTitle("Edit");const e=yield Ts.getChatFull(this.chatId,!0);let t=Pe.getChat(this.chatId);const s=Pe.isBroadcast(this.chatId),i=Pe.isChannel(this.chatId),n=(Pe.hasRights(this.chatId,"change_permissions"),!!Pe.hasRights(this.chatId,"change_info")),a={full:[],basic:[]},o=(e,t="basic")=>{a[t].push(e)};this.listenerSetter.add(H.default)("chat_update",e=>{this.chatId===e&&(t=Pe.getChat(this.chatId),a.basic.forEach(e=>e()))}),this.listenerSetter.add(H.default)("invalidate_participants",e=>{this.chatId===e&&a.full.forEach(e=>e())}),this.listenerSetter.add(H.default)("chat_full_update",e=>{this.chatId===e&&a.full.forEach(e=>e())});const r=this.chatId.toPeerId(!0);{const i=new fr({noDelimiter:!0}),a=[],l=document.createElement("div");if(l.classList.add("input-wrapper"),this.chatNameInputField=new Ws.b({label:s?"EnterChannelName":"CreateGroup.NameHolder",name:"chat-name",maxLength:255,required:!0,canBeEdited:n}),this.descriptionInputField=new Ws.b({label:"DescriptionPlaceholder",name:"chat-description",maxLength:255,canBeEdited:n}),this.chatNameInputField.setOriginalValue(t.title),this.descriptionInputField.setOriginalValue(e.about),Pe.isChannel(this.chatId)||Pe.isMegagroup(this.chatId)?(l.append(this.chatNameInputField.container,this.descriptionInputField.container),a.push(this.chatNameInputField,this.descriptionInputField)):(l.append(this.chatNameInputField.container),a.push(this.chatNameInputField)),this.editPeer=new Vi({peerId:r,inputFields:a,listenerSetter:this.listenerSetter}),!n){this.editPeer.avatarEdit.container.children[1].style.display="none",this.editPeer.avatarElem.style.filter="unset",this.editPeer.avatarEdit.container.style.pointerEvents="none"}if(this.content.append(this.editPeer.nextBtn),i.content.append(this.editPeer.avatarEdit.container,l),Pe.hasRights(this.chatId,"change_type")&&(Pe.isChannel(this.chatId)||Pe.isMegagroup(this.chatId))){const n=new Qi({titleLangKey:s?"ChannelType":"GroupType",clickable:()=>{const t=new sn(this.slider);t.chatId=this.chatId,t.chatFull=e,t.open(),this.listenerSetter.add(t.eventListener)("destroy",a)},icon:"lock"}),a=()=>{let e;n.subtitle.textContent="",e=s?t.username?"TypePublic":"TypePrivate":t.username?"TypePublicGroup":"TypePrivateGroup",n.subtitle.append(Object(O.i18n)(e))};a(),i.content.append(n.container)}if(Pe.hasRights(this.chatId,"change_permissions")&&!s){const e=["send_messages","send_media","send_stickers","send_forwarded_messages","embed_links","invite_users","view_participants"],s=new Qi({titleLangKey:"ChannelPermissions",clickable:()=>{const e=new yn(this.slider);e.chatId=this.chatId,e.open()},icon:"permissions"}),n=()=>{s.subtitle.innerHTML=e.reduce((e,s)=>e+ +Pe.hasRights(this.chatId,s,t.default_banned_rights),0)+"/"+e.length};n(),(Pe.isChannel(this.chatId)||Pe.isMegagroup(this.chatId))&&i.content.append(s.container),this.listenerSetter.add(H.default)("chat_update",e=>{this.chatId===e&&n()})}if(this.scrollable.append(i.container),Object(v.b)(this.editPeer.nextBtn,()=>{this.editPeer.nextBtn.disabled=!0;let e=[];const t=this.chatId;this.chatNameInputField.isValidToChange()&&e.push(Pe.editTitle(t,this.chatNameInputField.value)),this.descriptionInputField.isValidToChange()&&e.push(Pe.editAbout(t,this.descriptionInputField.value)),this.editPeer.uploadAvatar&&e.push(this.editPeer.uploadAvatar().then(e=>Pe.editPhoto(t,e))),Promise.race(e).finally(()=>{this.editPeer.nextBtn.removeAttribute("disabled"),this.close()})},{listenerSetter:this.listenerSetter}),s&&t.pFlags.creator){const e=new Gi.a({text:"PeerInfo.SignMessages",checked:!!t.pFlags.signatures,withRipple:!0});this.listenerSetter.add(e.input)("change",()=>{const t=e.toggleDisability(!0);Pe.toggleSignatures(this.chatId,e.checked).then(()=>{t()})}),o(()=>{e.setValueSilently(!!t.pFlags.signatures)}),i.content.append(e.label)}}if(!s&&!Pe.isInChat(this.chatId)){const t=new fr({});if(!s&&Pe.hasRights(this.chatId,"change_permissions")&&!Pe.isInChat(this.chatId)){const s=new Gi.a({text:"ChatHistory",withRipple:!0});this.listenerSetter.add(s.input)("change",()=>{const e=s.toggleDisability(!0);Pe.togglePreHistoryHidden(this.chatId,!s.checked).then(()=>{e()})});const n=()=>{s.setValueSilently(i&&!e.pFlags.hidden_prehistory)};n(),o(n),t.content.append(s.label)}this.scrollable.append(t.container)}{const e=new fr({}),t=new Qi({titleLangKey:"PeerInfo.Administrators",icon:"admin",listenerSetter:this.listenerSetter,clickable:()=>{const e=new On(this.slider);e.chatId=this.chatId,e.open()}}),n=()=>Fn(this,void 0,void 0,(function*(){const e=yield Ts.getChatFull(this.chatId,!0);t.subtitle.textContent=""+(e.admins_count||1)}));n(),o(n,"full"),e.content.append(t.container);{const t=new Qi({titleLangKey:s?"PeerInfo.Subscribers":"GroupMembers",icon:"newgroup",clickable:()=>{new kn(this.slider).open(this.chatId)},listenerSetter:this.listenerSetter}),n=()=>Fn(this,void 0,void 0,(function*(){const e=yield Ts.getChatFull(this.chatId,!0),s=i?e.participants_count||1:e.participants.participants.length;t.subtitle.textContent=Object(ds.e)(s)}));n(),o(n,"full"),H.default.addEventListener("chat_update",e=>{e===this.chatId&&Ts.getChannelParticipants(this.chatId,{_:"channelParticipantsRecent"})}),e.content.append(t.container)}const a=new Qi({titleLangKey:"ChannelBlockedUsers",icon:"deleteuser",clickable:()=>{new xn(this.slider).open(this.chatId)},listenerSetter:this.listenerSetter}),r=()=>Fn(this,void 0,void 0,(function*(){const e=(yield Ts.getChatFull(this.chatId,!0)).kicked_count||0;e?a.subtitle.textContent=Object(ds.e)(e):a.subtitle.replaceChildren(Object(O.i18n)("NoBlockedUsers"))}));r(),o(r,"full"),e.content.append(a.container),this.scrollable.append(e.container)}if(Pe.hasRights(this.chatId,"delete_chat")){const e=new fr({}),t=Object(Ks.a)("btn-primary btn-transparent danger",{icon:"delete",text:s?"PeerInfo.DeleteChannel":"DeleteAndExitButton"});Object(v.b)(t,()=>{new wn(r,void 0,e=>{const s=Object(tn.a)([t],!0);e.then(()=>{this.close()},()=>{s()})})},{listenerSetter:this.listenerSetter}),e.content.append(t),this.scrollable.append(e.container)}i||this.listenerSetter.add(H.default)("dialog_migrate",({migrateFrom:e,migrateTo:t})=>{r===e&&(this.chatId=t.toChatId(),this._init())})}))}init(){return this._init()}}class jn extends Ys{init(){this.container.classList.add("edit-peer-container","edit-contact-container");const e=!ye.isContact(this.peerId.toUserId());this.setTitle(e?"AddContactTitle":"Edit");{const t=new fr({noDelimiter:!0}),s=[],i=document.createElement("div");if(i.classList.add("input-wrapper"),this.nameInputField=new Ws.b({label:"FirstName",name:"contact-name",maxLength:70,required:!0}),this.lastNameInputField=new Ws.b({label:"LastName",name:"contact-lastname",maxLength:70}),this.peerId){const t=ye.getUser(this.peerId);e?(this.nameInputField.setDraftValue(t.first_name),this.lastNameInputField.setDraftValue(t.last_name)):(this.nameInputField.setOriginalValue(t.first_name),this.lastNameInputField.setOriginalValue(t.last_name))}if(i.append(this.nameInputField.container,this.lastNameInputField.container),s.push(this.nameInputField,this.lastNameInputField),this.editPeer=new Vi({peerId:this.peerId,inputFields:s,listenerSetter:this.listenerSetter,doNotEditAvatar:!0}),this.content.append(this.editPeer.nextBtn),this.peerId){const s=document.createElement("div");s.classList.add("avatar-edit"),s.append(this.editPeer.avatarElem);const n=new Gi.a({text:"Notifications"});n.input.addEventListener("change",e=>{e.isTrusted&&js.mutePeer(this.peerId)}),this.listenerSetter.add(H.default)("notify_settings",e=>{if("notifyPeer"!==e.peer._)return;const t=Te.getPeerId(e.peer.peer);if(this.peerId===t){const t=!Cs.isMuted(e.notify_settings);t!==n.checked&&(n.checked=t)}});const a=document.createElement("div");a.classList.add("profile-name"),a.append(new Oe({peerId:this.peerId}).element);const o=document.createElement("div");if(o.classList.add("profile-subtitle"),o.append(Object(O.i18n)("EditContact.OriginalName")),t.content.append(s,a,o,i),e){const e=ye.getUser(this.peerId),s=new Qi({icon:"phone",titleLangKey:e.phone?void 0:"MobileHidden",title:e.phone?ye.formatUserPhone(e.phone):void 0,subtitleLangKey:e.phone?"Phone":"MobileHiddenExceptionInfo",subtitleLangArgs:e.phone?void 0:[new Oe({peerId:this.peerId}).element]});t.content.append(s.container)}else{const e=new Qi({checkboxField:n}),s=!Cs.isPeerLocalMuted(this.peerId,!1);n.checked=s,t.content.append(e.container)}}else t.content.append(i);this.scrollable.append(t.container),Object(v.b)(this.editPeer.nextBtn,()=>{this.editPeer.nextBtn.disabled=!0,ye.addContact(this.peerId,this.nameInputField.value,this.lastNameInputField.value,ye.getUser(this.peerId).phone).finally(()=>{this.editPeer.nextBtn.removeAttribute("disabled"),this.close()})},{listenerSetter:this.listenerSetter})}if(!e){const e=new fr({}),t=Object(Ks.a)("btn-primary btn-transparent danger",{icon:"delete",text:"PeerInfo.DeleteContact"});Object(v.b)(t,()=>{new en("popup-delete-contact",{peerId:this.peerId,titleLangKey:"DeleteContact",descriptionLangKey:"AreYouSureDeleteContact",buttons:ai([{langKey:"Delete",callback:()=>{const e=Object(tn.a)([t],!0);ye.deleteContacts([this.peerId]).then(()=>{this.close()},()=>{e()})},isDanger:!0}])}).show()},{listenerSetter:this.listenerSetter}),e.content.append(t),this.scrollable.append(e.container)}}}var Rn=!C.IS_FIREFOX&&!1;function Bn(){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttributeNS(null,"viewBox","0 0 24 24"),e.setAttributeNS(null,"width","24"),e.setAttributeNS(null,"height","24"),e.classList.add("verified-icon");const t=document.createElementNS("http://www.w3.org/2000/svg","use");t.setAttributeNS(null,"href","#verified-background"),t.classList.add("verified-background");const s=document.createElementNS("http://www.w3.org/2000/svg","use");return s.setAttributeNS(null,"href","#verified-check"),s.classList.add("verified-check"),e.append(t,s),e}class Un extends Ns{constructor(e){super(Object.assign(Object.assign({},e),{loadMore:(e,t,s)=>{if(this.peerId.isAnyChat()||!t)return Promise.resolve({count:0,items:[]});const i=null==e?void 0:e.photoId;return Dt.getUserPhotos(this.peerId,i,s).then(e=>{const t=e.photos.map(e=>({element:null,photoId:e}));return{count:e.count,items:t}})}})),this.loadedAllUp=!0,this.peerId=e.peerId}}var Nn=s(167),Hn=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};const zn=e=>"touches"in e?e.touches[0]:e;function Wn(e,t){return t?Math.hypot(t.pageX-e.pageX,t.pageY-e.pageY):0}function qn(e,t){return{x:(e.pageX+t.pageX)/2,y:(e.pageY+t.pageY)/2}}const Vn=document;let Gn=!1;Sn.addEventListener("toggle",e=>{Gn=e});const Kn={passive:!1},Qn={capture:!0,passive:!1};class $n{constructor(e){var t,s,n,a,o;this.reset=e=>{var t,s,i;this.log("reset"),Ht.IS_TOUCH_SUPPORTED?this.listenerSetter.removeManual(Vn,"touchmove",this.handleMove,Kn):(this.listenerSetter.removeManual(Vn,"mousemove",this.handleMove,!1),this.setCursorTo.style.cursor=""),this.hadMove&&(null===(t=this.onReset)||void 0===t||t.call(this)),null===(s=this.releaseWheelDrag)||void 0===s||s.clearTimeout(),null===(i=this.releaseWheelZoom)||void 0===i||i.clearTimeout(),this.resetValues()},this.handleStart=e=>Hn(this,void 0,void 0,(function*(){var t,s;if(this.log("start"),this.isMouseDown){const t=e.touches;return void(2===(null==t?void 0:t.length)&&(this.initialDistance=Wn(t[0],t[1]),this.initialTouchCenter=qn(t[0],t[1])))}const i=zn(e);if(0!==Math.max(0,null!==(t=i.button)&&void 0!==t?t:0))return;if(Object(Nn.a)(e))return;const n=++this.tempId,a=null===(s=this.verifyTouchTarget)||void 0===s?void 0:s.call(this,e);if(void 0!==a){let e;if(a instanceof Promise){if(e=yield a,this.tempId!==n)return}else e=a;if(!e)return this.reset()}if(this.isMouseDown=!0,this.withDelay&&!Ht.IS_TOUCH_SUPPORTED){const e=Object.assign(Object.assign({},!1),{once:!0}),t=Object(w.a)(),s=()=>t.resolve(),i=this.listenerSetter.add(Vn)("mousemove",s,e);if(yield Promise.race([Object(M.a)(300),t]),t.resolve(),this.listenerSetter.remove(i),this.tempId!==n)return}this.xDown=i.clientX,this.yDown=i.clientY,this.eventUp=i,Ht.IS_TOUCH_SUPPORTED?this.listenerSetter.add(Vn)("touchmove",this.handleMove,Kn):this.listenerSetter.add(Vn)("mousemove",this.handleMove,!1),this.onStart&&(this.onStart(),this.hadMove=!0,this.handleMove(i))})),this.handleMove=e=>{var t,s;if(void 0===this.xDown||void 0===this.yDown||Gn)return void this.reset();if(this.cancelEvent&&Object(f.a)(e),(null===(t=this.releaseWheelDrag)||void 0===t?void 0:t.isDebounced())||(null===(s=this.releaseWheelZoom)||void 0===s?void 0:s.isDebounced()))return;this.log("move");const i=this.eventUp=zn(e),n=i.clientX,a=i.clientY,o=n-this.xDown+this.xAdded,r=a-this.yDown+this.yAdded;if(!this.hadMove){if(!o&&!r)return;this.setHadMove(e)}const l=e.touches;if(this.onZoom&&this.initialDistance>0&&2===l.length){const e=Wn(l[0],l[1]),t=qn(l[0],l[1]),s=t.x-this.initialTouchCenter.x,i=t.y-this.initialTouchCenter.y,n={zoomFactor:e/this.initialDistance,initialCenterX:this.initialTouchCenter.x,initialCenterY:this.initialTouchCenter.y,dragOffsetX:s,dragOffsetY:i,currentCenterX:t.x,currentCenterY:t.y};this.onZoom(n)}this.dispatchOnSwipe(o,r,e)},this.handleWheel=e=>{var t;if(!this.hadMove&&this.verifyTouchTarget){const t=this.verifyTouchTarget(e);if(void 0!==t&&!t)return void this.reset(e)}if(Object(f.a)(e),this.log("wheel"),this.onDoubleClick&&Object.is(e.deltaX,-0)&&Object.is(e.deltaY,-0)&&e.ctrlKey)return this.onWheelCapture(e),this.onDoubleClick({centerX:e.pageX,centerY:e.pageY}),void this.reset();e.metaKey||e.ctrlKey||e.shiftKey?((null===(t=this.releaseWheelDrag)||void 0===t?void 0:t.isDebounced())&&this.reset(),this.onWheelZoom(e)):this.handleWheelDrag(e)},this.handleWheelDrag=e=>{this.log("wheel drag"),this.onWheelCapture(e),this.isDragCanceled.x&&Math.sign(this.initialDragOffset.x)!==Math.sign(e.deltaX)||(this.initialDragOffset.x-=e.deltaX),this.isDragCanceled.y&&Math.sign(this.initialDragOffset.y)!==Math.sign(e.deltaY)||(this.initialDragOffset.y-=e.deltaY);const{x:t,y:s}=this.initialDragOffset;this.releaseWheelDrag(e),this.dispatchOnSwipe(t,s,e,(e,t)=>{this.isDragCanceled={x:e,y:t}})},this.onWheelCapture=e=>{this.hadMove||(this.log("wheel capture"),this.handleStart(e),this.setHadMove(e),this.initialTouchCenter={x:e.x,y:e.y})},this.onWheelZoom=e=>{if(!this.onZoom)return;this.log("wheel zoom"),this.onWheelCapture(e);const t=e.x-this.initialTouchCenter.x,s=e.y-this.initialTouchCenter.y,i=Object(ds.a)(e.deltaY,-25,25);this.wheelZoom-=.01*i;const n={zoomAdd:this.wheelZoom-1,initialCenterX:this.initialTouchCenter.x,initialCenterY:this.initialTouchCenter.y,dragOffsetX:t,dragOffsetY:s,currentCenterX:e.x,currentCenterY:e.y};this.onZoom(n),this.releaseWheelZoom(e)},Object(m.g)(this,e),this.log=Object(i.b)("SWIPE-HANDLER"),null!==(t=this.cursor)&&void 0!==t||(this.cursor="grabbing"),null!==(s=this.cancelEvent)&&void 0!==s||(this.cancelEvent=!0),null!==(n=this.listenerOptions)&&void 0!==n||(this.listenerOptions=Kn),null!==(a=this.setCursorTo)&&void 0!==a||(this.setCursorTo=this.element),this.listenerSetter=new Gs,this.setListeners(),this.resetValues(),this.tempId=0,null===(o=e.middleware)||void 0===o||o.onDestroy(()=>{this.reset(),this.removeListeners()}),this.releaseWheelDrag=Zi(this.reset,150,!1),this.releaseWheelZoom=Zi(this.reset,150,!1)}setListeners(){Ht.IS_TOUCH_SUPPORTED?(this.withDelay?Object(hi.a)(this.element,e=>{Object(f.a)(e),this.handleStart(e)},this.listenerSetter):this.listenerSetter.add(this.element)("touchstart",this.handleStart,this.listenerOptions),this.onDoubleClick&&this.listenerSetter.add(this.element)("dblclick",e=>{this.onDoubleClick({centerX:e.pageX,centerY:e.pageY})}),this.listenerSetter.add(Vn)("touchend",this.reset)):(this.listenerSetter.add(this.element)("mousedown",this.handleStart,this.listenerOptions),this.listenerSetter.add(Vn)("mouseup",this.reset),(this.onZoom||this.onDoubleClick)&&this.listenerSetter.add(this.element)("wheel",this.handleWheel,Qn))}removeListeners(){this.log("remove listeners"),this.reset(),this.listenerSetter.removeAll()}setCursor(e=""){this.cursor=e,!Ht.IS_TOUCH_SUPPORTED&&this.hadMove&&this.setCursorTo.style.setProperty("cursor",this.cursor,"important")}add(e,t){this.xAdded=e,this.yAdded=t,this.handleMove({clientX:this.eventUp.clientX,clientY:this.eventUp.clientY,target:this.eventUp.target})}resetValues(){++this.tempId,this.hadMove=!1,this.xAdded=this.yAdded=0,this.xDown=this.yDown=this.eventUp=this.isMouseDown=void 0,this.onZoom&&(this.initialDistance=0,this.initialTouchCenter={x:mt.windowW/2,y:mt.windowH/2},this.initialDragOffset={x:0,y:0},this.isDragCanceled={x:!1,y:!1},this.wheelZoom=1)}setHadMove(e){var t;this.hadMove||(this.log("had move"),this.hadMove=!0,this.setCursorTo.style.setProperty("cursor",this.cursor,"important"),null===(t=this.onFirstSwipe)||void 0===t||t.call(this,e))}dispatchOnSwipe(...e){const t=this.onSwipe(...e);void 0!==t&&t&&this.reset()}}function Yn(e,t,s,i=e.getBoundingClientRect(),n=t.getBoundingClientRect()){let{top:a,right:o,bottom:r,left:l}=n;if(s){const e=t.querySelector(".sticky");if(e){a=e.getBoundingClientRect().bottom}}if(i.top>=r||i.bottom<=a||i.right<=l||i.left>=o)return null;const d={top:!1,right:!1,bottom:!1,left:!1,vertical:0,horizontal:0},c=mt.windowW,h=mt.windowH;return{rect:{top:i.top<a&&0!==a?(d.top=!0,++d.vertical,a):i.top,right:i.right>o&&o!==c?(d.right=!0,++d.horizontal,o):i.right,bottom:i.bottom>r&&r!==h?(d.bottom=!0,++d.vertical,r):i.bottom,left:i.left<l&&0!==l?(d.left=!0,++d.horizontal,l):i.left},overflow:d}}function Xn(e,t,s,i,n,a,o){return[e,",",t," ",s," ",i,",",n," ",a,",",o].join("")}function Zn(e,t,s,i,n,a,o,r){const l=[];return l.push("M"+(e+s/2)+","+t),l.push("H"+(e+s-a)),a>0&&l.push("A"+Xn(a,a,0,0,1,e+s,t+a)),l.push("V"+(t+i-o)),o>0&&l.push("A"+Xn(o,o,0,0,1,e+s-o,t+i)),l.push("H"+(e+r)),r>0&&l.push("A"+Xn(r,r,0,0,1,e+0,t+i-r)),l.push("V"+(t+n)),n>0&&l.push("A"+Xn(n,n,0,0,1,e+n,t+0)),l.push("Z"),l.join(" ")}window.getVisibleRect=Yn,j.a.generatePathData=Zn;var Jn=s(205),ea=s.n(Jn);function ta(){return!!(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement)}var sa=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class ia extends Mt.a{constructor(e,t){super(!1),this.listLoader=e,this.author={},this.content={},this.buttons={},this.tempId=0,this.preloader=null,this.preloaderStreamable=null,this.isFirstOpen=!0,this.pageEl=document.getElementById("page-chats"),this.zoomElements={},this.transform={x:0,y:0,scale:1},this.liveGetMediaInterval=null,this.liveHls=null,this.lastTransform=this.transform,this.lastZoomCenter=this.transform,this.lastDragOffset=this.transform,this.lastDragDelta=this.transform,this.onSwipeFirst=e=>{this.lastDragOffset=this.lastDragDelta={x:0,y:0},this.lastTransform=Object.assign({},this.transform),"wheel"===(null==e?void 0:e.type)&&this.ctrlKeyDown||(this.moversContainer.classList.add("no-transition"),this.zoomElements.rangeSelector.container.classList.remove("with-transition")),this.isGesturingNow=!0,this.lastGestureTime=Date.now(),this.clampZoomDebounced.clearTimeout(),this.lastTransform.x||this.lastTransform.y||this.isZooming||(this.initialContentRect=this.content.media.getBoundingClientRect())},this.onSwipeReset=()=>{this.moversContainer.classList.remove("no-transition"),this.clampZoomDebounced.clearTimeout();const{draggingType:e}=this;if(this.isZoomingNow=!1,this.isGesturingNow=!1,this.draggingType=void 0,!this.closing)if(this.transform.scale>1){const t=Math.min(this.transform.scale,4),s=t/this.transform.scale;let i=this.transform.x*s+(this.lastZoomCenter.x-s*this.lastZoomCenter.x),n=this.transform.y*s+(this.lastZoomCenter.y-s*this.lastZoomCenter.y);if(e&&"wheel"!==e&&this.lastTransform.scale===this.transform.scale){const e=.1,t=Math.max(1,Date.now()-this.lastGestureTime),s=Math.abs(this.lastDragOffset.x)/t,a=Math.abs(this.lastDragOffset.y)/t;i-=Math.abs(this.lastDragOffset.x)*s*e*-this.lastDragDelta.x,n-=Math.abs(this.lastDragOffset.y)*a*e*-this.lastDragDelta.y}const[a]=this.calculateOffsetBoundaries({x:i,y:n,scale:t});this.lastTransform=a,this.setTransform(a)}else this.transform.scale<1&&this.resetZoom()},this.onZoom=({initialCenterX:e,initialCenterY:t,zoom:s,zoomAdd:i,currentCenterX:n,currentCenterY:a,dragOffsetX:o,dragOffsetY:r,zoomFactor:l})=>{e||(e=mt.windowW/2),t||(t=mt.windowH/2),n||(n=mt.windowW/2),a||(a=mt.windowH/2),this.isZoomingNow=!0;const d=void 0!==i?Object(ds.a)(this.lastTransform.scale+i,.5,12):null!=s?s:Object(ds.a)(this.lastTransform.scale*l,.5,12),c=d/this.lastTransform.scale,h=Math.abs(Math.min(this.lastTransform.x,0)),u=Math.abs(Math.min(this.lastTransform.y,0));this.lastZoomCenter={x:n,y:a};const p=h+e,g=u+t,{scaleOffsetX:m,scaleOffsetY:f}=this.calculateScaleOffset({x:p,y:g,scale:c}),[v]=this.calculateOffsetBoundaries({x:this.lastTransform.x+m+o,y:this.lastTransform.y+f+r,scale:d});this.setTransform(v)},this.calculateOffsetBoundaries=({x:e,y:t,scale:s},i=0)=>{if(!this.initialContentRect)return[{x:e,y:t,scale:s},!0,!0];let n=!0,a=!0;const{minX:o,maxX:r,minY:l,maxY:d}=this.getZoomBoundaries(s,i);return n=Object(ds.d)(e,r,o),e=Object(ds.a)(e,r,o),a=Object(ds.d)(t,d,l),[{x:e,y:t=Object(ds.a)(t,d,l),scale:s},n,a]},this.setZoomValue=(e=this.transform.scale)=>{var t;null!==(t=this.initialContentRect)&&void 0!==t||(this.initialContentRect=this.content.media.getBoundingClientRect()),1===e&&(this.transform.x=0,this.transform.y=0),this.moversContainer.style.transform=`translate3d(${this.transform.x.toFixed(3)}px, ${this.transform.y.toFixed(3)}px, 0px) scale(${e.toFixed(3)})`,this.zoomElements.btnOut.classList.toggle("inactive",e<=.5),this.zoomElements.btnIn.classList.toggle("inactive",e>=4),this.toggleZoom(1!==e)},this.onClick=e=>{if(this.setMoverAnimationPromise)return;const t=e.target;if("A"===t.tagName)return;if(Object(f.a)(e),Ht.IS_TOUCH_SUPPORTED)return this.highlightSwitchersTimeout?clearTimeout(this.highlightSwitchersTimeout):this.wholeDiv.classList.add("highlight-switchers"),void(this.highlightSwitchersTimeout=window.setTimeout(()=>{this.wholeDiv.classList.remove("highlight-switchers"),this.highlightSwitchersTimeout=0},3e3));const s=this.isZooming;let i=null;const n=["ckin__player","media-viewer-buttons","media-viewer-author","media-viewer-caption","zoom-container"];s&&n.push("media-viewer-movers"),n.find(e=>{try{if(i=Object(ti.a)(t,e),i)return!0}catch(e){return!1}}),i&&(s||"IMG"!==t.tagName&&"image"!==t.tagName)||this.buttons.close.click()},this.onKeyDown=e=>{if(H.default.overlaysActive>1)return;const t=e.key;let s=!0;"ArrowRight"===t?!this.isZooming&&this.buttons.next.click():"ArrowLeft"===t?!this.isZooming&&this.buttons.prev.click():"-"===t||"="===t?this.ctrlKeyDown&&this.addZoomStep("="===t):s=!1,(e.ctrlKey||e.metaKey)&&(this.ctrlKeyDown=!0),s&&Object(f.a)(e)},this.onKeyUp=e=>{H.default.overlaysActive>1||e.ctrlKey||e.metaKey||(this.ctrlKeyDown=!1,this.isZooming&&this.setZoomValue())},this.log=Object(i.b)("AMV"),this.preloader=new y,this.preloaderStreamable=new y({cancelable:!1,streamable:!0}),this.preloader.construct(),this.preloaderStreamable.construct(),this.lazyLoadQueue=new l,this.wholeDiv=document.createElement("div"),this.wholeDiv.classList.add("media-viewer-whole"),this.overlaysDiv=document.createElement("div"),this.overlaysDiv.classList.add("overlays");const s=document.createElement("div");s.classList.add("media-viewer");const n=this.topbar=document.createElement("div");n.classList.add("media-viewer-topbar","media-viewer-appear");const a=document.createElement("div");a.classList.add("media-viewer-topbar-left"),this.buttons["mobile-close"]=Qs("close",{onlyMobile:!0}),this.author.container=document.createElement("div"),this.author.container.classList.add("media-viewer-author","no-select");const o=document.createElement("div");this.author.avatarEl=new Od,this.author.avatarEl.classList.add("media-viewer-userpic","avatar-44"),this.author.nameEl=document.createElement("div"),this.author.nameEl.classList.add("media-viewer-name"),this.author.date=document.createElement("div"),this.author.date.classList.add("media-viewer-date"),o.append(this.author.nameEl,this.author.date),this.author.container.append(this.author.avatarEl,o);const r=document.createElement("div");r.classList.add("media-viewer-buttons"),t.concat(["download","zoom","close"]).forEach(e=>{const t=Qs(e,{noRipple:!0});this.buttons[e]=t,r.append(t)}),this.buttons.zoom.classList.add("zoom-in"),this.zoomElements.container=document.createElement("div"),this.zoomElements.container.classList.add("zoom-container"),this.zoomElements.btnOut=Qs("zoomout",{noRipple:!0}),Object(v.b)(this.zoomElements.btnOut,()=>this.addZoomStep(!1)),this.zoomElements.btnIn=Qs("zoomin",{noRipple:!0}),Object(v.b)(this.zoomElements.btnIn,()=>this.addZoomStep(!0)),this.zoomElements.rangeSelector=new Si({step:.01,min:.5,max:4,withTransition:!0},1),this.zoomElements.rangeSelector.setListeners(),this.zoomElements.rangeSelector.setHandlers({onScrub:e=>{var t;const s=e-this.transform.scale;this.addZoom(s),null===(t=this.clampZoomDebounced)||void 0===t||t.clearTimeout()},onMouseDown:()=>{this.onSwipeFirst()},onMouseUp:()=>{this.onSwipeReset()}}),this.zoomElements.container.append(this.zoomElements.btnOut,this.zoomElements.rangeSelector.container,this.zoomElements.btnIn),Ht.IS_TOUCH_SUPPORTED||this.wholeDiv.append(this.zoomElements.container),this.content.main=document.createElement("div"),this.content.main.classList.add("media-viewer-content"),this.content.container=document.createElement("div"),this.content.container.classList.add("media-viewer-container"),this.content.media=document.createElement("div"),this.content.media.classList.add("media-viewer-media"),this.content.container.append(this.content.media),this.content.main.append(this.content.container),s.append(this.content.main),this.overlaysDiv.append(s),a.append(this.buttons["mobile-close"],this.author.container),n.append(a,r),this.buttons.prev=document.createElement("div"),this.buttons.prev.className="media-viewer-switcher media-viewer-switcher-left",this.buttons.prev.innerHTML='<span class="tgico-down media-viewer-prev-button"></span>',this.buttons.next=document.createElement("div"),this.buttons.next.className="media-viewer-switcher media-viewer-switcher-right",this.buttons.next.innerHTML='<span class="tgico-down media-viewer-next-button"></span>',this.moversContainer=document.createElement("div"),this.moversContainer.classList.add("media-viewer-movers"),this.wholeDiv.append(this.overlaysDiv,this.buttons.prev,this.buttons.next,this.topbar,this.moversContainer),this.setNewMover()}get target(){return this.listLoader.current}set target(e){this.listLoader.current=e}setListeners(){Object(v.b)(this.buttons.download,this.onDownloadClick),[this.buttons.close,this.buttons["mobile-close"],this.preloaderStreamable.preloader].forEach(e=>{Object(v.b)(e,this.close.bind(this))}),[[-1,this.buttons.prev],[1,this.buttons.next]].forEach(([e,t])=>{t.addEventListener("click",t=>{Object(f.a)(t),this.setMoverPromise||this.listLoader.go(e)})}),Object(v.b)(this.buttons.zoom,()=>{this.isZooming?this.resetZoom():this.addZoomStep(!0)}),this.wholeDiv.addEventListener("click",this.onClick),this.listLoader.onJump=(e,t)=>{t?this.onNextClick(e):this.onPrevClick(e)};const e=(e,t)=>{const[s,i]=[e-this.lastDragOffset.x,t-this.lastDragOffset.y],[n,a,o]=this.calculateOffsetBoundaries({x:this.transform.x+s,y:this.transform.y+i,scale:this.transform.scale});return this.lastDragDelta={x:s,y:i},this.lastDragOffset={x:e,y:t},this.setTransform(n),{inBoundsX:a,inBoundsY:o}},t=Zi(()=>{this.lastGestureTime=Date.now()},500,!1,!0);this.clampZoomDebounced=Zi(()=>{this.onSwipeReset()},300,!1,!0),this.swipeHandler=new $n({element:this.wholeDiv,onReset:this.onSwipeReset,onFirstSwipe:this.onSwipeFirst,onSwipe:(s,i,n,a)=>{if(ta())return;if(this.isZooming&&!this.isZoomingNow){t(),this.draggingType=n.type;const{inBoundsX:o,inBoundsY:r}=e(s,i);return void(null==a||a(!o,!r))}if(this.isZoomingNow||!Ht.IS_TOUCH_SUPPORTED)return;if(Math.abs(s)/mt.windowW>.2||Math.abs(s)>125)return s>0?this.buttons.prev.click():this.buttons.next.click(),!0;return(Math.abs(i)/mt.windowH>.2||Math.abs(i)>125)&&(this.close(),!0)},onZoom:this.onZoom,onDoubleClick:({centerX:e,centerY:t})=>{if(this.isZooming)this.resetZoom();else{const s=3;this.changeZoomByPosition(e,t,s)}},verifyTouchTarget:e=>!(ta()||Object(zt.a)(e.target,this.zoomElements.container)||Object(ti.a)(e.target,"ckin__controls")||Object(ti.a)(e.target,"media-viewer-caption")||Object(ti.a)(e.target,"media-viewer-topbar")&&"wheel"!==e.type),cursor:""})}changeZoomByPosition(e,t,s){const{scaleOffsetX:i,scaleOffsetY:n}=this.calculateScaleOffset({x:e,y:t,scale:s}),a=this.calculateOffsetBoundaries({x:i,y:n,scale:s})[0];this.setTransform(a)}setTransform(e){this.transform=e,this.changeZoom(e.scale)}calculateScaleOffset({x:e,y:t,scale:s}){return{scaleOffsetX:e-s*e,scaleOffsetY:t-s*t}}toggleZoom(e){const t=this.isZooming,s=void 0===e;if((this.zoomElements.rangeSelector.mousedown||this.ctrlKeyDown)&&(e=!0),null!=e||(e=!t),t!==e){if(this.buttons.zoom.classList.toggle("zoom-in",!e),this.zoomElements.container.classList.toggle("is-visible",this.isZooming=e),this.wholeDiv.classList.toggle("is-zooming",e),s||!e){const t=e?this.transform.scale:1;this.setZoomValue(t),this.zoomElements.rangeSelector.setProgress(t)}this.videoPlayer&&this.videoPlayer.lockControls(!e&&void 0)}}addZoomStep(e){this.addZoom(.5*(e?1:-1))}resetZoom(){this.setTransform({x:0,y:0,scale:1})}changeZoom(e=this.transform.scale){this.transform.scale=e,this.zoomElements.rangeSelector.setProgress(e),this.setZoomValue(e)}addZoom(e){this.lastTransform=this.transform,this.onZoom({zoomAdd:e,currentCenterX:0,currentCenterY:0,initialCenterX:0,initialCenterY:0,dragOffsetX:0,dragOffsetY:0}),this.lastTransform=this.transform,this.clampZoomDebounced()}getZoomBounce(){return this.isGesturingNow&&Ht.IS_TOUCH_SUPPORTED?50:0}getZoomBoundaries(e=this.transform.scale,t=0){if(!this.initialContentRect)return{minX:0,maxX:0,minY:0,maxY:0};const s=(mt.windowW-mt.windowW*e)/2,i=(mt.windowH-mt.windowH*e)/2;return{minX:Math.max(-this.initialContentRect.left*e,s),maxX:mt.windowW-this.initialContentRect.right*e,minY:Math.max(-this.initialContentRect.top*e+t,i),maxY:mt.windowH-this.initialContentRect.bottom*e}}setBtnMenuToggle(e){const t=Pi({onlyMobile:!0},"bottom-left",e);this.topbar.append(t)}close(e){var t,s;if(e&&Object(f.a)(e),null!==this.liveGetMediaInterval&&(clearInterval(this.liveGetMediaInterval),this.liveGetMediaInterval=null),null!==this.liveHls&&this.liveHls.destroy(),this.setMoverAnimationPromise)return Promise.reject();this.closing=!0,null===(t=this.swipeHandler)||void 0===t||t.removeListeners(),Nt.a.removeByType("media"),this.lazyLoadQueue.clear();const i=this.setMoverToTarget(null===(s=this.target)||void 0===s?void 0:s.element,!0).then(({onAnimationEnd:e})=>e);return this.listLoader.reset(),this.listLoader.cleanup&&this.listLoader.cleanup(),this.setMoverPromise=null,this.tempId=-1,window.appMediaViewer=void 0,window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp),i.finally(()=>{this.wholeDiv.remove(),H.default.isOverlayActive=!1,zs.a.checkAnimations(!1)}),i}setMoverToTarget(e,t=!1,s=0){return sa(this,void 0,void 0,(function*(){this.dispatchEvent("setMoverBefore");const i=this.content.mover;t||(i.innerHTML="");const n=this.isZooming&&t?this.transform.scale:1;this.removeCenterFromMover(i);const a=0!==s,o=H.default.settings.animationsEnabled?a?350:200:0;let r,l;e&&(e instanceof Od||e.classList.contains("grid-item")?(r=e,l=e.getBoundingClientRect()):e instanceof SVGImageElement||e.parentElement instanceof SVGForeignObjectElement?(r=Object(ti.a)(e,"attachment"),l=r.getBoundingClientRect()):e.classList.contains("profile-avatars-avatar")&&(r=Object(ti.a)(e,"profile-avatars-container"),l=r.getBoundingClientRect(),t&&e.getBoundingClientRect().left!==l.left&&(e=r=l=void 0))),e||(e=this.content.media),l||(r=e.parentElement,l=e.getBoundingClientRect());let d=!1;if(e!==this.content.media&&!e.classList.contains("profile-avatars-avatar")){const s=Yn(r,Object(ti.a)(r,"scrollable"),!0);!t||s&&2!==s.overflow.vertical&&2!==s.overflow.horizontal?!s||1!==s.overflow.vertical&&1!==s.overflow.horizontal||(d=!0):(r=(e=this.content.media).parentElement,l=e.getBoundingClientRect())}const c=this.content.media.getBoundingClientRect();c.width=c.width<320?320:c.width,c.height=c.height<250?250:c.height;let h,u,p,m="";if(a?(h=1===s?mt.windowW:-c.width,u=c.top):(h=l.left,u=l.top),m+=`translate3d(${h}px,${u}px,0) `,e instanceof HTMLImageElement||e instanceof HTMLVideoElement||"DIV"===e.tagName){if(i.firstElementChild&&i.firstElementChild.classList.contains("media-viewer-aspecter")){p=i.firstElementChild;const e=p.querySelector(".ckin__player");if(e){const t=e.firstElementChild;p.append(t),e.remove()}p.style.cssText||(i.classList.remove("active"),this.setFullAspect(p,c,l),i.offsetLeft,i.classList.add("active"))}else p=document.createElement("div"),p.classList.add("media-viewer-aspecter"),i.prepend(p);p.style.cssText=`width: ${l.width}px; height: ${l.height}px; transform: scale3d(${c.width/l.width}, ${c.height/l.height}, 1);`}i.style.width=c.width+"px",i.style.height=c.height+"px";const f=l.width/c.width,v=l.height/c.height;a||(m+=`scale3d(${f},${v},1) `);let b=window.getComputedStyle(r).getPropertyValue("border-radius");const y=function(e){let t=e.split(" ");if(4!==t.length){t[0]||(t[0]="0px");for(let e=t.length;e<4;++e)t[e]=t[e%2]||t[0]||"0px"}return t}(b);if(b=y.map(e=>parseInt(e)/f+"px").join(" "),a||(i.style.borderRadius=b),t&&1!==n){const e=l.left-(mt.windowW*f-l.width)/2,t=l.top-(mt.windowH*v-l.height)/2;this.moversContainer.style.transform=`matrix(${f}, 0, 0, ${v}, ${e}, ${t})`}else i.style.transform=m;let S;d&&(i.style.opacity="0");const I=e.classList.contains("is-out"),M=this.setMoverAnimationPromise=Object(w.a)(),C={onAnimationEnd:M},P=setTimeout(()=>{M.isFulfilled||M.isRejected||M.resolve()},1e3);if(M.finally(()=>{this.dispatchEvent("setMoverAfter"),this.setMoverAnimationPromise===M&&(this.setMoverAnimationPromise=null),clearTimeout(P)}),t)return e instanceof SVGSVGElement&&(S=i.querySelector("path"),S&&this.sizeTailPath(S,c,f,o,!1,I,b)),e.classList.contains("media-viewer-media")&&i.classList.add("hiding"),this.wholeDiv.classList.add("backwards"),setTimeout(()=>{this.wholeDiv.classList.remove("active")},0),setTimeout(()=>{i.style.borderRadius=b,i.firstElementChild&&(i.firstElementChild.style.borderRadius=b)},o/2),setTimeout(()=>{i.innerHTML="",i.classList.remove("moving","active","hiding"),i.style.cssText="display: none;",M.resolve()},o),i.classList.remove("opening"),C;{let t,s;if(e instanceof HTMLVideoElement){const t=Array.from(e.parentElement.querySelectorAll("img"));t.length&&(e=t.pop())}if("DIV"===e.tagName||"AVATAR-ELEMENT"===e.tagName){const n=Array.from(e.querySelectorAll("img")).pop();n&&(t=new Image,s=n.src,i.append(t))}else if(e instanceof HTMLImageElement)t=new Image,e.classList.contains("image-size-empty")&&t.classList.add("image-size-empty"),s=e.src;else if(e instanceof HTMLVideoElement)t=document.createElement("video"),t.src=e.src;else if(e instanceof SVGSVGElement){const t=e.dataset.clipId,s=t+"-mv",{width:n,height:a}=c,o=document.createElementNS("http://www.w3.org/2000/svg","svg");o.setAttributeNS(null,"width",""+n),o.setAttributeNS(null,"height",""+a),o.setAttributeNS(null,"viewBox",`0 0 ${n} ${a}`),o.setAttributeNS(null,"preserveAspectRatio","xMidYMid meet"),o.insertAdjacentHTML("beforeend",e.firstElementChild.outerHTML.replace(t,s)),o.insertAdjacentHTML("beforeend",e.lastElementChild.outerHTML.replace(t,s));const r=o.firstElementChild,l=r.firstElementChild.firstElementChild;if(l instanceof SVGUseElement){let e,t=l.getAttributeNS(null,"transform");t=t.replace(/translate\((.+?), (.+?)\) scale\((.+?), (.+?)\)/,(e,t,s,i,o)=>`translate(${t=2!==(t=+t)?n-2/f:2/f}, ${a}) scale(${+i/f}, ${+o/v})`),l.setAttributeNS(null,"transform",t),S=r.firstElementChild.lastElementChild;const s=b.split(" ").map(e=>parseInt(e));e=I?Zn(0,0,n-9/f,a,...s):Zn(9/f,0,n-9/f,a,...s),S.setAttributeNS(null,"d",e)}const d=o.lastElementChild;d.setAttributeNS(null,"width",""+c.width),d.setAttributeNS(null,"height",""+c.height),i.prepend(o)}p&&(p.style.borderRadius=b,t&&p.append(t)),t=i.querySelector("video, img"),t instanceof HTMLImageElement&&(t.classList.add("thumbnail"),p||(t.style.width=c.width+"px",t.style.height=c.height+"px"),s&&(yield Ze(t,s))),i.style.display="",Object(g.b)(()=>{i.classList.add(a?"moving":"active")})}return i.classList.add("opening"),yield Object(g.a)(),i.style.transform=`translate3d(${c.left}px,${c.top}px,0) scale3d(1,1,1)`,d&&(i.style.opacity=""),p&&this.setFullAspect(p,c,l),setTimeout(()=>{i.style.borderRadius="",i.firstElementChild&&(i.firstElementChild.style.borderRadius="")},0),i.dataset.timeout=""+setTimeout(()=>{i.classList.remove("moving","opening"),p&&(i.querySelector("video"),i.classList.remove("active"),p.style.cssText="",i.offsetLeft),i.classList.add("center","no-transition"),i.classList.add("active"),delete i.dataset.timeout,M.resolve()},o),S&&this.sizeTailPath(S,c,f,o,!0,I,b),C}))}setFullAspect(e,t,s){const i=t.width/t.height;let{width:n,height:a}=s;i>0?n=a*i:a=n*i,e.style.cssText=`width: ${n}px; height: ${a}px; transform: scale3d(${t.width/n}, ${t.height/a}, 1);`}sizeTailPath(e,t,s,i,n,a,o){const r=Date.now(),{width:l,height:d}=t;i/=2;const c=o.split(" ").map(e=>parseInt(e)),h=()=>{const t=Date.now()-r;let o=i?t/i:1;o>1&&(o=1),n&&(o=1-o);const u=c.map(e=>e*o);let p;p=a?Zn(0,0,l-9/s*o,d,...u):Zn(9/s*o,0,l,d,...u),e.setAttributeNS(null,"d",p),t<i&&Object(g.b)(h)};h()}removeCenterFromMover(e){if(e.classList.contains("center")){const t=this.content.media.getBoundingClientRect();e.style.transform=`translate3d(${t.left}px,${t.top}px,0)`,e.classList.remove("center"),e.offsetLeft,e.classList.remove("no-transition")}}moveTheMover(e,t=!0){const s=mt.windowW;this.removeCenterFromMover(e),e.classList.add("moving"),e.dataset.timeout&&clearTimeout(+e.dataset.timeout);const i=e.getBoundingClientRect(),n=e.style.transform.replace(/translate3d\((.+?),/,(e,n)=>{const a=t?-i.width:s;return e.replace(n,a+"px")});e.style.transform=n,setTimeout(()=>{e.remove()},350)}setNewMover(){const e=document.createElement("div");if(e.classList.add("media-viewer-mover"),e.style.display="none",this.content.mover){this.content.mover.parentElement.append(e)}else this.moversContainer.append(e);return this.content.mover=e}updateMediaSource(e,t,s){const i=e.tagName.toLowerCase()===s?e:e.querySelector(s);if(i&&!Object(ti.a)(e,"document")){if(Object(ti.a)(e,"attachment")){const t=e.parentElement.parentElement.querySelector(".preloader-container");if(t){if("video"===s)return void(t.classList.contains("manual")&&t.click());t.remove()}}Xe(i,t),i.classList.contains("thumbnail")&&i.parentElement.classList.contains("media-container-aspecter")&&i.classList.remove("thumbnail")}}setAuthorInfo(e,t){Object(le.a)(this.author.date,Object(S.c)(t));const s=e.isPeerId();let i;s?i=new Oe({peerId:e,dialog:!1,onlyFirstName:!1,plainText:!1}).element:(i=document.createElement("span"),i.append(N.b.wrapEmojiText(e)),i.classList.add("peer-title")),Object(le.a)(this.author.nameEl,i);let n=this.author.avatarEl;this.author.avatarEl=n.cloneNode(),s?this.author.avatarEl.removeAttribute("peer-title"):this.author.avatarEl.setAttribute("peer-title",""+e),this.author.avatarEl.setAttribute("peer",""+(e||Z.b)),n.parentElement.replaceChild(this.author.avatarEl,n)}invokeLiveGetMedia(e,t,s){return F.a.invokeApi("liveGetMedia",{id:e,access_hash:t,flags:s})}_openMedia(e,t,s,i,n,a=!1,o=[],r=[],l){var d,c;return sa(this,void 0,void 0,(function*(){if(this.setMoverPromise)return this.setMoverPromise;let h,u=!1,p="",m="ended";if("message"===(null==l?void 0:l._)&&"messageMediaLiveStream"===(null===(d=null==l?void 0:l.media)||void 0===d?void 0:d._)){u=!0;const e=l.media.state;"liveStreamStateBroadcasting"===e._?(m="broadcasting",p=e.liveStream.read_link,this.buttons.download.classList.add("hide")):("liveStreamStateEnded2"===e._||"liveStreamStateEnded"===e._)&&1===e.flags?(m="archived",p=e.archive_link):m="ended",h={downloaded:1,url:p,type:m}}if(u&&"ended"!==m){const e=l.media;let t=3e4,s=0;"broadcasting"===m&&(t=15e3,s=1),null!==this.liveGetMediaInterval&&(clearInterval(this.liveGetMediaInterval),this.liveGetMediaInterval=null),this.invokeLiveGetMedia(e.id,e.access_hash,s),this.liveGetMediaInterval=setInterval(()=>{this.invokeLiveGetMedia(e.id,e.access_hash,s).then(t=>{const s=t.state._;if("liveStreamStateEnded"===s||"liveStreamStateEnded2"===s){this.close(),$t({langPackKey:"LiveEnded",timeToDisappear:4e3}),clearInterval(this.liveGetMediaInterval);const s=Object.assign({},l);s.media=t,s.media.thumbs=e.thumbs,H.default.dispatchEvent("updateNewMessage",{_:"updateNewMessage",message:s,pts:void 0,pts_count:0}),Ie.saveUpdate({_:"updateEditMessage",message:s,pts:void 0,pts_count:0}),ki.isPictureInPicture()&&document.exitPictureInPicture()}})},t)}this.setAuthorInfo(s,t);const v="document"===e._,b=v&&e.mime_type&&(["video","gif"].includes(e.type)||0===e.mime_type.indexOf("video/"));this.isFirstOpen&&(this.isFirstOpen=!1,this.listLoader.setTargets(o,r,a),window.appMediaViewer=this),this.buttons.prev.classList.toggle("hide",!this.listLoader.previous.length),this.buttons.next.classList.toggle("hide",!this.listLoader.next.length);const y=this.content.media,w=!n||n===y;w&&(n=y),this.target={element:n};const S=++this.tempId;y.firstElementChild&&(y.innerHTML="");if(0!==i)this.moveTheMover(this.content.mover,1===i),this.setNewMover();else{window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),document.querySelectorAll(".media-viewer-whole.active").forEach(e=>{e!==this.wholeDiv&&(e.classList.remove("active"),e.style.display="none")});const e=document.getElementById("main-columns");this.pageEl.insertBefore(this.wholeDiv,e),this.wholeDiv.offsetLeft,this.wholeDiv.classList.add("active"),H.default.isOverlayActive=!0,zs.a.checkAnimations(!0),C.IS_MOBILE_SAFARI||Nt.a.pushItem({type:"media",onPop:e=>{if(this.setMoverAnimationPromise)return!1;this.close()}})}const M=this.content.mover,P=mt.windowW;let L=0;const E=mt.windowH;E<1e6&&!I.b.isMobile&&(L=120);const _=E-120-L;let k=Promise.resolve();const T=Dt.setAttachmentSize(e,y,P,_,!I.b.isMobile,void 0,!!(v&&e.w&&e.h)).photoSize;if(w){const t=st.getCacheContext(e,T.type);let s;if(t.downloaded)s=new Image,s.src=t.url;else{const i=Dt.getStrippedThumbIfNeeded(e,t,!0);i&&(k=i.loadPromise,s=i.image)}s&&(s.classList.add("thumbnail"),y.append(s))}const x=null===(c=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./))||void 0===c?void 0:c[2],A=x&&Number(x)>=132,O=u||!A&&!(!v||!e.supportsStreaming),F=O?this.preloaderStreamable:this.preloader;let D;if(this.wholeDiv.classList.contains("no-forwards")&&M.addEventListener("contextmenu",f.a),b){const t=l&&"gif"!==e.type,s=document.createElement("video");s.defaultPlaybackRate=1,s.playbackRate=1;const a=()=>this.setMoverToTarget(n,!1,i).then(({onAnimationEnd:i})=>{const a=M.firstElementChild&&M.firstElementChild.classList.contains("media-viewer-aspecter")?M.firstElementChild:M;M.querySelector("video");s.setAttribute("playsinline","true"),s.addEventListener("timeupdate",()=>{this.tempId!==S&&s.pause()}),s.addEventListener("error",()=>{4!==s.error.code&&this.log.error("Error "+s.error.code+"; details: "+s.error.message),F&&F.detach()},{once:!0}),this.addEventListener("setMoverAfter",()=>{s.src="",s.load(),s.defaultPlaybackRate=1,s.playbackRate=1},{once:!0}),C.IS_SAFARI&&(s.autoplay=!0),"gif"===e.type&&(s.muted=!0,s.autoplay=!0,s.loop=!0),a.append(s);const o=new Promise(e=>{s.addEventListener("canplay",e,{once:!0})}),r=()=>{"gif"!==e.type&&(s.dataset.ckin="default",s.dataset.overlay="1",Promise.all([o,i]).then(()=>{if(this.tempId!==S)return;if(ki.isPictureInPicture())try{document.exitPictureInPicture()}catch(e){console.warn("Failed to exit exists Picture-in-Picture: ",e)}const e="broadcasting"===m;s.defaultPlaybackRate=1,s.playbackRate=1;(this.videoPlayer=new ki(s,!0,O,void 0,e)).addEventListener("toggleControls",e=>{this.wholeDiv.classList.toggle("has-video-controls",e)}),this.addEventListener("setMoverBefore",()=>{this.wholeDiv.classList.remove("has-video-controls"),this.videoPlayer.removeListeners(),this.videoPlayer=void 0},{once:!0}),this.isZooming&&this.videoPlayer.lockControls(!1)}))};if(O){i.then(()=>{s.readyState<s.HAVE_FUTURE_DATA&&F.attach(M,!0)});const e=()=>{s.addEventListener("canplay",()=>{F.detach(),s.parentElement.classList.remove("is-buffering")},{once:!0})};s.addEventListener("waiting",()=>{const t=s.networkState===s.NETWORK_LOADING,i=s.readyState<s.HAVE_FUTURE_DATA;t&&i&&(e(),F.attach(M,!0),s.parentElement.classList.add("is-buffering"))}),this.wholeDiv.classList.contains("no-forwards")&&s.addEventListener("contextmenu",e=>{Object(f.a)(e)}),e()}this.lazyLoadQueue.unshift({load:()=>{u||(h=st.getCacheContext(e));const o=O?Promise.resolve():es.downloadDoc(e);return O||i.then(()=>{h.url||F.attach(M,!0,o)}),Promise.all([o,i]).then(()=>{if(this.tempId!==S)return void this.log.warn("media viewer changed video");if(t){const e=yi.setSingleMedia(s,l);this.addEventListener("setMoverBefore",()=>{e()},{once:!0})}const e=h.url;s.addEventListener("error",e=>{$t({langPackKey:C.IS_MOBILE?"Video.Unsupported.Mobile":"Video.Unsupported.Desktop"}),4!==s.error.code&&this.log.error("Error "+s.error.code+"; details: "+s.error.message),null==F||F.detach()},{once:!0}),n instanceof SVGSVGElement?a.firstElementChild.lastElementChild.append(s):u?"broadcasting"===h.type?s.canPlayType("application/vnd.apple.mpegurl")?Xe(s,e):ea.a.isSupported()&&(this.liveHls=new ea.a,this.liveHls.loadSource(p),this.liveHls.attachMedia(s)):"archived"===h.type?Xe(s,e):"ended"===h.type||Xe(s,e):Xe(s,e),this.updateMediaSource(n,e,"video"),r()}),o}})});D=k.then(a)}else{const t=()=>this.setMoverToTarget(n,!1,i).then(({onAnimationEnd:t})=>{this.lazyLoadQueue.unshift({load:()=>{const s=st.getCacheContext(e,T.type),i=v?es.downloadDoc(e):Dt.preloadPhoto(e,T);return t.then(()=>{s.url||this.preloader.attachPromise(i)}),Promise.all([t,i]).then(()=>{var e;if(this.tempId!==S)return void this.log.warn("media viewer changed photo");const t=s.url;if(n instanceof SVGSVGElement){if(this.updateMediaSource(n,t,"img"),this.updateMediaSource(M,t,"img"),I.b.isMobile){const e=M.querySelectorAll("img");e&&e.length&&e.forEach(e=>{e.classList.remove("thumbnail")})}}else{const s=M.firstElementChild&&M.firstElementChild.classList.contains("media-viewer-aspecter")?M.firstElementChild:M,i="IMG"===(null===(e=s.firstElementChild)||void 0===e?void 0:e.tagName)?s.firstElementChild:null;if(!i||i.src!==t){let e=new Image;e.classList.add("thumbnail"),Xe(e,t,()=>{this.updateMediaSource(n,t,"img"),i&&Object(g.b)(()=>{i.remove()}),s.append(e)})}}}).catch(e=>{this.log.error(e),this.preloader.attach(M),this.preloader.setManual()}),i}})});D=k.then(t)}return this.setMoverPromise=D.catch(()=>{this.setMoverAnimationPromise=null}).finally(()=>{this.setMoverPromise=null})}))}}class na{constructor(e,t){let s,i,n=[];s="Eitaa.EditProfile.Photo.Title",i="Eitaa.EditProfile.Photo.Description";n.push({langKey:"Delete",callback:()=>{t&&t(),Ts.deleteProfilePhoto(e)}});new en("popup-delete-profile-photo",{peerId:H.default.myId,titleLangKey:"Eitaa.EditProfile.Photo.Title",descriptionLangKey:"Eitaa.EditProfile.Photo.Description",buttons:n}).show()}}var aa=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class oa extends ia{constructor(e){super(new Un({peerId:e}),e===H.default.myId?["delete"]:[]),this.onPrevClick=e=>{this.openMedia(e.photoId,e.element,-1)},this.onNextClick=e=>{this.openMedia(e.photoId,e.element,1)},this.onDownloadClick=()=>{Dt.savePhotoFile(Dt.getPhoto(this.target.photoId),Pd.chat.bubbles.lazyLoadQueue.queueId)},this.onDeleteProfilePhoto=()=>{const e=this.target.photoId;new na(String(e),()=>{this.close()})},this.peerId=e,this.canDeleteAvatar=this.peerId===H.default.myId;const t=[{icon:"download",text:"MediaViewer.Context.Download",onClick:this.onDownloadClick}];this.canDeleteAvatar&&t.push({icon:"delete danger",text:"Delete",onClick:this.onDeleteProfilePhoto}),this.setBtnMenuToggle(t),this.setListeners()}setListeners(){super.setListeners(),this.canDeleteAvatar&&this.buttons.delete.addEventListener("click",this.onDeleteProfilePhoto)}openMedia(e,t,s=0,i,n){const a=Object.create(null,{_openMedia:{get:()=>super._openMedia}});return aa(this,void 0,void 0,(function*(){if(this.setMoverPromise)return this.setMoverPromise;const o=Dt.getPhoto(e),r=a._openMedia.call(this,o,o.date,this.peerId,s,t,!1,i,n);return this.target.photoId=o.id,r}))}}var ra=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class la{constructor(e){this.scrollable=e,this.loadCallbacks=new Map,this.processedPhotoIds=new Set,this.itemToElementMap=new Map,this.processItem=e=>{if(!e)return e;if(this.itemToElementMap.has(e))return e;let t,s;if("object"==typeof e?(s=e.action.photo,t=String((null==s?void 0:s.id)||e.id)):(s=Dt.getPhoto(e),t=String(e)),this.processedPhotoIds.has(t))return null;this.processedPhotoIds.add(t);const i=document.createElement("div");i.classList.add(la.BASE_CLASS+"-avatar","media-container");const n=new Image;n.classList.add("avatar-photo"),n.draggable=!1;const a=()=>{if(this.peerId.isUser()&&s){if(s)try{const e=Oa({container:i,photo:s,size:Dt.choosePhotoSize(s,420,420,!1),withoutPreloader:!0});[e.images.thumb,e.images.full].filter(Boolean).forEach(e=>{e.classList.add("avatar-photo"),e.draggable=!1})}catch(e){const t=Te.getPeerPhoto(this.peerId);i.appendChild(n),jt.putAvatar(i,this.peerId,t,"photo_big",n)}}else{const e=Te.getPeerPhoto(this.peerId);e&&(i.appendChild(n),jt.putAvatar(i,this.peerId,e,"photo_big",n))}};return this.avatars.childElementCount<=3?a():(this.intersectionObserver.observe(i),this.loadCallbacks.set(i,a)),this.avatars.append(i),this.itemToElementMap.set(e,i),this.addTab(),e},this.container=document.createElement("div"),this.container.classList.add(la.BASE_CLASS+"-container"),this.avatars=document.createElement("div"),this.avatars.classList.add(la.BASE_CLASS+"-avatars"),this.gradient=document.createElement("div"),this.gradient.classList.add(la.BASE_CLASS+"-gradient"),this.info=document.createElement("div"),this.info.classList.add(la.BASE_CLASS+"-info"),this.tabs=document.createElement("div"),this.tabs.classList.add(la.BASE_CLASS+"-tabs"),this.arrowPrevious=document.createElement("div"),this.arrowPrevious.classList.add(la.BASE_CLASS+"-arrow","tgico-avatarprevious"),this.arrowNext=document.createElement("div"),this.arrowNext.classList.add(la.BASE_CLASS+"-arrow",la.BASE_CLASS+"-arrow-next","tgico-avatarnext"),this.container.append(this.avatars,this.gradient,this.info,this.tabs,this.arrowPrevious,this.arrowNext);const t=()=>0===this.scrollable.scrollTop||(this.scrollable.scrollIntoViewNew(this.scrollable.container.firstElementChild,"start"),!1);let s=!1,i=!1;Object(v.b)(this.container,e=>ra(this,void 0,void 0,(function*(){var n;if(i)return void Object(f.a)(e);if(s)return void(s=!1);if(!t())return;const a=this.container.getBoundingClientRect(),o=e.pageX,r=o-a.left;if(!(this.avatars.children.length>1)||r>a.width*(1/3)&&r<a.width-a.width*(1/3)){const e=this.peerId,t=this.listLoader.previous.concat(this.listLoader.current,this.listLoader.next),s=[];for(const e of t)if(e&&this.itemToElementMap.has(e)){const t=this.itemToElementMap.get(e);s.push({element:t,item:e})}let a=this.listLoader.current;if(!a&&!e.isUser()){const t=Te.getPeerPhoto(e);t&&"chatPhoto"===t._&&(a=js.generateFakeAvatarMessage(e,t),this.listLoader.current=a)}let o=-1;if(a&&(o=s.findIndex(e=>e.item===a)),-1===o&&a&&this.itemToElementMap.has(a)){const e=this.itemToElementMap.get(a);s.push({element:e,item:a}),o=s.length-1}-1===o&&s.length>0&&(o=0,a=s[0].item);const r=s.slice(0,o),l=s.slice(o+1),d=null===(n=s[o])||void 0===n?void 0:n.element;if(d&&a){i=!0;try{if(e.isUser()){const t=e=>{if("string"==typeof e||"number"==typeof e)return e;const t=e;return t.action&&"photo"in t.action?t.action.photo.id:null},s=t(a);if(!s)return console.error("[PeerProfileAvatars] Cannot get photoId from currentItem:",a),void(i=!1);const n=e=>e.map(e=>{const s=t(e.item);return{element:e.element,photoId:s}}).filter(e=>e.photoId);new oa(e).openMedia(s,d,0,r?n(r):void 0,l?n(l):void 0)}else yield Td(d,e,()=>e===this.peerId,a,r,l)}catch(e){console.error("[PeerProfileAvatars] Error opening avatar viewer:",e)}i=!1}else console.error("[PeerProfileAvatars] Cannot open viewer - missing target or currentItem"),console.error("[PeerProfileAvatars] target:",d),console.error("[PeerProfileAvatars] currentItem:",a)}else{const e=o>a.right-a.width/2;let t;this.avatars.classList.add("no-transition"),this.avatars.offsetLeft,t=0!==this.listLoader.index||e?this.listLoader.index===this.listLoader.count&&e?-this.listLoader.count:e?1:-1:this.listLoader.count,this.listLoader.go(t),Object(g.b)(()=>{this.avatars.classList.remove("no-transition")})}})));const n=()=>{s=!0,document.body.addEventListener(Ht.IS_TOUCH_SUPPORTED?"touchend":"click",e=>{s=!1},{once:!0})};let a=0,o=0,r=0,l=0;new $n({element:this.avatars,onSwipe:(e,t)=>{r=e;let s=o+e*-la.SCALE;return s>0?s=0:s<l&&(s=l),this.avatars.style.transform=la.TRANSLATE_TEMPLATE.replace("{x}",s+"px"),!1},verifyTouchTarget:e=>t()?!this.container.classList.contains("is-single")&&!i:(n(),Object(f.a)(e),!1),onFirstSwipe:()=>{const e=this.avatars.getBoundingClientRect();a=e.width,l=-a*(this.tabs.childElementCount-1),o=e.left-this.container.getBoundingClientRect().left,this.avatars.style.transform=la.TRANSLATE_TEMPLATE.replace("{x}",o+"px"),this.container.classList.add("is-swiping"),this.avatars.classList.add("no-transition"),this.avatars.offsetLeft},onReset:()=>{const e=Math.ceil(Math.abs(r)/(a/la.SCALE))*(r>=0?1:-1);n(),this.avatars.classList.remove("no-transition"),Object(g.b)(()=>{this.listLoader.go(e),this.container.classList.remove("is-swiping")})}});this.intersectionObserver=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&this.loadNearestToTarget(e.target)})})}setPeer(e){this.peerId=e,this.processedPhotoIds.clear(),this.itemToElementMap.clear(),Dt.filteredPhotos=[];const t=Te.getPeerPhoto(e);if(!t)return;e.isUser()||"chatPhoto"!==t._||(Dt.filteredPhotos=[t.photo_id]);const s=this.listLoader=new Ns({loadCount:50,loadMore:(t,i,n)=>{var a,o,r;if(!i)return Promise.resolve({count:void 0,items:[]});if(e.isUser()){const i=t||s.current;return Dt.getUserPhotos(e,i,n).then(e=>({count:e.count,items:e.photos}))}{const t=[];return(!s.current||"chatPhoto"===(null===(r=null===(o=null===(a=s.current)||void 0===a?void 0:a.action)||void 0===o?void 0:o.photo)||void 0===r?void 0:r._))&&t.push(Ts.getChatFull(e.toChatId())),t.push(js.getSearch({peerId:e,maxId:Number.MAX_SAFE_INTEGER,inputFilter:{_:"inputMessagesFilterChatPhotos"},limit:n,backLimit:0})),Promise.all(t).then(e=>{const t=e.pop();Us(t);const i=e[0];if(i&&i.chat_photo){const e=t.history.findAndSplice(e=>e.action.photo.id===i.chat_photo.id)||js.generateFakeAvatarMessage(this.peerId,i.chat_photo);if(s.current&&s.current!==e){const t=this.itemToElementMap.get(s.current);t&&(this.itemToElementMap.delete(s.current),this.itemToElementMap.set(e,t))}s.current=e}return{count:t.count,items:t.history}})}},processItem:this.processItem,onJump:(e,t)=>{const s=this.listLoader.index,i=this.avatars.children.length-1;if(s<0||s>i)return;const n=-100*la.SCALE*s;this.avatars.style.transform=la.TRANSLATE_TEMPLATE.replace("{x}",n+"%");const a=this.tabs.querySelector(".active");a&&a.classList.remove("active");const o=this.tabs.children[s];o&&o.classList.add("active");const r=this.avatars.children[s];r&&this.loadNearestToTarget(r)}});"userProfilePhoto"===t._?(s.current=t.photo_id,s.load(!0).then(()=>{this.ensureCurrentPhotoFirst(t.photo_id)}).catch(e=>{console.error("[PeerProfileAvatars] setPeer - listLoader.load() error:",e)})):e.isUser()||"chatPhoto"!==t._||Ts.getChatFull(e.toChatId()).then(e=>{if(null==e?void 0:e.chat_photo){const t=js.generateFakeAvatarMessage(this.peerId,e.chat_photo);s.current=t,this.processItem(t),s.load(!0).then(()=>{this.ensureGroupChannelSetup()}).catch(e=>{console.error("[PeerProfileAvatars] setPeer - listLoader.load() error:",e)})}else{console.warn("[PeerProfileAvatars] setPeer - no chat_photo in chatFull, falling back to ChatPhoto");const e=js.generateFakeAvatarMessage(this.peerId,t);s.current=e,this.processItem(e)}}).catch(e=>{console.error("[PeerProfileAvatars] setPeer - getChatFull error:",e);const i=js.generateFakeAvatarMessage(this.peerId,t);s.current=i,this.processItem(i)})}ensureCurrentPhotoFirst(e){if(0===this.avatars.children.length)return void this.processItem(e);let t=!1,s=-1;for(let i=0;i<this.listLoader.previous.length+this.listLoader.next.length+1;i++){let n;if(i<this.listLoader.previous.length){const e=this.listLoader.previous[i];n=String("object"==typeof e?e.action.photo.id:e)}else if(i===this.listLoader.previous.length){const e=this.listLoader.current;n=String("object"==typeof e?e.action.photo.id:e)}else{const e=this.listLoader.next[i-this.listLoader.previous.length-1];n=String("object"==typeof e?e.action.photo.id:e)}if(n===String(e)){t=!0,s=i;break}}if(t)s!==this.listLoader.previous.length&&this.repositionCurrentPhoto(s);else{this.processedPhotoIds.has(String(e))&&this.processedPhotoIds.delete(String(e));this.processItem(e)&&this.avatars.children.length>1&&(this.avatars.insertBefore(this.avatars.lastElementChild,this.avatars.firstElementChild),this.tabs.children.length>1&&this.tabs.insertBefore(this.tabs.lastElementChild,this.tabs.firstElementChild)),this.listLoader.previous.length>0?this.listLoader.current=this.listLoader.previous.shift():this.listLoader.current=e}const i=this.tabs.querySelector(".active");i&&i.classList.remove("active"),this.tabs.children[0]&&this.tabs.children[0].classList.add("active")}repositionCurrentPhoto(e){const t=this.listLoader.previous.length;if(e===t)return;const s=this.avatars.children[e],i=this.tabs.children[e],n=this.avatars.children[t],a=this.tabs.children[t];if(s&&n&&this.avatars.insertBefore(s,n),i&&a&&this.tabs.insertBefore(i,a),e<t){const t=this.listLoader.previous.splice(e,1)[0];this.listLoader.previous.push(this.listLoader.current),this.listLoader.current=t}else{const s=this.listLoader.next.splice(e-t-1,1)[0];this.listLoader.next.unshift(this.listLoader.current),this.listLoader.current=s}}ensureGroupChannelSetup(){if(!this.listLoader.current){const e=Te.getPeerPhoto(this.peerId);if(e&&"chatPhoto"===e._){const t=js.generateFakeAvatarMessage(this.peerId,e);this.listLoader.current=t}}0===this.avatars.children.length&&this.listLoader.current&&this.processItem(this.listLoader.current);!this.tabs.querySelector(".active")&&this.tabs.children[0]&&this.tabs.children[0].classList.add("active")}addTab(){const e=document.createElement("div");e.classList.add(la.BASE_CLASS+"-tab"),this.tabs.append(e),1===this.tabs.childElementCount&&e.classList.add("active"),this.container.classList.toggle("is-single",this.tabs.childElementCount<=1)}loadNearestToTarget(e){if(!e||!e.parentElement)return;const t=Array.from(e.parentElement.children),s=t.indexOf(e);if(-1===s)return;t.slice(Math.max(0,s-3),Math.min(t.length,s+3)).forEach(e=>{const t=this.loadCallbacks.get(e);t&&(t(),this.loadCallbacks.delete(e),this.intersectionObserver.unobserve(e))})}}la.BASE_CLASS="profile-avatars",la.SCALE=Rn?2:1,la.TRANSLATE_TEMPLATE=Rn?`translate3d({x}, 0, -1px) scale(${la.SCALE})`:"translate({x}, 0)";let da=(e,t)=>{Object(xe.a)(t.title,e||""),t.container.style.display=e?"":"none"};class ca{constructor(e,t,s=!0){this.scrollable=e,this.listenerSetter=t,this.isDialog=s,this.setPeerStatus=(e=!1)=>{if(!this.peerId)return;const t=this.peerId;Pd.setPeerStatus(this.peerId,this.subtitle,e,!0,()=>t===this.peerId,!this.isDialog)},Rn||this.scrollable.container.classList.add("no-parallax"),t||(this.listenerSetter=new Gs)}init(){this.init=null,this.element=document.createElement("div"),this.element.classList.add("profile-content"),this.section=new fr({noDelimiter:!0}),this.avatar=new Od,this.avatar.classList.add("profile-avatar","avatar-120"),this.avatar.setAttribute("dialog",""+ +this.isDialog),this.avatar.setAttribute("clickable",""),this.name=document.createElement("div"),this.name.classList.add("profile-name"),this.subtitle=document.createElement("div"),this.subtitle.classList.add("profile-subtitle"),this.bio=new Qi({title:" ",subtitleLangKey:"UserBio",icon:"info",clickable:e=>{"A"!==e.target.tagName&&Ts.getProfileByPeerId(this.peerId).then(e=>{Yi(e.about),Qt(O.default.format("BioCopied",!0))})}}),this.bio.title.classList.add("pre-wrap"),this.username=new Qi({title:" ",subtitleLangKey:"Username",icon:"username",clickable:()=>{Yi("@"+Te.getPeer(this.peerId).username),Qt(O.default.format("UsernameCopied",!0))}}),this.phone=new Qi({title:" ",subtitleLangKey:"Phone",icon:"phone",clickable:()=>{Yi("+"+ye.getUser(this.peerId).phone),Qt(O.default.format("PhoneCopied",!0))}}),this.link=new Qi({title:" ",subtitleLangKey:"SetUrlPlaceholder",icon:"link",clickable:()=>{Promise.resolve(Ts.getChatFull(this.peerId.toChatId())).then(e=>{Yi(e.exported_invite.link),Qt(O.default.format("LinkCopied",!0))})}}),this.section.content.append(this.phone.container,this.username.container,this.bio.container,this.link.container);const{listenerSetter:e}=this;this.isDialog&&(this.notifications=new Qi({checkboxField:new Gi.a({toggle:!0}),titleLangKey:"Notifications",icon:"unmute"}),e.add(this.notifications.checkboxField.input)("change",e=>{e.isTrusted&&js.mutePeer(this.peerId)}),e.add(H.default)("dialog_notify_settings",e=>{if(this.peerId===e.peerId){const e=Cs.isPeerLocalMuted(this.peerId,!1);this.notifications.checkboxField.checked=!e}}),this.section.content.append(this.notifications.container)),this.element.append(this.section.container),Rn&&this.element.append(br()),e.add(H.default)("peer_typings",({peerId:e})=>{this.peerId===e&&this.setPeerStatus()}),e.add(H.default)("peer_bio_edit",e=>{e===this.peerId&&this.setMoreDetails(!0)}),e.add(H.default)("user_update",e=>{this.peerId===e.toPeerId()&&this.setPeerStatus()}),e.add(H.default)("contacts_update",e=>{if(this.peerId===e.toPeerId()){const t=ye.getUser(e);t.pFlags.self||(t.phone?da(ye.formatUserPhone(t.phone),this.phone):this.phone.container.style.display="none")}}),this.setPeerStatusInterval=window.setInterval(this.setPeerStatus,6e4)}cleanupHTML(){[this.bio,this.phone,this.username,this.link].forEach(e=>{e.container.style.display="none"}),this.notifications&&(this.notifications.container.style.display="",this.notifications.checkboxField.checked=!0),this.setMoreDetailsTimeout&&(window.clearTimeout(this.setMoreDetailsTimeout),this.setMoreDetailsTimeout=0)}canBeDetailed(){return this.peerId!==H.default.myId||!this.isDialog}setAvatar(){if(this.canBeDetailed()){if(Te.getPeerPhoto(this.peerId)){const e=this.avatars;return this.avatars=new la(this.scrollable),this.avatars.setPeer(this.peerId),this.avatars.info.append(this.name,this.subtitle),this.avatar.remove(),e?e.container.replaceWith(this.avatars.container):this.element.prepend(this.avatars.container),void(Rn&&this.scrollable.container.classList.add("parallax"))}}Rn&&this.scrollable.container.classList.remove("parallax"),this.avatars&&(this.avatars.container.remove(),this.avatars=void 0),this.avatar.setAttribute("peer",""+this.peerId),this.section.content.prepend(this.avatar,this.name,this.subtitle)}fillProfileElements(){var e;if(!this.cleaned)return;this.cleaned=!1;const t=this.peerId;if(this.cleanupHTML(),this.setAvatar(),this.canBeDetailed()){if(Te.getPeerUsername(t)&&da(Te.getPeerUsername(t),this.username),this.notifications){const e=Cs.isPeerLocalMuted(t,!1);this.notifications.checkboxField.checked=!e}}else this.notifications&&Object(g.b)(()=>{this.notifications.container.style.display="none"});if(t.isUser()){let e=ye.getUser(t);e.phone&&this.canBeDetailed()&&da(ye.formatUserPhone(e.phone),this.phone)}this.setMoreDetails(),Object(le.a)(this.name,new Oe({peerId:t,dialog:this.isDialog}).element);const s=Te.getPeer(t);(null===(e=null==s?void 0:s.pFlags)||void 0===e?void 0:e.verified)&&this.name.append(Bn()),this.setPeerStatus(!0)}setMoreDetails(e){this.setMoreDetailsTimeout&&(window.clearTimeout(this.setMoreDetailsTimeout),this.setMoreDetailsTimeout=0);const t=this.peerId,s=this.threadId;if(!t||Te.isRestricted(t)||!this.canBeDetailed())return;let i;i=t.isUser()?Ts.getProfile(t,e).then(e=>this.peerId===t&&this.threadId===s&&(e.rAbout&&t!==H.default.myId&&da(e.rAbout,this.bio),!0)):Ts.getChatFull(t.toChatId(),e).then(e=>{var i,n,a;return this.peerId===t&&this.threadId===s&&!Te.isRestricted(t)&&(e.about&&da(N.b.wrapRichText(e.about),this.bio),"channelLocation"==(null===(n=null===(i=e)||void 0===i?void 0:i.location)||void 0===n?void 0:n._)&&"channelLocation"==(null===(a=null==e?void 0:e.location)||void 0===a?void 0:a._)&&da(e.location.address,this.location),!0)}),i.then(e=>{e&&(this.setMoreDetailsTimeout=window.setTimeout(()=>this.setMoreDetails(!0),6e4))})}setPeer(e,t=0){this.peerId===e&&this.threadId===t||(this.init&&this.init(),this.peerId=e,this.threadId=t,this.cleaned=!0)}}class ha extends Ys{constructor(e){super(e,!1),this.threadId=0,this.historiesStorage={}}init(){this.container.classList.add("shared-media-container","profile-container");const e=Object(Ks.a)("btn-icon sidebar-close-button",{noRipple:!0});this.closeBtn.replaceWith(e),this.closeBtn=e;const t=document.createElement("div");t.classList.add("animated-close-icon"),e.append(t);const s=document.createElement("div");s.className="transition slide-fade";const i=document.createElement("div");i.classList.add("transition-item"),this.title.append(Object(O.i18n)("Profile")),this.editBtn=Qs("edit"),i.append(this.title,this.editBtn);const n=document.createElement("div");n.classList.add("transition-item");const a=this.title.cloneNode();a.append(Object(O.i18n)("PeerInfo.SharedMedia")),n.append(a),s.append(i,n),this.header.append(s),this.profile=new ca(this.scrollable),this.profile.init(),this.scrollable.append(this.profile.element);this.scrollable.onAdditionalScroll=()=>{const e=this.searchSuper.nav.getBoundingClientRect();if(!e.width)return;const s=e.top-1<=56;t.classList.toggle("state-back",s),this.searchSuper.container.classList.toggle("is-full-viewport",s),o(+s),s||this.searchSuper.cleanScrollPositions()};const o=Object(Vs.a)(s,"slide-fade",400,null,!1);o(0),Object(v.b)(this.closeBtn,e=>{this.closeBtn.firstElementChild.classList.contains("state-back")?(this.scrollable.scrollIntoViewNew(this.scrollable.container.firstElementChild,"start"),o(0),t.classList.remove("state-back")):this.scrollable.isHeavyAnimationInProgress||this.slider.onCloseBtnClick()}),Object(v.b)(this.editBtn,e=>{let t;t=this.peerId.isAnyChat()?new Dn(this.slider):new jn(this.slider),t&&(t instanceof Dn?t.chatId=this.peerId.toChatId():t.peerId=this.peerId,t.open())}),H.default.addEventListener("contacts_update",e=>{this.peerId===e&&this.toggleEditBtn()}),H.default.addEventListener("chat_update",e=>{this.peerId===e.toPeerId(!0)&&this.toggleEditBtn()}),H.default.addEventListener("history_multiappend",e=>{for(const t in e)this.renderNewMessages(t.toPeerId(),Array.from(e[t]))}),H.default.addEventListener("history_delete",({peerId:e,msgs:t})=>{this.deleteDeletedMessages(e,Array.from(t))}),H.default.addEventListener("message_sent",({message:e})=>{this.renderNewMessages(e.peerId,[e.mid])}),this.searchSuper=new ao({mediaTabs:[{inputFilter:"inputMessagesFilterEmpty",name:"PeerMedia.Members",type:"members"},{inputFilter:"inputMessagesFilterPhotoVideo",name:"SharedMediaTab2",type:"media"},{inputFilter:"inputMessagesFilterDocument",name:"SharedFilesTab2",type:"files"},{inputFilter:"inputMessagesFilterUrl",name:"SharedLinksTab2",type:"links"},{inputFilter:"inputMessagesFilterMusic",name:"SharedMusicTab2",type:"music"},{inputFilter:"inputMessagesFilterRoundVoice",name:"SharedVoiceTab2",type:"voice"}],scrollable:this.scrollable,onChangeTab:e=>{let t="members"===e.type&&H.default.settings.animationsEnabled?250:0;setTimeout(()=>{r.classList.toggle("is-hidden","members"!==e.type)},t)}}),this.profile.element.append(this.searchSuper.container);const r=li({icon:"addmember_filled"});this.content.append(r),r.addEventListener("click",()=>{const e=this.peerId,t=this.peerId.toChatId(),s=Pe.isChannel(t),i=Pe.isBroadcast(t),n=(t,i)=>{let n,a,o,r,l;if(t.length>1){n="AddMembersAlertTitle",a=[Object(O.i18n)("Members",[t.length])],o="AddMembersAlertNamesText";const e=document.createElement("b");e.append(new Oe({peerId:t[0]}).element);const i=t.length;r=[e,String(i-1)],s||(l=[{text:"AddMembersForwardMessages",checked:!0}])}else{n="AddOneMemberAlertTitle",o="AddMembersAlertCountText";const e=document.createElement("b");e.append(new Oe({peerId:t[0]}).element),r=[e],s||(l=[{text:"AddOneMemberForwardMessages",textArgs:[new Oe({peerId:t[0]}).element],checked:!0}])}r.push(new Oe({peerId:e}).element),new en("popup-add-members",{peerId:e,titleLangKey:n,descriptionLangKey:o,descriptionLangArgs:r,buttons:[{langKey:"Add",callback:i}],checkboxes:l}).show()},a=e=>{"USER_PRIVACY_RESTRICTED"===e.type?$t(i?{langPackKey:"InviteToChannelError",timeToDisappear:3e3}:{langPackKey:"InviteToGroupError",timeToDisappear:3e3}):"CHANNEL_PRIVATE"===e.type?$t({langPackKey:"InviteToChannelFailed",timeToDisappear:3e3}):"USER_NOT_MUTUAL_CONTACT"===e.type&&$t(i?{langPackKey:"InviteToChannel.Error.MutualContact",timeToDisappear:4e3}:{langPackKey:"InviteToGroup.Error.MutualContact",timeToDisappear:4e3})};if(s){const e=new Pn(this.slider);e.open({type:"channel",skippable:!1,takeOut:s=>(n(s,()=>{const i=Pe.inviteToChannel(t,s);i.catch(a),e.attachToPromise(i)}),!1),title:"GroupAddMembers",placeholder:"SendMessageTo"})}else new un({peerTypes:["contacts"],placeholder:"Search",onSelect:e=>{setTimeout(()=>{n([e],s=>{Pe.addChatUser(t,e,s.size?void 0:0).catch(a)})},0)}})})}renderNewMessages(e,t){if(!this.init&&this.historiesStorage[e]){t=t.slice().reverse();for(const s of this.searchSuper.mediaTabs){const i=s.inputFilter,n=this.searchSuper.filterMessagesByType(t.map(t=>js.getMessageByPeer(e,t)),i);if(n.length){const t=this.historiesStorage[e][i];t&&t.unshift(...n.map(e=>({mid:e.mid,peerId:e.peerId}))),this.peerId===e&&-1!==this.searchSuper.usedFromHistory[i]&&(this.searchSuper.usedFromHistory[i]+=n.length,this.searchSuper.performSearchResult(n,s,!1))}}}}deleteDeletedMessages(e,t){if(!this.init&&this.historiesStorage[e]){for(const s of t)for(const t of this.searchSuper.mediaTabs){const i=t.inputFilter,n=this.historiesStorage[e][i];if(!n)continue;const a=n.findIndex(e=>e.mid===s);if(-1!==a){if(n.splice(a,1),this.peerId===e){const t=this.searchSuper.tabs[i].querySelector(`div[data-mid="${s}"][data-peer-id="${e}"]`);t&&(this.searchSuper.selection.isSelecting&&this.searchSuper.selection.toggleByElement(t),t.remove()),this.searchSuper.usedFromHistory[i]>=a+1&&this.searchSuper.usedFromHistory[i]--}break}}this.scrollable.onScroll()}}cleanupHTML(){this.profile.cleanupHTML(),this.editBtn.classList.add("hide"),this.searchSuper.cleanupHTML(!0),this.container.classList.toggle("can-add-members",this.searchSuper.canViewMembers()&&Pe.hasRights(this.peerId.toChatId(),"invite_users"))}setLoadMutex(e){this.searchSuper.loadMutex=e}setPeer(e,t=0){var s;return(this.peerId!==e||this.threadId!==t)&&(this.peerId=e,this.threadId=t,this.peerChanged=!0,this.init&&(this.init(),this.init=null),this.searchSuper.setQuery({peerId:e,historyStorage:null!==(s=this.historiesStorage[e])&&void 0!==s?s:this.historiesStorage[e]={}}),this.profile.setPeer(e,t),!0)}fillProfileElements(){this.peerChanged&&(this.peerChanged=!1,this.cleanupHTML(),this.profile.fillProfileElements(),this.toggleEditBtn())}toggleEditBtn(){let e;e=this.peerId.isUser()?this.peerId!==H.default.myId&&ye.isContact(this.peerId.toUserId()):Pe.hasRights(this.peerId.toChatId(),"edit_chat"),this.editBtn.classList.toggle("hide",!e)}loadSidebarMedia(e,t=!1){this.searchSuper.load(e,t)}onOpenAfterTimeout(){this.scrollable.onScroll()}}const ua=new class extends Zs{constructor(){super({sidebarEl:document.getElementById("column-right"),canHideFirst:!0,navigationType:"right"}),this.isColumnProportionSet=!1,I.b.addEventListener("changeScreen",(e,t)=>{t===I.a.medium&&e!==I.a.mobile&&this.toggleSidebar(!1)}),I.b.addEventListener("resize",()=>{this.setColumnProportion()}),this.sharedMediaTab=new ha(this)}onCloseTab(e,t,s){this.historyTabIds.length||this.toggleSidebar(!1,t),super.onCloseTab(e,t,s)}setColumnProportion(){const e=this.sidebarEl.scrollWidth/this.sidebarEl.previousElementSibling.scrollWidth;document.documentElement.style.setProperty("--right-column-proportion",""+e)}toggleSidebar(e,t){const s=document.body.classList.contains("is-right-column-shown");let i;if(void 0!==e?e?s||(i=!0):s&&(i=!0):i=!0,!i)return Promise.resolve();s||this.historyTabIds.length||this.sharedMediaTab.open(),this.isColumnProportionSet||(this.setColumnProportion(),this.isColumnProportionSet=!0);const n=Pd.selectTab(s?1:2,t);return document.body.classList.toggle("is-right-column-shown",e),n}};j.a.appSidebarRight=ua;var pa=ua;class ga extends Ys{init(){this.container.id="poll-results-container",this.container.classList.add("chatlist-container"),this.resultsDiv=document.createElement("div"),this.resultsDiv.classList.add("poll-results"),this.scrollable.append(this.resultsDiv)}open(e){const t=super.open(),s=Ls.getPoll(e.media.poll.id);this.setTitle(s.poll.pFlags.quiz?"PollResults.Title.Quiz":"PollResults.Title.Poll");const i=document.createElement("h3");i.innerHTML=s.poll.rQuestion;const n=s.results.results.map(e=>e.voters/s.results.total_voters*100);fa(n);const a=document.createDocumentFragment();return s.results.results.forEach((t,i)=>{if(!t.voters)return;const o=document.createElement("hr"),r=s.poll.answers[i],l=document.createElement("div");l.classList.add("poll-results-answer");const d=document.createElement("div");Object(xe.a)(d,N.a.wrapEmojiText(r.text));const c=document.createElement("div");c.innerText=Math.round(n[i])+"%",l.append(d,c);const h=Jd.createChatList();h.classList.add("poll-results-voters"),Jd.setListClickListener(h,()=>{pa.onCloseBtnClick()},void 0,!0),h.style.minHeight=50*Math.min(t.voters,4)+"px",a.append(o,l,h);let u,p=4,g=!1,m=t.voters-4;const f=()=>{g||(g=!0,Ls.getVotes(e,r.option,u,p).then(e=>{e.votes.forEach(e=>{const{dom:t}=Jd.addDialogNew({dialog:e.user_id.toPeerId(!1),container:h,drawStatus:!1,rippleEnabled:!1,meAsSaved:!1,avatarSize:32});t.lastMessageSpan.parentElement.remove()}),u&&(m-=e.votes.length,v.lastElementChild.replaceWith(Object(O.i18n)("PollResults.LoadMore",[Math.min(20,m)]))),u=e.next_offset,p=20,m&&e.votes.length||v.remove()}).finally(()=>{g=!1}))};if(f(),m<=0)return;const v=document.createElement("div");v.classList.add("poll-results-more","show-more","rp-overflow"),v.addEventListener("click",f),Object(ei.ripple)(v);const b=document.createElement("div");b.classList.add("tgico-down"),v.append(b,Object(O.i18n)("PollResults.LoadMore",[Math.min(20,m)])),a.append(v)}),this.resultsDiv.append(i,a),pa.toggleSidebar(!0).then(()=>{}),t}}let ma=0;const fa=e=>{const t=e.reduce((e,t)=>e+Math.round(t),0);if(t>100){const s=t-100,i=e.length;for(let t=0;t<s;++t){let t=-1,s=1;for(let n=0;n<i;++n){let i=e[n]%1;i>=.5&&i<s&&(s=i,t=n)}if(-1===t)return;e[t]-=s}}else if(t<100){const s=100-t,i=e.length;for(let t=0;t<s;++t){let t=-1,s=0;for(let n=0;n<i;++n){let i=e[n]%1;i<.5&&i>s&&(s=i,t=n)}if(-1===t)return;e[t]+=1-s}}};H.default.addEventListener("poll_update",({poll:e,results:t})=>{Array.from(document.querySelectorAll(`poll-element[poll-id="${e.id}"]`)).forEach(s=>{s.isClosed=!!e.pFlags.closed,s.performResults(t,e.chosenIndexes)})}),H.default.addEventListener("peer_changed",()=>{ba&&va(ba,ya,wa)}),I.b.addEventListener("resize",()=>{Sa.setMaxLength(),Sa.resizePolls()}),I.b.addEventListener("changeScreen",()=>{Sa.setMaxLength()});const va=(e,t,s)=>{e.classList.remove("active"),clearTimeout(s),setTimeout(()=>{t(),e.remove(),ba===e&&ya===t&&wa===s&&(ba=ya=null,wa=0)},200)};let ba,ya,wa;class Sa extends HTMLElement{constructor(){super(),this.isClosed=!1,this.isQuiz=!1,this.isRetracted=!1,this.isPublic=!1,this.isMultiple=!1,this.chosenIndexes=[],this.chosingIndexes=[],this.sentVote=!1}static setMaxLength(){const e=mt.windowW<=360?mt.windowW-120:I.b.active.poll.width;this.MAX_LENGTH=e+9+this.MAX_OFFSET+-13.7}static resizePolls(){if(!this.MAX_LENGTH)return;Array.from(document.querySelectorAll("poll-element.is-voted")).forEach(e=>{e.svgLines.forEach((t,s)=>{e.setLineProgress(s,1)})})}render(){ma||(ma=document.getElementById("poll-line").getTotalLength(),Sa.setMaxLength());const e=this.message.media.poll.id,{poll:t,results:s}=Ls.getPoll(e);let i;this.message.pFlags.is_scheduled&&this.classList.add("disable-hover"),t.pFlags&&(this.isPublic=!!t.pFlags.public_voters,this.isQuiz=!!t.pFlags.quiz,this.isClosed=!!t.pFlags.closed,this.isMultiple=!!t.pFlags.multiple_choice,this.isClosed?(i="Chat.Poll.Type.Closed",this.classList.add("is-closed")):i=this.isQuiz?this.isPublic?"Chat.Poll.Type.Quiz":"Chat.Poll.Type.AnonymousQuiz":this.isPublic?"Chat.Poll.Type.Public":"Chat.Poll.Type.Anonymous"),this.classList.toggle("is-multiple",this.isMultiple);const n=this.isMultiple?'<span class="poll-answer-selected tgico-check"></span>':"",a=t.answers.map((e,t)=>`\n        <div class="poll-answer" data-index="${t}">\n          <div class="circle-hover">\n            <div class="animation-ring"></div>\n            <svg class="progress-ring">\n              <circle class="progress-ring__circle" cx="13" cy="13" r="9"></circle>\n            </svg>\n            ${n}\n          </div>\n          <div class="poll-answer-percents"></div>\n          <div class="poll-answer-text">${N.a.wrapEmojiText(e.text)}</div>\n          <svg version="1.1" class="poll-line" style="display: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 485.9 35" xml:space="preserve">\n            <use href="#poll-line"></use>\n          </svg>\n          <span class="poll-answer-selected tgico"></span>\n        </div>\n      `).join("");if(this.innerHTML='\n      <div class="poll-title"></div>\n      <div class="poll-desc">\n        <div class="poll-type"></div>\n        <div class="poll-avatars"></div>\n      </div>\n      '+a,Object(xe.a)(this.firstElementChild,N.a.wrapEmojiText(t.question)),this.descDiv=this.firstElementChild.nextElementSibling,this.typeDiv=this.descDiv.firstElementChild,this.avatarsDiv=this.descDiv.lastElementChild,i&&this.typeDiv.append(Object(O.i18n)(i)),this.isQuiz&&(this.classList.add("is-quiz"),t.close_period&&t.close_date)){const e=document.createElement("div");e.classList.add("poll-time"),this.descDiv.append(e);const s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.classList.add("poll-quiz-timer"),this.quizTimer=s;const i=2,n=7,a=2*Math.PI*n,o=document.createElementNS("http://www.w3.org/2000/svg","circle");o.classList.add("poll-quiz-timer-circle"),o.setAttributeNS(null,"cx","16"),o.setAttributeNS(null,"cy","16"),o.setAttributeNS(null,"r",""+n),o.setAttributeNS(null,"stroke-width",""+i),s.append(o),this.descDiv.append(s);const r=1e3*t.close_period,l=1e3*(t.close_date-U.a.serverTimeOffset);this.quizInterval=window.setInterval(()=>{const t=Date.now(),s=(l-t)/r,i=(l-t)/1e3+1|0;e.innerHTML=String(i).toHHMMSS(),i<=5&&(e.style.color="#ee545c",o.style.stroke="#ee545c"),o.style.strokeDashoffset=a+s*a,o.style.strokeDasharray=`${a} ${a}`,t>=l&&(clearInterval(this.quizInterval),e.innerHTML="",o.style.strokeDashoffset=a,this.quizInterval=0,setTimeout(()=>{Ls.getResults(this.message)},3e3))},1e3)}this.answerDivs=Array.from(this.querySelectorAll(".poll-answer")),this.svgLines=Array.from(this.querySelectorAll(".poll-line")),this.numberDivs=Array.from(this.querySelectorAll(".poll-answer-percents"));const o=document.createElement("div");o.classList.add("poll-footer"),this.viewResults=document.createElement("div"),this.viewResults.className="poll-footer-button poll-view-results hide",this.viewResults.append(Object(O.i18n)("Chat.Poll.ViewResults")),this.votersCountDiv=document.createElement("div"),this.votersCountDiv.className="poll-votes-count",o.append(this.viewResults,this.votersCountDiv),this.append(o),this.viewResults.addEventListener("click",e=>{Object(f.a)(e),pa.isTabExists(ga)||new ga(pa).open(this.message)}),Object(ei.ripple)(this.viewResults),this.isMultiple&&(this.sendVoteBtn=document.createElement("div"),this.sendVoteBtn.classList.add("poll-footer-button","poll-send-vote"),this.sendVoteBtn.append(Object(O.i18n)("Chat.Poll.SubmitVote")),Object(ei.ripple)(this.sendVoteBtn),t.chosenIndexes.length||this.votersCountDiv.classList.add("hide"),Object(v.b)(this.sendVoteBtn,e=>{Object(f.a)(e),this.chosingIndexes.length&&this.sendVotes(this.chosingIndexes).then(()=>{this.chosingIndexes.length=0,this.answerDivs.forEach(e=>{e.classList.remove("is-chosing")})})}),o.append(this.sendVoteBtn));const r=!(t.chosenIndexes.length||this.isClosed);r&&!this.isPublic||this.performResults(s,t.chosenIndexes,!1),r&&(this.setVotersCount(s),Object(v.b)(this,this.clickHandler))}initQuizHint(e){if(e.solution&&e.solution_entities){const t=document.createElement("div");if(t.classList.add("tgico-tip","poll-hint"),this.descDiv.append(t),Object(v.b)(t,s=>{Object(f.a)(s),t.classList.add("active"),((e,t,s)=>{ba&&va(ba,ya,wa);const i=document.createElement("div");i.classList.add("quiz-hint");const n=document.createElement("div");n.classList.add("container","tgico");const a=document.createElement("div");a.classList.add("text"),n.append(a),i.append(n),Object(xe.a)(a,N.a.wrapRichText(e,{entities:t})),Pd.chat.bubbles.bubblesContainer.append(i),i.offsetLeft,i.classList.add("active"),ba=i,ya=s,wa=window.setTimeout(()=>{va(i,s,wa)},Ht.IS_TOUCH_SUPPORTED?5e3:7e3)})(e.solution,e.solution_entities,()=>{t.classList.remove("active")})}),this.sentVote){const s=e.results.find(e=>e.pFlags.correct);s&&!s.pFlags.chosen&&t.click()}}}clickHandler(e){const t=Object(ti.a)(e.target,"poll-answer");if(!t)return;Object(f.a)(e);const s=+t.dataset.index;if(this.isMultiple){t.classList.toggle("is-chosing");const e=this.chosingIndexes.indexOf(s);-1!==e?this.chosingIndexes.splice(e,1):this.chosingIndexes.push(s)}else this.sendVotes([s])}sendVotes(e){if(this.sendVotePromise)return this.sendVotePromise;const t=this.answerDivs.filter((t,s)=>e.includes(s));return t.forEach(e=>{e.classList.add("is-voting")}),this.classList.add("disable-hover"),this.sentVote=!0,this.sendVotePromise=Ls.sendVote(this.message,e).then(()=>{t.forEach(e=>{e.classList.remove("is-voting")}),this.classList.remove("disable-hover")}).catch(()=>{this.sentVote=!1}).finally(()=>{this.sendVotePromise=null})}performResults(e,t,s=!0){var i,n;if(H.default.settings.animationsEnabled||(s=!1),this.isQuiz&&((null===(i=e.results)||void 0===i?void 0:i.length)||this.isClosed)){this.answerDivs.forEach((t,s)=>{t.classList.toggle("is-correct",!!e.results[s].pFlags.correct)}),this.initQuizHint&&(this.initQuizHint(e),this.initQuizHint=null),this.quizInterval&&(clearInterval(this.quizInterval),this.quizInterval=0),(null===(n=this.quizTimer)||void 0===n?void 0:n.parentElement)&&this.quizTimer.remove();const t=this.descDiv.querySelector(".poll-time");t&&t.remove()}if(this.isClosed&&(this.classList.add("is-closed"),Object(le.a)(this.typeDiv,Object(O.i18n)("Chat.Poll.Type.Closed"))),(this.chosenIndexes.length!==t.length||this.isClosed)&&(this.isRetracted=this.chosenIndexes.length&&!t.length,this.chosenIndexes=t.slice(),this.isRetracted?Object(v.b)(this,this.clickHandler):Object(v.c)(this,this.clickHandler)),this.chosenIndexes.length||this.isRetracted||this.isClosed){const t=e.results.map(t=>e.total_voters?t.voters/e.total_voters*100:0);this.classList.toggle("no-transition",!s),s&&Object(p.a)(this,"",!this.isRetracted,340),Object(g.b)(()=>{this.setResults(this.isRetracted?this.percents:t,this.chosenIndexes,s),this.percents=t,this.isRetracted=!1})}if(this.setVotersCount(e),this.isPublic){this.isMultiple||(this.viewResults.classList.toggle("hide",!e.total_voters||!this.chosenIndexes.length),this.votersCountDiv.classList.toggle("hide",!!this.chosenIndexes.length));let t="";e.recent_voters.forEach((e,s)=>{t+=`<avatar-element class="avatar-16 poll-avatar" dialog="0" peer="${e}" ${0===s?"":`style="transform: translateX(-${3*s}px);"`}></avatar-element>`}),this.avatarsDiv.innerHTML=t}if(this.isMultiple){const t=!!this.chosenIndexes.length,s=this.isClosed||t,i=!this.isPublic||!e.total_voters||!t&&!this.isClosed;this.sendVoteBtn.classList.toggle("hide",s),this.viewResults.classList.toggle("hide",i),this.votersCountDiv.classList.toggle("hide",!s||!i)}}setResults(e,t,s){this.svgLines.forEach(e=>e.style.display=""),this.answerDivs.forEach((e,s)=>{e.classList.toggle("is-chosen",t.includes(s))});const i=Math.max(...e);if(this.maxPercents=e.map(e=>e/i),this.isRetracted)this.svgLines.forEach((e,t)=>{this.setLineProgress(t,-1)});else{const e=()=>{this.svgLines.forEach((e,t)=>{this.setLineProgress(t,1)})};s?Object(g.b)(e):e()}let n;e=e.slice(),fa(e);const a=t=>{e.forEach((e,s)=>{const i=n(e,t);this.numberDivs[s].innerText=i+"%"})};if(this.isRetracted)if(n=(e,t)=>Math.round(e/10*t),s)for(let e=9,t=0;e>=0;--e,++t)setTimeout(()=>{a(e)},34*t);else a(0);else if(n=(e,t)=>Math.round(e/10*(t+1)),s)for(let e=0;e<10;++e)setTimeout(()=>{a(e)},34*e);else a(9);if(this.isRetracted){s&&this.classList.add("is-retracting"),this.classList.remove("is-voted");const e=()=>{this.svgLines.forEach(e=>e.style.display="none")};s?setTimeout(()=>{this.classList.remove("is-retracting"),e()},340):e()}else this.classList.add("is-voted")}setVotersCount(e){const t=e.total_voters||0;let s,i=[t];s=this.isClosed?this.isQuiz?t?"Chat.Quiz.TotalVotes":"Chat.Quiz.TotalVotesResultEmpty":t?"Chat.Poll.TotalVotes1":"Chat.Poll.TotalVotesResultEmpty":this.isQuiz?t?"Chat.Quiz.TotalVotes":"Chat.Quiz.TotalVotesEmpty":t?"Chat.Poll.TotalVotes1":"Chat.Poll.TotalVotesEmpty",Object(le.a)(this.votersCountDiv,Object(O.i18n)(s,i))}setLineProgress(e,t){const s=this.svgLines[e];-1===t?(s.style.strokeDasharray="",s.style.strokeDashoffset=""):(s.style.strokeDasharray=t*this.maxPercents[e]*Sa.MAX_LENGTH+", 485.9",s.style.strokeDashoffset=""+t*Sa.MAX_OFFSET)}}Sa.MAX_OFFSET=-46.5,Sa.MAX_LENGTH=0,customElements.define("poll-element",Sa);var Ia=s(185),Ma=s(90),Ca=s(93),Pa=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};const La=new class{constructor(){this.storage=new Ma.a(Ca.a,"stickerSets"),this.getStickerSetPromises={},this.getStickersByEmoticonsPromises={},this.getAnimatedEmojiStickerSet(),H.default.addMultipleEventsListeners({updateNewStickerSet:e=>{this.saveStickerSet(e.stickerset,e.stickerset.set.id),H.default.dispatchEvent("stickers_installed",e.stickerset.set)}}),this.getGreetingStickersTimeout=window.setTimeout(()=>{this.getGreetingStickersTimeout=void 0,this.getGreetingSticker(!0)},5e3)}getGreetingSticker(e=!1){return this.getGreetingStickersTimeout&&(clearTimeout(this.getGreetingStickersTimeout),this.getGreetingStickersTimeout=void 0),this.getGreetingStickersPromise||(this.getGreetingStickersPromise=this.getStickersByEmoticon("ðŸ‘‹â­ï¸",!1).then(e=>{if(!e.length)throw"NO_STICKERS";this.greetingStickers=e.slice(),this.greetingStickers.sort((e,t)=>Math.random()-Math.random())})),this.getGreetingStickersPromise.then(()=>{let t;return e||(t=this.greetingStickers.shift(),this.greetingStickers.push(t)),es.downloadDoc(this.greetingStickers[0]),t})}saveStickers(e){Object(a.e)(e,(t,s)=>{(t=es.saveDoc(t))?e[s]=t:e.splice(s,1)})}getStickerSet(e,t={}){return Pa(this,void 0,void 0,(function*(){const s=e.id;return this.getStickerSetPromises[s]?this.getStickerSetPromises[s]:this.getStickerSetPromises[s]=new Promise(i=>Pa(this,void 0,void 0,(function*(){var n;if(!t.overwrite){const e=yield this.storage.get(s);if(e&&(null===(n=e.documents)||void 0===n?void 0:n.length)&&(Date.now()-e.refreshTime<36e5||t.useCache))return this.saveStickers(e.documents),i(e),void delete this.getStickerSetPromises[s]}try{const n=yield F.a.invokeApi("messages.getStickerSet",{stickerset:this.getStickerSetInput(e)}),a=t.saveById?s:n.set.id;this.saveStickerSet(n,a),i(n)}catch(e){i(null)}delete this.getStickerSetPromises[s]})))}))}getAnimatedEmojiStickerSet(){return this.getStickerSet({id:"emoji"},{saveById:!0})}getRecentStickers(){return Pa(this,void 0,void 0,(function*(){const e=yield F.a.invokeApiHashable("messages.getRecentStickers");return this.saveStickers(e.stickers),e}))}getAnimatedEmojiSticker(e){const t=this.storage.getFromCache("emoji");if(!t||!t.documents)return;e=e.replace(/\ufe0f/g,"").replace(/ðŸ»|ðŸ¼|ðŸ½|ðŸ¾|ðŸ¿/g,"");const s=t.packs.find(t=>t.emoticon===e);return s?es.getDoc(s.documents[0]):void 0}preloadAnimatedEmojiSticker(e,t,s){return this.getAnimatedEmojiStickerSet().then(()=>{const i=this.getAnimatedEmojiSticker(e);if(i)return es.downloadDoc(i).then(vt.d).then(n=>Pa(this,void 0,void 0,(function*(){const a=I.b.active.emojiSticker,o=Object(ui.d)(e),r=yield pi.b.loadAnimationWorker({container:void 0,animationData:n,width:null!=t?t:a.width,height:null!=s?s:a.height},"none",o);r.addEventListener("firstFrame",()=>{es.saveLottiePreview(i,r.canvas,o),r.remove()},{once:!0})})))})}saveStickerSet(e,t){const s={_:"messages.stickerSet",set:e.set,packs:e.packs,documents:e.documents};let i=this.storage.getFromCache(t);i?Object.assign(i,s):i=this.storage.setToCache(t,s),this.saveStickers(e.documents);const n=i.set.installed_date||"emoji"===t;i.refreshTime=Date.now(),this.storage.set({[t]:i},!n)}getStickerSetThumbDownloadOptions(e){var t;const s=e.thumbs.find(e=>"photoSize"===e._),i=e.thumb_dc_id,n=null===(t=e.pFlags)||void 0===t?void 0:t.animated;return{dcId:i,location:{_:"inputStickerSetThumb",stickerset:this.getStickerSetInput(e),thumb_version:e.thumb_version},size:s.size,mimeType:n?"application/x-tgsticker":"image/webp"}}getStickerSetInput(e){return"emoji"===e.id?{_:"inputStickerSetAnimatedEmoji"}:e.access_hash?{_:"inputStickerSetID",id:e.id,access_hash:e.access_hash}:{_:"inputStickerSetShortName",short_name:""+e.id}}getFeaturedStickers(){return Pa(this,void 0,void 0,(function*(){const e=yield F.a.invokeApiHashable("messages.getFeaturedStickers");return e.sets.forEach(e=>{this.saveStickerSet({set:e.set,documents:[],packs:[]},e.set.id)}),e.sets}))}toggleStickerSet(e){return Pa(this,void 0,void 0,(function*(){if(e.installed_date){if(yield F.a.invokeApi("messages.uninstallStickerSet",{stickerset:this.getStickerSetInput(e)}))return delete e.installed_date,H.default.dispatchEvent("stickers_deleted",e),this.storage.delete(e.id,!0),!0}else{if(yield F.a.invokeApi("messages.installStickerSet",{stickerset:this.getStickerSetInput(e),archived:!1}))return e.installed_date=Date.now()/1e3|0,H.default.dispatchEvent("stickers_installed",e),!0}return!1}))}searchStickerSets(e,t=!0){return Pa(this,void 0,void 0,(function*(){const s=t?1:0,i=yield F.a.invokeApiHashable("messages.searchStickerSets",{flags:s,exclude_featured:t||void 0,q:e});i.sets.forEach(e=>{this.saveStickerSet({set:e.set,documents:[],packs:[]},e.set.id)});const n=[],a=this.storage.getCache();for(let t in a){const{set:s}=a[t];s.title.toLowerCase().includes(e.toLowerCase())&&!i.sets.find(e=>e.set.id===s.id)&&n.push({_:"stickerSetCovered",set:s,cover:null})}return i.sets.concat(n)}))}getAllStickers(){return F.a.invokeApiHashable("messages.getAllStickers")}preloadStickerSets(){return this.getAllStickers().then(e=>Promise.all(e.sets.map(e=>this.getStickerSet(e,{useCache:!0}))))}getStickersByEmoticon(e,t=!0){return e=N.b.fixEmoji(e),this.getStickersByEmoticonsPromises[e]?this.getStickersByEmoticonsPromises[e]:this.getStickersByEmoticonsPromises[e]=Promise.all([F.a.invokeApiHashable("messages.getStickers",{emoticon:e}),t?this.preloadStickerSets():[],t?this.getRecentStickers():void 0]).then(([t,s,i])=>{const n=t.stickers.map(e=>es.saveDoc(e)),a=[],o=[],r=t=>{for(const s of t){if(N.b.fixEmoji(s.emoticon).includes(e))for(const e of s.documents){const t=es.getDoc(e);(t.animated?a:o).push(t)}}};if(i){r(i.packs);const e=i.stickers;[a,o].forEach(t=>{t.sort((t,s)=>e.indexOf(t)-e.indexOf(s))})}for(const e of s)r(e.packs);return[...new Set(a.concat(o,n))]})}pushRecentSticker(e){const t=N.b.fixEmoji(e.stickerEmojiRaw);for(const s in this.getStickersByEmoticonsPromises){this.getStickersByEmoticonsPromises[s].then(i=>{const n=i.findAndSplice(t=>t.id===e.id);n?i.unshift(n):s.includes(t)&&i.unshift(e)})}}};j.a.appStickersManager=La;var Ea=La;function _a(e){return e.rank||("channelParticipantAdmin"===e._||"chatParticipantAdmin"===e._?2:"chatParticipantCreator"===e._||"channelParticipantCreator"===e._?1:void 0)}var ka=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};let Ta=0;function xa({doc:e,container:t,message:s,boxWidth:i,boxHeight:n,withTail:a,isOut:o,middleware:r,lazyLoadQueue:l,noInfo:d,group:c,onlyPreview:h,withoutPreloader:u,loadPromises:p,noPlayButton:g,noAutoDownload:m,size:S,searchContext:M}){var P,L;const E=!(i&&n),_=("video"!==e.type||e.size<=52428800&&!E)&&("gif"===e.type?H.default.settings.autoPlay.gifs:H.default.settings.autoPlay.videos);let T,x,A="";if(!d){T=document.createElement("span"),T.classList.add("video-time"),t.append(T);let s=!1;"gif"!==e.type?(e.size&&(A=Object(ds.b)(e.size)+", "),T.innerText=A+(e.duration+"").toHHMMSS(!1),g||"round"===e.type||(_&&!m?T.classList.add("tgico","can-autoplay"):s=!0)):(T.innerText="GIF",_||g||(s=!0,m=void 0)),s&&(x=document.createElement("span"),x.classList.add("video-play","tgico-largeplay","btn-circle","position-center"),t.append(x))}let O,F={};if("image/gif"===e.mime_type){const d=Oa({photo:e,message:s,container:t,boxWidth:i,boxHeight:n,withTail:a,isOut:o,lazyLoadQueue:l,middleware:r,withoutPreloader:u,loadPromises:p,noAutoDownload:m,size:S});return F.thumb=d,F.loadPromise=d.loadPromises.full,F}const D=document.createElement("video");if(D.classList.add("media-video"),D.setAttribute("playsinline","true"),D.muted=!0,"round"===e.type){const i=document.createElement("div");i.classList.add("media-round","z-depth-1"),i.dataset.mid=""+s.mid,i.dataset.peerId=""+s.peerId,i.message=s;const n=I.b.active.round,a=n.width/2,o=3.5,r=a-2*o;i.innerHTML=`<svg class="progress-ring" width="${n.width}" height="${n.width}" style="transform: rotate(-90deg);">\n      <circle class="progress-ring__circle" stroke="white" stroke-opacity="0.3" stroke-width="${o}" cx="${a}" cy="${a}" r="${r}" fill="transparent"/>\n    </svg>`;const l=i.firstElementChild.firstElementChild;Ta||(Ta=2*Math.PI*r),l.style.strokeDasharray=Ta+" "+Ta,l.style.strokeDashoffset=""+Ta,T.classList.add("tgico");s.pFlags.media_unread&&i.classList.add("is-unread");const d=document.createElement("canvas");d.width=d.height=e.w,i.prepend(d,T),i.append(D),t.append(i);const c=d.getContext("2d"),h=()=>{const t=i.message,s=yi.addMedia(t,!m),n=()=>{(Pd.chat.setPeerPromise||Promise.resolve()).finally(()=>{Object(b.a)(s)||(s.removeEventListener("play",h),s.removeEventListener("timeupdate",r),s.removeEventListener("pause",u),s.removeEventListener("ended",p))})},a=()=>{c.drawImage(s,0,0);const e=Ta-s.currentTime/s.duration*Ta;return l.style.strokeDashoffset=""+e,!s.paused},o=()=>{s.duration&&(Object(b.a)(s)?(s.paused&&a(),e.size&&(A=Object(ds.b)(e.size)+", "),T.innerText=A+(s.duration-s.currentTime+"").toHHMMSS(!1)):n())},r=Ti(o),h=()=>{D.classList.add("hide"),i.classList.remove("is-paused"),Object(Ia.b)(a,d),O&&O.preloader&&O.preloader.classList.contains("manual")&&O.onClick()},u=()=>{Object(b.a)(s)?i.classList.add("is-paused"):n()},p=()=>{D.classList.remove("hide"),i.classList.add("is-paused"),D.currentTime=0,e.size&&(A=Object(ds.b)(e.size)+", "),T.innerText=A+(""+s.duration).toHHMMSS(!1),s.currentTime&&(s.currentTime=0)};s.addEventListener("play",h),s.addEventListener("timeupdate",r),s.addEventListener("pause",u),s.addEventListener("ended",p),Object(v.b)(d,e=>{if(Object(f.a)(e),O&&!O.detached&&O.onClick(),s.paused){const e=!!M;if(yi.setSearchContext(M||{peerId:Z.b,inputFilter:{_:"inputMessagesFilterEmpty"},useSearch:!1})){const[s,n]=e?Oi(i):[];yi.setTargets({peerId:t.peerId,mid:t.mid},s,n)}s.play()}else s.pause()}),s.paused?s.duration&&s.currentTime!==s.duration&&s.currentTime>0?(a(),o(),D.classList.add("hide")):u():h()};s.pFlags.is_outgoing?(i.onLoad=h,i.dataset.isOutgoing="1"):h()}else D.autoplay=!0;let j;if(s){if(j=Oa({photo:e,message:s,container:t,boxWidth:i,boxHeight:n,withTail:a,isOut:o,lazyLoadQueue:l,middleware:r,withoutPreloader:!0,loadPromises:p,noAutoDownload:m,size:S}),F.thumb=j,!_&&"gif"!==e.type||h)return F.loadPromise=j.loadPromises.full,F;if(a){const e=(j.images.thumb||j.images.full).parentElement;D.width=+e.getAttributeNS(null,"width"),D.height=+e.getAttributeNS(null,"height"),e.append(D)}}else{const t=es.getThumb(e,!1);t&&t.promise.then(()=>{D.poster=t.cacheContext.url})}!D.parentElement&&t&&((null==j?void 0:j.aspecter)||t).append(D);const R=st.getCacheContext(e),B=!!(null===(P=null==s?void 0:s.media)||void 0===P?void 0:P.preloader);B?(O=s.media.preloader,O.attach(t,!1),m=void 0):R.downloaded||e.supportsStreaming?e.supportsStreaming&&(O=new y({cancelable:!1,attachMethod:"prepend"})):O=new y({attachMethod:"prepend"});const U=Object(w.a)();D.addEventListener("error",e=>{4!==D.error.code&&console.error("Error "+D.error.code+"; details: "+D.error.message),O&&!B&&O.detach(),U.isFulfilled||U.resolve()},{once:!0}),k(D).then(()=>{c&&zs.a.addAnimation(D,c),O&&!B&&O.detach(),U.resolve()}),"video"===e.type&&D.addEventListener("timeupdate",()=>{e.size&&(A=Object(ds.b)(e.size)+", "),T.innerText=A+(D.duration-D.currentTime+"").toHHMMSS(!1)}),D.muted=!0,D.loop=!0,D.autoplay=!0;let N=m&&(null===(L=null==j?void 0:j.preloader)||void 0===L?void 0:L.loadFunc);const z=()=>{O&&m&&!u&&(O.construct(),O.setManual());let i=Promise.resolve();if(O&&!B)if(R.downloaded||e.supportsStreaming)e.supportsStreaming&&(m?i=Promise.reject():R.downloaded||(O.attach(t,!1,null),D.addEventListener(C.IS_SAFARI?"timeupdate":"canplay",()=>{O.detach()},{once:!0})));else{const s=i=es.downloadDoc(e,null==l?void 0:l.queueId,m);O.attach(t,!1,s)}return!m&&N&&(N(),N=null),m=void 0,i.then(()=>{!r||r()?("round"===e.type&&yi.resolveWaitingForLoadMedia(s.peerId,s.mid,s.pFlags.is_scheduled),Xe(D,R.url)):U.resolve()},()=>{}),{download:i,render:U}};return O&&!B&&O.setDownloadFunction(z),"gif"!==e.type||_?F.loadPromise=l?(l.push({div:t,load:()=>z().render}),Promise.resolve()):z().render:Object(v.b)(t,e=>{Object(f.a)(e),x.remove(),z()},{capture:!0,once:!0}),F}function Aa({message:e,withTime:t,fontWeight:s,voiceAsMusic:i,showSender:n,searchContext:a,loadPromises:o,noAutoDownload:r,lazyLoadQueue:l}){var d,c;s||(s=500);const h=e.media.document||e.media.webpage.document,u=e.pFlags.is_outgoing&&(null===(d=e.media)||void 0===d?void 0:d.preloader);if("audio"===h.type||"voice"===h.type||"round"===h.type){const d=new Fi;return d.withTime=t,d.message=e,d.noAutoDownload=r,d.lazyLoadQueue=l,d.loadPromises=o,i&&(d.voiceAsMusic=i),a&&(d.searchContext=a),n&&(d.showSender=n),u&&(d.preloader=e.media.preloader),d.dataset.fontWeight=""+s,d.render(),d}let p=h.file_name?h.file_name.split("."):"",g="";g=p.length>1&&Array.isArray(p)?V(p.pop().split(" ",1)[0].toLowerCase()):"file";let m=document.createElement("div");m.classList.add("document","ext-"+g),m.dataset.docId=""+h.id;const f=document.createElement("div");f.classList.add("document-ico");const b=st.getCacheContext(h);if((null===(c=h.thumbs)||void 0===c?void 0:c.length)||e.pFlags.is_outgoing&&b.url&&"photo"===h.type){m.classList.add("document-with-thumb");let t=[];if(e.pFlags.is_outgoing)f.innerHTML=`<img src="${b.url}">`,t.push(f.firstElementChild);else{const e=Oa({photo:h,message:null,container:f,boxWidth:54,boxHeight:54,loadPromises:o,withoutPreloader:!0,lazyLoadQueue:l,size:Dt.choosePhotoSize(h,54,54,!0)});f.style.width=f.style.height="",e.images.thumb&&t.push(e.images.thumb),e.images.full&&t.push(e.images.full)}t.forEach(e=>e.classList.add("document-thumb"))}else f.innerText=g;let w=h.fileName||"Unknown.file";document.createElement("div").classList.add("document-description");const I=[Object(ds.b)(h.size)];t&&I.push(Object(S.c)(e.date)),n&&I.push(js.wrapSenderToPeer(e)),m.innerHTML=`\n  ${b.downloaded&&!u?"":'<div class="document-download"></div>'}\n  <div class="document-name"></div>\n  <div class="document-size"></div>\n  `;const M=m.querySelector(".document-name"),C=new ys;C.dataset.fontWeight=""+s,C.innerHTML=w,M.append(C),n&&M.append(js.wrapSentTime(e));if(m.querySelector(".document-size").append(...Object(O.joinElementsWith)(I," Â· ")),m.prepend(f),!u&&e.pFlags.is_outgoing)return m;let P,L=null;const E=()=>{if(P){P.classList.add("downloaded");const e=P;setTimeout(()=>{e.remove()},200),P=null}L&&(L=null)},_=e=>{var t;const s=!e||e.isTrusted,i=es.getDoc(m.dataset.docId);let n;const a=Pd.chat.bubbles?Pd.chat.bubbles.lazyLoadQueue.queueId:void 0;return s?"pdf"===i.type?(n=es.downloadDoc(i,a),n.then(()=>{setTimeout(()=>{const e=st.getCacheContext(i).url;window.open(e)},H.default.settings.animationsEnabled?250:0)})):n=Bs.has(i.mime_type)&&(null===(t=i.thumbs)||void 0===t?void 0:t.length)?es.downloadDoc(i,a):es.saveDocFile(i,a):n=es.downloadDoc(i,a),P&&(n.then(E),L.attach(P,!0,n)),{download:n}};return es.downloading.has(h.id)?(P=m.querySelector(".document-download"),L=new y,L.attach(P,!1,es.downloading.get(h.id))):b.downloaded&&!u||(P=m.querySelector(".document-download"),L=e.media.preloader,L?(L.attach(P),e.media.promise.then(E)):(L=new y,L.construct(),L.setManual(),L.attach(P),L.setDownloadFunction(_))),Object(v.b)(m,e=>{L?L.onClick(e):_(e)}),m}function Oa({photo:e,message:t,container:s,boxWidth:i,boxHeight:n,withTail:a,isOut:o,lazyLoadQueue:r,middleware:l,size:d,withoutPreloader:c,loadPromises:h,noAutoDownload:u,noBlur:p,noThumb:g,noFadeIn:m,blurAfter:f}){var v;if(!e.sizes&&!e.thumbs)return i&&n&&!d&&"document"===e._&&Dt.setAttachmentSize(e,s,i,n,void 0,t),{loadPromises:{thumb:Promise.resolve(),full:Promise.resolve()},images:{thumb:null,full:null},preloader:null,aspecter:null};d||(void 0===i&&(i=I.b.active.regular.width),void 0===n&&(n=I.b.active.regular.height)),s.classList.add("media-container");let b,w,S,M=s,C=!0,P=Promise.resolve();const L="document"===e._&&"image/gif"===e.mime_type&&!d;if(w=new Image,i&&n&&!d){const g=Dt.setAttachmentSize(e,s,i,n,void 0,t,void 0,L?{_:"photoSize",w:e.w,h:e.h,size:e.size,type:"full"}:void 0);if(d=g.photoSize,C=g.isFit,S=st.getCacheContext(e,d.type),!C){M=document.createElement("div"),M.classList.add("media-container-aspecter"),M.style.width=g.size.width+"px",M.style.height=g.size.height+"px";const i=Dt.getStrippedThumbIfNeeded(e,S,!p,!0);if(i){P=i.loadPromise;const e=i.image;e.classList.add("media-photo"),s.append(e)}else{Oa({container:s,message:t,photo:e,boxWidth:0,boxHeight:0,size:d,lazyLoadQueue:r,isOut:o,loadPromises:h,middleware:l,withoutPreloader:c,withTail:a,noAutoDownload:u,noBlur:p,noThumb:!0,blurAfter:!0})}s.classList.add("media-container-fitted"),s.append(M)}}else d||(d=Dt.choosePhotoSize(e,i,n,!0));if(b=new Image,S=st.getCacheContext(e,null==d?void 0:d.type),!g){const t=Dt.getStrippedThumbIfNeeded(e,S,!p);t&&(P=Promise.all([P,t.loadPromise]),b=t.image,b.classList.add("media-photo"),M.append(b))}w.classList.add("media-photo");const E=(b||!S.downloaded)&&H.default.settings.animationsEnabled&&!m;let _;(null===(v=null==t?void 0:t.media)||void 0===v?void 0:v.preloader)&&!c?(_=t.media.preloader,_.attach(s),u=void 0):S.downloaded||(_=new y({attachMethod:"prepend"}));const k=e=>Fa(s,w,e,E,M,b),T=()=>l&&!l()?Promise.resolve():f?pt(S.url,12).then(e=>k(e)):k(S.url);let x;const A=d.w>=150&&d.h>=150||u,O=()=>{u&&!c&&_&&(_.construct(),_.setManual());const t=L&&!d?es.downloadDoc(e,null==r?void 0:r.queueId):Dt.preloadPhoto(e,d,null==r?void 0:r.queueId,u);_&&!S.downloaded&&!c&&A&&_.attach(s,!1,t),u=void 0;const i=t.then(T);return i.catch(()=>{}),{download:t,render:i}};return _&&_.setDownloadFunction(O),S.downloaded?P=x=O().render:r?r.push({div:s,load:()=>O().download}):x=O().render,h&&P&&h.push(P),{loadPromises:{thumb:P,full:x||Promise.resolve()},images:{thumb:b,full:w},preloader:_,aspecter:M}}function Fa(e,t,s,i,n=e,a){return i&&t.classList.add("fade-in"),new Promise(o=>{Xe(t,s,()=>{Je.a.mutateElement(e,()=>{n.append(t),Object(g.b)(()=>{o()}),i&&t.addEventListener("animationend",()=>{Je.a.mutate(()=>{t.classList.remove("fade-in"),a&&a.remove()})},{once:!0})})})})}function Da({doc:e,div:t,middleware:s,lazyLoadQueue:i,group:n,play:a,onlyThumb:o,emoji:r,width:l,height:d,withThumb:c,loop:h,loadPromises:u,needFadeIn:p}){var g;const m=e.sticker;if(l||(l=r?void 0:200),d||(d=r?void 0:200),2!==m||pi.b.loaded||pi.b.loadLottieWorkers(),!m)throw console.error("wrong doc for wrapSticker!",e),new Error("wrong doc for wrapSticker!");t.dataset.docId=""+e.id,t.classList.add("media-sticker-wrapper");const b=st.getCacheContext(e),y=r?Object(ui.d)(r):-1,S=b.downloaded&&!p;let I=Object(w.a)(),M=!1;if(((null===(g=e.thumbs)||void 0===g?void 0:g.length)||e.stickerCachedThumbs)&&!t.firstElementChild&&(!S||2===m||o)){let n,a=e.stickerCachedThumbs&&e.stickerCachedThumbs[y]||e.thumbs[0];const r=()=>{t.childElementCount||(n.classList.add("media-sticker","thumbnail"),Je.a.mutateElement(t,()=>{t.append(n),I.resolve()}))};if("url"in a)n=new Image,Xe(n,a.url,r),M=!0;else if("bytes"in a){if("photoPathSize"===a._)if(a.bytes.length){const s=Dt.getPathFromPhotoPathSize(a);t.innerHTML=`<svg class="rlottie-vector media-sticker thumbnail" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 ${e.w||512} ${e.h||512}" xml:space="preserve">\n            <path d="${s}"/>\n          </svg>`}else a=e.thumbs.find(e=>{var t;return null===(t=e.bytes)||void 0===t?void 0:t.length})||a;a&&"photoPathSize"!==a._&&y<=0&&(n=new Image,Fe.a||e.pFlags.stickerThumbConverted||b.url?(Xe(n,Dt.getPreviewURLFromThumb(e,a,!0),r),M=!0):gi.a.convert(""+e.id,a.bytes).then(i=>{a.bytes=i,e.pFlags.stickerThumbConverted=!0,s&&!s()||t.childElementCount||Xe(n,Dt.getPreviewURLFromThumb(e,a,!0),r)}).catch(()=>{}))}else if(2===m&&(c||o)&&y<=0){n=new Image;const l=()=>{if(t.childElementCount||s&&!s())return;const i=()=>{t.childElementCount||s&&!s()||Xe(n,b.url,r)};return b.url?(i(),Promise.resolve()):es.getThumbURL(e,a).promise.then(i)};if(i&&o)return i.push({div:t,load:l}),Promise.resolve();l(),a.url&&(M=!0)}}if(u&&M&&u.push(I),o)return Promise.resolve();const C=()=>ka(this,void 0,void 0,(function*(){if(!s||s())if(2===m)yield es.downloadDoc(e,null==i?void 0:i.queueId).then(vt.d).then(i=>ka(this,void 0,void 0,(function*(){if(s&&!s())return;let o=yield pi.b.loadAnimationWorker({container:t,loop:h&&!r,autoplay:a,animationData:i,width:l,height:d},n,y);o.addEventListener("firstFrame",()=>{const s=t.firstElementChild;p=(p||!s||"svg"===s.tagName)&&H.default.settings.animationsEnabled;const i=()=>{s&&s!==o.canvas&&s.remove()};p?Je.a.mutate(()=>{o.canvas.classList.add("fade-in"),s&&s.classList.add("fade-out"),o.canvas.addEventListener("animationend",()=>{Je.a.mutate(()=>{o.canvas.classList.remove("fade-in"),i()})},{once:!0})}):s&&Je.a.mutate(i),es.saveLottiePreview(e,o.canvas,y)},{once:!0}),r&&Object(v.b)(t,e=>{Object(f.a)(e);let s=pi.b.getAnimation(t);s.paused&&(s.autoplay=!0,s.restart())})})));else if(1===m){const n=new Image,a=t.firstElementChild!==n&&t.firstElementChild;return p=(p||!S||a)&&H.default.settings.animationsEnabled,n.classList.add("media-sticker"),p&&n.classList.add("fade-in"),new Promise((o,r)=>{const l=()=>{if(s&&!s())return o();Xe(n,b.url,()=>{Je.a.mutateElement(t,()=>{t.append(n),a&&a.classList.add("fade-out"),o(),p&&n.addEventListener("animationend",()=>{n.classList.remove("fade-in"),a&&a.remove()},{once:!0})})})};b.url?l():es.downloadDoc(e,null==i?void 0:i.queueId).then(l,o)})}})),P=!i||S&&2!==m?C():(i.push({div:t,load:C}),Promise.resolve());return S&&1===m&&(I=P,u&&u.push(I)),P}function ja(e,t,s){const i=new Ri("reply");return i.fill(e,t,s),i.container}function Ra(e){const t=new Wi(e.items,e.maxWidth,e.minWidth,e.spacing,e.maxHeight).layout(),s=t.find(e=>e.sides&Ni),i=s.geometry.width+s.geometry.x,n=t.find(e=>e.sides&Hi),a=n.geometry.height+n.geometry.y,o=e.container;o.style.width=i+"px",o.style.height=a+"px";const r=o.children;t.forEach(({geometry:t,sides:s},n)=>{let l;if(l=r[n],l||(l=document.createElement("div"),o.append(l)),l.classList.add("album-item","grouped-item"),l.style.width=t.width/i*100+"%",l.style.height=t.height/a*100+"%",l.style.top=t.y/a*100+"%",l.style.left=t.x/i*100+"%",s&zi&&s&Ui&&(l.style.borderTopLeftRadius="inherit"),s&zi&&s&Hi&&(l.style.borderBottomLeftRadius="inherit"),s&Ni&&s&Ui&&(l.style.borderTopRightRadius="inherit"),s&Ni&&s&Hi&&(l.style.borderBottomRightRadius="inherit"),e.forMedia){const e=document.createElement("div");e.classList.add("album-item-media"),l.append(e)}})}function Ba({groupId:e,attachmentDiv:t,middleware:s,uploading:i,lazyLoadQueue:n,isOut:a,chat:o,loadPromises:r,noAutoDownload:l}){const d=[],c=js.getMidsByAlbum(e);for(const e of c){const t=o.getMessage(e),s=t.media.photo||t.media.document,i="photo"===s._?Dt.choosePhotoSize(s,480,480):{w:s.w,h:s.h};d.push({size:i,media:s,message:t})}Ra({container:t,items:d.map(e=>({w:e.size.w,h:e.size.h})),maxWidth:I.b.active.album.width,minWidth:100,spacing:2,forMedia:!0}),d.forEach((e,i)=>{const{size:o,media:d,message:c}=e,h=t.children[i];h.dataset.mid=""+c.mid,h.dataset.peerId=""+c.peerId;const u=h.firstElementChild;"photo"===d._?Oa({photo:d,message:c,container:u,boxWidth:0,boxHeight:0,isOut:a,lazyLoadQueue:n,middleware:s,size:o,loadPromises:r,noAutoDownload:l}):xa({doc:c.media.document,container:u,message:c,boxWidth:0,boxHeight:0,withTail:!1,isOut:a,lazyLoadQueue:n,middleware:s,loadPromises:r,noAutoDownload:l})})}function Ua(e,t){var s,i,n,a,o;if("messageMediaGeo"===(null===(s=null==e?void 0:e.media)||void 0===s?void 0:s._)||"messageMediaGeoLive"===(null===(i=null==e?void 0:e.media)||void 0===i?void 0:i._)||"messageMediaVenue"===(null===(n=null==e?void 0:e.media)||void 0===n?void 0:n._)&&e.media.geo){const s=e.media.geo;if((null==s?void 0:s.lat)&&(null==s?void 0:s.long)){const e=16;let i=`https://neshan.org/maps/@${s.lat},${s.long},${e}.0z,0.0p`;C.IS_ANDROID?i=`geo:${s.lat},${s.long}?z=${e}`:C.IS_APPLE&&(i=`maps:?saddr=Current Location&daddr=${s.lat},${s.long}`);const n=`https://mts0.google.com/vt/lyrs=m&hl=fa&src=app&x=${a=s.long,o=e,Math.floor((a+180)/360*Math.pow(2,o))}&y=${((e,t)=>Math.floor((1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2*Math.pow(2,t)))(s.lat,e)}&z=${e}`;t.classList.add("media-container");const r=I.b.active.regular.width,l=I.b.active.regular.height;let d;t.style.width=r+"px",t.style.height=l+"px",d=new Image,d.src=n,d.classList.add("media-photo");const c=document.createElement("a");c.href=i,c.target="_blank",c.rel="noopener noreferrer",c.append(d),t.append(c)}}}I.b.addEventListener("changeScreen",(e,t)=>{if(t===I.a.mobile||e===I.a.mobile){const e=Array.from(document.querySelectorAll(".media-round .progress-ring")),t=I.b.active.round.width,s=t/2,i=s-7;Ta=2*Math.PI*i,e.forEach(e=>{e.setAttributeNS(null,"width",""+t),e.setAttributeNS(null,"height",""+t);const n=e.firstElementChild;n.setAttributeNS(null,"cx",""+s),n.setAttributeNS(null,"cy",""+s),n.setAttributeNS(null,"r",""+i),n.style.strokeDasharray=Ta+" "+Ta,n.style.strokeDashoffset=""+Ta})}}),H.default.addEventListener("download_start",e=>{Array.from(document.querySelectorAll(`.document[data-doc-id="${e}"]`)).forEach(e=>{e.querySelector(".preloader-container.manual")&&Object(v.e)(e)})});var Na=s(172);function Ha(e,t,s,i){return void 0===i&&(i=e.parentElement===t?Object(Na.a)(e):-1),i!==s&&(-1!==i&&i<s&&(s+=1),s?t.childElementCount>s?t.insertBefore(e,t.children[s]):t.append(e):t.prepend(e),!0)}class za{constructor(e){this.updateElementWith=e=>e(),this.updateListWith=e=>e(!0),this.middleware=Ke(),Object(m.g)(this,e),this.elements=new Map,this.sorted=[]}clear(){this.middleware.clean(),this.elements.clear(),this.sorted.length=0}_updateList(){this.elements.forEach(e=>{this.update(e.id,!0)}),this.onSort&&this.sorted.forEach((e,t)=>{this.onSort(e,t)})}updateList(e){const t=this.middleware.get();this.updateListWith(s=>{if(!t()||void 0!==s&&!s)return e(!1);this._updateList(),e(!0)})}has(e){return this.elements.has(e)}get(e){return this.elements.get(e)}getAll(){return this.elements}add(e,t=!1,s,i=t){let n=this.get(e);if(n)return n;const a={id:e,index:0};return n=this.onElementCreate(a,t),this.elements.set(e,n),this.update(e,i,n,s),n}delete(e,t){const s=this.elements.get(e);if(!s)return!1;this.elements.delete(e);const i=this.sorted.indexOf(s);if(-1!==i&&this.sorted.splice(i,1),this.onDelete)if(t)this.onDelete(s);else{const e=this.middleware.get();this.updateElementWith(()=>{e()&&this.onDelete(s)})}return!0}update(e,t=!1,s=this.get(e),i){if(!s)return;s.index=this.getIndex(e),this.onUpdate&&this.onUpdate(s);const n=Object(a.g)(this.sorted,s,"index");if(!t&&this.onSort){const e=this.middleware.get();(i||this.updateElementWith)(()=>{e()&&this.onSort(s,n)})}}}var Wa=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class qa extends za{constructor(e={}){let t;super({getIndex:e=>ye.getUserStatusForSort(e),onDelete:e=>{e.dom.listEl.remove(),this.onListLengthChange&&this.onListLengthChange()},onUpdate:e=>{const t=ye.getUserStatusString(e.id);Object(le.a)(e.dom.lastMessageSpan,t)},onSort:(e,t)=>{const s=e.dom.listEl.parentElement!==this.list;Ha(e.dom.listEl,this.list,t),s&&this.onListLengthChange&&this.onListLengthChange()},onElementCreate:e=>{const{dom:t}=Jd.addDialogNew({dialog:e.id,container:!1,drawStatus:!1,avatarSize:this.avatarSize,autonomous:this.autonomous,meAsSaved:!1,rippleEnabled:this.rippleEnabled,lazyLoadQueue:this.lazyLoadQueue}),s=this.ranks.get(e.id);if(s){t.titleP.lastElementChild.replaceChildren(function(e){return"object"==typeof e&&(e=_a(e)),"number"==typeof e?Object(O.i18n)(e?1===e?"Chat.OwnerBadge":"ChatAdmin":"Chat.ChannelBadge"):N.b.wrapEmojiText(e)}(s))}return e.dom=t,e},updateElementWith:g.b,updateListWith:e=>Wa(this,void 0,void 0,(function*(){return Object(b.a)(this.list)?(yield Object(it.c)(),Object(b.a)(this.list)?void e(!0):e(!1)):e(!1)}))}),this.ranks=new Map,this.avatarSize=48,this.rippleEnabled=!0,this.autonomous=!0,Object(m.g)(this,e),this.list=Jd.createChatList({new:e.new});const s=()=>{t=window.setTimeout(()=>{this.updateList(e=>{e&&s()})},qa.SORT_INTERVAL)};s()}}function Va(e){let t=!1;return new $n(Object.assign(Object.assign({},e),{verifyTouchTarget:t=>!Object(ti.a)(t.target,"progress-line")&&!Object(Nn.a)(t)&&(!e.verifyTouchTarget||e.verifyTouchTarget(t)),onSwipe:(s,i,n)=>{if(s*=-1,i*=-1,!t&&Math.abs(i)>20)return!0;if(Math.abs(s)>Math.abs(i))Object(f.a)(n),t=!0;else if(!t&&Math.abs(i)>Math.abs(s))return!0;return e.onSwipe(s,i,n)},onReset:()=>{t=!1,e.onReset&&e.onReset()},cancelEvent:!1}))}function Ga(e){return Va(Object.assign(Object.assign({},e),{onSwipe:(t,s,i)=>{if(Math.abs(t)>50)return e.onSwipe(t,s,i),Object(hi.b)(),!0}}))}qa.SORT_INTERVAL=3e4;var Ka=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class Qa extends un{constructor(e,t,s=!1,i="quote"){super({peerTypes:["dialogs","contacts"],onSelect:s?t:s=>Ka(this,void 0,void 0,(function*(){if(t){const e=t(s);e instanceof Promise&&(yield e)}Pd.setInnerPeer(s),Pd.chat.input.initMessagesForward(e,i)})),placeholder:"ShareModal.Search.ForwardPlaceholder",chatRightsAction:"send_messages",selfPresence:"ChatYourSelf"})}}class $a{constructor(e,t,s,i){const n=new Oe({peerId:e}).element;t=t.slice();const a=(n,a)=>{i&&i(),"scheduled"===s?js.deleteScheduledMessages(e,t):js.deleteMessages(e,t,!!n.size||a)};let o,r,l,d,c,h=[];if(1===t.length?o="DeleteSingleMessagesTitle":(o="DeleteMessagesTitle",r=[Object(O.i18n)("messages",[t.length])]),l=Te.isMegagroup(e)?1===t.length?"AreYouSureDeleteSingleMessageMega":"AreYouSureDeleteFewMessagesMega":1===t.length?"AreYouSureDeleteSingleMessage":"AreYouSureDeleteFewMessages",c=[{langKey:"Delete",isDanger:!0,callback:a}],e===H.default.myId||"scheduled"===s);else if(e.isUser())h.push({text:"DeleteMessagesOptionAlso",textArgs:[n],checked:!0});else{const s=Pe.getChat(e.toChatId()),i=Pe.hasRights(e.toChatId(),"delete_messages");if("chat"===s._){const s=i?t.slice():t.filter(t=>js.getMessageByPeer(e,t).fromId===H.default.myId);s.length&&(s.length===t.length?h.push({text:"DeleteForAll"}):(h.push({text:"DeleteMessagesOption"}),l="DeleteMessagesTextGroup",d=[Object(O.i18n)("messages",[s.length])]))}else c[0].callback=e=>a(e,!0)}ai(c);new en("popup-delete-chat",{peerId:e,titleLangKey:o,titleLangArgs:r,descriptionLangKey:l,descriptionLangArgs:d,buttons:c,checkboxes:h}).show()}}class Ya{constructor(e,t,s){let i,n,a=[];i=`Send Message${t.length>1?"s":""} Now`,n=t.length>1?"Send "+t.length+" messages now?":"Send message now?";a.push({langKey:"Send",callback:()=>{s&&s(),js.sendScheduledMessages(e,t)}});new en("popup-delete-chat",{peerId:e,title:i,description:n,buttons:a}).show()}}function Xa(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()}const Za=e=>[...e.values()].reduce((e,t)=>e+t.size,0);class Ja{constructor(e){if(this.selectedMids=new Map,this.isSelecting=!1,this.cancelSelection=()=>{this.onCancelSelection&&this.onCancelSelection(),this.selectedMids.clear(),this.toggleSelection(),Xa()},Object(m.g)(this,e),this.navigationType="multiselect-"+Object(x.b)(),Ht.IS_TOUCH_SUPPORTED){this.listenerSetter.add(this.listenElement)("touchend",()=>{this.isSelecting&&(this.selectedText=window.getSelection?window.getSelection().toString():document.selection?document.selection.createRange().text:"")});const e=window.matchMedia("(display-mode: standalone)").matches;return void Object(hi.a)(this.listenElement,t=>{var s;if(this.isSelecting||this.verifyTouchLongPress&&!this.verifyTouchLongPress())return;null===(s=this.onTouchLongPress)||void 0===s||s.call(this,t),document.body.classList.add("no-select"),C.IS_MOBILE_SAFARI||this.listenElement.addEventListener("touchend",e=>{Object(f.a)(e),document.body.classList.remove("no-select")},{once:!0,capture:!0}),C.IS_MOBILE_SAFARI&&e&&this.listenElement.addEventListener("mousedown",f.a,{once:!0,capture:!0}),Xa(),Object(f.a)(t);const i=this.getElementFromTarget(t.target);i&&this.toggleByElement(i)},this.listenerSetter)}const t=(e,t)=>{if(e===t)return[];const s=e.getBoundingClientRect(),i=t.getBoundingClientRect(),n=(s.top-i.top||s.left-i.left)<0,a=Object(ti.a)(e,this.lookupBetweenParentClassName);if(!a)return[];const o=Array.from(a.querySelectorAll(this.lookupBetweenElementsQuery));let r=o.indexOf(e),l=o.indexOf(t);n||([l,r]=[r,l]);return o.slice(r+1,l)};this.listenerSetter.add(this.listenElement)("mousedown",e=>{const s=Object(ti.a)(e.target,this.targetLookupClassName);if(0!==e.button)return;if(this.verifyTarget&&!this.verifyTarget(e,s))return;const i=new Map;let n,a=s;const o=(e,s=!0)=>{const r=+e.dataset.mid;if(!r||!e.dataset.peerId)return;const l=e.dataset.peerId.toPeerId();Object(b.a)(a)||(a=e);let d=i.get(l);if(d||i.set(l,d=new Set),!d.has(r)){const c=this.isMidSelected(l,r);if(void 0===n&&(n=!c),d.add(r),n&&!c||!n&&c){const n=Za(i);if(this.toggleByElement&&s){n<2&&Object(zt.a)(e,a)&&(a=e);const s=t(a,e);s.length&&s.forEach(e=>{o(e,!1)})}if(this.selectedMids.size)this.toggleByElement&&this.toggleByElement(e);else if(2===n&&this.toggleByMid)for(const[e,t]of i)for(const s of t)this.toggleByMid(e,s)}}};let r=!1;const l=e=>{r||(Xa(),r=!0);const t=this.getElementFromTarget(e.target);if(t)return this.verifyMouseMoveTarget&&!this.verifyMouseMoveTarget(e,t,n)?(this.listenerSetter.removeManual(this.listenElement,"mousemove",l),void this.listenerSetter.removeManual(document,"mouseup",d,c)):void o(t)},d=e=>{i.size&&Object(v.b)(window,f.a,{capture:!0,once:!0,passive:!1}),this.listenerSetter.removeManual(this.listenElement,"mousemove",l),Xa()},c={once:!0};this.listenerSetter.add(this.listenElement)("mousemove",l),this.listenerSetter.add(document)("mouseup",d,c)})}isElementShouldBeSelected(e){return this.isMidSelected(e.dataset.peerId.toPeerId(),+e.dataset.mid)}appendCheckbox(e,t){e.prepend(t.label)}toggleElementCheckbox(e,t){const s=!!this.getCheckboxInputFromElement(e);if(t){if(s)return!1;const t=new Gi.a({name:e.dataset.mid,round:!0});this.isSelecting&&this.isElementShouldBeSelected(e)&&(t.input.checked=!0,e.classList.add("is-selected")),this.appendCheckbox(e,t)}else s&&this.getCheckboxInputFromElement(e).parentElement.remove();return!0}getCheckboxInputFromElement(e){var t;return"LABEL"===(null===(t=e.firstElementChild)||void 0===t?void 0:t.tagName)&&e.firstElementChild.firstElementChild}updateContainer(e=!1){const t=this.selectedMids.size;if(!t&&!e)return;let s=!t,i=!t,n=!t;for(const[e,t]of this.selectedMids){const n=this.isScheduled?this.appMessagesManager.getScheduledMessagesStorage(e):this.appMessagesManager.getMessagesStorage(e);for(const e of t){const t=this.appMessagesManager.getMessageFromStorage(n,e);if(s||(s=!this.appMessagesManager.canForward(t)),s||this.appMessagesManager.canForwardMessage(t)||(s=!0),i||(i=!this.appMessagesManager.canDeleteMessage(t)),s&&i)break}if(s&&i)break}this.onUpdateContainer&&this.onUpdateContainer(s,i,n)}toggleSelection(e=!0,t=!1){const s=this.isSelecting,i=this.selectedMids.size;if(this.isSelecting=!!i||t,s===this.isSelecting)return!1;Ht.IS_TOUCH_SUPPORTED||(this.listenElement.classList.toggle("no-select",this.isSelecting),s&&Xa()),Object(si.a)();const n=!!i||t;return this.onToggleSelection&&this.onToggleSelection(n),C.IS_MOBILE_SAFARI||(n?Nt.a.pushItem({type:this.navigationType,onPop:()=>{this.cancelSelection()}}):Nt.a.removeByType(this.navigationType)),t&&this.updateContainer(t),!0}cleanup(){this.selectedMids.clear(),this.toggleSelection(!1)}updateElementSelection(e,t){this.toggleElementCheckbox(e,!0);this.getCheckboxInputFromElement(e).checked=t,this.toggleSelection(),this.updateContainer(),Object(p.a)(e,"is-selected",t,200)}isMidSelected(e,t){const s=this.selectedMids.get(e);return null==s?void 0:s.has(t)}length(){return Za(this.selectedMids)}toggleMid(e,t,s){let i=this.selectedMids.get(e);if(s||void 0===s&&(null==i?void 0:i.has(t)))i&&(i.delete(t),i.size||this.selectedMids.delete(e));else{if(H.default.config.forwarded_count_max-this.length()-1<0)return Qt(O.default.format("Chat.Selection.LimitToast",!0)),!1;i||(i=new Set,this.selectedMids.set(e,i)),i.add(t)}return!0}deleteSelectedMids(e,t){const s=this.selectedMids.get(e);s&&(t.forEach(e=>{s.delete(e)}),s.size||this.selectedMids.delete(e),this.updateContainer(),this.toggleSelection())}}class eo extends Ja{constructor(e,t){super({appMessagesManager:t,listenElement:e.container,listenerSetter:new Gs,verifyTarget:(e,t)=>!!t&&this.isSelecting,getElementFromTarget:e=>Object(ti.a)(e,"search-super-item"),targetLookupClassName:"search-super-item",lookupBetweenParentClassName:"tabs-tab",lookupBetweenElementsQuery:".search-super-item"}),this.searchSuper=e,this.toggleByElement=e=>{const t=+e.dataset.mid,s=e.dataset.peerId.toPeerId();this.toggleMid(s,t)&&this.updateElementSelection(e,this.isMidSelected(s,t))},this.toggleByMid=(e,t)=>{const s=this.searchSuper.mediaTab.contentTab.querySelector(`.search-super-item[data-peer-id="${e}"][data-mid="${t}"]`);this.toggleByElement(s)},this.onUpdateContainer=(e,t,s)=>{const i=this.length();Object(le.a)(this.selectionCountEl,Object(O.i18n)("messages",[i])),this.selectionGotoBtn.classList.toggle("hide",1!==i),this.selectionForwardBtn.classList.toggle("hide",e),this.selectionDeleteBtn&&this.selectionDeleteBtn.classList.toggle("hide",t)},this.onToggleSelection=e=>{if(Object(p.a)(this.searchSuper.navScrollableContainer,"is-selecting",e,200,()=>{this.isSelecting||(this.selectionContainer.remove(),this.selectionContainer=this.selectionForwardBtn=this.selectionDeleteBtn=null,this.selectedText=void 0)}),Object(p.a)(this.searchSuper.container,"is-selecting",e,200),this.isSelecting&&!this.selectionContainer){const e="search-super-selection";this.selectionContainer=document.createElement("div"),this.selectionContainer.classList.add(e+"-container");const t=Qs(`close ${e}-cancel`,{noRipple:!0});this.listenerSetter.add(t)("click",this.cancelSelection,{once:!0}),this.selectionCountEl=document.createElement("div"),this.selectionCountEl.classList.add(e+"-count"),this.selectionGotoBtn=Qs(`message ${e}-goto`);const s={listenerSetter:this.listenerSetter};Object(v.b)(this.selectionGotoBtn,()=>{const e=[...this.selectedMids.keys()][0],t=[...this.selectedMids.get(e)][0];this.cancelSelection(),H.default.dispatchEvent("history_focus",{peerId:e,mid:t})},s),this.selectionForwardBtn=Qs(`forward ${e}-forward`),Object(v.b)(this.selectionForwardBtn,()=>{const e={};for(const[t,s]of this.selectedMids)e[t]=Array.from(s).sort((e,t)=>e-t);new Qa(e,()=>{this.cancelSelection()})},s),this.isPrivate&&(this.selectionDeleteBtn=Qs(`delete danger ${e}-delete`),Object(v.b)(this.selectionDeleteBtn,()=>{const e=[...this.selectedMids.keys()][0];new $a(e,[...this.selectedMids.get(e)],"chat",()=>{this.cancelSelection()})},s)),this.selectionContainer.append(...[t,this.selectionCountEl,this.selectionGotoBtn,this.selectionForwardBtn,this.selectionDeleteBtn].filter(Boolean));const i=this.selectionContainer;i.style.opacity="0",this.searchSuper.navScrollableContainer.append(i),i.offsetLeft,i.style.opacity=""}},this.isPrivate=!e.showSender}toggleSelection(e=!0,t=!1){const s=super.toggleSelection(e,t);if(s&&e){Array.from(this.searchSuper.tabsContainer.querySelectorAll(".search-super-item")).forEach(e=>{this.toggleElementCheckbox(e,this.isSelecting)})}return s}}class to extends Ja{constructor(e,t,s,i){super({appMessagesManager:i,listenElement:t.bubblesContainer,listenerSetter:t.listenerSetter,getElementFromTarget:e=>Object(ti.a)(e,"grouped-item")||Object(ti.a)(e,"bubble"),verifyTarget:(e,t)=>!(!this.selectedMids.size&&!e.target.classList.contains("bubble")&&!e.target.classList.contains("document-selection")&&t),verifyMouseMoveTarget:(e,t,s)=>!(e.target!==t&&!e.target.classList.contains("document-selection")&&void 0===s&&!this.selectedMids.size),verifyTouchLongPress:()=>!this.chat.input.recording,targetLookupClassName:"bubble",lookupBetweenParentClassName:"bubbles-inner",lookupBetweenElementsQuery:".bubble:not(.is-multiple-documents), .grouped-item",isScheduled:"scheduled"===e.type,onTouchLongPress:()=>{const{replySwipeHandler:e}=this.chat.bubbles;null==e||e.reset()}}),this.chat=e,this.bubbles=t,this.input=s,this.isProcessingKeyEvent=!1,this.toggleByElement=e=>{if(!this.canSelectBubble(e))return;const t=+e.dataset.mid;if(e.classList.contains("is-grouped")){if(!this.isGroupedBubbleSelected(e)){const e=this.selectedMids.get(this.bubbles.peerId);if(e){this.chat.getMidsByMid(t).forEach(t=>e.delete(t))}}return void this.bubbles.getBubbleGroupedItems(e).forEach(this.toggleByElement)}if(!this.toggleMid(this.bubbles.peerId,t))return;if(e.classList.contains("grouped-item")){const s=Object(ti.a)(e,"bubble"),i=this.isGroupedBubbleSelected(s),n=this.isGroupedMidsSelected(t);(n||i)&&this.updateElementSelection(s,n)}this.updateElementSelection(e,this.isMidSelected(this.bubbles.peerId,t))},this.toggleByMid=(e,t)=>{const s=this.bubbles.getMountedBubble(t);s&&this.toggleByElement(s.bubble)},this.onToggleSelection=e=>{let t,s="",i="";const n=this.input.rowsWrapper.parentElement,a=n.querySelector(".fake-selection-wrapper"),o=n.querySelector(".fake-rows-wrapper"),r=a.getBoundingClientRect(),l=o.getBoundingClientRect(),d=l.width,c=r.width;if(d!==c){const n=c/d,a=(d-c)/2;if(t=r.left-l.left-a,e&&(s=`translateX(${t}px) scaleX(${n})`,n<1)){const e=12;i=e+e*(1-n)+"px"}}if(Object(p.a)(this.input.rowsWrapper,"is-centering",e,200),this.input.rowsWrapper.style.transform=s,this.input.rowsWrapper.style.borderRadius=i,Object(p.a)(this.listenElement,"is-selecting",e,200,()=>{this.isSelecting||(this.selectionInputWrapper.remove(),this.selectionInputWrapper=this.selectionContainer=this.selectionSendNowBtn=this.selectionForwardBtn=this.selectionDeleteBtn=null,this.selectedText=void 0),Object(g.b)(()=>{this.bubbles.onScroll()})}),this.isSelecting&&!this.selectionContainer){this.selectionInputWrapper=document.createElement("div"),this.selectionInputWrapper.classList.add("chat-input-wrapper","selection-wrapper"),this.selectionContainer=document.createElement("div"),this.selectionContainer.classList.add("selection-container");const e={listenerSetter:this.listenerSetter},t=Qs("close",{noRipple:!0});Object(v.b)(t,this.cancelSelection,{once:!0,listenerSetter:this.listenerSetter}),this.selectionCountEl=document.createElement("div"),this.selectionCountEl.classList.add("selection-container-count"),"scheduled"===this.chat.type?(this.selectionSendNowBtn=Object(Ks.a)("btn-primary btn-transparent btn-short text-bold selection-container-send",{icon:"send2"}),this.selectionSendNowBtn.append(Object(O.i18n)("MessageScheduleSend")),Object(v.b)(this.selectionSendNowBtn,()=>{new Ya(this.bubbles.peerId,[...this.selectedMids.get(this.bubbles.peerId)],()=>{this.cancelSelection()})},e)):(this.selectionForwardBtn=Object(Ks.a)("btn-primary btn-transparent text-bold selection-container-forward",{icon:"forward"}),this.selectionForwardBtn.append(Object(O.i18n)("Forward")),Object(v.b)(this.selectionForwardBtn,()=>{var e;let t="quote";(null===(e=this.chat.selection.selectionForwardBtn.dataset)||void 0===e?void 0:e.type)&&(t=this.chat.selection.selectionForwardBtn.dataset.type);const s={};for(const[e,t]of this.selectedMids)s[e]=Array.from(t).sort((e,t)=>e-t);new Qa(s,()=>{this.cancelSelection()},!1,t)},e)),this.selectionDeleteBtn=Object(Ks.a)("btn-primary btn-transparent danger text-bold selection-container-delete",{icon:"delete"}),this.selectionDeleteBtn.append(Object(O.i18n)("Delete")),Object(v.b)(this.selectionDeleteBtn,()=>{new $a(this.bubbles.peerId,[...this.selectedMids.get(this.bubbles.peerId)],this.chat.type,()=>{this.cancelSelection()})},e),this.listenerSetter.add(document)("keyup",e=>{"Delete"!==e.code||this.selectionDeleteBtn.hasAttribute("disabled")||this.isProcessingKeyEvent||(this.isProcessingKeyEvent=!0,this.selectionDeleteBtn.click(),setTimeout(()=>{this.isProcessingKeyEvent=!1},500))}),this.selectionContainer.append(...[t,this.selectionCountEl,this.selectionSendNowBtn,this.selectionForwardBtn,this.selectionDeleteBtn].filter(Boolean)),this.selectionInputWrapper.style.opacity="0",this.selectionInputWrapper.append(this.selectionContainer),this.input.rowsWrapper.parentElement.append(this.selectionInputWrapper),this.selectionInputWrapper.offsetLeft,this.selectionInputWrapper.style.opacity=""}},this.onUpdateContainer=(e,t,s)=>{Object(le.a)(this.selectionCountEl,Object(O.i18n)("messages",[this.length()])),this.selectionSendNowBtn&&this.selectionSendNowBtn.toggleAttribute("disabled",s),this.selectionForwardBtn&&this.selectionForwardBtn.toggleAttribute("disabled",e),this.selectionDeleteBtn.toggleAttribute("disabled",t)},this.onCancelSelection=()=>{for(const[e,t]of this.selectedMids)for(const e of t){const t=this.bubbles.getMountedBubble(e);t&&this.toggleByElement(t.bubble)}}}appendCheckbox(e,t){t.label.classList.add("bubble-select-checkbox"),e.classList.contains("document-container")?e.querySelector(".document, audio-element").append(t.label):super.appendCheckbox(e,t)}toggleSelection(e=!0,t=!1){const s=super.toggleSelection(e,t);if(s&&e)for(const e in this.bubbles.bubbles){const t=this.bubbles.bubbles[e];this.toggleElementCheckbox(t,this.isSelecting)}return s}toggleElementCheckbox(e,t){if(!this.canSelectBubble(e))return;const s=super.toggleElementCheckbox(e,t);if(s){e.classList.contains("is-grouped")&&this.bubbles.getBubbleGroupedItems(e).forEach(e=>this.toggleElementCheckbox(e,t))}return s}isElementShouldBeSelected(e){const t=e.classList.contains("is-grouped");return super.isElementShouldBeSelected(e)&&(!t||this.isGroupedMidsSelected(+e.dataset.mid))}isGroupedBubbleSelected(e){const t=this.getCheckboxInputFromElement(e);return null==t?void 0:t.checked}isGroupedMidsSelected(e){const t=this.chat.getMidsByMid(e),s=t.filter(e=>this.isMidSelected(this.bubbles.peerId,e));return t.length===s.length}getCheckboxInputFromElement(e){return e.classList.contains("document-container")?e.querySelector("label input"):super.getCheckboxInputFromElement(e)}canSelectBubble(e){return!e.classList.contains("service")&&!e.classList.contains("is-sending")&&!e.classList.contains("bubble-first")}}var so,io=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class no{constructor(e,t){this.attachTo=e,this.searchSuper=t,this.onGotoClick=()=>{H.default.dispatchEvent("history_focus",{peerId:this.peerId,mid:this.mid,threadId:this.searchSuper.searchContext.threadId})},this.onForwardClick=()=>{this.searchSuper.selection.isSelecting?Object(v.e)(this.searchSuper.selection.selectionForwardBtn):new Qa({[this.peerId]:[this.mid]})},this.onSelectClick=()=>{this.searchSuper.selection.toggleByElement(this.target)},this.onClearSelectionClick=()=>{this.searchSuper.selection.cancelSelection()},this.onDeleteClick=()=>{this.searchSuper.selection.isSelecting?Object(v.e)(this.searchSuper.selection.selectionDeleteBtn):new $a(this.peerId,[this.mid],"chat")};const s=e=>{let s;this.init&&(this.init(),this.init=null);try{s=Object(ti.a)(e.target,"search-super-item")}catch(e){}if(s){if(e instanceof MouseEvent&&e.preventDefault(),this.element.classList.contains("active"))return!1;e instanceof MouseEvent&&(e.cancelBubble=!0),this.target=s,this.peerId=s.dataset.peerId.toPeerId(),this.mid=+s.dataset.mid,this.isSelected=t.selection.isMidSelected(this.peerId,this.mid),this.message=js.getMessageByPeer(this.peerId,this.mid),this.noForwards=!js.canForward(this.message),this.buttons.forEach(e=>{let t;t=!(this.isSelected&&!e.withSelection)&&(!e.verify||e.verify()),e.element.classList.toggle("hide",!t)}),s.classList.add("menu-open"),Object(hi.e)(e,this.element),Object(hi.d)(this.element,()=>{s.classList.remove("menu-open")})}};Ht.IS_TOUCH_SUPPORTED||Object(hi.a)(e,s)}init(){this.buttons=[{icon:"forward",text:"Forward",onClick:this.onForwardClick,verify:()=>!this.noForwards},{icon:"forward",text:"Message.Context.Selection.Forward",onClick:this.onForwardClick,verify:()=>!this.noForwards&&this.isSelected&&!this.searchSuper.selection.selectionForwardBtn.classList.contains("hide"),withSelection:!0},{icon:"message",text:"Message.Context.Goto",onClick:this.onGotoClick,withSelection:!0},{icon:"select",text:"Message.Context.Select",onClick:this.onSelectClick},{icon:"select",text:"Message.Context.Selection.Clear",onClick:this.onClearSelectionClick,verify:()=>this.isSelected,withSelection:!0},{icon:"delete danger",text:"Delete",onClick:this.onDeleteClick,verify:()=>js.canDeleteMessage(js.getMessageByPeer(this.peerId,this.mid))},{icon:"delete danger",text:"Message.Context.Selection.Delete",onClick:this.onDeleteClick,verify:()=>this.isSelected&&!this.searchSuper.selection.selectionDeleteBtn.classList.contains("hide"),withSelection:!0}],this.element=Mi(this.buttons),this.element.classList.add("search-contextmenu","contextmenu"),document.getElementById("page-chats").append(this.element)}}class ao{constructor(e){this.tabs={},this.prevTabId=-1,this.lazyLoadQueue=new c,this.middleware=Ke(),this.historyStorage={},this.usedFromHistory={},this.urlsToRevoke=[],this.loadMutex=Promise.resolve(),this.nextRates={},this.loadPromises={},this.loaded={},this.loadedChats=!1,this.firstLoad=!0,this.log=Object(i.b)("SEARCH-SUPER"),this.monthContainers={},this.mediaTabsMap=new Map,this.asChatList=!1,this.groupByMonth=!0,this.hideEmptyTabs=!0,this.showSender=!1,this.toggleSubSearchSuperTabs=e=>{const t=()=>{s.querySelectorAll(".sub-search-super-item").forEach(e=>{"all"===e.getAttribute("data-type")?e.classList.add("active"):e.classList.remove("active")})},s=document.querySelector(".sub-search-super-tabs-scrollable");s&&("inputMessagesFilterPrivate"===e||"inputMessagesFilterPublic"===e||"inputMessagesFilterGlobal"===e?(s.style.display="flex",t()):"inputMessagesFilterChats"!==e&&"inputMessagesFilterTitle"!==e||(s.style.display="none",t()))},this.onTransitionStart=()=>{this.container.classList.add("sliding")},this.onTransitionEnd=()=>{this.container.classList.remove("sliding")},Object(m.g)(this,e),this.container=document.createElement("div"),this.container.classList.add("search-super"),this.searchContextMenu=new no(this.container,this),this.selection=new eo(this,js);const t=this.navScrollableContainer=document.createElement("div");t.classList.add("search-super-tabs-scrollable","menu-horizontal-scrollable","sticky");const s=this.navScrollable=new re.a(t);s.container.classList.add("search-super-nav-scrollable");const n=this.nav=document.createElement("nav");n.classList.add("search-super-tabs","menu-horizontal-div"),this.tabsMenu=n,s.container.append(n);for(const e of this.mediaTabs){const t=document.createElement("div");t.classList.add("menu-horizontal-div-item");const s=document.createElement("span"),i=document.createElement("i");s.append(Object(O.i18n)(e.name)),s.append(i),t.append(s),Object(ei.ripple)(t),this.tabsMenu.append(t),this.mediaTabsMap.set(e.type,e),e.menuTab=t}let a;this.tabsContainer=document.createElement("div"),this.tabsContainer.classList.add("search-super-tabs-container","tabs-container"),Ht.IS_TOUCH_SUPPORTED&&Ga({element:this.tabsContainer,onSwipe:(e,t,s)=>{const i=this.selectTab.prevId(),n=Array.from(this.tabsMenu.children);let o;if(e>0){for(let e=i+1;e<n.length;++e)if(!n[e].classList.contains("hide")){o=e;break}}else for(let e=i-1;e>=0;--e)if(!n[e].classList.contains("hide")){o=e;break}void 0!==o&&(a=function(e){const t=e=>{Object(f.a)(e)};let s=2;const i=()=>{--s||e.removeEventListener("touchmove",t,{capture:!0})};return e.addEventListener("touchmove",t,{capture:!0,passive:!1}),e.addEventListener("touchend",i,{once:!0}),i}(this.tabsContainer),this.selectTab(o))}});for(const e of this.mediaTabs){const t=document.createElement("div");t.classList.add("search-super-container-"+e.type,"tabs-tab");const s=document.createElement("div");s.classList.add("search-super-content-"+e.type),t.append(s),this.tabsContainer.append(t),this.tabs[e.inputFilter]=s,e.contentTab=s}this.container.append(t,this.tabsContainer),this.searchGroupMedia=new de(!1,"messages",!0),this.scrollable.onScrolledBottom=()=>{this.mediaTab.contentTab&&this.mediaTab.contentTab.childElementCount&&this.load(!0)},this.selectTab=Object(ci.a)(this.tabsMenu,this.tabsContainer,(e,t,s)=>{if(this.prevTabId===e&&!this.skipScroll)return void this.scrollable.scrollIntoViewNew(this.container,"start");const i=this.mediaTabs[e];this.onChangeTab&&this.onChangeTab(i),this.toggleSubSearchSuperTabs(i.inputFilter);const n=this.mediaTab;if(this.mediaTab=i,-1!==this.prevTabId&&s&&this.onTransitionStart(),this.skipScroll)this.skipScroll=!1;else{const e=this.container.offsetTop;let t=this.scrollable.scrollTop;if(t<e&&(this.scrollable.scrollIntoViewNew(this.container,"start"),t=e),n.scroll={scrollTop:t,scrollHeight:this.scrollable.scrollHeight},void 0===i.scroll){const e=this.container.getBoundingClientRect(),s=this.container.parentElement.getBoundingClientRect(),n=e.y-s.y;t>n&&(i.scroll={scrollTop:n,scrollHeight:0})}if(i.scroll){const e=n.scroll.scrollTop-i.scroll.scrollTop;e&&(i.contentTab.style.transform=`translateY(${e}px)`)}}-1===this.prevTabId||i.contentTab.childElementCount||this.load(!0),this.prevTabId=e},()=>{this.scrollable.onScroll(),void 0!==this.mediaTab.scroll&&(this.mediaTab.contentTab.style.transform="",this.scrollable.scrollTop=this.mediaTab.scroll.scrollTop),a&&(a(),a=void 0),this.onTransitionEnd()},void 0,s),Object(v.b)(this.tabsContainer,e=>{this.selection.isSelecting&&(Object(f.a)(e),this.selection.toggleByElement(Object(ti.a)(e.target,"search-super-item")))},{capture:!0,passive:!1});const o=(e,t,s,i)=>{const n=Object(ti.a)(i.target,e);if(!n)return;const a=+n.dataset.mid;if(!a)return void this.log.warn("no messageId by click on target:",n);const o=n.dataset.peerId.toPeerId(),r=Array.from(this.tabs[s].querySelectorAll("."+t)).map(t=>{const s=Object(ti.a)(t,e);return{element:t,mid:+s.dataset.mid,peerId:s.dataset.peerId.toPeerId()}}),l=r.findIndex(e=>e.mid===a&&e.peerId===o),d=js.getMessageByPeer(o,a);(new Ed).setSearchContext(this.copySearchContext(s)).openMedia(d,r[l].element,0,!1,r.slice(0,l),r.slice(l+1))};this.tabs.inputMessagesFilterPhotoVideo&&Object(v.b)(this.tabs.inputMessagesFilterPhotoVideo,o.bind(null,"grid-item","grid-item","inputMessagesFilterPhotoVideo")),this.tabs.inputMessagesFilterPhotoVideo&&Object(v.b)(this.tabs.inputMessagesFilterPhotoVideo,o.bind(null,"document-with-thumb","media-container","inputMessagesFilterDocument")),this.mediaTab=this.mediaTabs[0],Object(it.a)(()=>{this.lazyLoadQueue.lock()},()=>{this.lazyLoadQueue.unlockAndRefresh()})}filterMessagesByType(e,t){if("inputMessagesFilterEmpty"===t||"inputMessagesFilterPrivate"===t||"inputMessagesFilterPublic"===t||"inputMessagesFilterGlobal"===t)return e;"inputMessagesFilterUrl"!==t&&(e=e.filter(e=>!!e.media));let s=[];switch(t){case"inputMessagesFilterPhotoVideo":for(let t of e){let e=t.media.photo||t.media.document||t.media.webpage&&t.media.webpage.document;e&&("document"===e._&&"video"!==e.type||s.push(t))}break;case"inputMessagesFilterDocument":for(let t of e)t.media.document&&!["voice","audio","gif","sticker","round"].includes(t.media.document.type)&&s.push(t);break;case"inputMessagesFilterUrl":for(let t of e)s.push(t);break;case"inputMessagesFilterMusic":for(let t of e)t.media.document&&"audio"===t.media.document.type&&s.push(t);break;case"inputMessagesFilterVoice":for(let t of e)t.media.document&&"voice"===t.media.document.type&&s.push(t);break;case"inputMessagesFilterRoundVoice":for(let t of e)t.media.document&&["voice","round"].includes(t.media.document.type)&&s.push(t)}return s}performSearchResult(e,t,s=!0){var i;return io(this,void 0,void 0,(function*(){const n=[],a=t.contentTab,o=[],r=this.middleware.get();let l=t.inputFilter;yield Object(it.c)();let d,c="";switch("inputMessagesFilterPhotoVideo"===l&&this.searchContext.query.trim()?(l="inputMessagesFilterEmpty",d=this.searchGroupMedia,a.append(d.container)):"inputMessagesFilterEmpty"===l?d=this.searchGroups.messages:"inputMessagesFilterPrivate"===l?(d=new de(!1,"messages",!0),c="private"):"inputMessagesFilterPublic"===l?(d=new de(!1,"messages",!0),c="public"):"inputMessagesFilterGlobal"===l&&(d=new de(!1,"messages",!0),c="global"),l){case"inputMessagesFilterPrivate":case"inputMessagesFilterPublic":case"inputMessagesFilterGlobal":{for(const t of e){const{dialog:e,dom:s}=Jd.addDialogNew({dialog:t.peerId,container:d.list,drawStatus:!1,avatarSize:54});Jd.setLastMessage(e,t,s,this.searchContext.query)}d.list.childElementCount&&d.setActive();const t=document.querySelector("#search-container .search-super-content-"+c);t.append(d.container);const s=t.parentNode.querySelector(".preloader");s&&s.remove();break}case"inputMessagesFilterEmpty":for(const t of e){const{dialog:e,dom:s}=Jd.addDialogNew({dialog:t.peerId,container:d.list,drawStatus:!1,avatarSize:54});Jd.setLastMessage(e,t,s,this.searchContext.query)}d.list.childElementCount&&d.setActive();break;case"inputMessagesFilterPhotoVideo":for(const t of e){const e=t.media.photo||t.media.document||t.media.webpage&&t.media.webpage.document,s=document.createElement("div");let i;s.classList.add("grid-item");const a=Dt.choosePhotoSize(e,200,200);i="photo"!==e._?xa({doc:e,message:t,container:s,boxWidth:0,boxHeight:0,lazyLoadQueue:this.lazyLoadQueue,middleware:r,onlyPreview:!0,withoutPreloader:!0,noPlayButton:!0,size:a}).thumb:Oa({photo:e,message:t,container:s,boxWidth:0,boxHeight:0,lazyLoadQueue:this.lazyLoadQueue,middleware:r,withoutPreloader:!0,noBlur:!0,size:a}),[i.images.thumb,i.images.full].filter(Boolean).forEach(e=>{e.classList.add("grid-item-media")}),o.push(i.loadPromises.thumb),n.push({element:s,message:t})}break;case"inputMessagesFilterVoice":case"inputMessagesFilterRoundVoice":case"inputMessagesFilterMusic":case"inputMessagesFilterDocument":for(const t of e){const e=this.showSender||["voice","round"].includes(t.media.document.type),s=Aa({message:t,withTime:!e,fontWeight:400,voiceAsMusic:!0,showSender:e,searchContext:this.copySearchContext(l),lazyLoadQueue:this.lazyLoadQueue,noAutoDownload:!0});["audio","voice","round"].includes(t.media.document.type)&&s.classList.add("audio-48"),n.push({element:s,message:t})}break;case"inputMessagesFilterUrl":for(let t of e){let e;if((null===(i=t.media)||void 0===i?void 0:i.webpage)&&"webPageEmpty"!==t.media.webpage._)e=t.media.webpage;else{const s=t.totalEntities?t.totalEntities.find(e=>"messageEntityUrl"===e._||"messageEntityTextUrl"===e._):null;let i,n,a;if(s)a=t.message.slice(s.offset,s.offset+s.length);else{const e=N.b.matchUrl(t.message);if(!e)continue;i=e[0]}i="messageEntityTextUrl"===(null==s?void 0:s._)?s.url:i||a,n=i;const o=t.message===i;i.match(/^(ftp|http|https):\/\//)||(n="https://"+i,i=i.includes("@")?i:"https://"+i),n=new URL(n).hostname,e={url:i,display_url:n},o||(e.description=t.message,e.rDescription=N.b.wrapRichText(Object(A.f)(t.message,150,180)))}document.createElement("div");let s=document.createElement("div");if(s.classList.add("preview","row-media"),e.photo){Oa({container:s,message:null,photo:e.photo,boxWidth:0,boxHeight:0,withoutPreloader:!0,lazyLoadQueue:this.lazyLoadQueue,middleware:r,size:Dt.choosePhotoSize(e.photo,60,60,!1),loadPromises:o,noBlur:!0})}else s.classList.add("empty"),Object(xe.a)(s,N.b.getAbbreviation(e.title||e.display_url||e.description||e.url,!0));let a=e.rTitle||"";const l=Ne(e.rDescription||""),d=Ne(N.b.wrapRichText(e.url||"")).firstElementChild;d instanceof HTMLAnchorElement&&(d.innerText=decodeURIComponent(d.href)),l.firstChild&&l.append("\n"),l.append(d),this.showSender&&l.append("\n",js.wrapSenderToPeer(t)),a||(a=N.b.wrapPlainText(e.display_url.split("/",1)[0]));const c=new Qi({title:a,titleRight:js.wrapSentTime(t),subtitle:l,havePadding:!0,clickable:!0,noRipple:!0});c.container.append(s),c.container.innerText.trim().length&&n.push({element:c.container,message:t})}}if(this.loadMutex&&o.push(this.loadMutex),o.length&&(yield Promise.all(o),!r()))return;if(n.length){const e=s?"append":"prepend";n.forEach(t=>{const{element:s,message:i}=t,n=this.getMonthContainerByTimestamp(this.groupByMonth?i.date:0,l);s.classList.add("search-super-item"),s.dataset.mid=""+i.mid,s.dataset.peerId=""+i.peerId,n.items[e](s),this.selection.isSelecting&&this.selection.toggleElementCheckbox(s,!0)})}["inputMessagesFilterChats","inputMessagesFilterTitle","inputMessagesFilterPrivate","inputMessagesFilterPublic","inputMessagesFilterGlobal"].includes(l)||this.afterPerforming("inputMessagesFilterEmpty"===l?1:e.length,a)}))}afterPerforming(e,t){if(t){const s=t.parentElement;if(Array.from(s.children).slice(1).forEach(e=>{e.remove()}),!e&&!t.childElementCount){const e=document.createElement("div");e.innerText=Object(O.i18n)("Eitaa.NothingInteresting").innerText,e.classList.add("position-center","text-center","content-empty","no-select"),s.append(e)}}}loadChats(){const e=new Set,t=this.middleware.get();if(this.tabs.inputMessagesFilterChats){const e=this.searchGroups.contacts;this.tabs.inputMessagesFilterChats.append(e.container),e.clear()}const s=this.searchContext.query;if(s){const i=(t,i,n=!1)=>{t.forEach(t=>{if(e.has(t))return;e.add(t);const a=Te.getPeer(t),{dom:o}=Jd.addDialogNew({dialog:t,container:i.list,drawStatus:!1,avatarSize:48,autonomous:i.autonomous});if(n&&(a.participants_count||a.participants)){const e=new RegExp(`(${Object(A.e)(s)}|${Object(A.e)(K(s))})`,"gi");o.titleSpan.innerHTML=o.titleSpan.innerHTML.replace(e,"<i>$1</i>"),o.lastMessageSpan.append(Ts.getChatMembersString(t.toChatId()))}else if(t===H.default.myId)o.lastMessageSpan.append(Object(O.i18n)("Presence.YourChat"));else{let e=Te.getPeerUsername(t);if(e)e="@"+e;else{const s=ye.getUser(t);s&&s.phone&&(e="+"+Object(fe.a)(s.phone).formatted)}o.lastMessageSpan.innerHTML="<i>"+e+"</i>"}}),i.toggle()},n=e=>{if(t())return e};return Promise.all([ye.getContactsPeerIds(s,!0).then(n).then(e=>{e&&i(e,this.searchGroups.contacts,!0)}),ye.searchContacts(s,20).then(n).then(e=>{var t,s,n,a,o;if(e&&(i(e.my_results,this.searchGroups.contacts,!0),i(e.results,this.searchGroups.globalContacts),(null===(s=null===(t=this.searchGroups.globalContacts)||void 0===t?void 0:t.nameEl)||void 0===s?void 0:s.lastElementChild)&&this.searchGroups.globalContacts.nameEl.lastElementChild.remove(),this.searchGroups.globalContacts.container.classList.add("is-short"),(null===(n=this.searchGroups.globalContacts)||void 0===n?void 0:n.list.childElementCount)>3)){const e=document.createElement("div");e.classList.add("search-group__show-more"),e.innerText="Show more",(null===(a=this.searchGroups.globalContacts)||void 0===a?void 0:a.nameEl)&&(null===(o=this.searchGroups.globalContacts)||void 0===o||o.nameEl.append(e)),e.addEventListener("click",()=>{const t=this.searchGroups.globalContacts.container.classList.toggle("is-short");e.innerText=t?"Show more":"Show less"})}}),js.getConversations(s,0,20,0).promise.then(n).then(e=>{e&&i(e.dialogs.map(e=>e.peerId),this.searchGroups.contacts,!0)})])}if(this.searchContext.peerId||this.searchContext.minDate)return Promise.resolve();{const e=(e=!0)=>ve.default.getState().then(s=>{t()&&(this.searchGroups.recent.list.innerHTML="",s.recentSearch.slice(0,20).forEach(e=>{let{dialog:t,dom:s}=Jd.addDialogNew({dialog:e,container:this.searchGroups.recent.list,drawStatus:!1,meAsSaved:!0,avatarSize:48,autonomous:!0});s.lastMessageSpan.append(e.isUser()?ye.getUserStatusString(e):Ts.getChatMembersString(e.toChatId()))}),s.recentSearch.length?e&&this.searchGroups.recent.setActive():this.searchGroups.recent.clear())});return Promise.all([ye.getTopPeers("correspondents").then(e=>{if(!t())return;const s=e.findIndex(e=>e.id===H.default.myId);-1!==s&&(e=e.slice()).splice(s,1),e.length&&e.forEach(e=>{Jd.addDialogNew({dialog:e.id,container:this.searchGroups.people.list,drawStatus:!1,onlyFirstName:!0,avatarSize:54,autonomous:!1})}),this.searchGroups.people.setActive()}),e()])}}loadMembers(e){const t="members"===e.type?this.searchContext.peerId.toChatId():void 0,s="groups"===e.type?this.searchContext.peerId.toUserId():void 0,i=this.middleware.get();let n;const o=n=>io(this,void 0,void 0,(function*(){if(this.loadMutex&&(yield this.loadMutex,!i()))return;let o=this.membersList,r=this.membersParticipantMap;o||(r=this.membersParticipantMap=new Map,o=this.membersList=new qa({lazyLoadQueue:this.lazyLoadQueue,rippleEnabled:!1}),this.membersList.list.addEventListener("click",e=>{const t=Object(nn.a)(e.target,"LI");if(!t)return;const s=t.dataset.peerId.toPeerId();let i=Promise.resolve();I.b.isMobile&&(i=pa.toggleSidebar(!1)),i.then(()=>{Pd.setInnerPeer(s)})}),e.contentTab.append(this.membersList.list),this.afterPerforming(1,e.contentTab));const l=n.map(e=>{const i=s?e.id.toPeerId(!0):Pe.getParticipantPeerId(e);if(!(t?i.isAnyChat():i.isUser()))return{peerId:i,rank:_a(e),participant:e}}).filter(Boolean),d=yield Object(a.b)(l,({peerId:e})=>io(this,void 0,void 0,(function*(){const t=yield Te.getPeer(e);return!!i()&&!(!t||t.pFlags.deleted)})));for(const{peerId:e,rank:t,participant:s}of d)t&&this.membersList.ranks.set(e,t),r.set(e,s),this.membersList.add(e)}));if(Pe.isChannel(t)){const s=this.membersList?200:50;n=Ts.getChannelParticipants(t,void 0,s,this.nextRates[e.inputFilter]).then(t=>{if(!i())return;let n=e.contentTab.firstElementChild;return this.nextRates[e.inputFilter]=(n?n.childElementCount:0)+t.participants.length,t.participants.length<s&&(this.loaded[e.inputFilter]=!0),o(t.participants)})}else n=Ts.getChatFull(t).then(t=>{if(!i())return;this.loaded[e.inputFilter]=!0;const s=t.participants;return"chatParticipantsForbidden"!==s._?o(s.participants):void 0});return this.loadPromises[e.inputFilter]=n.finally(()=>{i()&&(this.loadPromises[e.inputFilter]=null)})}loadType(e,t,s,i){var n,a;const o=e.inputFilter;if(("inputMessagesFilterTitle"===o||"inputMessagesFilterPrivate"===o||"inputMessagesFilterPublic"===o||"inputMessagesFilterGlobal"===o)&&""===this.searchContext.query.trim()){const t=e.contentTab.parentNode.querySelector(".preloader");return t&&t.remove(),Promise.resolve()}if(this.loadPromises[o])return this.loadPromises[o];if("members"===e.type)return this.loadMembers(e);const r=null!==(n=this.historyStorage[o])&&void 0!==n?n:this.historyStorage[o]=[];if(!("inputMessagesFilterEmpty"!==o&&"inputMessagesFilterChats"!==o||r.length||(this.loadedChats||(this.loadChats(),this.loadedChats=!0),this.searchContext.query.trim()||this.searchContext.peerId||this.searchContext.minDate)))return this.loaded[o]=!0,Promise.resolve();if("inputMessagesFilterChats"===o)return Promise.resolve();const l="load ["+o+"]: ";if(r.length&&this.usedFromHistory[o]<r.length&&!t){let t=[],i=Math.max(0,this.usedFromHistory[o]),n=0;do{let e=r.slice(i,i+s);i+=e.length,n+=e.length,t.push(...this.filterMessagesByType(e.map(e=>js.getMessageByPeer(e.peerId,e.mid)),o))}while(n<s&&i<r.length);return this.usedFromHistory[o]=i,this.performSearchResult(t,e).finally(()=>{setTimeout(()=>{this.scrollable.checkForTriggers()},0)})}let d=r.length?r[r.length-1].mid:0,c={mid:0,peerId:0};return"inputMessagesFilterPrivate"!==o&&"inputMessagesFilterPublic"!==o&&"inputMessagesFilterGlobal"!==o||r.length&&(c=r[r.length-1]),this.loadPromises[o]=js.getSearch(Object.assign(Object.assign({},this.searchContext),{inputFilter:{_:o},maxId:d,limit:s,nextRate:null!==(a=this.nextRates[o])&&void 0!==a?a:this.nextRates[o]=0,lastHistory:c})).then(n=>{if(r.push(...n.history.map(e=>({mid:e.mid,peerId:e.peerId}))),this.log(l+"search house of glass",o,n),i())return(n.history.length<s||void 0!==this.searchContext.folderId&&!n.next_rate||n.history.length===n.count)&&(this.loaded[o]=!0),this.nextRates[o]=n.next_rate,t?Promise.resolve():(this.usedFromHistory[o]=r.length,this.loaded[o]||(this.loadPromises[o]||Promise.resolve()).then(()=>{setTimeout(()=>{if(i()&&this.mediaTab===e){const e=this.load(!0,!0);e&&e.then(()=>{i()&&setTimeout(()=>{this.scrollable.checkForTriggers()},0)})}},0)}),this.performSearchResult(this.filterMessagesByType(n.history,o),e))}).catch(e=>{this.log.error("load error:",e)}).finally(()=>{this.loadPromises[o]=null})}load(e=!1,t=!1){return io(this,void 0,void 0,(function*(){const s=this.searchContext.peerId;this.log("load",e,s,this.loadPromises);const i=this.middleware.get();if(this.firstLoad){if(this.hideEmptyTabs){const e=this.mediaTabs.filter(e=>"inputMessagesFilterEmpty"!==e.inputFilter),t=e.map(e=>({_:e.inputFilter})),n=yield js.getSearchCounters(s,t);if(!i())return;if(this.loadMutex&&(yield this.loadMutex,!i()))return;let a,o=0;e.forEach(e=>{const t=n.find(t=>t.filter._===e.inputFilter);e.menuTab.classList.toggle("hide",!t.count),e.menuTab.classList.remove("active"),t.count&&void 0===a&&(a=e),t.count&&++o});const r=this.mediaTabsMap.get("members"),l=this.canViewMembers();r.menuTab.classList.toggle("hide",!l),l&&(a=r),this.container.classList.toggle("hide",!a),this.container.parentElement.classList.toggle("search-empty",!a),a&&(this.skipScroll=!0,this.selectTab(this.mediaTabs.indexOf(a),!1),a.menuTab.classList.add("active"),this.navScrollableContainer.classList.toggle("hide",o<=1))}this.firstLoad=!1}let n=e?[this.mediaTab]:this.mediaTabs.filter(e=>e!==this.mediaTab);if(n=n.filter(e=>{const t=e.inputFilter;return"inputMessagesFilterPrivate"===t||"inputMessagesFilterPublic"===t||"inputMessagesFilterGlobal"===t||(!this.loaded[t]||this.historyStorage[t]&&this.usedFromHistory[t]<this.historyStorage[t].length)}),s.isUser()&&n.findAndSplice(e=>"members"===e.type),!n.length)return;const a=t?50:Math.round(3*(mt.windowH/130|0)*1.25),o=n.map(e=>this.loadType(e,t,a,i));return Promise.all(o).catch(e=>{this.log.error("Load error all promises:",e)})}))}getMonthContainerByTimestamp(e,t){var s;const i=new Date(1e3*e);i.setHours(0,0,0),i.setDate(1);const n=i.getTime(),a=null!==(s=this.monthContainers[t])&&void 0!==s?s:this.monthContainers[t]={};if(!(n in a)){const e=document.createElement("div");e.className="search-super-month";const s=document.createElement("div");s.classList.add("search-super-month-name");const o={month:"long"};i.getFullYear()!==(new Date).getFullYear()&&(o.year="numeric");const r=new O.default.IntlDateElement({date:i,options:o}).element;s.append(r),e.append(s);const l=document.createElement("div");l.classList.add("search-super-month-items"),e.append(s,l);const d=Object(m.e)(a,"desc");let c=0;for(;c<d.length;++c){if(n>d[c])break}a[n]={container:e,items:l},Ha(e,this.tabs[t],c)}return a[n]}canViewMembers(){return this.searchContext.peerId.isAnyChat()&&!Pe.isBroadcast(this.searchContext.peerId.toChatId())&&Pe.hasRights(this.searchContext.peerId.toChatId(),"view_participants")}cleanup(){this.loadPromises={},this.loaded={},this.loadedChats=!1,this.nextRates={},this.firstLoad=!0,this.lazyLoadQueue.clear(),this.mediaTabs.forEach(e=>{this.usedFromHistory[e.inputFilter]=-1}),this.selection.isSelecting&&this.selection.cancelSelection(),this.middleware.clean(),this.cleanScrollPositions(),this.membersList=void 0,this.membersParticipantMap=void 0}cleanScrollPositions(){this.mediaTabs.forEach(e=>{e.scroll=void 0})}cleanupHTML(e=!1){this.urlsToRevoke.length&&(this.urlsToRevoke.forEach(e=>{URL.revokeObjectURL(e)}),this.urlsToRevoke.length=0),this.mediaTabs.forEach(e=>{if(e.contentTab.innerHTML="",this.hideEmptyTabs&&(this.container.classList.add("hide"),this.container.parentElement.classList.add("search-empty")),"chats"!==e.type){if("private"===e.type||"public"===e.type||"global"===e.type){const t=e.contentTab.parentElement;t.querySelector(".preloader")||Object(hi.f)(t,!0)}if(!this.historyStorage[e.inputFilter]){const t=e.contentTab.parentElement;if(t){t.querySelector(".preloader")||Object(hi.f)(t,!0);const e=t.querySelector(".content-empty");e&&e.remove()}}}}),this.monthContainers={},this.searchGroupMedia.clear(),this.scrollable.scrollTop=0}copySearchContext(e){const t=Object(m.a)(this.searchContext);return t.inputFilter={_:e},t.nextRate=this.nextRates[e],t}setQuery({peerId:e,query:t,threadId:s,historyStorage:i,folderId:n,minDate:a,maxDate:o}){this.searchContext={peerId:e,query:t||"",inputFilter:{_:this.mediaTab.inputFilter},threadId:s,folderId:n,minDate:a,maxDate:o},this.historyStorage=null!=i?i:{},this.cleanup()}static subSearchSuperTabs(e){const t=document.createElement("div");t.classList.add("sub-search-super-tabs-scrollable","menu-horizontal-scrollable","sticky");const s=new re.a(t);s.container.classList.add("sub-search-super-nav-scrollable");const i=document.createElement("div");i.classList.add("sub-search-super-tabs","menu-horizontal-div"),s.container.append(i),["all","text","image","video","music","file"].forEach(e=>{const t=document.createElement("div");t.dataset.type=e,t.classList.add("sub-search-super-item","menu-horizontal-div-item"),"all"===e&&t.classList.add("active");const s=document.createElement("span"),n=document.createElement("i");switch(e){case"all":s.append(Object(O.i18n)("Eitaa.SubSearchSuper.All"));break;case"text":s.append(Object(O.i18n)("Eitaa.SubSearchSuper.Text"));break;case"image":s.append(Object(O.i18n)("Eitaa.SubSearchSuper.Image"));break;case"video":s.append(Object(O.i18n)("Eitaa.SubSearchSuper.Video"));break;case"music":s.append(Object(O.i18n)("Eitaa.SubSearchSuper.Music"));break;case"file":s.append(Object(O.i18n)("Eitaa.SubSearchSuper.File"))}s.append(n),t.append(s),Object(ei.ripple)(t),i.append(t)}),e.prepend(t)}}!function(e){e[e.Everybody=2]="Everybody",e[e.Contacts=1]="Contacts",e[e.Nobody=0]="Nobody"}(so||(so={}));const oo=new class{constructor(){this.privacy={},H.default.addMultipleEventsListeners({updatePrivacy:e=>{const t=e.key._;this.privacy[t]=e.rules,H.default.dispatchEvent("privacy_update",e)}})}setPrivacy(e,t){return F.a.invokeApi("account.setPrivacy",{key:{_:e},rules:t}).then(s=>(ye.saveApiUsers(s.users),Pe.saveApiChats(s.chats),Ie.processLocalUpdate({_:"updatePrivacy",key:{_:Object(A.b)(e)},rules:t.map(e=>{const t={};return Object.assign(t,e),t._=Object(A.b)(t._),t})}),s.rules))}getPrivacy(e){const t=Object(A.b)(e);return this.privacy[t]=F.a.invokeApi("account.getPrivacy",{key:{_:e}}).then(e=>(ye.saveApiUsers(e.users),Pe.saveApiChats(e.chats),this.privacy[t]=e.rules))}getPrivacyRulesDetails(e){const t=[];let s={users:[],chats:[]},i={users:[],chats:[]};return e.forEach(e=>{switch(e._){case"privacyValueAllowAll":t.push(2);break;case"privacyValueDisallowAll":t.push(0);break;case"privacyValueAllowContacts":t.push(1);break;case"privacyValueAllowChatParticipants":s.chats.push(...e.chats);break;case"privacyValueAllowUsers":s.users.push(...e.users);break;case"privacyValueDisallowChatParticipants":i.chats.push(...e.chats);break;case"privacyValueDisallowUsers":i.users.push(...e.users)}}),{type:t[0],disallowPeers:i,allowPeers:s}}};j.a.appPrivacyManager=oo;var ro=oo,lo=s(171);class co{constructor(e){this.size=e,this.needFrame=0,this.container=document.createElement("div"),this.container.classList.add("media-sticker-wrapper")}load(){return this.loadPromise?this.loadPromise:this.loadPromise=pi.b.loadAnimationFromURL({container:this.container,loop:!1,autoplay:!0,width:this.size,height:this.size,noCache:!0},"assets/img/animatedLock.tgs").then(e=>(this.animation=e,this.animation.play(),pi.b.waitForFirstFrame(e)))}remove(){this.animation&&this.animation.remove()}}class ho extends Ys{init(){this.container.classList.add("two-step-verification","two-step-verification-set"),this.setTitle("TwoStepVerificationPasswordSet");const e=new fr({caption:"TwoStepVerificationPasswordSetInfo",noDelimiter:!0}),t=Ea.getAnimatedEmojiSticker("ðŸ¥³"),s=document.createElement("div");t?Da({doc:t,div:s,loop:!0,play:!0,width:160,height:160}).then(()=>{}):s.classList.add("media-sticker-wrapper"),e.content.append(s);const i=e.generateContentElement(),n=document.createElement("div");n.classList.add("input-wrapper");const a=Object(Ks.a)("btn-primary btn-color-primary",{text:"TwoStepVerificationPasswordReturnSettings"});Object(v.b)(a,e=>{this.close()}),this.slider.sliceTabsUntilTab(rr,this),n.append(a),i.append(n),this.scrollable.container.append(e.container)}}var uo=s(184);function po(e){return!C.IS_MOBILE_SAFARI||!e}class go extends Ys{constructor(){super(...arguments),this.isFirst=!1}init(){this.container.classList.add("two-step-verification","two-step-verification-email-confirmation"),this.setTitle("TwoStepAuth.RecoveryTitle");const e=new fr({caption:!0,noDelimiter:!0});Object(O._i18n)(e.caption,"TwoStepAuth.ConfirmEmailCodeDesc",[this.email]);const t=Ea.getAnimatedEmojiSticker("ðŸ“¬"),s=document.createElement("div");t?Da({doc:t,div:s,loop:!1,play:!0,width:160,height:160,emoji:"ðŸ“¬"}).then(()=>{}):s.classList.add("media-sticker-wrapper"),e.content.append(s);const i=e.generateContentElement(),n=document.createElement("div");n.classList.add("input-wrapper");const a=this.codeInputField=new uo.a({name:"recovery-email-code",label:"TwoStepAuth.RecoveryCode",length:this.length,onFill:e=>{d(!0),lo.a.confirmPasswordEmail(""+e).then(e=>{l()}).catch(e=>{switch(e.type){case"CODE_INVALID":a.input.classList.add("error"),Object(le.a)(a.label,Object(O.i18n)("TwoStepAuth.RecoveryCodeInvalid"));break;case"EMAIL_HASH_EXPIRED":a.input.classList.add("error"),Object(le.a)(a.label,Object(O.i18n)("TwoStepAuth.RecoveryCodeExpired"));break;default:console.error("confirm error",e)}d(!1)})}}),o=Object(Ks.a)("btn-primary btn-primary-transparent primary",{text:"TwoStepAuth.EmailCodeChangeEmail"}),r=Object(Ks.a)("btn-primary btn-secondary btn-primary-transparent primary",{text:"ResendCode"}),l=()=>{new ho(this.slider).open()},d=e=>{Object(tn.a)([a.input,o,r],e)};Object(v.b)(o,e=>{d(!0),lo.a.cancelPasswordEmail().then(e=>{this.slider.sliceTabsUntilTab(fo,this),this.close()},()=>{d(!1)})}),Object(v.b)(r,e=>{d(!0);const t=Object(hi.f)(r);lo.a.resendPasswordEmail().then(e=>{t.remove(),d(!1)})}),n.append(a.container,o,r),i.append(n),this.scrollable.container.append(e.container)}onOpenAfterTimeout(){po(this.isFirst)&&this.codeInputField.input.focus()}}class mo{constructor(e){this.size=e,this.needFrame=0,this.container=document.createElement("div"),this.container.classList.add("media-sticker-wrapper")}load(){return this.loadPromise?this.loadPromise:this.loadPromise=pi.b.loadAnimationFromURL({container:this.container,loop:!1,autoplay:!0,width:this.size,height:this.size,noCache:!0},"assets/img/animatedMailBox.tgs").then(e=>(this.animation=e,this.animation.play(),pi.b.waitForFirstFrame(e)))}remove(){this.animation&&this.animation.remove()}}class fo extends Ys{constructor(){super(...arguments),this.isFirst=!1}init(){this.container.classList.add("two-step-verification","two-step-verification-email"),this.setTitle("RecoveryEmailTitle");const e=new fr({caption:!0,noDelimiter:!0}),t=document.createElement("div"),s=new mo(170);t.append(s.container),e.content.append(t);const i=e.generateContentElement(),n=document.createElement("div");n.classList.add("input-wrapper");const a=this.inputField=new Ws.b({name:"recovery-email",label:"RecoveryEmail",plainText:!0});a.input.addEventListener("keypress",e=>{if("Enter"===e.key)return Object(f.a)(e),c()}),a.input.addEventListener("input",e=>{a.input.classList.remove("error")});const o=Object(Ks.a)("btn-primary btn-color-primary",{text:"Continue"}),r=Object(Ks.a)("btn-primary btn-secondary btn-primary-transparent primary",{text:"YourEmailSkip"}),l=e=>{e?(o.setAttribute("disabled","true"),r.setAttribute("disabled","true")):(o.removeAttribute("disabled"),r.removeAttribute("disabled"))},d=()=>{new ho(this.slider).open()},c=()=>{const e=a.value.trim(),t=N.b.matchEmail(e);if(!t||t[0].length!==e.length)return void a.input.classList.add("error");l(!0);const s=Object(hi.f)(o);lo.a.updateSettings({hint:this.hint,currentPassword:this.plainPassword,newPassword:this.newPassword,email:e}).then(e=>{d()},t=>{if(t.type.includes("EMAIL_UNCONFIRMED")){const s=+t.type.match(/^EMAIL_UNCONFIRMED_(\d+)/)[1],i=new go(this.slider);i.state=this.state,i.email=e,i.length=s,i.open()}else console.log("password set error",t);l(!1),s.remove()})};Object(v.b)(o,c),Object(v.b)(s.container,()=>{s.animation.play()}),Object(v.b)(r,e=>{new en("popup-skip-email",{buttons:[{langKey:"Cancel",isCancel:!0},{langKey:"YourEmailSkip",callback:()=>{l(!0),Object(hi.f)(r),lo.a.updateSettings({hint:this.hint,currentPassword:this.plainPassword,newPassword:this.newPassword,email:""}).then(()=>{d()},e=>{l(!1)})},isDanger:!0}],titleLangKey:"YourEmailSkipWarning",descriptionLangKey:"YourEmailSkipWarningText"}).show()}),n.append(a.container,o,r),i.append(n),this.scrollable.container.append(e.container),s.load()}onOpenAfterTimeout(){po(this.isFirst)&&this.inputField.input.focus()}}var vo=s(181),bo=s(178),yo=s(187),wo=s(188);class So{constructor(e){this.size=e,this.needFrame=0,this.container=document.createElement("div"),this.container.classList.add("media-sticker-wrapper")}load(){return this.loadPromise?this.loadPromise:this.loadPromise=pi.b.loadAnimationFromURL({container:this.container,loop:!0,autoplay:!0,width:this.size,height:this.size,noCache:!0},"assets/img/animatedTimer.tgs").then(e=>(this.animation=e,this.animation.play(),pi.b.waitForFirstFrame(e)))}remove(){this.animation&&this.animation.remove()}}class Io extends Ys{init(){this.container.classList.add("two-step-verification","two-step-verification-main"),this.setTitle("TwoStepVerificationCallTitle");const e=new fr({caption:!0,noDelimiter:!0});let t;const s=document.createElement("div"),i=new So(170);s.append(i.container),e.content.append(s);const n=document.createElement("span");n.classList.add("timer"),Object(wo.a)(n,this.timeStamp,()=>{n.textContent=""});const a=e.generateContentElement();Object(O._i18n)(e.caption,"TwoStepAuth.VerificationCodeHelp",[n]);const o=document.createElement("div");o.classList.add("input-wrapper");const r=new uo.a({label:"Code",name:Object(x.b)(),length:5,onFill:e=>{l(e)}});t=r.input,o.append(r.container),a.append(o);const l=e=>{St.a.invokeApi("verifyTwoStepVerificationCode",{phone_code:e,phone_code_hash:this.authCode.phone_code_hash}).then(e=>{if(e){const e=new fo(this.slider);e.state=this.state,e.plainPassword=this.plainPassword,e.newPassword=this.newPassword,e.hint=this.hint,e.open()}else r.input.classList.add("error")}).catch(e=>{r.input.classList.add("error")})};this.scrollable.container.append(e.container),i.load()}}class Mo extends Ys{init(){this.container.classList.add("two-step-verification","two-step-verification-main"),this.setTitle("TwoStepVerificationCallTitle");const e=new fr({caption:!0,noDelimiter:!0}),t=Ea.getAnimatedEmojiSticker("ðŸ”"),s=document.createElement("div");t?Da({doc:t,div:s,loop:!1,play:!0,width:168,height:168,emoji:"ðŸ”"}).then(()=>{}):s.classList.add("media-sticker-wrapper"),e.content.append(s);const i=e.generateContentElement();Object(O._i18n)(e.caption,"TwoStepAuth.CallHelp");const n=document.createElement("div");n.classList.add("input-wrapper");const a=Object(Ks.a)("btn-primary btn-color-primary",{text:"TwoStepAuth.CallMe"});n.append(a),i.append(n),Object(v.b)(a,e=>{St.a.invokeApi("sendTwoStepVerificationCode").then(e=>{const t=new Io(this.slider);t.state=this.state,t.plainPassword=this.plainPassword,t.newPassword=this.newPassword,t.hint=this.hint,t.authCode=e,t.timeStamp=e.timeout,t.open()}).catch(e=>{if("CALL_VERIFY"===e.type){const e=new fo(this.slider);e.state=this.state,e.plainPassword=this.plainPassword,e.newPassword=this.newPassword,e.hint=this.hint,e.open()}})}),this.scrollable.container.append(e.container)}}class Co{constructor(e){this.size=e,this.needFrame=0,this.container=document.createElement("div"),this.container.classList.add("media-sticker-wrapper")}load(){return this.loadPromise?this.loadPromise:this.loadPromise=pi.b.loadAnimationFromURL({container:this.container,loop:!1,autoplay:!0,width:this.size,height:this.size,noCache:!0},"assets/img/animatedLamp.tgs").then(e=>(this.animation=e,this.animation.play(),pi.b.waitForFirstFrame(e)))}remove(){this.animation&&this.animation.remove()}}class Po extends Ys{init(){this.container.classList.add("two-step-verification","two-step-verification-hint"),this.setTitle("TwoStepAuth.SetupHintTitle");const e="account.password"!==this.state._&&"account.password2"!==this.state._||!this.plainPassword,t=new fr({noDelimiter:!0}),s=document.createElement("div"),i=new Co(170);s.append(i.container),t.content.append(s);const n=document.createElement("div");n.classList.add("input-wrapper");const a=this.inputField=new Ws.b({name:"hint",label:"TwoStepAuth.SetupHintPlaceholder"});a.input.addEventListener("keypress",e=>{if("Enter"===e.key)return Object(f.a)(e),a.value?d():c()}),Object(v.b)(i.container,()=>{i.animation.play()});const o=(t,s)=>{t&&Object(f.a)(t);const i=s?a.value:void 0;if(i&&this.newPassword===i)Qt(O.default.format("PasswordAsHintError",!0));else if(e){const e=new Mo(this.slider);e.state=this.state,e.plainPassword=this.plainPassword,e.newPassword=this.newPassword,e.hint=i,e.open()}else{const e=new fo(this.slider);e.state=this.state,e.plainPassword=this.plainPassword,e.newPassword=this.newPassword,e.hint=i,e.open()}},r=Object(Ks.a)("btn-primary btn-color-primary",{text:"Continue"}),l=Object(Ks.a)("btn-primary btn-secondary btn-primary-transparent primary",{text:"YourEmailSkip"}),d=e=>o(e,!0),c=e=>o(e,!1);Object(v.b)(r,d),Object(v.b)(l,c),n.append(a.container,r,l),t.content.append(n),this.scrollable.container.append(t.container),i.load()}onOpenAfterTimeout(){this.inputField.input.focus()}}class Lo extends Ys{init(){this.container.classList.add("two-step-verification","two-step-verification-enter-password","two-step-verification-re-enter-password"),this.setTitle("PleaseReEnterPassword");const e=new fr({noDelimiter:!0}),t=document.createElement("div");t.classList.add("input-wrapper");const s=this.passwordInputField=new bo.a({name:"re-enter-password",label:"PleaseReEnterPassword"}),i=new yo.a(170),n=Object(Ks.a)("btn-primary btn-color-primary",{text:"Continue"});t.append(s.container,n),e.content.append(i.container,t),this.scrollable.container.append(e.container),s.input.addEventListener("keypress",e=>{if(s.input.classList.contains("error")&&s.setState(Ws.a.Neutral),"Enter"===e.key)return o()});const a=()=>this.newPassword===s.value||(s.setError(),!1),o=e=>{if(e&&Object(f.a)(e),!a())return;const t=new Po(this.slider);t.state=this.state,t.plainPassword=this.plainPassword,t.newPassword=this.newPassword,t.open()};Object(v.b)(n,o),i.load()}onOpenAfterTimeout(){this.passwordInputField.input.focus()}}class Eo extends Ys{constructor(){super(...arguments),this.isFirst=!0}init(){const e="account.password"!==this.state._&&"account.password2"!==this.state._||this.plainPassword;this.container.classList.add("two-step-verification","two-step-verification-enter-password"),this.setTitle(e?"PleaseEnterFirstPassword":"PleaseEnterCurrentPassword");const t=new fr({noDelimiter:!0}),s=document.createElement("div");let i;s.classList.add("input-wrapper"),i="account.password"===this.state._||"account.password2"===this.state._?this.passwordInputField=new bo.a({name:"enter-password",label:e?"PleaseEnterFirstPassword":this.state.hint?void 0:"LoginPassword",labelText:!e&&this.state.hint?N.b.wrapEmojiText(this.state.hint):void 0}):this.passwordInputField=new bo.a({name:"enter-password",label:"PleaseEnterFirstPassword",labelText:void 0});const n=new vo.a(170),a=Object(Ks.a)("btn-primary btn-color-primary"),o=new O.default.IntlElement({key:"Continue"});a.append(o.element),s.append(i.container,a),t.content.append(n.container,s),this.scrollable.container.append(t.container),i.input.addEventListener("keypress",e=>{if(i.input.classList.contains("error")&&(i.input.classList.remove("error"),o.key="Continue",o.update()),"Enter"===e.key)return l()});const r=()=>!!i.value.length||(i.input.classList.add("error"),!1);let l;if(e)l=e=>{if(e&&Object(f.a)(e),!r())return;const t=new Lo(this.slider);t.state=this.state,t.newPassword=i.value,t.plainPassword=this.plainPassword,t.open()};else{let e,t=()=>(e||(e=window.setInterval(t,1e4)),lo.a.getState().then(e=>{"account.password"!==e._&&"account.password2"!==e._||(this.state=e,this.state.hint?Object(xe.a)(i.label,N.b.wrapEmojiText(this.state.hint)):Object(le.a)(i.label,Object(O.i18n)("LoginPassword")))}));l=s=>{if(!r())return void Object(f.a)(s);a.setAttribute("disabled","true"),o.key="PleaseWait",o.update();const l=Object(hi.f)(a),d=i.value;lo.a.check2StepPassword(i.value,this.state).then(t=>{if(console.log(t),"account.passwordSettings68"===t._){clearInterval(e),n&&n.remove();const t=new _o(this.slider);t.state=this.state,t.plainPassword=d,t.open(),this.slider.removeTabFromHistory(this)}},e=>{a.removeAttribute("disabled"),i.input.classList.add("error"),e.type,o.key="TwoStepAuth.InvalidPassword",o.update(),l.remove(),i.select(),t()})},t()}return Object(v.b)(a,l),Object(v.b)(n.container,()=>{n.animation.play()}),n.load()}onOpenAfterTimeout(){po(this.isFirst)&&this.passwordInputField.input.focus()}}class _o extends Ys{init(){this.container.classList.add("two-step-verification","two-step-verification-main"),this.setTitle("TwoStepVerificationTitle");const e=new fr({caption:!0,noDelimiter:!0}),t=document.createElement("div"),s=new co(170);t.append(s.container),e.content.append(t);const i=e.generateContentElement();if(this.stateChecker=()=>{lo.a.getState().then(e=>{e._!==this.state._&&(this.slider.sliceTabsUntilTab(rr,this),this.close())}),setTimeout(this.stateChecker,4e3)},"account.password"===this.state._||"account.password2"===this.state._){this.state.email_unconfirmed_pattern?Object(O._i18n)(e.caption,"TwoStepAuth.ActivateRecoveryEmail",[this.state.email_unconfirmed_pattern]):Object(O._i18n)(e.caption,"TwoStepAuth.GenericHelp");const t=Object(Ks.a)("btn-primary btn-transparent",{icon:"edit",text:"TwoStepAuth.ChangePassword"}),n=Object(Ks.a)("btn-primary btn-transparent",{icon:"passwordoff",text:"TwoStepAuth.RemovePassword"}),a=Object(Ks.a)("btn-primary btn-transparent",{icon:"email",text:this.state.pFlags.has_recovery?"TwoStepAuth.ChangeEmail":"TwoStepAuth.SetupEmail"});Object(v.b)(t,()=>{const e=new Eo(this.slider);e.state=this.state,e.plainPassword=this.plainPassword,e.open()}),Object(v.b)(s.container,()=>{s.animation.play()}),Object(v.b)(n,()=>{new en("popup-disable-password",{buttons:[{langKey:"Disable",callback:()=>{lo.a.updateSettings({currentPassword:this.plainPassword}).then(()=>{this.slider.sliceTabsUntilTab(rr,this),this.close()})},isDanger:!0}],titleLangKey:"TurnPasswordOffQuestionTitle",descriptionLangKey:"TurnPasswordOffQuestion"}).show()}),Object(v.b)(a,()=>{if("account.password"===this.state._||"account.password2"===this.state._){const e=new fo(this.slider);e.state=this.state,e.hint=this.state.hint,e.plainPassword=this.plainPassword,e.newPassword=this.plainPassword,e.isFirst=!0,e.open()}}),i.append(t,n,a)}else{Object(O._i18n)(e.caption,"TwoStepAuth.SetPasswordHelp");const t=document.createElement("div");t.classList.add("input-wrapper");const s=Object(Ks.a)("btn-primary btn-color-primary",{text:"TwoStepVerificationSetPassword"});t.append(s),i.append(t),Object(v.b)(s,e=>{const t=new Eo(this.slider);t.state=this.state,t.open()})}this.scrollable.container.append(e.container),s.load(),this.stateChecker()}onClose(){clearTimeout(this.stateChecker)}}class ko{constructor(e){this.options=e,this.onRadioChange=e=>{e=+e,this.type=e;const t=this.options.captions[this.type],s=this.radioSection.caption;t?Object(O._i18n)(s,t):s.innerHTML="",s.classList.toggle("hide",!t),this.exceptions&&(this.exceptions.get("allow").row.container.classList.toggle("hide",this.type===so.Everybody),this.exceptions.get("disallow").row.container.classList.toggle("hide",this.type===so.Nobody)),this.options.onRadioChange&&this.options.onRadioChange(e)},e.captions&&e.captions.reverse(),this.radioSection=new fr({name:e.title,caption:!0}),this.radioRows=new Map;let t=[{type:so.Everybody,langKey:"PrivacySettingsController.Everbody"},{type:so.Contacts,langKey:"PrivacySettingsController.MyContacts"},{type:so.Nobody,langKey:"PrivacySettingsController.Nobody"}];"inputPrivacyKeyStatusTimestamp"===e.inputKey&&(t=t.filter(e=>e.type!==so.Contacts));const s=Object(x.b)();t.forEach(({type:e,langKey:t})=>{const i=new Qi({radioField:new Xi({langKey:t,name:s,value:""+e})});this.radioRows.set(e,i)});const i=$i([...this.radioRows.values()],this.onRadioChange);if(this.radioSection.content.append(i),e.appendTo&&e.appendTo.append(this.radioSection.container),!e.noExceptions&&"inputPrivacyKeyStatusTimestamp"!==e.inputKey){const t=vr(e.appendTo,"PrivacyExceptions","PrivacySettingsController.PeerInfo");this.exceptions=new Map([["disallow",{titleLangKey:e.exceptionTexts[0],key:"disallow",row:null,icon:"deleteuser",subtitleLangKey:"PrivacySettingsController.AddUsers",clickable:!0}],["allow",{titleLangKey:e.exceptionTexts[1],key:"allow",row:null,icon:"adduser",subtitleLangKey:"PrivacySettingsController.AddUsers",clickable:!0}]]),this.exceptions.forEach(s=>{s.row=new Qi(s),s.row.container.addEventListener("click",()=>{n.then(()=>{const t=this.peerIds[s.key];new Pn(e.tab.slider).open({type:"privacy",skippable:!0,title:s.titleLangKey,placeholder:"PrivacyModal.Search.Placeholder",takeOut:e=>{t.length=0,t.push(...e),s.row.subtitle.innerHTML="",s.row.subtitle.append(...this.generateStr(this.splitPeersByType(e)))},selectedPeerIds:t})})}),t.append(s.row.container)})}const n=ro.getPrivacy(e.inputKey).then(t=>{const s=ro.getPrivacyRulesDetails(t);this.setRadio(s.type),this.exceptions&&(this.peerIds={},["allow","disallow"].forEach(e=>{const t=[],i="allow"===e?s.allowPeers:s.disallowPeers;t.push(...i.users.map(e=>e.toPeerId())),t.push(...i.chats.map(e=>e.toPeerId(!0))),this.peerIds[e]=t;const n=this.exceptions.get(e).row.subtitle;n.innerHTML="",n.append(...this.generateStr(i))})),e.tab.eventListener.addEventListener("destroy",()=>{const t=[];switch(this.type){case so.Everybody:t.push({_:"inputPrivacyValueAllowAll"});break;case so.Contacts:t.push({_:"inputPrivacyValueAllowContacts"});break;case so.Nobody:t.push({_:"inputPrivacyValueDisallowAll"})}this.exceptions&&[["allow","inputPrivacyValueAllowChatParticipants","inputPrivacyValueAllowUsers"],["disallow","inputPrivacyValueDisallowChatParticipants","inputPrivacyValueDisallowUsers"]].forEach(([e,s,i],n)=>{if(this.exceptions.get(e).row.container.classList.contains("hide"))return;const a=this.peerIds[e];if(a){const e=this.splitPeersByType(a);e.chats.length&&t.push({_:s,chats:e.chats}),e.users.length&&t.push({_:i,users:e.users.map(e=>ye.getUserInput(e))})}}),ro.setPrivacy(e.inputKey,t)},{once:!0})})}setRadio(e){const t=this.radioRows.get(e);this.onRadioChange(e),t.radioField.input.checked=!0}splitPeersByType(e){const t={users:[],chats:[]};return e.forEach(e=>{t[e.isAnyChat()?"chats":"users"].push(e.isAnyChat()?e.toChatId():e)}),t}generateStr(e){return e.users.length||e.chats.length?Object(O.join)([e.users.length?Object(O.i18n)("Users",[e.users.length]):null,e.chats.length?Object(O.i18n)("Chats",[e.chats.length]):null].filter(Boolean),!1):[Object(O.i18n)("PrivacySettingsController.AddUsers")]}}class To extends Xs{init(){this.container.classList.add("privacy-tab","privacy-last-seen"),this.setTitle("PrivacyLastSeen");const e="PrivacySettingsController.LastSeenDescription";new ko({tab:this,title:"LastSeenTitle",inputKey:"inputPrivacyKeyStatusTimestamp",captions:[e,e,e],exceptionTexts:["PrivacySettingsController.NeverShare","PrivacySettingsController.AlwaysShare"],appendTo:this.scrollable})}}class xo extends Xs{init(){this.container.classList.add("privacy-tab","privacy-add-to-groups"),this.setTitle("PrivacySettings.Groups");const e="PrivacySettingsController.GroupDescription";new ko({tab:this,title:"WhoCanAddMe",inputKey:"inputPrivacyKeyChatInvite",captions:[e,e,e],exceptionTexts:["PrivacySettingsController.NeverAllow","PrivacySettingsController.AlwaysAllow"],appendTo:this.scrollable,skipTypes:[so.Nobody]})}}class Ao extends Ys{init(){this.container.classList.add("active-sessions-container"),this.setTitle("SessionsTitle");const e=e=>{const t=new Qi({title:[e.app_name,e.app_version].join(" "),subtitle:[e.ip,e.country].join(" - "),clickable:!0,titleRight:e.pFlags.current?void 0:Object(S.b)(new Date(1e3*Math.max(e.date_active,e.date_created)))});t.container.dataset.hash=""+e.hash;const s=document.createElement("div");return s.classList.add("row-midtitle"),s.innerHTML=[e.device_model,e.system_version||e.platform].filter(Boolean).join(", "),t.subtitle.parentElement.insertBefore(s,t.subtitle),t},t=this.authorizations.slice();{const n=new fr({name:"CurrentSession"}),a=t.findAndSplice(e=>e.pFlags.current),o=e(a);if(n.content.append(o.container),t.length){const e=Object(Ks.a)("btn-primary btn-transparent danger",{icon:"stop",text:"TerminateAllSessions"});Object(v.b)(e,t=>{new en("revoke-session",{buttons:[{langKey:"Terminate",isDanger:!0,callback:()=>{const t=Object(tn.a)([e],!0);F.a.invokeApi("auth.resetAuthorizations").then(t=>{e.remove(),s.container.remove(),this.privacyTab.updateActiveSessions()},i).finally(()=>{t()})}}],titleLangKey:"AreYouSureSessionsTitle",descriptionLangKey:"AreYouSureSessions"}).show()}),n.content.append(e)}this.scrollable.append(n.container)}if(!t.length)return;const s=new fr({name:"OtherSessions"});t.forEach(t=>{s.content.append(e(t).container)}),this.scrollable.append(s.container);const i=e=>{"FRESH_RESET_AUTHORISATION_FORBIDDEN"===e.type&&Qt(O.default.format("RecentSessions.Error.FreshReset",!0))};let n;const a=()=>{const e=n.dataset.hash;new en("revoke-session",{buttons:[{langKey:"Terminate",isDanger:!0,callback:()=>{F.a.invokeApi("account.resetAuthorization",{hash:e}).then(e=>{e&&(n.remove(),this.privacyTab.updateActiveSessions())},i)}}],titleLangKey:"AreYouSureSessionTitle",descriptionLangKey:"TerminateSessionText"}).show()},o=this.menuElement=Mi([{icon:"stop",text:"Terminate",onClick:a}]);o.id="active-sessions-contextmenu",o.classList.add("contextmenu"),document.getElementById("page-chats").append(o),Object(hi.a)(this.scrollable.container,e=>{n=Object(ti.a)(e.target,"row"),n&&"0"!==n.dataset.hash&&(e instanceof MouseEvent&&e.preventDefault(),e instanceof MouseEvent&&(e.cancelBubble=!0),Object(hi.e)(e,o),Object(hi.d)(o))}),Object(v.b)(this.scrollable.container,e=>{n=Object(ti.a)(e.target,"row"),n&&"0"!==n.dataset.hash&&a()})}onCloseAfterTimeout(){return this.menuElement&&this.menuElement.remove(),super.onCloseAfterTimeout()}}class Oo extends Ys{init(){this.container.classList.add("blocked-users-container"),this.setTitle("BlockedUsers");{const e=new fr({caption:"BlockedUsersInfo"});this.scrollable.append(e.container)}const e=li({icon:"add",className:"is-visible"});this.content.append(e),Object(v.b)(e,e=>{new un({peerTypes:["contacts"],placeholder:"BlockModal.Search.Placeholder",onSelect:e=>{ye.toggleBlock(e,!0)}})},{listenerSetter:this.listenerSetter});const t=Jd.createChatList();this.scrollable.container.classList.add("chatlist-container"),this.scrollable.append(t);const s=(e,s)=>{const{dom:i}=Jd.addDialogNew({dialog:e,container:t,drawStatus:!1,rippleEnabled:!0,avatarSize:48,append:s}),n=ye.getUser(e);n.pFlags.bot?i.lastMessageSpan.append("@"+n.username):n.phone?i.lastMessageSpan.innerHTML=ye.formatUserPhone(n.phone):i.lastMessageSpan.append(n.username?"@"+n.username:ye.getUserStatusString(e))};for(const e of this.peerIds)s(e,!0);let i;const n=this.menuElement=Mi([{icon:"lockoff",text:"Unblock",onClick:()=>{const e=i.dataset.peerId.toPeerId();ye.toggleBlock(e,!1)},options:{listenerSetter:this.listenerSetter}}]);n.id="blocked-users-contextmenu",n.classList.add("contextmenu"),document.getElementById("page-chats").append(n),Object(hi.a)(this.scrollable.container,e=>{i=Object(nn.a)(e.target,"LI"),i&&(e instanceof MouseEvent&&e.preventDefault(),e instanceof MouseEvent&&(e.cancelBubble=!0),Object(hi.e)(e,n),Object(hi.d)(n))},this.listenerSetter),this.listenerSetter.add(H.default)("peer_block",e=>{const{peerId:i,blocked:n}=e,a=t.querySelector(`[data-peer-id="${i}"]`);n?a||s(i,!1):a&&a.remove()});let a=!1;this.scrollable.onScrolledBottom=()=>{a||(a=!0,ye.getBlocked(t.childElementCount,50).then(e=>{for(const t of e.peerIds)s(t,!0);(e.peerIds.length<50||t.childElementCount===e.count)&&(this.scrollable.onScrolledBottom=null),this.scrollable.checkForTriggers()}).finally(()=>{a=!1}))}}onOpenAfterTimeout(){this.scrollable.onScroll()}onCloseAfterTimeout(){return this.menuElement&&this.menuElement.remove(),super.onCloseAfterTimeout()}}class Fo extends Xs{init(){this.container.classList.add("dont-u-dare-block-me"),this.setTitle("PrivacySettings");{const e=new fr({noDelimiter:!0});let t;const s=new Qi({icon:"deleteuser",titleLangKey:"BlockedUsers",subtitleLangKey:"Loading",clickable:()=>{const e=new Oo(this.slider);e.peerIds=t,e.open()}});let i;s.freezed=!0;const n=new Qi({icon:"lock",titleLangKey:"TwoStepVerification",subtitleLangKey:"Loading",clickable:e=>{let t;"account.password2"===i._?(t=new Eo(this.slider),t.state=i,t.open()):"account.noPassword"===i._&&(t=new _o(this.slider),t.state=i,t.open())}});n.freezed=!0;const a=this.activeSessionsRow=new Qi({icon:"activesessions",titleLangKey:"SessionsTitle",subtitleLangKey:"Loading",clickable:()=>{const e=new Ao(this.slider);e.privacyTab=this,e.authorizations=this.authorizations,e.open()}});a.freezed=!0,e.content.append(s.container,n.container,a.container),this.scrollable.append(e.container);const o=e=>{e?Object(le.a)(s.subtitle,Object(O.i18n)("PrivacySettingsController.UserCount",[e])):Object(le.a)(s.subtitle,Object(O.i18n)("BlockedEmpty",[e]))};this.listenerSetter.add(H.default)("peer_block",()=>{r()});const r=()=>{ye.getBlocked().then(e=>{s.freezed=!1,o(e.count),t=e.peerIds})};r(),lo.a.getState().then(e=>{i=e,n.freezed=!1,"account.password2"===e._?Object(le.a)(n.subtitle,Object(O.i18n)("PrivacyAndSecurity.Item.On")):Object(le.a)(n.subtitle,Object(O.i18n)("PrivacyAndSecurity.Item.Off"))}),this.updateActiveSessions()}{const e=new fr({name:"PrivacyTitle"});e.content.classList.add("privacy-navigation-container");const t={},s=t.inputPrivacyKeyStatusTimestamp=new Qi({titleLangKey:"LastSeenTitle",subtitleLangKey:"Loading",clickable:()=>{new To(this.slider).open()}}),i=t.inputPrivacyKeyChatInvite=new Qi({titleLangKey:"WhoCanAddMe",subtitleLangKey:"Loading",clickable:()=>{new xo(this.slider).open()}}),n=e=>{const s=t[e];s&&ro.getPrivacy(e).then(e=>{const t=ro.getPrivacyRulesDetails(e),i=t.type===so.Everybody?"PrivacySettingsController.Everbody":t.type===so.Contacts?"PrivacySettingsController.MyContacts":"PrivacySettingsController.Nobody",n=t.disallowPeers.users.length+t.disallowPeers.chats.length,a=t.allowPeers.users.length+t.allowPeers.chats.length;s.subtitle.innerHTML="";const o=Object(O.i18n)(i);s.subtitle.append(o),(n||a)&&s.subtitle.append(` (${[-n,a?"+"+a:0].filter(Boolean).join(", ")})`)})};e.content.append(s.container,i.container),this.scrollable.append(e.container);for(const e in t)n(e);H.default.addEventListener("privacy_update",e=>{n(Object(A.c)(e.key._))})}const e=[];{const t=new fr({name:"Privacy.SensitiveContent"});t.container.classList.add("hide"),e.push(F.a.invokeApi("account.getContentSettings").then(e=>{if(!e.pFlags.sensitive_can_change)return;const s=e.pFlags.sensitive_enabled,i=new Qi({checkboxField:new Gi.a({text:"PrivacyAndSecurity.SensitiveText",checked:s}),subtitleLangKey:"PrivacyAndSecurity.SensitiveDesc",noCheckboxSubtitle:!0});t.content.append(i.container),t.container.classList.remove("hide"),this.eventListener.addEventListener("destroy",()=>{const e=i.checkboxField.checked;e!==s&&F.a.invokeApi("account.setContentSettings",{sensitive_enabled:e})},{once:!0})})),this.scrollable.append(t.container)}{const e=new fr({name:"FilterChats"}),t=()=>{new en("popup-delete-drafts",{buttons:[{langKey:"Delete",callback:()=>{const e=Object(tn.a)([s],!0);ls.clearAllDrafts().then(()=>{e()})},isDanger:!0}],titleLangKey:"AreYouSureClearDraftsTitle",descriptionLangKey:"AreYouSureClearDrafts"}).show()},s=Object(Ks.a)("btn-primary btn-transparent",{icon:"delete",text:"PrivacyDeleteCloudDrafts"});this.listenerSetter.add(s)("click",t),e.content.append(s)}return Promise.all(e)}updateActiveSessions(){F.a.invokeApi("account.getAuthorizations").then(e=>{this.activeSessionsRow.freezed=!1,this.authorizations=e.authorizations,Object(O._i18n)(this.activeSessionsRow.subtitle,"Privacy.Devices",[this.authorizations.length])})}}function Do(e){const t=e.getContext("2d"),s=new Array(4).fill(0),i=t.getImageData(0,0,e.width,e.height).data;for(let e=0;e<i.length;e+=4)s[0]+=i[e],s[1]+=i[e+1],s[2]+=i[e+2],s[3]+=i[e+3];const n=i.length/4,a=new Uint8ClampedArray(4);return a[0]=s[0]/n,a[1]=s[1]/n,a[2]=s[2]/n,a[3]=s[3]/n,a}function jo(e){const t=document.createElement("img");return Ze(t,e,!1).then(()=>function(e,t,s){const i=document.createElement("canvas"),n=t/s;return 1===n?(i.width=50,i.height=i.width/n):n>1?(i.height=50,i.width=i.height/n):i.width=i.height=50,i.getContext("2d").drawImage(e,0,0,t,s,0,0,i.width,i.height),Do(i)}(t,t.naturalWidth,t.naturalHeight))}function Ro(e,t,s,i=1){e/=255,t/=255,s/=255;const n=Math.max(e,t,s),a=Math.min(e,t,s);let o,r,l=(n+a)/2;if(n===a)o=r=0;else{let i=n-a;switch(r=l>.5?i/(2-n-a):i/(n+a),n){case e:o=(t-s)/i+(t<s?6:0);break;case t:o=(s-e)/i+2;break;case s:o=(e-t)/i+4}o/=6}return{h:360*o,s:100*r,l:100*l,a:i}}function Bo(e,t,s,i){let n,a,o;if(e/=360,s/=100,0===(t/=100))n=a=o=s;else{const i=function(e,t,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?e+6*(t-e)*s:s<.5?t:s<2/3?e+(t-e)*(2/3-s)*6:e},r=s<.5?s*(1+t):s+t-s*t,l=2*s-r;n=i(l,r,e+1/3),a=i(l,r,e),o=i(l,r,e-1/3)}return[Math.round(255*n),Math.round(255*a),Math.round(255*o),Math.round(255*i)]}function Uo(e){const t=[],s="#"===e[0]?1:0;if(e.length===5+s&&(e=(s?"#":"")+"0"+e.slice(s)),e.length===3+s)for(let i=s;i<e.length;++i)t.push(parseInt(e[i]+e[i],16));else if(e.length===4+s){for(let i=s;i<e.length-1;++i)t.push(parseInt(e[i]+e[i],16));t.push(parseInt(e[e.length-1],16))}else for(let i=s;i<e.length;i+=2)t.push(parseInt(e.slice(i,i+2),16));return t}function No(e){return"#"+e.map(e=>("0"+e.toString(16)).slice(-2)).join("")}function Ho(e){return No(function(e){const t=e.slice(5,-1).split(", "),s=+t.pop(),i=t.map(e=>e.endsWith("%")?+e.slice(0,-1):+e);return Bo(i[0],i[1],i[2],s)}(e))}function zo(e){const t=(e<0?16777215+e:e).toString(16);return"#"+(t.length>=6?t:"0".repeat(6-t.length)+t)}function Wo(e){let{h:t,s:s,l:i}=Ro(e[0],e[1],e[2]);s>0&&(s=Math.min(100,s+5+.1*(100-s))),i=Math.max(0,.65*i);return`hsla(${t}, ${s}%, ${i}%, .4)`}class qo{constructor(){this._width=50,this._height=50,this._tails=90,this._scrollTails=50,this._curve=[0,.25,.5,.75,1,1.5,2,2.5,3,3.5,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,18.3,18.6,18.9,19.2,19.5,19.8,20.1,20.4,20.7,21,21.3,21.6,21.9,22.2,22.5,22.8,23.1,23.4,23.7,24,24.3,24.6,24.9,25.2,25.5,25.8,26.1,26.3,26.4,26.5,26.6,26.7,26.8,26.9,27],this._positions=[{x:.8,y:.1},{x:.6,y:.2},{x:.35,y:.25},{x:.25,y:.6},{x:.2,y:.9},{x:.4,y:.8},{x:.65,y:.75},{x:.75,y:.4}],this._phases=this._positions.length,this.drawNextPositionAnimated=()=>{const e=this._frames,t=e.shift();t&&this.drawImageData(t);const s=e.length;return s||(this._animatingToNextPosition=void 0),!!s};const e=this._tails/this._curve[this._curve.length-1];for(let t=0,s=this._curve.length;t<s;++t)this._curve[t]=this._curve[t]*e;this._incrementalCurve=this._curve.map((e,t,s)=>{var i;return e-(null!==(i=s[t-1])&&void 0!==i?i:0)})}hexToRgb(e){const t=function(e){return Uo(e.slice(0,7))}(e);return{r:t[0],g:t[1],b:t[2]}}getPositions(e){const t=this._positions.slice();for(;e>0;)t.push(t.shift()),--e;const s=[];for(let e=0;e<t.length;e+=2)s.push(t[e]);return s}getNextPositions(e,t,s){const i=this.getPositions(e);if(!s[0]&&1===s.length)return[i];const n=this.getPositions(++e%this._phases).map((e,s)=>({x:(e.x-i[s].x)/t,y:(e.y-i[s].y)/t}));return s.map(e=>n.map((t,s)=>({x:i[s].x+t.x*e,y:i[s].y+t.y*e})))}curPosition(e,t){return this.getNextPositions(e,this._tails,[t])[0]}changeTail(e){for(this._tail+=e;this._tail>=this._tails;)this._tail-=this._tails,++this._phase>=this._phases&&(this._phase-=this._phases);for(;this._tail<0;)this._tail+=this._tails,--this._phase<0&&(this._phase+=this._phases)}getGradientImageData(e){const t=this._hctx.createImageData(this._width,this._height),s=t.data;let i=0;for(let t=0;t<this._height;++t){const n=t/this._height-.5,a=n*n;for(let t=0;t<this._width;++t){const o=t/this._width-.5,r=.35*Math.sqrt(o*o+a),l=r*r*.8*8,d=Math.sin(l),c=Math.cos(l),h=Math.max(0,Math.min(1,.5+o*c-n*d)),u=Math.max(0,Math.min(1,.5+o*d+n*c));let p=0,g=0,m=0,f=0;for(let t=0;t<this._colors.length;t++){const s=h-e[t].x,i=u-e[t].y;let n=Math.max(0,.9-Math.sqrt(s*s+i*i));n*=n*n*n,p+=n,g+=n*this._colors[t].r/255,m+=n*this._colors[t].g/255,f+=n*this._colors[t].b/255}s[i++]=g/p*255,s[i++]=m/p*255,s[i++]=f/p*255,s[i++]=255}}return t}drawImageData(e){this._hctx.putImageData(e,0,0),this._ctx.drawImage(this._hc,0,0,this._width,this._height)}drawGradient(e){this.drawImageData(this.getGradientImageData(e))}init(e){this._frames=[],this._phase=0,this._tail=0,this._scrollDelta=0;const t=e.getAttribute("data-colors").split(",").reverse();this._colors=t.map(e=>this.hexToRgb(e)),this._hc||(this._hc=document.createElement("canvas"),this._hc.width=this._width,this._hc.height=this._height,this._hctx=this._hc.getContext("2d")),this._canvas=e,this._ctx=this._canvas.getContext("2d"),this.update()}update(){if(this._colors.length<2){const e=this._colors[0];return this._ctx.fillStyle=`rgb(${e.r}, ${e.g}, ${e.b})`,void this._ctx.fillRect(0,0,this._width,this._height)}const e=this.curPosition(this._phase,this._tail);this.drawGradient(e)}toNextPosition(){var e;if(this._colors.length<2)return;const t=this._tail,s=this._tails;let i;const n=[];for(let a=0,o=this._incrementalCurve.length;a<o;++a){const o=this._incrementalCurve[a];let r=(null!==(e=n[a-1])&&void 0!==e?e:t)+o;+r.toFixed(2)>s&&void 0===i&&(i=a,r%=s),n.push(r)}[n.slice(0,i),void 0!==i?n.slice(i):[]].forEach((e,t,i)=>{const n=e[e.length-1];if(void 0!==n&&n>s&&(e[e.length-1]=+n.toFixed(2)),this._tail=null!=n?n:0,!e.length)return;const a=this.getNextPositions(this._phase,s,e);t!==i.length-1&&++this._phase>=this._phases&&(this._phase-=this._phases);const o=a.map(e=>this.getGradientImageData(e));this._frames.push(...o)}),this._animatingToNextPosition=!0,Object(Ia.a)(this.drawNextPositionAnimated)}static createCanvas(e){const t=document.createElement("canvas");return t.width=50,t.height=50,void 0!==e&&(t.dataset.colors=e),t}static create(e){const t=this.createCanvas(e),s=new qo;return s.init(t),{gradientRenderer:s,canvas:t}}}class Vo{constructor(){this.hue=0,this.saturation=100,this.lightness=50,this.alpha=1,this.elements={},this.onGrabStart=()=>{document.documentElement.style.cursor=this.elements.boxDragger.style.cursor="grabbing"},this.onGrabEnd=()=>{document.documentElement.style.cursor=this.elements.boxDragger.style.cursor=""},this.container=document.createElement("div"),this.container.classList.add(Vo.BASE_CLASS);const e=`\n      <svg class="${Vo.BASE_CLASS+"-box"}" viewBox="0 0 380 198">\n        <defs>\n          <linearGradient id="color-picker-saturation" x1="0%" y1="0%" x2="100%" y2="0%">\n            <stop offset="0%" stop-color="#fff"></stop>\n            <stop offset="100%" stop-color="hsl(0,100%,50%)"></stop>\n          </linearGradient>\n          <linearGradient id="color-picker-brightness" x1="0%" y1="0%" x2="0%" y2="100%">\n            <stop offset="0%" stop-color="rgba(0,0,0,0)"></stop>\n            <stop offset="100%" stop-color="#000"></stop>\n          </linearGradient>\n          <pattern id="color-picker-pattern" width="100%" height="100%">\n            <rect x="0" y="0" width="100%" height="100%" fill="url(#color-picker-saturation)"></rect>\n            <rect x="0" y="0" width="100%" height="100%" fill="url(#color-picker-brightness)"></rect>\n          </pattern>\n        </defs>\n        <rect rx="10" ry="10" x="0" y="0" width="380" height="198" fill="url(#color-picker-pattern)"></rect>\n        <svg class="${Vo.BASE_CLASS+"-dragger"} ${Vo.BASE_CLASS+"-box-dragger"}" x="0" y="0">\n          <circle r="11" fill="inherit" stroke="#fff" stroke-width="2"></circle>\n        </svg>\n      </svg>\n      <div class="${Vo.BASE_CLASS+"-sliders"}">\n        <svg class="${Vo.BASE_CLASS+"-color-slider"}" viewBox="0 0 380 24">\n          <defs>\n            <linearGradient id="hue" x1="100%" y1="0%" x2="0%" y2="0%">\n              <stop offset="0%" stop-color="#f00"></stop>\n              <stop offset="16.666%" stop-color="#f0f"></stop>\n              <stop offset="33.333%" stop-color="#00f"></stop>\n              <stop offset="50%" stop-color="#0ff"></stop>\n              <stop offset="66.666%" stop-color="#0f0"></stop>\n              <stop offset="83.333%" stop-color="#ff0"></stop>\n              <stop offset="100%" stop-color="#f00"></stop>\n            </linearGradient>\n          </defs>\n          <rect rx="4" ry="4" x="0" y="9" width="380" height="8" fill="url(#hue)"></rect>\n          <svg class="${Vo.BASE_CLASS+"-dragger"} ${Vo.BASE_CLASS+"-color-slider-dragger"}" x="0" y="13">\n            <circle r="11" fill="inherit" stroke="#fff" stroke-width="2"></circle>\n          </svg>\n        </svg>\n      </div>\n    `;this.container.innerHTML=e,this.elements.box=this.container.firstElementChild,this.elements.boxDragger=this.elements.box.lastElementChild,this.elements.saturation=this.elements.box.firstElementChild.firstElementChild,this.elements.sliders=this.elements.box.nextElementSibling,this.elements.hue=this.elements.sliders.firstElementChild,this.elements.hueDragger=this.elements.hue.lastElementChild,this.hexInputField=new Ws.b({plainText:!0,label:"Appearance.Color.Hex"}),this.rgbInputField=new Ws.b({plainText:!0,label:"Appearance.Color.RGB"});const t=document.createElement("div");t.className=Vo.BASE_CLASS+"-inputs",t.append(this.hexInputField.container,this.rgbInputField.container),this.container.append(t),this.hexInputField.input.addEventListener("input",()=>{let e=this.hexInputField.value.replace(/#/g,"").slice(0,6);const t=e.match(/([a-fA-F\d]+)/),s=t&&t[0].length===e.length&&[6].includes(e.length);this.hexInputField.setState(s?Ws.a.Neutral:Ws.a.Error),e="#"+e,this.hexInputField.setValueSilently(e),s&&this.setColor(e,!1,!0)});const s=/^(?:rgb)?\(?([01]?\d\d?|2[0-4]\d|25[0-5])(?:\W+)([01]?\d\d?|2[0-4]\d|25[0-5])\W+(?:([01]?\d\d?|2[0-4]\d|25[0-5])\)?)$/;this.rgbInputField.input.addEventListener("input",()=>{const e=this.rgbInputField.value.match(s);this.rgbInputField.setState(e?Ws.a.Neutral:Ws.a.Error),e&&this.setColor(Ro(+e[1],+e[2],+e[3]),!0,!1)}),this.attachBoxListeners(),this.attachHueListeners()}attachBoxListeners(){wi(this.elements.box,()=>{this.onGrabStart(),this.boxRect=this.elements.box.getBoundingClientRect()},e=>{this.saturationHandler(e.x,e.y)},()=>{this.onGrabEnd()})}attachHueListeners(){wi(this.elements.hue,()=>{this.onGrabStart(),this.hueRect=this.elements.hue.getBoundingClientRect()},e=>{this.hueHandler(e.x)},()=>{this.onGrabEnd()})}setColor(e,t=!0,s=!0){if(void 0===e)e={h:0,s:100,l:50,a:1};else if("string"==typeof e)if("#"===e[0])e=function(e){const t=Uo(e);return Ro(t[0],t[1],t[2],t[3])}(e);else{const t=e.match(/[.?\d]+/g);e=Ro(+t[0],+t[1],+t[2],void 0===t[3]?1:+t[3])}this.boxRect=this.elements.box.getBoundingClientRect();const i=this.boxRect.width/100*e.s,n=100-e.l/(100-e.s/2)*100,a=this.boxRect.height/100*n;this.saturationHandler(this.boxRect.left+i,this.boxRect.top+a,!1),this.hueRect=this.elements.hue.getBoundingClientRect();const o=e.h/360,r=this.hueRect.left+this.hueRect.width*o;this.hueHandler(r,!1),this.hue=e.h,this.saturation=e.s,this.lightness=e.l,this.alpha=e.a,this.updatePicker(t,s)}getCurrentColor(){const e=Bo(this.hue,this.saturation,this.lightness,this.alpha),t=No(e),s=t.slice(0,-2);return{hsl:`hsl(${this.hue}, ${this.saturation}%, ${this.lightness}%)`,rgb:`rgb(${e[0]}, ${e[1]}, ${e[2]})`,hex:s,hsla:`hsla(${this.hue}, ${this.saturation}%, ${this.lightness}%, ${this.alpha})`,rgba:`rgba(${e[0]}, ${e[1]}, ${e[2]}, ${e[3]})`,hexa:t,rgbaArray:e}}updatePicker(e=!0,t=!0){const s=this.getCurrentColor();this.elements.boxDragger.setAttributeNS(null,"fill",s.hex),e&&(this.hexInputField.setValueSilently(s.hex),this.hexInputField.setState(Ws.a.Neutral)),t&&(this.rgbInputField.setValueSilently(s.rgbaArray.slice(0,-1).join(", ")),this.rgbInputField.setState(Ws.a.Neutral)),this.onChange&&this.onChange(s)}hueHandler(e,t=!0){const s=Object(ds.a)(e-this.hueRect.left,0,this.hueRect.width)/this.hueRect.width;this.hue=Math.round(360*s);const i=`hsla(${this.hue}, 100%, 50%, ${this.alpha})`;this.elements.hueDragger.setAttributeNS(null,"x",100*s+"%"),this.elements.hueDragger.setAttributeNS(null,"fill",i),this.elements.saturation.lastElementChild.setAttributeNS(null,"stop-color",i),t&&this.updatePicker()}saturationHandler(e,t,s=!0){const i=this.boxRect.width,n=this.boxRect.height,a=Object(ds.a)(e-this.boxRect.left,0,i)/i*100,o=Object(ds.a)(t-this.boxRect.top,0,n)/n*100,r=this.elements.boxDragger;r.setAttributeNS(null,"x",a+"%"),r.setAttributeNS(null,"y",o+"%");const l=Object(ds.a)(a,0,100),d=100-l/2,c=100-Object(ds.a)(o,0,100),h=Object(ds.a)(c/100*d,0,100);this.saturation=l,this.lightness=h,s&&this.updatePicker()}}Vo.BASE_CLASS="color-picker";class Go extends Ys{constructor(){super(...arguments),this._applyColor=(e,t=!0)=>{if(t)this.colorPicker.setColor(e);else{const t=Uo(e),s=this.theme.background,i=Wo(t);s.id="2",s.intensity=0,s.slug="",s.color=e.toLowerCase(),s.type="color",s.highlightningColor=i,ve.default.pushToState("settings",H.default.settings),Pd.applyCurrentTheme(void 0,void 0,!0),this.setActive()}},this.onColorChange=e=>{this.applyColor(e.hex,!1)}}init(){this.container.classList.add("background-container","background-color-container"),this.setTitle("SetColor"),this.theme=H.default.getTheme();const e=new fr({});this.colorPicker=new Vo,e.content.append(this.colorPicker.container),this.scrollable.append(e.container);const t=this.grid=document.createElement("div");t.classList.add("grid");["#E6EBEE","#B2CEE1","#008DD0","#C6E7CB","#C4E1A6","#60B16E","#CCD0AF","#A6A997","#7A7072","#FDD7AF","#FDB76E","#DD8851"].forEach(e=>{const s=document.createElement("div");s.classList.add("grid-item"),s.dataset.color=e.toLowerCase();const i=document.createElement("div");i.classList.add("grid-item-media"),i.style.backgroundColor=e,s.append(i),t.append(s)}),Object(v.b)(t,e=>{const t=Object(ti.a)(e.target,"grid-item");if(!t||t.classList.contains("active"))return;const s=t.dataset.color;s&&this.applyColor(s)},{listenerSetter:this.listenerSetter}),this.scrollable.append(t),this.applyColor=Object(o.a)(this._applyColor,16,!0)}setActive(){const e=this.grid.querySelector(".active"),t=this.theme.background,s=t.color?this.grid.querySelector(`.grid-item[data-color="${t.color}"]`):null;e!==s&&(e&&e.classList.remove("active"),s&&s.classList.add("active"))}onOpen(){setTimeout(()=>{const e=this.theme.background,t=(e.color||"").split(",")[0],s=!!t&&!e.slug;s&&(this.colorPicker.onChange=this.onColorChange),this.colorPicker.setColor(t||"#cccccc"),s||(this.colorPicker.onChange=this.onColorChange)},0)}onCloseAfterTimeout(){return this.colorPicker.onChange=void 0,this.colorPicker=void 0,super.onCloseAfterTimeout()}}let Ko=0;var Qo=class extends Ys{constructor(){super(...arguments),this.tempId=0,this.clicked=new Set,this.wallpapersByElement=new Map,this.elementsByKey=new Map,this.onUploadClick=()=>{(function(e){const t=document.createElement("input");t.type="file",t.style.display="none",e&&(t.accept=e),document.body.append(t);const s=new Promise((e,s)=>{t.addEventListener("change",t=>{const i=t.target.files[0];i?e(i):s("NO_FILE_SELECTED")},{once:!0})}).finally(()=>{t.remove()});return t.click(),s})("image/x-png,image/png,image/jpeg").then(e=>{const t="wallpaper-upload-"+ ++Ko,s={_:"photoSize",h:0,w:0,location:{},size:e.size,type:"full"};let i={_:"document",access_hash:"",attributes:[],dc_id:0,file_reference:[],id:t,mime_type:e.type,size:e.size,date:Date.now()/1e3,pFlags:{},thumbs:[s],file_name:e.name};i=es.saveDoc(i);const n=st.getCacheContext(i);n.downloaded=e.size,n.url=URL.createObjectURL(e);let a={_:"wallPaper",access_hash:"",document:i,id:t,slug:t,pFlags:{}};const o=st.upload(e,e.name),r=Object(w.a)();r.addNotifyListener=o.addNotifyListener,r.cancel=o.cancel,o.then(t=>{F.a.invokeApi("account.uploadWallPaper",{file:t,mime_type:e.type,settings:{_:"wallPaperSettings"}}).then(e=>{const t=e.document,s=st.getCacheContext(t);Object.assign(s,n),a=e,a.document=es.saveDoc(a.document),this.setBackgroundDocument(a).then(r.resolve,r.reject)},r.reject)},r.reject);const l=this.getWallpaperKey(a);r.then(()=>{this.clicked.delete(l)},e=>{c.remove()});const d=new y({isUpload:!0,cancelable:!0,tryAgainOnFail:!1}),c=this.addWallPaper(a,!1);this.clicked.add(l),d.attach(c,!1,r)})},this.onResetClick=()=>{const e=ve.STATE_INIT.settings.themes.find(e=>e.name===this.theme.name);e&&(++this.tempId,this.theme.background=Object(m.a)(e.background),ve.default.pushToState("settings",H.default.settings),Pd.applyCurrentTheme(void 0,void 0,!0),this.blurCheckboxField.setValueSilently(this.theme.background.blur))},this.onGridClick=e=>{const t=Object(ti.a)(e.target,"grid-item");if(!t)return;const s=this.wallpapersByElement.get(t);if("wallPaperNoFile"===s._)return void this.setBackgroundDocument(s);const i=this.getWallpaperKey(s);if(this.clicked.has(i))return;this.clicked.add(i);const n=s.document,a=new y({cancelable:!0,tryAgainOnFail:!1}),o=()=>{const e=this.setBackgroundDocument(s);st.getCacheContext(n).url&&!this.theme.background.blur||a.attach(t,!0,e)};a.construct(),Object(v.b)(t,e=>{a.preloader.parentElement?(a.onClick(e),a.detach()):o()},{listenerSetter:this.listenerSetter}),o()},this.saveToCache=(e,t)=>{fetch(t).then(t=>{st.cacheStorage.save("backgrounds/"+e,t)})},this.setBackgroundDocument=e=>{let t=++this.tempId;const s=()=>t===this.tempId,i=e.document,n=Object(w.a)();let a;return i?(a=es.downloadDoc(i,Pd.chat.bubbles?Pd.chat.bubbles.lazyLoadQueue.queueId:0),n.addNotifyListener=a.addNotifyListener,n.cancel=a.cancel):a=Promise.resolve(),a.then(()=>{if(!s())return void n.resolve();const t=this.theme.background,a=i=>{let a;const o=this.getColorsFromWallPaper(e);if(i&&!o)a=jo(i);else{const{canvas:e}=qo.create(o);a=Promise.resolve(Do(e))}a.then(a=>{var r,l,d;if(!s())return void n.resolve();const c=Wo(Array.from(a)),h=null!==(r=e.slug)&&void 0!==r?r:"";t.id=e.id,t.intensity=null!==(d=null===(l=e.settings)||void 0===l?void 0:l.intensity)&&void 0!==d?d:0,t.color=o,t.slug=h,t.highlightningColor=c,ve.default.pushToState("settings",H.default.settings),h&&this.saveToCache(h,i),Pd.applyCurrentTheme(h,i,!0).then(n.resolve)})};if(!i)return void a();const o=st.getCacheContext(i);t.blur?setTimeout(()=>{pt(o.url,12,4).then(e=>{s()?a(e):n.resolve()})},200):a(o.url)}),n},this.setActive=()=>{const e=this.grid.querySelector(".active"),t=this.elementsByKey.get(this.getWallpaperKeyFromTheme(this.theme));e!==t&&(e&&e.classList.remove("active"),t&&t.classList.add("active"))}}init(){this.container.classList.add("background-container","background-image-container"),this.setTitle("ChatBackground"),this.theme=H.default.getTheme();{const t=vr(this.scrollable),s=Object(Ks.a)("btn-primary btn-transparent",{icon:"colorize",text:"SetColor"}),i=Object(Ks.a)("btn-primary btn-transparent",{icon:"favourites",text:"Appearance.Reset"});Object(v.b)(s,()=>{new Go(this.slider).open()},{listenerSetter:this.listenerSetter}),Object(v.b)(i,this.onResetClick,{listenerSetter:this.listenerSetter});const n=this.blurCheckboxField=new Gi.a({text:"ChatBackground.Blur",name:"blur",checked:this.theme.background.blur,withRipple:!0});this.listenerSetter.add(n.input)("change",()=>{this.theme.background.blur=n.input.checked,ve.default.pushToState("settings",H.default.settings);e.querySelector(".active")&&setTimeout(()=>{const t=e.querySelector(".active");if(!t)return;const s=this.wallpapersByElement.get(t);s.pFlags.pattern||"wallPaperNoFile"===s._||this.setBackgroundDocument(s)},100)}),t.append(s,i)}H.default.addEventListener("background_change",this.setActive),F.a.invokeApiHashable("account.getWallPapers").then(e=>{e.wallpapers.forEach(e=>{this.addWallPaper(e)})});const e=this.grid=document.createElement("div");e.classList.add("grid"),Object(v.b)(e,this.onGridClick,{listenerSetter:this.listenerSetter}),this.scrollable.append(e)}getColorsFromWallpaper(e){return e.settings?[e.settings.background_color,e.settings.second_background_color,e.settings.third_background_color,e.settings.fourth_background_color].filter(Boolean).map(e=>"#"+e.toString(16)).join(","):""}getWallpaperKey(e){return""+e.id}getWallpaperKeyFromTheme(e){return""+e.background.id}addWallPaper(e,t=!0){var s;const i=this.getColorsFromWallpaper(e),n="wallPaper"===e._;if(n&&e.pFlags.pattern&&!i)return;const a=!!e.pFlags.dark,o=n?e.document=es.saveDoc(e.document):void 0,r=document.createElement("div");r.classList.add("grid-item"),r.dataset.id=""+e.id;const l=this.getWallpaperKey(e);this.wallpapersByElement.set(r,e),this.elementsByKey.set(l,r);const d=document.createElement("div");let c,h;if(d.classList.add("grid-item-media"),n?(h=Dt.choosePhotoSize(o,200,200),c=Oa({photo:o,message:null,container:d,withoutPreloader:!0,size:h,noFadeIn:e.pFlags.pattern}),(c.loadPromises.thumb||c.loadPromises.full).then(()=>{Je.a.mutate(()=>{r.append(d)})}),e.pFlags.pattern&&(d.classList.add("is-pattern"),a?(c.images.full.style.display="none",c.images.thumb&&(c.images.thumb.style.display="none")):(null===(s=e.settings)||void 0===s?void 0:s.intensity)&&(c.images.full.style.opacity=""+Math.abs(e.settings.intensity)/100))):r.append(d),e.settings&&void 0!==e.settings.background_color){const{canvas:t}=qo.create(i);if(t.classList.add("background-colors-canvas"),a&&n){const s=st.getCacheContext(o,h.type);c.loadPromises.full.then(()=>{t.style.webkitMaskImage=`url(${s.url})`,t.style.opacity=""+Math.abs(e.settings.intensity)/100,d.append(t)})}else d.append(t)}return this.getWallpaperKeyFromTheme(this.theme)===l&&r.classList.add("active"),this.grid[t?"append":"prepend"](r),r}getColorsFromWallPaper(e){return e.settings?[e.settings.background_color,e.settings.second_background_color,e.settings.third_background_color,e.settings.fourth_background_color].filter(Boolean).map(zo).join(","):""}};class $o{constructor(e,t,s,i,n){const a="range-setting-selector";this.container=document.createElement("div"),this.container.classList.add(a);const o=document.createElement("div");o.classList.add(a+"-details");const r=document.createElement("div");r.classList.add(a+"-name"),Object(O._i18n)(r,e);const l=document.createElement("div");l.classList.add(a+"-value"),l.innerHTML=""+s,o.append(r,l),this.range=new Si({step:t,min:i,max:n},s),this.range.setListeners(),this.range.setHandlers({onScrub:e=>{this.onChange&&this.onChange(e),l.innerText=""+e}}),this.container.append(o,this.range.container)}}class Yo extends Xs{init(){this.container.classList.add("general-settings-container"),this.setTitle("General");const e=vr.bind(null,this.scrollable);{const t=e("Settings"),s=new $o("TextSize",1,H.default.settings.messagesTextSize,12,20);s.onChange=e=>{ve.default.setByKey("settings.messagesTextSize",e)};const i=Object(Ks.a)("btn-primary btn-transparent",{icon:"image",text:"ChatBackground"});Object(v.b)(i,()=>{new Qo(this.slider).open()});const n=new Gi.a({text:"EnableAnimations",name:"animations",stateKey:"settings.animationsEnabled",withRipple:!0});t.append(s.container,i,n.label)}{const t=e("General.Keyboard"),s=document.createElement("form"),i="send-shortcut",n="settings.sendShortcut",a=new Qi({radioField:new Xi({langKey:"General.SendShortcut.Enter",name:i,value:"enter",stateKey:n}),subtitleLangKey:"General.SendShortcut.NewLine.ShiftEnter"}),o=new Qi({radioField:new Xi({name:i,value:"ctrlEnter",stateKey:n}),subtitleLangKey:"General.SendShortcut.NewLine.Enter"});Object(O._i18n)(o.radioField.main,"General.SendShortcut.CtrlEnter",[C.IS_APPLE?"âŒ˜":"Ctrl"]),s.append(a.container,o.container),t.append(s)}{const t=e("General.TimeFormat"),s=document.createElement("form"),i="time-format",n="settings.timeFormat",a=[["h12","General.TimeFormat.h12"],["h23","General.TimeFormat.h23"]],o=a.map(([e,t])=>new Qi({radioField:new Xi({langKey:t,name:i,value:e,stateKey:n})})),r=function(e,t=!0){const s=e;let i;return t||(e=we.a),function t(){e(),i=J.a.setTimeout(t,1e3*(60-(new Date).getSeconds()))}(),e=s,()=>{clearTimeout(i)}}(()=>{const e=new Date;a.forEach(([t],s)=>{const i=e.toLocaleTimeString("en-us-u-hc-"+t,{hour:"2-digit",minute:"2-digit"});o[s].subtitle.textContent=i})});this.eventListener.addEventListener("destroy",r),s.append(...o.map(e=>e.container)),t.append(s)}{const t=e("AutoDownloadMedia"),s=new Gi.a({text:"AutodownloadContacts",name:"contacts",stateKey:"settings.autoDownload.contacts",withRipple:!0}),i=new Gi.a({text:"AutodownloadPrivateChats",name:"private",stateKey:"settings.autoDownload.private",withRipple:!0}),n=new Gi.a({text:"AutodownloadGroupChats",name:"groups",stateKey:"settings.autoDownload.groups",withRipple:!0}),a=new Gi.a({text:"AutodownloadChannels",name:"channels",stateKey:"settings.autoDownload.channels",withRipple:!0});t.append(s.label,i.label,n.label,a.label)}{const t=e("General.AutoplayMedia"),s=new Gi.a({text:"AutoplayGIF",name:"gifs",stateKey:"settings.autoPlay.gifs",withRipple:!0}),i=new Gi.a({text:"AutoplayVideo",name:"videos",stateKey:"settings.autoPlay.videos",withRipple:!0});t.append(s.label,i.label)}{const t=e("Emoji"),s=new Gi.a({text:"GeneralSettings.EmojiPrediction",name:"suggest-emoji",stateKey:"settings.emoji.suggest",withRipple:!0}),i=new Gi.a({text:"GeneralSettings.BigEmoji",name:"emoji-big",stateKey:"settings.emoji.big",withRipple:!0});t.append(s.label,i.label)}}onOpen(){this.init&&(this.init(),this.init=null)}}var Xo=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class Zo extends Ys{init(){return Xo(this,void 0,void 0,(function*(){this.container.classList.add("edit-profile-container"),this.setTitle("EditAccount.Title");const e=[];{const t=document.createElement("div");t.classList.add("input-wrapper"),this.firstNameInputField=new Ws.b({label:"EditProfile.FirstNameLabel",name:"first-name",maxLength:70}),this.lastNameInputField=new Ws.b({label:"Login.Register.LastName.Placeholder",name:"last-name",maxLength:64}),this.bioInputField=new Ws.b({label:"EditProfile.BioLabel",name:"bio",maxLength:70}),t.append(this.firstNameInputField.container,this.lastNameInputField.container,this.bioInputField.container);const s=document.createElement("div");s.classList.add("caption"),Object(O.i18n_)({element:s,key:"Bio.Description"}),e.push(this.firstNameInputField,this.lastNameInputField,this.bioInputField),this.scrollable.append(t,s)}this.scrollable.append(document.createElement("hr")),this.editPeer=new Vi({peerId:H.default.myId,inputFields:e,listenerSetter:this.listenerSetter}),this.content.append(this.editPeer.nextBtn),this.scrollable.prepend(this.editPeer.avatarEdit.container);{const t=document.createElement("div");t.classList.add("sidebar-left-h2"),Object(O.i18n_)({element:t,key:"EditAccount.Username"});const s=document.createElement("div");s.classList.add("input-wrapper"),this.usernameInputField=new Ji({label:"EditProfile.Username.Label",name:"username",plainText:!0,listenerSetter:this.listenerSetter,onChange:()=>{this.editPeer.handleChange(),this.setProfileUrl()},availableText:"EditProfile.Username.Available",takenText:"EditProfile.Username.Taken",invalidText:"EditProfile.Username.Invalid"}),s.append(this.usernameInputField.container);const i=document.createElement("div");i.classList.add("caption"),i.append(Object(O.i18n)("UsernameSettings.ChangeDescription")),i.append(document.createElement("br"),document.createElement("br"));const n=this.profileUrlContainer=document.createElement("div");n.classList.add("profile-url-container");const a=this.profileUrlAnchor=document.createElement("a");a.classList.add("profile-url"),a.href="#",a.target="_blank",n.append(Object(O.i18n)("UsernameHelpLink",[a])),i.append(n),e.push(this.usernameInputField),this.scrollable.append(t,s,i)}Object(v.b)(this.editPeer.nextBtn,()=>{this.editPeer.nextBtn.disabled=!0;let e=[];e.push(Ts.updateProfile(this.firstNameInputField.value,this.lastNameInputField.value,this.bioInputField.value).then(()=>{this.close()},e=>{console.error("updateProfile error:",e)})),this.editPeer.uploadAvatar&&e.push(this.editPeer.uploadAvatar().then(e=>Ts.uploadProfilePhoto(e))),this.usernameInputField.isValidToChange()&&e.push(ye.updateUsername(this.usernameInputField.value)),Promise.race(e).finally(()=>{this.editPeer.nextBtn.removeAttribute("disabled")})},{listenerSetter:this.listenerSetter});const t=ye.getSelf(),s=yield Ts.getProfile(t.id,!0);this.firstNameInputField.setOriginalValue(t.first_name,!0),this.lastNameInputField.setOriginalValue(t.last_name,!0),this.bioInputField.setOriginalValue(s.about,!0),this.usernameInputField.setOriginalValue(t.username,!0),this.setProfileUrl(),this.editPeer.handleChange()}))}setProfileUrl(){if(this.usernameInputField.input.classList.contains("error")||!this.usernameInputField.value.length)this.profileUrlContainer.style.display="none";else{this.profileUrlContainer.style.display="";let e="https://eitaa.com/"+this.usernameInputField.value;this.profileUrlAnchor.innerText=e,this.profileUrlAnchor.href=e}}}var Jo=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class er extends Ys{constructor(){super(...arguments),this.renderResults=e=>Jo(this,void 0,void 0,(function*(){yield ye.getContacts(),e.forEach(e=>{const{dom:t}=Jd.addDialogNew({dialog:e,container:this.selector.scrollable,drawStatus:!1,rippleEnabled:!0,avatarSize:46}),s=this.selector.selected.has(e);t.containerEl.append(this.checkbox(s));const i=[];this.dialogsByFilters.forEach((t,s)=>{if(t.has(e)){const e=document.createElement("span");Object(xe.a)(e,N.b.wrapEmojiText(s.title)),i.push(e)}});Object(O.join)(i,!1).forEach(e=>{t.lastMessageSpan.append(e)})})})),this.onSelectChange=e=>{"included"===this.type&&(this.confirmBtn.style.display=e?"":"none")},this.isNewFilter=e=>!(e.id in js.filtersStorage.localFilters)&&!(e.id in js.filtersStorage.filters)}init(){return this.content.remove(),this.container.classList.add("included-chatlist-container"),this.confirmBtn=Qs("check btn-confirm blue",{noRipple:!0}),this.confirmBtn.style.display="none",this.header.append(this.confirmBtn),this.confirmBtn.addEventListener("click",()=>{const e=this.selector.getSelected();if("included"===this.type)for(const e in this.filter.pFlags)0!==e.indexOf("exclude_")&&delete this.filter.pFlags[e];else for(const e in this.filter.pFlags)0===e.indexOf("exclude_")&&delete this.filter.pFlags[e];const t=[];for(const s of e)s.isPeerId()?t.push(s.toPeerId()):this.filter.pFlags[s]=!0;let s;s="included"===this.type?e=>t.includes(e):e=>!t.includes(e),Object(a.e)(this.filter.pinnedPeerIds,(e,t)=>{s(e)||(this.filter.pinnedPeerIds.splice(t,1),this.filter.pinned_peers.splice(t,1))});const i="included"===this.type?"excludePeerIds":"includePeerIds",n="included"===this.type?"exclude_peers":"include_peers";Object(a.e)(this.filter[i],(e,s)=>{t.includes(e)&&(this.filter[i].splice(s,1),this.filter[n].splice(s,1))}),this.filter["included"===this.type?"includePeerIds":"excludePeerIds"]=t,this.filter["included"===this.type?"include_peers":"exclude_peers"]=t.map(e=>Te.getInputPeerById(e)),this.editFolderTab.setFilter(this.filter,!1),this.close()}),this.dialogsByFilters=new Map,js.filtersStorage.getDialogFilters().then(e=>{for(const t of e)this.dialogsByFilters.set(t,new Set(js.dialogsStorage.getFolderDialogs(t.id).map(e=>e.peerId)))})}checkbox(e){const t=new Gi.a({round:!0});return e&&(t.input.checked=e),t.label}onOpen(){this.init&&(this.init(),this.init=null),this.confirmBtn.style.display="excluded"===this.type?"":"none",this.setTitle("included"===this.type?"FilterAlwaysShow":"FilterNeverShow");const e=this.filter,t=document.createDocumentFragment(),s=new fr({noDelimiter:!0,name:"FilterChatTypes"});let i;s.container.classList.add("folder-categories"),i="excluded"===this.type?{exclude_muted:{ico:"mute",text:"ChatList.Filter.MutedChats"},exclude_read:{ico:"readchats",text:"ChatList.Filter.ReadChats"}}:{contacts:{ico:"newprivate",text:"ChatList.Filter.Contacts"},non_contacts:{ico:"noncontacts",text:"ChatList.Filter.NonContacts"},groups:{ico:"group",text:"ChatList.Filter.Groups"},broadcasts:{ico:"newchannel",text:"ChatList.Filter.Channels"},admin:{ico:"admin",text:"ChatList.Filter.Admin"}};const n=document.createDocumentFragment();for(const e in i){const t=Object(Ks.a)("btn-primary btn-transparent folder-category-button",{icon:i[e].ico,text:i[e].text});t.dataset.peerId=e,t.append(this.checkbox()),n.append(t)}s.content.append(n);const a=new fr({name:"FilterChats"});t.append(s.container),(e.id in js.filtersStorage.localFilters||this.isNewFilter(e))&&t.append(a.container);const o=("included"===this.type?e.includePeerIds:e.excludePeerIds).slice();this.selector=new cn({appendTo:this.container,onChange:this.onSelectChange,peerType:["dialogs"],renderResultsFunc:this.renderResults,placeholder:"Search"}),this.selector.selected=new Set(o);let r=!1;const l=this.selector.add.bind(this.selector);this.selector.add=(e,t,s)=>{if(this.selector.selected.size>=100&&r&&!i[e]){const t=this.selector.list.querySelector(`[data-peer-id="${e}"] [type="checkbox"]`);t&&setTimeout(()=>{t.checked=!1},0);return void Qt(O.default.format("excluded"===this.type?"ChatList.Filter.Exclude.LimitReached":"ChatList.Filter.Include.LimitReached",!0))}const n=l(e,i[e]?Object(O.i18n)(i[e].text):void 0,s);return i[e]&&n.querySelector("avatar-element").classList.add("tgico-"+i[e].ico),n};const d=this.selector.list.parentElement;a.content.append(this.selector.list),d.append(t),this.selector.addInitial(o),r=!0;for(const t in e.pFlags)i.hasOwnProperty(t)&&e.pFlags[t]&&s.content.querySelector(`[data-peer-id="${t}"]`).click()}onCloseAfterTimeout(){return this.selector&&(this.selector.container.remove(),this.selector=null),super.onCloseAfterTimeout()}open(e,t,s){return this.originalFilter=e,this.filter=Object(m.a)(this.originalFilter),this.type=t,this.editFolderTab=s,super.open()}}class tr extends Ys{constructor(){super(...arguments),this.flags={}}init(){this.container.classList.add("edit-folder-container"),this.caption=document.createElement("div"),this.caption.classList.add("caption"),this.caption.append(Object(O.i18n)("FilterIncludeExcludeInfo")),this.stickerContainer=document.createElement("div"),this.stickerContainer.classList.add("sticker-container"),this.confirmBtn=Qs("check btn-confirm hide blue");const e={icon:"delete danger",text:"FilterMenuDelete",onClick:()=>{new en("filter-delete",{titleLangKey:"ChatList.Filter.Confirm.Remove.Header",descriptionLangKey:"ChatList.Filter.Confirm.Remove.Text",buttons:[{langKey:"Delete",callback:()=>{e.element.setAttribute("disabled","true"),js.filtersStorage.updateDialogFilter(this.filter,!0).then(e=>{e&&this.close()}).finally(()=>{e.element.removeAttribute("disabled")})},isDanger:!0}]}).show()}};this.menuBtn=Pi({},"bottom-left",[e]),this.menuBtn.classList.add("hide"),this.header.append(this.confirmBtn,this.menuBtn);const t=document.createElement("div");t.classList.add("input-wrapper"),this.nameInputField=new Ws.b({label:"FilterNameInputLabel",maxLength:12}),t.append(this.nameInputField.container);const s=(e,t,s,i)=>{const n=new fr({name:t,noDelimiter:!0});n.container.classList.add("folder-list",e);const a=n.generateContentElement();return a.classList.add("folder-categories"),s.forEach(e=>{const t=Object(Ks.a)("folder-category-button btn btn-primary btn-transparent",{icon:e.icon,text:e.text,noRipple:!e.withRipple||void 0});e.name&&(i[e.name]=t),a.append(t)}),n};this.includePeerIds=s("folder-list-included","FilterInclude",[{icon:"add primary",text:"ChatList.Filter.Include.AddChat",withRipple:!0},{text:"ChatList.Filter.Contacts",icon:"newprivate",name:"contacts"},{text:"ChatList.Filter.NonContacts",icon:"noncontacts",name:"non_contacts"},{text:"ChatList.Filter.Groups",icon:"group",name:"groups"},{text:"ChatList.Filter.Channels",icon:"channel",name:"broadcasts"},{text:"ChatList.Filter.Admin",icon:"admin",name:"admin"}],this.flags),this.excludePeerIds=s("folder-list-excluded","FilterExclude",[{icon:"minus primary",text:"ChatList.Filter.Exclude.AddChat",withRipple:!0},{text:"ChatList.Filter.MutedChats",icon:"mute",name:"exclude_muted"},{text:"ChatList.Filter.ReadChats",icon:"readchats",name:"exclude_read"}],this.flags),this.scrollable.append(this.stickerContainer,this.caption,t,this.includePeerIds.container,this.excludePeerIds.container);const i=this.includePeerIds.container.querySelector(".folder-categories"),n=this.excludePeerIds.container.querySelector(".folder-categories");return i.querySelector(".btn").addEventListener("click",()=>{new er(this.slider).open(this.filter,"included",this)}),n.querySelector(".btn").addEventListener("click",()=>{new er(this.slider).open(this.filter,"excluded",this)}),this.confirmBtn.addEventListener("click",()=>{if(this.nameInputField.input.classList.contains("error"))return;if(!this.nameInputField.value.trim())return void this.nameInputField.input.classList.add("error");let e,t=Array.from(i.children).slice(1).reduce((e,t)=>e+ +!t.style.display,0);t+=this.filter.include_peers.length,t?(this.confirmBtn.setAttribute("disabled","true"),this.filter.id?(this.filter.flags=void 0,e=js.filtersStorage.updateDialogFilter(this.filter)):e=js.filtersStorage.createDialogFilter(this.filter),e.then(e=>{e&&this.close()}).catch(e=>{"DIALOG_FILTERS_TOO_MUCH"===e.type?Qt("Sorry, you can't create more folders."):console.error("updateDialogFilter error:",e)}).finally(()=>{this.confirmBtn.removeAttribute("disabled")})):$t({langPackKey:"Chat.Selection.AtLeast",timeToDisappear:3e3})}),this.nameInputField.input.addEventListener("input",()=>{this.filter.title=this.nameInputField.value,this.editCheckForChange()}),this.loadAnimationPromise=pi.b.loadAnimationFromURL({container:this.stickerContainer,loop:!1,autoplay:!1,width:86,height:86},"assets/img/Folders_2.tgs").then(e=>(this.animation=e,pi.b.waitForFirstFrame(e)))}onOpenAfterTimeout(){this.loadAnimationPromise.then(()=>{this.animation.autoplay=!0,this.animation.play()})}onCreateOpen(){this.caption.style.display="",this.setTitle("FilterNew"),this.menuBtn.classList.add("hide"),this.confirmBtn.classList.remove("hide"),this.nameInputField.value="";const e=new fr({caption:!0,noDelimiter:!0}),t=new fr({caption:!0,noDelimiter:!0});e.caption.append(Object(O.i18n)("CreateFolderHint")),t.caption.append(Object(O.i18n)("RemoveLocalFoldersHint")),this.scrollable.append(e.container,t.container);for(const e in this.flags)this.flags[e].style.display="none"}onEditOpen(){this.caption.style.display="none",this.setTitle("create"===this.type?"FilterNew":"FilterHeaderEdit"),"edit"===this.type&&(this.menuBtn.classList.remove("hide"),this.confirmBtn.classList.add("hide"));const e=this.filter;this.nameInputField.value=Object(Yt.a)(N.b.wrapDraftText(e.title));for(const t in this.flags)this.flags[t].style.display=e.pFlags[t]?"":"none";["includePeerIds","excludePeerIds"].forEach(t=>{const s=this[t],i=Jd.createChatList(),n=e[t].slice(),a=e=>{for(let t=0,s=Math.min(n.length,e);t<s;++t){const e=n.shift(),{dom:t}=Jd.addDialogNew({dialog:e,container:i,drawStatus:!1,rippleEnabled:!1,meAsSaved:!0,avatarSize:32});t.lastMessageSpan.parentElement.remove()}n.length?o.lastElementChild.replaceWith(Object(O.i18n)("FilterShowMoreChats",[n.length])):o&&o.remove()};let o;if(s.generateContentElement().append(i),n.length){const e=s.generateContentElement();o=Object(Ks.a)("folder-category-button btn btn-primary btn-transparent",{icon:"down"}),o.classList.add("load-more","rp-overflow"),o.addEventListener("click",()=>a(20)),o.append(Object(O.i18n)("FilterShowMoreChats",[n.length])),e.append(o)}a(4)})}editCheckForChange(){if("edit"===this.type){const e=!Object(m.b)(this.originalFilter,this.filter);this.confirmBtn.classList.toggle("hide",!e),this.menuBtn.classList.toggle("hide",e)}}setFilter(e,t){Array.from(this.container.querySelectorAll("ul, .load-more")).forEach(e=>e.remove()),t?(this.originalFilter=e,this.filter=Object(m.a)(e)):(this.filter=e,this.onEditOpen(),this.editCheckForChange())}open(e){const t=super.open();return void 0===e?(this.setFilter({_:"dialogFilter",id:0,title:"",pFlags:{},pinned_peers:[],include_peers:[],exclude_peers:[],pinnedPeerIds:[],includePeerIds:[],excludePeerIds:[]},!0),this.type="create",this.onCreateOpen()):(this.setFilter(e,!0),this.type="edit",this.onEditOpen()),t}}var sr=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class ir extends Ys{constructor(){super(...arguments),this.filtersRendered={}}renderFolder(e,t,s){let i,n,a="",o=[];if("dialogFilterSuggested"===e._)i=e.filter,a=e.description;else{if(i=e,1===Object.keys(i.pFlags).length){const e=i.pFlags;let t;e.contacts?t="FilterAllContacts":e.non_contacts?t="FilterAllNonContacts":e.groups?t="FilterAllGroups":e.broadcasts&&(t="FilterAllChannels"),t&&o.push(Object(O.i18n)(t))}if(!o.length){const e=js.dialogsStorage.getFolderDialogs(i.id);let t=0,s=0,n=0;for(const i of e)Te.isAnyGroup(i.peerId)?n++:Te.isBroadcast(i.peerId)?s++:t++;t&&o.push(Object(O.i18n)("Chats",[t])),s&&o.push(Object(O.i18n)("Channels",[s])),n&&o.push(Object(O.i18n)("Groups",[n]))}}if(s)s.subtitle.textContent="",Object(O.join)(o).forEach(e=>{s.subtitle.append(e)});else if(s=new Qi({title:N.a.wrapEmojiText(i.title),subtitle:a,clickable:!0}),o.length&&Object(O.join)(o).forEach(e=>{s.subtitle.append(e)}),"dialogFilter"===e._){const e=i.id;this.filtersRendered.hasOwnProperty(i.id)||Object(v.b)(s.container,()=>{new tr(this.slider).open(js.filtersStorage.getFilter(e))},{listenerSetter:this.listenerSetter}),this.filtersRendered[i.id]=s}return n=s.container,i.hasOwnProperty("orderIndex")?Ha(n,n.parentElement||t,i.orderIndex):t&&t.append(n),n}init(){return sr(this,void 0,void 0,(function*(){this.container.classList.add("chat-folders-container"),this.setTitle("ChatList.Filter.List.Title"),this.scrollable.container.classList.add("chat-folders"),this.stickerContainer=document.createElement("div"),this.stickerContainer.classList.add("sticker-container");const e=document.createElement("div");e.classList.add("caption"),Object(O.i18n_)({element:e,key:"ChatList.Filter.Header"}),this.createFolderBtn=Object(Ks.a)("btn-primary btn-color-primary btn-control tgico",{text:"ChatList.Filter.NewTitle",icon:"add"}),this.resetFoldresBtn=Object(Ks.a)("btn-primary btn-color-primary btn-control tgico",{text:"Appearance.Reset",icon:"replace"}),this.foldersSection=new fr({name:"Filters"}),this.foldersSection.container.style.display="none",this.suggestedSection=new fr({name:"FilterRecommended"}),this.suggestedSection.container.style.display="none",this.scrollable.append(this.stickerContainer,e,this.createFolderBtn,this.resetFoldresBtn,this.foldersSection.container,this.suggestedSection.container),Object(v.b)(this.createFolderBtn,()=>{Object.keys(this.filtersRendered).length>=10?Qt("Sorry, you can't create more folders."):new tr(this.slider).open()},{listenerSetter:this.listenerSetter}),Object(v.b)(this.resetFoldresBtn,()=>{new en("popup-reset-folders",{buttons:[{langKey:"Reset",callback:()=>{F.a.invokeApi("messages.updateDialogFilter",{flags:4,id:void 0}).then(e=>{e&&(js.filtersStorage.localFilters={},ee.a.set({localFilters:{}}),Ie.processLocalUpdate({_:"updateDialogFilters"}),this.slider.closeTab())})},isDanger:!0}],titleLangKey:"ResetFoldersTitle",descriptionLangKey:"ResetFoldersQuestion"}).show()});const t=()=>{this.foldersSection.container.style.display=Object.keys(this.filtersRendered).length?"":"none"};return js.filtersStorage.getDialogFilters().then(e=>{for(const t of e)this.renderFolder(t,this.foldersSection.content);t()}),this.listenerSetter.add(H.default)("filter_update",e=>{this.filtersRendered.hasOwnProperty(e.id)?this.renderFolder(e,null,this.filtersRendered[e.id]):this.renderFolder(e,this.foldersSection.content),t(),this.getSuggestedFilters()}),this.listenerSetter.add(H.default)("filter_delete",e=>{this.filtersRendered.hasOwnProperty(e.id)&&(this.getSuggestedFilters(),this.filtersRendered[e.id].container.remove(),delete this.filtersRendered[e.id]),t()}),this.listenerSetter.add(H.default)("filter_order",e=>{e.forEach((e,t)=>{const s=this.filtersRendered[e].container;Ha(s,s.parentElement,t+1)})}),this.loadAnimationPromise=pi.b.loadAnimationFromURL({container:this.stickerContainer,loop:!1,autoplay:!1,width:86,height:86},"assets/img/Folders_1.tgs").then(e=>(this.animation=e,pi.b.waitForFirstFrame(e))),this.getSuggestedFilters(),this.loadAnimationPromise}))}onOpenAfterTimeout(){this.loadAnimationPromise.then(()=>{this.animation.autoplay=!0,this.animation.play()})}getSuggestedFilters(){return F.a.invokeApi("messages.getSuggestedDialogFilters").then(e=>{this.suggestedSection.container.style.display=e.length?"":"none",Array.from(this.suggestedSection.content.children).slice(1).forEach(e=>e.remove()),e.forEach(e=>{const t=this.renderFolder(e),s=Object(Ks.a)("btn-primary btn-color-primary",{text:"Add"});t.append(s),this.suggestedSection.content.append(t),Object(v.b)(s,i=>{if(Object(f.a)(i),Object.keys(this.filtersRendered).length>=10)return void Qt("Sorry, you can't create more folders.");s.setAttribute("disabled","true");const n=e.filter;n.includePeerIds=[],n.excludePeerIds=[],n.pinnedPeerIds=[],js.filtersStorage.createDialogFilter(n,!0).then(e=>{e&&t.remove()}).finally(()=>{s.removeAttribute("disabled")})},{listenerSetter:this.listenerSetter})})})}}class nr extends Xs{init(){this.container.classList.add("notifications-container"),this.setTitle("Eitaa.NotificationSettingsViewController");const e=e=>{const t=new fr({name:e.name}),s=new Qi({checkboxField:new Gi.a({text:e.typeText,checked:!0}),subtitleLangKey:"Loading",withCheckboxSubtitle:!0}),i=new Qi({checkboxField:new Gi.a({text:"Notifications.MessagePreview",checked:!0}),subtitleLangKey:"Loading",withCheckboxSubtitle:!0});t.content.append(s.container,i.container),this.scrollable.append(t.container);const n={_:e.inputKey},a=Cs.getNotifySettings(n);(a instanceof Promise?a:Promise.resolve(a)).then(t=>{const a=()=>{const e=Cs.isMuted(t);return s.checkboxField.checked=!e,i.checkboxField.checked=t.show_previews,e};a(),this.eventListener.addEventListener("destroy",()=>{const e=!s.checkboxField.checked,a=i.checkboxField.checked;if(e===Cs.isMuted(t)&&a===t.show_previews)return;const o=Object(m.a)(t);o._="inputPeerNotifySettings",o.mute_until=e?2147483647:0,o.show_previews=a,Cs.updateNotifySettingsByType(n,o)},{once:!0}),this.listenerSetter.add(H.default)("notify_settings",s=>{const i=Object(A.c)(s.peer._);e.inputKey===i&&(t=s.notify_settings,a())})})};e({name:"NotificationsPrivateChats",typeText:"NotificationsForPrivateChats",inputKey:"inputNotifyUsers"}),e({name:"NotificationsGroups",typeText:"NotificationsForGroups",inputKey:"inputNotifyChats"}),e({name:"NotificationsChannels",typeText:"NotificationsForChannels",inputKey:"inputNotifyBroadcasts"});{const e=new fr({name:"NotificationsOther"}),t=new Qi({checkboxField:new Gi.a({text:"Notifications.Sound",checked:!0,stateKey:"settings.notifications.sound"}),subtitleLangKey:"Loading",withCheckboxSubtitle:!0});ve.default.getState().then(e=>{t.checkboxField.checked=e.settings.notifications.sound}),e.content.append(t.container),this.scrollable.append(e.container)}}}var ar=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class or extends Ys{init(){return ar(this,void 0,void 0,(function*(){this.container.classList.add("language-container"),this.setTitle("Eitaa.LanguageViewController");const e=new fr({}),t=new Map,s=[{name:"ÙØ§Ø±Ø³ÛŒ",lang_code:"fa",native_name:"Persian"},{name:"Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ",lang_code:"en",native_name:"English"}],i=Promise.resolve().then(()=>{const i=Object(x.b)();s.forEach(e=>{const s=new Qi({radioField:new Xi({text:e.name,name:i,value:e.lang_code}),subtitle:e.native_name});t.set(e.lang_code,s)});const n=$i([...t.values()],e=>{O.default.getLangPack(e)});O.default.getCacheLangPack().then(e=>{const s=t.get(e.lang_code);s?s.radioField.setValueSilently(!0):console.error("no row",s,e)}),e.content.append(n)});return this.scrollable.append(e.container),i}))}}class rr extends Ys{constructor(){super(...arguments),this.buttons={},this.cleanStorage=()=>{ee.a.delete("notifyUsers"),ee.a.delete("notifyChats"),ee.a.delete("notifyBroadcasts"),ee.a.delete("savedGifs"),ee.a.delete("localFilters"),ee.a.delete("localPinned"),ee.a.delete("archivedIds")}}init(){this.container.classList.add("settings-container"),this.setTitle("Settings");const e=Pi({},"bottom-left",[{icon:"logout",text:"EditAccount.Logout",onClick:()=>{new en("logout",{titleLangKey:"LogOut",descriptionLangKey:"LogOut.Description",buttons:[{langKey:"LogOut",callback:()=>{try{"ios"===H.default.platform&&iosLogout.postMessage("")}catch(e){}finally{this.cleanStorage(),Nt.a.overrideHash("#"),F.a.logOut()}},isDanger:!0}]}).show()}}]);this.buttons.edit=Qs("edit"),this.header.append(this.buttons.edit,e),this.profile=new ca(this.scrollable,this.listenerSetter,!1),this.profile.init(),this.profile.setPeer(H.default.myId),this.profile.fillProfileElements();const t=li({icon:"cameraadd",className:"profile-change-avatar"});t.addEventListener("click",()=>{const e=document.createElement("canvas");(new oi).open(e,e=>{e().then(e=>Ts.uploadProfilePhoto(e))})}),this.profile.element.lastElementChild.firstElementChild.append(t);const s=()=>{var e;const s=ye.getSelf();t.classList.toggle("hide","userProfilePhoto"!==(null===(e=s.photo)||void 0===e?void 0:e._))};s(),this.listenerSetter.add(H.default)("avatar_update",e=>{H.default.myId===e&&(this.profile.setAvatar(),s())});const i=document.createElement("div");i.classList.add("profile-buttons");const n="profile-button btn-primary btn-transparent";i.append(this.buttons.general=Object(Ks.a)(n,{icon:"settings",text:"Eitaa.GeneralSettingsViewController"})),i.append(this.buttons.folders=Object(Ks.a)(n,{icon:"folder",text:"AccountSettings.Filters"})),i.append(this.buttons.notifications=Object(Ks.a)(n,{icon:"unmute",text:"AccountSettings.Notifications"})),i.append(this.buttons.privacy=Object(Ks.a)(n,{icon:"lock",text:"AccountSettings.PrivacyAndSecurity"})),i.append(this.buttons.language=Object(Ks.a)(n,{icon:"language",text:"AccountSettings.Language"}));const a=new fr;a.content.append(i),this.scrollable.append(this.profile.element,a.container),this.buttons.edit.addEventListener("click",()=>{new Zo(this.slider).open()}),this.buttons.folders.addEventListener("click",()=>{new ir(this.slider).open()}),this.buttons.general.addEventListener("click",()=>{new Yo(this.slider).open()}),this.buttons.notifications.addEventListener("click",()=>{new nr(this.slider).open()}),this.buttons.privacy.addEventListener("click",()=>{new Fo(this.slider).open()}),this.buttons.language.addEventListener("click",()=>{new or(this.slider).open()}),pi.b.loadLottieWorkers()}}class lr extends Ys{constructor(){super(...arguments),this.uploadAvatar=null}init(){this.container.classList.add("new-channel-container"),this.setTitle("NewChannel"),this.avatarEdit=new ri(e=>{this.uploadAvatar=e});const e=document.createElement("div");e.classList.add("input-wrapper"),this.channelNameInputField=new Ws.b({label:"EnterChannelName",maxLength:128}),this.channelDescriptionInputField=new Ws.b({label:"DescriptionOptionalPlaceholder",maxLength:255}),e.append(this.channelNameInputField.container,this.channelDescriptionInputField.container);const t=()=>{this.nextBtn.classList.toggle("is-visible",!!this.channelNameInputField.value.length&&!this.channelNameInputField.input.classList.contains("error")&&!this.channelDescriptionInputField.input.classList.contains("error"))};this.channelNameInputField.input.addEventListener("input",t),this.channelDescriptionInputField.input.addEventListener("input",t);const s=document.createElement("div");s.classList.add("caption"),Object(O._i18n)(s,"Channel.DescriptionHolderDescrpiton"),this.nextBtn=li({icon:"arrow_next"}),this.nextBtn.addEventListener("click",()=>{const e=this.channelNameInputField.value,t=this.channelDescriptionInputField.value;this.nextBtn.disabled=!0,Pe.createChannel(e,t).then(e=>{this.uploadAvatar&&this.uploadAvatar().then(t=>{Pe.editPhoto(e,t)}),wr.removeTabFromHistory(this),new Pn(this.slider).open({type:"channel",skippable:!0,title:"GroupAddMembers",placeholder:"SendMessageTo",takeOut:t=>Pe.inviteToChannel(e,t)})})}),this.content.append(this.nextBtn),this.scrollable.append(this.avatarEdit.container,e,s)}onCloseAfterTimeout(){return this.avatarEdit.clear(),this.uploadAvatar=null,this.channelNameInputField.value="",this.channelDescriptionInputField.value="",this.nextBtn.disabled=!1,super.onCloseAfterTimeout()}}var dr=s(196);class cr extends ni{constructor(){super("popup-create-contact popup-send-photo popup-new-media",null,{closable:!0,withConfirm:"Add"}),Object(O._i18n)(this.title,"AddContactTitle"),Object(v.b)(this.btnConfirm,()=>{const e=ye.importContact(s.value,i.value,n.value);e.then(()=>{this.hide()},e=>{"NO_USER"===e.type&&($t({langPackKey:"Contacts.PhoneNumber.NotRegistred"}),l.disabled=!1)}),l.lockWithPromise(e)},{listenerSetter:this.listenerSetter});const e=[],t=document.createElement("div");t.classList.add("name-fields");const s=new Ws.b({label:"FirstName",name:"create-contact-name",maxLength:70,required:!0}),i=new Ws.b({label:"LastName",name:"create-contact-lastname",maxLength:70}),n=new dr.a({required:!0});e.push(s,i,n);const a=()=>{const e=s.value+" "+i.value;l.avatarElem.setAttribute("peer-title",e),l.avatarElem.update()};this.listenerSetter.add(s.input)("input",a),this.listenerSetter.add(i.input)("input",a);const o=ye.getSelf(),r=Object(fe.a)(o.phone);r&&(n.validate=()=>!!n.value.match(/\d/),n.value="+"+r.code.country_code);const l=new Vi({inputFields:e,listenerSetter:this.listenerSetter,doNotEditAvatar:!0,nextBtn:this.btnConfirm,avatarSize:100});t.append(s.container,i.container,l.avatarElem),this.container.append(t,n.container),this.show()}}class hr{constructor(e){let t,s,i;t="Eitaa.Contact.GroupDelete.Title",s="Eitaa.Contact.GroupDelete.Description",i=[{langKey:"Eitaa.Contact.GroupDelete.Delete",isDanger:!0,callback:()=>{ye.deleteContacts(e).then(()=>{Nt.a.back()},()=>{})}}],new en("popup-delete-chat",{peerId:0,titleLangKey:"Eitaa.Contact.GroupDelete.Title",descriptionLangKey:"Eitaa.Contact.GroupDelete.Description",descriptionLangArgs:void 0,buttons:i,checkboxes:void 0}).show()}}var ur=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class pr extends Ys{init(){this.container.id="contacts-container";const e=document.createElement("div");e.id="edit-contact-section",this.content.prepend(e);const t=li({icon:"add",className:"is-visible"});this.content.append(t),Object(v.b)(t,()=>{new cr},{listenerSetter:this.listenerSetter}),this.inputSearch=new qs("Search",e=>{this.openContacts(e)}),this.listenerSetter.add(H.default)("contacts_update",e=>ur(this,void 0,void 0,(function*(){const t=yield ye.isContact(e),s=e.toPeerId();this.sortedUserList?t?(console.log("contacts_update: adding contact",e),this.sortedUserList.add(s)):(console.log("contacts_update: removing contact",e),this.sortedUserList.delete(s)):console.log("contacts_update: sortedUserList not initialized, skipping update")}))),this.title.replaceWith(this.inputSearch.container),this.middleware=Ke();const s=document.createElement("button");s.id="edit-contact-btn",s.append(Object(O.i18n)("Edit"));const i=document.createElement("button");i.id="sync-contact-btn",i.append(Object(O.i18n)("Eitaa.Contact.Sync")),i.addEventListener("click",()=>{try{iosExportContacts.postMessage({force:!0}),Qt(Object(O.i18n)("Eitaa.Contact.Sync.Success").innerText)}catch(e){}});const n=document.createElement("button");n.id="cancel-edit-contact-btn",n.style.display="none",n.append(Object(O.i18n)("Eitaa.Contact.Cancel")),s.addEventListener("click",()=>{this.container.classList.add("edit-contact-section-toggle");this.content.querySelector(".chatlist").classList.add("multi-select")}),n.addEventListener("click",()=>{this.container.classList.remove("edit-contact-section-toggle");const e=this.content.querySelector(".chatlist");e.classList.remove("multi-select");e.querySelectorAll(".active").forEach(e=>{e.classList.remove("active")})});const a=document.createElement("button");a.id="delete-contacts-btn",a.style.display="none",a.append(Object(O.i18n)("Message.Context.Selection.Delete")),a.addEventListener("click",()=>{const e=this.content.querySelector(".chatlist").querySelectorAll("li.active");if(0===e.length)return void Qt(Object(O.i18n)("Eitaa.Contact.GroupDelete.Required").innerText);let t=[];e.forEach(e=>{const s=e.dataset.peerId.toPeerId();t.push(s)}),new hr(t)}),"ios"===H.default.platform?e.append(s,i,n,a):e.append(s,n,a)}createList(){const e=new qa,t=e.list;return t.id="contacts",t.classList.add("contacts-container"),Jd.setListClickListener(t,()=>{this.close()},void 0,!0),e}onClose(){this.middleware.clean()}onOpenAfterTimeout(){!C.IS_MOBILE&&po(!0)&&this.inputSearch.input.focus()}openContacts(e){this.init&&(this.init(),this.init=null),this.middleware.clean();const t=this.middleware.get();this.scrollable.onScrolledBottom=null,this.scrollable.container.textContent="",ye.getContactsPeerIds(e,void 0,"online").then(e=>{if(!t())return;const s=this.sortedUserList=this.createList();let i=()=>{const t=mt.windowH/72*1.25|0;e.splice(0,t).forEach(e=>{s.add(e)}),e.length||(i=void 0,this.scrollable.onScrolledBottom=null)};i(),this.scrollable.onScrolledBottom=()=>{i?i():this.scrollable.onScrolledBottom=null},Object(le.a)(this.scrollable.container,s.list)})}open(){return this.openContacts(),super.open()}}class gr extends Ys{init(){if(this.container.id="chats-archived-container","night"===H.default.getTheme().name&&(this.container.classList.add("eitaa-dialogs-toggle"),this.container.classList.add("ads-active-toggle")),H.default.addEventListener("theme_change",()=>{"night"===H.default.settings.theme?(this.container.classList.add("eitaa-dialogs-toggle"),this.container.classList.add("ads-active-toggle")):(this.container.classList.remove("eitaa-dialogs-toggle"),this.container.classList.remove("ads-active-toggle"))}),this.setTitle("ArchivedChats"),!Jd.sortedLists[gr.filterId]){const e=Jd.createChatList();Jd.generateScrollable(e,gr.filterId).container.append(e),Jd.setListClickListener(e,null,!0)}const e=Jd.scrollables[gr.filterId];this.scrollable.container.replaceWith(e.container),this.scrollable=e}onOpen(){this.init&&(this.init(),this.init=null),this.wasFilterId=Jd.filterId,Jd.setFilterId(gr.filterId),Jd.onTabChange()}onOpenAfterTimeout(){Jd.sortedLists[this.wasFilterId].clear()}onClose(){Jd.setFilterId(this.wasFilterId),Jd.onTabChange()}onCloseAfterTimeout(){return Jd.sortedLists[gr.filterId].clear(),super.onCloseAfterTimeout()}}gr.filterId=1;var mr=s(25);class fr{constructor(e={}){const t=this.container=document.createElement("div");t.classList.add("sidebar-left-section-container");const s=this.innerContainer=document.createElement("div");if(s.classList.add("sidebar-left-section"),e.noShadow&&s.classList.add("no-shadow"),e.fakeGradientDelimiter)s.append(br()),s.classList.add("with-fake-delimiter");else if(e.noDelimiter)s.classList.add("no-delimiter");else{const e=document.createElement("hr");s.append(e)}const i=this.content=this.generateContentElement();if(e.name){const t=this.title=document.createElement("div");t.classList.add("sidebar-left-h2","sidebar-left-section-name"),Object(O.i18n_)({element:t,key:e.name,args:e.nameArgs}),i.append(t)}if(t.append(s),e.caption){const s=this.caption=this.generateContentElement();s.classList.add("sidebar-left-section-caption"),t.append(s),!0!==e.caption&&Object(O.i18n_)({element:s,key:e.caption,args:e.captionArgs})}}generateContentElement(){const e=document.createElement("div");return e.classList.add("sidebar-left-section-content"),this.innerContainer.append(e),e}}const vr=(e,t,s)=>{const i=new fr({name:t,caption:s});return e.append(i.container),i.content},br=()=>{const e=document.createElement("div");return e.classList.add("gradient-delimiter"),e},yr=new class extends Zs{constructor(){super({sidebarEl:document.getElementById("column-left"),navigationType:"left"}),this.searchGroups={},this.inputSearchValue="",this.saveNesesseryState=()=>{ee.a.set({savedSettings:H.default.settings});const e=js.filtersStorage.localFilters;ee.a.set({localFilters:e});const t=js.filtersStorage.getLocalPinnedDialogs();js.filtersStorage.setLocalPinnedStorage(t)},this.reloadApplication=()=>{Nt.a.overrideHash("#"),this.saveNesesseryState(),ve.default.reload()};const e=this.sidebarEl.querySelector(".item-main .sidebar-header"),t=Object(O.i18n)("AppName");t.classList.add("eitaa-title"),e.querySelector(".sidebar-header__btn-container").append(t),this.inputSearch=new qs("Search"),this.inputSearch.container.id="main-search",e.append(this.inputSearch.container);const s=()=>{new pr(this).open()};this.backBtn=this.sidebarEl.querySelector(".sidebar-back-button");const i={icon:"archive",text:"ArchivedChats",onClick:()=>{new gr(this).open()},verify:()=>!!js.dialogsStorage.getFolderDialogs(1,!1).length&&js.dialogsStorage.isDialogsLoaded(1)},n=new Gi.a({toggle:!0,checked:"night"===H.default.getTheme().name});n.input.addEventListener("change",()=>{H.default.settings.theme=n.input.checked?"night":"day",ve.default.pushToState("settings",H.default.settings),H.default.dispatchEvent("theme_change")}),H.default.addEventListener("theme_change",()=>{n.setValueSilently("night"===H.default.getTheme().name)});const a=new Gi.a({toggle:!0,checked:"rtl"===H.default.getDirection().name});a.input.addEventListener("change",()=>{H.default.settings.direction=a.input.checked?"rtl":"ltr",ve.default.pushToState("settings",H.default.settings),H.default.setDirection(),Pd.applyDirection()});let o=[{icon:"saved",text:"SavedMessages",onClick:()=>{setTimeout(()=>{Pd.setPeer(Pd.myId)},0)}},i,{icon:"user",text:"Contacts",onClick:s},{icon:"settings",text:"Settings",onClick:()=>{new rr(this).open()}},{icon:"darkmode",text:"DarkMode",onClick:()=>{},checkboxField:n},{icon:"animations",text:"Animations",onClick:()=>{},checkboxField:new Gi.a({toggle:!0,checked:!0,stateKey:"settings.animationsEnabled"})},{icon:"direction",text:"Eitaa.Direction",onClick:()=>{},checkboxField:a},{icon:"services",text:"Eitaa.Services",onClick:()=>{const e=document.createElement("a");e.target="_blank",e.href="https://pay.eitaa.com/?hash="+H.default.payHash,document.body.append(e),e.click(),setTimeout(()=>{ye.setUserPayHash(H.default.myId),e.remove()},0)}},{icon:"admin",text:"MyEitaa",onClick:()=>{const e=document.createElement("a");e.target="_blank",e.href="https://my.eitaa.com/?hash="+H.default.payHash,document.body.append(e),e.click(),setTimeout(()=>{ye.setUserPayHash(H.default.myId),e.remove()},0)}},{icon:"stop",text:"Eitaa.Reload",onClick:()=>{this.reloadApplication()}}];this.toolsBtn=Pi({},"bottom-right",o,e=>{o.forEach(e=>{e.verify&&e.element.classList.toggle("hide",!e.verify())})}),this.toolsBtn.classList.remove("tgico-more"),this.toolsBtn.classList.add("sidebar-tools-button","is-visible"),this.backBtn.parentElement.insertBefore(this.toolsBtn,this.backBtn);const r=this.toolsBtn.querySelector(".btn-menu"),l=document.createElement("a");l.href="https://web.eitaa.com",l.target="_blank",l.rel="noopener noreferrer",l.classList.add("btn-menu-footer"),l.addEventListener(v.a,e=>{e.stopPropagation(),Object(hi.c)()});const d=document.createElement("span");d.classList.add("btn-menu-footer-text"),"ios"===H.default.platform?d.innerHTML="Eitaa iOS "+H.default.version:d.innerHTML="Eitaa Web "+mr.a.versionFull,l.append(d),r.classList.add("has-footer"),r.append(l),this.newBtnMenu=Pi({},"top-left",[{icon:"newchannel",text:"NewChannel",onClick:()=>{new lr(this).open()}},{icon:"newgroup",text:"NewGroup",onClick:()=>{new Pn(this).open({type:"chat",skippable:!1,takeOut:e=>{new di(this).open(e)},title:"GroupAddMembers",placeholder:"SendMessageTo"})}},{icon:"newprivate",text:"NewPrivateChat",onClick:s}]),this.newBtnMenu.className="btn-circle rp btn-corner z-depth-1 btn-menu-toggle animated-button-icon",this.newBtnMenu.insertAdjacentHTML("afterbegin",'\n    <span class="tgico tgico-newchat_filled"></span>\n    <span class="tgico tgico-close"></span>\n    '),this.newBtnMenu.id="new-menu",e.nextElementSibling.append(this.newBtnMenu),this.inputSearch.input.addEventListener("focus",()=>this.initSearch(),{once:!0}),this.inputSearch.input.addEventListener("focus",()=>{document.querySelector("#main-search").classList.add("main-search-toggle");document.querySelector(".eitaa-title").style.display="none"}),ye.getTopPeers("correspondents"),ve.default.getState().then(e=>{const t=e.recentSearch||[];for(let e=0,s=t.length;e<s;++e)ve.default.requestPeer(t[e],"recentSearch")}),H.default.payHash||ye.setUserPayHash(H.default.myId)}initSearch(){const e=this.sidebarEl.querySelector("#search-container"),t=new re.b(e),s=()=>{this.backBtn.click()};this.searchGroups={contacts:new de(!1,"contacts",void 0,void 0,void 0,void 0,s),globalContacts:new de(!1,"contacts",void 0,void 0,void 0,void 0,s),messages:new de(!1,"messages"),people:new de(!1,"contacts",!0,"search-group-people",!0,!1,s),recent:new de("Recent","contacts",!0,"search-group-recent",!0,!0,s)};const i=this.searchSuper=new ao({mediaTabs:[{inputFilter:"inputMessagesFilterChats",name:"FilterChats",type:"chats"},{inputFilter:"inputMessagesFilterTitle",name:"Eitaa.SharedTitleTab",type:"title"},{inputFilter:"inputMessagesFilterPrivate",name:"Eitaa.SharedPrivateTab",type:"private"},{inputFilter:"inputMessagesFilterPublic",name:"Eitaa.SharedPublicTab",type:"public"},{inputFilter:"inputMessagesFilterGlobal",name:"Eitaa.SharedGlobalTab",type:"global"}],scrollable:t,searchGroups:this.searchGroups,asChatList:!0,hideEmptyTabs:!1,showSender:!0});e.prepend(i.nav.parentElement.parentElement),t.container.append(i.container);i.setQuery({peerId:"".toPeerId(),folderId:0}),i.selectTab(0),i.load(!0);let n=[],o="".toPeerId(),r=0,l=0;const d=()=>{this.inputSearch.container.classList.toggle("is-picked-twice",2===n.length),this.inputSearch.container.classList.toggle("is-picked",!!n.length),n.length?this.inputSearch.input.style.setProperty("--paddingLeft",n[n.length-1].getBoundingClientRect().right-this.inputSearch.input.getBoundingClientRect().left+"px"):this.inputSearch.input.style.removeProperty("--paddingLeft")};(()=>{const e=document.createElement("div");e.classList.add("sub-search-super-tabs-scrollable","menu-horizontal-scrollable","sticky"),e.style.display="none";const t=new re.a(e);t.container.classList.add("sub-search-super-nav-scrollable");const s=document.createElement("div");s.classList.add("sub-search-super-tabs","menu-horizontal-div"),t.container.append(s),["all","text","image","video","music","file"].forEach(e=>{const t=document.createElement("div");t.dataset.type=e,t.classList.add("sub-search-super-item","menu-horizontal-div-item"),"all"===e&&t.classList.add("active");const n=document.createElement("span"),a=document.createElement("i");switch(e){case"all":n.append(Object(O.i18n)("Eitaa.SubSearchSuper.All"));break;case"text":n.append(Object(O.i18n)("Eitaa.SubSearchSuper.Text"));break;case"image":n.append(Object(O.i18n)("Eitaa.SubSearchSuper.Image"));break;case"video":n.append(Object(O.i18n)("Eitaa.SubSearchSuper.Video"));break;case"music":n.append(Object(O.i18n)("Eitaa.SubSearchSuper.Music"));break;case"file":n.append(Object(O.i18n)("Eitaa.SubSearchSuper.File"))}n.append(a),t.append(n),Object(ei.ripple)(t),s.append(t),t.addEventListener("click",e=>{const n=s.querySelectorAll(".sub-search-super-item");t.classList.contains("active")||(n.forEach(e=>{e.classList.remove("active")}),t.classList.add("active"),i.cleanupHTML(),i.setQuery({peerId:o,folderId:o?void 0:0,query:this.inputSearchValue,minDate:r,maxDate:l}),i.load(!0))})}),document.querySelector("#search-container").insertBefore(e,document.querySelector("#search-container .search-super-tabs-scrollable").nextSibling)})();const c=e=>{0===e.dataset.key.indexOf("date_")?r=l=0:o="".toPeerId(),e.remove(),Object(a.f)(n,e),setTimeout(()=>{d(),this.inputSearch.onChange(this.inputSearch.value)},0)};this.inputSearch.onClear=()=>{n.forEach(e=>{c(e)})},this.inputSearch.onChange=e=>{this.inputSearchValue=e,i.cleanupHTML(),i.setQuery({peerId:o,folderId:o?void 0:0,query:e,minDate:r,maxDate:l}),i.load(!0)};let h,u=!0;const p=Object(Vs.a)(e.parentElement,"zoom-fade",150,e=>{h&&clearTimeout(h),0!==e||u||(i.selectTab(0,!1),this.inputSearch.onClearClick(),h=window.setTimeout(()=>{h=0,this.newBtnMenu.classList.remove("is-hidden")},150)),u=!1});p(0);const g=()=>{this.toolsBtn.classList.remove("is-visible"),this.backBtn.classList.add("is-visible"),this.newBtnMenu.classList.add("is-hidden"),this.toolsBtn.parentElement.firstElementChild.classList.toggle("state-back",!0),C.IS_MOBILE_SAFARI||Nt.a.findItemByType("global-search")||Nt.a.pushItem({onPop:()=>{s()},type:"global-search"}),p(1)};this.inputSearch.input.addEventListener("focus",g),g(),this.backBtn.addEventListener("click",e=>{document.querySelector("#main-search").classList.remove("main-search-toggle");document.querySelector(".eitaa-title").style.display="inline",this.toolsBtn.classList.add("is-visible"),this.backBtn.classList.remove("is-visible"),this.toolsBtn.parentElement.firstElementChild.classList.toggle("state-back",!1),Nt.a.removeByType("global-search"),p(0)});const m=document.createElement("button");m.classList.add("btn-icon","tgico-close"),this.searchGroups.recent.nameEl.append(m),m.addEventListener("click",()=>{this.searchGroups.recent.clear(),ve.default.pushToState("recentSearch",[])})}};j.a.appSidebarLeft=yr;var wr=yr;class Sr{constructor(e){this.chat=e,this.bubbles=[],this.detailsMap=new Map,this.groups=[],this.newGroupDiff=121}removeBubble(e){const t=this.detailsMap.get(e);t&&(t.group.length&&(t.group.findAndSplice(t=>t.bubble===e),t.group.length?this.updateGroup(t.group):Object(a.f)(this.groups,t.group)),this.detailsMap.delete(e))}changeBubbleMid(e,t){const s=this.detailsMap.get(e);s&&(s.mid=t)}addBubble(e,t,s){const i=t.date,n=t.mid;let a,o=t.viaBotId||t.fromId;o===H.default.myId&&t.peerId===H.default.myId&&t.fwdFromId===o&&(o=o.toPeerId(!0)),this.removeBubble(e);const r={bubble:e,mid:n,timestamp:i};if(this.bubbles.length){let e,t=-1;for(let e=0;e<this.bubbles.length;++e){const s=this.bubbles[e],a=Math.abs(s.timestamp-i);if(s.fromId===o&&a<=this.newGroupDiff){if(t=e,"scheduled"===this.chat.type)break}else t=-1;if("scheduled"!==this.chat.type&&n>s.mid)break}if(-1!==t&&(e=this.bubbles[t]),e){a=e.group;let t=0,s=0;for(;t<a.length;++t){const e=a[t].timestamp,o=a[t].mid;if(i<e)break;if(i===e&&(s=o),s&&n<s)break}a.splice(t,0,r)}else this.groups.push(a=[r])}else this.groups.push(a=[r]);const l={timestamp:i,fromId:o,mid:t.mid,group:a};let d=0;for(;d<this.bubbles.length&&!(this.bubbles[d].mid<n);++d);this.bubbles.splice(d,0,{timestamp:i,fromId:o,mid:t.mid,group:a}),this.updateGroup(a),this.detailsMap.set(e,l)}updateGroup(e){if(!e.length)return;const t=e[0].bubble;if(1===e.length)return void t.classList.add("is-group-first","is-group-last");t.classList.remove("is-group-last"),t.classList.add("is-group-first");const s=e.length-1;for(let t=1;t<s;++t){e[t].bubble.classList.remove("is-group-last","is-group-first")}const i=e[e.length-1].bubble;i.classList.remove("is-group-first"),i.classList.add("is-group-last")}updateGroupByMessageId(e){const t=this.bubbles.find(t=>t.mid===e);t&&this.updateGroup(t.group)}cleanup(){this.bubbles=[],this.groups=[],this.detailsMap.clear()}}const Ir=[31,28,31,30,31,30,31,31,30,31,30,31],Mr=[31,31,31,31,31,31,30,30,30,30,30,29];class Cr extends Date{constructor(...e){super(...e),this.toLocaleDateString=e=>super.toLocaleDateString("fa-IR-u-nu-latn"),this.getParts=()=>this.toLocaleDateString().split("/"),this.getDay=()=>6===super.getDay()?0:super.getDay()+1,this.getMonth=()=>parseInt(this.getParts()[1],10),this.getYear=()=>this.getParts()[0]}}class Pr extends ni{constructor(e,t,s={}){if(super("popup-date-picker",s.noButtons?[]:[{langKey:"JumpToDate",callback:()=>{this.onPick&&this.onPick(this.selectedDate.getTime()/1e3|0)}},{langKey:"Cancel",isCancel:!0}],Object.assign({body:!0,overlayClosable:!0},s)),this.onPick=t,this.options=s,this.onPrevClick=e=>{if(this.isJalali){const e=this.jalaliToGregorian(this.selectedMonth,-1);this.selectedMonth.setFullYear(e[0],e[1]-1,e[2])}else this.selectedMonth.setMonth(this.selectedMonth.getMonth()-1);this.setMonth(),this.selectedMonth.getTime()===this.minMonth.getTime()&&this.prevBtn.setAttribute("disabled","true"),this.nextBtn.removeAttribute("disabled")},this.onNextClick=e=>{if(this.isJalali){const e=this.jalaliToGregorian(this.selectedMonth,1);this.selectedMonth.setFullYear(e[0],e[1]-1,e[2])}else this.selectedMonth.setMonth(this.selectedMonth.getMonth()+1);this.setMonth(),this.selectedMonth.getTime()===this.maxMonth.getTime()&&this.nextBtn.setAttribute("disabled","true"),this.prevBtn.removeAttribute("disabled")},this.onDateClick=e=>{const t=e.target;if(!t.dataset.timestamp)return;if(this.selectedEl){if(this.selectedEl===t)return;this.selectedEl.classList.remove("active")}this.selectedEl=t,t.classList.add("active");const s=+t.dataset.timestamp;this.selectedDate=new Date(s),this.setTitle(),this.setTimeTitle()},this.jalaliToGregorian=(e,t)=>{let s=parseInt(e.getYear()),i=e.getMonth()+(t||0);0===i?(s--,i=12):13===i&&(s++,i=1);return((e,t,s)=>{let i=(e=parseInt(String(e)))-979,n=(t=parseInt(String(t)))-1,a=(s=parseInt(String(s)))-1,o=365*i+8*parseInt(String(i/33))+parseInt(String((i%33+3)/4));for(let e=0;e<n;++e)o+=Mr[e];o+=a;let r=o+79,l=1600+400*parseInt(String(r/146097));r%=146097;let d,c=!0;for(r>=36525&&(r--,l+=100*parseInt(String(r/36524)),r%=36524,r>=365?r++:c=!1),l+=4*parseInt(String(r/1461)),r%=1461,r>=366&&(c=!1,r--,l+=parseInt(String(r/365)),r%=365),d=0;r>=Ir[d]+Number(1==d&&c);d++)r-=Ir[d]+Number(1==d&&c);let h=d+1,u=r+1;return h=h<10?"0"+h:String(h),u=u<10?"0"+u:String(u),[l,parseInt(h),parseInt(u)]})(s,i,1)},this.isNotEndOfMonth=e=>{if(this.isJalali){const t=new O.default.IntlDateElement({date:e,options:{day:"numeric"}}).element.innerText;return"Û±"!==t&&"1"!==t}return 1!==e.getDate()},this.isJalali="fa"===O.default.lastAppliedLangCode,this.minDate=s.minDate||new Date("2013-08-01T00:00:00"),e<this.minDate&&e.setFullYear(this.minDate.getFullYear(),this.minDate.getMonth(),this.minDate.getDate()),this.controlsDiv=document.createElement("div"),this.controlsDiv.classList.add("date-picker-controls"),this.prevBtn=document.createElement("button"),this.prevBtn.classList.add("btn-icon","tgico-down","date-picker-prev"),Object(v.b)(this.prevBtn,this.onPrevClick,{listenerSetter:this.listenerSetter}),this.nextBtn=document.createElement("button"),this.nextBtn.classList.add("btn-icon","tgico-down","date-picker-next"),Object(v.b)(this.nextBtn,this.onNextClick,{listenerSetter:this.listenerSetter}),this.monthTitle=document.createElement("div"),this.monthTitle.classList.add("date-picker-month-title"),this.controlsDiv.append(this.prevBtn,this.monthTitle,this.nextBtn),this.monthsContainer=document.createElement("div"),this.monthsContainer.classList.add("date-picker-months"),Object(v.b)(this.monthsContainer,this.onDateClick,{listenerSetter:this.listenerSetter}),this.body.append(this.controlsDiv,this.monthsContainer),s.withTime){this.timeDiv=document.createElement("div"),this.timeDiv.classList.add("date-picker-time");const t=document.createElement("div");t.classList.add("date-picker-time-delimiter"),t.append(":");const s=(e,t,s,i)=>{const n=""+e;this.listenerSetter.add(t.input)("input",a=>{let o=t.value.replace(/\D/g,"");o.length>2?o=o.slice(0,2):(1===o.length&&+o[0]>+n[0]||2===o.length&&+o>e)&&(2===o.length&&i&&i(+o[1]),o="0"+o[0]),t.setValueSilently(o),s(o.length)})};this.hoursInputField=new Ws.b({plainText:!0}),this.minutesInputField=new Ws.b({plainText:!0}),s(23,this.hoursInputField,e=>{2===e&&this.minutesInputField.input.focus(),this.setTimeTitle()},e=>{this.minutesInputField.value=(e+this.minutesInputField.value).slice(0,2)}),s(59,this.minutesInputField,e=>{e||this.hoursInputField.input.focus(),this.setTimeTitle()}),this.selectedDate=e,e.setMinutes(e.getMinutes()+10),this.hoursInputField.setValueSilently(("0"+e.getHours()).slice(-2)),this.minutesInputField.setValueSilently(("0"+e.getMinutes()).slice(-2)),e.setHours(0,0,0,0),this.timeDiv.append(this.hoursInputField.container,t,this.minutesInputField.container),Object(v.b)(this.btnConfirm,()=>{this.onPick&&(this.selectedDate.setHours(+this.hoursInputField.value||0,+this.minutesInputField.value||0,0,0),this.onPick(this.selectedDate.getTime()/1e3|0)),this.hide()},{listenerSetter:this.listenerSetter}),this.body.append(this.timeDiv),this.prevBtn.classList.add("primary"),this.nextBtn.classList.add("primary")}const i=document.createElement("div");if(i.classList.add("popup-centerer"),i.append(this.container),this.element.append(i),e.setHours(0,0,0,0),this.selectedDate=e,this.maxDate=s.maxDate||new Date,this.maxDate.setHours(0,0,0,0),this.isJalali){this.selectedMonth=new Cr(this.selectedDate);const e=this.jalaliToGregorian(this.selectedMonth);this.selectedMonth.setFullYear(e[0],e[1]-1,e[2])}else this.selectedMonth=new Date(this.selectedDate),this.selectedMonth.setDate(1);if(this.isJalali){this.maxMonth=new Cr(this.maxDate);const e=this.jalaliToGregorian(this.maxMonth);this.maxMonth.setFullYear(e[0],e[1]-1,e[2])}else this.maxMonth=new Date(this.maxDate),this.maxMonth.setDate(1);if(this.isJalali){this.minMonth=new Cr(this.minDate),this.minMonth.setHours(0,0,0,0);const e=this.jalaliToGregorian(this.minMonth);this.minMonth.setFullYear(e[0],e[1]-1,e[2])}else this.minMonth=new Date(this.minDate),this.minMonth.setHours(0,0,0,0),this.minMonth.setDate(1);this.selectedMonth.getTime()===this.minMonth.getTime()&&this.prevBtn.setAttribute("disabled","true"),this.selectedMonth.getTime()===this.maxMonth.getTime()&&this.nextBtn.setAttribute("disabled","true"),s.noTitle&&(this.setTitle=()=>{}),this.setTimeTitle(),this.setTitle(),this.setMonth()}setTimeTitle(){if(this.btnConfirm&&this.selectedDate){let e,t=[];const s=new Date;s.setHours(0,0,0,0);const i={minute:"2-digit",hour:"2-digit"},n=new Date(this.selectedDate.getTime());if(n.setHours(+this.hoursInputField.value,+this.minutesInputField.value),this.selectedDate.getTime()===s.getTime())e="Schedule.SendToday";else{e="Schedule.SendDate";const i={month:"short",day:"numeric"};n.getFullYear()!==s.getFullYear()&&(i.year="numeric"),t.push(new O.default.IntlDateElement({date:n,options:i}).element)}t.push(new O.default.IntlDateElement({date:n,options:i}).element),this.btnConfirm.firstChild.replaceWith(Object(O.i18n)(e,t))}}setTitle(){this.title.textContent="",this.title.append(new O.default.IntlDateElement({date:this.selectedDate,options:{day:"numeric",month:"long",weekday:"short"}}).element)}renderElement(e,t=""){const s=document.createElement("button");return s.classList.add("btn-icon","date-picker-month-date"),e&&s.setAttribute("disabled","true"),t&&s.append(t),s}setMonth(){const e=new Date(this.selectedMonth),t={year:"numeric",month:this.timeDiv&&I.b.isMobile?"short":"long"};this.monthTitle.textContent="",this.monthTitle.append(new O.default.IntlDateElement({date:e,options:t}).element),this.month&&this.month.remove(),this.month=document.createElement("div"),this.month.classList.add("date-picker-month");const s=new Date;let i,n=s.getDay()+1;this.isJalali&&n++,1!==n&&s.setHours(-24*(n-1));for(let e=0;e<7;++e){const e=this.renderElement(!0,new O.default.IntlDateElement({date:s,options:{weekday:"narrow"}}).element);e.classList.remove("date-picker-month-date"),e.classList.add("date-picker-month-day"),this.month.append(e),s.setDate(s.getDate()+1)}this.isJalali?(i=e.getDay()+1,7===i&&(i=0)):(i=e.getDay()-1,-1===i&&(i=6));const a=new Date(e.getTime());a.setDate(a.getDate()-i-1);for(let e=0;e<i;++e)this.options.showOverflowMonths?(a.setDate(a.getDate()+1),this.month.append(this.renderElement(!0,""+a.getDate()))):this.month.append(this.renderElement(!0));do{const t=e.getDate(),s=this.isJalali?new O.default.IntlDateElement({date:e,options:{day:"numeric"}}).element.innerText:""+t,i=this.renderElement(e>this.maxDate||e<this.minDate,s);i.dataset.timestamp=""+e.getTime(),e.getTime()===this.selectedDate.getTime()&&(this.selectedEl=i,i.classList.add("active")),this.month.append(i),e.setDate(t+1)}while(this.isNotEndOfMonth(e));const o=this.month.childElementCount%7;if(this.options.showOverflowMonths&&o)for(let t=o;t<7;++t)this.month.append(this.renderElement(!0,""+e.getDate())),e.setDate(e.getDate()+1);const r=Math.ceil(this.month.childElementCount/7);this.container.dataset.lines=""+r,this.monthsContainer.append(this.month)}}class Lr extends ni{constructor(e){super("popup-stickers",null,{closable:!0,overlayClosable:!0,body:!0}),this.stickerSetInput=e,this.onStickersClick=e=>{const t=Object(ti.a)(e.target,"sticker-set-sticker");if(!t)return;const s=t.dataset.docId;Pd.chat.input.sendMessageWithDocument(s)?this.hide():console.warn("got no doc by id:",s)},this.h6=document.createElement("h6"),this.h6.append(Object(O.i18n)("Loading")),this.header.append(this.h6),this.addEventListener("close",()=>{zs.a.setOnlyOnePlayableGroup("")});const t=document.createElement("div");t.classList.add("sticker-set"),this.stickersDiv=document.createElement("div"),this.stickersDiv.classList.add("sticker-set-stickers","is-loading"),Object(v.b)(this.stickersDiv,this.onStickersClick,{listenerSetter:this.listenerSetter}),Object(hi.f)(this.stickersDiv,!0),this.stickersFooter=document.createElement("div"),this.stickersFooter.classList.add("sticker-set-footer"),t.append(this.stickersDiv);const s=Object(Ks.a)("btn-primary btn-primary-transparent disable-hover",{noRipple:!0,text:"Loading"});this.stickersFooter.append(s),this.body.append(t);new re.b(this.body);this.body.append(this.stickersFooter),this.loadStickerSet()}loadStickerSet(){return Ea.getStickerSet(this.stickerSetInput).then(e=>{let t;this.set=e.set,zs.a.setOnlyOnePlayableGroup("STICKERS-POPUP"),Object(xe.a)(this.h6,N.a.wrapEmojiText(e.set.title)),this.stickersFooter.classList.toggle("add",!e.set.installed_date),e.set.installed_date?(t=Object(Ks.a)("btn-primary btn-primary-transparent danger",{noRipple:!0}),t.append(Object(O.i18n)("RemoveStickersCount",[Object(O.i18n)("Stickers",[e.set.count])]))):(t=Object(Ks.a)("btn-primary btn-color-primary",{noRipple:!0}),t.append(Object(O.i18n)("AddStickersCount",[Object(O.i18n)("Stickers",[e.set.count])]))),this.stickersFooter.textContent="",this.stickersFooter.append(t),Object(v.b)(t,()=>{const e=Object(tn.a)([t],!0);Ea.toggleStickerSet(this.set).then(()=>{this.hide()}).catch(()=>{e()})});const s=new c;this.stickersDiv.classList.remove("is-loading"),this.stickersDiv.innerHTML="";for(let t of e.documents){if("documentEmpty"===t._)continue;const e=document.createElement("div");e.classList.add("sticker-set-sticker");const i=I.b.active.esgSticker.width;Da({doc:t,div:e,lazyLoadQueue:s,group:"STICKERS-POPUP",play:!0,loop:!0,width:i,height:i}),this.stickersDiv.append(e)}})}}class Er{constructor(e,t){this.container=e,this.handler=t,this.observeHeaders(),this.observeElements()}observeHeaders(){this.headersObserver=new IntersectionObserver(e=>{for(const t of e){const e=t.boundingClientRect,s=t.target.parentElement,i=t.rootBounds;e.bottom<i.top&&this.handler(!0,s),e.bottom>=i.top&&e.bottom<i.bottom&&this.handler(!1,s)}},{threshold:0,root:this.container})}observeElements(){this.elementsObserver=new IntersectionObserver(e=>{let t=e.filter(e=>e.boundingClientRect.top<0).sort((e,t)=>e.boundingClientRect.top-t.boundingClientRect.top)[0];if(!t)return;let s=t.isIntersecting?t.target:t.target.nextElementSibling;this.handler(!0,s)},{root:this.container})}addSentinel(e,t){const s=document.createElement("div");return s.classList.add("sticky_sentinel",t),e.appendChild(s)}observeStickyHeaderChanges(e){const t=this.addSentinel(e,"sticky_sentinel--top");this.headersObserver.observe(t),this.elementsObserver.observe(e)}disconnect(){this.headersObserver.disconnect(),this.elementsObserver.disconnect()}unobserve(e,t){this.elementsObserver.unobserve(e),this.headersObserver.unobserve(t)}}H.default.addEventListener("replies_updated",e=>{const t=e;Array.from(document.querySelectorAll(`replies-element[data-post-key="${t.peerId}_${t.mid}"]`)).forEach(e=>{e.message=t,e.render()})});class _r extends HTMLElement{constructor(){super(),this.updated=!1}init(){this.render(),this.dataset.postKey=this.message.peerId+"_"+this.message.mid,this.classList.add("replies","replies-"+this.type)}render(){const e=this.message.replies;if("footer"===this.type){let t,s;if(this.firstElementChild&&(t=this.firstElementChild),(null==e?void 0:e.recent_repliers)?(t&&!t.classList.contains("replies-footer-avatars")&&(this.innerHTML="",t=null),t||(t=document.createElement("div"),t.classList.add("replies-footer-avatars")),e.recent_repliers.slice().reverse().forEach((e,s)=>{let i=t.children[s];i||(i=new Od,i.setAttribute("dialog","0"),i.classList.add("avatar-30"),i.lazyLoadQueue=this.lazyLoadQueue,this.loadPromises&&(i.loadPromises=this.loadPromises)),i.setAttribute("peer",""+Te.getPeerId(e)),i.parentNode||t.append(i)}),Array.from(t.children).slice(e.recent_repliers.length).forEach(e=>e.remove())):(t&&!t.classList.contains("tgico-comments")&&(t.remove(),t=null),t||(t=document.createElement("span"),t.classList.add("tgico-comments"))),t.parentElement||this.append(t),s=e?e.replies?Object(O.i18n)("Comments",[e.replies]):Object(O.i18n)("LeaveAComment"):Object(O.i18n)("ViewInChat"),e){const t=js.getHistoryStorage(e.channel_id.toPeerId(!0));let s=!1;e.replies&&(s=void 0!==e.read_max_id&&void 0!==e.max_id?e.read_max_id<e.max_id:!t.readMaxId||t.readMaxId<(e.max_id||0)),this.classList.toggle("is-unread",s)}let i=this.children[1];if(!i){i=document.createElement("span"),i.classList.add("replies-footer-text");const e=document.createElement("span");e.classList.add("tgico-next");const t=document.createElement("div");Object(ei.ripple)(t),this.append(i,e,t)}Object(le.a)(i,s)}else this.classList.add("bubble-beside-button"),this.innerHTML=`<span class="tgico-commentssticker"></span><span class="replies-beside-text">${(null==e?void 0:e.replies)?Object(ds.c)(e.replies,0):""}</span>`;!e||this.updated||this.message.pFlags.is_outgoing||(js.subscribeRepliesThread(this.message.peerId,this.message.mid),js.updateMessage(this.message.peerId,this.message.mid,"replies_updated"),this.updated=!0),this.loadPromises&&(this.loadPromises=void 0)}}customElements.define("replies-element",_r);const kr=()=>{const e=document.createElement("i");return e.classList.add("edited"),Object(O._i18n)(e,"EditedMessage"),e};var Tr,xr;function Ar(e,t,s){const i=e.getBoundingClientRect(),n="center"===s?Math.ceil(i.left+(i.right-i.left)/2+1):Math.ceil(i.left+1),a="bottom"===t?Math.floor(i.top+i.height-1):Math.ceil(i.top+1);return document.elementFromPoint(n,a)}function Or(e){e.style.display="none",e.offsetLeft,e.style.display=""}(xr=Tr||(Tr={})).setTime=(e,t,s,i,n)=>{var a,o;const r=new Date(1e3*t.date),l=[];let d,c=Object(S.d)(r);if(t.views){let e=t.post_author||(null===(a=t.fwd_from)||void 0===a?void 0:a.post_author);if("peerUser"===(null===(o=null==t?void 0:t.from_id)||void 0===o?void 0:o._)){const s=ye.getUser(t.from_id.user_id);e=s.first_name+(s.last_name?" "+s.last_name:"")}s.classList.add("channel-post");const i=document.createElement("span");i.classList.add("post-views"),i.innerHTML=Object(ds.c)(t.views,1);const n=document.createElement("i");if(n.classList.add("tgico-channelviews","time-icon"),l.push(i,n),e){const t=document.createElement("span");Object(xe.a)(t,N.b.wrapEmojiText(e)),t.insertAdjacentHTML("beforeend",",&nbsp;"),l.push(t)}}if(t.edit_date&&"scheduled"!==e.type&&!t.pFlags.edit_hide&&(s.classList.add("is-edited"),l.unshift(d=kr())),"pinned"!==e.type&&t.pFlags.pinned){s.classList.add("is-pinned");const e=document.createElement("i");e.classList.add("tgico-pinnedchat","time-icon"),l.unshift(e)}l.push(c);const h=Object(S.e)(r)+(t.edit_date?"\nEdited: "+Object(S.e)(new Date(1e3*t.edit_date)):"")+(t.fwd_from?"\nOriginal: "+Object(S.e)(new Date(1e3*t.fwd_from.date)):""),u=document.createElement("span");u.classList.add("time","tgico"),u.title=h,u.append(...l);const p=document.createElement("div");p.classList.add("inner","tgico"),p.title=h;let g=l;return d&&(g[g.indexOf(d)]=kr()),g=g.map(e=>e instanceof HTMLElement&&!e.classList.contains("i18n")?e.cloneNode(!0):e),g[g.length-1]=Object(S.d)(r),p.append(...g),u.append(p),n.append(u),u},xr.renderReplies=({bubble:e,bubbleContainer:t,message:s,messageDiv:i,loadPromises:n,lazyLoadQueue:a})=>{const o=!e.classList.contains("sticker")&&!e.classList.contains("emoji-big")&&!e.classList.contains("round"),r=new _r;return r.message=s,r.type=o?"footer":"beside",r.loadPromises=n,r.lazyLoadQueue=a,r.init(),t.prepend(r),o},xr.setReply=({chat:e,bubble:t,bubbleContainer:s,message:i})=>{const n=!s;n&&(s=t.querySelector(".bubble-content"));const a=n?s.querySelector(".reply"):null;if(!i.reply_to_mid)return a&&a.remove(),void t.classList.remove("is-reply");const o=i.reply_to.reply_to_peer_id?e.appPeersManager.getPeerId(i.reply_to.reply_to_peer_id):e.peerId;let r,l=e.appMessagesManager.getMessageByPeer(o,i.reply_to_mid);"messageEmpty"===l._?(e.appMessagesManager.wrapSingleMessage(o,i.reply_to_mid),e.bubbles.needUpdate.push({replyToPeerId:o,replyMid:i.reply_to_mid,mid:i.mid}),r=Object(O.i18n)("Loading")):r=new Oe({peerId:l.fromId||l.fwdFromId,dialog:!1,onlyFirstName:!1,plainText:!1}).element;const d=ja(r,void 0,l);a?a.replaceWith(d):s.append(d),t.classList.add("is-reply")},j.a.getElementByPoint=Ar;const Fr={keywords:{},version:0,langCode:mr.a.langPackCode};class Dr{constructor(){this.keywordLangPacks={},this.indexedLangPacks={},this.getKeywordsPromises={}}getEmojiKeywords(e=mr.a.langPackCode){const t=this.getKeywordsPromises[e];if(t)return t;const s="emojiKeywords_"+e;return this.getKeywordsPromises[e]=ss.a.get(s).then(t=>(Object(ts.b)(t)||(t={}),Object(m.k)(Fr,t),t.langCode=e,this.keywordLangPacks[e]=t,F.a.invokeApi("messages.getEmojiKeywordsDifference",{lang_code:t.langCode,from_version:t.version}).then(e=>{t.version=e.version;const i=t.keywords,n=e.keywords;for(let e=0,t=n.length;e<t;++e){const{keyword:t,emoticons:s}=n[e];i[t]=s}return ss.a.set({[s]:t}),t},()=>t)))}getBothEmojiKeywords(){const e=[this.getEmojiKeywords()];return O.default.lastRequestedLangCode!==mr.a.langPackCode&&e.push(this.getEmojiKeywords(O.default.lastRequestedLangCode)),this.recent||e.push(this.getRecentEmojis()),Promise.all(e)}indexEmojis(){this.index||(this.index=new $(void 0,2));for(const e in this.keywordLangPacks){if(this.indexedLangPacks[e])continue;const t=this.keywordLangPacks[e].keywords;for(const e in t){const s=t[e];this.index.indexObject(s,e)}this.indexedLangPacks[e]=!0}}searchEmojis(e){let t;if(this.indexEmojis(),(e=e.toLowerCase().replace(/_/g," ")).trim()){const s=this.index.search(e);t=Array.from(s).reduce((e,t)=>e.concat(t),[])}else t=this.recent.concat(Dr.POPULAR_EMOJI).slice(0,36);return t=Array.from(new Set(t)),t}getRecentEmojis(){return this.getRecentEmojisPromise?this.getRecentEmojisPromise:this.getRecentEmojisPromise=ve.default.getState().then(e=>this.recent=Array.isArray(e.recentEmoji)?e.recentEmoji:[])}pushRecentEmoji(e){e=N.b.fixEmoji(e),this.getRecentEmojis().then(t=>{Object(a.f)(t,e),t.unshift(e),t.length>36&&(t.length=36),ve.default.pushToState("recentEmoji",t),H.default.dispatchEvent("emoji_recent",e)})}}Dr.POPULAR_EMOJI=["ðŸ˜‚","ðŸ˜˜","â¤ï¸","ðŸ˜","ðŸ˜Š","ðŸ˜","ðŸ‘","â˜ºï¸","ðŸ˜”","ðŸ˜„","ðŸ˜­","ðŸ’‹","ðŸ˜’","ðŸ˜³","ðŸ˜œ","ðŸ™ˆ","ðŸ˜‰","ðŸ˜ƒ","ðŸ˜¢","ðŸ˜","ðŸ˜±","ðŸ˜¡","ðŸ˜","ðŸ˜ž","ðŸ˜…","ðŸ˜š","ðŸ™Š","ðŸ˜Œ","ðŸ˜€","ðŸ˜‹","ðŸ˜†","ðŸ‘Œ","ðŸ˜","ðŸ˜•"];const jr=new Dr;j.a&&(j.a.appEmojiManager=jr);var Rr=jr,Br=s(92),Ur=s(198);const Nr=new Set;function Hr(e,t,s=!1,i=!1){var n;const a=document.createElement("span");let o;if(a.classList.add("super-emoji"),i&&!Br.a?o=N.a.wrapSingleEmoji(e):(e=N.a.fixEmoji(e),o=N.a.wrapEmojiText(e)),a.append(o),a.children.length>1){const e=a.firstElementChild;a.innerHTML="",a.append(e)}if("IMG"===(null===(n=a.firstElementChild)||void 0===n?void 0:n.tagName)){const e=a.firstElementChild,t=e.src;if(!Nr.has(t)){e.setAttribute("loading","lazy");const s=document.createElement("span");s.classList.add("emoji-placeholder"),H.default.settings.animationsEnabled&&(e.style.opacity="0",s.style.opacity="1"),e.addEventListener("load",()=>{Object(g.b)(()=>{H.default.settings.animationsEnabled&&(e.style.opacity="",s.style.opacity=""),a.classList.remove("empty"),Nr.add(t)})},{once:!0}),a.append(s)}}s?t.prepend(a):t.appendChild(a)}function zr(e){return Object(ti.a)(e,"super-emoji")?3===e.nodeType?e.nodeValue:("SPAN"===e.tagName&&!e.classList.contains("emoji")&&e.firstElementChild&&(e=e.firstElementChild),e.getAttribute("alt")||e.innerText):""}class Wr{constructor(){this.closeScrollTop=0,this.onContentClick=e=>{Object(f.a)(e);const t=zr(e.target);t&&(Pd.chat.input.onEmojiSelected(t,!1),Ht.IS_TOUCH_SUPPORTED&&Object(si.a)())}}init(){this.content=document.getElementById("content-emoji");const e=["Emoji.SmilesAndPeople","Emoji.AnimalsAndNature","Emoji.FoodAndDrink","Emoji.TravelAndPlaces","Emoji.ActivityAndSport","Emoji.Objects","Emoji.Flags","Skin Tones"],t={},s=new Map([["Emoji.Recent",[]]]);for(const t in Ur.b){const i=""+Ur.b[t],n=e[+i[0]-1];if(!n)continue;let a=s.get(n);a||(a=[],s.set(n,a)),a[+i.slice(1)||0]=t}s.delete(e.pop()),s.forEach((e,s)=>{const i=document.createElement("div");i.classList.add("emoji-category");const n=document.createElement("div");n.classList.add("category-title"),n.append(Object(O.i18n)(s));const a=document.createElement("div");a.classList.add("super-emojis"),i.append(n,a),e.forEach(e=>{Hr(Object(ui.a)(e),a,!1)}),t[s]=i});const i=this.menu=this.content.previousElementSibling,n=this.scroll=new re.b(this.content,"EMOJI"),a=Object(hi.f)(this.content,!0);Promise.all([Object(M.a)(200),Rr.getRecentEmojis().then(e=>{const t=!!e.length,s=t?0:1;this.menu.children[0].classList.toggle("hide",!t),this.menu.children[s].classList.add("active");const a=ol.menuOnClick(i,n,void 0,s);return this.stickyIntersector=a.stickyIntersector,this.setMenuActive=a.setActive,e})]).then(([s,i])=>{a.remove(),this.recentItemsDiv=t["Emoji.Recent"].querySelector(".super-emojis");for(const e of i)Hr(e,this.recentItemsDiv);this.recentItemsDiv.parentElement.classList.toggle("hide",!this.recentItemsDiv.childElementCount),e.unshift("Emoji.Recent"),e.map(e=>{const s=t[e];return s||console.error("no div by category:",e),n.container.append(s),this.stickyIntersector.observeStickyHeaderChanges(s),s})}),this.content.addEventListener("click",this.onContentClick),this.init=null,H.default.addEventListener("emoji_recent",e=>{const t=Array.from(this.recentItemsDiv.children);for(let s=0,i=t.length;s<i;++s){const i=t[s];if(e===N.a.fixEmoji(zr(i))){if(0===s)return;i.remove()}}Hr(e,this.recentItemsDiv,!0),this.recentItemsDiv.parentElement.classList.remove("hide"),this.menu.children[0].classList.remove("hide"),this.closeScrollTop||this.setMenuActive(0)}),ll.addEventListener("close",()=>{this.closeScrollTop=this.scroll.scrollTop})}onClose(){}}var qr=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class Vr{constructor(e,t,s,i=!0){this.element=e,this.group=t,this.scrollable=s,this.scrollPromise=Promise.resolve(),this.timeout=0,this.onScroll=()=>{this.timeout?clearTimeout(this.timeout):this.scrollPromise=Object(w.a)(),this.timeout=window.setTimeout(()=>{this.timeout=0,this.scrollPromise.resolve()},150)},this.processInvisibleDiv=e=>this.scrollPromise.then(()=>qr(this,void 0,void 0,(function*(){if(this.lazyLoadQueue.intersector.isVisible(e))return;const t=e.querySelector("video"),s=e.querySelector("img");if(s&&(s&&s.classList.remove("hide"),yield Object(g.a)()),!this.lazyLoadQueue.intersector.isVisible(e)&&t){t.remove(),t.src="",t.load();zs.a.getAnimations(t).forEach(e=>{zs.a.checkAnimation(e,!0,!0)})}}))),this.lazyLoadQueue=new u(void 0,(e,t)=>{t?this.processVisibleDiv(e):this.processInvisibleDiv(e)}),i&&this.attach()}attach(){this.scrollable.container.addEventListener("scroll",this.onScroll)}detach(){this.clear(),this.scrollable.container.removeEventListener("scroll",this.onScroll)}clear(){this.lazyLoadQueue.clear()}processVisibleDiv(e){if(e.querySelector("video"))return;this.lazyLoadQueue.push({div:e,load:()=>{const t=e.dataset.docId,s=es.getDoc(t);return this.scrollPromise.then(()=>{const t=xa({doc:s,container:e,lazyLoadQueue:null,group:this.group,noInfo:!0}).loadPromise;return t.finally(()=>{const t=e.querySelector("video");e.style.opacity="";const s=e.querySelector("img");s&&s.classList.add("hide"),t&&!t.parentElement&&setTimeout(()=>{t.src="",t.load();zs.a.getAnimations(t).forEach(e=>{zs.a.checkAnimation(e,!0,!0)})},0),this.lazyLoadQueue.intersector.isVisible(e)||this.processInvisibleDiv(e)}),t})}})}add(e,t=this.element){var s;let i=e.w,n=e.h;n<100&&(i*=100/n,n=100);const a=Math.min(300,400,i),o=Object(gt.a)(i,n,a,100),r=document.createElement("div");r.classList.add("gif","fade-in-transition"),r.style.width=o.width+"px",r.style.opacity="0",r.dataset.docId=""+e.id,t.append(r),this.lazyLoadQueue.observe(r);const l=es.getThumb(e,!1);let d;!!l&&(d=new Image,d.classList.add("media-poster"),l.cacheContext.url||l.promise.then(()=>{d.src=l.cacheContext.url}));const c=()=>{d&&(r.append(d),r.style.opacity="")};(null===(s=null==l?void 0:l.cacheContext)||void 0===s?void 0:s.url)?Xe(d,l.cacheContext.url,c):c()}}class Gr{init(){this.content=document.getElementById("content-gifs");const e=this.content.firstElementChild;e.addEventListener("click",ol.onMediaClick);const t=new re.b(this.content,"GIFS"),s=new Vr(e,al,t),i=Object(hi.f)(this.content,!0);H.default.addEventListener("save_gif",e=>{s.add(e)}),Promise.resolve().then(()=>{const e={_:"messages.savedGifs",hash:"",gifs:es.savedGifs.map(e=>es.getDoc(e))};"messages.savedGifs"===e._&&e.gifs.forEach((t,i)=>{e.gifs[i]=t=es.saveDoc(t),s.add(t)}),i.remove()}),ll.addLazyLoadQueueRepeat(s.lazyLoadQueue,s.processInvisibleDiv),this.init=null}onClose(){}}var Kr=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class Qr{constructor(e,t){this.regularLazyLoadQueue=e,this.group=t,this.animatedDivs=new Set,this.checkAnimationContainer=(e,t)=>{zs.a.getAnimations(e).forEach(e=>{t?zs.a.checkAnimation(e,!1):zs.a.checkAnimation(e,!0,!0)})},this.processVisibleDiv=e=>{const t=e.dataset.docId,s=es.getDoc(t),i=I.b.active.esgSticker.width,n=Da({doc:s,div:e,width:i,height:i,lazyLoadQueue:null,group:this.group,onlyThumb:!1,play:!0,loop:!0});return n.then(()=>{this.checkAnimationContainer(e,this.lazyLoadQueue.intersector.isVisible(e))}),n},this.processInvisibleDiv=e=>{const t=e.dataset.docId,s=es.getDoc(t);this.checkAnimationContainer(e,!1),e.innerHTML="",this.renderSticker(s,e)},this.lazyLoadQueue=new h(void 0,(e,t)=>{t||this.processInvisibleDiv(e)})}clear(){this.lazyLoadQueue.clear()}renderSticker(e,t,s){return t||((t=document.createElement("div")).classList.add("grid-item","super-sticker"),e.animated&&this.observeAnimatedDiv(t)),Da({doc:e,div:t,lazyLoadQueue:this.regularLazyLoadQueue,group:this.group,onlyThumb:e.animated,loadPromises:s}),t}observeAnimatedDiv(e){this.animatedDivs.add(e),this.lazyLoadQueue.observe({div:e,load:this.processVisibleDiv})}}class $r{constructor(){this.stickerSets={},this.recentStickers=[],this.mounted=!1,this.queueCategoryPush=[]}categoryPush(e,t="",s,i){const n=document.createElement("div");n.classList.add("category-items","super-stickers");const a=document.createElement("div");return a.classList.add("category-title"),t&&("string"==typeof t?a.innerHTML=t:a.append(t)),e.append(a,n),this.stickyIntersector.observeStickyHeaderChanges(e),this.queueCategoryPush.push({element:e,prepend:i}),s.then(e=>{e.forEach(e=>{n.append(this.superStickerRenderer.renderSticker(e))}),this.queueCategoryPush.length&&(this.queueCategoryPush.forEach(({element:e,prepend:t})=>{t?this.recentDiv.parentElement?(this.stickersDiv.prepend(e),this.stickersDiv.prepend(this.recentDiv)):this.stickersDiv.prepend(e):this.stickersDiv.append(e)}),this.queueCategoryPush.length=0)}),{titleDiv:a}}renderStickerSet(e,t=!1){return Kr(this,void 0,void 0,(function*(){const s=document.createElement("div");s.classList.add("sticker-category"),s.dataset.id=""+e.id,s.dataset.access_hash=""+e.access_hash;const i=document.createElement("button");i.classList.add("btn-icon","menu-horizontal-div-item"),this.stickerSets[e.id]={stickers:s,tab:i},t?this.menu.insertBefore(i,this.menu.firstElementChild.nextSibling):this.menu.append(i);const n=Ea.getStickerSet(e);this.categoryPush(s,N.a.wrapEmojiText(e.title),n.then(e=>e.documents),t);yield n;!function({set:e,lazyLoadQueue:t,container:s,group:i,autoplay:n,width:a,height:o}){var r;ka(this,void 0,void 0,(function*(){if(null===(r=e.thumbs)||void 0===r?void 0:r.length)return s.classList.add("media-sticker-wrapper"),void t.push({div:s,load:()=>{const t=Ea.getStickerSetThumbDownloadOptions(e),r=st.download(t);if(e.pFlags.animated)return r.then(vt.d).then(e=>{pi.b.loadAnimationWorker({container:s,loop:!0,autoplay:n,animationData:e,width:a,height:o,needUpscale:!0},i)});{const e=new Image;return e.classList.add("media-sticker"),r.then(t=>{Xe(e,URL.createObjectURL(t),()=>{s.append(e)})})}}});const l=Ea.getStickerSet(e),d=yield l;"documentEmpty"!==d.documents[0]._&&Da({doc:d.documents[0],div:s,group:i,lazyLoadQueue:t})}))}({set:e,container:i,group:al,lazyLoadQueue:ol.lazyLoadQueue,width:32,height:32,autoplay:!1})}))}init(){this.content=document.getElementById("content-stickers"),this.recentDiv=document.createElement("div"),this.recentDiv.classList.add("sticker-category","stickers-recent");let e=this.content.previousElementSibling;this.menu=e.firstElementChild;let t=new re.a(e);this.stickersDiv=document.createElement("div"),this.stickersDiv.classList.add("stickers-categories"),this.content.append(this.stickersDiv),H.default.addEventListener("stickers_installed",e=>{const t=e;!this.stickerSets[t.id]&&this.mounted&&this.renderStickerSet(t,!0)}),H.default.addEventListener("stickers_deleted",e=>{const t=e;if(this.stickerSets[t.id]&&this.mounted){const e=this.stickerSets[t.id];e.stickers.remove(),e.tab.remove(),delete this.stickerSets[t.id]}}),this.stickersDiv.addEventListener("click",e=>{const t=e.target;if(Object(ti.a)(t,"category-title")){const e=Object(ln.a)(t,"data-id");new Lr({id:e.dataset.id,access_hash:e.dataset.access_hash}).show()}else ol.onMediaClick(e)});const s=(e=!1)=>{H.default.dispatchEvent("choosing_sticker",!e)};this.scroll=new re.b(this.content,"STICKERS"),this.scroll.setVirtualContainer(this.stickersDiv),this.scroll.onAdditionalScroll=()=>{s()},ll.addEventListener("closed",()=>{s(!0)}),ll.addEventListener("opened",()=>{s()}),this.stickyIntersector=ol.menuOnClick(this.menu,this.scroll,t).stickyIntersector;const i=Object(hi.f)(this.content,!0);Promise.all([Ea.getRecentStickers().then(e=>{this.recentStickers=e.stickers.slice(0,20),this.stickerSets.recent={stickers:this.recentDiv,tab:this.menu.firstElementChild},i.remove();const{titleDiv:t}=this.categoryPush(this.recentDiv,"",Promise.resolve(this.recentStickers),!0);t.append(Object(O.i18n)("Stickers.Recent"))}),Ea.getAllStickers().then(e=>{i.remove();for(let t of e.sets)this.renderStickerSet(t)})]).finally(()=>{this.mounted=!0,s()}),this.superStickerRenderer=new Qr(ol.lazyLoadQueue,al),ll.addLazyLoadQueueRepeat(this.superStickerRenderer.lazyLoadQueue,this.superStickerRenderer.processInvisibleDiv),this.init=null}pushRecentSticker(e){var t;if(Ea.pushRecentSticker(e),!(null===(t=this.recentDiv)||void 0===t?void 0:t.parentElement))return;let s=this.recentDiv.querySelector(`[data-doc-id="${e.id}"]`);s||(s=this.superStickerRenderer.renderSticker(e));const i=this.recentDiv.querySelector(".category-items");i.prepend(s),i.childElementCount>20&&Array.from(i.children).slice(20).forEach(e=>e.remove())}onClose(){}}var Yr=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};const Xr=new class{constructor(){this.inlineResults={},this.setHash={}}getGeoInput(e){return"geoPoint"===e._?{_:"inputGeoPoint",lat:e.lat,long:e.long,accuracy_radius:e.accuracy_radius}:{_:"inputGeoPointEmpty"}}getInlineResults(e,t,s="",i="",n){return F.a.invokeApi("messages.getInlineBotResults",{bot:ye.getUserInput(t),peer:Te.getInputPeerById(e),query:s,geo_point:n?this.getGeoInput(n):void 0,offset:i},{stopTime:-1,noErrorBox:!0}).then(e=>{const t=e.query_id;return e.results.forEach(e=>{"botInlineMediaResult"===e._&&(e.document&&(e.document=es.saveDoc(e.document)),e.photo&&(e.photo=Dt.savePhoto(e.photo))),this.inlineResults[this.generateQId(t,e.id)]=e}),e})}generateQId(e,t){return e+"_"+t}pushPopularBot(e){ye.getTopPeers("bots_inline").then(t=>{const s=e.toPeerId(),i=t.findIndex(e=>e.id===s);let n;n=-1!==i?t[i]:{id:s,rating:0},++n.rating,Object(a.g)(t,n,"rating"),ve.default.setKeyValueToStorage("topPeersCache")})}switchToPM(e,t,s){return this.setHash[t]={peerId:e,time:Date.now()},H.default.dispatchEvent("history_focus",{peerId:t.toPeerId()}),js.startBot(t,void 0,s)}checkSwitchReturn(e){return Yr(this,void 0,void 0,(function*(){const t=ye.getUser(e);if(!t||!t.pFlags.bot||!t.bot_inline_placeholder)return;const s=this.setHash[e];return s&&(delete this.setHash[e],Date.now()-s.time<36e5)?s.peerId:void 0}))}switchInlineQuery(e,t,s,i){H.default.dispatchEvent("history_focus",{peerId:e,threadId:t}),ls.setDraft(e,t,"@"+ye.getUser(s).username+" "+i)}callbackButtonClick(e,t,s){return F.a.invokeApi("messages.getBotCallbackAnswer",{peer:Te.getInputPeerById(e),msg_id:as.getServerMessageId(t),data:s.data},{stopTime:-1,noErrorBox:!0}).then(e=>{"string"==typeof e.message&&e.message.length&&Qt(N.a.wrapRichText(e.message,{noLinks:!0,noLinebreaks:!0}))})}sendInlineResult(e,t,s,i={}){var n;const a=this.inlineResults[s];if(!a)return;this.pushPopularBot(t);const o=s.split("_"),r=o.shift(),l=o.join("_");if(i.viaBotId=t,i.queryId=r,i.resultId=l,a.send_message.reply_markup&&(i.replyMarkup=a.send_message.reply_markup),"botInlineMessageText"===a.send_message._)i.entities=a.send_message.entities,js.sendText(e,a.send_message.message,i);else{let t,s="";const o=a.send_message;switch(o._){case"botInlineMessageMediaAuto":if(s=o.message,"botInlineMediaResult"===a._){const{document:e,photo:s}=a;t=e?es.getMediaInput(e):Dt.getMediaInput(s)}break;case"botInlineMessageMediaGeo":t={_:"inputMediaGeoPoint",geo_point:this.getGeoInput(o.geo)},i.geoPoint=o.geo;break;case"botInlineMessageMediaVenue":t={_:"inputMediaVenue",geo_point:this.getGeoInput(o.geo),title:o.title,address:o.address,provider:o.provider,venue_id:o.venue_id,venue_type:o.venue_type},i.geoPoint=o.geo;break;case"botInlineMessageMediaContact":t={_:"inputMediaContact",phone_number:o.phone_number,first_name:o.first_name,last_name:o.last_name,vcard:o.vcard}}t||(t={_:"messageMediaPending",type:a.type,file_name:a.title||(null===(n=a.content)||void 0===n?void 0:n.url)||a.url,size:0,progress:{percent:30,total:0}}),js.sendOther(e,t,i)}}};j.a&&(j.a.appInlineBotsManager=Xr);var Zr=Xr,Jr=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class el extends Ys{constructor(){super(...arguments),this.nextOffset="",this.loadedAll=!1,this.onGifsClick=e=>{const t=Object(ti.a)(e.target,"gif");if(!t)return;const s=t.dataset.docId;Pd.chat.input.sendMessageWithDocument(s)?I.b.isMobile&&pa.onCloseBtnClick():console.warn("got no doc by id:",s)}}init(){this.container.id="search-gifs-container",this.inputSearch=new qs("SearchGifsTitle",e=>{this.reset(),this.search(e)}),this.title.replaceWith(this.inputSearch.container),this.gifsDiv=document.createElement("div"),this.gifsDiv.classList.add("gifs-masonry"),Object(v.b)(this.gifsDiv,this.onGifsClick,{listenerSetter:this.listenerSetter}),this.scrollable.append(this.gifsDiv),this.masonry=new Vr(this.gifsDiv,"GIFS-SEARCH",this.scrollable)}onClose(){this.scrollable.onScrolledBottom=()=>{}}onCloseAfterTimeout(){return this.reset(),this.gifsDiv.innerHTML="",zs.a.checkAnimations(void 0,"GIFS-SEARCH"),this.inputSearch.remove(),super.onCloseAfterTimeout()}reset(){this.searchPromise=null,this.nextOffset="",this.loadedAll=!1,this.masonry.clear()}open(){const e=super.open();return pa.toggleSidebar(!0).then(()=>{this.search("",!0),this.scrollable.onScrolledBottom=()=>{this.search(this.inputSearch.value,!1)}}),e}search(e,t=!0){return Jr(this,void 0,void 0,(function*(){if(!this.searchPromise&&!this.loadedAll){this.gifBotPeerId||(this.gifBotPeerId=(yield ye.resolveUsername("gif")).id.toPeerId(!1));try{this.searchPromise=Zr.getInlineResults(Z.b,this.gifBotPeerId,e,this.nextOffset);const{results:s,next_offset:i}=yield this.searchPromise;if(this.inputSearch.value!==e)return;this.searchPromise=null,this.nextOffset=i,t&&(this.gifsDiv.innerHTML=""),s.length?s.forEach(e=>{"botInlineMediaResult"===e._&&e.document&&this.masonry.add(e.document)}):this.loadedAll=!0,this.scrollable.onScroll()}catch(e){throw this.searchPromise=null,console.error("gifs loading error:",e),e}}}))}}class tl extends Ys{init(){this.container.id="stickers-container",this.container.classList.add("chatlist-container"),this.lazyLoadQueue=new c,this.inputSearch=new qs("StickersTab.SearchPlaceholder",e=>{this.search(e)}),this.title.replaceWith(this.inputSearch.container),this.setsDiv=document.createElement("div"),this.setsDiv.classList.add("sticker-sets"),this.scrollable.append(this.setsDiv),Object(v.b)(this.setsDiv,e=>{const t=Object(ti.a)(e.target,"sticker-set-sticker");if(t){const e=t.dataset.docId;return void Pd.chat.input.sendMessageWithDocument(e)}const s=Object(ti.a)(e.target,"sticker-set");if(!s)return;const i=s.dataset.stickerSet,n=s.dataset.access_hash,a=Object(ti.a)(e.target,"sticker-set-button");a?(e.preventDefault(),e.cancelBubble=!0,a.setAttribute("disabled","true"),Ea.getStickerSet({id:i,access_hash:n}).then(e=>{Ea.toggleStickerSet(e.set).then(t=>{t&&(a.textContent="",a.append(Object(O.i18n)(e.set.installed_date?"Stickers.SearchAdded":"Stickers.SearchAdd")),a.classList.toggle("gray",!!e.set.installed_date))}).finally(()=>{a.removeAttribute("disabled")})})):Ea.getStickerSet({id:i,access_hash:n}).then(e=>{new Lr(e.set).show()})},{listenerSetter:this.listenerSetter})}onCloseAfterTimeout(){return this.setsDiv.innerHTML="",zs.a.checkAnimations(void 0,"STICKERS-SEARCH"),super.onCloseAfterTimeout()}renderSet(e){const t=document.createElement("div");t.classList.add("sticker-set");const s=document.createElement("div");s.classList.add("sticker-set-header");const i=document.createElement("div");i.classList.add("sticker-set-details"),i.innerHTML=`\n      <div class="sticker-set-name">${N.a.wrapEmojiText(e.title)}</div>\n    `;const n=document.createElement("div");n.classList.add("sticker-set-count"),n.append(Object(O.i18n)("Stickers",[e.count])),i.append(n);const a=document.createElement("button");a.classList.add("btn-primary","btn-color-primary","sticker-set-button"),a.append(Object(O.i18n)(e.installed_date?"Stickers.SearchAdded":"Stickers.SearchAdd")),e.installed_date&&a.classList.add("gray"),s.append(i,a);const o=document.createElement("div");o.classList.add("sticker-set-stickers");const r=Math.min(5,e.count);for(let e=0;e<r;++e){const e=document.createElement("div");e.classList.add("sticker-set-sticker"),o.append(e)}Ea.getStickerSet(e).then(e=>{for(let t=0;t<r;++t){const s=o.children[t],i=e.documents[t];"documentEmpty"!==i._&&Da({doc:i,div:s,lazyLoadQueue:this.lazyLoadQueue,group:"STICKERS-SEARCH",play:!0,loop:!0,width:68,height:68})}}),t.dataset.stickerSet=""+e.id,t.dataset.access_hash=""+e.access_hash,t.dataset.title=e.title,t.append(s,o),this.setsDiv.append(t)}open(){const e=super.open();return pa.toggleSidebar(!0).then(()=>{this.renderFeatured()}),e}renderFeatured(){return Ea.getFeaturedStickers().then(e=>{this.inputSearch.value||(e=this.filterRendered("",e)).forEach(e=>{this.renderSet(e.set)})})}filterRendered(e,t){t=t.slice();const s=Array.from(this.setsDiv.children);return Object(a.e)(s,s=>{const i=s.dataset.stickerSet,n=t.findIndex(e=>e.set.id===i);-1!==n?t.splice(n,1):e&&s.dataset.title.toLowerCase().includes(e.toLowerCase())||s.remove()}),zs.a.checkAnimations(void 0,"STICKERS-SEARCH"),t}search(e){return e?Ea.searchStickerSets(e,!1).then(t=>{this.inputSearch.value===e&&(t=this.filterRendered(e,t)).forEach(e=>{this.renderSet(e.set)})}):this.renderFeatured()}}var sl=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class il extends Mt.a{constructor(e){super(!1),this.forceClose=!1,this.inited=!1,this.onMouseOut=e=>{if(clearTimeout(this.displayTimeout),!this.isActive())return;const t=e.toElement;t&&Object(zt.a)(t,this.element)||(this.displayTimeout=window.setTimeout(()=>{this.toggle(!1)},200))},this.toggle=e=>sl(this,void 0,void 0,(function*(){const t=!!this.element.style.display&&void 0===e||e;if(this.init){if(!t)return;this.init(),this.init=null}if(t!==this.isActive())if(this.element.style.display&&void 0===e||e){const e=this.dispatchEvent("open");yield Promise.all(e),this.element.style.display="",this.element.offsetLeft,this.element.classList.add("active"),clearTimeout(this.displayTimeout),this.displayTimeout=window.setTimeout(()=>{this.forceClose=!1,this.dispatchEvent("opened")},Ht.IS_TOUCH_SUPPORTED?0:200)}else this.dispatchEvent("close"),this.element.classList.remove("active"),clearTimeout(this.displayTimeout),this.displayTimeout=window.setTimeout(()=>{this.element.style.display="none",this.forceClose=!1,this.dispatchEvent("closed")},Ht.IS_TOUCH_SUPPORTED?0:200)})),Object(m.g)(this,e)}attachButtonListener(e,t){let s=!0;Ht.IS_TOUCH_SUPPORTED?Object(v.b)(e,()=>{s?(s=!1,this.toggle(!0)):this.toggle()},{listenerSetter:t}):t.add(e)("mouseover",i=>{s&&(t.add(e)("mouseout",this.onMouseOut),s=!1),clearTimeout(this.displayTimeout),this.displayTimeout=window.setTimeout(()=>{this.toggle(!0)},200)})}init(){Ht.IS_TOUCH_SUPPORTED||(this.element.onmouseout=this.onMouseOut,this.element.onmouseover=e=>{this.forceClose||clearTimeout(this.displayTimeout)})}isActive(){return this.element.classList.contains("active")}}var nl=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};const al="emoticons-dropdown";class ol extends il{constructor(){super({element:document.getElementById("emoji-dropdown")}),this.tabId=-1,this.onSelectTabClick=e=>{this.tabId!==e&&(zs.a.checkAnimations(!0,al),this.tabId=e,this.searchButton.classList.toggle("hide",0===this.tabId),this.deleteBtn.classList.toggle("hide",0!==this.tabId))},this.checkRights=()=>{const{peerId:e,threadId:t}=Pd.chat,s=this.tabsEl.children,i=Array.from(s),n=js.canSendToPeer(e,t,"send_stickers")||!0;i[2].toggleAttribute("disabled",!n);const a=js.canSendToPeer(e,t,"send_gifs")||!0;i[3].toggleAttribute("disabled",!a);const o=this.tabsEl.querySelector(".active");!o||1===Object(Na.a)(o)||n&&a||this.selectTab(0,!1)},this.addEventListener("open",()=>nl(this,void 0,void 0,(function*(){Ht.IS_TOUCH_SUPPORTED&&Object(si.a)()&&(yield Object(M.a)(100)),this.element.parentElement!==Pd.chat.input.chatInput&&Pd.chat.input.chatInput.append(this.element),this.savedRange=this.getGoodRange(),ol.lazyLoadQueue.lock(),zs.a.lockIntersectionGroup(al)}))),this.addEventListener("opened",()=>{zs.a.unlockIntersectionGroup(al),ol.lazyLoadQueue.unlock(),ol.lazyLoadQueue.refresh(),this.container.classList.remove("disable-hover")}),this.addEventListener("close",()=>{ol.lazyLoadQueue.lock(),zs.a.lockIntersectionGroup(al),zs.a.checkAnimations(!0,al)}),this.addEventListener("closed",()=>{zs.a.unlockIntersectionGroup(al),ol.lazyLoadQueue.unlock(),ol.lazyLoadQueue.refresh(),this.container.classList.remove("disable-hover"),this.savedRange=void 0})}init(){this.emojiTab=new Wr,this.stickersTab=new $r,this.gifsTab=new Gr,this.tabs={0:this.emojiTab,1:this.stickersTab,2:this.gifsTab},this.container=this.element.querySelector(".emoji-container .tabs-container"),this.tabsEl=this.element.querySelector(".emoji-tabs"),this.selectTab=Object(ci.a)(this.tabsEl,this.container,this.onSelectTabClick,()=>{const e=this.tabs[this.tabId];e.init&&e.init(),e.onCloseAfterTimeout&&e.onCloseAfterTimeout(),zs.a.checkAnimations(!1,al)}),this.searchButton=this.element.querySelector(".emoji-tabs-search"),this.searchButton.addEventListener("click",()=>{1===this.tabId?pa.isTabExists(tl)||new tl(pa).open():pa.isTabExists(el)||new el(pa).open()}),this.deleteBtn=this.element.querySelector(".emoji-tabs-delete"),this.deleteBtn.addEventListener("click",e=>{var t;const s=Pd.chat.input.messageInput;(null===(t=s.lastChild)||void 0===t?void 0:t.tagName)?s.lastElementChild.remove():s.lastChild&&(s.lastChild.textContent.length?s.lastChild.textContent=s.lastChild.textContent.slice(0,-1):s.lastChild.remove());const i=new Event("input",{bubbles:!0,cancelable:!0});Pd.chat.input.messageInput.dispatchEvent(i),Object(f.a)(e)});const e=C.IS_APPLE_MOBILE,t=e?1:0;return e&&this.tabsEl.children[1].classList.add("hide"),this.tabsEl.children[t+1].click(),this.tabs[t].init&&this.tabs[t].init(),H.default.addEventListener("peer_changed",this.checkRights),this.checkRights(),super.init()}addLazyLoadQueueRepeat(e,t){this.addEventListener("close",()=>{e.lock()}),this.addEventListener("closed",()=>{const s=e.intersector.getVisible();for(const e of s)t(e);e.intersector.clearVisible()}),this.addEventListener("opened",()=>{e.unlockAndRefresh()})}getSavedRange(){return this.getGoodRange()||this.savedRange}getGoodRange(){const e=document.getSelection();if(e.rangeCount&&document.activeElement===Pd.chat.input.messageInput)return e.getRangeAt(0)}}ol.lazyLoadQueue=new c,ol.menuOnClick=(e,t,s,i=0)=>{let n=-1;const a=t=>t!==i&&(e.children[i].classList.remove("active"),e.children[t].classList.add("active"),i=t,!0),o=new Er(t.container,(i,o)=>{if(Math.abs(n-t.container.scrollTop)<=1)return;n=-1;const r=Object(Na.a)(o);!i&&r||(a(r),s&&(r<e.childElementCount-4?s.container.scrollLeft=47*(r-3):s.container.scrollLeft=47*r))});return e.addEventListener("click",e=>{let s=e.target;if(s=Object(ti.a)(s,"menu-horizontal-div-item"),!s)return;const i=Object(Na.a)(s);if(!a(i))return;const o=(t.splitUp||t.container).children[i].offsetTop+1;t.container.scrollTop=n=o}),{stickyIntersector:o,setActive:a}},ol.onMediaClick=(e,t=!1)=>{let s=e.target;if(s=Object(nn.a)(s,"DIV"),!s)return!1;const i=s.dataset.docId;return!!i&&(Pd.chat.input.sendMessageWithDocument(i,void 0,t)?(rl.container&&(rl.forceClose=!0,rl.container.classList.add("disable-hover"),rl.toggle(!1)),!0):(console.warn("got no doc by id:",i),!1))};const rl=new ol;j.a.emoticonsDropdown=rl;var ll=rl;var dl=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};const cl=new Set(["messageActionHistoryClear","messageActionChatCreate"]);let hl=void 0,ul=0;class pl{constructor(e,t,s,i,n,o,r,l,d,h){if(this.chat=e,this.appMessagesManager=t,this.appStickersManager=s,this.appUsersManager=i,this.appInlineBotsManager=n,this.appPhotosManager=o,this.appPeersManager=r,this.appProfileManager=l,this.appDraftsManager=d,this.appMessagesIdsManager=h,this.unreadOut=new Set,this.needUpdate=[],this.bubbles={},this.skippedMids=new Set,this.dateMessages={},this.scrolledDown=!0,this.isScrollingTimeout=0,this.unreaded=new Map,this.unreadedSeen=new Set,this.preloader=null,this.loadedTopTimes=0,this.loadedBottomTimes=0,this.messagesQueuePromise=null,this.messagesQueue=[],this.messagesQueueOnRender=null,this.messagesQueueOnRenderAdditional=null,this.firstUnreadBubble=null,this.middleware=Ke(),this.replyFollowHistory=[],this.isHeavyAnimationInProgress=!1,this.isFirstLoad=!0,this.passEntities={},this.viewsMids=new Set,this.isTopPaddingSet=!1,this.onBubblesClick=e=>{var t;let s=e.target,i=null;try{i=Object(ti.a)(s,"bubble")}catch(e){}if(!i)return;if(i.classList.contains("is-date")&&Object(ti.a)(s,"bubble-content")){if(i.classList.contains("is-sticky")&&!this.chatInner.classList.contains("is-scrolling"))return;for(const e in this.dateMessages){if(this.dateMessages[e].div===i){new Pr(new Date(+e),this.onDatePick).show();break}}return}if(!Ht.IS_TOUCH_SUPPORTED&&Object(ti.a)(s,"time"))return void this.chat.selection.toggleByElement(i);if(this.chat.selection.isSelecting&&e.isTrusted){if(i.classList.contains("service")&&void 0===i.dataset.mid)return;return Object(f.a)(e),Ht.IS_TOUCH_SUPPORTED&&this.chat.selection.selectedText?void(this.chat.selection.selectedText=void 0):void this.chat.selection.toggleByElement(Object(ti.a)(s,"grouped-item")||i)}const n=Object(ti.a)(s,"contact");if(n)return void this.chat.appImManager.setInnerPeer(n.dataset.peerId.toPeerId());if(Object(ti.a)(s,"replies")){const e=+i.dataset.mid;if(this.peerId===Z.c){const t=this.chat.getMessage(e),s=this.appPeersManager.getPeerId(t.reply_to.reply_to_peer_id),i=t.reply_to.reply_to_top_id,n=t.fwd_from.saved_from_msg_id;this.chat.appImManager.openThread(s,n,i)}else{const t=this.appMessagesManager.filterMessages(this.chat.getMessage(e),e=>!!e.replies)[0],s=t.replies;s&&this.appMessagesManager.getDiscussionMessage(this.peerId,t.mid).then(e=>{this.chat.appImManager.setInnerPeer(s.channel_id.toPeerId(!0),void 0,"discussion",e.mid)})}return}const a=Object(ti.a)(s,"is-via");if(a){const t=a.querySelector(".peer-title");if(s===t||Object(zt.a)(s,t)){const s=t.innerText+" ";return this.appDraftsManager.setDraft(this.peerId,this.chat.threadId,s),void Object(f.a)(e)}}const o=Object(ti.a)(s,"peer-title")||Object(nn.a)(s,"AVATAR-ELEMENT")||Object(ln.a)(s,"data-saved-from");if(o&&o!==i){s=o||s;const e=s.dataset.peerId||s.getAttribute("peer"),t=s.dataset.savedFrom;if("string"==typeof e||t)if(t){const[e,s]=t.split("_");this.chat.appImManager.setInnerPeer(e.toPeerId(),+s)}else{const t=e.toPeerId();t!==Z.b?this.chat.appImManager.setInnerPeer(t):Qt(O.default.format("HidAccount",!0))}return}if(i.classList.contains("sticker")&&s.parentElement.classList.contains("attachment")){const e=+i.dataset.mid,s=null===(t=this.chat.getMessage(e).media)||void 0===t?void 0:t.document;return void((null==s?void 0:s.stickerSetInput)&&new Lr(s.stickerSetInput).show())}const r=Object(ti.a)(s,"document-with-thumb");if("IMG"===s.tagName&&!s.classList.contains("emoji")&&!s.classList.contains("document-thumb")||s.classList.contains("album-item")||"VIDEO"===s.tagName&&!i.classList.contains("round")||r&&!r.querySelector(".preloader-container")||s.classList.contains("canvas-thumbnail")){const t=+(Object(ti.a)(s,"album-item")||Object(ti.a)(s,"document-container")||i).dataset.mid,n=this.chat.getMessage(t);if(!n)return void this.log.warn("no message by messageId:",t);const a="webpage",o=i.classList.contains(a),l=r?e=>Ed.isMediaCompatibleForDocumentViewer(e):e=>"photo"===e._||["video","gif"].includes(e.type),d=[],c=o?[t]:Object.keys(this.bubbles).map(e=>+e).filter(e=>{const t=this.chat.getMessage(e),s=this.appMessagesManager.getMediaFromMessage(t);return s&&l(s)}).sort((e,t)=>e-t);c.forEach(e=>{let t;if(r)t=".document-container";else{t=".album-item video, .album-item img, .preview video, .preview img, ",t+=this.bubbles[e].classList.contains("with-media-tail")?".bubble__media-container":".attachment video, .attachment img"}const s=Array.from(this.bubbles[e].querySelectorAll(t)),i=new Set;if(r)s.forEach(e=>{d.push({element:e.querySelector(".document-ico"),mid:+e.dataset.mid,peerId:this.peerId})});else{const t=!!this.bubbles[e].querySelector(".media-container-aspecter");s.forEach(s=>{if(t&&!Object(ti.a)(s,"media-container-aspecter"))return;let n=Object(ti.a)(s,"album-item");const a=n||s.parentElement;i.has(a)||(i.add(a),d.push({element:s,mid:n?+n.dataset.mid:e,peerId:this.peerId}))})}}),d.sort((e,t)=>e.mid-t.mid);let h=d.findIndex(e=>e.mid===t);return j.b&&this.log("open mediaViewer single with ids:",c,h,d),d[h]?((new Ed).setSearchContext({threadId:this.chat.threadId,peerId:this.peerId,inputFilter:{_:r?"inputMessagesFilterDocument":"inputMessagesFilterPhotoVideo"},useSearch:"scheduled"!==this.chat.type&&!o,isScheduled:"scheduled"===this.chat.type}).openMedia(n,d[h].element,0,!0,d.slice(0,h),d.slice(h+1)),void Object(f.a)(e)):void this.log("no target for media viewer!",s)}if(-1===["IMG","DIV","SPAN"].indexOf(s.tagName)&&(s=Object(nn.a)(s,"DIV")),-1!==["DIV","SPAN"].indexOf(s.tagName)){if(s.classList.contains("goto-original")){const e=i.dataset.savedFrom,[t,s]=e.split("_");return void this.chat.appImManager.setInnerPeer(t.toPeerId(),+s)}if(s.classList.contains("forward")){const e=+i.dataset.mid,t=this.appMessagesManager.getMessageByPeer(this.peerId,e);return void new Qa({[this.peerId]:this.appMessagesManager.getMidsByMessage(t)})}let t=!1;try{t=!!Object(ti.a)(e.target,"reply")}catch(e){}if(t&&i.classList.contains("is-reply")){const e=+i.dataset.mid;this.replyFollowHistory.push(e);const t=this.chat.getMessage(e),s=t.reply_to.reply_to_peer_id?this.appPeersManager.getPeerId(t.reply_to.reply_to_peer_id):this.peerId,n=t.reply_to.reply_to_msg_id;this.chat.appImManager.setInnerPeer(s,n,this.chat.type,this.chat.threadId)}}},this.onScroll=()=>{this.isHeavyAnimationInProgress&&this.scrolledDown||(Ht.IS_TOUCH_SUPPORTED||(this.isScrollingTimeout?clearTimeout(this.isScrollingTimeout):this.chatInner.classList.contains("is-scrolling")||this.chatInner.classList.add("is-scrolling"),this.isScrollingTimeout=window.setTimeout(()=>{this.chatInner.classList.remove("is-scrolling"),this.isScrollingTimeout=0},1350)),this.scrollable.getDistanceToEnd()<300&&this.scrollable.loadedAll.bottom?(this.bubblesContainer.classList.add("scrolled-down"),this.scrolledDown=!0):this.bubblesContainer.classList.contains("scrolled-down")&&(this.bubblesContainer.classList.remove("scrolled-down"),this.scrolledDown=!1),this.chat.topbar.pinnedMessage&&this.chat.topbar.pinnedMessage.setCorrectIndex(this.scrollable.lastScrollDirection))},this.onDatePick=e=>{const t=this.peerId;this.appMessagesManager.requestHistory(t,0,2,-1,e,this.chat.threadId).then(e=>{var s;(null===(s=null==e?void 0:e.messages)||void 0===s?void 0:s.length)?this.peerId===t&&this.chat.setMessageId(e.messages[0].mid):this.log.error("no history!")})},this.getBubblesCount=()=>this.historyStorage.count,this.listenerSetter=new Gs,this.bubblesContainer=document.createElement("div"),this.bubblesContainer.classList.add("bubbles","scrolled-down"),this.chatInner=document.createElement("div"),this.chatInner.classList.add("bubbles-inner"),this.setScroll(),this.bubblesContainer.append(this.scrollable.container),this.log=this.chat.log,this.bubbleGroups=new Sr(this.chat),this.preloader=new y({cancelable:!1}),this.lazyLoadQueue=new c,this.lazyLoadQueue.queueId=++ul,this.listenerSetter.add(H.default)("history_update",({storage:e,peerId:t,mid:s})=>{if(this.chat.getMessagesStorage()===e){const e=this.bubbles[s];if(!e)return;const t=this.chat.getMessage(s);if(+e.dataset.timestamp>=t.date+U.a.serverTimeOffset-1)return void this.bubbleGroups.changeBubbleMid(e,s);this.setBubblePosition(e,t,!1),this.scrollingToBubble&&this.scrollToBubbleEnd()}}),this.listenerSetter.add(H.default)("dialog_flush",({peerId:e})=>{this.peerId===e&&this.deleteMessagesByIds(Object.keys(this.bubbles).map(e=>+e))}),this.listenerSetter.add(H.default)("message_sent",e=>{var t,s,i,n,a,o,r,l;const{storage:d,tempId:c,tempMessage:h,mid:u}=e;if(this.chat.getMessagesStorage()!==d)return;const p=this.getMountedBubble(c,h)||this.getMountedBubble(u);if(p){const e=this.chat.getMessage(u),d=p.bubble;if(e.replies){const t=d.querySelector("replies-element");t&&(t.message=e,t.init())}if(null===(t=e.media)||void 0===t?void 0:t.document){const t=d.querySelector(`.document-container[data-mid="${c}"] .document`);if(t){const o=Object(ti.a)(t,"document-container");!(null===(n=null===(i=null===(s=h.media)||void 0===s?void 0:s.document)||void 0===i?void 0:i.thumbs)||void 0===n?void 0:n.length)&&(null===(a=e.media.document.thumbs)||void 0===a?void 0:a.length)&&t.replaceWith(Aa({message:e})),o&&(o.dataset.mid=""+u)}}if(e.grouped_id){const e=d.querySelector(`.grouped-item[data-mid="${c}"]`)||d;e&&(e.dataset.mid=""+u)}if(null===(o=e.media)||void 0===o?void 0:o.poll){const t=d.querySelector("poll-element");if(t){const s=e.media.poll;t.message=e,t.setAttribute("poll-id",s.id),t.setAttribute("message-id",""+u)}}if(null===(r=e.media)||void 0===r?void 0:r.document){const t=d.querySelector(`audio-element[data-mid="${c}"], .document[data-doc-id="${c}"], .media-round[data-mid="${c}"]`);t&&(t instanceof Fi||t.classList.contains("media-round")?(t.dataset.mid=""+e.mid,delete t.dataset.isOutgoing,t.message=e,t.onLoad(!0)):t.dataset.docId=e.media.document.id)}(null===(l=e.media)||void 0===l?void 0:l.webpage)&&!d.querySelector(".web")&&Object(it.c)().then(()=>{this.safeRenderMessage(e,!0,!1,d,!1),this.scrollToBubbleIfLast(d)})}else this.log.warn("message_sent there is no bubble",e);const m=this.bubbles;if(m[c]){const e=m[c];m[u]=e,delete m[c],Object(g.b)(()=>{e.classList.contains("is-sending")&&(e.classList.remove("is-sending"),e.classList.add(this.peerId===H.default.myId&&"scheduled"!==this.chat.type?"is-read":"is-sent"))}),e.dataset.mid=""+u}if(this.unreadOut.has(c)&&(this.unreadOut.delete(c),this.unreadOut.add(u)),"scheduled"===this.chat.type){(Date.now()/1e3|0)>=h.date-10&&this.deleteMessagesByIds([u])}}),this.listenerSetter.add(H.default)("message_edit",({storage:e,peerId:t,mid:s})=>{if(e!==this.chat.getMessagesStorage())return;const i=this.chat.getMessage(s),n=i.grouped_id?this.getGroupedBubble(i.grouped_id):this.getMountedBubble(s);if(!n)return;const a="scheduled"===this.chat.type,o=this.scrolledDown;this.safeRenderMessage(n.message,!0,!1,n.bubble,a),o&&this.scrollToBubbleIfLast(n.bubble),a&&(this.messagesQueuePromise||Promise.resolve()).then(()=>{this.deleteEmptyDateGroups()})}),this.listenerSetter.add(H.default)("album_edit",({peerId:e,groupId:t,deletedMids:s})=>{if(e!==this.peerId)return;const i=this.appMessagesManager.getMidsByAlbum(t).concat(s).find(e=>this.bubbles[e]);if(!i)return;const n=Object(m.e)(this.appMessagesManager.groupedMessagesStorage[t],"asc").pop();this.safeRenderMessage(this.chat.getMessage(n),!0,!1,this.bubbles[i],!1)}),this.listenerSetter.add(H.default)("messages_downloaded",({peerId:e,mids:t})=>{const s=this.getMiddleware();Object(it.c)().then(()=>{s()&&t.forEach(t=>{Object(a.e)(this.needUpdate,(s,i)=>{if(s.replyMid===t&&s.replyToPeerId===e){const{mid:e,replyMid:t}=this.needUpdate.splice(i,1)[0],n=this.bubbles[e];if(!n)return;const a=this.chat.getMessage(e);this.appMessagesManager.getMessageByPeer(s.replyToPeerId,t).deleted&&delete a.reply_to_mid,Tr.setReply({chat:this.chat,bubble:n,message:a})}})})})}),this.listenerSetter.add(this.bubblesContainer)("click",this.onBubblesClick),Ht.IS_TOUCH_SUPPORTED){const e="is-gesturing-reply",t=64,s=.75*t;let i,n,a=!1;this.replySwipeHandler=Va({element:this.bubblesContainer,verifyTouchTarget:t=>!(this.chat.selection.isSelecting||!this.appMessagesManager.canSendToPeer(this.peerId,this.chat.threadId))&&(i=Object(ti.a)(t.target,"bubble"),i&&(Object(p.a)(i,e,!0,250),i.offsetLeft,n?(n.classList.remove("is-visible"),n.style.opacity=""):(n=document.createElement("span"),n.classList.add("tgico-reply_filled","bubble-gesture-reply-icon")),i.append(n)),!!i),onSwipe:(e,o)=>{a=e>=s,a&&!n.classList.contains("is-visible")&&n.classList.add("is-visible"),n.style.opacity=""+Math.min(1,e/s);const r=-Math.max(0,Math.min(t,e));i.style.transform=`translateX(${r}px)`,Object(hi.b)()},onReset:()=>{const t=i;Object(p.a)(t,e,!1,250,()=>{n.parentElement===t&&(n.classList.remove("is-visible"),n.remove())}),Object(g.b)(()=>{if(t.style.transform="",a){const{mid:e}=t.dataset;this.chat.input.initMessageReply(+e),a=!1}})},listenerOptions:{capture:!0}})}let u;j.b&&this.listenerSetter.add(this.bubblesContainer)("dblclick",e=>{const t=Object(ti.a)(e.target,"grouped-item")||Object(ti.a)(e.target,"bubble");if(t){const e=+t.dataset.mid;this.log("debug message:",this.chat.getMessage(e)),this.highlightBubble(t)}}),C.IS_MOBILE||"pinned"===this.chat.type||this.listenerSetter.add(this.bubblesContainer)("dblclick",e=>{if(this.chat.selection.isSelecting||!this.appMessagesManager.canSendToPeer(this.peerId,this.chat.threadId))return;const t=e.target,s=t.classList.contains("bubble")?t:t.classList.contains("document-selection")?t.parentElement:null;if(s&&!s.classList.contains("bubble-first")){const e=+s.dataset.mid;if(this.chat.getMessage(e).pFlags.is_outgoing)return;this.chat.input.initMessageReply(e)}}),this.stickyIntersector=new Er(this.scrollable.container,(e,t)=>{for(const s in this.dateMessages){const i=this.dateMessages[s];if(i.container===t){i.div.classList.toggle("is-sticky",e);break}}}),Object(it.a)(()=>{this.isHeavyAnimationInProgress=!0,this.lazyLoadQueue.lock(),u=this.getMiddleware()},()=>{this.isHeavyAnimationInProgress=!1,u&&u()&&(this.lazyLoadQueue.unlock(),this.lazyLoadQueue.refresh()),u=null},this.listenerSetter)}constructPeerHelpers(){if(this.listenerSetter.add(H.default)("history_append",({storage:e,mid:t})=>{if(e===this.chat.getMessagesStorage()&&(this.scrollable.loadedAll.bottom?this.renderNewMessagesByIds([t],!0):this.chat.setMessageId(),H.default.settings.animationsEnabled)){const e=this.chat.gradientRenderer;e&&e.toNextPosition()}}),this.listenerSetter.add(H.default)("history_multiappend",e=>{if(!(this.peerId in e))return;const t=Array.from(e[this.peerId]).slice().sort((e,t)=>t-e);this.renderNewMessagesByIds(t)}),this.listenerSetter.add(H.default)("history_delete",({peerId:e,msgs:t})=>{e===this.peerId&&this.deleteMessagesByIds(Array.from(t))}),this.listenerSetter.add(H.default)("dialog_unread",({peerId:e})=>{e===this.peerId&&(this.chat.input.setUnreadCount(),this.updateUnreadByDialog())}),this.listenerSetter.add(H.default)("dialogs_multiupdate",e=>{e[this.peerId]&&this.chat.input.setUnreadCount()}),this.listenerSetter.add(H.default)("dialog_notify_settings",e=>{this.peerId===e.peerId&&this.chat.input.setUnreadCount()}),this.listenerSetter.add(H.default)("chat_update",e=>{if(this.peerId===e.toPeerId(!0)){this.chatInner.classList.contains("has-rights")!==this.appMessagesManager.canSendToPeer(this.peerId,this.chat.threadId)&&(this.finishPeerChange(),this.chat.input.updateMessageInput())}}),this.listenerSetter.add(H.default)("settings_updated",e=>{if("settings.emoji.big"===e.key){const e=this.scrollable.isScrolledDown;e||this.setMessagesQueuePromise();Object(m.e)(this.bubbles,"desc").forEach(e=>{const t=this.bubbles[e];if(t.classList.contains("can-have-big-emoji")){const s=this.chat.getMessage(e);this.safeRenderMessage(s,void 0,!1,t)}}),e?this.scrollable.scrollTop=99999:this.performHistoryResult([],!0,!1,void 0)}}),this.listenerSetter.add(H.default)("message_views",({peerId:e,views:t,mid:s})=>{this.peerId===e&&Object(g.b)(()=>{const e=this.bubbles[s];if(!e)return;const i=Array.from(e.querySelectorAll(".post-views"));if(i.length){const e=Object(ds.c)(t,1);let s=!1;i.forEach(t=>{(s||t.innerHTML!==e)&&(s=!0,t.innerHTML=e)})}})}),this.unreadedObserver=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target,s=this.unreaded.get(t);this.onUnreadedInViewport(t,s)}})},{root:this.scrollable.container}),this.viewsObserver=new IntersectionObserver(e=>{e.forEach(e=>{var t;if(e.isIntersecting){const s=e.target,i=+s.dataset.mid,n=this.chat.getMessage(i);if(n&&void 0!==n.views&&!n.pFlags.is_outgoing&&this.viewsObserver&&(this.viewsMids.add(i),this.viewsObserver.unobserve(e.target),this.sendViewCountersDebounced()),"messageMediaLiveStream"===(null===(t=null==n?void 0:n.media)||void 0===t?void 0:t._)){const e=s.querySelector(".live"),t=e.querySelector(".live-type"),i=(Date.now()-864e6)/1e3;if((null==n?void 0:n.date)<=i)return Object(O._i18n)(t,"EitaaLive.StreamStateExpired"),e.classList.remove("live-broadcasting","live-archived","live-ended","live-paused"),void e.classList.add("live-ended");const a=n.media;F.a.invokeApi("liveGetMedia",{id:a.id,access_hash:a.access_hash,flags:0}).then(s=>{let i;const n=s.state;if("liveStreamStateBroadcasting"===n._?1===n.flags?(i="paused",Object(O._i18n)(t,"EitaaLive.StreamStatePaused")):(i="broadcasting",Object(O._i18n)(t,"EitaaLive.StreamStateBroadcasting")):("liveStreamStateEnded2"===n._||"liveStreamStateEnded"===n._)&&1===n.flags?n.expire_date>=Date.now()/1e3?(i="archived",Object(O._i18n)(t,"EitaaLive.StreamStateArchive")):(i="ended",Object(O._i18n)(t,"EitaaLive.StreamStateExpired")):(i="ended",Object(O._i18n)(t,"EitaaLive.StreamStateEnded")),e.classList.remove("live-broadcasting","live-archived","live-ended"),e.classList.add("live-"+i),"archived"===i){let t;t=document.createElement("span"),t.classList.add("video-time"),t.innerText=(n.duration+"").toHHMMSS(!1),e.append(t)}})}}})},{root:this.scrollable.container}),this.sendViewCountersDebounced=Zi(()=>{const e=[...this.viewsMids];this.viewsMids.clear(),this.appMessagesManager.incrementMessageViews(this.peerId,e)},1e3,!1,!0),"ResizeObserver"in window){let e=this.scrollable.container.offsetHeight,t=!1,s=!1,i=0,n=0,a=0;const o=()=>{const o=this.scrollable.container.offsetHeight,r=this.scrollable.isScrolledDown;o===e||s&&r||(n+=e-o),n&&(this.scrollable.scrollTop+=Math.round(n)),e=o,i=0,a=0,n=0,t=!1,s=!1},r=e=>{a&&window.cancelAnimationFrame(a),a=window.requestAnimationFrame(e?o:()=>{a=window.requestAnimationFrame(o)})};new ResizeObserver(a=>{if(s)return void r(!1);const o=a[0].contentRect.height;if(!e)return void(e=o);const l=e-o;let d=l+n;const c=d%1;if(d-=c,!t&&(t=!0,l<0&&this.scrollable.isScrolledDown))return n=-l,s=!0,void r(!1);if(i+=d,d){const e=this.scrollable.scrollTop+d;this.scrollable.scrollTop=e}r(!1),n=c,e=o}).observe(this.bubblesContainer)}}getRenderedLength(){return Object.keys(this.bubbles).length-this.skippedMids.size}onUnreadedInViewport(e,t){this.unreadedSeen.add(t),this.unreadedObserver.unobserve(e),this.unreaded.delete(e),this.readUnreaded()}readUnreaded(){if(this.readPromise)return;const e=this.getMiddleware();this.readPromise=H.default.idle.focusPromise.then(()=>{if(!e())return;let t=Math.max(...Array.from(this.unreadedSeen));if(this.scrollable.loadedAll.bottom){const e=Math.max(...Object.keys(this.bubbles).map(e=>+e));t>=e&&(t=Math.max(this.appMessagesManager.getHistoryStorage(this.peerId,this.chat.threadId).maxId||0,t))}this.unreaded.forEach((e,s)=>{e<=t&&this.onUnreadedInViewport(s,e)});const s=[];for(const e of this.unreadedSeen){const t=this.chat.getMessage(e);this.appMessagesManager.isMentionUnread(t)&&s.push(e)}return this.appMessagesManager.readMessages(this.peerId,s),this.unreadedSeen.clear(),j.b&&this.log("will readHistory by maxId:",t),this.appMessagesManager.readHistory(this.peerId,t,this.chat.threadId).catch(e=>{this.log.error("readHistory err:",e),this.appMessagesManager.readHistory(this.peerId,t,this.chat.threadId)}).finally(()=>{e()&&(this.readPromise=void 0,this.unreadedSeen.size&&this.readUnreaded())})})}constructPinnedHelpers(){this.listenerSetter.add(H.default)("peer_pinned_messages",e=>{const{peerId:t,mids:s,pinned:i}=e;t===this.peerId&&s&&(i||this.deleteMessagesByIds(s))})}constructScheduledHelpers(){const e=()=>{this.chat.topbar.setTitle(this.appMessagesManager.getScheduledMessagesStorage(this.peerId).size)};this.listenerSetter.add(H.default)("scheduled_new",({peerId:t,mid:s})=>{t===this.peerId&&(this.renderNewMessagesByIds([s]),e())}),this.listenerSetter.add(H.default)("scheduled_delete",({peerId:t,mids:s})=>{t===this.peerId&&(this.deleteMessagesByIds(s),e())})}onGoDownClick(){if(this.replyFollowHistory.length){Object(a.e)(this.replyFollowHistory,(e,t)=>{const s=this.bubbles[e];let i=!0;if(s){const e=s.getBoundingClientRect();i=mt.windowH/2>e.top}else{this.chat.getMessage(e).deleted||(i=!1)}i&&this.replyFollowHistory.splice(t,1)}),this.replyFollowHistory.sort((e,t)=>t-e);const e=this.replyFollowHistory.pop();this.chat.setMessageId(e)}else this.chat.setMessageId()}getBubbleByPoint(e){let t=Ar(this.scrollable.container,e,"center");return t&&(t=Object(ti.a)(t,"bubble")),t}getGroupedBubble(e){const t=this.appMessagesManager.groupedMessagesStorage[e];for(const[e]of t)if(this.bubbles[e]){const s=Math.max(...t.keys());return{bubble:this.bubbles[e],mid:+e,message:this.chat.getMessage(s)}}return null}getBubbleGroupedItems(e){return Array.from(e.querySelectorAll(".grouped-item"))}getMountedBubble(e,t=this.chat.getMessage(e)){if(t.grouped_id&&this.appMessagesManager.getMidsByAlbum(t.grouped_id).length>1){const s=this.getGroupedBubble(t.grouped_id);if(s)return s.bubble=s.bubble.querySelector(`.document-container[data-mid="${e}"]`)||s.bubble,s}const s=this.bubbles[e];if(s)return{bubble:s,mid:e,message:t}}findNextMountedBubbleByMsgId(e){return this.bubbles[Object(m.e)(this.bubbles).find(t=>{var s;return!(t<e)&&!!(null===(s=this.bubbles[t])||void 0===s?void 0:s.parentElement)})]}loadMoreHistory(e,t=!1){if(!this.peerId||this.chat.setPeerPromise||this.isHeavyAnimationInProgress||e&&(this.getHistoryTopPromise||this.scrollable.loadedAll.top)||!e&&(this.getHistoryBottomPromise||this.scrollable.loadedAll.bottom))return;const s=Object.keys(this.bubbles).map(e=>+e).sort((e,t)=>e-t);if(s.length)if(e)j.b&&this.log("Will load more (up) history by id:",s[0],"maxId:",s[s.length-1],t),this.getHistory(s[0],!0,void 0,void 0,t);else{const e=this.appMessagesManager.getHistoryStorage(this.peerId,this.chat.threadId);if(-1!==s.indexOf(e.maxId))return void this.setLoaded("bottom",!0);j.b&&this.log("Will load more (down) history by id:",s[s.length-1],t),this.getHistory(s[s.length-1],!1,!0,void 0,t)}}setScroll(){this.scrollable=new re.b(null,"IM",300),this.setLoaded("top",!1),this.setLoaded("bottom",!1),this.scrollable.container.append(this.chatInner),this.scrollable.onAdditionalScroll=this.onScroll,this.scrollable.onScrolledTop=()=>this.loadMoreHistory(!0),this.scrollable.onScrolledBottom=()=>this.loadMoreHistory(!1),Ht.IS_TOUCH_SUPPORTED&&(this.scrollable.container.addEventListener("touchmove",()=>{this.isScrollingTimeout?clearTimeout(this.isScrollingTimeout):this.chatInner.classList.contains("is-scrolling")||this.chatInner.classList.add("is-scrolling")},{passive:!0}),this.scrollable.container.addEventListener("touchend",()=>{this.chatInner.classList.contains("is-scrolling")&&(this.isScrollingTimeout&&clearTimeout(this.isScrollingTimeout),this.isScrollingTimeout=window.setTimeout(()=>{this.chatInner.classList.remove("is-scrolling"),this.isScrollingTimeout=0},1350))},{passive:!0}))}updateUnreadByDialog(){const e=this.appMessagesManager.getHistoryStorage(this.peerId,this.chat.threadId),t=this.peerId===H.default.myId?e.readMaxId:e.readOutboxMaxId;for(const e of this.unreadOut)if(e>0&&e<=t){const t=this.bubbles[e];if(t){if(t.classList.contains("is-sending"))continue;t.classList.remove("is-sent","is-sending"),t.classList.add("is-read")}this.unreadOut.delete(e)}}deleteMessagesByIds(e,t=!0){e.forEach(e=>{if(!(e in this.bubbles))return;const t=this.bubbles[e];delete this.bubbles[e],this.skippedMids.delete(e),this.firstUnreadBubble===t&&(this.firstUnreadBubble=null),this.bubbleGroups.removeBubble(t),this.unreadedObserver&&(this.unreadedObserver.unobserve(t),this.unreaded.delete(t)),this.viewsObserver&&(this.viewsObserver.unobserve(t),this.viewsMids.delete(e)),t.remove(),this.emptyPlaceholderMid===e&&(this.emptyPlaceholderMid=void 0)}),t&&this.chat.selection.isSelecting&&this.chat.selection.deleteSelectedMids(this.peerId,e),zs.a.checkAnimations(!1,Sd),this.deleteEmptyDateGroups()}renderNewMessagesByIds(e,t){if(!this.scrollable.loadedAll.bottom)return;this.chat.threadId&&(e=e.filter(e=>{const t=this.chat.getMessage(e).reply_to;return t&&(t.reply_to_top_id||t.reply_to_msg_id)===this.chat.threadId})),e=e.filter(e=>!this.bubbles[e]),t||(t=this.scrolledDown&&(!this.scrollingToBubble||this.scrollingToBubble===this.getLastBubble()));const s=this.getMiddleware();let i,n=!1;if(!this.isTopPaddingSet){const{clientHeight:e,scrollHeight:t}=this.scrollable.container;n=e===t,n&&(i=this.chatInner,i.style.paddingTop=e+"px",this.scrollable.scrollTop=t,this.isTopPaddingSet=!0)}const a=this.performHistoryResult(e,!1,!0);t&&a.then(()=>{if(!s())return;let t;"scheduled"===this.chat.type&&(t=this.bubbles[Math.max(...e)]);const a=this.scrollToBubbleEnd(t)||Promise.resolve();n&&a.then(()=>{s()&&n&&(i.style.paddingTop="",this.isTopPaddingSet=!1)})})}getLastBubble(){const e=this.getLastDateGroup();if(e)return e.lastElementChild}scrollToBubble(e,t,s,i){const n=Object(ti.a)(e,"bubble");if("center"===t&&Object(Na.a)(n)===(this.stickyIntersector?2:1)){const s=n.parentElement;0===Object(Na.a)(s)&&(e=s,t="start")}const a=this.chat.input.messageInput&&this.chat.input.messageInput.classList.contains("is-changing-height")||this.chat.container.classList.contains("is-toggling-helper");return this.scrollable.scrollIntoViewNew(e,t,4,void 0,s,i,"y",a?({rect:e})=>{let t=mt.windowH;return t-=this.bubblesContainer.offsetTop,t-=I.b.isMobile||mt.windowH<570?58:78,t}:void 0)}scrollToBubbleEnd(e=this.getLastBubble()){if(e){this.scrollingToBubble=e;const t=this.getMiddleware();return this.scrollToBubble(e,"end",void 0,void 0).then(()=>{t()&&(this.scrollingToBubble=void 0)})}}getLastDateGroup(){let e,t=0;for(const s in this.dateMessages){const i=this.dateMessages[s];i.firstTimestamp>t&&(e=i.container,t=i.firstTimestamp)}return e}scrollToBubbleIfLast(e){var t,s;(null===(t=e.parentElement)||void 0===t?void 0:t.lastElementChild)===e&&(null===(s=this.getLastDateGroup().parentElement)||void 0===s?void 0:s.lastElementChild)===e.parentElement&&this.scrollToBubbleEnd(e)}highlightBubble(e){const t="highlightTimeout";e.dataset[t]&&(clearTimeout(+e.dataset[t]),e.classList.remove("is-highlighted"),e.offsetWidth),e.classList.add("is-highlighted"),e.dataset[t]=""+setTimeout(()=>{e.classList.remove("is-highlighted"),delete e.dataset[t]},2e3)}getDateContainerByMessage(e,t){const s=new Date(1e3*e.date);s.setHours(0,0,0);const i=s.getTime();if(!this.dateMessages[i]){let t;const n=new Date;n.setHours(0,0,0,0);const a="scheduled"===this.chat.type;if(n.getTime()===s.getTime())t=Object(O.i18n)(a?"Chat.Date.ScheduledForToday":"Date.Today");else if(a&&2147483646===e.date)t=Object(O.i18n)("MessageScheduledUntilOnline");else{const e={day:"numeric",month:"long"};s.getFullYear()!==n.getFullYear()&&(e.year="numeric"),t=new O.default.IntlDateElement({date:s,options:e}).element,a&&(t=Object(O.i18n)("Chat.Date.ScheduledFor",[t]))}const o=document.createElement("div");o.className="bubble service is-date";const r=document.createElement("div");r.classList.add("bubble-content");const l=document.createElement("div");l.classList.add("service-msg"),l.append(t),r.append(l),o.append(r);const d=document.createElement("div");d.className="bubbles-date-group",d.append(o),this.dateMessages[i]={div:o,container:d,firstTimestamp:s.getTime()};const c=Object(m.e)(this.dateMessages,"asc");let h,u=0,p=c.length;for(;u<c.length;++u){const e=c[u];if(h=this.dateMessages[e].container,i<e)break}u===p&&h&&(h=h.nextElementSibling),h?this.chatInner.insertBefore(d,h):this.chatInner.append(d),this.stickyIntersector&&this.stickyIntersector.observeStickyHeaderChanges(d)}return this.dateMessages[i]}destroy(){this.scrollable.onScrolledTop=this.scrollable.onScrolledBottom=this.scrollable.onAdditionalScroll=null,this.listenerSetter.removeAll(),this.lazyLoadQueue.clear(),this.unreadedObserver&&this.unreadedObserver.disconnect(),this.viewsObserver&&this.viewsObserver.disconnect(),this.stickyIntersector&&this.stickyIntersector.disconnect(),delete this.lazyLoadQueue,this.unreadedObserver&&delete this.unreadedObserver,this.viewsObserver&&delete this.viewsObserver,this.stickyIntersector&&delete this.stickyIntersector}cleanup(e=!1){this.setLoaded("top",!1),this.setLoaded("bottom",!1),Object(Ia.c)(this.scrollable.container),Object(it.d)(),void 0!==hl&&(hl=void 0),this.bubbles={},this.skippedMids.clear(),this.dateMessages={},this.bubbleGroups.cleanup(),this.unreadOut.clear(),this.needUpdate.length=0,this.lazyLoadQueue.clear(),e&&(this.scrollable.container.textContent=""),this.firstUnreadBubble=null,this.attachedUnreadBubble=!1,this.messagesQueue.length=0,this.messagesQueuePromise=null,this.getHistoryTopPromise=this.getHistoryBottomPromise=void 0,this.fetchNewPromise=void 0,this.stickyIntersector&&this.stickyIntersector.disconnect(),this.unreadedObserver&&(this.unreadedObserver.disconnect(),this.unreaded.clear(),this.unreadedSeen.clear(),this.readPromise=void 0),this.viewsObserver&&(this.viewsObserver.disconnect(),this.viewsMids.clear()),this.loadedTopTimes=this.loadedBottomTimes=0,this.middleware.clean(),this.onAnimateLadder=void 0,this.resolveLadderAnimation=void 0,this.emptyPlaceholderMid=void 0,this.scrollingToBubble=void 0,this.isTopPaddingSet=!1}setPeer(e,t){var s;if(!e)return this.cleanup(!0),this.peerId=e,null;const i=this.peerId===e,n=this.chat.type;("scheduled"===n||this.chat.isRestricted)&&(t=0),this.historyStorage=this.appMessagesManager.getHistoryStorage(e,this.chat.threadId);let a="pinned"===n?this.appMessagesManager.pinnedMessages[e].maxId:null!==(s=this.historyStorage.maxId)&&void 0!==s?s:0;const o=void 0!==t;let r,l=0;o||(i||(r=this.chat.appImManager.getChatSavedPosition(this.chat)),r||a&&(l=this.appMessagesManager.getReadMaxIdIfUnread(e,this.chat.threadId),t=l&&!i?l:a));const d=t!==a,{scrollable:c}=this;if(i){const e=this.getMountedBubble(t);if(e)return o?(this.scrollToBubble(e.bubble,"center"),this.highlightBubble(e.bubble),this.chat.dispatchEvent("setPeer",t,!1)):a&&!d&&(c.scrollTop=c.scrollHeight,this.chat.dispatchEvent("setPeer",t,!0)),null}else this.peerId&&(this.lazyLoadQueue.queueId=++ul,this.chat.apiManager.setQueueId(this.chat.bubbles.lazyLoadQueue.queueId)),this.peerId=e,this.replyFollowHistory.length=0,this.passEntities={messageEntityBotCommand:this.appPeersManager.isAnyGroup(e)||this.appUsersManager.isBot(e)};j.b&&this.log("setPeer peerId:",e,this.historyStorage,t,a);const h=d||"scheduled"===n||this.chat.isRestricted?0:a;let u=0;if(i){let e=this.getBubbleByPoint("bottom");e&&(u=+e.dataset.mid),u<=0&&(u=Math.max(...Object.keys(this.bubbles).map(e=>+e)))}else this.isFirstLoad=!0;const p=this.chatInner;this.cleanup();const g=this.chatInner=document.createElement("div");let m;i?(g.className=p.className,g.classList.remove("disable-hover","is-scrolling")):g.classList.add("bubbles-inner"),this.lazyLoadQueue.lock(),m=r?{promise:Object(it.c)().then(()=>this.performHistoryResult(r.mids,!0,!1,void 0)),cached:!0}:this.getHistory(t,!0,d,h);const{promise:f,cached:v}=m;v||i||(c.container.textContent="",this.chat.finishPeerChange(o,d,t),this.preloader.attach(this.bubblesContainer)),zs.a.lockGroup(Sd);const b=f.then(()=>{if(v?i||this.chat.finishPeerChange(o,d,t):this.preloader.detach(),this.resolveLadderAnimation&&(this.resolveLadderAnimation(),this.resolveLadderAnimation=void 0),c.lastScrollDirection=0,c.lastScrollTop=0,Object(le.a)(c.container,g),zs.a.unlockGroup(Sd),zs.a.checkAnimations(!1,Sd),this.lazyLoadQueue.unlock(),r)c.scrollTop=r.top;else if(a&&d||o){const e=u>0&&(!t||u<t||t<0),s=l===t&&!o;!e&&i?c.scrollTop=99999:e&&(c.scrollTop=0);const n=t?this.getMountedBubble(t):{bubble:this.getLastBubble()};let a=s&&this.firstUnreadBubble||(null==n?void 0:n.bubble);(null==a?void 0:a.parentElement)||(a=this.findNextMountedBubbleByMsgId(t)),a&&(this.scrollToBubble(a,s?"start":"center",i?void 0:rn.a.Static),s||this.highlightBubble(a))}else c.scrollTop=99999;this.onScroll();const s=this.getMiddleware(),h=Promise.all([b,Object(it.c)()]);h.then(()=>{c.checkForTriggers()}),this.chat.dispatchEvent("setPeer",t,!d);const p=this.appMessagesManager.isFetchIntervalNeeded(e);if(r||p?h.then(()=>{if(s()&&(c.checkForTriggers(),p)){const t=()=>{this.fetchNewPromise=new Promise(i=>{s()&&this.appMessagesManager.isFetchIntervalNeeded(e)?this.appMessagesManager.getNewHistory(e,this.chat.threadId).then(e=>{if(!s()||!e)return void i();const n=e.history.slice.isEnd(Y.Bottom);c.loadedAll.bottom&&c.loadedAll.bottom!==n&&(this.setLoaded("bottom",n),this.onScroll()),setTimeout(t,3e4),i()}):i()}).finally(()=>{this.fetchNewPromise=void 0})};i?setTimeout(t,3e4):t()}}):t&&!this.bubbles[a]&&t!==a||this.setLoaded("bottom",!0),this.log("scrolledAllDown:",c.loadedAll.bottom),c.loadedAll.bottom&&a&&!this.unreaded.size&&this.onScrolledAllDown(),"chat"===n){const t=this.appMessagesManager.getDialogOnly(e);(null==t?void 0:t.pFlags.unread_mark)&&this.appMessagesManager.markDialogUnread(e,!0)}}).catch(e=>{throw this.log.error("getHistory promise error:",e),this.preloader.detach(),e});return{cached:v,promise:b}}onScrolledAllDown(){if("chat"===this.chat.type||"discussion"===this.chat.type){const e=this.appMessagesManager.getHistoryStorage(this.peerId,this.chat.threadId);this.appMessagesManager.readHistory(this.peerId,e.maxId,this.chat.threadId,!0)}}finishPeerChange(){const e=this.peerId,t=this.appPeersManager.isChannel(e),s=this.appMessagesManager.canSendToPeer(e,this.chat.threadId);this.chatInner.classList.toggle("has-rights",s),this.bubblesContainer.classList.toggle("is-chat-input-hidden",!s),this.chatInner.classList.toggle("is-chat",this.chat.isAnyGroup()),this.chatInner.classList.toggle("is-channel",t)}renderMessagesQueue(e,t,s,i){this.messagesQueue.push({message:e,bubble:t,reverse:s,promises:i}),this.setMessagesQueuePromise()}setMessagesQueuePromise(){!this.messagesQueuePromise&&this.messagesQueue.length&&(this.messagesQueuePromise=new Promise((e,t)=>{setTimeout(()=>{const s=this.messagesQueue.slice();this.messagesQueue.length=0;const i=s.reduce((e,{promises:t})=>e.concat(t),[]);this.log("promises to call",i,s,this.isHeavyAnimationInProgress);const n=this.getMiddleware();Promise.all(i).then(()=>{if(!n())throw"setMessagesQueuePromise: peer changed!";this.messagesQueueOnRender&&this.messagesQueueOnRender(),this.messagesQueueOnRenderAdditional&&this.messagesQueueOnRenderAdditional(),s.forEach(({message:e,bubble:t,reverse:s})=>{this.setBubblePosition(t,e,s)}),e(),this.messagesQueuePromise=null,this.messagesQueue.length&&this.setMessagesQueuePromise(),this.setUnreadDelimiter()}).catch(s=>{"messages.getStickers"===s.type&&(this.messagesQueuePromise=null,e()),t()})},0)}))}setBubblePosition(e,t,s){if(t.id<0)return void this.chatInner.prepend(e);const i=this.getDateContainerByMessage(t,s);if("scheduled"===this.chat.type||"pinned"===this.chat.type){const s=this.stickyIntersector?2:1;let n=Array.from(i.container.children).slice(s),a=0,o=0;for(;a<n.length;++a){const e=n[a],s=+e.dataset.timestamp;if(t.date<s)break;if(t.date===s&&(o=+e.dataset.mid),o&&t.mid<o)break}let r=s+a;Ha(e,i.container,r)}else s?i.container.insertBefore(e,i.container.children[this.stickyIntersector?1:0].nextSibling):i.container.append(e);"message"===t._?this.bubbleGroups.addBubble(e,t,s):e.classList.add("is-group-first","is-group-last")}getMiddleware(){return this.middleware.get()}renderMessage(e,t=!1,s=!1,i=null,n=!0){var a,o,r;let l="none";if("messageMediaLiveStream"===(null===(a=null==e?void 0:e.media)||void 0===a?void 0:a._)&&((null==e?void 0:e.message)?l="prepend":(e.message=" ",l="add")),!i&&this.bubbles[e.mid])return;const d="pinned"!==this.chat.type;if(e.deleted)return;if(e.grouped_id&&d){const t=this.appMessagesManager.groupedMessagesStorage[e.grouped_id],s=Math.max(...t.keys());if(e.mid<s)return}const c=this.peerId,h=e.fromId===H.default.myId||e.pFlags.out&&this.appPeersManager.isMegagroup(this.peerId),u=document.createElement("div");let p,g;if(u.classList.add("message"),i){const t=["is-highlighted","is-group-first","is-group-last"],s=i.className.split(" "),n=["bubble"].concat(t.filter(e=>s.includes(e)));i.className=n.join(" "),g=i.lastElementChild,g.classList.contains("bubble-content-wrapper")||(g=i.querySelector(".bubble-content-wrapper")),p=g.firstElementChild,p.innerHTML="",p.style.cssText="",g.innerHTML="",g.appendChild(p);const a=g.style.transitionDelay;g.style.cssText="",g.style.transitionDelay=a,i===this.firstUnreadBubble&&i.classList.add("is-first-unread");const o=+i.dataset.mid;+e.mid===o||(delete this.bubbles[o],this.skippedMids.delete(o))}else if(g=document.createElement("div"),g.classList.add("bubble-content-wrapper"),p=document.createElement("div"),p.classList.add("bubble-content"),(i=document.createElement("div")).classList.add("bubble"),g.appendChild(p),i.appendChild(g),!h&&!e.pFlags.out&&this.unreadedObserver){(e.pFlags.unread||this.appMessagesManager.isMentionUnread(e)||void 0!==this.historyStorage.readMaxId&&this.historyStorage.readMaxId<e.mid)&&(this.unreadedObserver.observe(i),this.unreaded.set(i,e.mid))}this.bubbles[+e.mid]=i,i.dataset.mid=e.mid,i.dataset.peerId=""+e.peerId,i.dataset.timestamp=e.date;const m=[];if("messageService"===e._){const s=e.action;if(s){const t=s._;if(cl.has(t)||O.langPack.hasOwnProperty(t)&&!O.langPack[t])return this.skippedMids.add(+e.mid),i}i.className="bubble service",p.innerHTML="";const a=document.createElement("div");return a.classList.add("service-msg"),s&&("messageActionChannelMigrateFrom"===s._?a.append(Object(O.i18n)("ChatMigration.From",[new Oe({peerId:s.chat_id.toPeerId(!0)}).element])):"messageActionChatMigrateTo"===s._?a.append(Object(O.i18n)("ChatMigration.To",[new Oe({peerId:s.channel_id.toPeerId(!0)}).element])):a.append(this.appMessagesManager.wrapMessageActionTextNew(e))),p.append(a),n&&(this.renderMessagesQueue(e,i,t,m),e.pFlags.is_single&&i.classList.add("is-group-last")),i}let b,y,w=e.media;if((null==w?void 0:w.document)&&!["video","gif"].includes(w.document.type));else if(e.grouped_id&&d){const t=this.appMessagesManager.getAlbumText(e.grouped_id);b=t.message,y=t.totalEntities}else"sticker"!==(null===(o=null==w?void 0:w.document)||void 0===o?void 0:o.type)&&(b=e.message,y=e.totalEntities);let S=N.b.wrapRichText(b,{entities:y,passEntities:this.passEntities}),M=!0,P=!1,L=!0;if(y&&!w){let e=y.filter(e=>"messageEntityEmoji"===e._),t=b.length;if(e.reduce((e,t)=>e+t.length,0)===t&&e.length<=3){if(H.default.settings.emoji.big){let t=this.appStickersManager.getAnimatedEmojiSticker(b);if(1===e.length&&!w&&t)w={_:"messageMediaDocument",document:t};else{let t=document.createElement("div");t.classList.add("attachment"),Object(xe.a)(t,S),i.classList.add("emoji-"+e.length+"x"),p.append(t)}i.classList.add("is-message-empty","emoji-big"),P=!0,M=!1,L=!1}i.classList.add("can-have-big-emoji")}}if(L){const e=document.createElement("div");e.classList.add("caption-live-stream");const t=document.createElement("strong");Object(O._i18n)(t,"EitaaLive.Live"),e.append(t),"add"===l?(u.setAttribute("dir","auto"),p.prepend(e)):"prepend"===l?(u.setAttribute("dir","auto"),p.prepend(e),Object(xe.a)(u,S)):Object(xe.a)(u,S)}const E=Tr.setTime(this.chat,e,i,p,u);p.prepend(u);const _=!this.appMessagesManager.canForward(e);if(i.classList.toggle("no-forwards",_),!_&&e.views&&!(null===(r=e.fwd_from)||void 0===r?void 0:r.saved_from_msg_id)&&"pinned"!==this.chat.type){const e=document.createElement("div");e.classList.add("bubble-beside-button","forward","tgico-forward_filled"),p.prepend(e),i.classList.add("with-beside-button")}if(this.viewsObserver&&this.viewsObserver.observe(i),e.reply_markup&&"replyInlineMarkup"===e.reply_markup._&&e.reply_markup.rows&&e.reply_markup.rows.length){const t=e.reply_markup.rows,s=document.createElement("div");s.classList.add("reply-markup"),t.forEach(t=>{const i=t.buttons;if(!i||!i.length)return;const n=document.createElement("div");n.classList.add("reply-markup-row"),i.forEach(t=>{const s=N.b.wrapRichText(t.text,{noLinks:!0,noLinebreaks:!0});let i;switch(t._){case"keyboardButtonUrl":i=Ne(N.b.wrapRichText(" ",{entities:[{_:"messageEntityTextUrl",length:1,offset:0,url:t.url}]})).firstElementChild,i.classList.add("is-link","tgico");break;case"keyboardButtonSwitchInline":i=document.createElement("button"),i.classList.add("is-switch-inline","tgico"),Object(v.b)(i,s=>{Object(f.a)(s);const i=e.viaBotId||e.fromId;let n;n=t.pFlags.same_peer?Promise.resolve(this.peerId):this.appInlineBotsManager.checkSwitchReturn(i).then(e=>e||new Promise((e,t)=>{new Qa({[this.peerId]:[]},t=>{e(t)},!0).addEventListener("close",()=>{t()})})),n.then(e=>{const s=this.peerId===e?this.chat.threadId:void 0;this.appInlineBotsManager.switchInlineQuery(e,s,i,t.query)})});break;default:i=document.createElement("button")}i.classList.add("reply-markup-button","rp"),"string"==typeof s?i.insertAdjacentHTML("beforeend",s):i.append(s),Object(ei.ripple)(i),n.append(i)}),s.append(n)}),Object(v.b)(s,s=>{let i=s.target;if(i.classList.contains("reply-markup-button")||(i=Object(ti.a)(i,"reply-markup-button")),!i||i.classList.contains("is-link")||i.classList.contains("is-switch-inline"))return;Object(f.a)(s);const n=Object(Na.a)(i),a=t[Object(Na.a)(i.parentElement)];if(!a.buttons||!a.buttons[n])return void this.log.warn("no such button",a,n,e);const o=a.buttons[n];this.appInlineBotsManager.callbackButtonClick(this.peerId,e.mid,o)}),M=!1,i.classList.add("with-reply-markup"),g.append(s)}const k=e.pFlags.is_outgoing;if(h){(e.pFlags.unread||k)&&this.unreadOut.add(e.mid);let t="";t=k?"is-sending":e.pFlags.unread||e.pFlags.is_scheduled?"is-sent":"is-read",i.classList.add(t)}const T=this.appMessagesManager.getMessageWithReplies(e),x=!!T&&e.mid>0;x&&i.classList.add("with-replies");const A=h&&(!e.fwd_from||this.peerId!==H.default.myId);let F=p;if(w){let t=document.createElement("div");t.classList.add("attachment"),b||i.classList.add("is-message-empty");let s=!1;switch(w._){case"messageMediaPhoto":{const s=w.photo;b||(M=!1),e.viaBotId||i.classList.add("hide-name"),i.classList.add("photo");const n=this.appMessagesManager.groupedMessagesStorage[e.grouped_id];if(e.grouped_id&&1!==n.size&&d){i.classList.add("is-album","is-grouped"),Ba({groupId:e.grouped_id,attachmentDiv:t,middleware:this.getMiddleware(),isOut:h,lazyLoadQueue:this.lazyLoadQueue,chat:this.chat,loadPromises:m,noAutoDownload:this.chat.noAutoDownloadMedia});break}const a=!C.IS_ANDROID&&M&&!x&&!1;a&&i.classList.add("with-media-tail"),Oa({photo:s,message:e,container:t,withTail:a,isOut:A,lazyLoadQueue:this.lazyLoadQueue,middleware:this.getMiddleware(),loadPromises:m,noAutoDownload:this.chat.noAutoDownloadMedia});break}case"messageMediaWebPage":{s=!0;let t=w.webpage;if("webPage"!==t._)break;i.classList.add("webpage");let n=document.createElement("div");n.classList.add("web");let a,o,r=document.createElement("div");r.classList.add("quote");const l=t.photo;(l||t.document)&&(a=document.createElement("div"),a.classList.add("preview-resizer"),o=document.createElement("div"),o.classList.add("preview"),a.append(o));const d=t.document;if(d)if("gif"===d.type||"video"===d.type||"round"===d.type){const t="round"===d.type?I.b.active.round:I.b.active.webpage;"round"===d.type?(i.classList.add("round"),o.classList.add("is-round")):i.classList.add("video"),xa({doc:d,container:o,message:e,boxWidth:t.width,boxHeight:t.height,lazyLoadQueue:this.lazyLoadQueue,middleware:this.getMiddleware(),isOut:A,group:Sd,loadPromises:m,noAutoDownload:!0})}else{const t=Aa({message:e,noAutoDownload:this.chat.noAutoDownloadMedia,lazyLoadQueue:this.lazyLoadQueue,loadPromises:m});o.append(t),o.classList.add("preview-with-document")}let c,h=document.createElement("div");if(h.classList.add("quote-text"),a&&h.append(a),t.site_name){const e=Ne(N.b.wrapRichText(t.url)).firstElementChild;e.classList.add("webpage-name"),Object(xe.a)(e,N.b.wrapEmojiText(t.site_name)),h.append(e),c=e}if(t.rTitle){let e=document.createElement("div");e.classList.add("title"),Object(xe.a)(e,t.rTitle),h.append(e),c=e}if(t.rDescription){let e=document.createElement("div");e.classList.add("text"),Object(xe.a)(e,t.rDescription),h.append(e),c=e}if(r.append(h),l&&!d){i.classList.add("photo");const t=l.sizes[l.sizes.length-1];let s=!1;t.w===t.h&&c?(i.classList.add("is-square-photo"),s=!0,this.appPhotosManager.setAttachmentSize(l,o,48,48,!1)):t.h>t.w&&i.classList.add("is-vertical-photo"),Oa({photo:l,message:e,container:o,boxWidth:s?0:I.b.active.webpage.width,boxHeight:s?0:I.b.active.webpage.height,isOut:A,lazyLoadQueue:this.lazyLoadQueue,middleware:this.getMiddleware(),loadPromises:m,withoutPreloader:s,noAutoDownload:this.chat.noAutoDownloadMedia})}n.append(r),u.insertBefore(n,E);break}case"messageMediaDocument":{const n=w.document;if(n.sticker){i.classList.add("sticker"),M=!1,P=!0,n.animated&&i.classList.add("sticker-animated");const e=I.b.active,s=i.classList.contains("emoji-big")?e.emojiSticker:n.animated?e.animatedSticker:e.staticSticker;this.appPhotosManager.setAttachmentSize(n,t,s.width,s.height),p.style.height=t.style.height,p.style.width=t.style.width,Da({doc:n,div:t,middleware:this.getMiddleware(),lazyLoadQueue:this.lazyLoadQueue,group:Sd,play:!0,loop:!0,emoji:i.classList.contains("emoji-big")?b:void 0,withThumb:!0,loadPromises:m})}else if("video"===n.type||"gif"===n.type||"round"===n.type){const s="round"===n.type;s&&(P=!0),!s&&b||(M=!1),e.viaBotId||i.classList.add("hide-name"),i.classList.add(s?"round":"video");const a=this.appMessagesManager.groupedMessagesStorage[e.grouped_id];if(e.grouped_id&&1!==a.size&&d)i.classList.add("is-album","is-grouped"),Ba({groupId:e.grouped_id,attachmentDiv:t,middleware:this.getMiddleware(),isOut:h,lazyLoadQueue:this.lazyLoadQueue,chat:this.chat,loadPromises:m,noAutoDownload:this.chat.noAutoDownloadMedia});else{const a=!C.IS_ANDROID&&!C.IS_APPLE&&!s&&M&&!x&&!1;a&&i.classList.add("with-media-tail"),xa({doc:n,container:t,message:e,boxWidth:I.b.active.regular.width,boxHeight:I.b.active.regular.height,withTail:a,isOut:A,lazyLoadQueue:this.lazyLoadQueue,middleware:this.getMiddleware(),group:Sd,loadPromises:m,noAutoDownload:!0,searchContext:s?{peerId:this.peerId,inputFilter:{_:"inputMessagesFilterRoundVoice"},threadId:this.chat.threadId,useSearch:!e.pFlags.is_scheduled,isScheduled:e.pFlags.is_scheduled}:void 0})}}else{const t=function({albumMustBeRenderedFull:e,message:t,bubble:s,messageDiv:i,chat:n,loadPromises:a,noAutoDownload:o,lazyLoadQueue:r,searchContext:l,useSearch:d}){let c;const h=e?n.getMidsByMid(t.mid):[t.mid];return h.forEach((e,t)=>{const s=n.getMessage(e),d=Aa({message:s,loadPromises:a,noAutoDownload:o,lazyLoadQueue:r,searchContext:l}),u=document.createElement("div");u.classList.add("document-container"),u.dataset.mid=""+e,u.dataset.peerId=""+s.peerId;const p=document.createElement("div");if(p.classList.add("document-wrapper"),s.message){const e=document.createElement("div");e.classList.add("document-message");const t=N.b.wrapRichText(s.message,{entities:s.totalEntities});Object(xe.a)(e,t),p.append(e)}if(h.length>1){const e=document.createElement("div");e.classList.add("document-selection"),u.append(e),u.classList.add("grouped-item"),0===t&&(c=p)}p.append(d),u.append(p),i.append(u)}),h.length>1&&s.classList.add("is-multiple-documents","is-grouped"),c}({albumMustBeRenderedFull:d,message:e,bubble:i,messageDiv:u,chat:this.chat,loadPromises:m,noAutoDownload:this.chat.noAutoDownloadMedia,lazyLoadQueue:this.lazyLoadQueue,searchContext:"voice"===n.type||"audio"===n.type?{peerId:this.peerId,inputFilter:{_:"voice"===n.type?"inputMessagesFilterRoundVoice":"inputMessagesFilterMusic"},threadId:this.chat.threadId,useSearch:!e.pFlags.is_scheduled,isScheduled:e.pFlags.is_scheduled}:void 0});t&&(F=t);const a=u.lastElementChild.querySelector(".document-message, .document-size, .audio");a&&a.append(E.cloneNode(!0)),i.classList.remove("is-message-empty"),u.classList.add((["photo","pdf"].includes(n.type)?"document":n.type||"document")+"-message"),s=!0}break}case"messageMediaContact":{const t=document.createElement("div");t.classList.add("contact"),t.dataset.peerId=""+w.user_id,u.classList.add("contact-message"),s=!0;const n=document.createElement("div");n.classList.add("contact-details");const a=document.createElement("div");a.classList.add("contact-name"),e.media.first_name&&a.append(N.b.wrapEmojiText(e.media.first_name)),e.media.last_name&&(e.media.first_name&&a.append(" "),a.append(N.b.wrapEmojiText(e.media.last_name)));const o=document.createElement("div");o.classList.add("contact-number"),o.textContent=e.media.phone_number?"+"+Object(fe.a)(e.media.phone_number).formatted:"Unknown phone number",n.append(a,o),t.append(n);const r=new Od;r.lazyLoadQueue=this.lazyLoadQueue,r.setAttribute("peer",""+e.media.user_id),r.classList.add("contact-avatar","avatar-54"),t.prepend(r),i.classList.remove("is-message-empty"),u.classList.add("contact-message"),u.append(t);break}case"messageMediaPoll":{i.classList.remove("is-message-empty");const t=function(e){const t=new Sa;return t.message=e,t.setAttribute("peer-id",""+e.peerId),t.setAttribute("poll-id",e.media.poll.id),t.setAttribute("message-id",""+e.mid),t.render(),t}(e);u.prepend(t),u.classList.add("poll-message");break}case"messageMediaLiveStream":{const s=!1;i.classList.add(s?"round":"video");const n=!1;n&&i.classList.add("with-media-tail"),function({doc:e,container:t,message:s,boxWidth:i,boxHeight:n,withTail:a,isOut:o,middleware:r,lazyLoadQueue:l,noInfo:d,group:c,onlyPreview:h,withoutPreloader:u,loadPromises:p,noPlayButton:g,noAutoDownload:m,size:f,searchContext:v}){var b,y;t.classList.add("live");const w=document.createElement("span");let S;w.classList.add("video-play","btn-circle","position-center"),t.append(w);let I=document.createElement("span");if(I.classList.add("live-type"),"messageMediaLiveStream"===s.media._){if((null===(y=null===(b=s.media)||void 0===b?void 0:b.thumbs)||void 0===y?void 0:y.length)>0){const e=s.media.thumbs[0],i=new Blob([e.bytes],{type:"application/octet-stream"});pt(URL.createObjectURL(i)).then(e=>{let s=document.createElement("img");s.classList.add("media-photo"),s.src=e,t.prepend(s)})}const e=s.media.state;"liveStreamStateBroadcasting"===e._?1===e.flags?(S="paused",Object(O._i18n)(I,"EitaaLive.StreamStatePaused")):(S="broadcasting",Object(O._i18n)(I,"EitaaLive.StreamStateBroadcasting")):("liveStreamStateEnded"===e._||"liveStreamStateEnded2"===e._)&&1===e.flags?(S="archived",Object(O._i18n)(I,"EitaaLive.StreamStateArchive")):(S="ended",Object(O._i18n)(I,"EitaaLive.StreamStateEnded")),t.classList.add("live-"+S),t.append(I)}let M,C={};s&&(M=Oa({photo:e,message:s,container:t,boxWidth:i,boxHeight:n,withTail:a,isOut:o,lazyLoadQueue:l,middleware:r,withoutPreloader:!0,loadPromises:p,noAutoDownload:m,size:f}),C.thumb=M)}({doc:w.document,container:t,message:e,boxWidth:I.b.active.regular.width,boxHeight:I.b.active.regular.height,withTail:n,isOut:A,lazyLoadQueue:this.lazyLoadQueue,middleware:this.getMiddleware(),group:Sd,loadPromises:m,noAutoDownload:this.chat.noAutoDownloadMedia,searchContext:s?{peerId:this.peerId,inputFilter:{_:"inputMessagesFilterRoundVoice"},threadId:this.chat.threadId,useSearch:!e.pFlags.is_scheduled,isScheduled:e.pFlags.is_scheduled}:void 0});break}case"messageMediaGeo":case"messageMediaGeoLive":case"messageMediaVenue":i.classList.remove("is-message-empty"),Ua(e,t),u.append(E);break;default:i.classList.remove("is-message-empty"),u.innerHTML='<i class="media-not-supported">This message is currently not supported on Eitaa Web. Try <a href="https://desktop.eitaa.com/" target="_blank">desktop.eitaa.com</a></i>',u.append(E),this.log.warn("unrecognized media type:",e.media._,e)}s||p.append(t)}P&&i.classList.add("just-media"),this.chat.selection.isSelecting&&this.chat.selection.toggleElementCheckbox(i,!0);let D="";const j=e.fromId!==H.default.myId&&this.appPeersManager.isAnyChat(c)&&!this.appPeersManager.isBroadcast(c)||e.viaBotId;if(j||e.fwd_from||e.reply_to_mid){let t,s;const n=e.from_id&&"peerChannel"===e.from_id._&&e.fromId===e.fwdFromId;let a,o=e.fwd_from&&!e.fwd_from.from_id&&!e.fwd_from.channel_id;if(e.viaBotId&&(s=document.createElement("span"),s.innerText="@"+this.appUsersManager.getUser(e.viaBotId).username,s.classList.add("peer-title"),i.classList.add("must-have-name")),o?(t=document.createElement("span"),Object(xe.a)(t,N.b.wrapEmojiText(e.fwdFrom.from_name)),t.classList.add("peer-title"),i.classList.add("hidden-profile")):t=new Oe({peerId:e.fwdFromId||e.fromId}).element,e.reply_to_mid&&e.reply_to_mid!==this.chat.threadId&&Tr.setReply({chat:this.chat,bubble:i,bubbleContainer:p,message:e}),e.fwdFromId||e.fwd_from)if(this.peerId===H.default.myId||n||i.classList.add("forwarded"),e.savedFrom&&(D=e.savedFrom,t.dataset.savedFrom=D),a=document.createElement("div"),t.dataset.peerId=e.fwdFromId,this.peerId!==H.default.myId&&this.peerId!==Z.c&&!n||P){const e=[t];P&&e.unshift(document.createElement("br")),a.append(Object(O.i18n)("ForwardedFrom",[e]))}else a.style.color=this.appPeersManager.getPeerColorById(e.fwdFromId,!1),a.append(t);else e.viaBotId||(!P&&j?(a=document.createElement("div"),a.append(t),h||(a.style.color=this.appPeersManager.getPeerColorById(e.fromId,!1)),a.dataset.peerId=e.fromId):i.classList.add("hide-name"));if(e.viaBotId){a?a.append(" "):a=document.createElement("div");const e=document.createElement("span");e.append(Object(O.i18n)("ViaBot")," ",s),e.classList.add("is-via"),a.append(e)}a&&(a.classList.add("name"),F.append(a));if(this.chat.isAnyGroup()&&!A){let t=new Od;t.lazyLoadQueue=this.lazyLoadQueue,t.classList.add("user-avatar","avatar-40"),t.loadPromises=m,!e.fwdFromId&&e.fwd_from&&e.fwd_from.from_name&&t.setAttribute("peer-title",e.fwd_from.from_name),t.setAttribute("peer",""+((e.fwd_from&&(this.peerId===H.default.myId||this.peerId===Z.c)||n?e.fwdFromId:e.fromId)||Z.b)),g.append(t)}}else i.classList.add("hide-name");"pinned"===this.chat.type&&(D=`${this.chat.peerId}_${e.mid}`);if(T&&T.mid===this.chat.threadId&&i.classList.add("is-thread-starter","is-group-last"),D&&("pinned"===this.chat.type||e.fwd_from.saved_from_msg_id)&&this.peerId!==Z.c){const e=document.createElement("div");e.classList.add("bubble-beside-button","goto-original","tgico-arrow_next"),p.append(e),i.dataset.savedFrom=D,i.classList.add("with-beside-button")}if(i.classList.add(A?"is-out":"is-in"),n&&this.renderMessagesQueue(e,i,t,m),x){Tr.renderReplies({bubble:i,bubbleContainer:p,message:T,messageDiv:u,loadPromises:m,lazyLoadQueue:this.lazyLoadQueue})&&(M=!0)}return M&&(i.classList.add("can-have-tail"),p.append(gl())),i}safeRenderMessage(e,t,s,i,n){try{return this.renderMessage(e,t,s,i,n)}catch(e){this.log.error("renderMessage error:",e)}}performHistoryResult(e,t,s,i){return dl(this,void 0,void 0,(function*(){let s;e=e.slice(),i&&e.unshift(i),this.messagesQueueOnRender=()=>{const{scrollTop:e,scrollHeight:i}=this.scrollable;s=t?i-e:e,this.messagesQueueOnRender=void 0},this.needReflowScroll&&(Or(this.scrollable.container),this.needReflowScroll=!1);const n=e=>{const s=this.chat.getMessage(e);s.id>0?this.safeRenderMessage(s,t,!0):this.processLocalMessageRender(s)},a=e.length;if(t)for(let t=0;t<a;++t)n(e[t]);else for(let t=a-1;t>=0;--t)n(e[t]);if("scheduled"!==this.chat.type){const t=this.appMessagesManager.getHistoryStorage(this.peerId,this.chat.threadId),s=t.history.first,i=t.history.last;!s.isEnd(Y.Bottom)||s.length&&!e.includes(s[0])||this.setLoaded("bottom",!0,!1),!i.isEnd(Y.Top)||i.length&&!e.includes(i[i.length-1])||this.setLoaded("top",!0,!1)}else this.setLoaded("top",!0),this.setLoaded("bottom",!0);if(yield this.messagesQueuePromise,this.scrollable.loadedAll.top&&this.messagesQueueOnRenderAdditional&&(this.messagesQueueOnRenderAdditional(),this.messagesQueueOnRenderAdditional&&this.messagesQueueOnRenderAdditional()),void 0!==s){const e=t?this.scrollable.scrollHeight-s:s;this.scrollable.scrollTop=e,C.IS_SAFARI&&Or(this.scrollable.container)}return!0}))}requestHistory(e,t,s){if("chat"===this.chat.type||"discussion"===this.chat.type)return this.appMessagesManager.getHistory(this.peerId,e,t,s,this.chat.threadId);if("pinned"===this.chat.type){return this.appMessagesManager.getSearch({peerId:this.peerId,inputFilter:{_:"inputMessagesFilterPinned"},maxId:e,limit:t,backLimit:s}).then(e=>({history:e.history.map(e=>e.mid)}))}return"scheduled"===this.chat.type?this.appMessagesManager.getScheduledMessages(this.peerId).then(e=>({history:e.slice().reverse()})):void 0}animateAsLadder(e,t,s,i,n){return dl(this,void 0,void 0,(function*(){if(this.chat.setPeerPromise&&!this.resolveLadderAnimation)return void(this.resolveLadderAnimation=this.animateAsLadder.bind(this,e,t,s,i,n));if(!Object.keys(this.bubbles).length)return;let a,o=Object(m.e)(this.bubbles,"desc");s&&t.length&&(o=o.filter(e=>!t.includes(e))),a=i?n||Math.max(...o):e||Math.max(...o);const r=o.slice(o.findIndex(e=>a>e)),l=s?[]:[a],d=s?[]:o.slice(0,o.findIndex(e=>a>=e)).reverse();j.b&&this.log("getHistory: targeting mid:",a,n,e,r.map(e=>this.appMessagesIdsManager.getServerMessageId(e)),d.map(e=>this.appMessagesIdsManager.getServerMessageId(e)));const c=[];this.chatInner.classList.add("zoom-fading");const h=s?10:40,u=s?0:1,p=(e,t=0)=>{const s=Object(w.a)();let i=0;return e.forEach((n,a)=>{if(!this.bubbles[n]||this.skippedMids.has(n))return void this.log.warn("animateAsLadder: no bubble by mid:",n);const o=this.bubbles[n].lastElementChild;if(i=(a+t||.1)*h,o.classList.add("zoom-fade"),o.style.transitionDelay=i+"ms",a===e.length-1){const e=t=>{t.target===o&&(s.resolve(),o.removeEventListener("transitionend",e))};o.addEventListener("transitionend",e)}c.push(o)}),e.length||s.resolve(),{lastMsDelay:i,animationPromise:s}},f=p(r,u),v=p(l),b=p(d,u),y=[f.animationPromise,v.animationPromise,b.animationPromise],S=[f.lastMsDelay,v.lastMsDelay,b.lastMsDelay];let I;return this.onAnimateLadder&&(yield this.onAnimateLadder()),Object(g.b)(()=>{c.forEach(e=>{e.classList.remove("zoom-fade")})}),(r.length||l.length||d.length)&&(I=Promise.all(y),Object(it.b)(I,Math.max(...S)+200).then(()=>{Object(g.b)(()=>{c.forEach(e=>{e.style.transitionDelay=""}),this.chatInner.classList.remove("zoom-fading")}),C.IS_SAFARI||(this.needReflowScroll=!0)})),I}))}renderEmptyPlaceholder(e,t,s,i){const n="empty-bubble-placeholder";let a,o;if(t.classList.add(n,n+"-"+e),"group"===e?a=Object(O.i18n)("GroupEmptyTitle1"):"saved"===e?a=Object(O.i18n)("ChatYourSelfTitle"):"noMessages"===e||"greeting"===e?a=Object(O.i18n)("NoMessages"):"noScheduledMessages"===e?a=Object(O.i18n)("NoScheduledMessages"):"restricted"===e&&(a=document.createElement("span"),a.innerText=this.appPeersManager.getRestrictionReasonText(this.peerId)),a.classList.add("center",n+"-title"),i.push(a),"group"===e)i.push(Object(O.i18n)("GroupEmptyTitle2")),o=[Object(O.i18n)("GroupDescription1"),Object(O.i18n)("GroupDescription2"),Object(O.i18n)("GroupDescription3"),Object(O.i18n)("GroupDescription4")];else if("saved"===e)o=[Object(O.i18n)("ChatYourSelfDescription1"),Object(O.i18n)("ChatYourSelfDescription2"),Object(O.i18n)("ChatYourSelfDescription3"),Object(O.i18n)("ChatYourSelfDescription4")];else if("greeting"===e){const e=Object(O.i18n)("NoMessagesGreetingsDescription");e.classList.add("center",n+"-subtitle"),this.messagesQueue.findAndSplice(e=>e.bubble===t);const a=document.createElement("div");a.classList.add(n+"-sticker");const o=this.getMiddleware(),r=this.appStickersManager.getGreetingSticker().then(e=>{if(!o())return;const t=[];return Da({doc:e,div:a,middleware:o,lazyLoadQueue:this.lazyLoadQueue,group:Sd,play:!0,loop:!0,withThumb:!0,loadPromises:t}),Object(v.b)(a,e=>{Object(f.a)(e),ol.onMediaClick({target:e.target})}),Promise.all(t)});this.renderMessagesQueue(s,t,!1,[r]),i.push(e,a)}o&&(i.push(...o.map(e=>{const t=document.createElement("span");return t.classList.add(n+"-list-item"),t.append(e),t})),"group"===e?o.forEach(e=>{const t=document.createElement("span");t.classList.add("tgico-check"),e.prepend(t)}):"saved"===e&&o.forEach(e=>{const t=document.createElement("span");t.classList.add(n+"-list-bullet"),t.innerText="â€¢",e.prepend(t)})),i.length>1&&t.classList.add("has-description"),i.forEach(e=>e.classList.add(n+"-line"))}processLocalMessageRender(e){const t=this.safeRenderMessage(e,void 0,void 0,void 0,!1);t.classList.add("bubble-first","is-group-last","is-group-first"),t.classList.remove("can-have-tail","is-in");const s=t.querySelector(".message, .service-msg"),i=[],n=this.appPeersManager.isBot(this.peerId);if(this.chat.isRestricted)this.renderEmptyPlaceholder("restricted",t,e,i);else if(n&&"message"===e._){const e=document.createElement("b");e.append(Object(O.i18n)("BotInfoTitle")),i.push(e,"\n\n")}else this.appPeersManager.isAnyGroup(this.peerId)&&this.appPeersManager.getPeer(this.peerId).pFlags.creator?this.renderEmptyPlaceholder("group",t,e,i):"scheduled"===this.chat.type?this.renderEmptyPlaceholder("noScheduledMessages",t,e,i):H.default.myId===this.peerId?this.renderEmptyPlaceholder("saved",t,e,i):this.appPeersManager.isUser(this.peerId)&&!n&&this.appMessagesManager.canSendToPeer(this.peerId)&&"chat"===this.chat.type?this.renderEmptyPlaceholder("greeting",t,e,i):this.renderEmptyPlaceholder("noMessages",t,e,i);s.prepend(...i),this.messagesQueueOnRenderAdditional?this.onAnimateLadder=()=>{if(this.chatInner.prepend(t),this.onAnimateLadder=void 0,!this.messagesQueuePromise)return Object(g.d)()}:this.chatInner.prepend(t),this.emptyPlaceholderMid=e.mid}generateLocalFirstMessage(e,t){const s=this.appMessagesIdsManager.generateMessageId("scheduled"===this.chat.type?-1:0),i={_:e?"messageService":"message",date:0,id:-(+this.peerId+s),peer_id:this.appPeersManager.getOutputPeer(this.peerId),pFlags:{}};return e||(i.message=""),t&&t(i),this.appMessagesManager.saveMessages([i]),i}setLoaded(e,t,s=!0){if(this.scrollable.loadedAll[e]!==t){if(this.scrollable.loadedAll[e]=t,"top"===e&&t&&this.appPeersManager.isBot(this.peerId)&&!this.chat.isRestricted){this.log("inject bot description");const e=this.getMiddleware();return this.appProfileManager.getProfile(this.peerId.toUserId()).then(t=>{var s;if(!e())return;if(!(null===(s=t.bot_info)||void 0===s?void 0:s.description))return void this.checkIfEmptyPlaceholderNeeded();const i=this.generateLocalFirstMessage(!1,e=>{e.message=t.bot_info.description});this.processLocalMessageRender(i)})}this.checkIfEmptyPlaceholderNeeded()}}checkIfEmptyPlaceholderNeeded(){if(this.scrollable.loadedAll.top&&this.scrollable.loadedAll.bottom&&void 0===this.emptyPlaceholderMid&&(this.chat.isRestricted||!this.appMessagesManager.getHistoryStorage(this.peerId).count||Object.keys(this.bubbles).length&&!this.getRenderedLength()||"scheduled"===this.chat.type&&!Object.keys(this.bubbles).length)){this.log("inject empty peer placeholder");const e=this.generateLocalFirstMessage(!0);return this.processLocalMessageRender(e),!0}return!1}getHistory(e=0,t=!1,s=!1,i=0,n=!1){const a=this.peerId,o=Math.min(30,mt.windowH/38|0),r=Object.keys(this.bubbles).length>0?Math.max(40,o):o;let l=r;if(void 0!==hl){if(!hl)return{cached:!1,promise:Promise.resolve(!0)};Object.keys(this.bubbles).length>0&&--hl}let d,c=0;if(s&&(c=l,t||(l=0)),i&&!s)if("pinned"===this.chat.type)d=[i];else{const t=this.appMessagesManager.getHistoryStorage(a,this.chat.threadId).history.slice;if(t.length<l&&!t.isEnd(Y.Both)){d=t.slice();for(let e=d.length-1;e>=0;--e){if(!this.chat.getMessage(d[e]).grouped_id)break;d.splice(e,1)}e=d[d.length-1]||e}}let h,u=this.requestHistory(e,l,c);const p=(null==d?void 0:d.length)&&u instanceof Promise,g=this.isFirstLoad&&c&&u instanceof Promise||p;p&&(h=u,u={history:d}),this.isFirstLoad=!1;const f=e=>dl(this,void 0,void 0,(function*(){if("offsetIdOffset"in e&&e.history.isEnd(Y.Top)){if("discussion"===this.chat.type){const t=this.appMessagesManager.threadsServiceMessagesIdsStorage[this.peerId+"_"+this.chat.threadId];t&&e.history.push(t),e.history.push(...this.chat.getMidsByMid(this.chat.threadId).reverse())}yield this.setLoaded("top",!0)}})),v=e=>Object(it.c)().then(()=>f(e)).then(()=>this.performHistoryResult(e.history||[],t,s,!p&&i)),b=e=>{const s=e.then(e=>(t?this.getHistoryTopPromise!==s:this.getHistoryBottomPromise!==s)?(this.log.warn("getHistory: peer changed"),Promise.reject()):n?(this.scrollable.onScroll(),!0):v(e),e=>{throw this.log.error("getHistory error:",e),e});return s};let y,w;if(u instanceof Promise)w=!1,y=b(u);else{if(n)return null;w=!0,y=v(u)}const S=p?b(h):y;if(g&&H.default.settings.animationsEnabled){let s=p?2:1;this.messagesQueueOnRenderAdditional=()=>{if(this.log("ship went past rocks of magnets"),--s)return;this.messagesQueueOnRenderAdditional=void 0;(this.animateAsLadder(i,d,p,c,e)||Promise.resolve()).then(()=>{setTimeout(()=>{this.loadMoreHistory(t,!0)},0)})}}else this.messagesQueueOnRenderAdditional=void 0;return t?this.getHistoryTopPromise=S:this.getHistoryBottomPromise=S,S.then(()=>{t?this.getHistoryTopPromise=void 0:this.getHistoryBottomPromise=void 0}),n?null:(!g&&y.then(()=>{let e;t?(this.loadedTopTimes++,this.loadedBottomTimes=Math.max(0,--this.loadedBottomTimes)):(this.loadedBottomTimes++,this.loadedTopTimes=Math.max(0,--this.loadedTopTimes)),(t&&this.loadedTopTimes>2||!t&&this.loadedBottomTimes>2)&&(e=Object(m.e)(this.bubbles));const s=2*r;e&&e.length>s&&(t?(e=e.slice(s),this.setLoaded("bottom",!1)):(e=e.slice(0,e.length-s),this.setLoaded("top",!1)),this.deleteMessagesByIds(e,!1))}),y.then(()=>{"chat"===this.chat.type&&setTimeout(()=>{t?this.loadMoreHistory(!0,!0):this.loadMoreHistory(!1,!0)},0)}),{cached:w,promise:y})}setUnreadDelimiter(){if("chat"!==this.chat.type&&"discussion"!==this.chat.type)return;if(this.attachedUnreadBubble)return;const e=this.appMessagesManager.getHistoryStorage(this.peerId,this.chat.threadId);let t=this.appMessagesManager.getReadMaxIdIfUnread(this.peerId,this.chat.threadId);if(t&&(t=Object.keys(this.bubbles).filter(e=>!this.bubbles[e].classList.contains("is-out")).map(e=>+e).sort((e,t)=>e-t).find(e=>e>t),t&&this.bubbles[t])){let s=this.bubbles[t];this.firstUnreadBubble&&this.firstUnreadBubble!==s&&(this.firstUnreadBubble.classList.remove("is-first-unread"),this.firstUnreadBubble=null),t!==e.maxId&&s.classList.add("is-first-unread"),this.firstUnreadBubble=s,this.attachedUnreadBubble=!0}}deleteEmptyDateGroups(){const e=+!!this.stickyIntersector+1;for(const t in this.dateMessages){const s=this.dateMessages[t];s.container.childElementCount===e&&(s.container.remove(),this.stickyIntersector&&this.stickyIntersector.unobserve(s.container,s.div),delete this.dateMessages[t])}this.checkIfEmptyPlaceholderNeeded()}}function gl(){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttributeNS(null,"viewBox","0 0 11 20"),e.setAttributeNS(null,"width","11"),e.setAttributeNS(null,"height","20"),e.classList.add("bubble-tail");const t=document.createElementNS("http://www.w3.org/2000/svg","use");return t.setAttributeNS(null,"href","#message-tail-filled"),e.append(t),e}class ml{constructor(e,t,s,i){var n;let a,o,r,l=[],d=[];const c=Te.canPinMessage(e),h=(n,a,o)=>{setTimeout(()=>{let n;n=s&&!t?c?js.unpinAllMessages(e):js.hidePinnedMessages(e):js.updatePinnedMessage(e,t,s,o,a),i&&n.then(i)},300)};if(s){let s="UnpinMessage";t?(a="UnpinMessageAlertTitle",o="Chat.Confirm.Unpin"):c?(a="Popup.Unpin.AllTitle",o="Chat.UnpinAllMessagesConfirmation",r=[""+((null===(n=js.pinnedMessages[e])||void 0===n?void 0:n.count)||1)]):(a="Popup.Unpin.HideTitle",o="Popup.Unpin.HideDescription",s="Popup.Unpin.Hide"),l.push({langKey:s,isDanger:!0,callback:h})}else{a="PinMessageAlertTitle";const t="PinMessage";e.isAnyChat()?(l.push({langKey:t,callback:e=>h(0,!1,!e.size)}),Pe.isBroadcast(e.toChatId())?o="PinMessageAlertChannel":(o="PinMessageAlert",d.push({text:"PinNotify",checked:!0}))):(o="PinMessageAlertChat",e===H.default.myId?l.push({langKey:t,callback:h}):(l.push({langKey:t,callback:e=>h(0,!e.size)}),d.push({text:"PinAlsoFor",textArgs:[new Oe({peerId:e}).element],checked:!0})))}ai(l);new en("popup-delete-chat",{peerId:e,titleLangKey:a,descriptionLangKey:o,descriptionLangArgs:r,buttons:l,checkboxes:d}).show()}}function fl(e=window.getSelection()){if(!e||!e.rangeCount)return!0;const t=e.getRangeAt(0);return!t.toString()||!t.START_TO_END}class vl{constructor(e){this.size=e,this.needFrame=0,this.container=document.createElement("div"),this.container.classList.add("media-sticker-wrapper")}load(){return this.loadPromise?this.loadPromise:this.loadPromise=pi.b.loadAnimationFromURL({container:this.container,loop:!0,autoplay:!0,width:this.size,height:this.size,noCache:!0},"assets/img/report.tgs").then(e=>(this.animation=e,this.animation.play(),pi.b.waitForFirstFrame(e)))}remove(){this.animation&&this.animation.remove()}}class bl extends en{constructor(e,t,s,i){super("popup-report-messages-confirm",{noTitle:!0,descriptionLangKey:"ReportInfo",buttons:[{langKey:"ReportChat",callback:()=>{a.isValid()&&(i&&i(),js.reportMessages(e,t,s,a.value).then(e=>{e&&$t({langPackKey:"ReportSentInfo"})}))}}],body:!0});const n=new vl(170);n.load(),this.header.append(n.container);const a=new Ws.b({label:"ReportHint",maxLength:512,placeholder:"ReportChatDescription"});a.input.addEventListener("input",()=>{this.buttons[0].element.toggleAttribute("disabled",!a.isValid())}),this.show(),this.body.append(a.container)}}bl.STICKER_EMOJI="ðŸ‘®â€â™€ï¸";class yl extends en{constructor(e,t,s){super("popup-report-messages",{titleLangKey:"ChatTitle.ReportMessages",buttons:[],body:!0}),t=t.slice();const i=[["ReportChatSpam","inputReportReasonSpam"],["ReportChatViolence","inputReportReasonViolence"],["ReportChatChild","inputReportReasonChildAbuse"],["ReportChatPornography","inputReportReasonPornography"],["ReportChatOther","inputReportReasonOther"]];i.forEach(e=>{const t=Object(Ks.a)("btn-primary btn-transparent",{text:e[0]});this.body.append(t)}),Object(v.b)(this.body,n=>{const a=Object(ti.a)(n.target,"btn-primary"),o=i[Object(Na.a)(a)][1];this.hide(),ni.createPopup(bl,e,t,o,s)},{listenerSetter:this.listenerSetter}),this.body.style.margin="0 -1rem",this.buttonsEl.style.marginTop=".5rem",this.show()}}class wl{constructor(e,t,s,i,n,a,o){this.attachTo=e,this.chat=t,this.appMessagesManager=s,this.appPeersManager=i,this.appPollsManager=n,this.appDocsManager=a,this.appMessagesIdsManager=o,this.onSendScheduledClick=()=>{this.chat.selection.isSelecting?Object(v.e)(this.chat.selection.selectionSendNowBtn):new Ya(this.peerId,this.chat.getMidsByMid(this.mid))},this.onReplyClick=()=>{this.chat.input.initMessageReply(this.mid)},this.onEditClick=()=>{this.chat.input.initMessageEditing(this.mid)},this.onCopyClick=()=>{if(fl()){Yi((this.chat.selection.isSelecting?[...this.chat.selection.selectedMids.get(this.peerId)].sort((e,t)=>e-t):[this.mid]).reduce((e,t)=>{const s=this.chat.getMessage(t);return e+((null==s?void 0:s.message)?s.message+"\n":"")},"").trim())}else document.execCommand("copy")},this.onCopyAnchorLinkClick=()=>{Yi(this.target.href)},this.onCopyLinkClick=()=>{let e;"discussion"===this.chat.type&&(e=this.appMessagesManager.getMessageByPeer(this.peerId,this.chat.threadId));const t=this.appPeersManager.getPeerUsername(e?e.fromId:this.peerId),s=this.appMessagesIdsManager.getServerMessageId(this.mid);let i,n="https://eitaa.com/";t?(n+=t+"/"+(e?this.appMessagesIdsManager.getServerMessageId(e.fwd_from.channel_post):s),e&&(n+="?comment="+s),i="LinkCopied"):(n+=this.peerId.toChatId()+"/"+s,e&&(n+="?thread="+this.appMessagesIdsManager.getServerMessageId(e.mid)),i="LinkCopiedPrivateInfo"),Qt(O.default.format(i,!0)),Yi(n)},this.onPinClick=()=>{new ml(this.peerId,this.mid)},this.onUnpinClick=()=>{new ml(this.peerId,this.mid,!0)},this.onRetractVote=()=>{this.appPollsManager.sendVote(this.message,[])},this.onStopPoll=()=>{this.appPollsManager.stopPoll(this.message)},this.onForwardClick=(e="quote")=>{if(this.chat.selection.isSelecting)this.chat.selection.selectionForwardBtn.dataset.type=e,Object(v.e)(this.chat.selection.selectionForwardBtn);else{const t=this.isTargetAGroupedItem?[this.mid]:this.chat.getMidsByMid(this.mid);new Qa({[this.peerId]:t},null,!1,e)}},this.onSelectClick=()=>{this.chat.selection.toggleByElement(Object(ti.a)(this.target,"grouped-item")||Object(ti.a)(this.target,"bubble"))},this.onClearSelectionClick=()=>{this.chat.selection.cancelSelection()},this.onDeleteClick=()=>{this.chat.selection.isSelecting?Object(v.e)(this.chat.selection.selectionDeleteBtn):new $a(this.peerId,this.isTargetAGroupedItem?[this.mid]:this.chat.getMidsByMid(this.mid),this.chat.type)};const r=e=>{let s,i;this.init&&(this.init(),this.init=null);try{i=Object(ti.a)(e.target,"bubble-content-wrapper"),s=i?i.parentElement:Object(ti.a)(e.target,"bubble")}catch(e){}if(!s||s.classList.contains("bubble-first"))return;if((e instanceof MouseEvent||e.hasOwnProperty("preventDefault"))&&e.preventDefault(),this.element.classList.contains("active"))return!1;(e instanceof MouseEvent||e.hasOwnProperty("cancelBubble"))&&(e.cancelBubble=!0);let n=+s.dataset.mid;if(!n)return;if(this.isSelectable=this.chat.selection.canSelectBubble(s),this.peerId=this.chat.peerId,this.target=e.target,this.isTextSelected=!fl(),this.isAnchorTarget="A"===this.target.tagName&&("_blank"===this.target.target||this.target.classList.contains("anchor-url")),this.isUsernameTarget="A"===this.target.tagName&&this.target.classList.contains("mention"),t.selection.isSelecting&&!i){const e=this.chat.getMidsByMid(n);if(e.length>1){const t=this.chat.selection.isMidSelected(this.peerId,n)?n:e.find(e=>this.chat.selection.isMidSelected(this.peerId,e));t&&(n=t)}}const a=Object(ti.a)(this.target,"grouped-item");this.isTargetAGroupedItem=!!a,this.mid=a?+a.dataset.mid:n,this.isSelected=this.chat.selection.isMidSelected(this.peerId,this.mid),this.message=this.chat.getMessage(this.mid),this.noForwards=!this.appMessagesManager.canForward(this.message),this.buttons.forEach(e=>{let s;t.selection.isSelecting&&!e.withSelection?s=!1:(i||Ht.IS_TOUCH_SUPPORTED,s=e.verify()),e.element.classList.toggle("hide",!s)});const o=s.classList.contains("is-in")?"left":"right";Object(hi.e)(e.touches?e.touches[0]:e,this.element,o),Object(hi.d)(this.element,()=>{this.mid=0,this.peerId=void 0,this.target=null})};Ht.IS_TOUCH_SUPPORTED?Object(v.b)(e,e=>{if(t.selection.isSelecting)return;const s=e.target.className;if(!s||!s.includes)return;t.log("touchend",e);["bubble","bubble-content-wrapper","bubble-content","message","time","inner"].find(e=>s.match(new RegExp(e+"($|\\s)")))&&(Object(f.a)(e),r(e))},{listenerSetter:this.chat.bubbles.listenerSetter}):Object(hi.a)(e,r,this.chat.bubbles.listenerSetter)}init(){this.buttons=[{icon:"send2",text:"MessageScheduleSend",onClick:this.onSendScheduledClick,verify:()=>"scheduled"===this.chat.type&&!this.message.pFlags.is_outgoing},{icon:"send2",text:"Message.Context.Selection.SendNow",onClick:this.onSendScheduledClick,verify:()=>"scheduled"===this.chat.type&&this.isSelected&&!this.chat.selection.selectionSendNowBtn.hasAttribute("disabled"),notDirect:()=>!0,withSelection:!0},{icon:"schedule",text:"MessageScheduleEditTime",onClick:()=>{this.chat.input.scheduleSending(()=>{this.appMessagesManager.editMessage(this.message,this.message.message,{scheduleDate:this.chat.input.scheduleDate,entities:this.message.entities}),this.chat.input.onMessageSent(!1,!1)},new Date(1e3*this.message.date))},verify:()=>"scheduled"===this.chat.type},{icon:"reply",text:"Reply",onClick:this.onReplyClick,verify:()=>this.appMessagesManager.canSendToPeer(this.peerId,this.chat.threadId)&&!this.message.pFlags.is_outgoing&&!!this.chat.input.messageInput&&"scheduled"!==this.chat.type},{icon:"edit",text:"Edit",onClick:this.onEditClick,verify:()=>this.appMessagesManager.canEditMessage(this.message,"text",this.peerId)&&!!this.chat.input.messageInput},{icon:"copy",text:"Copy",onClick:this.onCopyClick,verify:()=>!(this.noForwards||!this.message.message||this.isTextSelected||this.isAnchorTarget&&this.message.message===this.target.innerText)},{icon:"copy",text:"Chat.CopySelectedText",onClick:this.onCopyClick,verify:()=>!this.noForwards&&!!this.message.message&&this.isTextSelected},{icon:"copy",text:"Message.Context.Selection.Copy",onClick:this.onCopyClick,verify:()=>{if(!this.isSelected||this.noForwards)return!1;for(const[e,t]of this.chat.selection.selectedMids)for(const s of t)if(this.appMessagesManager.getMessageByPeer(e,s).message)return!0;return!1},notDirect:()=>!0,withSelection:!0},{icon:"copy",text:"CopyLink",onClick:this.onCopyAnchorLinkClick,verify:()=>this.isAnchorTarget,withSelection:!0},{icon:"copy",text:"Text.Context.Copy.Username",onClick:()=>{Yi(this.target.innerHTML)},verify:()=>this.isUsernameTarget,withSelection:!0},{icon:"copy",text:"Text.Context.Copy.Hashtag",onClick:()=>{Yi(this.target.innerHTML)},verify:()=>this.target.classList.contains("anchor-hashtag"),withSelection:!0},{icon:"link",text:"MessageContext.CopyMessageLink1",onClick:this.onCopyLinkClick,verify:()=>this.appPeersManager.isChannel(this.peerId)&&!this.message.pFlags.is_outgoing},{icon:"pin",text:"Message.Context.Pin",onClick:this.onPinClick,verify:()=>!this.message.pFlags.is_outgoing&&"messageService"!==this.message._&&!this.message.pFlags.pinned&&this.appPeersManager.canPinMessage(this.peerId)&&"scheduled"!==this.chat.type},{icon:"unpin",text:"Message.Context.Unpin",onClick:this.onUnpinClick,verify:()=>this.message.pFlags.pinned&&this.appPeersManager.canPinMessage(this.peerId)},{icon:"download",text:"MediaViewer.Context.Download",onClick:()=>{var e;const t=null===(e=this.message)||void 0===e?void 0:e.media;"messageMediaPhoto"===t._&&"photo"===t.photo._?Dt.savePhotoFile(t.photo):this.appDocsManager.saveDocFile(this.message.media.document)},verify:()=>{var e,t,s,i;if(this.message.pFlags.is_outgoing||this.noForwards)return!1;const n=(null===(t=null===(e=this.message)||void 0===e?void 0:e.media)||void 0===t?void 0:t.document)||(null===(i=null===(s=this.message)||void 0===s?void 0:s.media)||void 0===i?void 0:i.photo);if(!n)return!1;let a=!!Ht.IS_TOUCH_SUPPORTED;const o=!n.type||!["gif","video","sticker"].includes(n.type);return o&&(a=a||!!Object(ti.a)(this.target,"document")||!!Object(ti.a)(this.target,"audio")||"messageMediaPhoto"===this.message.media._),o&&a}},{icon:"checkretract",text:"Chat.Poll.Unvote",onClick:this.onRetractVote,verify:()=>{var e;const t=null===(e=this.message.media)||void 0===e?void 0:e.poll;return t&&t.chosenIndexes.length&&!t.pFlags.closed&&!t.pFlags.quiz}},{icon:"stop",text:"Chat.Poll.Stop",onClick:this.onStopPoll,verify:()=>{var e;const t=null===(e=this.message.media)||void 0===e?void 0:e.poll;return this.appMessagesManager.canEditMessage(this.message,"poll")&&t&&!t.pFlags.closed&&!this.message.pFlags.is_outgoing}},{icon:"forward",text:"Forward",onClick:()=>this.onForwardClick("quote"),verify:()=>!(this.noForwards||"scheduled"===this.chat.type||this.message.pFlags.is_outgoing&&this.message.pFlags.out||"messageService"===this.message._)},{icon:"forward-no-quote",text:"Eitaa.ForwardNoQuote",onClick:()=>this.onForwardClick("no-quote"),verify:()=>!this.noForwards&&"scheduled"!==this.chat.type&&!this.message.pFlags.is_outgoing&&"messageService"!==this.message._&&this.appMessagesManager.canForwardMessage(this.message)},{icon:"forward",text:"Message.Context.Selection.Forward",onClick:()=>this.onForwardClick("quote"),verify:()=>this.chat.selection.selectionForwardBtn&&this.isSelected&&!this.chat.selection.selectionForwardBtn.hasAttribute("disabled")&&this.appMessagesManager.canForwardMessage(this.message),notDirect:()=>!0,withSelection:!0},{icon:"forward-no-quote",text:"Message.Context.Selection.ForwardNoQuote",onClick:()=>this.onForwardClick("no-quote"),verify:()=>!this.noForwards&&this.chat.selection.selectionForwardBtn&&this.isSelected&&!this.chat.selection.selectionForwardBtn.hasAttribute("disabled")&&this.appMessagesManager.canForwardMessage(this.message),notDirect:()=>!0,withSelection:!0},{icon:"gifs",text:"SaveGif",onClick:()=>{var e;const t=null===(e=this.message.media)||void 0===e?void 0:e.document;this.appDocsManager.saveGif(t)},verify:()=>{var e;if(this.noForwards)return!1;const t=null===(e=this.message.media)||void 0===e?void 0:e.document;return"gif"===(null==t?void 0:t.type)&&!this.appDocsManager.isSavedGif(t)}},{icon:"flag",text:"ReportChat",onClick:()=>{new yl(this.peerId,[this.mid])},verify:()=>!this.message.pFlags.out&&"message"===this.message._&&!this.message.pFlags.is_outgoing&&this.appPeersManager.isChannel(this.peerId),notDirect:()=>!0,withSelection:!0},{icon:"select",text:"Message.Context.Select",onClick:this.onSelectClick,verify:()=>!this.message.action&&!this.isSelected&&this.isSelectable,notDirect:()=>!0,withSelection:!0},{icon:"select",text:"Message.Context.Selection.Clear",onClick:this.onClearSelectionClick,verify:()=>this.isSelected,notDirect:()=>!0,withSelection:!0},{icon:"delete danger",text:"Delete",onClick:this.onDeleteClick,verify:()=>this.appMessagesManager.canDeleteMessage(this.message)},{icon:"delete danger",text:"Message.Context.Selection.Delete",onClick:this.onDeleteClick,verify:()=>this.isSelected&&!this.chat.selection.selectionDeleteBtn.hasAttribute("disabled"),notDirect:()=>!0,withSelection:!0}],this.element=Mi(this.buttons,this.chat.bubbles.listenerSetter),this.element.id="bubble-contextmenu",this.element.classList.add("contextmenu"),this.chat.container.append(this.element)}}var Sl=s(206),Il=s.n(Sl);class Ml{constructor(e){this.sendMenuButtons=[{icon:"mute",text:"Chat.Send.WithoutSound",onClick:e.onSilentClick,verify:()=>"schedule"===this.type},{icon:"schedule",text:"Chat.Send.ScheduledMessage",onClick:e.onScheduleClick,verify:()=>"schedule"===this.type},{icon:"schedule",text:"Chat.Send.SetReminder",onClick:e.onScheduleClick,verify:()=>"reminder"===this.type}],this.sendMenu=Mi(this.sendMenuButtons,e.listenerSetter),this.sendMenu.classList.add("menu-send",e.openSide),Object(hi.a)(e.onContextElement,t=>{e.onOpen&&e.onOpen()},e.listenerSetter)}setPeerId(e){this.type=e===H.default.myId?"reminder":"schedule"}}var Cl=s(180);function Pl(e){const t=e.src;return fetch(t).then(e=>e.arrayBuffer()).then(e=>{const t=new Uint8Array(e);let s=0;for(let e=0,i=t.length;e<i;++e)if(33==t[e]&&249==t[e+1]&&4==t[e+2]&&0==t[e+7]){const i=t[e+5]<<8|255&t[e+4];s+=i<2?10:i}return s/1e3})}let Ll;function El(){return Ll}class _l extends ni{constructor(e,t,s){if(super("popup-send-photo popup-new-media",null,{closable:!0,withConfirm:"Modal.Send",confirmShortcutIsSendShortcut:!0,body:!0}),this.chat=e,this.files=t,this.onKeyDown=e=>{const t=e.target;if(t!==this.input){if("INPUT"===t.tagName||t.hasAttribute("contenteditable"))return;this.input.focus(),Object(Cl.a)(this.input)}},this.attachFile=e=>{const t=this.willAttach,s=this.shouldCompress(e.type),i={};i.file=e;const n=document.createElement("div");n.classList.add("popup-item"),i.itemDiv=n;const a=s?this.attachMedia(e,i,n):this.attachDocument(e,i,n);return t.sendFileDetails.push(i),a},this.willAttach={type:s,sendFileDetails:[],group:!1},Object(v.b)(this.btnConfirm,()=>this.send(),{listenerSetter:this.listenerSetter}),"scheduled"!==this.chat.type){const e=new Ml({onSilentClick:()=>{this.chat.input.sendSilent=!0,this.send()},onScheduleClick:()=>{this.chat.input.scheduleSending(()=>{this.send()})},openSide:"bottom-left",onContextElement:this.btnConfirm,listenerSetter:this.listenerSetter});e.setPeerId(this.chat.peerId),this.header.append(e.sendMenu)}this.mediaContainer=document.createElement("div"),this.mediaContainer.classList.add("popup-photo");const i=new re.b(null);i.container.append(this.mediaContainer),this.inputField=new Ws.b({placeholder:"PreviewSender.CaptionPlaceholder",label:"Caption",name:"photo-caption",maxLength:H.default.config.caption_length_max}),this.input=this.inputField.input,this.inputField.value=this.wasInputValue=this.chat.input.messageInputField.input.innerHTML,this.chat.input.messageInputField.value="",this.body.append(i.container),this.container.append(this.inputField.container),this.attachFiles(),this.addEventListener("close",()=>{this.files=[],Ll=void 0}),Ll=this}appendDrops(e){this.body.append(e)}get type(){return this.willAttach.type}set type(e){this.willAttach.type=e}appendGroupCheckboxField(){var e;const t=this.files.length>1;t&&!this.groupCheckboxField?(this.groupCheckboxField=new Gi.a({text:"PreviewSender.GroupItems",name:"group-items"}),this.container.append(...[this.groupCheckboxField.label,null===(e=this.mediaCheckboxField)||void 0===e?void 0:e.label,this.inputField.container].filter(Boolean)),this.willAttach.group=!0,this.groupCheckboxField.setValueSilently(this.willAttach.group),this.listenerSetter.add(this.groupCheckboxField.input)("change",()=>{const e=this.groupCheckboxField.checked;this.willAttach.group=e,this.attachFiles()})):this.groupCheckboxField&&this.groupCheckboxField.label.classList.toggle("hide",!t)}appendMediaCheckboxField(){var e;const t=!!this.files.find(e=>Bs.has(e.type));t&&!this.mediaCheckboxField?(this.mediaCheckboxField=new Gi.a({text:"PreviewSender.CompressFile",name:"compress-items"}),this.container.append(...[null===(e=this.groupCheckboxField)||void 0===e?void 0:e.label,this.mediaCheckboxField.label,this.inputField.container].filter(Boolean)),this.mediaCheckboxField.setValueSilently("media"===this.willAttach.type),this.listenerSetter.add(this.mediaCheckboxField.input)("change",()=>{const e=this.mediaCheckboxField.checked;this.willAttach.type=e?"media":"document",this.attachFiles()})):this.mediaCheckboxField&&this.mediaCheckboxField.label.classList.toggle("hide",!t)}addFiles(e){const t=e.filter(e=>!this.files.find(t=>t.lastModified===e.lastModified&&t.name===e.name&&t.size===e.size));t.length&&(this.files.push(...t),this.attachFiles())}send(e=!1){if("scheduled"===this.chat.type&&!e)return void this.chat.input.scheduleSending(()=>{this.send(!0)});let t=this.inputField.value;if(t.length>H.default.config.caption_length_max)return void Qt(O.default.format("Error.PreviewSender.CaptionTooLong",!0));this.hide();const s=this.willAttach;s.isMedia="media"===s.type||void 0;const{sendFileDetails:i,isMedia:n}=s,{peerId:a,input:o}=this.chat,{sendSilent:r,scheduleDate:l}=o;i.forEach(e=>{e.itemDiv=void 0});const{length:d}=i,c=o.replyToMsgId;this.iterate(e=>{t&&e.length!==d&&(this.chat.appMessagesManager.sendText(a,t,{replyToMsgId:c,threadId:this.chat.threadId,silent:r,scheduleDate:l,clearDraft:!0}),t=void 0);const i=Object.assign(Object.assign({},s),{sendFileDetails:e});this.chat.appMessagesManager.sendAlbum(a,i.sendFileDetails.map(e=>e.file),Object.assign({caption:t,replyToMsgId:c,threadId:this.chat.threadId,isMedia:n,silent:r,scheduleDate:l,clearDraft:!0},i)),t=void 0}),o.replyToMsgId=this.chat.threadId,o.onMessageSent()}attachMedia(e,t,s){s.classList.add("popup-item-media");let i;if(e.type.startsWith("video/")){const n=document.createElement("video"),a=document.createElement("source");a.src=t.objectURL=URL.createObjectURL(e),n.autoplay=!0,n.controls=!1,n.muted=!0,n.setAttribute("playsinline","true"),n.addEventListener("timeupdate",()=>{n.pause()},{once:!0}),i=k(n).then(()=>{t.width=n.videoWidth,t.height=n.videoHeight,t.duration=Math.floor(n.duration);const e=n.webkitAudioDecodedByteCount;return void 0!==e&&(t.noSound=!e),s.append(n),E(n).then(e=>{t.thumb=Object.assign({url:URL.createObjectURL(e.blob)},e)})}),n.append(a)}else{const n=new Image;i=new Promise(i=>{n.onload=()=>{t.width=n.naturalWidth,t.height=n.naturalHeight,s.append(n),"image/gif"===e.type?(t.noSound=!0,Promise.all([Pl(n).then(e=>{t.duration=Math.ceil(e)}),L(n).then(e=>{t.thumb=Object.assign({url:URL.createObjectURL(e.blob)},e)})]).then(()=>{i()})):i()}}),n.src=t.objectURL=URL.createObjectURL(e)}return i}attachDocument(e,t,s){s.classList.add("popup-item-document");const i=e.type.startsWith("image/"),n=e.type.startsWith("audio/");(i||n)&&(t.objectURL=URL.createObjectURL(e));const a={_:"document",file:e,file_name:e.name||"",fileName:e.name?N.b.wrapEmojiText(e.name):"",size:e.size,type:i?"photo":"doc"},o=st.getCacheContext(a);o.url=t.objectURL,o.downloaded=e.size;const r=Aa({message:{_:"message",pFlags:{is_outgoing:!0},mid:0,peerId:0,media:{_:"messageMediaDocument",document:a}}});return new Promise(e=>{const n=()=>{s.append(r),e()};if(i){const e=new Image;e.src=t.objectURL,e.onload=()=>{t.width=e.naturalWidth,t.height=e.naturalHeight,n()},e.onerror=n}else n()})}shouldCompress(e){return"media"===this.willAttach.type&&Bs.has(e)}onRender(){this.element.classList.contains("active")||(this.listenerSetter.add(document.body)("keydown",this.onKeyDown),this.addEventListener("close",()=>{this.wasInputValue&&(this.chat.input.messageInputField.value=this.wasInputValue)}),this.show())}setTitle(){const{willAttach:e,title:t,files:s}=this;let i;const n=[];if("document"===e.type)i="PreviewSender.SendFile",n.push(s.length);else{let e=0,t=0,a=0;s.forEach(s=>{s.type.startsWith("image/")?++e:s.type.startsWith("video/")?++t:++a}),[e,t,a].filter(e=>e>0).length>1?(i="PreviewSender.SendFile",n.push(s.length)):e?(i="PreviewSender.SendPhoto",n.push(e)):t&&(i="PreviewSender.SendVideo",n.push(t))}Object(le.a)(t,Object(O.i18n)(i,n))}appendMediaToContainer(e,t){if(this.shouldCompress(t.file.type)){const s=Object(gt.a)(t.width,t.height,380,320);e.style.width=s.width+"px",e.style.height=s.height+"px"}this.mediaContainer.append(e)}iterate(e){const{sendFileDetails:t}=this.willAttach;if(!this.willAttach.group)return void t.forEach(t=>e([t]));const s=t.length;for(let i=0;i<s;){const n=t[i].file.type;let a=0;for(;a<10&&i<s;++i,++a){const e=t[i].file.type;if(this.shouldCompress(n)!==this.shouldCompress(e))break}e(t.slice(i-a,i))}}attachFiles(){const{files:e,willAttach:t,mediaContainer:s}=this;t.sendFileDetails.length=0,this.appendGroupCheckboxField(),this.appendMediaCheckboxField(),Promise.all(e.map(this.attachFile)).then(()=>{s.innerHTML="",e.length&&(this.setTitle(),this.iterate(e=>{if(this.shouldCompress(e[0].file.type)&&e.length>1){const t=document.createElement("div");t.classList.add("popup-item-album","popup-item"),t.append(...e.map(e=>e.itemDiv)),Ra({container:t,items:e.map(e=>({w:e.width,h:e.height})),maxWidth:380,minWidth:100,spacing:4}),s.append(t)}else e.forEach(e=>{this.appendMediaToContainer(e.itemDiv,e)})}))}).then(()=>{this.onRender()})}}const kl=["ArrowUp","ArrowDown"],Tl=["ArrowLeft","ArrowRight"];function xl({list:e,type:t,onSelect:s,once:i,waitForKey:n}){const a=new Set("xy"===t?kl.concat(Tl):"x"===t?Tl:kl);let o;const r=()=>o||e.querySelector(".active")||e.firstElementChild,l=(e,s)=>{if(o===e)return;let i=!1;o&&(i=!0,o.classList.remove("active")),o=e,o&&(o.classList.add("active"),i&&u&&s&&Object(rn.b)(u,o,"center",void 0,void 0,void 0,100,"x"===t?"x":"y"))},d=(t,s)=>{let i;return i=s?t.nextElementSibling||e.firstElementChild:t.previousElementSibling||e.lastElementChild,i};let c;c="xy"===t?(t,s)=>"ArrowUp"===s||"ArrowDown"===s?((t,s)=>{const i=s?"nextElementSibling":"previousElementSibling",n=s?"firstElementChild":"lastElementChild",a=t.getBoundingClientRect();let o=t[i]||e[n];for(;o!==t;){const t=o.getBoundingClientRect();if(t.x===a.x&&t.y!==a.y)break;o=o[i]||e[n]}return o})(t,"ArrowDown"===s):d(t,"ArrowRight"===s):(e,t)=>d(e,"ArrowRight"===t||"ArrowDown"===t);let h=s=>{const i=s.key;if(a.has(i)){if(Object(f.a)(s),e.childElementCount>1){let e=r();e=c(e,i),l(e,!0)}}else("Enter"===i||"xy"!==t&&"Tab"===i)&&(Object(f.a)(s),m(r()))};const u=Object(ti.a)(e,"scrollable");e.classList.add("navigable-list");const p=t=>{const s=Object(zt.a)(t.target,e);s&&l(s,!1)},g=t=>{Object(f.a)(t);const s=Object(zt.a)(t.target,e);s&&(l(s,!1),m(r()))},m=e=>{const t=s(e);(void 0!==t?!t:i)&&b()},b=()=>{document.removeEventListener("keydown",h,{capture:!0}),e.removeEventListener("mousemove",p),Object(v.c)(e,g)},y=()=>{n||l(e.firstElementChild,!1)};if(n){const e=h;h=t=>{t.key===n&&(Object(f.a)(t),document.removeEventListener("keydown",h,{capture:!0}),h=e,document.addEventListener("keydown",h,{capture:!0,passive:!1}),n=void 0,y())}}else y();return document.addEventListener("keydown",h,{capture:!0,passive:!1}),e.addEventListener("mousemove",p,{passive:!0}),Object(v.b)(e,g),{detach:b,resetTarget:y}}class Al extends Mt.a{constructor(e){super(!1),this.hidden=!0,this.onVisible=()=>{this.detach&&this.detach();const e=this.list,{detach:t,resetTarget:s}=xl({list:e,type:this.listType,onSelect:this.onSelect,once:!0,waitForKey:this.waitForKey});this.detach=t,this.resetTarget=s,C.IS_MOBILE||this.navigationItem||(this.navigationItem={type:"autocomplete-helper",onPop:()=>{this.navigationItem=void 0,this.toggle(!0)},noBlurOnPop:!0},Nt.a.pushItem(this.navigationItem)),this.addEventListener("hidden",()=>{this.resetTarget=void 0,this.detach=void 0,e.innerHTML="",t(),this.navigationItem&&(Nt.a.removeItem(this.navigationItem),this.navigationItem=void 0)},{once:!0})},Object(m.g)(this,e),this.container=document.createElement("div"),this.container.classList.add("autocomplete-helper","z-depth-1"),e.appendTo.append(this.container),this.attachNavigation(),this.controller.addHelper(this)}attachNavigation(){this.addEventListener("visible",this.onVisible)}toggle(e,t=!1){this.init||(void 0===e&&(e=this.container.classList.contains("is-visible")&&!this.container.classList.contains("backwards")),this.hidden!==e?(this.hidden=e,e?(this.navigationItem&&(Nt.a.removeItem(this.navigationItem),this.navigationItem=void 0),t||this.controller.hideOtherHelpers(),this.detach&&this.detach()):(this.controller.hideOtherHelpers(this),this.dispatchEvent("visible")),Object(p.a)(this.container,"is-visible",!e,H.default.settings.animationsEnabled?200:0,()=>{this.hidden&&this.dispatchEvent("hidden")})):e||this.dispatchEvent("visible"))}}class Ol extends Al{constructor(e,t){super({appendTo:e,controller:t,listType:"xy",onSelect:e=>!ol.onMediaClick({target:e},!0),waitForKey:"ArrowUp"}),this.container.classList.add("stickers-helper"),this.addEventListener("visible",()=>{setTimeout(()=>{this.scrollable.container.scrollTop=0},0),H.default.dispatchEvent("choosing_sticker",!0)}),this.addEventListener("hidden",()=>{this.onChangeScreen&&(I.b.removeEventListener("changeScreen",this.onChangeScreen),this.onChangeScreen=void 0),H.default.dispatchEvent("choosing_sticker",!1)})}checkEmoticon(e){const t=this.controller.getMiddleware();this.lazyLoadQueue&&this.lazyLoadQueue.clear(),Ea.preloadAnimatedEmojiSticker(e),Ea.getStickersByEmoticon(e).then(e=>{if(!t())return;this.init&&(this.init(),this.init=null);const s=this.list.cloneNode();let i;this.lazyLoadQueue.clear(),i=e.length?new Promise(t=>{const i=[];e.forEach(e=>{s.append(this.superStickerRenderer.renderSticker(e,void 0,i))}),Promise.all(i).finally(t)}):Promise.resolve(),i.then(()=>{this.list.replaceWith(s),this.list=s,this.onChangeScreen||(this.onChangeScreen=()=>{const e=this.list.childElementCount*I.b.active.esgSticker.width+(this.list.childElementCount-1);this.list.style.width=e+"px"},I.b.addEventListener("changeScreen",this.onChangeScreen)),this.onChangeScreen(),this.toggle(!e.length),this.scrollable.scrollTop=0})})}init(){this.list=document.createElement("div"),this.list.classList.add("stickers-helper-stickers","super-stickers"),this.container.append(this.list),this.scrollable=new re.b(this.container),this.lazyLoadQueue=new c,this.superStickerRenderer=new Qr(this.lazyLoadQueue,Sd)}}const Fl=()=>{const e=new Date;return e.setHours(0,0,0,0),e},Dl=()=>{const e=new Date;return e.setFullYear(e.getFullYear()+1),e.setDate(e.getDate()-1),e};class jl extends Pr{constructor(e,t,s){var i;if(super((i=e).getTime()>Dl().getTime()?new Date:i,t,{noButtons:!0,noTitle:!0,closable:!0,withConfirm:!0,minDate:Fl(),maxDate:Dl(),withTime:!0,showOverflowMonths:!0,confirmShortcutIsSendShortcut:!0}),this.element.classList.add("popup-schedule"),this.header.append(this.controlsDiv),this.title.replaceWith(this.monthTitle),this.body.append(this.btnConfirm),s){const e=Object(Ks.a)("btn-primary btn-secondary btn-primary-transparent primary",{text:"Schedule.SendWhenOnline"});this.body.append(e),Object(v.b)(e,()=>{t(2147483646),this.hide()})}}}var Rl=s(150),Bl=s(164),Ul=s(159);function Nl(e,t=!0){const s=[],i=[],n=window.getSelection();let a,o;if(n&&n.rangeCount){const t=n.getRangeAt(0),s=t.startOffset;if(t.startContainer&&t.startContainer==t.endContainer&&s==t.endOffset){const i=s-1,n=e.childNodes;if(t.startContainer===e&&n[i]){a=n[i],o=0;for(let e=0;e<t.endOffset;++e){const t=n[e],s=t.nodeValue||t.alt;s&&(o+=s.length)}}else a=t.startContainer,o=s}}const r=t?[]:void 0;Object(Ul.a)(e,s,i,a,o,r),i.length&&s.push(i.join(""));let l=s.join("\n");const d=l.indexOf("");return-1!=d&&(l=l.substr(0,d)+l.substr(d+1)),l=l.replace(/\u00A0/g," "),r&&N.b.combineSameEntities(r),{value:l,entities:r,caretPos:d}}class Hl extends Al{constructor(e,t,s,i){super({appendTo:e,controller:t,listType:"x",onSelect:e=>{s.onEmojiSelected(zr(e),!0)}}),this.appEmojiManager=i,this.container.classList.add("emoji-helper")}init(){this.list=document.createElement("div"),this.list.classList.add("emoji-helper-emojis","super-emojis"),this.container.append(this.list),this.scrollable=new re.a(this.container),this.addEventListener("visible",()=>{setTimeout(()=>{this.scrollable.container.scrollLeft=0},0)})}render(e,t){if(this.init){if(!e.length)return;this.init(),this.init=null}(e=e.slice(0,80)).length&&(this.list.innerHTML="",e.forEach(e=>{Hr(e,this.list,!1,!0)})),this.waitForKey=t?"ArrowUp":void 0,this.toggle(!e.length)}checkQuery(e,t){const s=this.controller.getMiddleware();this.appEmojiManager.getBothEmojiKeywords().then(()=>{if(!s())return;const i=e.replace(/^:/,""),n=this.appEmojiManager.searchEmojis(i);this.render(n,":"!==t)})}}class zl extends Al{constructor(e,t,s,i){super({appendTo:e,controller:t,listType:"y",onSelect:i}),this.className=s,this.container.classList.add(zl.BASE_CLASS,s)}init(){this.list=document.createElement("div"),this.list.classList.add(zl.BASE_CLASS+"-list"),this.container.append(this.list),this.scrollable=new re.b(this.container),this.addEventListener("visible",()=>{setTimeout(()=>{this.scrollable.container.scrollTop=0},0)})}render(e){if(this.init){if(!e.length)return;this.init(),this.init=null}e.length&&(this.list.innerHTML="",e.forEach(e=>{const t=zl.listElement({className:this.className,peerId:e.peerId,name:e.name,description:e.description});this.list.append(t)})),this.toggle(!e.length)}static listElement(e){const t=zl.BASE_CLASS_LIST_ELEMENT;e.className+="-list-element";const s=document.createElement("div");s.classList.add(t,e.className),s.dataset.peerId=""+e.peerId;const i=new Od;i.classList.add("avatar-30",t+"-avatar",e.className+"-avatar"),i.setAttribute("dialog","0"),i.setAttribute("peer",""+e.peerId);const n=document.createElement("div");if(n.classList.add(t+"-name",e.className+"-name"),e.name?Object(xe.a)(n,N.b.wrapEmojiText(e.name)):n.append(new Oe({peerId:e.peerId,dialog:!1,onlyFirstName:!1,plainText:!1}).element),s.append(i,n),e.description){const i=document.createElement("div");i.classList.add(t+"-description",e.className+"-description"),Object(xe.a)(i,N.b.wrapEmojiText(e.description)),s.append(i)}return s}}zl.BASE_CLASS="autocomplete-peer-helper",zl.BASE_CLASS_LIST_ELEMENT=zl.BASE_CLASS+"-list-element";class Wl extends zl{constructor(e,t,s,i,n){super(e,t,"commands-helper",e=>{const t=e.querySelector(`.${zl.BASE_CLASS_LIST_ELEMENT}-name`).innerHTML;return s.getReadyToSend(()=>{s.messageInput.innerHTML=t,s.sendMessage(!0)})}),this.appProfileManager=i,this.appUsersManager=n}checkQuery(e,t){if(!this.appUsersManager.isBot(t))return!1;const s=this.controller.getMiddleware();return this.appProfileManager.getProfileByPeerId(t).then(t=>{if(!s())return;const i=[].concat(t.bot_info),n=new $({ignoreCase:!0}),a=new Map;i.forEach(e=>{e.commands.forEach(t=>{const s="/"+t.command;a.set(t.command,{peerId:e.user_id.toPeerId(!1),name:s,description:t.description}),n.indexObject(t.command,s)})});const o=n.search(e),r=Array.from(o).map(e=>a.get(e));this.render(r)}),!0}}class ql{constructor(){this.helpers=new Set,this.middleware=Ke()}getMiddleware(){return this.middleware.clean(),this.middleware.get()}addHelper(e){this.helpers.add(e)}hideOtherHelpers(e){this.helpers.forEach(t=>{t!==e&&t.toggle(!0,!0)}),e||this.middleware.clean()}}class Vl extends zl{constructor(e,t,s,i,n){super(e,t,"mentions-helper",e=>{const t=n.getUser(e.dataset.peerId.toUserId());let i,a="";t.username?a="@"+t.username:(a=t.first_name||t.last_name,i={_:"messageEntityMentionName",length:a.length,offset:0,user_id:t.id}),a+=" ",s.insertAtCaret(a,i)}),this.appProfileManager=i,this.appUsersManager=n}checkQuery(e,t,s){const i=e.trim();if(e.length!==i.length)return!1;const n=this.controller.getMiddleware();return this.appProfileManager.getMentions(t&&t.toChatId(),i,s).then(e=>{if(!n())return;const t=i.slice(1).toLowerCase();this.render(e.map(e=>{const s=this.appUsersManager.getUser(e);if(!s.username||s.username.toLowerCase()!==t)return{peerId:e,description:s.username?"@"+s.username:void 0}}).filter(Boolean))}),!0}}var Gl=s(76);class Kl extends il{constructor(e){super({element:document.createElement("div")}),this.onBodyTouchStart=e=>{const t=e.touches[0].target;Object(zt.a)(t,this.element)||t===this.btnHover||(Object(f.a)(e),this.toggle(!1))},Object(m.g)(this,e),this.element.classList.add(Kl.BASE_CLASS),this.element.style.display="none",this.attachButtonListener(this.btnHover,this.listenerSetter),this.listenerSetter.add(H.default)("history_reply_markup",({peerId:e})=>{this.peerId===e&&(this.checkAvailability()&&this.isActive()&&this.render(),Object(it.c)().then(()=>{this.checkForceReply()}))})}init(){return this.appendTo.append(this.element),this.listenerSetter.add(this)("open",()=>{this.render(),Ht.IS_TOUCH_SUPPORTED&&(this.touchListener=this.listenerSetter.add(document.body)("touchstart",this.onBodyTouchStart,{passive:!1,capture:!0}),this.listenerSetter.add(this)("close",()=>{this.listenerSetter.remove(this.touchListener)},{once:!0}))}),this.listenerSetter.add(this.element)("click",e=>{const t=Object(ti.a)(e.target,"btn");t&&(this.appMessagesManager.sendText(this.peerId,t.dataset.text),this.toggle(!1))}),super.init()}checkForceReply(){const e=this.getReplyMarkup();"replyKeyboardForceReply"!==e._||e.pFlags.hidden||e.pFlags.used||(e.pFlags.used=!0,this.chatInput.initMessageReply(e.mid))}getReplyMarkup(){var e;return null!==(e=this.appMessagesManager.getHistoryStorage(this.peerId).replyMarkup)&&void 0!==e?e:{_:"replyKeyboardHide"}}render(e=this.getReplyMarkup()){this.element.innerHTML="";for(const t of e.rows){const e=document.createElement("div");e.classList.add(Kl.BASE_CLASS+"-row");for(const s of t.buttons){const t=document.createElement("button");t.classList.add(Kl.BASE_CLASS+"-button","btn"),Object(xe.a)(t,N.b.wrapEmojiText(s.text)),t.dataset.text=s.text,e.append(t)}this.element.append(e)}}checkAvailability(e=this.getReplyMarkup()){var t;const s="replyKeyboardHide"===e._||!(null===(t=e.rows)||void 0===t?void 0:t.length);return this.btnHover.classList.toggle("hide",s),s&&this.toggle(!1),!s}setPeer(e){this.peerId=e,this.checkAvailability(),this.checkForceReply()}}Kl.BASE_CLASS="reply-keyboard";var Ql=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class $l extends Al{constructor(e,t,s,i,n){super({appendTo:e,controller:t,listType:"xy",onSelect:e=>{const{peerId:t,botId:s,queryId:i}=this.list.dataset;return this.chat.input.getReadyToSend(()=>{const n=this.appInlineBotsManager.generateQId(i,e.dataset.resultId);this.appInlineBotsManager.sendInlineResult(t.toPeerId(),s,n,{clearDraft:!0,scheduleDate:this.chat.input.scheduleDate,silent:this.chat.input.sendSilent,replyToMsgId:this.chat.input.replyToMsgId}),this.chat.input.onMessageSent(!0,!0)})}}),this.chat=s,this.appUsersManager=i,this.appInlineBotsManager=n,this._checkQuery=(e,t,s)=>Ql(this,void 0,void 0,(function*(){const i=this.controller.getMiddleware(),n=yield this.appUsersManager.resolveUsername(t);if(!i())throw"PEER_CHANGED";if("user"!==n._)throw"NOT_A_BOT";const a=this.appInlineBotsManager.getInlineResults(e,n.id,s).then(t=>{var s;if(!i())throw"PEER_CHANGED";this.init&&(this.init(),this.init=null);const a=this.list.cloneNode();a.dataset.peerId=""+e,a.dataset.botId=""+n.id,a.dataset.queryId=""+t.query_id;const o=new Vr(null,"INLINE-HELPER",this.scrollable,!1);this.lazyLoadQueue.clear(),this.superStickerRenderer.clear();const r=[],l=!!t.pFlags.gallery;for(const e of t.results){const t=document.createElement("div");t.classList.add("inline-helper-result"),t.dataset.resultId=e.id;const n=l?void 0:document.createElement("div");if(n&&(n.classList.add("inline-helper-result-preview"),t.append(n)),a.append(t),l)t.classList.add("grid-item");else{n.classList.add("empty"),Object(xe.a)(n,N.b.wrapEmojiText([...e.title.trim()][0]));const s=document.createElement("div");s.classList.add("inline-helper-result-title"),Object(xe.a)(s,N.b.wrapEmojiText(e.title));const i=document.createElement("div");i.classList.add("inline-helper-result-description"),Object(xe.a)(i,N.b.wrapRichText(e.description,{noCommands:!0,noLinks:!0})),t.append(s,i);const o=document.createElement("div");o.classList.add("inline-helper-separator"),a.append(o)}if("botInlineResult"===e._){if(e.thumb&&0===e.thumb.mime_type.indexOf("image/")){let s;n?(s=document.createElement("div"),n.append(s)):s=t,s.classList.add("media-container"),l&&s.classList.add("no-border-radius"),this.lazyLoadQueue.push({div:t,load:()=>st.download({dcId:4,location:{_:"inputWebFileLocation",access_hash:e.thumb.access_hash,url:e.thumb.url},size:e.thumb.size,mimeType:e.thumb.mime_type}).then(e=>{const t=new Image;t.classList.add("media-photo"),Object(vt.c)(e).then(e=>{Fa(s,t,e,!0)})})})}}else{const a=e.document||e.photo;if(["sticker","gif"].includes(null===(s=a)||void 0===s?void 0:s.type)&&l)"gif"===a.type?o.add(a,t):"sticker"===a.type&&(t.classList.add("super-sticker"),this.superStickerRenderer.renderSticker(a,t,r),2===a.sticker&&this.superStickerRenderer.observeAnimatedDiv(t));else if(a){const e=l?48:void 0;l&&t.classList.add("no-border-radius"),Oa({photo:a,container:l?t:n,boxWidth:e,boxHeight:e,middleware:i,lazyLoadQueue:this.lazyLoadQueue,loadPromises:r})}}}return Promise.all(r).then(()=>{if(!i())return void o.clear();a.classList.toggle("is-gallery",l),a.classList.toggle("super-stickers",l),this.container.classList.toggle("is-gallery",l);const s=this.list.parentElement;if(s.textContent="",t.switch_pm){const i=Object(Ks.a)("btn-primary btn-secondary btn-primary-transparent primary");Object(xe.a)(i,N.b.wrapEmojiText(t.switch_pm.text)),Object(v.b)(i,s=>{this.appInlineBotsManager.switchToPM(e,n.id,t.switch_pm.start_param)}),s.append(i)}s.append(this.list=a),this.gifsMasonry&&this.gifsMasonry.detach(),this.gifsMasonry=o,o.attach(),this.onChangeScreen||(this.onChangeScreen=()=>{if(this.list.classList.contains("is-gallery")){const e=this.list.childElementCount*I.b.active.esgSticker.width+(this.list.childElementCount-1);this.list.style.width=e+"px"}else this.list.style.width=""},I.b.addEventListener("changeScreen",this.onChangeScreen)),this.onChangeScreen(),this.toggle(!t.results.length&&!t.switch_pm),this.scrollable.scrollTop=0})});return{user:n,renderPromise:a}})),this.container.classList.add("inline-helper"),this.addEventListener("visible",()=>{setTimeout(()=>{this.scrollable.container.scrollTop=0},0)}),this.checkQuery=Zi(this._checkQuery,200,!0,!0),this.addEventListener("hidden",()=>{this.onChangeScreen&&(I.b.removeEventListener("changeScreen",this.onChangeScreen),this.onChangeScreen=void 0)})}init(){this.list=document.createElement("div"),this.list.classList.add("inline-helper-results"),this.container.append(this.list),this.scrollable=new re.b(this.container),this.lazyLoadQueue=new c,this.superStickerRenderer=new Qr(this.lazyLoadQueue,"INLINE-HELPER")}}var Yl=s(75);class Xl{constructor(e,t,s,i,n,a,o,r,l,d,c,h,u,p){this.chat=e,this.appMessagesManager=t,this.appMessagesIdsManager=s,this.appDocsManager=i,this.appChatsManager=n,this.appPeersManager=a,this.appWebPagesManager=o,this.appImManager=r,this.appDraftsManager=l,this.serverTimeManager=d,this.appNotificationsManager=c,this.appEmojiManager=h,this.appUsersManager=u,this.appInlineBotsManager=p,this.lastUrl="",this.lastTimeType=0,this.replyElements={},this.willSendWebPage=null,this.recording=!1,this.recordCanceled=!1,this.recordStartTime=0,this.lockRedo=!1,this.canRedoFromHTML="",this.undoHistory=[],this.executedHistory=[],this.canUndoFromHTML="",this.forwardType="quote",this.onCancelRecordClick=e=>{e&&Object(f.a)(e),this.recordCanceled=!0,this.recorder.stop(),Ut.setKeepAlive(!1)},this.onEmoticonsOpen=()=>{const e=Ht.IS_TOUCH_SUPPORTED?"flip-icon":"active";this.btnToggleEmoticons.classList.toggle(e,!0)},this.onEmoticonsClose=()=>{const e=Ht.IS_TOUCH_SUPPORTED?"flip-icon":"active";this.btnToggleEmoticons.classList.toggle(e,!1)},this.scheduleSending=(e=this.sendMessage.bind(this,!0),t=new Date)=>{const{peerId:s}=this.chat,i=this.chat.bubbles.getMiddleware(),n=H.default.myId!==s&&s.isUser()&&this.appUsersManager.isUserOnlineVisible(s);new jl(t,t=>{if(!i())return;t<=10+(Date.now()/1e3|0)&&(t=void 0),this.scheduleDate=t,e(),"scheduled"!==this.chat.type&&t&&setTimeout(()=>{i()&&this.appImManager.openScheduled(s)},0)},n).show()},this.prepareDocumentExecute=()=>(this.executedHistory.push(this.messageInput.innerHTML),()=>this.canUndoFromHTML=this.messageInput.innerHTML),this.undoRedo=(e,t,s)=>{Object(f.a)(e);let i=this.messageInput.innerHTML;if(i&&i!==s){this.lockRedo=!0;let e=0;do{document.execCommand(t,!1,null);const s=this.messageInput.innerHTML;if(i===s){if(++e>2)break}else e=0;i=s}while(i!==s);this.lockRedo=!1}},this.handleMarkdownShortcut=e=>{const t={KeyB:"bold",KeyI:"italic",KeyM:"monospace"};this.appImManager.markupTooltip&&(t.KeyK="link");const s=e.code,i=t[s];if(document.getSelection().toString().trim().length&&i&&("KeyK"===s?this.appImManager.markupTooltip.showLinkEditor():this.applyMarkdown(i),Object(f.a)(e)),"KeyZ"===s){let t=this.messageInput.innerHTML;e.shiftKey?this.undoHistory.length&&(this.executedHistory.push(t),t=this.undoHistory.pop(),this.undoRedo(e,"redo",t),t=this.messageInput.innerHTML,this.canRedoFromHTML=this.undoHistory.length?t:"",this.canUndoFromHTML=t):!this.executedHistory.length||this.canUndoFromHTML&&t!==this.canUndoFromHTML||(this.undoHistory.push(t),t=this.executedHistory.pop(),this.undoRedo(e,"undo",t),this.canUndoFromHTML=this.canRedoFromHTML=this.messageInput.innerHTML)}},this.onMessageInput=e=>{var t;const{value:s,entities:i,caretPos:n}=Nl(this.messageInputField.input),a=N.b.parseMarkdown(s,i,!0),o=N.b.mergeEntities(i,N.b.parseEntities(a));this.canRedoFromHTML&&!this.lockRedo&&this.messageInput.innerHTML!==this.canRedoFromHTML&&(this.canRedoFromHTML="",this.undoHistory.length=0);const r=!(null===(t=this.editMessage)||void 0===t?void 0:t.media)&&o.filter(e=>"messageEntityUrl"===e._||"messageEntityTextUrl"===e._);if(r.length)for(const e of r){let t;if("messageEntityTextUrl"===e._)t=e.url;else if(t=s.slice(e.offset,e.offset+e.length),!t.includes("http://")&&!t.includes("https://"))continue;if(this.lastUrl!==t){this.lastUrl=t;const e=this.getWebPagePromise=F.a.invokeApiHashable("messages.getWebPage",{url:t}).then(s=>{s=this.appWebPagesManager.saveWebPage(s),this.getWebPagePromise===e&&(this.getWebPagePromise=void 0),this.lastUrl===t&&("webPage"===s._?(this.setTopInfo("webpage",()=>{},s.site_name||s.title||"Webpage",s.description||s.url||""),delete this.noWebPage,this.willSendWebPage=s):this.willSendWebPage&&this.onHelperCancel())})}break}else this.lastUrl&&(this.lastUrl="",delete this.noWebPage,this.willSendWebPage=null,this.helperType?this.helperFunc():this.clearHelper());if(s.trim()){const e=Date.now();e-this.lastTimeType>=6e3&&(this.lastTimeType=e,this.appMessagesManager.setTyping(this.chat.peerId,{_:"sendMessageTypingAction"}))}else this.lastTimeType&&this.appMessagesManager.setTyping(this.chat.peerId,{_:"sendMessageCancelAction"}),this.appImManager.markupTooltip&&this.appImManager.markupTooltip.hide();this.editMsgId||this.saveDraftDebounced(),this.checkAutocomplete(s,n,o),this.updateSendBtn()},this.onEmojiSelected=(e,t)=>{this.insertAtCaret(e,N.b.getEmojiEntityFromEmoji(e),t)},this.onBtnSendClick=e=>{if(Object(f.a)(e),!this.recorder||this.recording||!this.isInputEmpty()||this.forwarding||this.editMsgId)this.recording?Date.now()-this.recordStartTime<500?this.onCancelRecordClick():this.recorder.stop():this.sendMessage();else{if(this.chat.peerId.isAnyChat()&&!this.appMessagesManager.canSendToPeer(this.chat.peerId,this.chat.threadId,"send_media"))return void Qt("Posting media content isn't allowed in this group.");this.chatInput.classList.add("is-locked"),Object(si.a)(),this.recorder.start().then(()=>{this.releaseMediaPlayback=yi.setSingleMedia(),this.recordCanceled=!1,this.chatInput.classList.add("is-recording"),this.recording=!0,this.updateSendBtn(),Ut.setKeepAlive(!0);const e=()=>{new en("popup-cancel-record",{titleLangKey:"DiscardVoiceMessageTitle",descriptionLangKey:"DiscardVoiceMessageDescription",buttons:[{langKey:"DiscardVoiceMessageAction",callback:()=>{Object(v.e)(this.btnCancelRecord)}},{langKey:"Continue",isCancel:!0}]}).show()};this.recordingOverlayListener=this.listenerSetter.add(document.body)("mousedown",t=>{Object(ti.a)(t.target,"chat-input")||Object(ti.a)(t.target,"popup-cancel-record")||(Object(f.a)(t),e())},{capture:!0,passive:!1}),Nt.a.pushItem(this.recordingNavigationItem={type:"voice",onPop:()=>(setTimeout(()=>{e()},0),!1)}),this.recordStartTime=Date.now();const t=this.recorder.sourceNode,s=t.context.createAnalyser();t.connect(s),s.fftSize=32;const i=new Uint8Array(s.frequencyBinCount),n=255*i.length;let a=()=>{if(!this.recording)return;s.getByteFrequencyData(i);let e=0;i.forEach(t=>{e+=t});let t=Math.min(1,e/n+.36);this.recordRippleEl.style.transform=`scale(${t})`;let o=Date.now()-this.recordStartTime,r=o%1e3,l=(""+o/1e3).toHHMMSS()+","+("00"+Math.round(r/10)).slice(-2);this.recordTimeEl.innerText=l,Object(g.b)(a)};a()}).catch(e=>{switch(e.name){case"NotAllowedError":Qt(Object(O.i18n)("Eitaa.Input.Device.Microphone.AllowAccess").innerText);break;case"NotReadableError":Qt(e.message);break;default:console.error("Recorder start error:",e,e.name,e.message),Qt(Object(O.i18n)("Eitaa.Input.Device.NotFound").innerText)}this.chatInput.classList.remove("is-recording","is-locked")})}},this.onHelperCancel=(e,t)=>{if(e&&Object(f.a)(e),this.willSendWebPage){const e=this.lastUrl;let t=!1;if(this.helperType&&(this.helperFunc(),t=!0),this.lastUrl=e,this.noWebPage=!0,this.willSendWebPage=null,t)return}if("edit"===this.helperType&&!t){const e=this.editMessage,t=N.b.parseMarkdown(this.messageInputField.value,[]);if(e.message!==t)return void new en("discard-editing",{buttons:[{langKey:"Alert.Confirm.Discard",callback:()=>{this.onHelperCancel(void 0,!0)}}],descriptionLangKey:"Chat.Edit.Cancel.Text"}).show()}this.clearHelper(),this.updateSendBtn()},this.onHelperClick=e=>{if(Object(f.a)(e),Object(ti.a)(e.target,"reply"))if("forward"===this.helperType){const{forwardElements:e}=this;e&&Ht.IS_TOUCH_SUPPORTED&&!e.container.classList.contains("active")&&Object(hi.d)(e.container)}else"reply"===this.helperType?this.chat.setMessageId(this.replyToMsgId):"edit"===this.helperType&&this.chat.setMessageId(this.editMsgId)},this.listenerSetter=new Gs}construct(){this.chatInput=document.createElement("div"),this.chatInput.classList.add("chat-input"),this.chatInput.style.display="none",this.inputContainer=document.createElement("div"),this.inputContainer.classList.add("chat-input-container"),this.rowsWrapper=document.createElement("div"),this.rowsWrapper.classList.add("rows-wrapper","chat-input-wrapper");const e=gl();this.rowsWrapper.append(e);const t=this.fakeRowsWrapper=document.createElement("div");t.classList.add("fake-wrapper","fake-rows-wrapper");const s=document.createElement("div");s.classList.add("fake-wrapper","fake-selection-wrapper"),this.inputContainer.append(this.rowsWrapper,t,s),this.chatInput.append(this.inputContainer),this.goDownBtn=li({icon:"arrow_down",className:"bubbles-corner-button bubbles-go-down hide"}),this.inputContainer.append(this.goDownBtn),Object(v.b)(this.goDownBtn,e=>{Object(f.a)(e),this.chat.bubbles.onGoDownClick()},{listenerSetter:this.listenerSetter})}constructPeerHelpers(){this.replyElements.container=document.createElement("div"),this.replyElements.container.classList.add("reply-wrapper"),this.replyElements.iconBtn=Qs(""),this.replyElements.cancelBtn=Qs("close reply-cancel",{noRipple:!0}),this.replyElements.container.append(this.replyElements.iconBtn,this.replyElements.cancelBtn);const e=()=>(i=!0,this.canToggleHideAuthor()),t=()=>{i=!1},s=this.forwardElements={};let i=!1;const n=[s.showSender={text:"Chat.Alert.Forward.Action.Show1",onClick:e,checkboxField:new Gi.a({checked:!0})},s.hideSender={text:"Chat.Alert.Forward.Action.Hide1",onClick:e,checkboxField:new Gi.a({checked:!1})},s.showCaption={text:"Chat.Alert.Forward.Action.ShowCaption",onClick:t,checkboxField:new Gi.a({checked:!0})},s.hideCaption={text:"Chat.Alert.Forward.Action.HideCaption",onClick:t,checkboxField:new Gi.a({checked:!1})},s.changePeer={text:"Chat.Alert.Forward.Action.Another",onClick:()=>{this.changeForwardRecipient()},icon:"replace"}],a=s.container=Mi(n,this.listenerSetter),o=Array.from(a.children);if([{elements:o.slice(0,2),onChange:(e,t)=>{const n=!!+e;i&&(this.forwardWasDroppingAuthor=!n);const a=this.replyElements.container.querySelector(".reply-title");if(a){const e=a.firstElementChild,t=O.default.weakMap.get(e),i=s.showSender.checkboxField.checked?"Chat.Accessory.Forward":"Chat.Accessory.Hidden";t.key=i,t.update()}}},{elements:o.slice(2,4),onChange:e=>{const t=!!+e;let i;i=t&&void 0!==this.forwardWasDroppingAuthor?this.forwardWasDroppingAuthor?s.hideSender:s.showSender:t?s.showSender:s.hideSender,i.checkboxField.checked=!0}}].forEach(e=>{const t=Ki(e.elements.map(e=>({container:e,input:e.querySelector("input")})),e.onChange),s=document.createElement("hr");t.append(s),a.append(t)}),a.append(s.changePeer.element),!Ht.IS_TOUCH_SUPPORTED){this.forwardHover=new il({element:a})}s.modifyArgs=n.slice(0,-1),this.replyElements.container.append(a),s.modifyArgs.forEach((e,t)=>{const{input:s}=e.checkboxField;s.type="radio",s.name=t<2?"author":"caption",s.value=""+ +!(t%2)}),this.newMessageWrapper=document.createElement("div"),this.newMessageWrapper.classList.add("new-message-wrapper"),this.btnToggleEmoticons=Qs("none toggle-emoticons",{noRipple:!0}),this.inputMessageContainer=document.createElement("div"),this.inputMessageContainer.classList.add("input-message-container"),"chat"===this.chat.type&&(this.goDownUnreadBadge=document.createElement("span"),this.goDownUnreadBadge.classList.add("badge","badge-24","badge-primary"),this.goDownBtn.append(this.goDownUnreadBadge),this.goMentionBtn=li({icon:"mention",className:"bubbles-corner-button bubbles-go-mention"}),this.goMentionUnreadBadge=document.createElement("span"),this.goMentionUnreadBadge.classList.add("badge","badge-24","badge-primary"),this.goMentionBtn.append(this.goMentionUnreadBadge),this.inputContainer.append(this.goMentionBtn),Object(v.b)(this.goMentionBtn,e=>{Object(f.a)(e),this.appMessagesManager.goToNextMention(this.chat.peerId)},{listenerSetter:this.listenerSetter}),this.btnScheduled=Qs("scheduled btn-scheduled float hide",{noRipple:!0}),Object(v.b)(this.btnScheduled,e=>{this.appImManager.openScheduled(this.chat.peerId)},{listenerSetter:this.listenerSetter}),this.listenerSetter.add(H.default)("scheduled_new",({peerId:e})=>{this.chat.peerId===e&&this.btnScheduled.classList.remove("hide")}),this.listenerSetter.add(H.default)("scheduled_delete",({peerId:e})=>{this.chat.peerId===e&&this.appMessagesManager.getScheduledMessages(this.chat.peerId).then(e=>{this.btnScheduled.classList.toggle("hide",!e.length)})}),this.btnToggleReplyMarkup=Qs("botcom toggle-reply-markup float hide",{noRipple:!0}),this.replyKeyboard=new Kl({appendTo:this.rowsWrapper,listenerSetter:this.listenerSetter,appMessagesManager:this.appMessagesManager,btnHover:this.btnToggleReplyMarkup,chatInput:this}),this.listenerSetter.add(this.replyKeyboard)("open",()=>this.btnToggleReplyMarkup.classList.add("active")),this.listenerSetter.add(this.replyKeyboard)("close",()=>this.btnToggleReplyMarkup.classList.remove("active"))),this.attachMenuButtons=[{icon:"image",text:"Chat.Input.Attach.PhotoOrVideo",onClick:()=>{this.fileInput.value="";const e=[...Bs].join(", ");this.fileInput.setAttribute("accept",e),this.willAttachType="media",this.fileInput.click()},verify:(e,t)=>this.appMessagesManager.canSendToPeer(e,t,"send_media")},{icon:"document",text:"Chat.Input.Attach.Document",onClick:()=>{this.fileInput.value="",this.fileInput.removeAttribute("accept"),this.willAttachType="document",this.fileInput.click()},verify:(e,t)=>this.appMessagesManager.canSendToPeer(e,t,"send_media")}],this.attachMenu=Pi({noRipple:!0,listenerSetter:this.listenerSetter},"top-left",this.attachMenuButtons),this.attachMenu.classList.add("attach-file","tgico-attach"),this.attachMenu.classList.remove("tgico-more"),this.recordTimeEl=document.createElement("div"),this.recordTimeEl.classList.add("record-time"),this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.multiple=!0,this.fileInput.style.display="none",C.IS_SAFARI?this.newMessageWrapper.append(...[this.inputMessageContainer,this.btnScheduled,this.btnToggleReplyMarkup,this.attachMenu,this.recordTimeEl,this.fileInput].filter(Boolean)):this.newMessageWrapper.append(...[this.btnToggleEmoticons,this.inputMessageContainer,this.btnScheduled,this.btnToggleReplyMarkup,this.attachMenu,this.recordTimeEl,this.fileInput].filter(Boolean)),this.rowsWrapper.append(this.replyElements.container),this.autocompleteHelperController=new ql,this.stickersHelper=new Ol(this.rowsWrapper,this.autocompleteHelperController),this.emojiHelper=new Hl(this.rowsWrapper,this.autocompleteHelperController,this,this.appEmojiManager),this.commandsHelper=new Wl(this.rowsWrapper,this.autocompleteHelperController,this,this.chat.appProfileManager,this.chat.appUsersManager),this.mentionsHelper=new Vl(this.rowsWrapper,this.autocompleteHelperController,this,this.chat.appProfileManager,this.chat.appUsersManager),this.inlineHelper=new $l(this.rowsWrapper,this.autocompleteHelperController,this.chat,this.appUsersManager,this.appInlineBotsManager),this.rowsWrapper.append(this.newMessageWrapper),this.btnCancelRecord=Qs("delete danger btn-circle z-depth-1 btn-record-cancel"),this.btnSendContainer=document.createElement("div"),this.btnSendContainer.classList.add("btn-send-container"),this.recordRippleEl=document.createElement("div"),this.recordRippleEl.classList.add("record-ripple"),this.btnSend=Qs("none btn-circle z-depth-1 btn-send animated-button-icon"),this.btnSend.insertAdjacentHTML("afterbegin",'\n    <span class="tgico tgico-send"></span>\n    <span class="tgico tgico-schedule"></span>\n    <span class="tgico tgico-check"></span>\n    <span class="tgico tgico-microphone"></span>\n    '),this.btnSendContainer.append(this.recordRippleEl,this.btnSend),"scheduled"!==this.chat.type&&(this.sendMenu=new Ml({onSilentClick:()=>{this.sendSilent=!0,this.sendMessage()},onScheduleClick:()=>{this.scheduleSending(void 0)},listenerSetter:this.listenerSetter,openSide:"top-left",onContextElement:this.btnSend,onOpen:()=>!this.isInputEmpty()||!!Object.keys(this.forwarding).length}),this.btnSendContainer.append(this.sendMenu.sendMenu)),this.inputContainer.append(this.btnCancelRecord,this.btnSendContainer),ll.attachButtonListener(this.btnToggleEmoticons,this.listenerSetter),this.listenerSetter.add(ll)("open",this.onEmoticonsOpen),this.listenerSetter.add(ll)("close",this.onEmoticonsClose),this.attachMessageInputField(),this.listenerSetter.add(H.default)("settings_updated",()=>{(this.stickersHelper||this.emojiHelper)&&(this.previousQuery="",this.checkAutocomplete()),this.messageInputField&&this.messageInputField.onFakeInput()}),this.listenerSetter.add(H.default)("draft_updated",({peerId:e,threadId:t,draft:s,force:i})=>{this.chat.threadId===t&&this.chat.peerId===e&&this.setDraft(s,!0,i)}),this.listenerSetter.add(H.default)("peer_changing",e=>{this.chat===e&&this.saveDraft()}),"scheduled"===this.chat.type?this.listenerSetter.add(H.default)("scheduled_delete",({peerId:e,mids:t})=>{this.chat.peerId===e&&t.includes(this.editMsgId)&&this.onMessageSent()}):this.listenerSetter.add(H.default)("history_delete",({peerId:e,msgs:t})=>{this.chat.peerId===e&&(t.has(this.editMsgId)&&this.onMessageSent(),this.replyToMsgId&&t.has(this.replyToMsgId)&&this.clearHelper("reply"))});try{this.recorder=new Il.a({encoderSampleRate:48e3,monitorGain:0,numberOfChannels:1,recordingGain:1,reuseWorker:!0})}catch(e){console.error("Recorder constructor error:",e)}this.updateSendBtn(),this.listenerSetter.add(this.fileInput)("change",e=>{let t=e.target.files;t.length&&(new _l(this.chat,Array.from(t).slice(),this.willAttachType),this.fileInput.value="")},!1),Object(v.b)(this.btnSend,this.onBtnSendClick,{listenerSetter:this.listenerSetter,touchMouseDown:!0}),this.recorder&&(Object(v.b)(this.btnCancelRecord,this.onCancelRecordClick,{listenerSetter:this.listenerSetter}),this.recorder.onstop=()=>{this.recording=!1,this.chatInput.classList.remove("is-recording","is-locked"),this.updateSendBtn(),this.recordRippleEl.style.transform=""},this.recorder.ondataavailable=e=>{if(this.releaseMediaPlayback&&(this.releaseMediaPlayback(),this.releaseMediaPlayback=void 0),this.recordingOverlayListener&&(this.listenerSetter.remove(this.recordingOverlayListener),this.recordingOverlayListener=void 0),this.recordingNavigationItem&&(Nt.a.removeItem(this.recordingNavigationItem),this.recordingNavigationItem=void 0),this.recordCanceled)return;const{peerId:t,threadId:s}=this.chat,i=this.replyToMsgId,n=(Date.now()-this.recordStartTime)/1e3|0,a=new Blob([e],{type:"audio/ogg"});Ut.decode(e,!0).then(e=>{Ut.setKeepAlive(!1),this.appMessagesManager.sendFile(t,a,{isVoiceMessage:!0,isMedia:!0,duration:n,waveform:e.waveform,objectURL:e.url,replyToMsgId:i,threadId:s,clearDraft:!0}),this.onMessageSent(!1,!0)})}),Object(v.b)(this.replyElements.cancelBtn,this.onHelperCancel,{listenerSetter:this.listenerSetter}),Object(v.b)(this.replyElements.container,this.onHelperClick,{listenerSetter:this.listenerSetter}),this.saveDraftDebounced=Zi(()=>this.saveDraft(),2500,!1,!0)}constructPinnedHelpers(){const e=document.createElement("div");e.classList.add("pinned-container"),this.pinnedControlBtn=Object(Ks.a)("btn-primary btn-transparent text-bold pinned-container-button",{icon:"unpin"}),e.append(this.pinnedControlBtn);const t=e.cloneNode(!0);this.fakePinnedControlBtn=t.firstChild,this.fakeRowsWrapper.append(t),this.listenerSetter.add(this.pinnedControlBtn)("click",()=>{const e=this.chat.peerId;new ml(e,0,!0,()=>{this.chat.appImManager.setPeer(Z.b);const e=this.chat.appImManager.chat;e.topbar.pinnedMessage&&e.topbar.pinnedMessage.pinnedMessageContainer.toggle(!0)})}),this.rowsWrapper.append(e),this.chatInput.classList.add("type-pinned"),this.rowsWrapper.classList.add("is-centered")}getReadyToSend(e){return"scheduled"===this.chat.type?(this.scheduleSending(e),!0):(e(),!1)}setUnreadCount(){const e=this.appMessagesManager.getDialogOnly(this.chat.peerId),t=null==e?void 0:e.unread_count;if(this.goDownUnreadBadge.innerText=""+(t||""),this.goDownUnreadBadge.classList.toggle("badge-gray",this.appNotificationsManager.isPeerLocalMuted(this.chat.peerId,!0)),this.goMentionUnreadBadge&&"chat"===this.chat.type){const t=!!(null==e?void 0:e.unread_mentions_count);this.goMentionUnreadBadge.innerText=t?""+e.unread_mentions_count:"",this.goMentionBtn.classList.toggle("is-visible",t)}}saveDraft(){if(!this.chat.peerId||this.editMsgId||"scheduled"===this.chat.type)return;const{value:e,entities:t}=Object(Rl.a)(this.messageInputField.input);let s;(e.length||this.replyToMsgId)&&(s={_:"draftMessage",date:Object(S.f)(!0)+this.serverTimeManager.serverTimeOffset,message:e,entities:t.length?t:void 0,pFlags:{no_webpage:this.noWebPage},reply_to_msg_id:this.replyToMsgId}),this.appDraftsManager.syncDraft(this.chat.peerId,this.chat.threadId,s)}destroy(){this.listenerSetter.removeAll()}cleanup(e=!0){this.chat.peerId||(this.chatInput.style.display="none",this.goDownBtn.classList.add("hide")),Xa(),this.lastTimeType=0,this.messageInput&&(this.clearInput(),e&&this.clearHelper()),ll.toggle(!1)}setDraft(e,t=!0,s=!1){return!(!s&&!Object(Bl.a)(this.messageInput)||"scheduled"===this.chat.type)&&(e||(e=this.appDraftsManager.getDraft(this.chat.peerId,this.chat.threadId))?(this.messageInputField.value!==e.rMessage||this.replyToMsgId!==e.reply_to_msg_id)&&(t&&this.clearHelper(),this.noWebPage=e.pFlags.no_webpage,e.reply_to_msg_id&&this.initMessageReply(e.reply_to_msg_id),this.setInputValue(e.rMessage,t,t),!0):(s&&(this.chat.container.classList.contains("is-helper-active")&&this.t(),this.messageInputField.inputFake.textContent="",this.messageInputField.onFakeInput(!1),(this.chat.bubbles.messagesQueuePromise||Promise.resolve()).then(()=>{Object(g.b)(()=>{this.onMessageSent()})})),!1))}finishPeerChange(){const e=this.chat.peerId,{forwardElements:t,btnScheduled:s,replyKeyboard:i,sendMenu:n,goDownBtn:a,chatInput:o}=this;o.style.display="";const r=this.appPeersManager.isBroadcast(e);if(a.classList.toggle("is-broadcast",r),a.classList.remove("hide"),this.goDownUnreadBadge&&this.setUnreadCount(),"pinned"===this.chat.type&&o.classList.toggle("can-pin",this.appPeersManager.canPinMessage(e)),t&&(this.forwardWasDroppingAuthor=!1,t.showCaption.checkboxField.setValueSilently(!0),"quote"===this.forwardType?(t.showSender.checkboxField.setValueSilently(!0),t.hideSender.checkboxField.setValueSilently(!1)):(t.showSender.checkboxField.setValueSilently(!1),t.hideSender.checkboxField.setValueSilently(!0))),s){s.classList.add("hide");const t=this.chat.bubbles.getMiddleware();this.appMessagesManager.getScheduledMessages(e).then(e=>{t()&&s.classList.toggle("hide",!e.length)})}i&&i.setPeer(e),n&&n.setPeerId(e),this.messageInput?this.updateMessageInput():this.pinnedControlBtn&&(this.appPeersManager.canPinMessage(this.chat.peerId)?(this.pinnedControlBtn.append(Object(O.i18n)("Chat.Input.UnpinAll")),this.fakePinnedControlBtn.append(Object(O.i18n)("Chat.Input.UnpinAll"))):(this.pinnedControlBtn.append(Object(O.i18n)("Chat.Pinned.DontShow")),this.fakePinnedControlBtn.append(Object(O.i18n)("Chat.Pinned.DontShow"))))}updateMessageInput(){const{chatInput:e,attachMenu:t,messageInput:s}=this,{peerId:i,threadId:n}=this.chat,a=this.appMessagesManager.canSendToPeer(i,n);e.classList.add("no-transition"),e.classList.toggle("is-hidden",!a),e.offsetLeft,e.classList.remove("no-transition");const o=O.default.weakMap.get(s);if(o){let e;e=n?"Comment":this.appPeersManager.isBroadcast(i)?"ChannelBroadcast":this.appMessagesManager.isAnonymousSending(i)?"SendAnonymously":"Message",o.key!==e&&(o.key=e,o.update())}const r=this.attachMenuButtons.filter(e=>{const t=e.verify(i,n);return e.element.classList.toggle("hide",!t),t});a?(s.setAttribute("contenteditable","true"),this.setDraft(void 0,!1),s.innerHTML||this.messageInputField.onFakeInput()):s.removeAttribute("contenteditable"),t.toggleAttribute("disabled",!r.length),t.classList.toggle("btn-disabled",!r.length),this.updateSendBtn()}attachMessageInputField(){const e=this.messageInputField;this.messageInputField=new Ws.b({placeholder:"Message",name:"message",animate:!0}),this.messageInputField.input.classList.replace("input-field-input","input-message-input"),this.messageInputField.inputFake.classList.replace("input-field-input","input-message-input"),this.messageInput=this.messageInputField.input,this.messageInput.classList.add("no-scrollbar"),this.attachMessageInputListeners(),Yl.a&&Object(Yl.b)(this.messageInput),e?(e.input.replaceWith(this.messageInputField.input),e.inputFake.replaceWith(this.messageInputField.inputFake)):this.inputMessageContainer.append(this.messageInputField.input,this.messageInputField.inputFake)}attachMessageInputListeners(){this.listenerSetter.add(this.messageInput)("keydown",e=>{const t=e.key;if(ii(e))Object(f.a)(e),this.sendMessage();else if(e.ctrlKey||e.metaKey)this.handleMarkdownShortcut(e);else if(("PageUp"===t||"PageDown"===t)&&!e.shiftKey)if(e.preventDefault(),"PageUp"===t){const e=document.createRange(),t=window.getSelection();e.setStart(this.messageInput.childNodes[0]||this.messageInput,0),e.collapse(!0),t.removeAllRanges(),t.addRange(e)}else Object(Cl.a)(this.messageInput)}),Ht.IS_TOUCH_SUPPORTED&&Object(v.b)(this.messageInput,e=>{this.appImManager.selectTab(1),ll.toggle(!1)},{listenerSetter:this.listenerSetter}),this.listenerSetter.add(this.messageInput)("input",this.onMessageInput),this.listenerSetter.add(this.messageInput)("keyup",()=>{this.checkAutocomplete()}),"chat"!==this.chat.type&&"discussion"!==this.chat.type||this.listenerSetter.add(this.messageInput)("focusin",()=>{this.chat.bubbles.scrollable.loadedAll.bottom&&this.appMessagesManager.readAllHistory(this.chat.peerId,this.chat.threadId)})}applyMarkdown(e,t){const s={bold:"Bold",italic:"Italic",monospace:()=>document.execCommand("fontName",!1,"monospace"),link:t?()=>document.execCommand("createLink",!1,t):()=>document.execCommand("unlink",!1,null)};if(!s[e])return!1;const i=s[e],n=this.prepareDocumentExecute(),a=[];if(a.push(document.execCommand("styleWithCSS",!1,"true")),"monospace"===e){let t=!1;const s=window.getSelection();if(!s.isCollapsed){const i=s.getRangeAt(0),n=Ul.b[e],a=i.commonAncestorContainer;(a.parentNode.matches(n.match)||a instanceof HTMLElement&&a.matches(n.match))&&(t=!0)}t?a.push(document.execCommand("fontName",!1,"Roboto")):a.push("function"==typeof i?i():document.execCommand(i,!1,null))}else a.push("function"==typeof i?i():document.execCommand(i,!1,null));return a.push(document.execCommand("styleWithCSS",!1,"false")),n(),this.appImManager.markupTooltip&&this.appImManager.markupTooltip.setActiveMarkupButton(),!0}insertAtCaret(e,t,s=!0){const{value:i,caretPos:n,entities:a}=Nl(this.messageInput),o=n>=0?n:i.length,r=i.substr(0,o),l=i.substr(o),d=s?r.match(Xl.AUTO_COMPLETE_REG_EXP):null,c=d?d.index+(d[0].length-d[2].length):r.length,h=r.slice(0,c)+e+l,u=N.b.parseEntities(i);N.b.mergeEntities(a,u);const p=t?Math.max(t.length,e.length):e.length,g=[];t&&(g.push(t),t.offset=c);const m=d?p-d[2].length:p;a.forEach(e=>{e.offset>=c&&(e.offset+=m)}),N.b.mergeEntities(a,g);{const e={_:"messageEntityCaret",offset:c+p,length:0};let t=0;for(let s=a.length;t<s;++t){if(a[t].offset>e.offset)break}a.splice(t,0,e)}const f=Object(Yt.a)(N.b.wrapDraftText(h,{entities:a}));this.messageInputField.setValueSilently(f,!0);const v=this.messageInput.querySelector(".composer-sel");v&&(!function(e){const t=e;if(1===(e=e.previousSibling).nodeType){const s=document.createTextNode("");e.parentNode.insertBefore(s,t.nextSibling&&t.nextSibling.nodeType!==e.nodeType?t.nextSibling:t),e=s}if(window.getSelection&&document.createRange){const t=document.createRange();e&&(t.setStartAfter(e),t.insertNode(e),t.setStart(e,e.nodeValue.length)),t.collapse(!0);const s=window.getSelection();s.removeAllRanges(),s.addRange(t)}}(v),v.remove()),this.onMessageInput()}checkAutocomplete(e,t,s){}checkInlineAutocomplete(e,t){let s=!1;if(!t){const i=e.match(/^@([a-zA-Z\\d_]{3,32})\s/);if(i){const n=i[1],a=e.slice(i[0].length);s=i[0].length===e.length,t=this.inlineHelper,this.btnPreloader?Object(p.a)(this.btnPreloader,"show",!0,400):(this.btnPreloader=Qs("none btn-preloader float show disable-hover",{noRipple:!0}),Object(hi.f)(this.btnPreloader,!0),this.inputMessageContainer.parentElement.insertBefore(this.btnPreloader,this.inputMessageContainer.nextSibling)),this.inlineHelper.checkQuery(this.chat.peerId,n,a).then(({user:e,renderPromise:t})=>{s&&e.bot_inline_placeholder&&(this.messageInput.dataset.inlinePlaceholder=e.bot_inline_placeholder),t.then(()=>{Object(p.a)(this.btnPreloader,"show",!1,400)})}).catch(we.a)}}return s||delete this.messageInput.dataset.inlinePlaceholder,t!==this.inlineHelper&&this.btnPreloader&&Object(p.a)(this.btnPreloader,"show",!1,400),t}changeForwardRecipient(){if(this.helperWaitingForward)return;this.helperWaitingForward=!0;const e=Object(m.a)(this.forwarding),t=this.helperFunc;this.clearHelper(),this.updateSendBtn();let s=!1;new Qa(Object(m.a)(e),()=>{s=!0}).addEventListener("close",()=>{this.helperWaitingForward=!1,s||t()})}clearInput(e=!0,t=!0,s=""){if(document.activeElement===this.messageInput&&C.IS_MOBILE_SAFARI){const e=document.createElement("input");document.body.append(e),Object(Gl.a)(e),this.messageInputField.setValueSilently(s),Object(Gl.a)(this.messageInput),e.remove()}else this.messageInputField.setValueSilently(s);Ht.IS_TOUCH_SUPPORTED||(this.canRedoFromHTML="",this.undoHistory.length=0,this.executedHistory.length=0,this.canUndoFromHTML="");let i=!1;e&&(i=this.setDraft(void 0,!1)),!i&&t&&this.onMessageInput()}isInputEmpty(){return Object(Bl.a)(this.messageInput)}updateSendBtn(){let e;const t=this.isInputEmpty();e=this.editMsgId?"edit":!this.recorder||this.recording||!t||this.forwarding?"scheduled"===this.chat.type?"schedule":"send":"record",["send","record","edit","schedule"].forEach(t=>{this.btnSend.classList.toggle(t,e===t)}),this.btnScheduled&&this.btnScheduled.classList.toggle("show",t),this.btnToggleReplyMarkup&&this.btnToggleReplyMarkup.classList.toggle("show",t)}onMessageSent(e=!0,t){"scheduled"!==this.chat.type&&this.appMessagesManager.readAllHistory(this.chat.peerId,this.chat.threadId,!0),this.scheduleDate=void 0,this.sendSilent=void 0;const s=this.messageInputField.value;N.b.parseEntities(s).filter(e=>"messageEntityEmoji"===e._).forEach(e=>{const t=Object(ui.a)(e.unicode);this.appEmojiManager.pushRecentEmoji(t)}),e&&(this.lastUrl="",delete this.noWebPage,this.willSendWebPage=null,this.clearInput()),(t||e)&&this.clearHelper(),this.updateSendBtn()}sendMessage(e=!1){const{editMsgId:t,chat:s}=this;if("scheduled"===s.type&&!e&&!t)return void this.scheduleSending();const{threadId:i,peerId:n}=s,{replyToMsgId:a,noWebPage:o,sendSilent:r,scheduleDate:l}=this,{value:d,entities:c}=Object(Rl.a)(this.messageInputField.input);if(t){const e=this.editMessage;if(!d.trim()&&!e.media)return void new $a(n,[t],s.type);this.appMessagesManager.editMessage(e,d,{entities:c,noWebPage:o}),this.onMessageSent()}else d.trim()&&(this.appMessagesManager.sendText(n,d,{entities:c,replyToMsgId:a,threadId:i,noWebPage:o,webPage:this.getWebPagePromise?void 0:this.willSendWebPage,scheduleDate:l,silent:r,clearDraft:!0}),this.onMessageSent(!1,!1));if(this.forwarding){const e=Object(m.a)(this.forwarding);setTimeout(()=>{let t=!1;for(const s in e){const a=e[s];for(const e of a){const a=this.appMessagesManager.getMessageByPeer(s.toPeerId(),e);if(this.appMessagesManager.getMediaFromMessage(a)){if(!this.appMessagesManager.canSendToPeer(n,i,"send_media")){t=!0;break}}}if(t)break}if(t)$t({langPackKey:"UserRestrictionsNoSendMedia"});else{for(const t in e)this.appMessagesManager.forwardMessages(n,t.toPeerId(),e[t],{silent:r,scheduleDate:l,dropAuthor:this.forwardElements&&this.forwardElements.hideSender.checkboxField.checked,dropCaptions:this.isDroppingCaptions()});d||this.onMessageSent()}},0)}}sendMessageWithDocument(e,t=!1,s=!1){var i;const n="sticker"===(e=this.appDocsManager.getDoc(e)).type?"send_stickers":"gif"===e.type?"send_gifs":"send_media";return this.chat.peerId.isAnyChat()&&!this.appMessagesManager.canSendToPeer(this.chat.peerId,this.chat.threadId,n)?(Qt("Posting media content isn't allowed in this group."),!1):"scheduled"!==this.chat.type||t?!!e&&(this.appMessagesManager.sendFile(this.chat.peerId,e,{isMedia:!0,replyToMsgId:this.replyToMsgId,threadId:this.chat.threadId,silent:this.sendSilent,scheduleDate:this.scheduleDate,clearDraft:s||void 0}),this.onMessageSent(s,!0),"sticker"===e.type&&(null===(i=ll.stickersTab)||void 0===i||i.pushRecentSticker(e)),!0):(this.scheduleSending(()=>this.sendMessageWithDocument(e,!0,s)),!1)}canToggleHideAuthor(){const{forwardElements:e}=this;if(!e)return!1;const t=e.hideCaption.checkboxField;return!t.checked||Object(nn.a)(t.label,"FORM").classList.contains("hide")}isDroppingCaptions(){return!this.canToggleHideAuthor()}initMessageEditing(e){const t=this.chat.getMessage(e);let s=Object(Yt.a)(N.b.wrapDraftText(t.message,{entities:t.totalEntities}));const i=()=>{const n=this.appMessagesManager.wrapMessageForReply(t,void 0,[t.mid]);this.setTopInfo("edit",i,Object(O.i18n)("AccDescrEditing"),n,s,t),this.editMsgId=e,this.editMessage=t,s=void 0};i()}initMessagesForward(e,t="quote"){this.forwardType=t;const s=()=>{const i=Object.keys(e).map(e=>e.toPeerId()),n=new Set;let a=0,o=0;i.forEach(t=>{const s=e[t];s.forEach(e=>{var s;const i=this.appMessagesManager.getMessageByPeer(t,e);!(null===(s=i.fwd_from)||void 0===s?void 0:s.from_name)||i.fromId||i.fwdFromId?n.add("P"+i.fromId):n.add("N"+i.fwd_from.from_name),i.media&&i.message&&++o}),a+=s.length});const r=n.size>2,l=[...n].map(e=>{const t=e[0];if(e=e.slice(1),"P"===t){const t=e.toPeerId();return t===H.default.myId?Object(O.i18n)("Chat.Accessory.Forward.You"):new Oe({peerId:t,dialog:!1,onlyFirstName:r}).element}return r?e.split(" ")[0]:e}),{forwardElements:d}=this;Object(nn.a)(d.showCaption.checkboxField.label,"FORM").classList.toggle("hide",!o);const c=d.hideCaption.checkboxField.checked;o&&c?d.hideSender.checkboxField.setValueSilently(!0):void 0!==this.forwardWasDroppingAuthor&&(this.forwardWasDroppingAuthor?d.hideSender:d.showSender).checkboxField.setValueSilently(!0),"quote"===t?(d.showSender.checkboxField.setValueSilently(!0),d.hideSender.checkboxField.setValueSilently(!1)):(d.showSender.checkboxField.setValueSilently(!1),d.hideSender.checkboxField.setValueSilently(!0));const h=d.showSender.checkboxField.checked?"Chat.Accessory.Forward":"Chat.Accessory.Hidden",u=Object(O.i18n)(h,[a]),p=document.createDocumentFragment();let g,m;if(l.length<3?p.append(...Object(O.join)(l,!1)):p.append(l[0],Object(O.i18n)("AndOther",[l.length-1])),1===i.length){const t=i[0],s=e[t];if(g=this.appMessagesManager.getMessageByPeer(t,s[0]),m=!!g.grouped_id,m){const e=this.appMessagesManager.getMidsByMessage(g);(e.length!==a||e.find(e=>!s.includes(e)))&&(m=!1)}}const f=document.createDocumentFragment();if(m||1===a){const t=e[i[0]],s=this.appMessagesManager.wrapMessageForReply(g,void 0,t);f.append(p,": ",s)}else f.append(Object(O.i18n)("Chat.Accessory.Forward.From"),": ",p);let v=this.setTopInfo("forward",s,u,f);d.modifyArgs.forEach((e,t)=>{const s=e.textElement,n=O.default.weakMap.get(s);n.args=[t<2?i.length:o],n.update()}),this.forwardHover&&this.forwardHover.attachButtonListener(v,this.listenerSetter),this.forwarding=e};s()}initMessageReply(e){if(this.replyToMsgId===e)return;let t=this.chat.getMessage(e);const s=()=>{let i;"messageEmpty"===t._?(i=Object(O.i18n)("Loading"),this.chat.appMessagesManager.wrapSingleMessage(this.chat.peerId,e).then(i=>{this.replyToMsgId===e&&(t=i,"messageEmpty"===t._?this.clearHelper("reply"):s())})):i=new Oe({peerId:t.fromId,dialog:!1}).element,this.setTopInfo("reply",s,i,t&&t.message,void 0,t),this.replyToMsgId=e};s()}clearHelper(e){"edit"===this.helperType&&"edit"!==e&&this.clearInput(),e&&(this.lastUrl="",delete this.noWebPage,this.willSendWebPage=null),"reply"!==e&&(this.replyToMsgId=void 0,this.forwarding=void 0),this.editMsgId=this.editMessage=void 0,this.helperType=this.helperFunc=void 0,this.chat.container.classList.contains("is-helper-active")&&(Nt.a.removeByType("input-helper"),this.chat.container.classList.remove("is-helper-active"),this.t())}t(){Object(p.a)(this.chat.container,"is-toggling-helper",!0,150,()=>{this.chat.container.classList.remove("is-toggling-helper")})}setInputValue(e,t=!0,s=!0){e||(e=""),t?this.clearInput(!1,!1,e):this.messageInputField.setValueSilently(e),Object(g.b)(()=>{s&&Object(Cl.a)(this.messageInput),this.onMessageInput(),this.messageInput.scrollTop=this.messageInput.scrollHeight})}setTopInfo(e,t,s="",i="",n,a){if(this.willSendWebPage&&"reply"===e)return;"webpage"!==e&&(this.clearHelper(e),this.helperType=e,this.helperFunc=t);const o=this.replyElements.container,r=o.lastElementChild.previousElementSibling,l=r.classList.contains("reply");this.replyElements.iconBtn.replaceWith(this.replyElements.iconBtn=Qs(("webpage"===e?"link":e)+" active reply-icon",{noRipple:!0}));const d=ja(s,i,a);return l?r.replaceWith(d):o.insertBefore(d,o.lastElementChild),this.chat.container.classList.contains("is-helper-active")||(this.chat.container.classList.add("is-helper-active"),this.t()),C.IS_MOBILE||Nt.a.pushItem({type:"input-helper",onPop:()=>{this.onHelperCancel()}}),void 0!==n&&this.setInputValue(n),setTimeout(()=>{this.updateSendBtn()},0),d}}Xl.AUTO_COMPLETE_REG_EXP=/(\s|^)((?:(?:@|^\/)\S*)|(?::|^[^:@\/])(?!.*[:@\/]).*)$/;class Zl{constructor(e){this.floating=!1,Object(m.g)(this,e);const{divAndCaption:t,className:s}=this;t.container.classList.add("pinned-container","hide"),t.title.classList.add("pinned-container-title"),t.subtitle.classList.add("pinned-container-subtitle"),t.content.classList.add("pinned-container-content"),this.btnClose=document.createElement("button"),this.btnClose.classList.add("pinned-container-close",`pinned-${s}-close`,"btn-icon","tgico-close"),this.wrapper=document.createElement("div"),this.wrapper.classList.add("pinned-container-wrapper"),Object(ei.ripple)(this.wrapper),this.wrapperUtils=document.createElement("div"),this.wrapperUtils.classList.add("pinned-container-wrapper-utils"),this.wrapperUtils.append(this.btnClose),this.wrapper.append(...Array.from(t.container.children),this.wrapperUtils),t.container.append(this.wrapper),this.attachOnCloseEvent(this.btnClose)}attachOnCloseEvent(e){Object(v.b)(e,e=>{Object(f.a)(e),((this.onClose?this.onClose():null)||Promise.resolve(!0)).then(e=>{e&&this.toggle(!0)})},{listenerSetter:this.listenerSetter})}toggle(e){const t=this.divAndCaption.container.classList.contains("hide");if(void 0===e)e=!t;else if(e===t)return;const s=(this.floating||I.b.isMobile)&&!e;this.divAndCaption.container.classList.toggle("is-floating",s),this.divAndCaption.container.classList.toggle("hide",e),this.topbar.container.classList.toggle("is-pinned-floating",s),this.topbar.container.classList.toggle(`is-pinned-${this.className}-shown`,!e),this.topbar.setFloating(),this.topbar.setUtilsWidth()}fill(e,t,s){this.divAndCaption.container.dataset.peerId=""+s.peerId,this.divAndCaption.container.dataset.mid=""+s.mid,this.divAndCaption.fill(e,t,s),this.topbar.setUtilsWidth()}}class Jl extends Zl{constructor(e,t,s){super({topbar:e,chat:t,listenerSetter:e.listenerSetter,className:"audio",divAndCaption:new Di("pinned-audio",(e,t)=>{Object(le.a)(this.divAndCaption.title,e),Object(le.a)(this.divAndCaption.subtitle,t)}),onClose:()=>{yi.stop()},floating:!0}),this.topbar=e,this.chat=t,this.appMessagesManager=s,this.divAndCaption.border.remove();const i=Qs("pprevious active",{noRipple:!0}),n=Qs("nnext active",{noRipple:!0});i.innerHTML='<svg class="missing-icon" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet"><g><path class="missing-icon-path" d="M6 6h2v12H6zm3.5 6l8.5 6V6z"></path></g></svg>',n.innerHTML='<svg class="missing-icon" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet"><g><path class="missing-icon-path" d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"></path></g></svg>';const a=(e,t)=>{Object(v.b)(e,e=>{Object(f.a)(e),t()},{listenerSetter:this.topbar.listenerSetter})};a(i,()=>{yi.previous()}),a(n,()=>{yi.next()}),this.toggleEl=Qs("",{noRipple:!0}),this.toggleEl.classList.add("active","pinned-audio-ico","tgico"),a(this.toggleEl,()=>{yi.toggle()}),this.wrapper.prepend(this.wrapper.firstElementChild,i,this.toggleEl,n),this.volumeSelector=new _i(this.listenerSetter,!0);const o=document.createElement("div");o.classList.add("progress-line-container"),o.append(this.volumeSelector.container);const r=document.createElement("div");r.classList.add("pinned-audio-volume-tunnel"),this.volumeSelector.btn.classList.add("pinned-audio-volume","active"),this.volumeSelector.btn.prepend(r),this.volumeSelector.btn.append(o),this.playbackRateButton=Qs("playback_1x btn-menu-toggle",{noRipple:!0}),this.playbackRateButton.classList.add("active"),this.setupPlaybackRateMenu(),this.wrapperUtils.prepend(this.playbackRateButton,this.volumeSelector.btn);const l=document.createElement("div");l.classList.add("pinned-audio-progress-wrapper"),this.progressLine=new Ei(void 0,void 0,!0,!0),this.progressLine.container.classList.add("pinned-audio-progress"),l.append(this.progressLine.container),this.wrapper.insertBefore(l,this.wrapperUtils),this.topbar.listenerSetter.add(H.default)("media_playback_params",({playbackRate:e})=>{this.setPlaybackRateIcon(e)}),this.topbar.listenerSetter.add(H.default)("media_play",({doc:e,message:t,media:s})=>{let i,n;"voice"!==e.type&&e.type;"voice"===e.type||"round"===e.type?(i=new Oe({peerId:t.fromId}).element,n=Object(S.c)(t.date)):(i=e.audioTitle||e.fileName,n=e.audioPerformer||Object(O.i18n)("AudioUnknownArtist")),yi.playbackRate=1,this.playbackRateButton.classList.remove("hide"),this.progressLine.setMedia(s),this.fill(i,n,t),this.toggleEl.classList.add("flip-icon"),this.toggle(!1)}),this.topbar.listenerSetter.add(H.default)("media_pause",()=>{this.toggleEl.classList.remove("flip-icon")}),this.topbar.listenerSetter.add(H.default)("media_stop",()=>{this.toggle(!0)})}setupPlaybackRateMenu(){const e=Jl.PLAYBACK_RATES.map((e,t)=>({icon:Jl.PLAYBACK_RATES_ICONS[t],onClick:()=>{yi.playbackRate=e}})),t=Mi(e,this.topbar.listenerSetter);t.classList.add("play-speed-menu"),Ci(this.playbackRateButton),this.playbackRateButton.append(t),this.setPlaybackRateIcon(yi.playbackRate)}setPlaybackRateIcon(e){Jl.PLAYBACK_RATES_ICONS.forEach(e=>{this.playbackRateButton.classList.remove("tgico-"+e)});let t=Jl.PLAYBACK_RATES.indexOf(e);-1===t&&(t=Jl.PLAYBACK_RATES.indexOf(1)),this.playbackRateButton.classList.add("tgico-"+Jl.PLAYBACK_RATES_ICONS[t])}}var ed;Jl.PLAYBACK_RATES=[.5,1,1.5,2],Jl.PLAYBACK_RATES_ICONS=["playback_05","playback_1x","playback_15","playback_2x"],function(e){e[e.ONE=32]="ONE",e[e.TWO=15]="TWO",e[e.THREE=10]="THREE",e[e.FOUR=8]="FOUR",e[e.MORE=8]="MORE"}(ed||(ed={}));class td{constructor(){this.drawRect=(e,t,s,i,n)=>`M${e},${t+n}a${n},${n},0,0,1,${s},0v${i-2*n}a${n},${n},0,0,1,${-s},0Z`,this.getClipPath=(e,t,s)=>{let i="";if(2===s)i=this.drawRect(0,0,2,t,1)+this.drawRect(0,t+2,2,t,1);else for(let e=0;e<s;++e)i+=this.drawRect(0,(t+1)*e,2,t,1);return this.clipPath||(this.clipPath=document.createElementNS("http://www.w3.org/2000/svg","clipPath"),this.path=document.createElementNS("http://www.w3.org/2000/svg","path"),this.clipPath.append(this.path)),this.clipPath.id=e,this.path.setAttributeNS(null,"d",i),this.clipPath},this.getBarHeight=(e,t)=>{let s;return e<=1?s=ed.ONE:2===e?s=ed.TWO:3===e?s=ed.THREE:4===e?s=ed.FOUR:e>3&&(s=ed.MORE),s},this.getMarkHeight=(e,t)=>{let s;return e<=1?s=ed.ONE:2===e?s=ed.TWO:3===e?s=ed.THREE:4===e?s=ed.FOUR:e>3&&(s=ed.MORE),s},this.getMarkTranslateY=(e,t,s)=>1===s?0:2===s?e?t+1:0:3===s?e?1===e?t+1:2*t+2+1:0:(t+1)*e,this.getTrackTranslateY=(e,t,s,i)=>t<=4||e<=1?0:e>=t-2?i-ed.ONE-s:(e-2)*s+1*e,this.getTrackHeight=(e,t)=>e<=3?ed.ONE:t*e+1*(e-1)}render(e,t){if(this.border||(this.border=document.createElement("div"),this.border.classList.add("pinned-message-border"),this.wrapper=document.createElement("div"),this.border.append(this.wrapper)),1===e)return this.count!==e&&(this.wrapper.className="pinned-message-border-wrapper-1",this.border.classList.remove("pinned-message-border-mask"),this.wrapper.innerHTML=this.wrapper.style.cssText=""),this.border;const s=this.getBarHeight(e,t),i=this.getMarkHeight(e,t),n=this.getTrackHeight(e,s),a="clipPath_"+e,o=this.getClipPath(a,s,e),r=this.getMarkTranslateY(t,s,e),l=this.getTrackTranslateY(t,e,s,n);return this.border.classList.toggle("pinned-message-border-mask",e>4),t<=1?(this.border.classList.add("mask-bottom"),this.border.classList.remove("mask-top")):t>=e-2?(this.border.classList.add("mask-top"),this.border.classList.remove("mask-bottom")):this.border.classList.add("mask-top","mask-bottom"),this.wrapper.className="pinned-message-border-wrapper",this.wrapper.style.cssText=`clip-path: url(#${a}); width: 2px; height: ${n}px; transform: translateY(-${l}px);`,this.svg||(this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttributeNS(null,"height","0"),this.svg.setAttributeNS(null,"width","0"),this.defs=document.createElementNS("http://www.w3.org/2000/svg","defs"),this.defs.append(o),this.svg.append(this.defs),this.mark=document.createElement("div"),this.mark.classList.add("pinned-message-border-mark")),this.svg.parentElement||this.wrapper.append(this.svg,this.mark),this.mark.style.cssText=`height: ${i}px; transform: translateY(${r}px);`,this.count=e,this.index=t,this.border}}var sd=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class id{constructor(){this.rows={},this.container=document.createElement("div"),this.container.className=id.BASE_CLASS}getRow(e,t=!1){if(this.rows[e])return this.rows[e].element;const s=document.createElement("div"),i=!Object.keys(this.rows).length&&!t;return s.className=id.BASE_CLASS+"-row"+(i?"":" is-hiding hide"),this.rows[e]={element:s,new:!0},this.container.append(s),s}clearRow(e){this.rows[e]&&(this.rows[e].element.remove(),delete this.rows[e])}clearRows(e){this.clearTimeout&&clearTimeout(this.clearTimeout),this.clearTimeout=window.setTimeout(()=>{for(const t in this.rows)+t!==e&&this.clearRow(+t)},id.DURATION)}setNewRow(e,t=!1){const s=this.rows[e];s.new&&(t?(s.element.classList.remove("hide"),s.element.offsetLeft):s.element.classList.remove("is-hiding","hide"),delete s.new),this.clearRows(e)}animate(e,t,s=e>t,i=!1){if(e===t)return this.setNewRow(e);const n=this.rows[e],a=this.rows[t];if(!a&&!i)return this.setNewRow(e);const o=["from-top","from-bottom"];s||o.reverse(),n.element.classList.add(o[0]),n.element.classList.remove(o[1]),a&&(a.element.classList.add(o[1]),a.element.classList.remove(o[0])),n.new&&this.setNewRow(e,!0),n.element.classList.toggle("is-hiding",!1),a&&a.element.classList.toggle("is-hiding",!0),this.clearRows(e)}}id.DURATION=200,id.BASE_CLASS="animated-super";class nd{constructor(e=!1){this.reverse=e,this.decimals=[],this.previousNumber=0,this.container=document.createElement("div"),this.container.className=nd.BASE_CLASS}getDecimal(e){if(this.decimals[e])return this.decimals[e];const t=document.createElement("div");t.className=nd.BASE_CLASS+"-decimal";const s=document.createElement("div");s.className=nd.BASE_CLASS+"-decimal-placeholder";const i=new id;return i.container.className=nd.BASE_CLASS+"-decimal-wrapper",t.append(s,i.container),this.container.append(t),this.decimals[e]={container:t,placeholder:s,animatedSuper:i}}clear(e){this.clearTimeout&&clearTimeout(this.clearTimeout);const t=(""+e).length;t>=this.decimals.length||(this.clearTimeout=window.setTimeout(()=>{this.decimals.splice(t,this.decimals.length-t).forEach(e=>{e.container.remove()})},id.DURATION))}hideLeft(e){const t=(""+e).length;this.decimals.slice(t).forEach(t=>{const s=+t.placeholder.innerText||0;t.animatedSuper.getRow(nd.EMPTY_INDEX,!0);t.animatedSuper.animate(nd.EMPTY_INDEX,s,this.reverse?e<this.previousNumber:e>this.previousNumber,!0)}),this.clear(e)}setCount(e){const t=Array.from(""+this.previousNumber).map(e=>+e);Array.from(""+e).map(e=>+e).forEach((s,i)=>{var n;const a=this.getDecimal(i),o=a.animatedSuper.getRow(s,!0),r=null!==(n=t[i])&&void 0!==n?n:nd.EMPTY_INDEX;o.innerText=a.placeholder.innerText=""+s,a.animatedSuper.animate(s,r,this.reverse?e<this.previousNumber:e>this.previousNumber,!0)}),this.hideLeft(e),this.previousNumber=e}}nd.EMPTY_INDEX=-1,nd.BASE_CLASS="animated-counter";class ad{constructor(e,t,s,i){this.topbar=e,this.chat=t,this.appMessagesManager=s,this.appPeersManager=i,this.pinnedMaxMid=0,this.pinnedMid=0,this.pinnedIndex=-1,this.wasPinnedIndex=0,this.wasPinnedMediaIndex=0,this.locked=!1,this.waitForScrollBottom=!1,this.count=0,this.mids=[],this.offsetIndex=0,this.loading=!1,this.loadedBottom=!1,this.loadedTop=!1,this.scrollDownListenerSetter=null,this.hidden=!1,this.getCurrentIndexPromise=null,this.isStatic=!1,this.debug=!1,this.listenerSetter=new Gs;const n=new Ri("pinned-message");this.pinnedMessageContainer=new Zl({topbar:e,chat:t,listenerSetter:this.listenerSetter,className:"message",divAndCaption:n,onClose:()=>sd(this,void 0,void 0,(function*(){return i.canPinMessage(this.topbar.peerId)?new ml(this.topbar.peerId,this.pinnedMid,!0):new ml(this.topbar.peerId,0,!0),!1}))}),this.pinnedMessageBorder=new td,n.border.replaceWith(this.pinnedMessageBorder.render(1,0)),this.animatedSubtitle=new id,n.subtitle.append(this.animatedSubtitle.container),this.animatedMedia=new id,this.animatedMedia.container.classList.add("pinned-message-media-container"),n.content.prepend(this.animatedMedia.container),this.animatedCounter=new nd(!0),n.title.append(Object(O.i18n)("PinnedMessage")," ",this.animatedCounter.container);const a=this.pinnedMessageContainer.btnClose.cloneNode(!0);this.pinnedMessageContainer.attachOnCloseEvent(a),n.container.prepend(a),this.btnOpen=Qs("pinlist pinned-container-close pinned-message-pinlist",{noRipple:!0}),this.pinnedMessageContainer.wrapperUtils.prepend(this.btnOpen),Object(v.b)(this.btnOpen,e=>{Object(f.a)(e),this.topbar.openPinned(!0)},{listenerSetter:this.listenerSetter}),this.listenerSetter.add(H.default)("peer_pinned_messages",({peerId:e})=>{e===this.topbar.peerId&&(this.hidden&&this.pinnedMessageContainer.toggle(this.hidden=!1),this.loadedTop=this.loadedBottom=!1,this.pinnedIndex=-1,this.pinnedMid=0,this.count=0,this.mids=[],this.offsetIndex=0,this.pinnedMaxMid=0,this.setCorrectIndex(0))}),this.listenerSetter.add(H.default)("peer_pinned_hidden",({peerId:e})=>{e===this.topbar.peerId&&this.pinnedMessageContainer.toggle(this.hidden=!0)}),this.setPinnedMessage=Zi(()=>this._setPinnedMessage(),100,!0,!0),this.isStatic="discussion"===this.chat.type}destroy(){this.pinnedMessageContainer.divAndCaption.container.remove(),this.pinnedMessageContainer.toggle(!0),this.listenerSetter.removeAll(),this.unsetScrollDownListener(!1)}setCorrectIndex(e){if(this.isStatic)return;if(this.locked||this.hidden)return;if((this.loadedBottom||this.loadedTop)&&!this.count)return;let t=this.chat.bubbles.getBubbleByPoint("bottom");if(!t)return;const s=t.dataset.mid;t&&void 0!==s&&this.testMid(+s,e)}testMid(e,t){if(this.isStatic)return;if(this.hidden)return;let s=this.mids.findIndex(t=>t<=e);if(-1===s||this.isNeededMore(s)){if(!(this.loadedTop&&e<this.mids[this.mids.length-1]))return void(this.getCurrentIndexPromise||(this.getCurrentIndexPromise=this.getCurrentIndex(e,void 0!==t)));s=this.mids.length-1+this.offsetIndex}else s+=this.offsetIndex;if(this.pinnedIndex!==s){if(this.waitForScrollBottom&&void 0!==t&&(0===this.pinnedIndex||this.pinnedIndex>s))return;this.pinnedIndex=s,this.pinnedMid=this.mids.find(t=>t<=e)||this.mids[this.mids.length-1],this.setPinnedMessage()}}isNeededMore(e){return this.count>ad.LOAD_COUNT&&(!this.loadedBottom&&e<=ad.LOAD_OFFSET||!this.loadedTop&&this.count-1-e<=ad.LOAD_OFFSET)}getCurrentIndex(e,t=!0){return sd(this,void 0,void 0,(function*(){if(!this.loading){this.loading=!0;try{let s=!1;const i=[this.appMessagesManager.getSearch({peerId:this.topbar.peerId,inputFilter:{_:"inputMessagesFilterPinned"},maxId:e,limit:ad.LOAD_COUNT,backLimit:ad.LOAD_COUNT}).then(e=>(s=!0,e))];if(!this.pinnedMaxMid){const e=this.appMessagesManager.getPinnedMessage(this.topbar.peerId).then(e=>{e.maxId&&(this.pinnedMaxMid=e.maxId,!s&&t&&(this.mids=[this.pinnedMaxMid],this.count=e.count,this.pinnedIndex=0,this.pinnedMid=this.mids[0],this.setPinnedMessage()))});i.push(e)}const n=(yield Promise.all(i))[0];let a=n.history.findIndex(t=>t.mid<=e);-1===a&&(a=n.history.length),this.offsetIndex=n.offset_id_offset?n.offset_id_offset-a:0,this.mids=n.history.map(e=>e.mid).slice(),this.count=n.count,this.count||this.pinnedMessageContainer.toggle(!0),this.loadedTop=this.offsetIndex+this.mids.length===this.count,this.loadedBottom=!this.offsetIndex,this.debug&&this.chat.log("[PM]: getCurrentIndex result:",e,n,a,this.offsetIndex,this.loadedTop,this.loadedBottom)}catch(e){this.chat.log.error("[PM]: getCurrentIndex error",e)}this.loading=!1,this.locked?this.testMid(e):t&&this.setCorrectIndex(0),this.getCurrentIndexPromise=null}}))}setScrollDownListener(){this.waitForScrollBottom=!0,this.scrollDownListenerSetter||(this.scrollDownListenerSetter=new Gs,function(e,t,s,i){if(Ht.IS_TOUCH_SUPPORTED){let n;const a={passive:!0};i.add(e)("touchstart",t=>{t.touches.length>1?r():(n=t.touches[0].clientY,i.add(e)("touchmove",o,a),i.add(e)("touchend",r,a))},a);const o=e=>{const i=e.touches[0].clientY,a=i<n;"bottom"===t&&a?s():"top"!==t||a||s(),n=i},r=()=>{i.removeManual(e,"touchmove",o,a),i.removeManual(e,"touchend",r,a)}}else i.add(e)("wheel",e=>{const i=e.deltaY>0;"bottom"===t&&i?s():"top"!==t||i||s()},{passive:!0})}(this.chat.bubbles.scrollable.container,"bottom",()=>{this.unsetScrollDownListener()},this.scrollDownListenerSetter))}unsetScrollDownListener(e=!0){this.waitForScrollBottom=!1,this.scrollDownListenerSetter&&(this.scrollDownListenerSetter.removeAll(),this.scrollDownListenerSetter=null),e&&this.setCorrectIndex(0)}handleFollowingPinnedMessage(){return sd(this,void 0,void 0,(function*(){this.locked=!0,this.debug&&this.chat.log("[PM]: handleFollowingPinnedMessage");try{this.setScrollDownListener();const e=this.chat.setPeerPromise;e instanceof Promise&&(yield e),yield Object(it.c)(),this.getCurrentIndexPromise&&(yield this.getCurrentIndexPromise),this.debug&&this.chat.log("[PM]: handleFollowingPinnedMessage: unlock"),this.locked=!1}catch(e){this.chat.log.error("[PM]: handleFollowingPinnedMessage error:",e),this.locked=!1,this.waitForScrollBottom=!1,this.setCorrectIndex(0)}}))}followPinnedMessage(e){return sd(this,void 0,void 0,(function*(){const t=this.chat.getMessage(e);t&&!t.deleted&&(this.chat.setMessageId(e),(this.chat.setPeerPromise||Promise.resolve()).then(()=>{this.handleFollowingPinnedMessage(),this.testMid(this.pinnedIndex>=this.count-1?this.pinnedMaxMid:e-1)}))}))}_setPinnedMessage(){return sd(this,void 0,void 0,(function*(){const e=this.count;if(e){const t=this.pinnedIndex,s=this.chat.getMessage(this.pinnedMid),i=0===t;this.animatedCounter.container.classList.toggle("is-last",i),i||this.animatedCounter.setCount(e-t),this.pinnedMessageContainer.toggle(!1);const n=t>this.wasPinnedIndex;this.debug&&this.chat.log("[PM]: setPinnedMessage: fromTop",n,t,this.wasPinnedIndex);const a=this.animatedSubtitle.getRow(t),o=this.animatedMedia.getRow(t);o.classList.add("pinned-message-media");const r=[],l=ji({title:void 0,titleEl:null,subtitle:s.message,subtitleEl:a,message:s,mediaEl:o,loadPromises:r});yield Promise.all(r),this.pinnedMessageContainer.divAndCaption.container.classList.toggle("is-media",l),this.animatedSubtitle.animate(t,this.wasPinnedIndex),l?(this.animatedMedia.animate(t,this.wasPinnedMediaIndex),this.wasPinnedMediaIndex=t):this.animatedMedia.clearRows(),this.pinnedMessageBorder.render(e,e-t-1),this.wasPinnedIndex=t,this.pinnedMessageContainer.divAndCaption.container.dataset.mid=""+s.mid}else this.pinnedMessageContainer.toggle(!0),this.wasPinnedIndex=0;this.pinnedMessageContainer.divAndCaption.container.classList.toggle("is-many",this.count>1)}))}}ad.LOAD_COUNT=50,ad.LOAD_OFFSET=5;class od{constructor(e,t,s,i,n,a,o,r){this.chat=e,this.appSidebarRight=t,this.appMessagesManager=s,this.appPeersManager=i,this.appChatsManager=n,this.appNotificationsManager=a,this.appProfileManager=o,this.appUsersManager=r,this.menuButtons=[],this.keysPressed={},this.isProcessingKeyEvent=!1,this.onResize=()=>{this.setUtilsWidth(!0),this.setFloating()},this.onChangeScreen=(e,t)=>{this.container.classList.toggle("is-pinned-floating",I.b.isMobile),this.pinnedMessage&&this.pinnedMessage.pinnedMessageContainer.divAndCaption.container.classList.toggle("is-floating",t===I.a.mobile),this.onResize()},this.setUtilsWidth=(e=!1)=>{this.setUtilsRAF&&window.cancelAnimationFrame(this.setUtilsRAF),C.IS_SAFARI&&e&&this.chatUtils.classList.add("hide"),this.setUtilsRAF=window.requestAnimationFrame(()=>{C.IS_SAFARI&&e&&this.chatUtils.classList.remove("hide");const t=this.chatUtils.getBoundingClientRect().width;this.chat.log("utils width:",t),this.container.style.setProperty("--utils-width",t+"px"),this.setUtilsRAF=0})},this.setFloating=()=>{const e=[this.chatAudio,this.pinnedMessage&&this.pinnedMessage.pinnedMessageContainer].filter(Boolean).reduce((e,t)=>{const s=t.divAndCaption.container.classList.contains("is-floating");return this.container.classList.toggle(`is-pinned-${t.className}-floating`,s),e+ +s},0);this.container.dataset.floating=""+e},this.setPeerStatus=(e=!1)=>{if(!this.subtitle)return;const t=this.peerId;this.chat.appImManager.setPeerStatus(this.peerId,this.subtitle,e,!1,()=>t===this.peerId)},this.listenerSetter=new Gs,H.default.addEventListener("language_change",e=>{"en"===e?this.subtitle.classList.add("ltrI18N"):this.subtitle.classList.remove("ltrI18N")})}construct(){this.container=document.createElement("div"),this.container.classList.add("sidebar-header","topbar"),this.container.dataset.floating="0",this.btnBack=Qs("left sidebar-close-button",{noRipple:!0}),this.chatInfo=document.createElement("div"),this.chatInfo.classList.add("chat-info");const e=document.createElement("div");e.classList.add("person");const t=document.createElement("div");t.classList.add("content");const s=document.createElement("div");s.classList.add("top"),this.title=document.createElement("div"),this.title.classList.add("user-title"),s.append(this.title);const i=document.createElement("div");i.classList.add("bottom"),this.subtitle&&i.append(this.subtitle),t.append(s,i),this.avatarElement&&e.append(this.avatarElement),e.append(t),this.chatInfo.append(e),this.chatUtils=document.createElement("div"),this.chatUtils.classList.add("chat-utils"),this.chatAudio=new Jl(this,this.chat,this.appMessagesManager),this.menuButtons.length&&(this.btnMore=Pi({listenerSetter:this.listenerSetter},"bottom-left",this.menuButtons,e=>{Object(f.a)(e),this.menuButtons.forEach(e=>{e.element.classList.toggle("hide",!e.verify())}),this.menuButtons[this.menuButtons.length-1].element.lastChild.replaceWith(Object(O.i18n)(this.appPeersManager.getDeleteButtonText(this.peerId)))})),this.chatUtils.append(...[this.pinnedMessage?this.pinnedMessage.pinnedMessageContainer.divAndCaption.container:null,this.btnJoin,this.btnPinned,this.btnMute,this.btnSearch,this.btnMore].filter(Boolean)),this.container.append(this.btnBack,this.chatInfo,this.chatUtils),this.chatAudio&&this.container.append(this.chatAudio.divAndCaption.container),this.listenerSetter.add(window)("resize",this.onResize),this.listenerSetter.add(I.b)("changeScreen",this.onChangeScreen),Object(v.b)(this.container,e=>{const t=Object(ti.a)(e.target,"pinned-container");if(Object(si.a)(),t){if(Object(f.a)(e),Object(ti.a)(e.target,"progress-line"))return;const s=+t.dataset.mid;if(t.classList.contains("pinned-message"))this.pinnedMessage.followPinnedMessage(s);else{const e=t.dataset.peerId.toPeerId(),i=yi.getSearchContext();this.chat.appImManager.setInnerPeer(e,s,i.isScheduled?"scheduled":i.threadId?"discussion":void 0,i.threadId)}}else I.b.activeScreen===I.a.medium&&document.body.classList.contains("is-left-column-shown")?n():Object(nn.a)(e.target,"AVATAR-ELEMENT")?this.appSidebarRight.toggleSidebar(!document.body.classList.contains("is-right-column-shown")):this.appSidebarRight.toggleSidebar(!0)},{listenerSetter:this.listenerSetter});const n=e=>{if(e&&Object(f.a)(e),I.b.activeScreen===I.a.medium&&document.body.classList.contains("is-left-column-shown"))this.chat.appImManager.setPeer(this.peerId);else{const e=0===this.chat.appImManager.chats.indexOf(this.chat);Nt.a.back(e?"im":"chat")}};this.listenerSetter.add(document)("keydown",e=>a(e));const a=e=>{e.ctrlKey&&"KeyF"===e.code&&e.preventDefault(),e.ctrlKey&&"KeyF"===e.code&&!this.isProcessingKeyEvent&&(this.isProcessingKeyEvent=!0,this.btnSearch.click(),setTimeout(()=>{this.isProcessingKeyEvent=!1},500))};Object(v.b)(this.btnBack,n,{listenerSetter:this.listenerSetter})}constructUtils(){this.menuButtons=[{icon:"search",text:"Search",onClick:()=>{this.chat.initSearch()},verify:()=>I.b.isMobile},{icon:"mute",text:"ChatList.Context.Mute",onClick:()=>{this.appMessagesManager.mutePeer(this.peerId)},verify:()=>"chat"===this.chat.type&&H.default.myId!==this.peerId&&!this.appNotificationsManager.isPeerLocalMuted(this.peerId,!1)},{icon:"unmute",text:"ChatList.Context.Unmute",onClick:()=>{this.appMessagesManager.mutePeer(this.peerId)},verify:()=>"chat"===this.chat.type&&H.default.myId!==this.peerId&&this.appNotificationsManager.isPeerLocalMuted(this.peerId,!1)},{icon:"comments",text:"ViewDiscussion",onClick:()=>{this.appProfileManager.getChannelFull(this.peerId.toChatId()).then(e=>{e.linked_chat_id&&this.chat.appImManager.setInnerPeer(e.linked_chat_id.toPeerId(!0))})},verify:()=>{var e;const t=this.appProfileManager.chatsFull[this.peerId.toChatId()];return"chat"===this.chat.type&&this.appPeersManager.isBroadcast(this.peerId)&&!!(null===(e=t)||void 0===e?void 0:e.linked_chat_id)}},{icon:"select",text:"Chat.Menu.SelectMessages",onClick:()=>{const e=this.chat.selection;e.toggleSelection(!0,!0),ve.default.getState().then(t=>{if(t.chatContextMenuHintWasShown)return;const s=e.toggleByElement.bind(e);e.toggleByElement=t=>{ve.default.pushToState("chatContextMenuHintWasShown",!0),Qt(Object(O.i18n)("Chat.Menu.Hint")),e.toggleByElement=s,e.toggleByElement(t)}})},verify:()=>!this.chat.selection.isSelecting&&!!this.chat.bubbles.getBubblesCount()},{icon:"select",text:"Chat.Menu.ClearSelection",onClick:()=>{this.chat.selection.cancelSelection()},verify:()=>this.chat.selection.isSelecting},{icon:"flag",text:"ReportChat",onClick:()=>{new yl(this.peerId,[])},verify:()=>this.peerId.isAnyChat()},{icon:"forward",text:"ShareContact",onClick:()=>{const e=this.peerId;new un({peerTypes:["dialogs","contacts"],onSelect:t=>new Promise((s,i)=>{new en("",{titleLangKey:"SendMessageTitle",descriptionLangKey:"SendContactToGroupText",descriptionLangArgs:[new Oe({peerId:t,dialog:!0}).element],buttons:[{langKey:"Send",callback:()=>{s(),this.appMessagesManager.sendOther(t,this.appUsersManager.getContactMediaInput(e)),this.chat.appImManager.setInnerPeer(t)}},{langKey:"Cancel",callback:()=>{i()},isCancel:!0}],peerId:t,overlayClosable:!0}).show()}),placeholder:"ShareModal.Search.Placeholder",chatRightsAction:"send_messages",selfPresence:"ChatYourSelf"})},verify:()=>H.default.myId!==this.peerId&&this.peerId.isUser()&&this.appPeersManager.isContact(this.peerId)},{icon:"lock",text:"BlockUser",onClick:()=>{new en("",{peerId:this.peerId,titleLangKey:"BlockUser",descriptionLangKey:"AreYouSureBlockContact2",descriptionLangArgs:[new Oe({peerId:this.peerId}).element],buttons:[{langKey:"BlockUser",isDanger:!0,callback:()=>{this.appUsersManager.toggleBlock(this.peerId,!0).then(e=>{e&&$t({langPackKey:"UserBlocked"})})}}]}).show()},verify:()=>{var e;const t=this.peerId.toUserId(),s=this.appProfileManager.usersFull[t];return this.appPeersManager.isUser(this.peerId)&&this.peerId!==H.default.myId&&s&&!(null===(e=s.pFlags)||void 0===e?void 0:e.blocked)}},{icon:"lockoff",text:"Unblock",onClick:()=>{this.appUsersManager.toggleBlock(this.peerId,!1).then(e=>{e&&$t({langPackKey:"UserUnblocked"})})},verify:()=>{var e;const t=this.appProfileManager.usersFull[this.peerId.toUserId()];return this.appPeersManager.isUser(this.peerId)&&!!(null===(e=null==t?void 0:t.pFlags)||void 0===e?void 0:e.blocked)}},{icon:"group",text:"Eitaa.Action.MigrateToSuperGroup",onClick:()=>{Pe.migrateChat(this.peerId.toChatId()).then(e=>{Qt(O.default.format("ActionMigrateFromGroup",!0))}).catch(()=>{Qt(O.default.format("Eitaa.ErrorMigrateToSuperGroup",!0))})},verify:()=>!Pe.isChannel(this.peerId.toChatId())&&!Pe.isMegagroup(this.peerId.toChatId())&&Pe.hasRights(this.peerId.toChatId(),"change_permissions")&&Pe.isInChat(this.peerId.toChatId())},{icon:"delete danger",text:"Delete",onClick:()=>{new wn(this.peerId,void 0,e=>{e.then(()=>{this.appMessagesManager.getDialogOnly(this.peerId)||this.appMessagesManager.reloadConversation(this.peerId)})})},verify:()=>"chat"===this.chat.type&&!!this.appMessagesManager.getDialogOnly(this.peerId)}],this.btnSearch=Qs("search"),Object(v.b)(this.btnSearch,e=>{Object(f.a)(e),this.chat.initSearch()},{listenerSetter:this.listenerSetter})}constructPeerHelpers(){return this.avatarElement=new Od,this.avatarElement.setAttribute("dialog","1"),this.avatarElement.classList.add("avatar-42","person-avatar"),this.subtitle=document.createElement("div"),this.subtitle.classList.add("info"),ss.a.get("langPack").then(e=>{"en"===e.lang_code?this.subtitle.classList.add("ltrI18N"):this.subtitle.classList.remove("ltrI18N")}),this.pinnedMessage=new ad(this,this.chat,this.appMessagesManager,this.appPeersManager),this.btnJoin=Object(Ks.a)("btn-primary btn-color-primary chat-join hide"),this.btnPinned=Qs("pinlist"),this.btnMute=Qs("mute"),Object(v.b)(this.btnPinned,e=>{Object(f.a)(e),Object(si.a)(),this.openPinned(!0)},{listenerSetter:this.listenerSetter}),Object(v.b)(this.btnMute,e=>{Object(f.a)(e),Object(si.a)(),this.appMessagesManager.mutePeer(this.peerId)},{listenerSetter:this.listenerSetter}),Object(v.b)(this.btnJoin,e=>{Object(f.a)(e),Object(si.a)();const t=this.chat.bubbles.getMiddleware();this.btnJoin.setAttribute("disabled","true");const s=this.peerId.toChatId();let i;i=this.appChatsManager.isChannel(s)?this.appChatsManager.joinChannel(s):this.appChatsManager.addChatUser(s,H.default.myId),i.then(()=>{if(t()&&this.appChatsManager.isChannel(s)){this.appMessagesManager.getDialogOnly(this.peerId)||this.appMessagesManager.reloadConversation(this.peerId)}}).finally(()=>{t()&&this.btnJoin.removeAttribute("disabled")})},{listenerSetter:this.listenerSetter}),this.listenerSetter.add(H.default)("chat_update",e=>{var t,s;if(this.peerId===e.toPeerId(!0)){const i=this.appChatsManager.getChat(e);this.btnJoin.classList.toggle("hide",!(null===(s=null===(t=i)||void 0===t?void 0:t.pFlags)||void 0===s?void 0:s.left)),this.setUtilsWidth()}}),this.listenerSetter.add(H.default)("dialog_notify_settings",e=>{e.peerId===this.peerId&&this.setMutedState()}),this.listenerSetter.add(H.default)("peer_typings",({peerId:e})=>{this.peerId===e&&this.setPeerStatus()}),this.listenerSetter.add(H.default)("user_update",e=>{this.peerId===e&&this.setPeerStatus()}),this.pinnedMessage&&this.chat.addEventListener("setPeer",(e,t)=>{const s=this.chat.bubbles.getMiddleware();ve.default.getState().then(i=>{s()&&(this.pinnedMessage.hidden=!!i.hiddenPinnedMessages[this.chat.peerId],t?(this.pinnedMessage.unsetScrollDownListener(),this.pinnedMessage.testMid(e,0)):this.pinnedMessage.locked||(this.pinnedMessage.handleFollowingPinnedMessage(),this.pinnedMessage.testMid(e)))})}),this.setPeerStatusInterval=window.setInterval(this.setPeerStatus,6e4),this}constructPinnedHelpers(){this.listenerSetter.add(H.default)("peer_pinned_messages",e=>{const{peerId:t,mids:s,pinned:i}=e;t===this.peerId&&s&&this.setTitle()})}constructDiscussionHelpers(){this.pinnedMessage=new ad(this,this.chat,this.appMessagesManager,this.appPeersManager)}openPinned(e){this.chat.appImManager.setInnerPeer(this.peerId,e?+this.pinnedMessage.pinnedMessageContainer.divAndCaption.container.dataset.mid:0,"pinned")}destroy(){this.listenerSetter.removeAll(),window.clearInterval(this.setPeerStatusInterval),this.pinnedMessage&&this.pinnedMessage.destroy(),delete this.chatAudio,delete this.pinnedMessage}setPeer(e){this.wasPeerId=this.peerId,this.peerId=e,this.container.style.display=e?"":"none"}finishPeerChange(e,t,s){var i,n;const a=this.peerId;this.avatarElement&&(this.avatarElement.innerHTML="",this.avatarElement.setAttribute("peer",""+a),this.avatarElement.update());const o=this.appPeersManager.isBroadcast(a);if(this.btnMute&&this.btnMute.classList.toggle("hide",!o),this.appPeersManager.isAnyChat(a)&&this.btnJoin){const e=a.toChatId();Object(le.a)(this.btnJoin,Object(O.i18n)(this.appChatsManager.isChannel(e)?"Chat.Subscribe":"ChannelJoin")),this.btnJoin.classList.toggle("hide",!(null===(n=null===(i=this.appChatsManager.getChat(e))||void 0===i?void 0:i.pFlags)||void 0===n?void 0:n.left))}this.setUtilsWidth();const r=this.chat.bubbles.getMiddleware();if(this.pinnedMessage)if("chat"===this.chat.type){if(void 0!==this.wasPeerId){const e=new ad(this,this.chat,this.appMessagesManager,this.appPeersManager);this.pinnedMessage.pinnedMessageContainer.divAndCaption.container.replaceWith(e.pinnedMessageContainer.divAndCaption.container),this.pinnedMessage.destroy(),this.pinnedMessage=e}ve.default.getState().then(t=>{r()&&(this.pinnedMessage.hidden=!!t.hiddenPinnedMessages[a],e||this.pinnedMessage.setCorrectIndex(0))})}else"discussion"===this.chat.type&&(this.pinnedMessage.pinnedMid=this.chat.threadId,this.pinnedMessage.count=1,this.pinnedMessage.pinnedIndex=0,this.pinnedMessage._setPinnedMessage());Object(g.b)(()=>{this.setTitle(),this.setPeerStatus(!0),this.setMutedState()})}setTitle(e){var t;let s;if("pinned"===this.chat.type?(s=void 0===e?Object(O.i18n)("Loading"):Object(O.i18n)("PinnedMessagesCount",[e]),void 0===e&&this.appMessagesManager.getSearchCounters(this.peerId,[{_:"inputMessagesFilterPinned"}],!1).then(e=>{const t=e[0].count;if(this.setTitle(t),!t){this.chat.appImManager.setPeer(Z.b);const e=this.chat.appImManager.chat;e.topbar.pinnedMessage&&e.topbar.pinnedMessage.pinnedMessageContainer.toggle(!0)}})):"scheduled"===this.chat.type?(s=this.peerId===H.default.myId?Object(O.i18n)("Reminders"):Object(O.i18n)("ScheduledMessages"),void 0===e&&this.appMessagesManager.getScheduledMessages(this.peerId).then(e=>{this.setTitle(e.length)})):"discussion"===this.chat.type?(s=void 0===e?Object(O.i18n)("Loading"):Object(O.i18n)("Chat.Title.Comments",[e]),void 0===e&&Promise.all([this.appMessagesManager.getHistory(this.peerId,0,1,0,this.chat.threadId),Promise.resolve()]).then(()=>{const e=this.appMessagesManager.getHistoryStorage(this.peerId,this.chat.threadId).count;null===e?setTimeout(()=>{this.setTitle()},30):this.setTitle(e)})):"chat"===this.chat.type&&(s=new Oe({peerId:this.peerId,dialog:!0}).element),Object(le.a)(this.title,s),"chat"===this.chat.type){const e=this.appPeersManager.getPeer(this.peerId);(null===(t=null==e?void 0:e.pFlags)||void 0===t?void 0:t.verified)&&this.title.append(Bn())}}setMutedState(){if(!this.btnMute)return;const e=this.peerId;let t=this.appNotificationsManager.isPeerLocalMuted(e,!1);this.appPeersManager.isBroadcast(e)?(this.btnMute.classList.remove("tgico-mute","tgico-unmute"),this.btnMute.classList.add(t?"tgico-unmute":"tgico-mute"),this.btnMute.style.display=""):this.btnMute.style.display="none"}}class rd extends Ys{constructor(){super(...arguments),this.threadId=0,this.query=""}onOpenAfterTimeout(){this.appSearch.beginSearch(this.peerId,this.threadId,this.query)}init(){this.container.id="search-private-container",this.container.classList.add("chatlist-container"),this.inputSearch=new qs("Search"),this.title.replaceWith(this.inputSearch.container),this.btnPickDate=Qs("calendar sidebar-header-right"),this.header.append(this.btnPickDate);const e=document.createElement("div");e.classList.add("chatlist-container"),this.scrollable.container.replaceWith(e),this.appSearch=new ce(e,this.inputSearch,{messages:new de("Chat.Search.PrivateSearch","messages")})}open(e,t,s,i){const n=super.open();return this.peerId?this.appSearch.beginSearch(this.peerId,this.threadId,i):(this.query=i,this.peerId=e,this.threadId=t,this.onDatePick=s,this.btnPickDate.classList.toggle("hide",!this.onDatePick),this.onDatePick&&Object(v.b)(this.btnPickDate,()=>{new Pr(new Date,this.onDatePick).show()}),i&&this.appSearch.searchInput.inputField.setValueSilently(i),pa.toggleSidebar(!0)),n}}class ld{constructor(e,t,s){this.topbar=e,this.chat=t,this.query=s,this.foundCount=0,this.selectedIndex=0,this.onDateClick=e=>{Object(f.a)(e),new Pr(new Date,this.chat.bubbles.onDatePick).show()},this.selectResult=e=>{if(this.setPeerPromise)return this.setPeerPromise;const t=e.dataset.peerId.toPeerId(),s=+e.dataset.mid||void 0,i=Object(Na.a)(e);i===this.foundCount-1?this.upBtn.setAttribute("disabled","true"):this.upBtn.removeAttribute("disabled"),i?this.downBtn.removeAttribute("disabled"):this.downBtn.setAttribute("disabled","true"),this.results.classList.remove("active"),this.chat.bubbles.bubblesContainer.classList.remove("search-results-active");const n=this.chat.setPeer(t,s);this.setPeerPromise=(n instanceof Promise?n:Promise.resolve(n)).then(()=>{this.selectedIndex=i,Object(le.a)(this.foundCountEl,Object(O.i18n)("Of",[i+1,this.foundCount]));const e=this.searchGroup.list.childElementCount;this.selectedIndex>=e-6&&this.appSearch.searchMore()}).finally(()=>{this.setPeerPromise=null})},this.onResultsClick=e=>{const t=Object(nn.a)(e.target,"LI");t&&this.selectResult(t)},this.onFooterClick=e=>{this.foundCount&&(this.chat.bubbles.bubblesContainer.classList.toggle("search-results-active"),this.results.classList.toggle("active"))},this.onUpClick=e=>{Object(f.a)(e),this.selectResult(this.searchGroup.list.children[this.selectedIndex+1])},this.onDownClick=e=>{Object(f.a)(e),this.selectResult(this.searchGroup.list.children[this.selectedIndex-1])},this.element=document.createElement("div"),this.element.classList.add("sidebar-header","chat-search","chatlist-container"),this.backBtn=document.createElement("button"),this.backBtn.classList.add("btn-icon","tgico-left","sidebar-close-button"),Object(ei.ripple)(this.backBtn);const i=this.listenerSetter=new Gs;var n,a;n=this.backBtn,a=()=>{this.destroy()},Object(v.b)(n,a,{listenerSetter:i}),this.inputSearch=new qs("Search"),this.results=document.createElement("div"),this.results.classList.add("chat-search-results","chatlist-container"),this.searchGroup=new de(!1,"messages",void 0,"",!1),this.searchGroup.list.addEventListener("click",this.onResultsClick),this.appSearch=new ce(this.results,this.inputSearch,{messages:this.searchGroup},e=>{this.foundCount=e,this.foundCount?this.selectResult(this.searchGroup.list.children[0]):(Object(le.a)(this.foundCountEl,this.inputSearch.value?Object(O.i18n)("NoResult"):""),this.results.classList.remove("active"),this.chat.bubbles.bubblesContainer.classList.remove("search-results-active"),this.upBtn.setAttribute("disabled","true"),this.downBtn.setAttribute("disabled","true"))}),this.appSearch.beginSearch(this.chat.peerId,this.chat.threadId),this.chat.bubbles.bubblesContainer.append(this.results),this.footer=document.createElement("div"),this.footer.classList.add("chat-search-footer"),this.footer.addEventListener("click",this.onFooterClick),Object(ei.ripple)(this.footer),this.foundCountEl=document.createElement("span"),this.foundCountEl.classList.add("chat-search-count"),this.dateBtn=document.createElement("button"),this.dateBtn.classList.add("btn-icon","tgico-calendar"),this.controls=document.createElement("div"),this.controls.classList.add("chat-search-controls"),this.upBtn=document.createElement("button"),this.upBtn.classList.add("btn-icon","tgico-up"),this.downBtn=document.createElement("button"),this.downBtn.classList.add("btn-icon","tgico-down"),this.upBtn.setAttribute("disabled","true"),this.downBtn.setAttribute("disabled","true"),this.dateBtn.addEventListener("click",this.onDateClick),this.upBtn.addEventListener("click",this.onUpClick),this.downBtn.addEventListener("click",this.onDownClick),this.controls.append(this.upBtn,this.downBtn),this.footer.append(this.foundCountEl,this.dateBtn,this.controls),this.topbar.container.parentElement.insertBefore(this.footer,t.input.chatInput),this.element.append(this.backBtn,this.inputSearch.container),this.topbar.container.classList.add("hide-pinned"),this.topbar.container.parentElement.append(this.element),this.inputSearch.input.focus(),s&&this.setQuery(s),C.IS_MOBILE_SAFARI||(this.navigationItem={type:"mobile-search",onPop:()=>{this.destroy()}},Nt.a.pushItem(this.navigationItem))}destroy(){this.topbar.container.classList.remove("hide-pinned"),this.element.remove(),this.inputSearch.remove(),this.results.remove(),this.footer.remove(),this.footer.removeEventListener("click",this.onFooterClick),this.dateBtn.removeEventListener("click",this.onDateClick),this.upBtn.removeEventListener("click",this.onUpClick),this.downBtn.removeEventListener("click",this.onDownClick),this.searchGroup.list.removeEventListener("click",this.onResultsClick),this.chat.bubbles.bubblesContainer.classList.remove("search-results-active"),this.listenerSetter.removeAll(),Nt.a.removeItem(this.navigationItem)}setQuery(e){this.inputSearch.inputField.value=e}}const dd="undefined"!=typeof ImageBitmap;class cd{constructor(){this.canvases=new Set}static getInstance(e){let t=this.INSTANCES.find(t=>Object(m.b)(t.options,e));return t||(t=new cd,t.init(e),this.INSTANCES.push(t)),t}init(e){this.options=e}renderToCanvas(e){return this.renderImageFromUrl(this.options.url).then(()=>this.fillCanvas(e))}renderImageFromUrl(e){if(this.renderImageFromUrlPromise)return this.renderImageFromUrlPromise;const t=this.img=document.createElement("img");return t.crossOrigin="anonymous",this.renderImageFromUrlPromise=Ze(t,e,!1).then(()=>dd?createImageBitmap(t).then(e=>(this.imageBitmap=e,t)):t)}cleanup(e){var t;this.canvases.delete(e),this.canvases.size||(Object(a.f)(cd.INSTANCES,this),this.objectUrl&&(null===(t=this.imageBitmap)||void 0===t||t.close(),URL.revokeObjectURL(this.objectUrl)))}fillCanvas(e){const t=e.getContext("2d"),{width:s,height:i}=e,n=this.imageBitmap||this.img;let a=n.width,o=n.height;a*=.35,o*=.35,this.options.mask?(t.fillStyle="#000",t.fillRect(0,0,s,i),t.globalCompositeOperation="destination-out"):t.globalCompositeOperation="source-over";const r=e=>{for(let i=0;i<s;i+=a)t.drawImage(n,i,e,a,o)},l=(i-o)/2;if(r(l),l>0){let e=l;do{r(e-=o)}while(e>=0)}const d=i-1;for(let e=l+o;e<d;e+=o)r(e)}setCanvasDimensions(e){const t=Math.min(2,window.devicePixelRatio),s=this.options.width*t;let i=this.options.height*t;e.dataset.originalHeight=""+i,I.b.activeScreen===I.a.large&&(i*=1.5),e.width=s,e.height=i}createCanvas(){const e=document.createElement("canvas");return this.canvases.add(e),this.setCanvasDimensions(e),e}resize(e,t){this.init(Object.assign(Object.assign({},this.options),{width:e,height:t}));const s=[];for(const e of this.canvases)this.setCanvasDimensions(e),s.push(this.renderToCanvas(e));return Promise.all(s)}static resizeInstances(e,t){return Promise.all(this.INSTANCES.map(s=>s.resize(e,t)))}}cd.INSTANCES=[];class hd extends Mt.a{constructor(e,t,s,n,a,o,r,l,d,c,h,u,p,g,m,f,v,b,y){super(),this.appImManager=e,this.appChatsManager=t,this.appDocsManager=s,this.appInlineBotsManager=n,this.appMessagesManager=a,this.appPeersManager=o,this.appPhotosManager=r,this.appProfileManager=l,this.appStickersManager=d,this.appUsersManager=c,this.appWebPagesManager=h,this.appPollsManager=u,this.apiManager=p,this.appDraftsManager=g,this.serverTimeManager=m,this.storage=f,this.appNotificationsManager=v,this.appEmojiManager=b,this.appMessagesIdsManager=y,this.initPeerId=0,this.type="chat",this.container=document.createElement("div"),this.container.classList.add("chat","tabs-tab"),this.backgroundEl=document.createElement("div"),this.backgroundEl.classList.add("chat-background"),this.log=Object(i.b)("CHAT",i.a.Log|i.a.Warn|i.a.Debug|i.a.Error),this.container.append(this.backgroundEl),this.appImManager.chatsContainer.append(this.container),this.backgroundTempId=0}setBackground(e,t){const s=H.default.getTheme();let i;if(!!s.background.color&&!s.background.slug&&!s.background.intensity&&"grabbing"===document.documentElement.style.cursor&&this.gradientRenderer&&!this.patternRenderer)return this.gradientCanvas.dataset.colors=s.background.color,this.gradientRenderer.init(this.gradientCanvas),Promise.resolve();const n=++this.backgroundTempId,a=(this.gradientRenderer,this.patternRenderer),o=(this.gradientCanvas,this.patternCanvas);this.gradientRenderer=this.patternRenderer=this.gradientCanvas=this.patternCanvas=void 0;const r=s.background.intensity&&s.background.intensity/100,l=!!r&&r<0;let d,c,h,u=null==i?void 0:i.firstElementChild;if(!i)if(i=document.createElement("div"),i.classList.add("chat-background-item"),e)if(r){i.classList.add("is-pattern");const t=this.appImManager.chatsContainer.getBoundingClientRect();d=this.patternRenderer=cd.getInstance({url:e,width:t.width,height:t.height,mask:l}),u=this.patternCanvas=d.createCanvas(),u.classList.add("chat-background-item-canvas","chat-background-item-pattern-canvas"),l&&i.classList.add("is-dark")}else s.background.slug&&i.classList.add("is-image");else s.background.color&&i.classList.add("is-color");const g=s.background.color;if(g){const{canvas:e,gradientRenderer:t}=qo.create(g);h=this.gradientRenderer=t,c=this.gradientCanvas=e,c.classList.add("chat-background-item-canvas","chat-background-item-color-canvas")}if(d){const e=l?c:u;let t=Math.abs(r)*(l?.5:1);l&&(t=Math.max(.3,t)),e.style.setProperty("--opacity-max",""+t)}const m=new Promise(s=>{const r=()=>{if(this.backgroundTempId!==n)return void(d&&d.cleanup(u));const e=this.backgroundEl.lastElementChild;if(e===i)return void s();const r=[c,u].filter(Boolean);r.length&&i.append(...r),this.backgroundEl.append(i),Object(p.a)(i,"is-visible",!0,t?0:200,e?()=>{a&&a.cleanup(o),e.remove()}:null,2),s()};if(d){d.renderToCanvas(u).then(()=>{if(this.backgroundTempId!==n)return;let e;e=Promise.resolve(),e.then(r)})}else e?Xe(i,e,r):r()});return this.setBackgroundPromise=Promise.race([Object(M.a)(500),m])}setType(e){this.type=e,"scheduled"===this.type&&(this.getMessagesStorage=()=>this.appMessagesManager.getScheduledMessagesStorage(this.peerId))}init(e){this.initPeerId=e,this.topbar=new od(this,pa,this.appMessagesManager,this.appPeersManager,this.appChatsManager,this.appNotificationsManager,this.appProfileManager,this.appUsersManager),this.bubbles=new pl(this,this.appMessagesManager,this.appStickersManager,this.appUsersManager,this.appInlineBotsManager,this.appPhotosManager,this.appPeersManager,this.appProfileManager,this.appDraftsManager,this.appMessagesIdsManager),this.input=new Xl(this,this.appMessagesManager,this.appMessagesIdsManager,this.appDocsManager,this.appChatsManager,this.appPeersManager,this.appWebPagesManager,this.appImManager,this.appDraftsManager,this.serverTimeManager,this.appNotificationsManager,this.appEmojiManager,this.appUsersManager,this.appInlineBotsManager),this.selection=new to(this,this.bubbles,this.input,this.appMessagesManager),this.contextMenu=new wl(this.bubbles.bubblesContainer,this,this.appMessagesManager,this.appPeersManager,this.appPollsManager,this.appDocsManager,this.appMessagesIdsManager),"chat"===this.type?(this.topbar.constructUtils(),this.topbar.constructPeerHelpers()):"pinned"===this.type?this.topbar.constructPinnedHelpers():"discussion"===this.type&&(this.topbar.constructUtils(),this.topbar.constructDiscussionHelpers()),this.topbar.construct(),this.input.construct(),"chat"===this.type?(this.bubbles.constructPeerHelpers(),this.input.constructPeerHelpers()):"pinned"===this.type?(this.bubbles.constructPinnedHelpers(),this.input.constructPinnedHelpers()):"scheduled"===this.type?(this.bubbles.constructScheduledHelpers(),this.input.constructPeerHelpers()):"discussion"===this.type&&(this.bubbles.constructPeerHelpers(),this.input.constructPeerHelpers()),this.container.classList.add("type-"+this.type),this.container.append(this.topbar.container,this.bubbles.bubblesContainer,this.input.chatInput),this.bubbles.listenerSetter.add(H.default)("dialog_migrate",({migrateFrom:e,migrateTo:t})=>{this.peerId===e&&this.setPeer(t)}),this.bubbles.listenerSetter.add(H.default)("dialog_drop",e=>{e.peerId===this.peerId&&this.appImManager.setPeer(Z.b)})}beforeDestroy(){this.bubbles.cleanup()}destroy(){this.topbar.destroy(),this.bubbles.destroy(),this.input.destroy(),delete this.topbar,delete this.bubbles,delete this.input,delete this.selection,delete this.contextMenu,this.container.remove()}cleanup(e=!0){this.input.cleanup(e),this.selection.cleanup()}setPeer(e,t){e?this.inited||(this.init&&(this.init(e),this.init=null),this.inited=!0):this.inited=void 0;const s=this.peerId===e;if(s){if(this.setPeerPromise)return this.peerId=void 0,this.setPeerPromise=null,pa.toggleSidebar(!1),this.cleanup(!0),this.topbar.setPeer(e),this.bubbles.setPeer(e),void H.default.dispatchEvent("peer_changed",e)}else H.default.dispatchEvent("peer_changing",this),this.peerId=e,this.noForwards=this.appPeersManager.noForwards(e),this.container.classList.toggle("no-forwards",this.noForwards);if(!e)return;if(!s){const t=pa.getTab(rd);t&&t.close(),this.isRestricted=this.appPeersManager.isRestricted(e),pa.sharedMediaTab.setPeer(e,this.threadId),this.input.clearHelper(),this.selection.cleanup(),this.setAutoDownloadMedia()}this.peerChanged=s;const i=this.bubbles.setPeer(e,t);if(!i)return;const{promise:n}=i,a=this.setPeerPromise=n.finally(()=>{this.setPeerPromise===a&&(this.setPeerPromise=null)});return s||(pa.sharedMediaTab.setLoadMutex(this.setPeerPromise),pa.sharedMediaTab.loadSidebarMedia(!0)),i}setAutoDownloadMedia(){const e=this.peerId;if(!e)return;let t;t=e.isUser()?e.isContact()?"contacts":"private":e.isBroadcast()?"channels":"groups",this.noAutoDownloadMedia=!H.default.settings.autoDownload[t]}setMessageId(e){return this.setPeer(this.peerId,e)}finishPeerChange(e,t,s){if(this.peerChanged)return;let i=this.peerId;this.peerChanged=!0,this.cleanup(!1),this.topbar.setPeer(i),this.topbar.finishPeerChange(e,t,s),this.bubbles.finishPeerChange(),this.input.finishPeerChange(),pa.sharedMediaTab.fillProfileElements(),this.log.setPrefix("CHAT-"+i+"-"+this.type),H.default.dispatchEvent("peer_changed",i),this.wasAlreadyUsed=!0}getMessagesStorage(){return this.appMessagesManager.getMessagesStorage(this.peerId)}getMessage(e){var t;const s=this.appMessagesManager.getMessageFromStorage(this.getMessagesStorage(),e);if("messageMediaLiveStream"===(null===(t=null==s?void 0:s.media)||void 0===t?void 0:t._)){const e=s.media,t=e.state,i={_:"documentAttributeVideo",duration:0,flags:1,pFlags:{supports_streaming:!0},h:400,w:480};let n=0;"liveStreamStateEnded"===t._&&1===t.flags&&(n=t.duration),s.media.document={_:"document",id:e.id,access_hash:e.access_hash,file_reference:[0,0],date:0,mime_type:"video/mp4",size:0,dc_id:1,attributes:[i],type:"video",duration:n}}return s}getMidsByMid(e){return this.appMessagesManager.getMidsByMessage(this.getMessage(e))}isAnyGroup(){return this.peerId===H.default.myId||this.peerId===Z.c||this.appPeersManager.isAnyGroup(this.peerId)}initSearch(e){if(this.peerId)if(I.b.isMobile)new ld(this.topbar,this,e);else{let t=pa.getTab(rd);t||(t=new rd(pa)),t.open(this.peerId,this.threadId,this.bubbles.onDatePick,e)}}}function ud(){const e=[],t=window.getSelection();for(let s=0;s<t.rangeCount;++s){const i=t.getRangeAt(s);let{startContainer:n,endContainer:a}=i;for(3!==a.nodeType&&(a=a.firstChild);n&&n!==a;)e.push(3===n.nodeType?n:n.firstChild),n=n.nextSibling;e[e.length-1]!==a&&e.push(a)}return e.filter(e=>!!e)}class pd{constructor(e){this.appImManager=e,this.buttons={},this.addedListener=!1,this.waitingForMouseUp=!1,this.mouseUpCounter=0,this.onMouseUpSingle=e=>{if(this.waitingForMouseUp=!1,Ht.IS_TOUCH_SUPPORTED){if(Object(f.a)(e),0!=this.mouseUpCounter++)return void this.hide();this.resetSelection(this.savedRange)}this.show()}}init(){this.container=document.createElement("div"),this.container.classList.add("markup-tooltip","z-depth-1","hide"),this.wrapper=document.createElement("div"),this.wrapper.classList.add("markup-tooltip-wrapper");const e=document.createElement("div"),t=document.createElement("div");e.classList.add("markup-tooltip-tools"),t.classList.add("markup-tooltip-tools");["bold","italic","monospace","link"].forEach(t=>{const s=Qs(t,{noRipple:!0});e.append(this.buttons[t]=s),"link"!==t?s.addEventListener("mousedown",e=>{Object(f.a)(e),this.appImManager.chat.input.applyMarkdown(t),this.cancelClosening()}):Object(v.b)(s,e=>{Object(f.a)(e),this.showLinkEditor(),this.cancelClosening()})}),this.linkBackButton=Qs("left",{noRipple:!0}),this.linkInput=document.createElement("input"),Object(O._i18n)(this.linkInput,"MarkupTooltip.LinkPlaceholder",void 0,"placeholder"),this.linkInput.classList.add("input-clear"),this.linkInput.addEventListener("keydown",e=>{const t=!this.linkInput.value.length||!!N.b.matchUrl(this.linkInput.value);"Enter"===e.key&&(t?this.applyLink(e):(this.linkInput.classList.contains("error")&&(this.linkInput.classList.remove("error"),this.linkInput.offsetLeft),this.linkInput.classList.add("error")))}),this.linkInput.addEventListener("input",e=>{const t=this.isLinkValid();this.linkInput.classList.toggle("is-valid",t),this.linkInput.classList.remove("error")}),this.linkBackButton.addEventListener("mousedown",e=>{Object(f.a)(e),this.container.classList.remove("is-link"),this.resetSelection(),this.setTooltipPosition(),this.cancelClosening()}),this.linkApplyButton=Qs("check markup-tooltip-link-apply",{noRipple:!0}),this.linkApplyButton.addEventListener("mousedown",e=>{this.applyLink(e)});const s=document.createElement("div");s.classList.add("markup-tooltip-link-apply-container");const i=document.createElement("span"),n=document.createElement("span"),a=document.createElement("span");i.classList.add("markup-tooltip-delimiter"),n.classList.add("markup-tooltip-delimiter"),a.classList.add("markup-tooltip-delimiter"),e.insertBefore(i,this.buttons.link),s.append(a,this.linkApplyButton),t.append(this.linkBackButton,n,this.linkInput,s),this.wrapper.append(e,t),this.container.append(this.wrapper),document.body.append(this.container),window.addEventListener("resize",()=>{this.hide()})}showLinkEditor(){this.container&&this.container.classList.contains("is-visible")||this.show();const e=this.buttons.link;this.container.classList.add("is-link");const t=document.getSelection();if(this.savedRange=t.getRangeAt(0),e.classList.contains("active")){const e=this.savedRange.startContainer.parentElement;this.linkInput.value=e.href}else this.linkInput.value="";this.setTooltipPosition(!0),setTimeout(()=>{this.linkInput.focus()},200),this.linkInput.classList.toggle("is-valid",this.isLinkValid())}applyLink(e){Object(f.a)(e),this.resetSelection();let t=this.linkInput.value;t&&!N.b.matchUrlProtocol(t)&&(t="https://"+t),this.appImManager.chat.input.applyMarkdown("link",t),setTimeout(()=>{this.hide()},0)}isLinkValid(){return!this.linkInput.value.length||!!N.b.matchUrl(this.linkInput.value)}resetSelection(e=this.savedRange){const t=window.getSelection();t.removeAllRanges(),t.addRange(e),this.appImManager.chat.input.messageInput.focus()}hide(){this.init||(this.container.classList.remove("is-visible"),document.removeEventListener("mouseup",this.onMouseUpSingle),this.waitingForMouseUp=!1,Nt.a.removeByType("markup"),this.hideTimeout&&clearTimeout(this.hideTimeout),this.hideTimeout=window.setTimeout(()=>{this.hideTimeout=void 0,this.container.classList.add("hide"),this.container.classList.remove("is-link")},200))}getActiveMarkupButton(){const e=ud(),t=[...new Set(e.map(e=>e.parentNode))],s=new Set;return t.forEach(e=>{for(const t in Ul.b){const i=Ul.b[t];e.closest(i.match+", [contenteditable]")!==this.appImManager.chat.input.messageInput&&s.add(this.buttons[t])}}),[...s]}setActiveMarkupButton(){const e=this.getActiveMarkupButton();for(const t in this.buttons){const s=this.buttons[t];s.classList.toggle("active",e.includes(s))}}setTooltipPosition(e=!1){const t=document.getSelection().getRangeAt(0),s=document.body.getBoundingClientRect(),i=t.getBoundingClientRect(),n=this.appImManager.chat.input.rowsWrapper.getBoundingClientRect();this.container.style.maxWidth=n.width+"px";const a=i.top+-1*s.top,o=(this.container.classList.contains("is-link")?this.wrapper.lastElementChild:this.wrapper.firstElementChild).getBoundingClientRect(),r=a-o.height-8,l=n.left,d=n.left+n.width-Math.min(n.width,o.width);let c;if(e){const e=this.container.getBoundingClientRect();c=Object(ds.a)(e.left,l,d)}else{const e=i.left+(i.width-o.width)/2;c=Object(ds.a)(e,l,d)}this.container.style.transform=`translate3d(${c}px, ${r}px, 0)`}show(){if(this.init&&(this.init(),this.init=null),fl())return void this.hide();if(void 0!==this.hideTimeout&&clearTimeout(this.hideTimeout),this.container.classList.contains("is-visible"))return;this.setActiveMarkupButton(),this.container.classList.remove("is-link");const e=this.container.classList.contains("hide");e&&(this.container.classList.remove("hide"),this.container.classList.add("no-transition")),this.setTooltipPosition(),e&&(this.container.offsetLeft,this.container.classList.remove("no-transition")),this.container.classList.add("is-visible"),C.IS_MOBILE||Nt.a.pushItem({type:"markup",onPop:()=>{this.hide()}})}setMouseUpEvent(){this.waitingForMouseUp||(this.waitingForMouseUp=!0,document.addEventListener("mouseup",this.onMouseUpSingle,{once:!0}))}cancelClosening(){Ht.IS_TOUCH_SUPPORTED&&!C.IS_APPLE&&(document.removeEventListener("mouseup",this.onMouseUpSingle),document.addEventListener("mouseup",e=>{Object(f.a)(e),this.mouseUpCounter=1,this.waitingForMouseUp=!1,this.setMouseUpEvent()},{once:!0}))}handleSelection(){this.addedListener||(this.addedListener=!0,document.addEventListener("selectionchange",e=>{if(document.activeElement===this.linkInput)return;if(document.activeElement!==this.appImManager.chat.input.messageInput)return void this.hide();const t=document.getSelection();if(fl(t))this.hide();else if(Ht.IS_TOUCH_SUPPORTED)if(C.IS_APPLE)this.show(),this.setTooltipPosition();else{if(2===this.mouseUpCounter)return void(this.mouseUpCounter=0);this.savedRange=t.getRangeAt(0),this.setMouseUpEvent()}else this.setMouseUpEvent()}))}}class gd{constructor(e,t){let s;this.options=t,this.onDragOver=e=>{this.container.classList.add("is-dragover")},this.onDragLeave=e=>{this.container.classList.remove("is-dragover")},this.onDrop=e=>{this.options.onDrop(e)},this.container=document.createElement("div"),this.container.classList.add("drop","z-depth-1"),this.outlineWrapper=document.createElement("div"),this.outlineWrapper.classList.add("drop-outline-wrapper"),this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.classList.add("drop-outline"),this.path=document.createElementNS("http://www.w3.org/2000/svg","path"),this.path.classList.add("drop-outline-path"),t.icon&&(s=document.createElement("div"),s.classList.add("drop-icon","tgico-"+t.icon));const i=document.createElement("div");let n;i.classList.add("drop-header"),i.append(Object(O.i18n)(t.header,t.headerArgs)),t.subtitle&&(n=document.createElement("div"),n.classList.add("drop-subtitle"),n.append(Object(O.i18n)(t.subtitle))),this.svg.append(this.path),this.outlineWrapper.append(this.svg),this.container.append(...[this.outlineWrapper,s,i,n].filter(Boolean)),e.append(this.container),this.container.addEventListener("dragover",this.onDragOver),this.container.addEventListener("dragleave",this.onDragLeave),this.container.addEventListener("drop",this.onDrop)}destroy(){delete this.options,this.container.remove(),this.container.removeEventListener("dragover",this.onDragOver),this.container.removeEventListener("dragleave",this.onDragLeave),this.container.removeEventListener("drop",this.onDrop)}setPath(){const e=this.outlineWrapper.getBoundingClientRect();this.svg.setAttributeNS(null,"preserveAspectRatio","none"),this.svg.setAttributeNS(null,"viewBox",`0 0 ${e.width} ${e.height}`),this.svg.setAttributeNS(null,"width",""+e.width),this.svg.setAttributeNS(null,"height",""+e.height);const t=Zn(5,5,e.width-10,e.height-10,10,10,10,10);this.path.setAttributeNS(null,"d",t)}}function md(e){e.forEach(e=>e.classList.add("no-transition")),Object(g.a)().then(()=>{e.forEach(e=>e.classList.remove("no-transition"))})}var fd,vd=s(197);class bd extends ni{constructor(e,t){super("popup-join-chat-invite",ai([{langKey:t.pFlags.broadcast?"JoinByPeekChannelTitle":"JoinByPeekGroupTitle",callback:()=>{F.a.invokeApi("messages.importChatInvite",{hash:e}).then(e=>{Ie.processUpdateMessage(e);const t=e.chats[0].id.toPeerId(!0);H.default.dispatchEvent("history_focus",{peerId:t})})}}]),{closable:!0,overlayClosable:!0,body:!0}),this.header.remove();const s=new Od;s.setAttribute("dialog","0"),s.classList.add("avatar-100"),"photo"===t.photo._?(t.photo=Dt.savePhoto(t.photo),Oa({container:s,message:null,photo:t.photo,boxHeight:100,boxWidth:100,withoutPreloader:!0}),s.style.width=s.style.height=""):jt.putPhoto(s,Z.b,!1,t.title);const i=document.createElement("div");i.classList.add("chat-title"),Object(xe.a)(i,N.b.wrapEmojiText(t.title));const n=t.pFlags.broadcast,a=Object(O.i18n)(n?"Subscribers":"Members",[t.participants_count]);a.classList.add("chat-participants-count"),this.body.append(s,i,a)}}!function(e){e[e.MESSAGE=0]="MESSAGE",e[e.PRIVATE_POST=1]="PRIVATE_POST",e[e.STICKER_SET=2]="STICKER_SET",e[e.JOIN_CHAT=3]="JOIN_CHAT"}(fd||(fd={}));var yd=s(189),wd=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};const Sd="chat",Id=Ht.IS_TOUCH_SUPPORTED?"touchstart":"mousemove";var Md;!function(e){e[e.CHATLIST=0]="CHATLIST",e[e.CHAT=1]="CHAT",e[e.PROFILE=2]="PROFILE"}(Md||(Md={}));const Cd=new class{constructor(){this.columnEl=document.getElementById("column-center"),this.offline=!1,this.updateStatusInterval=0,this.setPeerPromise=null,this.chats=[],this.isProcessingKeyEvent=!1,this.onHashChange=e=>{try{this.onHashChangeUnsafe(e)}catch(e){this.log.error("hash change error",e)}},this.onHashChangeUnsafe=(e=!0)=>{const t=location.hash;e||Nt.a.replaceState();const s=t.split("?"),i=this.parseUriParams(t,s);if(this.log("hashchange",t,s[0],i),t)if(i.tgaddr)this.openUrl(i.tgaddr);else switch(s[0]){default:i.p=s[0].slice(1);case"#/im":{if(!Object.keys(i).length)break;let e=i.p;"/"===e[e.length-1]&&(e=e.slice(0,e.length-1));const t=void 0!==i.post?+i.post:void 0,s=t||(void 0!==i.message?+i.message:void 0),n=void 0!==i.thread?+i.thread:void 0;switch(e[0]){case"@":this.openUsername({userName:e,lastMsgId:s,threadId:n});break;default:{const i=t?e.toPeerId(!0):e.toPeerId(),a=Te.getPeer(i);this.op({peer:a,lastMsgId:s,threadId:n});break}}}}},this.setSettings=()=>{document.documentElement.style.setProperty("--messages-text-size",H.default.settings.messagesTextSize+"px"),document.body.classList.toggle("animation-level-0",!H.default.settings.animationsEnabled),document.body.classList.toggle("animation-level-1",!1),document.body.classList.toggle("animation-level-2",H.default.settings.animationsEnabled),this.chatsSelectTabDebounced=Zi(()=>{const e=this.chat.topbar;e.pinnedMessage&&e.pinnedMessage.setCorrectIndex(0),F.a.setQueueId(this.chat.bubbles.lazyLoadQueue.queueId)},H.default.settings.animationsEnabled?250:0,!1,!0),pi.b.setLoop(H.default.settings.stickers.loop),zs.a.checkAnimations(!1);for(const e of this.chats)e.setAutoDownloadMedia();O.default.setTimeFormat(H.default.settings.timeFormat)},this.onDocumentPaste=(e,t)=>{const s=El();if(this.canDrag()||s){if(e instanceof DragEvent){const t=e.dataTransfer.types;(t.contains?t.contains("Files"):t.indexOf("Files")>=0)&&Object(f.a)(e)}T(e).then(e=>{if(e.length){if(s)return void s.addFiles(e);const i=this.chat.input;i.willAttachType=t||(Bs.has(e[0].type)?"media":"document"),new _l(this.chat,e,i.willAttachType)}})}},Ie.attach(),Cs.start(),this.log=Object(i.b)("IM",i.a.Log|i.a.Warn|i.a.Debug|i.a.Error),this.backgroundPromises={},ve.STATE_INIT.settings.themes.forEach(e=>{if(e.background.slug){const t="assets/img/"+e.background.slug+".svg"+(C.IS_FIREFOX?"?1":"");this.backgroundPromises[e.background.slug]=Promise.resolve(t)}}),this.selectTab(Md.CHATLIST),window.addEventListener("blur",()=>{zs.a.checkAnimations(!0),this.offline=H.default.idle.isIDLE=!0,this.updateStatus(),clearInterval(this.updateStatusInterval),H.default.dispatchEvent("idle",H.default.idle.isIDLE),window.addEventListener("focus",()=>{this.offline=H.default.idle.isIDLE=!1,this.updateStatus(),this.updateStatusInterval=window.setInterval(()=>this.updateStatus(),5e4),zs.a.checkAnimations(!1),H.default.dispatchEvent("idle",H.default.idle.isIDLE)},{once:!0})}),window.addEventListener(Id,()=>{this.updateStatusInterval=window.setInterval(()=>this.updateStatus(),5e4),this.updateStatus(),this.offline=H.default.idle.isIDLE=!1,H.default.dispatchEvent("idle",H.default.idle.isIDLE)},{once:!0,passive:!0}),H.default.addEventListener("im_mount",()=>{this.applyCurrentTheme()}),this.chatsContainer=document.createElement("div"),this.chatsContainer.classList.add("chats-container","tabs-container"),this.chatsContainer.dataset.animation="navigation",this.columnEl.append(this.chatsContainer),this.createNewChat(),this.chatsSelectTab(this.chat.container),Nt.a.onHashChange=this.onHashChange,this.setSettings(),H.default.addEventListener("settings_updated",this.setSettings),Object(it.a)(()=>{zs.a.setOnlyOnePlayableGroup("lock"),zs.a.checkAnimations(!0)},()=>{zs.a.setOnlyOnePlayableGroup(""),zs.a.checkAnimations(!1)}),C.IS_FIREFOX&&ve.default.oldVersion&&-1===Object(yd.a)(ve.default.oldVersion,"1.4.3")?this.deleteFilesIterative(e=>"image/svg+xml"===e.headers.get("Content-Type")).then(()=>{this.applyCurrentTheme()}):this.applyCurrentTheme(),this.applyDirection(),I.b.addEventListener("changeScreen",(e,t)=>{document.body.classList.contains("is-left-column-shown")&&document.body.classList.contains("is-right-column-shown")&&pa.toggleSidebar(!1)}),I.b.addEventListener("resize",()=>{const e=this.chatsContainer.getBoundingClientRect();cd.resizeInstances(e.width,e.height)}),H.default.addEventListener("history_focus",e=>{let{peerId:t,threadId:s,mid:i}=e;s&&(s=as.generateMessageId(s)),i&&(i=as.generateMessageId(i)),this.setInnerPeer(t,i,s?"discussion":void 0,s)}),H.default.addEventListener("peer_changing",e=>{this.saveChatPosition(e)}),H.default.addEventListener("theme_change",()=>{this.applyCurrentTheme()}),H.default.addEventListener("choosing_sticker",e=>{this.setChoosingStickerTyping(!e)}),H.default.addEventListener("peer_title_edit",e=>{var t;(null===(t=this.chat)||void 0===t?void 0:t.peerId)===e&&void 0!==this.tabId&&this.overrideHash(e)}),H.default.addEventListener("instance_deactivated",()=>{const e=new ni("popup-instance-deactivated",void 0,{overlayClosable:!0}),t=document.createElement("div");t.classList.add("instance-deactivated-container"),e.container.replaceWith(t);const s=document.createElement("div");s.classList.add("header"),s.append(Object(O.i18n)("Deactivated.Title"));const i=document.createElement("div");i.classList.add("subtitle"),i.append(Object(O.i18n)("Deactivated.Subtitle")),t.append(s,i),document.body.classList.add("deactivated"),e.onClose=()=>{document.body.classList.add("deactivated-backwards"),vd.a.activateInstance(),setTimeout(()=>{document.body.classList.remove("deactivated","deactivated-backwards")},333)},e.show()}),H.default.addEventListener("peer_changed",e=>wd(this,void 0,void 0,(function*(){document.body.classList.toggle("has-chat",!!e),this.overrideHash(e)}))),ss.a.get("chatPositions").then(e=>{ss.a.setToCache("chatPositions",e||{})}),vd.a.activateInstance();const e=()=>{Qe.default.setAuthorized(!0)};setInterval(e,S.a),e(),this.addAnchorListener({name:"showMaskedAlert",callback:(e,t)=>{const s=t.href;let i=t.dataset.originalUrl||s;const n=t.cloneNode(!0);n.className="anchor-url",n.innerText=i,n.removeAttribute("onclick"),new en("popup-masked-url",{titleLangKey:"OpenUrlTitle",descriptionLangKey:"OpenUrlAlert2",descriptionLangArgs:[n],buttons:[{langKey:"Open",callback:()=>{console.log("[showMaskedAlert] Opening URL:",n.href),console.log("[showMaskedAlert] URL starts with search.eitaa.com?",n.href.startsWith("https://search.eitaa.com/?url=")),n.click()}}]}).show()}}),this.addAnchorListener({name:"execBotCommand",callback:({uriParams:e})=>{const{command:t,bot:s}=e;js.sendText(this.chat.peerId,"/"+t+(s?"@"+s:""))}}),this.addAnchorListener({name:"searchByHashtag",callback:({uriParams:e})=>{const{hashtag:t}=e;t&&this.chat.initSearch("#"+t+" ")}}),this.addAnchorListener({name:"addstickers",callback:({pathnameParams:e})=>{const t={_:fd.STICKER_SET,set:e[1]};this.processInternalLink(t)}}),this.addAnchorListener({name:"joinchat",callback:({pathnameParams:e})=>{const t={_:fd.JOIN_CHAT,invite:e[1]||decodeURIComponent(e[0]).slice(1)};this.processInternalLink(t)}}),this.addAnchorListener({name:"im",callback:({pathnameParams:e,uriParams:t})=>wd(this,void 0,void 0,(function*(){let s;s="c"===e[0]?{_:fd.PRIVATE_POST,channel:e[1],post:e[2],thread:"thread"in t?t.thread:void 0,comment:t.comment}:{_:fd.MESSAGE,domain:e[0],post:e[1],comment:t.comment},this.processInternalLink(s)}))}),this.addAnchorListener({name:"resolve",protocol:"et",callback:({uriParams:e})=>{let t;"telegrampassport"===e.domain||(t=this.makeLink(fd.MESSAGE,e)),this.processInternalLink(t)}}),this.addAnchorListener({name:"privatepost",protocol:"et",callback:({uriParams:e})=>{const t=this.makeLink(fd.PRIVATE_POST,e);this.processInternalLink(t)}}),this.addAnchorListener({name:"addstickers",protocol:"et",callback:({uriParams:e})=>{const t=this.makeLink(fd.STICKER_SET,e);this.processInternalLink(t)}}),this.addAnchorListener({name:"joinchat",protocol:"et",callback:({uriParams:e})=>{const t=this.makeLink(fd.JOIN_CHAT,e);this.processInternalLink(t)}}),this.onHashChange(!0),this.attachKeydownListener()}get myId(){return H.default.myId}get chat(){return this.chats[this.chats.length-1]}deleteFilesIterative(e){return st.cacheStorage.timeoutOperation(t=>{const s=performance.now();return t.keys().then(s=>{const i=s.map(s=>t.match(s).then(t=>e(t)));return Promise.all(i).then(e=>(e.map((e,i)=>{if(!e)return;const n=s[i];return t.delete(n)}),Promise.all(e.filter(Boolean))))}).then(()=>{this.log("deleted files",performance.now()-s)})})}attachKeydownListener(){const e=new Set(["PageUp","PageDown","Meta","Control"]);document.body.addEventListener("keydown",t=>{var s;if(this.isProcessingKeyEvent)return;const i=t.key;if(H.default.isOverlayActive||e.has(i))return;const n=t.target,a=this.chat;if("KeyC"!==t.code||!t.ctrlKey&&!t.metaKey||"INPUT"===n.tagName){if(!t.altKey||"ArrowUp"!==i&&"ArrowDown"!==i)if("ArrowUp"===i){if(this.isProcessingKeyEvent=!0,a.input.editMsgId||!a.input.isInputEmpty())return;{const e=js.getHistoryStorage(a.peerId,a.threadId).history.slice;if(e.isEnd(Y.Bottom)&&e.length){let s;for(const t of e){const e=a.getMessage(t);if((this.myId===a.peerId?e.fromId===this.myId:e.pFlags.out)&&js.canEditMessage(a.getMessage(t),"text")){s=t;break}}s&&(a.input.initMessageEditing(s),Object(f.a)(t))}}}else{if("ArrowDown"===i)return;"0"===t.key&&t.ctrlKey&&(location.hash=String(H.default.myId))}else{this.isProcessingKeyEvent=!0;const e=js.dialogsStorage.getFolderDialogs(H.default.filterId,!0);let t;if(H.default.peerId){const s=e.findIndex(e=>e.peerId===H.default.peerId);if(-1!==s){t=e["ArrowUp"===i?s-1:s+1]}}else"ArrowDown"===i&&(t=e[0]);t&&this.setPeer(t.peerId.toPeerId())}if((null===(s=null==a?void 0:a.input)||void 0===s?void 0:s.messageInput)&&t.target!==a.input.messageInput&&"INPUT"!==n.tagName&&!n.hasAttribute("contenteditable")&&!Ht.IS_TOUCH_SUPPORTED&&(!I.b.isMobile||this.tabId===Md.CHAT)&&!a.selection.isSelecting&&!a.input.recording){a.input.messageInput.focus(),Object(Cl.a)(a.input.messageInput);const e=new KeyboardEvent(t.type,t);a.input.messageInput.dispatchEvent(e)}this.isProcessingKeyEvent&&setTimeout(()=>{this.isProcessingKeyEvent=!1},200)}})}makeLink(e,t){return Object.assign({_:e},t)}processInternalLink(e){return wd(this,void 0,void 0,(function*(){switch(null==e?void 0:e._){case fd.MESSAGE:{const t=e.post?as.generateMessageId(+e.post):void 0,s=e.comment?as.generateMessageId(+e.comment):void 0;this.openUsername({userName:e.domain,lastMsgId:t,threadId:void 0,commentId:s});break}case fd.PRIVATE_POST:{const t=e.channel.toChatId(),s=t.toPeerId(!0);if(Pe.getChat(t).deleted)try{yield Pe.resolveChannel(t)}catch(e){throw $t({langPackKey:"LinkNotFound"}),e}const i=as.generateMessageId(+e.post),n=e.thread?as.generateMessageId(+e.thread):void 0;n?this.openThread(s,i,n):this.setInnerPeer(s,i);break}case fd.STICKER_SET:new Lr({id:e.set}).show();break;case fd.JOIN_CHAT:F.a.invokeApi("messages.checkChatInvite",{hash:e.invite}).then(t=>{t.chat&&Pe.saveApiChat(t.chat,!0),"chatInviteAlready"!==t._&&"chatInvitePeek"!==t._?new bd(e.invite,t).show():this.setInnerPeer(t.chat.id.toPeerId(!0))},e=>{"INVITE_HASH_EXPIRED"===e.type&&Qt(Object(O.i18n)("InviteExpired"))});break;default:this.log.warn("Not supported internal link:",e)}}))}addAnchorListener(e){window[(e.protocol?e.protocol+"_":"")+e.name]=t=>{var s;Object(f.a)(null);const i=null===(s=null==t?void 0:t.dataset)||void 0===s?void 0:s.originalUrl,n=(null==t?void 0:t.href)||"",a=i||n;if(!a)return!1;let o,r;e.noPathnameParams||(o=new URL(a).pathname.split("/").slice(1)),e.noUriParams||(r=this.parseUriParams(a));const l=e.callback({pathnameParams:o,uriParams:r},t);return void 0===l&&l}}parseUriParams(e,t=e.split("?")){const s={};return t[1]?(t[1].split("&").forEach(e=>{s[e.split("=")[0]]=decodeURIComponent(e.split("=")[1])}),s):s}openUrl(e){const{url:t,onclick:s}=N.b.wrapUrl(e);if(!s)return;const i=document.createElement("a");return i.href=t,window[s](i)}openUsername(e){const{userName:t}=e;return ye.resolveUsername(t).then(t=>this.op(Object.assign({peer:t},e)),e=>{"USERNAME_NOT_OCCUPIED"===e.type?$t({langPackKey:"NoUsernameFound"}):"USERNAME_INVALID"===e.type&&$t({langPackKey:"Alert.UserDoesntExists"})})}op(e){return wd(this,void 0,void 0,(function*(){const t="user"===e.peer._||void 0===e.peer._;e.peer._;let s=e.peer.id.toPeerId(!t);yield Promise.all(["commentId","lastMsgId","threadId"].map(t=>wd(this,void 0,void 0,(function*(){e[t]&&(e[t]=as.generateMessageId(e[t]))}))));const i=e.peer.migrated_to;if(i){const t=i.channel_id;e.peer=yield Pe.getChat(t),s=t.toPeerId(!0)}return this.setInnerPeer(s,e.lastMsgId,e.type,e.threadId)}))}openThread(e,t,s){return js.wrapSingleMessage(e,s).then(()=>{const i=js.getMessageByPeer(e,s);return js.generateThreadServiceStartMessage(i),this.setInnerPeer(e,t,"discussion",s)})}openComment(e,t,s){return js.getDiscussionMessage(e,t).then(e=>this.openThread(e.peerId,s,e.mid))}setCurrentBackground(e=!0){const t=H.default.getTheme();if(t.background.slug){const s=ve.AppStateManager.STATE_INIT.settings.themes.find(e=>e.name===t.name);return this.getBackground(t.background.slug).then(t=>this.setBackground(t,e),()=>(t.background=Object(m.a)(s.background),this.setCurrentBackground(!0)))}return this.setBackground("",e)}getBackground(e){return this.backgroundPromises[e]?this.backgroundPromises[e]:this.backgroundPromises[e]=st.cacheStorage.getFile("backgrounds/"+e).then(e=>URL.createObjectURL(e))}setBackground(e,t=!0){this.lastBackgroundUrl=e;const s=this.chats.map(t=>t.setBackground(e));return s[s.length-1].then(()=>{t&&H.default.dispatchEvent("background_change")})}saveChatPosition(e){if(!["chat","discussion"].includes(e.type)||!e.peerId)return;const t=e.bubbles,s=t.scrollable.scrollTop,i=e.peerId+(e.threadId?"_"+e.threadId:""),n=ss.a.getFromCache("chatPositions");if(t.scrollable.getDistanceToEnd()<=16&&t.scrollable.loadedAll.bottom||!Object.keys(t.bubbles).length)delete n[i],this.log("deleted chat position");else{const e={mids:Object(m.e)(t.bubbles,"desc"),top:s};n[i]=e,this.log("saved chat position:",e)}ss.a.set({chatPositions:n},!0)}getChatSavedPosition(e){if(!["chat","discussion"].includes(e.type)||!e.peerId)return;const t=e.peerId+(e.threadId?"_"+e.threadId:""),s=ss.a.getFromCache("chatPositions");return s&&s[t]}applyHighlightningColor(){let e;const t=H.default.getTheme();t.background.highlightningColor?(e=t.background.highlightningColor,document.documentElement.style.setProperty("--message-highlightning-color",e)):document.documentElement.style.removeProperty("--message-highlightning-color"),!Ht.IS_TOUCH_SUPPORTED&&e&&(H.default.themeColor=function(e){return Ho(e).slice(0,-2)}(e))}applyCurrentTheme(e,t,s){return this.applyHighlightningColor(),H.default.setTheme(),t&&(this.backgroundPromises[e]=Promise.resolve(t)),this.setCurrentBackground(void 0===s?!!e:s)}applyDirection(){"rtl"===H.default.getDirection().name?(document.documentElement.dir="rtl",document.documentElement.classList.add("is-rtl")):(document.documentElement.dir="ltr",document.documentElement.classList.remove("is-rtl"))}chatsSelectTab(e,t){if(this.prevTab!==e){if(!1===t&&this.prevTab&&md([e,this.prevTab].filter(Boolean)),this.prevTab){this.prevTab.classList.remove("active"),this.chatsSelectTabDebounced(),H.default.settings.animationsEnabled&&!1!==t&&Object(it.b)(Object(M.a)(400),400);const s=Object(Na.a)(this.prevTab);Object(Na.a)(e)>s&&Nt.a.pushItem({type:"chat",onPop:e=>{this.setPeer(Z.b,void 0,e),Object(si.a)()}})}e.classList.add("active"),this.prevTab=e}}init(){document.addEventListener("paste",this.onDocumentPaste,!0),document.addEventListener("copy",e=>{ud().some(t=>{let s=t;return t.nodeType!==t.ELEMENT_NODE&&(s=t.parentElement),!!Object(ti.a)(s,"no-forwards")&&(e.preventDefault(),!0)})}),Ht.IS_TOUCH_SUPPORTED||this.attachDragAndDropListeners(),this.markupTooltip=new pd(this),this.markupTooltip.handleSelection()}attachDragAndDropListeners(){const e=[],t=[];let s=!1;const i=(r,l)=>wd(this,void 0,void 0,(function*(){if(l===s)return;const d=r.dataTransfer.types,c=d.contains?d.contains("Files"):d.indexOf("Files")>=0,h=El();if(!c||!this.canDrag()&&!h)return void(n=0);const u=h?o:a,g=h?t:e;if(l&&!g.length){const e=yield T(r,!0),t=c&&!e.length,s=e.filter(e=>Bs.has(e)).length;this.log("drag files",e),h?(h.appendDrops(u),(e.length||t)&&g.push(new gd(u,{header:"Preview.Dragging.AddItems",headerArgs:[e.length],onDrop:e=>{i(e,!1),Cd.log("drop",e),Cd.onDocumentPaste(e,"document")}}))):((e.length||t)&&g.push(new gd(u,{icon:"dragfiles",header:"Chat.DropTitle",subtitle:"Chat.DropAsFilesDesc",onDrop:e=>{i(e,!1),Cd.log("drop",e),Cd.onDocumentPaste(e,"document")}})),(s||t)&&g.push(new gd(u,{icon:"dragmedia",header:"Chat.DropTitle",subtitle:"Chat.DropQuickDesc",onDrop:e=>{i(e,!1),Cd.log("drop",e),Cd.onDocumentPaste(e,"media")}})),this.chat.container.append(u))}Object(p.a)(u,"is-visible",l,200,()=>{l||(g.forEach(e=>{e.destroy()}),g.length=0)}),l?g.forEach(e=>{e.setPath()}):n=0,document.body.classList.toggle("is-dragging",l),s=l}));let n=0;document.body.addEventListener("dragenter",e=>{n++}),document.body.addEventListener("dragover",e=>{i(e,!0),Object(f.a)(e)}),document.body.addEventListener("dragleave",e=>{n--,0===n&&i(e,!1)});const a=document.createElement("div");a.classList.add("drops-container");const o=a.cloneNode(!0)}canDrag(){var e;const t=null===(e=this.chat)||void 0===e?void 0:e.peerId;return!(!t||H.default.isOverlayActive||!js.canSendToPeer(t,this.chat.threadId,"send_media"))}overrideHash(e){return wd(this,void 0,void 0,(function*(){let t;if(e){const s=Te.getPeerUsername(e);t=s?"@"+s:""+e}Nt.a.overrideHash(t)}))}selectTab(e,t){var s;!1===t&&md([wr.sidebarEl,this.columnEl,pa.sidebarEl]),document.body.classList.toggle("is-left-column-shown",0===e);const i=this.tabId;void 0!==i&&this.overrideHash(e>Md.CHATLIST?null===(s=this.chat)||void 0===s?void 0:s.peerId:void 0),this.log("selectTab",e,i);let n=H.default.settings.animationsEnabled?Object(g.a)():Promise.resolve();if(void 0!==i&&i!==e&&H.default.settings.animationsEnabled&&!1!==t){const e=100+(I.b.isMobile?250:200);n=Object(M.a)(e),Object(it.b)(n,e)}return this.tabId=e,Object(si.a)(),I.b.isMobile&&2===i&&e<2&&document.body.classList.remove("is-right-column-shown"),void 0!==i&&e>i&&(e<2||!Nt.a.findItemByType("im"))&&Nt.a.pushItem({type:"im",onPop:e=>{this.setPeer(Z.b,void 0,e)}}),H.default.dispatchEvent("im_tab_change",e),n}updateStatus(){return this.myId?(ye.setUserStatus(this.myId,this.offline),F.a.invokeApiSingle("account.updateStatus",{offline:this.offline})):Promise.resolve()}createNewChat(){const e=new hd(this,Pe,es,Zr,js,Te,Dt,Ts,Ea,ye,Os,Ls,F.a,ls,U.a,ss.a,Cs,Rr,as);this.chats.length&&e.setBackground(this.lastBackgroundUrl,!0),this.chats.push(e)}spliceChats(e,t=!0,s,i){if(e>=this.chats.length)return;this.chat;this.chats.length>1&&t&&H.default.dispatchEvent("peer_changing",this.chat),i||(i=this.chats.splice(e,this.chats.length-e));for(let e=0;e<i.length-1;++e)Nt.a.removeByType("chat",!0);if(i.length>1&&i.slice(0,-1).forEach(e=>{e.container.remove()}),this.chatsSelectTab(this.chat.container,s),t){H.default.dispatchEvent("peer_changed",this.chat.peerId);const e=pa.getTab(rd);e&&e.close();pa.sharedMediaTab.setPeer(this.chat.peerId,this.chat.threadId)&&(pa.sharedMediaTab.loadSidebarMedia(!0),pa.sharedMediaTab.fillProfileElements())}i.forEach(e=>{e.beforeDestroy()}),setTimeout(()=>{i.forEach(e=>{e.destroy()})},350)}setPeer(e,t,s){this.init&&(this.init(),this.init=null);const i=this.chat,n=this.chats.indexOf(i);if(e){if(n>0&&i.peerId&&i.peerId!==e){const s=this.chats.splice(1,this.chats.length-1);if(this.chat.peerId===e)return void this.spliceChats(0,!0,!0,s);{const i=this.setPeer(e,t);return this.spliceChats(0,!1,!1,s),i}}}else{if(n>0)return void this.spliceChats(n,void 0,s);if(I.b.activeScreen===I.a.medium)return void this.selectTab(+!this.tabId,s)}if(e===i.peerId&&I.b.activeScreen<=I.a.medium&&document.body.classList.contains("is-left-column-shown"))return this.selectTab(Md.CHAT,s),!1;if(e||I.b.activeScreen!==I.a.mobile){const n=i.setPeer(e,t),a=(null==n?void 0:n.cached)?n.promise:Promise.resolve();e&&Promise.all([a,i.setBackgroundPromise]).then(()=>{setTimeout(()=>{setTimeout(()=>{this.chatsSelectTab(this.chat.container)},0),this.selectTab(Md.CHAT,s)},0)})}return e?void 0:(this.selectTab(Md.CHATLIST,s),!1)}setInnerPeer(e,t,s="chat",i){if(e===Z.b||!e)return;const n=this.chats.findIndex(t=>t.peerId===e&&t.type===s);if(-1!==n)return this.spliceChats(n+1),this.setPeer(e,t);return this.chat.inited&&this.createNewChat(),s&&(this.chat.setType(s),i&&(this.chat.threadId=i)),this.setPeer(e,t)}openScheduled(e){this.setInnerPeer(e,void 0,"scheduled")}getTypingElement(e){const t=document.createElement("span");let s="peer-typing";switch(t.classList.add(s),t.dataset.action=e._,e._){case"sendMessageTypingAction":s+="-text";for(let e=0;e<3;++e){const e=document.createElement("span");e.className=s+"-dot",t.append(e)}break;case"sendMessageUploadAudioAction":case"sendMessageUploadDocumentAction":case"sendMessageUploadRoundAction":case"sendMessageUploadVideoAction":case"sendMessageUploadPhotoAction":s+="-upload";break;case"sendMessageRecordAudioAction":case"sendMessageRecordRoundAction":case"sendMessageRecordVideoAction":s+="-record";break;case"sendMessageChooseStickerAction":s+="-choosing-sticker";for(let e=0;e<2;++e){const e=document.createElement("div");e.className=s+"-eye",t.append(e)}}return t.classList.add(s),t}getPeerTyping(e,t){if(!ye.isBot(e)){const s=Ts.getPeerTypings(e);if(!s||!s.length)return;const i=s[0],n={private:{sendMessageTypingAction:"Peer.Activity.User.TypingText",sendMessageUploadAudioAction:"Peer.Activity.User.SendingFile",sendMessageUploadDocumentAction:"Peer.Activity.User.SendingFile",sendMessageUploadPhotoAction:"Peer.Activity.User.SendingPhoto",sendMessageUploadVideoAction:"Peer.Activity.User.SendingVideo",sendMessageUploadRoundAction:"Peer.Activity.User.SendingVideo",sendMessageRecordVideoAction:"Peer.Activity.User.RecordingVideo",sendMessageRecordAudioAction:"Peer.Activity.User.RecordingAudio",sendMessageRecordRoundAction:"Peer.Activity.User.RecordingVideo",sendMessageGamePlayAction:"Peer.Activity.User.PlayingGame",sendMessageChooseStickerAction:"Peer.Activity.User.ChoosingSticker"},chat:{sendMessageTypingAction:"Peer.Activity.Chat.TypingText",sendMessageUploadAudioAction:"Peer.Activity.Chat.SendingFile",sendMessageUploadDocumentAction:"Peer.Activity.Chat.SendingFile",sendMessageUploadPhotoAction:"Peer.Activity.Chat.SendingPhoto",sendMessageUploadVideoAction:"Peer.Activity.Chat.SendingVideo",sendMessageUploadRoundAction:"Peer.Activity.Chat.SendingVideo",sendMessageRecordVideoAction:"Peer.Activity.Chat.RecordingVideo",sendMessageRecordAudioAction:"Peer.Activity.Chat.RecordingAudio",sendMessageRecordRoundAction:"Peer.Activity.Chat.RecordingVideo",sendMessageGamePlayAction:"Peer.Activity.Chat.PlayingGame",sendMessageChooseStickerAction:"Peer.Activity.Chat.ChoosingSticker"},multi:{sendMessageTypingAction:"Peer.Activity.Chat.Multi.TypingText1",sendMessageUploadAudioAction:"Peer.Activity.Chat.Multi.SendingFile1",sendMessageUploadDocumentAction:"Peer.Activity.Chat.Multi.SendingFile1",sendMessageUploadPhotoAction:"Peer.Activity.Chat.Multi.SendingPhoto1",sendMessageUploadVideoAction:"Peer.Activity.Chat.Multi.SendingVideo1",sendMessageUploadRoundAction:"Peer.Activity.Chat.Multi.SendingVideo1",sendMessageRecordVideoAction:"Peer.Activity.Chat.Multi.RecordingVideo1",sendMessageRecordAudioAction:"Peer.Activity.Chat.Multi.RecordingAudio1",sendMessageRecordRoundAction:"Peer.Activity.Chat.Multi.RecordingVideo1",sendMessageGamePlayAction:"Peer.Activity.Chat.Multi.PlayingGame1",sendMessageChooseStickerAction:"Peer.Activity.Chat.Multi.ChoosingSticker1"}},a=e.isUser()?n.private:s.length>1?n.multi:n.chat;let o=i.action;if(s.length>1){const e={};s.forEach(t=>{const s=t.action._;void 0===e[s]&&(e[s]=0),++e[s]}),Object.keys(e).length>1&&(o={_:"sendMessageTypingAction"})}const r=a[o._];if(!r)return;t||(t=document.createElement("span")).classList.add("online","peer-typing-container"),"sendMessageChooseStickerAction"===o._&&t.classList.add("peer-typing-flex");let l,d=t.firstElementChild;d?d.dataset.action!==o._&&d.replaceWith(this.getTypingElement(o)):(d=this.getTypingElement(o),t.prepend(d)),e.isAnyChat()&&(l=[new Oe({peerId:i.userId.toPeerId(!1),onlyFirstName:!0}).element,s.length-1]);const c=Object(O.i18n)(r,l);return c.classList.add("peer-typing-description"),t.childElementCount>1?t.lastElementChild.replaceWith(c):t.append(c),t}}getPeerStatus(e,t){var s;return wd(this,void 0,void 0,(function*(){let i;if(e){if(e.isAnyChat()){let t=this.getPeerTyping(e);if(t)return t;const s=e.toChatId(),n=yield Ts.getChatFull(s);this.chat.log("chatInfo res:",n);n.participants_count||n.participants&&n.participants.participants&&n.participants.participants.length;return i=Ts.getChatMembersString(s),i}{const n=ye.getUser(e);if(H.default.myId===e&&!t)return;if(n){if(i=ye.getUserStatusString(n.id),!ye.isBot(e)){let t=this.getPeerTyping(e);if(t||"userStatusOnline"!==(null===(s=n.status)||void 0===s?void 0:s._)||(t=document.createElement("span"),t.classList.add("online"),t.append(i)),t)return t}return i}}}}))}setPeerStatus(e,t,s,i,n,a){s&&(t.innerHTML=i?"â€Ž":"");const o=t.querySelector(".peer-typing-container");o&&this.getPeerTyping(e,o)||this.getPeerStatus(e,a).then(e=>{n()&&Object(le.a)(t,e||(i?"â€Ž":""))})}setChoosingStickerTyping(e){js.setTyping(this.chat.peerId,{_:e?"sendMessageCancelAction":"sendMessageChooseStickerAction"})}};j.a&&(j.a.appImManager=Cd);var Pd=Cd,Ld=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class Ed extends ia{constructor(){let e;super(new Hs({processItem:e=>{const t="inputMessagesFilterDocument"===this.searchContext.inputFilter._,{mid:s,peerId:i}=e,n=js.getMediaFromMessage(e);if(n&&(!t||Ed.isMediaCompatibleForDocumentViewer(n)))return{element:null,mid:s,peerId:i}}}),["delete","forward","forward-no-quote"]),this.onPrevClick=e=>{this.openMedia(this.getMessageByPeer(e.peerId,e.mid),e.element,-1)},this.onNextClick=e=>{this.openMedia(this.getMessageByPeer(e.peerId,e.mid),e.element,1)},this.onDeleteClick=()=>{const e=this.target;new $a(e.peerId,[e.mid],"chat",()=>{this.target={element:this.content.media},this.close()})},this.onForwardClick=(e="quote")=>{const t=this.target;t.mid&&new Qa({[t.peerId]:[t.mid]},()=>this.close(),!1,e)},this.onAuthorClick=e=>{const{mid:t,peerId:s}=this.target;if(t&&t!==Number.MAX_SAFE_INTEGER){const i=this.searchContext.threadId,n=this.getMessageByPeer(s,t);this.close(e).then(()=>{if(I.b.isMobile){const e=pa.getTab(ha);e&&e.close()}Pd.setInnerPeer(n.peerId,t,i?"discussion":void 0,i)})}},this.onDownloadClick=()=>{const{peerId:e,mid:t}=this.target,s=this.getMessageByPeer(e,t);if(s.media.photo)Dt.savePhotoFile(s.media.photo,Pd.chat.bubbles.lazyLoadQueue.queueId);else{let e=null;e=s.media.webpage?s.media.webpage.document:s.media.document,e&&es.saveDocFile(e,Pd.chat.bubbles.lazyLoadQueue.queueId)}},this.listLoader.onEmptied=()=>{this.close()},this.content.caption=document.createElement("div"),this.content.caption.classList.add("media-viewer-caption");const t=()=>{e&&clearTimeout(e),e=window.setTimeout(()=>{e=void 0,this.content.caption.classList.remove("is-focused")},800)};this.content.caption.addEventListener("touchstart",()=>{I.b.isMobile&&(this.content.caption.classList.add("is-focused"),e&&(clearTimeout(e),e=void 0),document.addEventListener("touchend",t,{once:!0}))});new re.b(this.content.caption).onAdditionalScroll=t,this.wholeDiv.append(this.content.caption),Object(v.b)(this.buttons.delete,this.onDeleteClick);const s=[this.btnMenuForward={icon:"forward",text:"Forward",onClick:()=>this.onForwardClick("quote")},this.btnMenuForwardNoQuote={icon:"forward",text:"Eitaa.ForwardNoQuote",onClick:()=>this.onForwardClick("no-quote")},this.btnMenuDownload={icon:"download",text:"MediaViewer.Context.Download",onClick:this.onDownloadClick},this.btnMenuDelete={icon:"delete danger",text:"Delete",onClick:this.onDeleteClick}];this.setBtnMenuToggle(s),this.setListeners()}get searchContext(){return this.listLoader.searchContext}setListeners(){super.setListeners(),this.buttons.forward.addEventListener("click",()=>this.onForwardClick("quote")),this.buttons["forward-no-quote"].addEventListener("click",()=>this.onForwardClick("no-quote")),this.author.container.addEventListener("click",this.onAuthorClick);const e=t=>{if(t.target instanceof HTMLAnchorElement){const s=t.target.getAttribute("onclick");if(!s||s.includes("showMaskedAlert"))return;return Object(f.a)(t),this.close().then(()=>{this.content.caption.removeEventListener("click",e,{capture:!0}),t.target.click()}),!1}};this.content.caption.addEventListener("click",e,{capture:!0})}getMessageByPeer(e,t){return this.searchContext.isScheduled?js.getScheduledMessageByPeer(e,t):js.getMessageByPeer(e,t)}setCaption(e){const t=e.message;let s="";t&&(s=N.b.wrapRichText(t,{entities:e.totalEntities})),Object(xe.a)(this.content.caption.firstElementChild,s),this.content.caption.classList.toggle("hide",!t)}setSearchContext(e){return this.listLoader.setSearchContext(e),this}openMedia(e,t,s=0,i=!1,n=[],a=[]){const o=Object.create(null,{_openMedia:{get:()=>super._openMedia}});var r,l,d,c,h,u;return Ld(this,void 0,void 0,(function*(){if("message"===e._&&"messageMediaLiveStream"===(null===(r=null==e?void 0:e.media)||void 0===r?void 0:r._)){if("liveStreamStateBroadcasting"===e.media.state._&&(null===(l=this.btnMenuDownload)||void 0===l||l.element.classList.add("hide")),t&&t.parentElement){const e=t.parentElement.classList;if(e.contains("live-ended")||e.contains("live-error"))return}}if(this.setMoverPromise)return this.setMoverPromise;const p=e.mid,g=e.fwd_from&&!e.fromId?e.fwd_from.from_name:e.fromId,m=js.getMediaFromMessage(e),f=!js.canForward(e),v=!js.canForwardMessage(e)||f;this.wholeDiv.classList.toggle("no-forwards",v),this.buttons.forward.classList.toggle("hide","messageService"===e._),this.buttons.forward.classList.contains("hide")||js.canForwardMessage(e)&&!f||(this.buttons.forward.classList.add("hide"),this.buttons["forward-no-quote"].classList.add("hide"),null===(d=this.btnMenuForward)||void 0===d||d.element.classList.add("hide"),null===(c=this.btnMenuForwardNoQuote)||void 0===c||c.element.classList.add("hide")),!this.buttons.download.classList.contains("hide")&&f&&(this.buttons.download.classList.add("hide"),null===(h=this.btnMenuDownload)||void 0===h||h.element.classList.add("hide"));const b=js.canDeleteMessage(e);this.buttons.delete.classList.toggle("hide",!b),null===(u=this.btnMenuDelete)||void 0===u||u.element.classList.toggle("hide",!b),this.setCaption(e),yield o._openMedia.call(this,m,e.date,g,s,t,i,n,a,e),this.target.mid=p,this.target.peerId=e.peerId}))}static isMediaCompatibleForDocumentViewer(e){return"photo"===e._||Bs.has(e.mime_type)}}var _d=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};const kd=e=>{jt.removeFromAvatarsCache(e),Array.from(document.querySelectorAll('avatar-element[peer="'+e+'"]')).forEach(e=>{e.update()})};function Td(e,t,s,i,n,a){return _d(this,void 0,void 0,(function*(){if(Te.isRestricted(t))return;let o=yield Ts.getFullPhoto(t);if(!s()||!o)return;const r=()=>Array.from(e.querySelectorAll("img")).find(e=>!e.classList.contains("emoji"))?e:null;if(t.isAnyChat()){const e=!!i,l="inputMessagesFilterChatPhotos";if(!i&&(i=yield js.getSearch({peerId:t,inputFilter:{_:l},maxId:0,limit:1}).then(e=>e.history[0]),!s()))return;if(i&&i.action){i.action.photo.id!==o.id&&(e||(i=js.generateFakeAvatarMessage(t,o)));const s=e=>e.map(e=>({element:e.element,mid:e.item.mid,peerId:e.item.peerId}));return void(new Ed).setSearchContext({peerId:t,inputFilter:{_:l}}).openMedia(i,r(),void 0,void 0,n?s(n):void 0,a?s(a):void 0)}}if(o){!Object(m.f)(i)&&i&&(o=Dt.getPhoto(i));const e=e=>e.map(e=>({element:e.element,photoId:e.item}));new oa(t).openMedia(o.id,r(),void 0,n?e(n):void 0,a?e(a):void 0)}else console.warn("[openAvatarViewer] No photo available to open")}))}H.default.addEventListener("avatar_update",kd),H.default.addEventListener("peer_title_edit",e=>{jt.isAvatarCached(e)||kd(e)});const xd=new Map,Ad=new Set;class Od extends HTMLElement{constructor(){super(...arguments),this.isDialog=!1,this.addedToQueue=!1}connectedCallback(){if(this.isDialog="1"===this.getAttribute("dialog"),""===this.getAttribute("clickable")){this.setAttribute("clickable","set");let e=!1;Object(v.b)(this,t=>_d(this,void 0,void 0,(function*(){if(Object(f.a)(t),e)return;const s=this.peerId;e=!0,yield Td(this,this.peerId,()=>this.peerId===s),e=!1})))}}disconnectedCallback(){const e=xd.get(this.peerId);e&&e.has(this)&&(e.delete(this),e.size||xd.delete(this.peerId)),this.lazyLoadQueue&&this.lazyLoadQueue.unobserve(this)}static get observedAttributes(){return["peer","dialog","peer-title"]}attributeChangedCallback(e,t,s){if("peer"===e){const e=(s||"").toPeerId()||Z.b;if(this.peerId===e)return;this.peerId=Te.getPeerMigratedTo(e)||e;const i=(t||"").toPeerId()||Z.b;if(i){const e=xd.get(i);e&&(e.delete(this),e.size||xd.delete(i))}this.update()}else"peer-title"===e?this.peerTitle=s:"dialog"===e&&(this.isDialog="1"===s)}r(e=!1){const t=jt.putPhoto(this,this.peerId,this.isDialog,this.peerTitle,e),s=t?t.loadPromise:Promise.resolve();return this.loadPromises&&(t&&t.cached&&this.loadPromises.push(s),s.finally(()=>{this.loadPromises=void 0})),t}update(){if(this.lazyLoadQueue){if(!Ad.has(this.peerId)){if(this.addedToQueue)return;this.addedToQueue=!0;let e=xd.get(this.peerId);return e||(e=new Set,xd.set(this.peerId,e)),e.add(this),this.r(!0),void this.lazyLoadQueue.push({div:this,load:()=>(Ad.add(this.peerId),this.update())})}this.addedToQueue&&this.lazyLoadQueue.unobserve(this)}Ad.add(this.peerId);const e=this.r(),t=e?e.loadPromise:Promise.resolve();this.addedToQueue&&t.finally(()=>{this.addedToQueue=!1});const s=xd.get(this.peerId);if(s){s.delete(this);const e=Array.from(s);xd.delete(this.peerId);for(let t=0,s=e.length;t<s;++t)e[t].update()}return t}}customElements.define("avatar-element",Od);class Fd{constructor(){this.onArchiveClick=()=>{let e=js.getDialogOnly(this.selectedId);e&&(js.editPeerFolders([e.peerId],+!e.folder_id),js.dialogsStorage.toggleArchivedDialog(e.peerId))},this.onPinClick=()=>{js.toggleDialogPin(this.selectedId,this.filterId).catch(e=>{"PINNED_DIALOGS_TOO_MUCH"===e.type&&(this.filterId>=1?$t({langPackKey:"PinFolderLimitReached"}):new en("pinned-dialogs-too-much",{buttons:[{langKey:"OK",isCancel:!0},{langKey:"FiltersSetupPinAlert",callback:()=>{new ir(wr).open()}}],descriptionLangKey:"PinToTopLimitReached2",descriptionLangArgs:[Object(O.i18n)("Chats",[H.default.config.pinned_dialogs_count_max])]}).show())})},this.onUnmuteClick=()=>{js.mutePeer(this.selectedId,!1)},this.onMuteClick=()=>{js.mutePeer(this.selectedId,!0)},this.onUnreadClick=()=>{const e=js.getDialogOnly(this.selectedId);e&&(e.unread_count?(js.readHistory(this.selectedId,e.top_message),js.markDialogUnread(this.selectedId,!0)):js.markDialogUnread(this.selectedId))},this.onDeleteClick=()=>{new wn(this.selectedId)},this.onContextMenu=e=>{this.init&&(this.init(),this.init=null);let t=null;try{t=Object(nn.a)(e.target,"LI")}catch(e){}if(t){if(e instanceof MouseEvent&&e.preventDefault(),this.element.classList.contains("active"))return!1;e instanceof MouseEvent&&(e.cancelBubble=!0),this.filterId=Jd.filterId,this.selectedId=t.dataset.peerId.toPeerId(),this.dialog=js.getDialogOnly(this.selectedId),this.buttons.forEach(e=>{const t=e.verify();e.element.classList.toggle("hide",!t)}),this.buttons[this.buttons.length-1].element.lastChild.replaceWith(Object(O.i18n)(Te.getDeleteButtonText(this.selectedId))),t.classList.add("menu-open"),Object(hi.e)(e,this.element),Object(hi.d)(this.element,()=>{t.classList.remove("menu-open"),this.selectedId=this.dialog=this.filterId=void 0})}}}init(){this.buttons=[{icon:"unread",text:"MarkAsUnread",onClick:this.onUnreadClick,verify:()=>!1},{icon:"readchats",text:"MarkAsRead",onClick:this.onUnreadClick,verify:()=>!1},{icon:"pin",text:"ChatList.Context.Pin",onClick:this.onPinClick,verify:()=>{const e=js.dialogsStorage.isDialogsLoaded(0);return!js.isDialogPinned(this.filterId,this.dialog)&&1!==this.filterId&&e}},{icon:"unpin",text:"ChatList.Context.Unpin",onClick:this.onPinClick,verify:()=>{const e=js.dialogsStorage.isDialogsLoaded(0);return js.isDialogPinned(this.filterId,this.dialog)&&1!==this.filterId&&e}},{icon:"mute",text:"ChatList.Context.Mute",onClick:this.onMuteClick,verify:()=>this.selectedId!==H.default.myId&&!Cs.isPeerLocalMuted(this.dialog.peerId)},{icon:"unmute",text:"ChatList.Context.Unmute",onClick:this.onUnmuteClick,verify:()=>this.selectedId!==H.default.myId&&Cs.isPeerLocalMuted(this.dialog.peerId)},{icon:"archive",text:"Archive",onClick:this.onArchiveClick,verify:()=>js.dialogsStorage.isDialogsLoaded(0)&&0===this.filterId&&this.selectedId!==H.default.myId&&333e3!==this.selectedId},{icon:"unarchive",text:"Unarchive",onClick:this.onArchiveClick,verify:()=>js.dialogsStorage.isDialogsLoaded(0)&&1===this.filterId&&this.selectedId!==H.default.myId},{icon:"delete danger",text:"Delete",onClick:this.onDeleteClick,verify:()=>!Te.canPinMessage(this.selectedId)}],this.element=Mi(this.buttons),this.element.id="dialogs-contextmenu",this.element.classList.add("contextmenu"),document.getElementById("page-chats").append(this.element)}}var Dd,jd=s(58);class Rd{constructor(e){this.hadConnect=!1,this.connecting=!1,this.timedOut=!1,this.updating=!1,this.eitaaAllowCallGetDifference=!1,this.eitaaLastCallGetDifferenceTime=0,this.eitaaUsedBackgroundDelayCallGetDifference=!1,this.setConnectionStatus=()=>{ee.a.get("dc").then(e=>{e||(e=mr.a.baseDcId),this.setFirstConnectionTimeout&&(clearTimeout(this.setFirstConnectionTimeout),this.setFirstConnectionTimeout=0);const t=H.default.connectionStatus["NET-"+e],s=t&&t.status===jd.a.Connected;this.eitaaAllowCallGetDifference=!!s,s&&!this.hadConnect&&(this.hadConnect=!0),this.timedOut=t&&t.status===jd.a.TimedOut,this.connecting=!s,this.retryAt=t&&t.retryAt,j.b&&this.log("connecting",this.connecting),this.setState()})},this.setStatusText=(e,t)=>{this.currentLangPackKey!==e&&(this.currentLangPackKey=e,Object(le.a)(this.statusEl,Object(O.i18n)(e,t)),this.statusPreloader.attach(this.statusEl))},this.setState=()=>{const e=Rd.CHANGE_STATE_DELAY;if(this.connecting)if(this.timedOut){const e=this.getA("ConnectionStatus.ForceReconnect",()=>F.a.forceReconnect());this.setStatusText("ConnectionStatus.TimedOut",[e])}else if(this.hadConnect)if(void 0!==this.retryAt){const e=document.createElement("span"),t=this.retryAt,s=()=>{const s=Date.now();e.innerText=""+Math.round((t-s)/1e3),s>t&&clearInterval(i)},i=setInterval(s,1e3);s();const n=this.getA("ConnectionStatus.Reconnect",()=>F.a.forceReconnectTimeout());this.setStatusText("ConnectionStatus.ReconnectIn",[e,n])}else this.setStatusText("ConnectionStatus.Reconnecting");else this.setStatusText("ConnectionStatus.Waiting");else this.updating&&this.setStatusText("Updating");j.b&&this.log("setState",this.connecting||this.updating),window.requestAnimationFrame(()=>{this.setStateTimeout&&clearTimeout(this.setStateTimeout);this.setStateTimeout=window.setTimeout(()=>{this.chatsContainer.insertBefore(this.statusContainer,this.chatsContainer.children[1]),Object(p.a)(this.statusContainer,"is-shown",this.connecting||this.updating,200),this.setStateTimeout=0,j.b&&this.log("setState: isShown:",this.connecting||this.updating)},e)})},this.log=Object(i.b)("CS"),this.statusContainer=document.createElement("div"),this.statusContainer.classList.add("connection-status"),this.chatsContainer=e,this.statusEl=Object(Ks.a)("btn-primary bg-warning connection-status-button",{noRipple:!0}),this.statusPreloader=new y({cancelable:!1}),this.statusPreloader.constructContainer({color:"transparent",bold:!0}),this.statusContainer.append(this.statusEl),e.prepend(this.statusContainer),H.default.addEventListener("connection_status_change",e=>{const t=e;j.b&&console.log(t),this.setConnectionStatus()}),H.default.addEventListener("state_synchronizing",e=>{e||(this.updating=!1,j.b&&this.log("updating",this.updating),this.setState())}),H.default.addEventListener("state_synchronized",e=>{const t=e;j.b&&this.log("state_synchronized",t),t||(this.updating=!1,j.b&&this.log("updating",this.updating),this.setState())}),this.setFirstConnectionTimeout=window.setTimeout(this.setConnectionStatus,Rd.CHANGE_STATE_DELAY+1e3)}eitaaCallGetDifference(){setInterval(()=>{this.eitaaAllowCallGetDifference&&this.eitaaAllowCallGetDifferenceTime()&&Ie.forceGetDifference()},1e3)}eitaaAllowCallGetDifferenceTime(){const e=Date.now(),t=H.default.config.schedule_period_foreground_ms,s=H.default.config.schedule_period_background_ms,i=H.default.config.schedule_period_background_delay_ms;return 0===this.eitaaLastCallGetDifferenceTime?(this.eitaaLastCallGetDifferenceTime=e+t,!0):document.hasFocus()&&this.eitaaLastCallGetDifferenceTime>=e+t?(this.eitaaUsedBackgroundDelayCallGetDifference=!1,this.eitaaLastCallGetDifferenceTime=e+t,!0):this.eitaaLastCallGetDifferenceTime<=e&&(document.hasFocus()?(this.eitaaUsedBackgroundDelayCallGetDifference=!1,this.eitaaLastCallGetDifferenceTime=e+t):!this.eitaaUsedBackgroundDelayCallGetDifference&&this.eitaaLastCallGetDifferenceTime>=e-i?(this.eitaaUsedBackgroundDelayCallGetDifference=!0,this.eitaaLastCallGetDifferenceTime=e+t):this.eitaaLastCallGetDifferenceTime=e+s,!0)}getA(e,t){const s=document.createElement("a");return s.classList.add("force-reconnect"),s.append(Object(O.i18n)(e)),s.addEventListener("click",e=>{Object(f.a)(e),t()}),s}}function Bd(e,t,s,i,n,a,o,r){if("number"==typeof a)a={tl:a,tr:a,br:a,bl:a};else{const e={tl:0,tr:0,br:0,bl:0};for(const t in e)a[t]=a[t]||e[t]}e.beginPath(),e.moveTo(t+a.tl,s),e.lineTo(t+i-a.tr,s),e.quadraticCurveTo(t+i,s,t+i,s+a.tr),e.lineTo(t+i,s+n-a.br),e.quadraticCurveTo(t+i,s+n,t+i-a.br,s+n),e.lineTo(t+a.bl,s+n),e.quadraticCurveTo(t,s+n,t,s+n-a.bl),e.lineTo(t,s+a.tl),e.quadraticCurveTo(t,s,t+a.tl,s),e.closePath(),o&&e.fill(),r&&e.stroke()}Rd.CHANGE_STATE_DELAY=1e3,function(e){e[e.Error=-1]="Error",e[e.Pending=0]="Pending",e[e.Sent=1]="Sent",e[e.Read=2]="Read"}(Dd||(Dd={}));const Ud=window.devicePixelRatio,Nd=20*Ud,Hd=2.5*Ud,zd=2*Ud,Wd=1*Ud;function qd(e=!1){const t=document.createElement("canvas");t.width=t.height=Nd;const s=t.getContext("2d"),i=(Nd-(3*zd+2*Hd))/2,n=Date.now();let a=!1;const o=()=>{if(t.isConnected)a||(a=t.isConnected);else if(a)return!1;const e=Date.now(),o=(r=(e-n)%1e3,l=0,d=1e3,-1/2*(Math.cos(Math.PI*r/d)-1)+l);var r,l,d;s.clearRect(0,0,Nd,Nd),s.fillStyle="#ff8100";for(let e=0;e<3;++e){let t;t=o>=.5?e%2?2-2*o:2*(o-.5):e%2?2*o:1-2*o;let n=4+8*t;n*=Ud;Bd(s,i+e*zd+e*Hd,(Nd-n)/2,zd,n,Wd,!0)}return!0};return{canvas:t,startAnimation:()=>{Object(Ia.a)(o),o()},setActive:e=>{e,o()}}}class Vd{constructor(e){this.container=document.createElement("div"),this.container.className="changelog-box",this.versionElement=document.createElement("div"),this.versionElement.className="changelog-version",this.container.appendChild(this.versionElement),this.changelogContainer=document.createElement("div"),this.changelogContainer.className="changelog-box-container",this.container.appendChild(this.changelogContainer),this.parseMarkdown(e)}parseMarkdown(e){const t=e.match(/^#\s*(.+)$/m),s=t?t[1]:"Ù†Ø³Ø®Ù‡â€ŒÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡";this.versionElement.textContent="Ù†Ø³Ø®Ù‡â€ŒÛŒ: "+s;e.replace(/^#\s*.+$/m,"").trim().split(/(?=^##\s)/gm).forEach(e=>{const t=e.match(/^##\s*(.+)$/m),s=t?t[1]:"",i=e.replace(/^##\s*.+\n/,""),n=document.createElement("h3");n.className="changelog-title",n.textContent=s,this.changelogContainer.appendChild(n);const a=document.createElement("div");a.className="changelog-content";const o=document.createElement("p");o.innerHTML=i,a.appendChild(o),this.changelogContainer.appendChild(a)})}render(e){e.appendChild(this.container)}}var Gd=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class Kd extends ni{constructor(e){super("popup-release",null,{closable:!0}),this.preloader=new y({cancelable:!1}),this.preloader.construct(),this.h6=document.createElement("h6"),Object(O._i18n)(this.h6,"NewRelease.Title"),this.btnClose.classList.remove("btn-icon"),this.header.append(this.h6),this.changelogContainer=document.createElement("div"),this.changelogContainer.className="changelog-container",this.preloader.attach(this.changelogContainer),this.container.appendChild(this.changelogContainer),this.loadChangelogs(e),this.updateButton=Object(Ks.a)("btn-primary btn-color-primary");const t=new O.default.IntlElement({key:"OK"});this.updateButton.append(t.element),this.container.appendChild(this.updateButton),Object(v.b)(this.updateButton,()=>{this.hide()},{listenerSetter:this.listenerSetter})}loadChangelogs(e){return Gd(this,void 0,void 0,(function*(){try{const t=e.map(e=>Gd(this,void 0,void 0,(function*(){const t=yield fetch(`changelogs/inPopup/${e}.md`);return yield t.text()})));(yield Promise.all(t)).forEach(e=>{new Vd(e).render(this.changelogContainer)})}catch(e){this.changelogContainer.innerText="Failed to load changelog."}finally{this.preloader.detach()}}))}}class Qd{constructor(e){this.setStatusText=(e,t)=>{this.currentLangPackKey!==e&&(this.currentLangPackKey=e,Object(le.a)(this.statusEl,Object(O.i18n)(e,t)))},this.setState=()=>{window.requestAnimationFrame(()=>{this.setStateTimeout&&clearTimeout(this.setStateTimeout);this.setStateTimeout=window.setTimeout(()=>{Object(p.a)(this.statusContainer,"is-shown",!0,200),this.setStateTimeout=0},1e3)})},this.init=()=>{this.chatsContainer.insertBefore(this.statusContainer,this.chatsContainer.children[1]),this.setState()},this.getLatestBuildVersion=()=>F.a.invokeApi("getLatestBuildVersion",{flags:0}).then(e=>(ee.a.set({lastUpdate:[Object(S.f)(),e.build_version]}),e.build_version)),this.checkForNewUpdate=()=>this.setLastBuildVersion().then(()=>!!this.lastBuildVersion&&this.lastBuildVersion>mr.a.build),this.setLastBuildVersion=()=>ee.a.get("lastUpdate").then(e=>{if(!(e&&Object(S.f)()-e[0]<864e5))return this.getLatestBuildVersion().then(e=>{this.lastBuildVersion=e});this.lastBuildVersion=e[1]}),this.statusContainer=document.createElement("div"),this.statusContainer.id="update-status",this.statusEl=document.createElement("div"),this.statusEl.classList.add("btn-primary","connection-status-button"),this.updateButton=Object(Ks.a)("update-btn"),this.setStatusText("NewRelease"),Object(O._i18n)(this.updateButton,"Update"),this.statusContainer.append(this.statusEl),this.statusEl.appendChild(this.updateButton),this.chatsContainer=e,this.updateButton.addEventListener("click",()=>{ee.a.set({isUpdating:!0}),wr.reloadApplication()}),ee.a.get("isUpdating").then(e=>{if(e&&(ee.a.delete("isUpdating"),Qd.WITH_CHANGELOG)){new Kd(Qd.LAST_VERSIONS).show()}})}}Qd.CHANGE_STATE_DELAY=1e3,Qd.LAST_VERSIONS=["4.6.10","4.6.9","4.6.8"],Qd.WITH_CHANGELOG=!1;var $d=function(e,t,s,i){return new(s||(s=Promise))((function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function r(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}l((i=i.apply(e,t||[])).next())}))};class Yd extends za{constructor(e,t,s){super({getIndex:e=>js.getDialogOnly(e)[this.indexKey],onDelete:e=>{e.dom.listEl.remove(),this.onListLengthChange&&this.onListLengthChange()},onSort:(e,t)=>{const s=e.dom.listEl.parentElement!==this.list;Ha(e.dom.listEl,this.list,t),s&&this.onListLengthChange&&this.onListLengthChange()},onElementCreate:(e,t)=>{const s=t?[]:void 0,{dom:i}=Zd.addListDialog({dialog:e.id,loadPromises:s,isBatch:t});return e.dom=i,(null==s?void 0:s.length)&&(e.loadPromises=s,Promise.all(s).finally(()=>{delete e.loadPromises})),e},updateElementWith:g.c}),this.list=e,this.indexKey=t,this.onListLengthChange=s}clear(){this.list.innerHTML="",super.clear()}}class Xd{constructor(){this.chatsContainer=document.getElementById("chatlist-container"),this.scroll=null,this.log=Object(i.b)("DIALOGS",i.a.Log|i.a.Error|i.a.Warn|i.a.Debug),this.contextMenu=new Fd,this.sortedLists={},this.scrollables={},this.folders={menu:document.getElementById("folders-tabs"),menuScrollContainer:null,container:document.getElementById("folders-container")},this.filtersRendered={},this.lastActiveElements=new Set,this.offsets={top:0,bottom:0},this.initedListeners=!1,this.loadedDialogsAtLeastOnce=!1,this.initStartedForCreateDialogs=!1,this.timeSendAdsRequest=0,this.allowSendAdsRequest=!0,this.isProcessingKeyEvent=!1,this.onTabChange=()=>{this.scroll=this.scrollables[this.filterId],this.scroll.loadedAll.top=!0,this.scroll.loadedAll.bottom=!1,this.offsets.top=this.offsets.bottom=0,this.loadDialogsPromise=void 0,this.sortedList=this.sortedLists[this.filterId],this.onChatsScroll()},this._onListLengthChange=()=>{if(!this.loadedDialogsAtLeastOnce)return;if(this.checkIfPlaceholderNeeded(),this.filterId>0)return;const e=this.chatList,t=e.childElementCount,s=e.parentElement.parentElement,i=e.parentElement.nextElementSibling,n=!!i.childElementCount;if(t>=10)return void(n&&this.removeContactsPlaceholder());if(n)return;s.classList.add("with-contacts");const a=new fr({name:"Contacts",noDelimiter:!0,fakeGradientDelimiter:!0});a.container.classList.add("hide"),ye.getContactsPeerIds(void 0,void 0,"online").then(e=>{let t=!1;const s=()=>{t&&a.container.classList.toggle("hide",!i.list.childElementCount)},i=new qa({avatarSize:42,new:!0,autonomous:!1,onListLengthChange:s});this.loadContacts=()=>{const t=mt.windowH/60|0;e.splice(0,t).filter(this.verifyPeerIdForContacts).forEach(e=>{i.add(e)}),e.length||(this.loadContacts=void 0)},this.loadContacts(),this.processContact=e=>{if(e.isAnyChat())return;const t=this.verifyPeerIdForContacts(e),s=i.has(e);!s&&t?i.add(e):s&&!t&&i.delete(e)};const n=i.list;n.classList.add("chatlist-new"),this.setListClickListener(n),a.content.append(n),t=!0,s()}),i.append(a.container)},this.verifyPeerIdForContacts=e=>e.isContact()&&!js.getDialogOnly(e),this.onChatsRegularScroll=()=>{this.sliceTimeout&&clearTimeout(this.sliceTimeout),this.sliceTimeout=window.setTimeout(()=>{this.sliceTimeout=void 0,this.chatList.childElementCount&&!this.processContact&&Object(g.c)(()=>{const e=performance.now(),t=this.scroll.scrollTop,s=this.chatList.firstElementChild,i=this.scroll.container.getBoundingClientRect(),n=s.getBoundingClientRect(),a=Array.from(this.scroll.splitUp.children);let o=this.scroll.splitUp.offsetTop;o&&t<o&&(o-=t);const r=i.y+o,l=i.y,d=Object(nn.a)(document.elementFromPoint(Math.ceil(n.x),Math.ceil(r+1)),s.tagName),c=Object(nn.a)(document.elementFromPoint(Math.ceil(n.x),Math.floor(l+i.height-1)),s.tagName);if(!d||!c)return;const h=d.getBoundingClientRect().y-r,u=[],p=a.indexOf(d),g=a.indexOf(c),m=C.IS_SAFARI?[]:a.slice(0,Math.max(0,p-10)),f=a.slice(g+10);m.length&&(this.scroll.loadedAll.top=!1),f.length&&(this.scroll.loadedAll.bottom=!1),u.push(...m),u.push(...f),u.forEach(e=>{const t=e.dataset.peerId.toPeerId();this.deleteDialog(t)}),this.setOffsets(),this.scroll.scrollTop=d.offsetTop-h,this.log("slice time",performance.now()-e)})},200)},this.onChatsScrollTop=()=>{this.onChatsScroll("top")},this.onChatsScroll=(e="bottom")=>{if(!this.scroll.loadedAll[e])return this.loadDialogsPromise?this.loadDialogsPromise:(this.log("onChatsScroll",e),this.loadDialogs(e));this.loadContacts&&this.loadContacts()},this.chatsPreloader=Object(hi.f)(null,!0),this.allUnreadCount=this.folders.menu.querySelector(".badge"),this.folders.menuScrollContainer=this.folders.menu.parentElement,this.onListLengthChange=Zi(this._onListLengthChange,100,!1,!0);const e=document.createElement("div");e.classList.add("connection-status-bottom"),e.append(this.folders.container),Ht.IS_TOUCH_SUPPORTED&&Ga({element:this.folders.container,onSwipe:e=>{const t=s.prevId();"ltr"===H.default.settings.direction?s(e>0?t+1:t-1):s(e>0?t-1:t+1)}}),this.setFilterId(0),this.addFilter({id:this.filterId,title:"",titleEl:Object(O.i18n)("ChatList.Filter.AllChats"),orderIndex:0}),this.sortedList=this.sortedLists[this.filterId],this.scroll=this.scrollables[this.filterId],H.default.addEventListener("state_cleared",()=>{ve.default.getState().then(e=>{this.loadedDialogsAtLeastOnce=!1,ye.clear(),Pe.clear();const t=js.filtersStorage.filters;for(const e in t)H.default.dispatchEvent("updateDialogFilter",{_:"updateDialogFilter",id:+e});js.clear(),this.sortedList.clear(),this.onTabChange(),this.onStateLoaded(e)})}),"night"===H.default.getTheme().name&&(this.chatsContainer.classList.add("eitaa-dialogs-toggle"),this.chatsContainer.classList.add("ads-active-toggle")),H.default.addEventListener("theme_change",()=>{"night"===H.default.settings.theme?(this.chatsContainer.classList.add("eitaa-dialogs-toggle"),this.chatsContainer.classList.add("ads-active-toggle")):(this.chatsContainer.classList.remove("eitaa-dialogs-toggle"),this.chatsContainer.classList.remove("ads-active-toggle"))});const t=new re.a(this.folders.menuScrollContainer);e.prepend(this.folders.menuScrollContainer);const s=Object(ci.a)(this.folders.menu,this.folders.container,(e,t)=>{e=+t.dataset.filterId||0,this.filterId!==e&&(this.sortedLists[e].clear(),this.setFilterId(e),this.onTabChange())},()=>{for(const e in this.sortedLists)+e!==this.filterId&&this.sortedLists[e].clear()},void 0,t);this.folders.menu.firstElementChild.click(),js.construct(),ve.default.getState().then(e=>this.onStateLoaded(e)),document.addEventListener("keydown",e=>{if(this.isProcessingKeyEvent)return;const t=e.code;if(e.altKey&&("ArrowLeft"===t||"ArrowRight"===t)){this.isProcessingKeyEvent=!0;const e=Object.entries(this.filtersRendered).length;let i=s.prevId();i+="rtl"===H.default.settings.direction?"ArrowRight"===t?-1:1:"ArrowRight"===t?1:-1,-1===i?i=0:i===e&&i--,s(i),setTimeout(()=>{this.isProcessingKeyEvent=!1},200)}});new Rd(this.chatsContainer).eitaaCallGetDifference();const n=new Qd(this.chatsContainer);n.checkForNewUpdate().then(e=>{e&&n.init()}),this.chatsContainer.append(e),setTimeout(()=>{pi.b.loadLottieWorkers()},200)}get chatList(){return this.sortedList.list}setFilterId(e){this.filterId=e,this.indexKey=js.dialogsStorage?js.dialogsStorage.getDialogIndexKey(this.filterId):"index",H.default.filterId=e}initListeners(){H.default.addEventListener("user_update",e=>{var t;const s=e.toPeerId(),i=this.getDialogDom(s);if(i&&!ye.isBot(e)&&s!==H.default.myId){const s="userStatusOnline"===(null===(t=ye.getUser(e).status)||void 0===t?void 0:t._);i.avatarEl.classList.toggle("is-online",s)}}),H.default.addEventListener("updateNewMessage",e=>{var t;const s=e.message;if("message"===s._&&"messageMediaLiveStream"===(null===(t=null==s?void 0:s.media)||void 0===t?void 0:t._)){const e=this.getDialogDom(s.peerId);if(e&&(!s.fwd_from||s.peerId!==H.default.myId)){"liveStreamStateBroadcasting"===s.media.state._?this.setCallStatus(e,!0):this.setCallStatus(e,!1)}}}),H.default.addEventListener("chat_update",e=>{const t=e.toPeerId(!0),s=js.getDialogOnly(t);s&&this.processDialogForCallStatus(s)}),H.default.addEventListener("folder_unread",e=>{this.setFilterUnreadCount(e.id)}),H.default.addEventListener("contacts_update",e=>{this.processContact&&this.processContact(e.toPeerId())}),H.default.addEventListener("dialog_flush",({peerId:e})=>{const t=js.getDialogOnly(e);t&&(this.setLastMessage(t,void 0,void 0,void 0,void 0,void 0,!0),this.validateDialogForFilter(t),this.setFiltersUnreadCount())}),H.default.addEventListener("dialogs_multiupdate",e=>{for(const t in e){const s=e[t];this.updateDialog(s),this.processContact&&this.processContact(t.toPeerId()),this.validateDialogForFilter(s)}}),H.default.addEventListener("dialog_drop",({peerId:e})=>{this.deleteDialog(e),this.processContact&&this.processContact(e)}),H.default.addEventListener("dialog_unread",({peerId:e})=>{const t=js.getDialogOnly(e);t&&(this.setUnreadMessages(t),this.validateDialogForFilter(t))}),H.default.addEventListener("dialog_notify_settings",e=>{this.setUnreadMessages(e),this.setFiltersUnreadCount()}),H.default.addEventListener("dialog_draft",({dialog:e,drop:t,peerId:s})=>{t?this.sortedList.delete(s):this.updateDialog(e),this.processContact&&this.processContact(s)}),H.default.addEventListener("peer_changed",e=>{for(const t of this.lastActiveElements)t.dataset.peerId.toPeerId()!==e&&(t.classList.remove("active"),this.lastActiveElements.delete(t));Array.from(document.querySelectorAll(`[data-autonomous="0"] li[data-peer-id="${e}"]`)).forEach(e=>{e.classList.add("active"),this.lastActiveElements.add(e)})}),H.default.addEventListener("filter_update",e=>{if(!this.filtersRendered[e.id])return void this.addFilter(e);if(e.id===this.filterId){const e=js.dialogsStorage.getCachedDialogs(!0);this.validateListForFilter();for(let t=0,s=e.length;t<s;++t){const s=e[t];this.updateDialog(s)}}const t=this.filtersRendered[e.id];Object(xe.a)(t.title,N.a.wrapEmojiText(e.title))}),H.default.addEventListener("filter_delete",e=>{const t=this.filtersRendered[e.id];t&&(this.folders.menu.firstElementChild.click(),t.container.remove(),t.menu.remove(),delete this.sortedLists[e.id],delete this.scrollables[e.id],delete this.filtersRendered[e.id],Object.keys(this.filtersRendered).length<=1&&this.folders.menuScrollContainer.classList.add("hide"))}),H.default.addEventListener("filter_order",e=>{const t=this.folders.menu;e.forEach(e=>{const s=js.filtersStorage.getFilter(e),i=this.filtersRendered[e];this.sortedLists[e].indexKey=js.dialogsStorage.getDialogIndexKey(e),Ha(i.menu,t,s.orderIndex),Ha(i.container,this.folders.container,s.orderIndex)}),this.indexKey=js.dialogsStorage.getDialogIndexKey(this.filterId)}),H.default.addEventListener("peer_typings",({peerId:e,typings:t})=>{const s=js.getDialogOnly(e);s&&(t.length?this.setTyping(s):this.unsetTyping(s))})}onStateLoaded(e){return $d(this,void 0,void 0,(function*(){Cs.getNotifyPeerTypeSettings(),this.initedListeners||(this.initListeners(),this.initedListeners=!0);const t=js.filtersStorage.getDialogFilters().then(e=>{for(const t of e)this.addFilter(t)});return e.filters&&Object.keys(e.filters).length&&(yield t,this.showFiltersPromise&&(yield this.showFiltersPromise)),ve.default.storagesResults.dialogs.length&&ls.addMissedDialogs(),this.onChatsScroll().then(()=>{js.fillConversations()})}))}getOffsetIndex(e){return{index:this.scroll.loadedAll[e]?0:this.offsets[e]}}isDialogMustBeInViewport(e){if(void 0!==e.migratedTo||!this.testDialogForFilter(e))return!1;const t=this.getOffsetIndex("top"),s=this.getOffsetIndex("bottom");if(!t.index&&!s.index)return!0;const i=e[this.indexKey];return(!t.index||i<=t.index)&&(!s.index||i>=s.index)}deleteDialog(e){this.sortedList.delete(e)}updateDialog(e){if(!this.isDialogMustBeInViewport(e))return void this.deleteDialog(e.peerId);if(!this.sortedList.has(e.peerId))return void this.sortedList.add(e.peerId);const t=this.getDialogDom(e.peerId);t&&(this.setLastMessage(e,void 0,t,void 0,void 0,void 0,!0),this.sortedList.update(e.peerId))}setFilterUnreadCount(e){var t;const s=0===e?this.allUnreadCount:null===(t=this.filtersRendered[e])||void 0===t?void 0:t.unread;if(!s)return;const i=js.dialogsStorage.getFolder(e),n=0===e||!!i.dialogs.find(e=>(e.unread_count||e.pFlags.unread_mark)&&!Cs.isPeerLocalMuted(e.peerId,!0));s.classList.toggle("badge-gray",!n);const a=i.unreadDialogsCount;s.innerText=a?""+a:""}setFiltersUnreadCount(){for(const e in this.filtersRendered)this.setFilterUnreadCount(+e);this.setFilterUnreadCount(0)}validateListForFilter(){const e=js.filtersStorage.getFilter(this.filterId)||null;this.sortedList.getAll().forEach(t=>{const s=js.getDialogOnly(t.id);this.testDialogForFilter(s,e)||this.deleteDialog(t.id)})}validateDialogForFilter(e,t){this.getDialogDom(e.peerId)&&(this.testDialogForFilter(e,t)||this.deleteDialog(e.peerId))}testDialogForFilter(e,t=js.filtersStorage.getFilter(this.filterId)){return!(!e||t&&!js.filtersStorage.testDialogForFilter(e,t)||!t&&this.filterId!==e.folder_id)}generateScrollable(e,t){const s=new re.b(null,"CL",500);s.container.addEventListener("scroll",this.onChatsRegularScroll),s.container.dataset.filterId=""+t,s.onScrolledTop=this.onChatsScrollTop,s.onScrolledBottom=this.onChatsScroll,s.setVirtualContainer(e);const i=new Yd(e,js.dialogsStorage?js.dialogsStorage.getDialogIndexKey(t):"index",this.onListLengthChange);return this.scrollables[t]=s,this.sortedLists[t]=i,s}addFilter(e){if(this.filtersRendered[e.id])return;const t=document.createElement("div");t.classList.add("menu-horizontal-div-item");const s=document.createElement("span"),i=document.createElement("span");i.classList.add("text-super"),e.titleEl?i.append(e.titleEl):Object(xe.a)(i,N.a.wrapEmojiText(e.title));const n=document.createElement("div");n.classList.add("badge","badge-20","badge-primary");const a=document.createElement("i");s.append(i,n,a),t.append(s),Object(ei.ripple)(t);Ha(t,this.folders.menu,e.orderIndex);const o=this.createChatList(),r=this.generateScrollable(o,e.id);r.container.classList.add("tabs-tab","chatlist-parts");const l=document.createElement("div");l.classList.add("chatlist-top");const d=document.createElement("div");d.classList.add("chatlist-bottom"),l.append(o),r.container.append(l,d);const c=r.container;Ha(r.container,this.folders.container,e.orderIndex),this.setListClickListener(o,null,!0),this.filtersRendered[e.id]={menu:t,container:c,unread:n,title:i},!this.showFiltersPromise&&Object.keys(this.filtersRendered).length>1&&(this.showFiltersPromise=new Promise(e=>{window.setTimeout(()=>{this.showFiltersPromise=void 0,Object.keys(this.filtersRendered).length>1&&(this.folders.menuScrollContainer.classList.remove("hide"),this.setFiltersUnreadCount()),e()},0)}))}initAdsDialogBox(e){const t=e.parentElement;if(!t||t.querySelector(".ads-dialog-box"))return;const s=document.createElement("ul");if(s.classList.add("ads-dialog-box"),t.prepend(s),this.setListClickListener(s),Xd.adsDialogs.length>0)Xd.adsDialogs.forEach(e=>{s.append(e.cloneNode(!0))});else if(this.initStartedForCreateDialogs){const e=document.querySelectorAll(".ads-dialog-box");if(e.length>0){const t=e.item(0).querySelectorAll("li[data-id]");t.length>0&&t.forEach(e=>{s.append(e.cloneNode(!0))})}}else if(!this.initStartedForCreateDialogs){this.initStartedForCreateDialogs=!0,this.createAdsDialogBox(),setInterval(()=>{this.createAdsDialogBox()},1e3);document.querySelector("#chatlist-container").addEventListener("mousedown",e=>{const t=e.target;if("A"===t.tagName.toUpperCase()&&t.classList.contains("anchor-url")){const e=t.parentElement;if(e&&e.hasAttribute("data-id")){const t={_:"adsInputAdsLocationDialog"},s={_:"statReportAdActionPerformed",statAd:{_:"statAd",id:parseInt(e.getAttribute("data-id")),adsLocation:t}};St.a.invokeApi("statReportAdActionPerformed",s).then(e=>{})}}})}}canSendAdsRequest(){return document.hasFocus()&&(this.timeSendAdsRequest-=1e3),this.timeSendAdsRequest<=0&&this.allowSendAdsRequest}createAdsDialogBox(){if(!this.canSendAdsRequest())return;this.allowSendAdsRequest=!1,this.timeSendAdsRequest=1e4;const e={flags:0,location:{_:"adsInputAdsLocationDialog"}};St.a.invokeApi("adsGetAdsPack",e).then(e=>{var t,s;this.allowSendAdsRequest=!0;const i=document.querySelectorAll(".ads-dialog-box");if(0===(null==e?void 0:e.ads.length)||"adsEmptyAd"===e.ads[0]._||!(null===(t=e.ads[0])||void 0===t?void 0:t.action)){if("adsEmptyAd"===e.ads[0]._||!(null===(s=e.ads[0])||void 0===s?void 0:s.action)){const t=e.ads[0];t.expires>0?(this.timeSendAdsRequest=1e3*t.expires,setTimeout(()=>{this.timeSendAdsRequest=0,this.createAdsDialogBox()},1e3*t.expires)):(this.timeSendAdsRequest=3e5,setTimeout(()=>{this.timeSendAdsRequest=0,this.createAdsDialogBox()},3e5))}return void i.forEach(e=>{const t=e.querySelector("li[data-id]");t&&t.remove()})}Xd.adsDialogs=[];const n=e.ads;n.forEach(e=>{this.timeSendAdsRequest=1e3*e.expire;let t=i.length;if(i.forEach(s=>{s.querySelector('li[data-id="'+e.id+'"]')&&t--}),0===t)return;i.forEach(e=>{const t=e.querySelector("li[data-id]");t&&t.remove()});const s=document.createElement("li");s.classList.add("ads-active"),s.setAttribute("data-id",""+e.id),Object(ei.ripple)(s);const n=e.action;if("adsOpenLinkAction"===n._)if(/^(?:https?:\/\/)?eitaa\.com\/(.+)/.test(n.link)){const e=document.createElement("a");e.classList.add("anchor-url"),s.append(e);const t=new URL(n.link).pathname.trim();if(t){const e=t.slice(1).split("/");if(e.length){const[t,i]=e,n=parseInt(t);isNaN(n)?s.dataset.username=t:s.dataset.peerId=String(n),i&&(s.dataset.msgId=i)}}}else s.innerHTML=`<a class="anchor-url" rel="noopener noreferrer" target="_blank" href="${n.link}"></a>`;else"adsOpenExternalLinkAction"===n._?s.innerHTML=`<a class="anchor-url" rel="noopener noreferrer" target="_blank" href="${n.link}"></a>`:"adsIntentAction"===n._&&(s.innerHTML=`<a class="anchor-url" href="tel:${n.uri}"></a>`);const a=new Od;if(a.classList.add("dialog-avatar","avatar-54"),a.classList.remove("tgico-deletedaccount"),a.setAttribute("data-color",""),e.thumbs.length>0){const t=e.thumbs[0],s=new Blob([t.bytes],{type:"application/octet-stream"});let i=document.createElement("img");i.classList.add("avatar-photo"),i.src=URL.createObjectURL(s),a.append(i)}const o=document.createElement("div");o.classList.add("user-caption");const r=document.createElement("span");r.classList.add("user-title");const l=document.createElement("span");l.classList.add("peer-title"),l.setAttribute("dir","auto"),l.textContent=e.title,r.append(l),r.classList.add("tgico");const d=document.createElement("span");d.classList.add("user-last-message"),d.setAttribute("dir","auto"),d.textContent=e.message;const c=document.createElement("span");c.classList.add("message-status","sending-status");const h=document.createElement("span");h.classList.add("message-time"),h.textContent=e.badge;document.createElement("div").className="dialog-subtitle-badge badge badge-24";const u=document.createElement("p");u.classList.add("dialog-title");const p=document.createElement("span");p.classList.add("dialog-title-details"),p.append(c,h),u.append(r,p);const g=document.createElement("p");g.classList.add("dialog-subtitle"),g.append(d),o.append(u,g),s.append(a,o),i.forEach(e=>{e.append(s.cloneNode(!0))}),Xd.adsDialogs.push(s)})})}loadDialogs(e){if(this.loadDialogsPromise)return this.loadDialogsPromise;const t=new Promise(s=>$d(this,void 0,void 0,(function*(){const{chatList:i,filterId:n,indexKey:a}=this;this.initAdsDialogBox(i);let o=mt.windowH/72*1.25|0,r=0;const{index:l}=this.getOffsetIndex(e);if(l)if("top"===e){const e=js.dialogsStorage.getFolderDialogs(n,!0),t=e.findIndex(e=>e[a]<=l),s=Math.max(0,t-o);o=t-s,r=e[s][a]+1}else r=l;try{const s=js.getConversations("",r,o,n,!0);if(!s.cached&&!i.childElementCount){i.parentElement.append(this.chatsPreloader)}const l=yield s.promise;if(this.loadDialogsPromise!==t)return;if("bottom"===e?l.isEnd&&(this.scroll.loadedAll[e]=!0):l.isTopEnd&&(this.scroll.loadedAll[e]=!0),this.loadedDialogsAtLeastOnce=!0,l.dialogs.length){const t="top"===e?l.dialogs.slice().reverse():l.dialogs,s=[],i=[],n=e=>{i.push(e)};t.forEach(e=>{if(!js.getDialogOnly(e.peerId))return;const t=this.sortedList.add(e.peerId,!0,n,!1);t.loadPromises&&s.push(...t.loadPromises)}),yield Promise.all(s).finally(),i.forEach(e=>e())}else this.onListLengthChange();const d=l.dialogs["top"===e?0:l.dialogs.length-1];d&&(this.offsets[e]=d[a]),this.log.debug("getDialogs "+o+" dialogs by offset:",r,l,i.childElementCount),setTimeout(()=>{this.scroll.onScroll()},0)}catch(e){this.log.error(e)}this.chatsPreloader.parentElement&&this.chatsPreloader.remove(),s()}))).finally(()=>{this.loadDialogsPromise=void 0});return this.loadDialogsPromise=t}generateEmptyPlaceholder(e){const t="empty-placeholder",s=document.createElement("div");s.classList.add(t,t+"-"+e.classNameType);const i=document.createElement("div");i.classList.add(t+"-header"),Object(O._i18n)(i,e.title);const n=document.createElement("div");return n.classList.add(t+"-subtitle"),e.subtitle&&Object(O._i18n)(n,e.subtitle,e.subtitleArgs),s.append(i,n),{container:s,header:i,subtitle:n}}checkIfPlaceholderNeeded(){if(1===this.filterId)return;const e=this.chatList,t=e.parentElement;let s=Array.from(t.children).find(e=>e.matches(".empty-placeholder"));const i=this.scroll.loadedAll.bottom&&!e.childElementCount;if(i&&s)return;if(!i)return void(s&&(t.classList.remove("with-placeholder"),s.remove()));let n;if(this.filterId){n=this.generateEmptyPlaceholder({title:"FilterNoChatsToDisplay",subtitle:"FilterNoChatsToDisplayInfo",classNameType:"folder"}),s=n.container,s.prepend(function({emoji:e,width:t,height:s}){const i=document.createElement("div"),n=Ea.getAnimatedEmojiSticker(e);return n?Da({doc:n,div:i,loop:!1,play:!0,width:t,height:s,emoji:e}).then(()=>{}):i.classList.add("media-sticker-wrapper"),{container:i}}({emoji:"ðŸ“‚",width:128,height:128}).container);const e=Object(Ks.a)("btn-primary btn-color-primary btn-control tgico",{text:"FilterHeaderEdit",icon:"settings"});Object(v.b)(e,()=>{new tr(wr).open(js.filtersStorage.getFilter(this.filterId))}),s.append(e)}else{n=this.generateEmptyPlaceholder({title:"ChatList.Main.EmptyPlaceholder.Title",classNameType:"dialogs"}),s=n.container;const e=document.createElement("img");e.classList.add("empty-placeholder-dialogs-icon"),Promise.all([ye.getContacts().then(e=>{let t,s;e.length?(t="ChatList.Main.EmptyPlaceholder.Subtitle",s=[Object(O.i18n)("Contacts.Count",[e.length])]):(t="ChatList.Main.EmptyPlaceholder.SubtitleNoContacts",s=[]);new O.default.IntlElement({key:t,args:s,element:n.subtitle})}),Ze(e,"assets/img/EmptyChats.svg"),Object(g.d)()]).then(()=>{s.classList.add("visible")}),s.prepend(e)}t.append(s),t.classList.add("with-placeholder")}removeContactsPlaceholder(){const e=this.chatList,t=e.parentElement.parentElement,s=e.parentElement.nextElementSibling;t.classList.remove("with-contacts"),s.innerHTML="",this.loadContacts=void 0,this.processContact=void 0}setOffsets(){const e=this.chatList,t=this.getDialogFromElement(e.firstElementChild),s=this.getDialogFromElement(e.lastElementChild),i=this.indexKey;this.offsets.top=t[i],this.offsets.bottom=s[i]}getDialogFromElement(e){return js.getDialogOnly(e.dataset.peerId.toPeerId())}setListClickListener(e,t,s=!1,i=!1,n=!1){let a;const o=(n?Pd.setInnerPeer:Pd.setPeer).bind(Pd);e.dataset.autonomous=""+ +i,e.addEventListener("mousedown",e=>{var s,n,r;if(0!==e.button)return;this.log("dialogs click list");const l=e.target,d=Object(nn.a)(l,"LI");if(!d)return;if(Object(nn.a)(d,"ul").classList.contains("multi-select"))d.classList.contains("active")?d.classList.remove("active"):d.classList.add("active");else{if(i){const e=a===d;a&&!e&&a.classList.remove("active"),d&&(d.classList.add("active"),a=d,this.lastActiveElements.add(d))}if(d){t&&t();const e=null===(s=d.dataset)||void 0===s?void 0:s.username,i=null===(r=null===(n=d.dataset)||void 0===n?void 0:n.peerId)||void 0===r?void 0:r.toPeerId(),a=+d.dataset.mid||void 0;e?ye.resolveUsername(e).then(e=>{const t=+d.dataset.msgId||void 0,s=as.generateMessageId(t);o(e.id.toPeerId("chat"===e._||"channel"===e._),s)}):o(i,a)}else o(Z.b)}},{capture:!0}),j.b&&e.addEventListener("dblclick",e=>{const t=Object(nn.a)(e.target,"LI");if(t){const e=t.dataset.peerId.toPeerId();this.log("debug dialog:",js.getDialogByPeerId(e))}}),s&&Object(hi.a)(e,this.contextMenu.onContextMenu)}createChatList(e={}){const t=document.createElement("ul");return t.classList.add("chatlist"),e.new&&t.classList.add("chatlist-new"),t}setLastMessage(e,t,s,i,n,a=!1,o=!1){if(!s&&!(s=this.getDialogDom(e.peerId)))return;let r;if(t||(e.draft&&"draftMessage"===e.draft._&&(r=e.draft),t=js.getMessageByPeer(e.peerId,e.top_message)),"messageEmpty"===t._)return s.lastMessageSpan.innerHTML="",s.lastTimeSpan.innerHTML="",delete s.listEl.dataset.mid,void(o&&this.setUnreadMessages(e,s,a));const l=e.peerId,d=t&&js.isRestricted(t);{let e;if(!t.deleted&&!r&&!d){const s=js.getMediaFromMessage(t);if(s&&("photo"===s._||["video","gif"].includes(s.type))){const i=Dt.choosePhotoSize(s,20,20);if("photoSizeEmpty"!==i._&&(e=document.createElement("div"),e.classList.add("dialog-subtitle-media"),Oa({photo:s,message:t,container:e,withoutPreloader:!0,size:i,loadPromises:n}),"video"===s.type)){const t=document.createElement("span");t.classList.add("tgico-play"),e.append(t)}}}const a=!!e&&!!(null==t?void 0:t.message);let o;if(o=i&&t.message?js.wrapMessageForReply(t,void 0,void 0,!1,i,a):r?js.wrapMessageForReply(r):t.deleted?document.createDocumentFragment():js.wrapMessageForReply(t,void 0,void 0,!1,void 0,a),e&&o.prepend(e),Object(le.a)(s.lastMessageSpan,o),r){const e=document.createElement("b");e.classList.add("danger"),e.append(Object(O.i18n)("Draft"),": "),s.lastMessageSpan.prepend(e)}else if(l.isAnyChat()&&l!==t.fromId&&!t.action){const e=Te.getPeer(t.fromId);if(e&&e.id){const i=document.createElement("b");e.id===H.default.myId?i.append(Object(O.i18n)("FromYou")):i.append(new Oe({peerId:t.fromId,onlyFirstName:!0}).element),i.append(": "),s.lastMessageSpan.prepend(i)}}}if(!t.deleted||r){const e=r?Math.max(r.date,t.date||0):t.date;Object(le.a)(s.lastTimeSpan,Object(S.b)(new Date(1e3*e)))}else s.lastTimeSpan.textContent="";null!==o&&(o?this.setUnreadMessages(e,s,a):s.listEl.dataset.mid=t.mid)}setUnreadMessages(e,t=this.getDialogDom(e.peerId),s=!1){var i;if(!t)return;if(!s){const s=Cs.isPeerLocalMuted(e.peerId,!0);s!==t.listEl.classList.contains("is-muted")&&Object(p.a)(t.listEl,"is-muted",s,200)}let n;if("draftMessage"!==(null===(i=e.draft)||void 0===i?void 0:i._)){const t=js.getMessageByPeer(e.peerId,e.top_message);!t.deleted&&t.pFlags.out&&t.peerId!==H.default.myId&&(n=t)}!function(e,t,s){let i;if((null==t?void 0:t.pFlags.out)&&(i=t.pFlags.is_outgoing?"sending":t.pFlags.unread?"check":"checks"),!i)return void(e.textContent="");const n="tgico-"+i,a=e.lastElementChild;if(a&&a.classList.contains(n))return;const o=document.createElement("i");o.classList.add("sending-status-icon",n),e.append(o),a&&a.remove()}(t.statusSpan,n);const a=js.filtersStorage.getFilter(this.filterId);let o;o=a?-1!==a.pinnedPeerIds.indexOf(e.peerId):!!e.pFlags.pinned;const r=js.isDialogUnread(e),l=o||r,d=Object(b.a)(t.unreadBadge);l&&!d&&t.subtitleEl.append(t.unreadBadge);const c=e.unread_mentions_count&&(e.unread_mentions_count>1||e.unread_count>1),h=t.mentionsBadge&&Object(b.a)(t.mentionsBadge);c&&(t.mentionsBadge||(t.mentionsBadge=document.createElement("div"),t.mentionsBadge.className="dialog-subtitle-badge badge badge-24 mention mention-badge",t.mentionsBadge.innerText="@",t.subtitleEl.insertBefore(t.mentionsBadge,t.lastMessageSpan.nextSibling)));const u=s?0:200;if(Object(p.a)(t.unreadBadge,"is-visible",l,u,l?void 0:()=>{t.unreadBadge.remove()},d?0:2),t.mentionsBadge&&Object(p.a)(t.mentionsBadge,"is-visible",c,u,c?void 0:()=>{t.mentionsBadge.remove(),delete t.mentionsBadge},h?0:2),!l)return;o?t.unreadBadge.classList.add("tgico-chatspinned","tgico"):t.unreadBadge.classList.remove("tgico-chatspinned","tgico");let g=!0,m=!1;e.unread_mentions_count&&1===e.unread_count?(t.unreadBadge.innerText="@",m=!0):r?t.unreadBadge.innerText=""+(e.unread_count||" "):(t.unreadBadge.innerText="",g=!1),t.unreadBadge.classList.toggle("unread",g),t.unreadBadge.classList.toggle("mention",m)}getDialogDom(e){const t=this.sortedList.get(e);return null==t?void 0:t.dom}getDialog(e){if("object"!=typeof e&&e){const t=js.getDialogOnly(e);return t||{peerId:e,peer:Te.getOutputPeer(e),pFlags:{}}}return e}setCallStatus(e,t){let{listEl:s}=e;if(t){const{canvas:e,startAnimation:t}=qd(s.classList.contains("active"));e.classList.add("dialog-group-call-icon"),s.append(e),t()}else s.querySelectorAll(".dialog-group-call-icon").forEach(e=>{e.remove()})}addListDialog(e){const t=this.getDialog(e.dialog);e.autonomous=!1;const s=this.addDialogNew(e);if(s){const{peerId:i}=t;if(Cs.isPeerLocalMuted(i,!0)&&s.dom.listEl.classList.add("is-muted"),i.isUser()){let e=s.dom;if(e||(e=this.getDialogDom(t.peerId)),!e)return;if(t.topMessage&&t.topMessage.media){const s=t.topMessage;if(s.media.state&&(!s.fwd_from||i!==H.default.myId)){"liveStreamStateBroadcasting"===s.media.state._?this.setCallStatus(e,!0):this.setCallStatus(e,!1)}}}else this.processDialogForCallStatus(t,s.dom);this.setLastMessage(t,void 0,s.dom,void 0,e.loadPromises,e.isBatch,!0)}return s}processDialogForCallStatus(e,t){if(t||(t=this.getDialogDom(e.peerId)),!t)return;const s=Pe.getChat(e.peerId.toChatId());s.live_msg_id&&s.live_msg_id>0?this.setCallStatus(t,!0):this.setCallStatus(t,!1)}addDialogNew(e){return this.addDialog(e.dialog,e.container,e.drawStatus,e.rippleEnabled,e.onlyFirstName,e.meAsSaved,e.append,e.avatarSize,e.autonomous,e.lazyLoadQueue,e.loadPromises)}addDialog(e,t,s=!0,i=!0,n=!1,a=!0,o=!0,r=54,l=!!t,d,c){var h,u;const p=this.getDialog(e),g=p.peerId,m=new Od;if(m.loadPromises=c,m.lazyLoadQueue=d,m.setAttribute("dialog",a?"1":"0"),m.setAttribute("peer",""+g),m.classList.add("dialog-avatar","avatar-"+r),s&&g!==H.default.myId&&g.isUser()){const e=ye.getUser(g);e.status&&"userStatusOnline"===e.status._?m.classList.add("is-online"):m.classList.remove("is-online")}const f=document.createElement("div");f.classList.add("user-caption");const v=document.createElement("span");v.classList.add("user-title");const b=document.createElement("span");b.classList.add("eitaa-dialog"),g.isUser()?b.classList.add("eitaa-chat"):g.isBroadcast()?b.classList.add("eitaa-channel"):(g.isAnyGroup()||g.isMegagroup())&&b.classList.add("eitaa-group"),v.prepend(b);const y=new Oe({peerId:g,dialog:a,onlyFirstName:n,plainText:!1});v.append(y.element),v.classList.add("tgico");const w=Te.getPeer(g);(null===(h=null==w?void 0:w.pFlags)||void 0===h?void 0:h.verified)&&v.append(Bn());const S=document.createElement("span");S.classList.add("user-last-message"),S.setAttribute("dir","auto");const I=document.createElement("li");i&&Object(ei.ripple)(I),I.append(m,f),I.classList.add("chatlist-chat"),I.dataset.peerId=""+g;const M=document.createElement("span");M.classList.add("message-status","sending-status");const C=document.createElement("span");C.classList.add("message-time");const P=document.createElement("div");P.className="dialog-subtitle-badge badge badge-24";const L=document.createElement("p");L.classList.add("dialog-title");const E=document.createElement("span");E.classList.add("dialog-title-details"),E.append(M,C),L.append(v,E);const _=document.createElement("p");_.classList.add("dialog-subtitle"),_.append(S),f.append(L,_);const k={avatarEl:m,captionDiv:f,titleSpan:y.element,titleSpanContainer:v,statusSpan:M,lastTimeSpan:C,unreadBadge:P,lastMessageSpan:S,containerEl:I,listEl:I,subtitleEl:_,titleP:L};if(t){t[o?"append":"prepend"](I)}return l||(null===(u=Pd.chat)||void 0===u?void 0:u.peerId)!==g||(I.classList.add("active"),this.lastActiveElements.add(I)),{dom:k,dialog:p}}setTyping(e){const t=this.getDialogDom(e.peerId);if(!t)return;let s=t.lastMessageSpan.querySelector(".peer-typing-container");s?Pd.getPeerTyping(e.peerId,s):(s=Pd.getPeerTyping(e.peerId),Object(le.a)(t.lastMessageSpan,s),t.lastMessageSpan.classList.add("user-typing"))}unsetTyping(e){const t=this.getDialogDom(e.peerId);t&&(t.lastMessageSpan.classList.remove("user-typing"),this.setLastMessage(e,null,t,void 0,void 0,void 0,null))}}Xd.adsDialogs=[];const Zd=new Xd;j.a.appDialogsManager=Zd;var Jd=t.default=Zd},206:function(e,t,s){"undefined"!=typeof self&&self,e.exports=function(e){var t={};function s(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}return s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(i,n,function(t){return e[t]}.bind(null,n));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){"use strict";(function(t){var s=t.AudioContext||t.webkitAudioContext,i=function(e){if(!i.isRecordingSupported())throw new Error("Recording is not supported in this browser");e||(e={}),this.state="inactive",this.config=Object.assign({bufferLength:4096,encoderApplication:2049,encoderFrameSize:20,encoderPath:"encoderWorker.min.js",encoderSampleRate:48e3,maxFramesPerPage:40,mediaTrackConstraints:!0,monitorGain:0,numberOfChannels:1,recordingGain:1,resampleQuality:3,streamPages:!1,reuseWorker:!1,wavBitDepth:16},e),this.encodedSamplePosition=0};i.isRecordingSupported=function(){return s&&t.navigator&&t.navigator.mediaDevices&&t.navigator.mediaDevices.getUserMedia&&t.WebAssembly},i.prototype.clearStream=function(){this.stream&&(this.stream.getTracks?this.stream.getTracks().forEach((function(e){e.stop()})):this.stream.stop(),delete this.stream),this.audioContext&&this.closeAudioContext&&(this.audioContext.close(),delete this.audioContext)},i.prototype.encodeBuffers=function(e){if("recording"===this.state){for(var t=[],s=0;s<e.numberOfChannels;s++)t[s]=e.getChannelData(s);this.encoder.postMessage({command:"encode",buffers:t})}},i.prototype.initAudioContext=function(e){return e&&e.context?(this.audioContext=e.context,this.closeAudioContext=!1):(this.audioContext=new s,this.closeAudioContext=!0),this.audioContext},i.prototype.initAudioGraph=function(){this.encodeBuffers=function(){delete this.encodeBuffers},this.scriptProcessorNode=this.audioContext.createScriptProcessor(this.config.bufferLength,this.config.numberOfChannels,this.config.numberOfChannels),this.scriptProcessorNode.connect(this.audioContext.destination),this.scriptProcessorNode.onaudioprocess=e=>{this.encodeBuffers(e.inputBuffer)},this.monitorGainNode=this.audioContext.createGain(),this.setMonitorGain(this.config.monitorGain),this.monitorGainNode.connect(this.audioContext.destination),this.recordingGainNode=this.audioContext.createGain(),this.setRecordingGain(this.config.recordingGain),this.recordingGainNode.connect(this.scriptProcessorNode)},i.prototype.initSourceNode=function(e){return e&&e.context?t.Promise.resolve(e):t.navigator.mediaDevices.getUserMedia({audio:this.config.mediaTrackConstraints}).then(e=>(this.stream=e,this.audioContext.createMediaStreamSource(e)))},i.prototype.loadWorker=function(){this.encoder||(this.encoder=new t.Worker(this.config.encoderPath))},i.prototype.initWorker=function(){var e=(this.config.streamPages?this.streamPage:this.storePage).bind(this);return this.recordedPages=[],this.totalLength=0,this.loadWorker(),new Promise((t,s)=>{var i=s=>{switch(s.data.message){case"ready":t();break;case"page":this.encodedSamplePosition=s.data.samplePosition,e(s.data.page);break;case"done":this.encoder.removeEventListener("message",i),this.finish()}};this.encoder.addEventListener("message",i),this.encoder.postMessage(Object.assign({command:"init",originalSampleRate:this.audioContext.sampleRate,wavSampleRate:this.audioContext.sampleRate},this.config))})},i.prototype.pause=function(e){if("recording"===this.state){if(this.state="paused",e&&this.config.streamPages){var t=this.encoder;return new Promise((e,s)=>{var i=s=>{"flushed"===s.data.message&&(t.removeEventListener("message",i),this.onpause(),e())};t.addEventListener("message",i),t.postMessage({command:"flush"})})}return this.onpause(),Promise.resolve()}},i.prototype.resume=function(){"paused"===this.state&&(this.state="recording",this.onresume())},i.prototype.setRecordingGain=function(e){this.config.recordingGain=e,this.recordingGainNode&&this.audioContext&&this.recordingGainNode.gain.setTargetAtTime(e,this.audioContext.currentTime,.01)},i.prototype.setMonitorGain=function(e){this.config.monitorGain=e,this.monitorGainNode&&this.audioContext&&this.monitorGainNode.gain.setTargetAtTime(e,this.audioContext.currentTime,.01)},i.prototype.start=function(e){if("inactive"===this.state)return this.initAudioContext(e),this.initAudioGraph(),this.encodedSamplePosition=0,this.initWorker().then(()=>this.initSourceNode(e)).then(e=>{this.sourceNode=e,this.state="recording",this.onstart(),this.encoder.postMessage({command:"getHeaderPages"}),this.sourceNode.connect(this.monitorGainNode),this.sourceNode.connect(this.recordingGainNode)})},i.prototype.stop=function(){if("inactive"!==this.state){this.state="inactive",this.monitorGainNode.disconnect(),this.scriptProcessorNode.disconnect(),this.recordingGainNode.disconnect(),this.sourceNode.disconnect(),this.clearStream();var e=this.encoder;return new Promise(t=>{var s=i=>{"done"===i.data.message&&(e.removeEventListener("message",s),t())};e.addEventListener("message",s),e.postMessage({command:"done"}),this.config.reuseWorker||e.postMessage({command:"close"})})}return Promise.resolve()},i.prototype.destroyWorker=function(){"inactive"===this.state&&this.encoder&&(this.encoder.postMessage({command:"close"}),delete this.encoder)},i.prototype.storePage=function(e){this.recordedPages.push(e),this.totalLength+=e.length},i.prototype.streamPage=function(e){this.ondataavailable(e)},i.prototype.finish=function(){if(!this.config.streamPages){var e=new Uint8Array(this.totalLength);this.recordedPages.reduce((function(t,s){return e.set(s,t),t+s.length}),0),this.ondataavailable(e)}this.onstop(),this.config.reuseWorker||delete this.encoder},i.prototype.ondataavailable=function(){},i.prototype.onpause=function(){},i.prototype.onresume=function(){},i.prototype.onstart=function(){},i.prototype.onstop=function(){},e.exports=i}).call(this,s(1))},function(e,t){var s;s=function(){return this}();try{s=s||new Function("return this")()}catch(e){"object"==typeof window&&(s=window)}e.exports=s}])}}]);